<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="Kasowanie procedury SkojarzRozrachunek"></A><PRE>
          <FONT SIZE="2" DISABLED="True"><I>/* Kasowanie procedury SkojarzRozrachunek */</I><BR>
if exists (select name from sysobjects where name = 'SkojarzRozrachunek' and type = 'P')
  drop procedure CDN.SkojarzRozrachunek;
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="Tworzenie procedury SkojarzRozrachunek"></A><PRE>
          <FONT SIZE="2"><I>/* Tworzenie procedury SkojarzRozrachunek */</I><BR>
CREATE PROCEDURE CDN.SkojarzRozrachunek
@GIDFirma int,
@GIDTyp SMALLINT,
@GIDNumer INT,
@GIDLp SMALLINT,
@UserID INT,
@DataDzisiejsza INT


AS
--return 0
DECLARE @KontaNieTozsame INT
DECLARE @OpisRK VARCHAR(80)
DECLARE @OpisKompensaty VARCHAR(80)
DECLARE @Dokument1 VARCHAR(40)
DECLARE @Dokument2 VARCHAR(40)
DECLARE @DokumentRK_Zrodlowy VARCHAR(40)
DECLARE @ParID INT
DECLARE @KontoWal1 VARCHAR(50)
DECLARE @KontoWal2 VARCHAR(50)
DECLARE @KontoWal1Numer INT
DECLARE @KontoWal2Numer INT
DECLARE @KwotaRozWal DECIMAL(15,2)
DECLARE @KwotaRozSys DECIMAL(15,2)
DECLARE @KwotaRozSys1 DECIMAL(15,2)
DECLARE @KwotaRozSys2 DECIMAL(15,2)
DECLARE @Dod1 SMALLINT
DECLARE @Dod2 SMALLINT
DECLARE @Sav1Numer INT
DECLARE @Sav1Lp SMALLINT
DECLARE @Sav1DC	SMALLINT
DECLARE @KompGIDNumer INT
DECLARE @DataDzisiejszaKomp INT;
DECLARE @DataKomp INT

DECLARE @DataDzisiejszaRK INT;
DECLARE @OkresRK INT
DECLARE @StronaRK SMALLINT
DECLARE @StronaRK_Rozl SMALLINT
DECLARE @StronaRozl tinyint
DECLARE @RKDekretNumer INT


declare @KursDTL1 decimal(29,10)
declare @KursDTM1 decimal(29,10)
declare @KursDTL2 decimal(29,10)
declare @KursDTM2 decimal(29,10)
declare @KursDTL decimal(29,10)
declare @KursDTM decimal(29,10)

DECLARE @WalutaSys VARCHAR(3)
DECLARE @Dekret1Numer INT
DECLARE @Dekret1Lp SMALLINT
DECLARE @Dekret2Numer INT
DECLARE @Dekret2Lp SMALLINT
DECLARE @Dekret1DC SMALLINT
DECLARE @Dekret2DC SMALLINT
DECLARE @DekretRKDC SMALLINT


DECLARE @KwotaDTWal1 DECIMAL(15,2)
DECLARE @KwotaDTSys1 DECIMAL(15,2)
DECLARE @KwotaDTWal2 DECIMAL(15,2)
DECLARE @KwotaDTSys2 DECIMAL(15,2)
DECLARE @KwotaWal DECIMAL(15,2)
DECLARE @KwotaSys DECIMAL(15,2)
DECLARE @DataRoz1 INT
DECLARE @DataRoz2 INT
DECLARE @DataRoz  INT
DECLARE @Cnt1 SMALLINT;
DECLARE @Cnt2 SMALLINT;
DECLARE @RoznicaKursowa DECIMAL(15,2);
DECLARE @KontoDT VARCHAR(50);
DECLARE @KontoCT VARCHAR(50);
DECLARE @KontoDTNumer INT;
DECLARE @KontoCTNumer INT;
DECLARE @Znak1 INT
DECLARE @Znak2 INT

DECLARE @Waluta1 VARCHAR(3)
DECLARE @Waluta2 VARCHAR(3)


DECLARE @Data1 INT
DECLARE @Data2 INT
DECLARE @Konto1 VARCHAR(50)
DECLARE @Konto2 VARCHAR(50)
DECLARE @Konto1Numer INT
DECLARE @Konto2Numer INT
DECLARE @Konto1TypPozabil TINYINT
DECLARE @Konto2TypPozabil TINYINT

DECLARE @IDRoz INT
DECLARE @Termin1 INT
DECLARE @Termin2 INT

create table #Nierozliczone (
Numer    SMALLINT,
GIDNumer INT,
GIDLp    SMALLINT,
DC       SMALLINT,
KwotaSys DECIMAL(15,2),
KwotaWal DECIMAL(15,2),
DTKwotaSys DECIMAL(15,2),
DTKwotaWal DECIMAL(15,2),
Konto    VARCHAR(50) COLLATE Polish_CI_AS,
Kontonumer INT,
KontoTypPozabil TINYINT,
KontoWal VARCHAR(50) COLLATE Polish_CI_AS,
KontoWalNumer INT,
Waluta   VARCHAR(3) COLLATE Polish_CI_AS,
KursL	 DECIMAL(29,10),
KursM	 DECIMAL(29,10),
Znak     SMALLINT,
Data     INT,
IDRoz    INT,
KwotaRozWal DECIMAL(15,2),
KwotaRozSys DECIMAL(15,2),
Dokument VARCHAR(40) COLLATE Polish_CI_AS,
ParID    INT,
DokTyp   SMALLINT,
DokNumer INT,
DokLp SmallINT,
DataRozl int,
Nierozliczony smallint,
Rozliczony smallint,
MaRozliczenie smallint,
Kurs DECIMAL(29,10),
R2_RK DECIMAL(15,2),
R2_RKStrona smallint,
R2_Strona smallint,
R2_Wycena tinyint,
R2_WycenaParID int,
DT_WycenaParID int,
KontoRej tinyint,
DekretKazRoz int,
Termin int,
DokKAZWycenaKolejnosc tinyint,
DokKAZKursWgWyceny tinyint,
DokKAZLokata tinyint
PRIMARY KEY (Numer,GIDNumer,GIDLp,DC,ParID)
  );


declare @Nierozliczone Table (
Numer    SMALLINT,
GIDNumer INT,
GIDLp    SMALLINT,
DC       SMALLINT,
KwotaSys DECIMAL(15,2),
KwotaWal DECIMAL(15,2),
DTKwotaSys DECIMAL(15,2),
DTKwotaWal DECIMAL(15,2),
Konto    VARCHAR(50),
Kontonumer INT,
KontoTypPozabil TINYINT,
KontoWal VARCHAR(50),
KontoWalNumer INT,
Waluta   VARCHAR(3),
KursL	 DECIMAL(29,10),
KursM	 DECIMAL(29,10),
Znak     SMALLINT,
Data     INT,
IDRoz    INT,
KwotaRozWal DECIMAL(15,2),
KwotaRozSys DECIMAL(15,2),
Dokument VARCHAR(40),
ParID    INT,
DokTyp   SMALLINT,
DokNumer INT,
DokLp SmallINT,
DataRozl int,
Nierozliczony smallint,
Rozliczony smallint,
MaRozliczenie smallint,
Kurs DECIMAL(29,10),
R2_RK DECIMAL(15,2),
R2_RKStrona smallint,
R2_Strona smallint,
R2_Wycena tinyint,
R2_WycenaParID int,
DT_WycenaParID int,
KontoRej tinyint,
DekretKazRoz int,
Termin int,
DokKAZWycenaKolejnosc tinyint,
DokKAZKursWgWyceny tinyint,
DokKAZLokata tinyint
  );



/*
declare @TypRK smallint
set @TypRK = 435
declare @TypDT smallint
set @TypDT = 432
declare @TypKAZ smallint
set @TypKAZ = 784
declare @TypROZ smallint
set @TypROZ = 433
declare @TypSchRK smallint
set @TypSchRK = 6339
*/

declare @DokTyp smallint
declare @DokNumer int
declare @DokLp smallint


declare @RKN_ID int
declare @DataRozliczenia int
declare @DataRozrachunku int
declare @DataRK int
declare @poz_DecKwota smallint
set @poz_DecKwota = 2
declare @Kurs1 decimal(29,10)
declare @Kurs2 decimal(29,10)
declare @DokumentRK smallint
declare @DokumentRKAutomat smallint
declare @KonfDokumentRK smallint
declare @KonfDokumentRKAutomat smallint
declare @RKN_DataRozl int
declare @RKN_DataWyst int
declare @RKN_Seria varchar(5)
declare @RKN_Numer int
declare @DataRKN_Rok smallint
declare @RKN_Zaksiegowano smallint
declare @RozliczenieCalkowite smallint
declare @RK_R2_ID int
declare @RK_R2_DokNumer int
declare @RK_R2_DokTyp smallint
declare @tmpDekretNumer int
declare @tmpDekretLp smallint
declare @tmpDekretDC smallint
declare @tmpZnak smallint
declare @tmpRoznicaKursowa DECIMAL(15,2)
declare @R2_RK DECIMAL(15,2)
declare @R2_RKStrona smallint
declare @R2_ID int

declare @r2_strona smallint

declare @szMsg1 varchar(30)
declare @szMsg2 varchar(30)

declare @rv int
set @rv = 0

declare @BZ smallint
declare @RKN_BZ smallint


declare @OldKonto1Numer int
declare @OldKonto2Numer int
declare @OldKonto1 VARCHAR(50)
declare @OldKonto2 VARCHAR(50)
declare @OldKontoWal1Numer int
declare @OldKontoWal2Numer int
declare @OldKontoWal1 VARCHAR(50)
declare @OldKontoWal2 VARCHAR(50)

declare @KAZZnak tinyint
declare @KAZWycenaKolejnosc tinyint
declare @KAZKursWgWyceny tinyint
declare @KAZLokata tinyint
set @KAZLokata = 0

declare @TrybRozrachunek tinyint

declare @bPobierzDekr1 tinyint
declare @bKAZzRozl tinyint
declare @R2_WycenaParID int
declare @R2_Wycena tinyint

declare @DokKAZWycenaKolejnosc tinyint
declare @DokKAZKursWgWyceny tinyint
declare @DokKAZLokata tinyint

-- początek transakcji
SET NOCOUNT ON
BEGIN TRAN


if @GidTyp = 435
begin
	RollBack TRAN
	raiserror('999:Błędne parametry wejściowe procedury SkojarzRozrachunek',16,1)
	set @rv = 301
	goto lErr
end



SELECT @WalutaSys = KON_Wartosc FROM CDN.Konfig with(nolock) WHERE KON_Numer = 211


set @KonfDokumentRK = isnull((SELECT KON_Wartosc FROM CDN.Konfig with(nolock) WHERE KON_Numer = 2095),0)
--set @KonfDokumentRK = 0
set @KonfDokumentRKAutomat = isnull((SELECT KON_Wartosc FROM CDN.Konfig with(nolock) WHERE KON_Numer = 2096),0)
--set @KonfDokumentRKAutomat = 0



-- wczytanie dekretów księgowych


INSERT INTO #Nierozliczone( Numer, GIDNumer, GIDLp, DC, KwotaSys, KwotaWal, DTKwotaSys, DTKwotaWal, Konto, KontoNumer, KontoTypPozabil, 
KontoWal, KontoWalNumer,  Waluta, KursL, KursM, Znak, Data, IDRoz, KwotaRozWal, KwotaRozSys, Dokument, Nierozliczony, Rozliczony,
DT_WycenaParID, DekretKazRoz, ParID) 
SELECT 1, DT_GIDNumer, DT_GIDLp, DT_DC,
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN ABS(DT_Kwota) ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN ABS(DT_Kwota) ELSE 0 END),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_Konto ELSE '' END), 
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_GIDNumer ELSE '' END), 
MAX( CASE WHEN DT_Waluta = @WalutaSys AND KKS_TypKonta=6 THEN 1 ELSE 0 END),
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_Konto ELSE '' END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_GIDNumer ELSE '' END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_Waluta ELSE '' END),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN DT_KursKwota ELSE 1 END ),
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_KursKwota ELSE 1 END ),
MAX( DT_Znak ), 
MAX( DT_DataDekr ),
NULL, 
NULL, 
NULL, 
MAX( DEL_DokumentZrodlowy ),
Max( DT_Nierozliczony ),
Max( DT_Rozliczony ),
Max( DEL_WycenaParID ),
max( isnull(PDT_ZroNumer,0)),
0
FROM cdn.Zrodla with(nolock)
	join cdn.Dekrety with(updlock)
		on zro_dttyp = 432 and zro_dtnumer = dt_gidnumer and zro_dtlp = dt_gidlp
	JOIN CDN.Konta with(nolock)
		ON DT_KKSNumer = KKS_GIDNumer
	JOIN CDN.DziennikElem with(nolock) 
		ON DT_GIDNumer = DEL_GIDNumer AND DT_GIDLp = DEL_GIDLp
	left join cdn.Predekrety with(nolock)
		on PDT_GIDTyp = 784 and @GIDTyp = 784 and PDT_GIDNumer = @GIDNumer and PDT_DelNumer = DEL_GIDNumer and PDT_DelLp = DEL_GIDLp
WHERE zro_trntyp = @GIDTyp and zro_trnnumer = @GIDNumer and zro_trnlp = @GIDLp
	AND (DT_Nierozliczony = 1 OR DT_Rozliczony = 1) 
	AND KKS_Rozrachunkowe &lt;&gt; 0
GROUP BY DT_GIDNumer, DT_GIDLp, DT_DC




INSERT INTO #Nierozliczone( Numer, GIDNumer, GIDLp, DC, KwotaSys, KwotaWal, DTKwotaSys, DTKwotaWal, Konto, KontoNumer, KontoTypPozabil,
KontoWal, KontoWalNumer,  Waluta, KursL, KursM, Znak, Data, IDRoz, KwotaRozWal, KwotaRozSys, Dokument, 
ParID, DokTyp, DokNumer, DokLp, DataRozl, Nierozliczony, Rozliczony, R2_RK, R2_RKStrona, R2_Strona,
DT_WycenaParID,
R2_Wycena, R2_WycenaParID, DekretKazRoz,
DokKAZWycenaKolejnosc, DokKAZKursWgWyceny,
DokKAZLokata  ) 
SELECT 2, DT_GIDNumer, DT_GIDLp, DT_DC,
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN ABS(DT_Kwota) ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN ABS(DT_Kwota) ELSE 0 END),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_Konto ELSE '' END), 
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_GIDNumer ELSE '' END), 
MAX( CASE WHEN DT_Waluta = @WalutaSys AND KKS_TypKonta=6 THEN 1 ELSE 0 END),
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_Konto ELSE '' END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_GIDNumer ELSE '' END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_Waluta ELSE '' END),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN DT_KursKwota ELSE 1 END ),
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_KursKwota ELSE 1 END ),
MAX( DT_Znak ), 
MAX( DT_DataDekr ),
R2_ID, 
MAX( R2_KwotaWal1 ), 
MAX( R2_KwotaSys ), 
MAX( DEL_DokumentZrodlowy ),
R2_ParID,  
R2_Dok2Typ, R2_Dok2Numer, R2_Dok2Lp,
MAX(R2_DataRozliczenia),
Max( DT_Nierozliczony ),
Max( DT_Rozliczony ),
max( isnull(R2_RK,0)),
max( isnull(R2_RKStrona,0)),
1,
max( DEL_WycenaParID),
max( R2_Wycena ),
max( R2_WycenaParID ),
max( isnull(PDT_ZroNumer,0)),
max(isnull(KAZ_WycenaKolejnosc,0)),
max(isnull(KAZ_KursWgWyceny,0)),
max(isnull(KAZ_Lokata,0))
FROM CDN.Rozliczenia with(updlock) 	
	join cdn.Zrodla b with(nolock)
		on b.ZRO_TRNTyp = R2_Dok2Typ AND b.ZRO_TRNNumer = R2_Dok2Numer AND b.ZRO_TRNLp = R2_Dok2Lp 	
	join cdn.Dekrety with(updlock)
		on b.ZRO_DTTyp = 432 AND b.ZRO_DTNumer=DT_GIDNumer AND b.ZRO_DTLp=DT_GIDLp
	JOIN CDN.Konta with(nolock) 
		ON DT_KKSNumer = KKS_GIDNumer
	JOIN CDN.DziennikElem with(nolock) 
		ON DT_GIDNumer = DEL_GIDNumer AND DT_GIDLp = DEL_GIDLp
	left join cdn.Predekrety with(nolock)
		on R2_Dok2Typ = 784 and PDT_GIDTyp = R2_Dok2Typ and PDT_GIDNumer = R2_Dok2Numer and PDT_DelNumer = DEL_GIDNumer and PDT_DelLp = DEL_GIDLp
	left join cdn.Zapisy with(nolock)
		on R2_Dok2Typ = 784 and KAZ_GIDNumer = R2_Dok2Numer and R2_Dok2Lp = 0
WHERE R2_Dok1Typ = @GIDTyp AND R2_Dok1Numer = @GIDNumer AND R2_Dok1Lp = @GIDLp
	AND (DT_Nierozliczony = 1 OR DT_Rozliczony = 1)	
	AND R2_Dok2Typ &lt;&gt; 435 
	AND not (isnull(R2_Dekret1Numer,0) &lt;&gt; 0 and isnull(R2_Dekret2Numer,0) &lt;&gt; 0) --juz rozrachowany (z dekretem innej platnosci tego samego dokumentu lub z dekretem innej platnosci na spinaczu pochodzaca z innego dokumentu)
GROUP BY R2_ID, R2_ParID, R2_Dok2Typ, R2_Dok2Numer, R2_Dok2Lp, DT_GIDNumer, DT_GIDLp, DT_DC





INSERT INTO #Nierozliczone( Numer, GIDNumer, GIDLp, DC, KwotaSys, KwotaWal, DTKwotaSys, DTKwotaWal, Konto, KontoNumer, KontoTypPozabil, 
KontoWal, KontoWalNumer,  Waluta, KursL, KursM, Znak, Data, IDRoz, KwotaRozWal, KwotaRozSys, Dokument, 
ParID, DokTyp, DokNumer, DokLp, DataRozl, Nierozliczony, Rozliczony, R2_RK, R2_RKStrona, R2_Strona, 
DT_WycenaParID,
R2_Wycena, R2_WycenaParID, DekretKazRoz,
DokKAZWycenaKolejnosc, DokKAZKursWgWyceny,
DokKAZLokata  ) 
SELECT 2, DT_GIDNumer, DT_GIDLp, DT_DC,
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN ABS(DT_Kwota) ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN ABS(DT_Kwota) ELSE 0 END),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_Konto ELSE '' END), 
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_GIDNumer ELSE '' END), 
MAX( CASE WHEN DT_Waluta = @WalutaSys AND KKS_TypKonta=6 THEN 1 ELSE 0 END),
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_Konto ELSE '' END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_GIDNumer ELSE '' END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_Waluta ELSE '' END),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN DT_KursKwota ELSE 1 END ),
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_KursKwota ELSE 1 END ),
MAX( DT_Znak ), 
MAX( DT_DataDekr ),
R2_ID, 
MAX( R2_KwotaWal2 ), 
MAX( R2_KwotaSys ), 
MAX( DEL_DokumentZrodlowy ),
R2_ParID,  
R2_Dok1Typ, R2_Dok1Numer, R2_Dok1Lp,
MAX(R2_DataRozliczenia),
Max( DT_Nierozliczony ),
Max( DT_Rozliczony ),
max( isnull(R2_RK,0)),
max( isnull(R2_RKStrona,0)),
2,
max( DEL_WycenaParId),
max( R2_Wycena ),
max( R2_WycenaParID ),
max( isnull(PDT_ZroNumer,0)),
max(isnull(KAZ_WycenaKolejnosc,0)),
max(isnull(KAZ_KursWgWyceny,0)),
max(isnull(KAZ_Lokata,0))
FROM CDN.Rozliczenia with(updlock) 	
	join cdn.Zrodla b with(nolock)
		on b.ZRO_TRNTyp = R2_Dok1Typ AND b.ZRO_TRNNumer = R2_Dok1Numer AND b.ZRO_TRNLp = R2_Dok1Lp
	join cdn.Dekrety with(updlock)
		on b.ZRO_DTTyp = 432 AND b.ZRO_DTNumer=DT_GIDNumer AND b.ZRO_DTLp=DT_GIDLp
	JOIN CDN.Konta with(nolock) 
		ON DT_KKSNumer = KKS_GIDNumer
	JOIN CDN.DziennikElem with(nolock) 
		ON DT_GIDNumer = DEL_GIDNumer AND DT_GIDLp = DEL_GIDLp
	left join cdn.Predekrety with(nolock)
		on R2_Dok1Typ = 784 and PDT_GIDTyp = R2_Dok1Typ and PDT_GIDNumer = R2_Dok1Numer and PDT_DelNumer = DEL_GIDNumer and PDT_DelLp = DEL_GIDLp
	left join cdn.Zapisy with(nolock)
		on R2_Dok1Typ = 784 and KAZ_GIDNumer = R2_Dok1Numer and R2_Dok1Lp = 0
WHERE R2_Dok2Typ = @GIDTyp AND R2_Dok2Numer = @GIDNumer AND R2_Dok2Lp = @GIDLp
	AND(DT_Nierozliczony = 1 OR DT_Rozliczony = 1)	
	AND R2_Dok1Typ &lt;&gt; 435 
	AND not (isnull(R2_Dekret1Numer,0) &lt;&gt; 0 and isnull(R2_Dekret2Numer,0) &lt;&gt; 0) --juz rozrachowany (z dekretem innej platnosci tego samego dokumentu lub z dekretem innej platnosci na spinaczu pochodzaca z innego dokumentu)
GROUP BY R2_ID, R2_ParID, R2_Dok1Typ, R2_Dok1Numer, R2_Dok1Lp, DT_GIDNumer, DT_GIDLp, DT_DC



UPDATE #Nierozliczone SET Waluta = @WalutaSys WHERE Waluta = '';



set @Cnt1 = isnull((SELECT COUNT(Znak) FROM #Nierozliczone WHERE Numer = 1),0)
set @Cnt2 = isnull((SELECT COUNT(Znak) FROM #Nierozliczone WHERE Numer = 2),0)



if @Cnt2 = 0 
BEGIN --drugi nie jest zaksiegowany	
	set @rv = 0
	goto lExit_ok
END

if @Cnt1 = 0 
BEGIN
	ROLLBACK TRAN
	RAISERROR('301:Powstały dekret nie zawiera księgowania na konto rozrachunkowe', 16, 1) 
	set @rv = 301
	goto lErr
END



----zczytaj kursy
update #Nierozliczone set
	Kurs = case when KAZ_GIDTyp is null then TRP_KwotaSys/TRP_Kwota else KAZ_KwotaSys/KAZ_KwotaRoz end
	
from #Nierozliczone 
	LEFT JOIN cdn.Zapisy with(updlock)
		ON Numer = 1 and @GIDTyp = 784 and KAZ_GIDNumer = @GIDNumer
	LEFT JOIN cdn.TraPlat with(updlock) 
		ON Numer = 1 and @GIDTyp &lt;&gt; 784 and TRP_GIDTyp = @GIDTyp and TRP_GIDNumer = @GIDNumer and TRP_GIDLp = @GIDLp
where Numer = 1



update #Nierozliczone set
	Kurs = case when KAZ_GIDTyp is null then TRP_KwotaSys/TRP_Kwota else KAZ_KwotaSys/KAZ_KwotaRoz end,
	Termin = case when KAZ_GIDTyp is null then TRP_Termin else KAZ_DataZapisu end	
from #Nierozliczone 
	LEFT JOIN cdn.Zapisy with(updlock)
		ON Numer = 2 and DokTyp = 784 and KAZ_GIDNumer = DokNumer
	LEFT JOIN cdn.TraPlat with(updlock) 
		ON Numer = 2 and DokTyp &lt;&gt; 784 and TRP_GIDTyp = DokTyp and TRP_GIDNumer = DokNumer and TRP_GIDLp = DokLp
where Numer = 2



--opis dokumentu i termin 
IF @GIDTyp = 784
	SELECT 
		@Termin1 = KAZ_DataZapisu,
		@Dokument1 = cdn.NazwaObiektu (KAZ_GIDTyp, KAZ_GIDNumer, 0, 2),
		@KAZZnak = KAZ_Znak,
		@KAZWycenaKolejnosc = KAZ_WycenaKolejnosc,
		@KAZKursWgWyceny = KAZ_KursWgWyceny,
		@KAZLokata = KAZ_Lokata
	FROM CDN.Zapisy 
	WHERE KAZ_GIDNumer = @GIDNumer
ELSE
	SELECT 
		@Termin1 = TRP_Termin,
		@Dokument1 = cdn.NazwaObiektu (TRP_GIDTyp, TRP_GIDNumer, 0, 2)
	FROM CDN.TraPlat 
	WHERE TRP_GIDTyp = @GIDTyp AND TRP_GIDNumer = @GIDNumer AND TRP_GIDLp=@GIDLp


IF @@ERROR &lt;&gt; 0
BEGIN
	ROLLBACK TRAN
	RAISERROR('100:Błąd pobrania wiersza do rozliczenia', 16, 1) 
	set @rv = 301
	goto lErr
END



update #Nierozliczone set
	Dokument = cdn.NazwaObiektu (DokTyp, DokNumer, 0, 2)
where Numer = 2


-----------kojarzenie dekretow


--zaktualizuj flage MaRozliczenie
update #Nierozliczone set
	MaRozliczenie = 
	case when exists(select b.R2_ID from 
		(select R2_ParID from cdn.Rozliczenia where R2_Dekret1Numer = GIDNumer and R2_Dekret1Lp = GIDLp and R2_Dekret1DC = DC
		union all
		select R2_ParID from cdn.Rozliczenia where R2_Dekret2Numer = GIDNumer and R2_Dekret2Lp = GIDLp and R2_Dekret2DC = DC
		) a
		join cdn.Rozliczenia b on a.R2_ParID = b.R2_ParID and b.R2_Dok1Typ &lt;&gt; 0 and b.R2_Dok2Typ &lt;&gt; 0)
	then 1 else 0 end			
where Numer = 2 and Rozliczony &lt;&gt; 0

if @@Error &lt;&gt; 0
begin			
	ROLLBACK TRAN				
	RAISERROR('200:Błąd odczytu z tabeli cdn.Rozliczenia', 16, 1) 
	set @rv = 301
	goto lErr
end




--zaznacz konta rejestru

update #Nierozliczone set
		KontoRej = 
		case when (len(rtrim(KontoWal)) &gt; 0 
				and exists(select KAR_KontoKasy
							from cdn.Rejestry
							where KontoWal = KAR_KontoKasy))
					or exists(select KAR_KontoKasy
							from cdn.Rejestry
							where Konto = KAR_KontoKasy) 
		then 1 else 0 end			


if @@Error &lt;&gt; 0
begin			
	ROLLBACK TRAN				
	RAISERROR('200:Błąd odczytu z tabeli cdn.Rejestry', 16, 1) 
	set @rv = 301
	goto lErr
end





if @GIDTyp = 784 and @KAZZnak = 1 and @KAZWycenaKolejnosc &lt;&gt; 0 --rozchodowy i kurs na podstawie wyceny
begin
	--lec po wycenach
	set @TrybRozrachunek = 1

	set @R2_WycenaParID = 0
	 

	if @KAZKursWgWyceny &lt;&gt; 0
	begin --rozne kursy
		declare cursDekr1 cursor LOCAL STATIC for
		select
			DT_WycenaParID
		from #Nierozliczone
		where Numer = 1 and DT_WycenaParID &lt;&gt; 0
		group by DT_WycenaParID
	end
	else
	begin --kurs ustalony
		declare cursDekr1 cursor LOCAL STATIC for
		select
			ParID			
		from #Nierozliczone
		where Numer = 2 and R2_Wycena = 1
		group by ParID		


		insert into @Nierozliczone
		select * from #Nierozliczone
		where Numer = 1		
			and DT_WycenaParID = 0
			and KontoRej = 1
			and isnull(DekretKazRoz,0) = 0
	end


	Open cursDekr1

	fetch next from cursDekr1 into @ParID
	

	While @@Fetch_Status = 0
	begin
		set @bPobierzDekr1 = 1


		if @KAZKursWgWyceny &lt;&gt; 0
		begin
			delete from @Nierozliczone

			--skopiuj dekrety KW
			--skopiuj dekrety zapisu KP nie powstale w oparciu o rozliczenie 
			insert into @Nierozliczone
			select * from #Nierozliczone
			where Numer = 1		
				and DT_WycenaParID = @ParID
				and KontoRej = 1
				and isnull(DekretKazRoz,0) = 0
			union all
			select * from #Nierozliczone
			where Numer = 2 
				and R2_Wycena = 1
				and ParID = @ParID
				and KontoRej = 1
				and isnull(DekretKazRoz,0) = 0
		
		end
		else
		begin
			delete from @Nierozliczone where Numer = 2

			--skopiuj dekrety KW
			--skopiuj dekrety zapisu KP nie powstale w oparciu o rozliczenie 
			insert into @Nierozliczone			
			select * from #Nierozliczone
			where Numer = 2 
				and R2_Wycena = 1
				and ParID = @ParID
				and KontoRej = 1
				and isnull(DekretKazRoz,0) = 0
		end	



		--pobierz pozostale zmienne
		select 
			top 1
			@R2_ID = IDRoz,
			@DokTyp = DokTyp,
			@DokNumer = DokNumer,
			@DokLp = DokLp
		from @Nierozliczone
		where Numer = 2


		
/*
		delete from @Nierozliczone
		insert into @Nierozliczone select * from #Nierozliczone
		ROLLBACK TRAN				
		drop table cdn.aa1
		select * into cdn.aa1 from @Nierozliczone
			RAISERROR('200:Zapis %s nie jest paaaa', 16, 1, @Dokument1) 
			set @rv = 301
			goto lErr_cursDekr1

*/

		
		set @Dokument2 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 2)
		



		set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)
		if @Cnt2 = 0
		begin
			if not exists(select * from #Nierozliczone where Numer = 2 and ParID = @ParID)
			begin
				goto lNext_cursDekr1
			end
			else
			begin
				set @Dokument2 = (select max(rtrim(Dokument)) from #Nierozliczone where Numer = 2 and ParID = @ParID)
				
				ROLLBACK TRAN				
				RAISERROR('200:Wyceniany zapis %s nie jest poprawnie zaksięgowany na rozrachunkowe konto rejestru', 16, 1, @Dokument2) 
				set @rv = 301
				goto lErr_cursDekr1
			end				
		end		
		
		
		set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)
		if @Cnt1 = 0
		begin
			ROLLBACK TRAN				
			RAISERROR('200:Zapis %s nie jest poprawnie zaksięgowany na rozrachunkowe konto rejestru', 16, 1, @Dokument1) 
			set @rv = 301
			goto lErr_cursDekr1
		end		
		
		
		
		if @Cnt2 &gt; 1
		begin
			set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2 and Rozliczony = 1),0)	
			if @Cnt2 &gt; 0
			begin			
				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) &lt;&gt; 0),0)
				if @Cnt2 &gt; 0
				begin
					if @Cnt2 &gt; 1
					begin
						ROLLBACK TRAN				
						RAISERROR('200:Dla zapisu wyceniającego %s dokonano już rozrachunku wyceny na więcej niż jednym dekrecie', 16, 1, @Dokument2) 
						set @rv = 301
						goto lErr_cursDekr1
					end
					else
					begin
						delete from @Nierozliczone where Numer = 2 and isnull(MaRozliczenie,0) = 0

						set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
						if @Cnt2 = 0 ---nie powinno sie zdarzyc
						begin					
							ROLLBACK TRAN				
							RAISERROR('200:Na dekrecie zapisu wyceniającego %s dokonano już rozrachunku wyceny bez rozliczenia', 16, 1, @Dokument2) 
							set @rv = 301
							goto lErr_cursDekr1
						end				
					end
				end
				else
				begin
					delete from @Nierozliczone where Numer = 2 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) = 0

					set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
					if @Cnt2 = 0
					begin					
						ROLLBACK TRAN				
						RAISERROR('200:Na dekrecie zapisu wyceniającego %s dokonano już rozrachunku wyceny', 16, 1, @Dokument2) 
						set @rv = 301
						goto lErr_cursDekr1
					end			
				end												
			end
			else
			begin --nie ma rozrachowanych
				DELETE FROM a 
				FROM @Nierozliczone a 
						JOIN @Nierozliczone b 
							ON a.Numer=b.Numer 
							AND not (a.GIDNumer=b.GIDNumer and a.GIDLp=b.GIDLp and a.DC=b.DC)
				WHERE a.Numer = 2 AND a.KwotaSys = 0 AND b.KwotaSys &lt;&gt; 0;


				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
				if @Cnt2 &gt; 1
				begin
					set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)	
					if @Cnt1 = 1
					begin
						DELETE FROM a 
						FROM @Nierozliczone a 
						WHERE a.Numer = 2 
							AND EXISTS(SELECT * FROM @Nierozliczone b WHERE b.Numer = 1 AND b.Znak = a.Znak)


						set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
						if @Cnt2 &gt; 1
						begin							
							ROLLBACK TRAN				
							RAISERROR('200:Dla zapisu wyceniającego %s nie można ustalić pozycji dekretu do rozrachunku wyceny (1)', 16, 1, @Dokument2) 
							set @rv = 301
							goto lErr_cursDekr1
						end
					end
					else
					begin
						ROLLBACK TRAN				
						RAISERROR('200:Dla zapisu wyceniającego %s nie można ustalić pozycji dekretu do rozrachunku wyceny (2)', 16, 1, @Dokument2) 
						set @rv = 301
						goto lErr_cursDekr1
					end
				end
			end
		end
		--else --ok 1 dekret
				

		set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)
		if @Cnt1 &gt; 1
		begin
			DELETE FROM a 
			FROM @Nierozliczone a 
			WHERE a.Numer = 1
				AND EXISTS(SELECT * FROM @Nierozliczone b WHERE b.Numer = 2 AND b.Znak = a.Znak)

			set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)

			if @Cnt1 = 0 
			begin
				RAISERROR('502:Rozrachunek wyceny niemożliwy. Dekrety możliwe do rozrachunku posiadają konta po tej samej stronie', 16, 1) 				
			end

			if @Cnt1 &gt; 1
			begin
				DELETE FROM a FROM @Nierozliczone a 
				WHERE a.Numer = 1 AND 
				NOT EXISTS(SELECT * 
					FROM @Nierozliczone b 
						left join cdn.KontaNastLinki c
							on b.KontoNumer = c.KLI_NastNumer and a.KontoNumer = c.KLI_PoprzNumer
						left join cdn.KontaNastLinki d
							on a.KontoNumer = d.KLI_NastNumer and b.KontoNumer = d.KLI_PoprzNumer
					WHERE b.Numer = 3-a.Numer AND b.Znak = 3-a.Znak AND not (c.KLI_NastNumer is null and d.KLI_NastNumer is null))

				set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)
				if @Cnt1 &gt; 1
				begin
					set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 1)
					ROLLBACK TRAN				
					RAISERROR('200:Na księgowanym zapisie %s nie można ustalić pozycji dekretu do rozrachunku wyceny', 16, 1, @szMsg1) 
					set @rv = 301
					goto lErr_cursDekr1
				end
			end
		end					


		set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)
		if @Cnt1 &gt; 1
		begin
			set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 1)
			ROLLBACK TRAN				
			RAISERROR('200:Na księgowanym zapisie %s nie można ustalić pozycji dekretu do rozrachunku wyceny', 16, 1, @szMsg1) 
			set @rv = 301
			goto lErr_cursDekr1
		end
		set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)
		if @Cnt2 &gt; 1
		begin			
			ROLLBACK TRAN				
			RAISERROR('200:Dla zapisu wyceniającego %s nie można ustalić pozycji dekretu do rozrachunku wyceny (3)', 16, 1, @Dokument2) 
			set @rv = 301
			goto lErr_cursDekr1
		end

		
		goto lRozrachunek

lNext_cursDekr1:	
		fetch next from cursDekr1 into @ParID
	end
end



if @GIDTyp = 784 and @KAZZnak = 2 --przychodowy 
begin
	--lec po wycenach
	set @TrybRozrachunek = 2
	set @bPobierzDekr1 = 1
	set @R2_WycenaParID = 0


	delete from @Nierozliczone

	insert into @Nierozliczone
	select * from #Nierozliczone
	where Numer = 1		
		and DT_WycenaParID = 0
		and KontoRej = 1		
		and isnull(DekretKazRoz,0) = 0



	declare cursDekr2 cursor LOCAL STATIC for
	select
		ParID,
		IDRoz,
		DokTyp,
		DokNumer,
		DokLp,
		DokKAZWycenaKolejnosc,
		DokKAZKursWgWyceny
	from #Nierozliczone
	where Numer = 2 and R2_Wycena = 1
	group by ParID,
		IDRoz,
		DokTyp,
		DokNumer,
		DokLp,
		DokKAZWycenaKolejnosc,
		DokKAZKursWgWyceny

	Open cursDekr2

	fetch next from cursDekr2 into @ParID, @R2_ID, @DokTyp, @DokNumer, @DokLp, @DokKAZWycenaKolejnosc, @DokKAZKursWgWyceny

	While @@Fetch_Status = 0
	begin
		delete from @Nierozliczone where Numer = 2


		if @DokKAZWycenaKolejnosc &lt;&gt; 0 and @DokKAZKursWgWyceny &lt;&gt; 0
		begin
			insert into @Nierozliczone		
			select * from #Nierozliczone
			where Numer = 2 
				and R2_Wycena = 1
				and ParID = @ParID
				and KontoRej = 1
				and DT_WycenaParID = @ParID
				and isnull(DekretKazRoz,0) = 0
		end
		else
		begin
			insert into @Nierozliczone		
			select * from #Nierozliczone
			where Numer = 2 
				and R2_Wycena = 1
				and ParID = @ParID
				and KontoRej = 1
				and DT_WycenaParID = 0
				and isnull(DekretKazRoz,0) = 0
		end


		
		set @Dokument2 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 2)


		set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)
		if @Cnt2 = 0
		begin			
			if not exists(select * from #Nierozliczone where Numer = 2 and ParID = @ParID)
			begin
				goto lNext_cursDekr2
			end
			else
			begin
				set @Dokument2 = (select max(rtrim(Dokument)) from #Nierozliczone where Numer = 2 and ParID = @ParID)
				
				ROLLBACK TRAN				
				RAISERROR('200:Wyceniany zapis %s nie jest poprawnie zaksięgowany na konto rejestru', 16, 1, @Dokument2) 
				set @rv = 301
				goto lErr_cursDekr2
			end
		end		
		
		
		set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)
		if @Cnt1 = 0
		begin
			set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 1)
			ROLLBACK TRAN				
			RAISERROR('200:Zapis %s nie jest poprawnie zaksięgowany na konto rejestru', 16, 1, @szMsg1) 
			set @rv = 301
			goto lErr_cursDekr2
		end		

		
		if @Cnt2 &gt; 1
		begin			
			set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2 and Rozliczony = 1),0)	
			if @Cnt2 &gt; 0
			begin			
				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) &lt;&gt; 0),0)
				if @Cnt2 &gt; 0
				begin
					if @Cnt2 &gt; 1
					begin
						ROLLBACK TRAN				
						RAISERROR('200:Dla wycenianego zapisu %s dokonano już rozrachunku wyceny na więcej niż jednym dekrecie', 16, 1, @Dokument2) 
						set @rv = 301
						goto lErr_cursDekr2
					end
					else
					begin
						delete from @Nierozliczone where Numer = 2 and isnull(MaRozliczenie,0) = 0

						set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
						if @Cnt2 = 0 ---nie powinno sie zdarzyc
						begin					
							ROLLBACK TRAN				
							RAISERROR('200:Na dekrecie dokumentu %s dokonano już rozrachunku wyceny bez rozliczenia', 16, 1, @Dokument2) 
							set @rv = 301
							goto lErr_cursDekr2
						end				
					end
				end
				else
				begin
					delete from @Nierozliczone where Numer = 2 and Rozliczony &lt;&gt; 0

					set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
					if @Cnt2 = 0
					begin					
						ROLLBACK TRAN				
						RAISERROR('200:Na dekrecie zapisu wycenianego %s dokonano już rozrachunku wyceny', 16, 1, @Dokument2)
						set @rv = 301
						goto lErr_cursDekr2
					end			
				end												
			end
			else
			begin --nie ma rozrachowanych
				DELETE FROM a 
				FROM @Nierozliczone a 
						JOIN @Nierozliczone b 
							ON a.Numer=b.Numer 
							AND not (a.GIDNumer=b.GIDNumer and a.GIDLp=b.GIDLp and a.DC=b.DC)
				WHERE a.Numer = 2 AND a.KwotaSys = 0 AND b.KwotaSys &lt;&gt; 0;


				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
				if @Cnt2 &gt; 1
				begin
					set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)	
					if @Cnt1 = 1
					begin
						DELETE FROM a 
						FROM @Nierozliczone a 
						WHERE a.Numer = 2 
							AND EXISTS(SELECT * FROM @Nierozliczone b WHERE b.Numer = 1 AND b.Znak = a.Znak)


						set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
						if @Cnt2 &gt; 1
						begin
							ROLLBACK TRAN				
							RAISERROR('200:Dla wycenianego zapisu %s nie można ustalić pozycji dekretu do rozrachunku wyceny (1)', 16, 1, @Dokument2) 
							set @rv = 301
							goto lErr_cursDekr2
						end
					end
					else
					begin						
						ROLLBACK TRAN				
						RAISERROR('200:Dla wycenianego zapisu %s nie można ustalić pozycji dekretu do rozrachunku wyceny (2)', 16, 1, @Dokument2) 
						set @rv = 301
						goto lErr_cursDekr2
					end
				end
			end
		end
		--else --ok 1 dekret
				

		set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)
		if @Cnt1 &gt; 1
		begin
			DELETE FROM a 
			FROM @Nierozliczone a 
			WHERE a.Numer = 1
				AND EXISTS(SELECT * FROM @Nierozliczone b WHERE b.Numer = 2 AND b.Znak = a.Znak)

			set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)
			if @Cnt1 &gt; 1
			begin
				DELETE FROM a FROM @Nierozliczone a 
				WHERE a.Numer = 1 AND 
				NOT EXISTS(SELECT * 
					FROM @Nierozliczone b 
						left join cdn.KontaNastLinki c
							on b.KontoNumer = c.KLI_NastNumer and a.KontoNumer = c.KLI_PoprzNumer
						left join cdn.KontaNastLinki d
							on a.KontoNumer = d.KLI_NastNumer and b.KontoNumer = d.KLI_PoprzNumer
					WHERE b.Numer = 3-a.Numer AND b.Znak = 3-a.Znak AND not (c.KLI_NastNumer is null and d.KLI_NastNumer is null))

				set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)
				if @Cnt1 &gt; 1
				begin
					set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 1)
					ROLLBACK TRAN				
					RAISERROR('200:Na księgowanym zapisie %s nie można ustalić pozycji dekretu do rozrachunku wyceny', 16, 1, @szMsg1) 
					set @rv = 301
					goto lErr_cursDekr2
				end
			end
		end					


		set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)
		if @Cnt1 &gt; 1
		begin
			set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 1)
			ROLLBACK TRAN				
			RAISERROR('200:Na księgowanym zapisie %s nie można ustalić pozycji dekretu do rozrachunku wyceny', 16, 1, @szMsg1) 
			set @rv = 301
			goto lErr_cursDekr2
		end
		set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)
		if @Cnt2 &gt; 1
		begin			
			ROLLBACK TRAN				
			RAISERROR('200:Dla wycenianego zapisu %s nie można ustalić pozycji dekretu do rozrachunku wyceny (3)', 16, 1, @Dokument2) 
			set @rv = 301
			goto lErr_cursDekr2
		end

		
		goto lRozrachunek

lNext_cursDekr2:	
		fetch next from cursDekr2 into @ParID, @R2_ID, @DokTyp, @DokNumer, @DokLp, @DokKAZWycenaKolejnosc, @DokKAZKursWgWyceny
	end
end





---rozrachunek rozliczenia

delete from @Nierozliczone

if exists(select Numer from #Nierozliczone b where b.Numer = 1 and b.DekretKAZRoz &lt;&gt; 0)
	set @bKAZzRozl = 1
else
begin
	set @bKAZzRozl = 0	


	if not (@GIDTyp = 784 and @KAZZnak = 1 and @KAZWycenaKolejnosc &lt;&gt; 0 and @KAZKursWgWyceny &lt;&gt; 0)
	begin
		insert into @Nierozliczone
		select * from #Nierozliczone
		where Numer = 1				
			and DT_WycenaParID = 0
			and DekretKAZRoz = 0
			and KontoRej = 0
	end
end




declare cursDekr3 cursor LOCAL STATIC for
select
	ParID,
	IDRoz,
	R2_WycenaParID,
	DokTyp,
	DokNumer,
	DokLp,
	DokKAZLokata
from #Nierozliczone
where Numer = 2 and R2_Wycena = 0
group by ParID,
	IDRoz,
	R2_WycenaParID,
	DokTyp,
	DokNumer,
	DokLp,
	DokKAZLokata

Open cursDekr3

fetch next from cursDekr3 into @ParID, @R2_ID, @R2_WycenaParID, @DokTyp, @DokNumer, @DokLp, @DokKAZLokata

set @TrybRozrachunek = 3
set @bPobierzDekr1 = 1

While @@Fetch_Status = 0
begin

	

	if @bKAZzRozl = 1
	begin
		delete from @Nierozliczone

		insert into @Nierozliczone
		select * from #Nierozliczone
		where Numer = 1		
			and DT_WycenaParID = 0
			and DekretKAZRoz = @R2_ID
			and KontoRej = 0
	end
	else
	begin
		if @GIDTyp = 784 and @KAZZnak = 1 and @KAZWycenaKolejnosc &lt;&gt; 0 and @KAZKursWgWyceny &lt;&gt; 0
		begin
			delete from @Nierozliczone

			insert into @Nierozliczone
			select * from #Nierozliczone
			where Numer = 1				
				and DT_WycenaParID = @R2_WycenaParID
				and DekretKAZRoz = 0
				and KontoRej = 0
		end
		else
		begin
			delete from @Nierozliczone where Numer = 2
		end
	end

	insert into @Nierozliczone
	select * from #Nierozliczone
	where Numer = 2	
		and R2_Wycena = 0
		and ParID = @ParID
		and KontoRej = 0


	set @Dokument2 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 2)


	if (@KAZLokata = 1 and (@DokTyp &lt;&gt; 784 or @DokTyp = 784 and @DokKAZLokata &lt;&gt; @KAZLokata)) 	
	begin
		ROLLBACK TRAN				
		RAISERROR('200:Zapis bankowy związany z lokatą %s posiada niedozwolone rozliczenie z dokumentem %s. Usuń wskazane rozliczenie. Zamknij lokatę/nalicz odsetki ponownie', 16, 1, @Dokument1, @Dokument2) 
		set @rv = 301
		goto lErr_cursDekr3
	end

	if @DokTyp = 784 and @DokKAZLokata = 1 and @KAZLokata &lt;&gt; 1
	begin
		ROLLBACK TRAN				
		RAISERROR('200:Zapis bankowy związany z lokatą %s posiada niedozwolone rozliczenie z zapisem %s. Usuń wskazane rozliczenie. Zamknij lokatę/nalicz odsetki ponownie', 16, 1, @Dokument2, @Dokument1) 
		set @rv = 301
		goto lErr_cursDekr3
	end


	set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)
	if @Cnt1 = 0
	begin		
		if @KAZLokata = 0		
		begin
			ROLLBACK TRAN				
			RAISERROR('200:Zapis %s nie jest poprawnie zaksięgowany na konto podmiotu', 16, 1, @Dokument1) 
			set @rv = 301
			goto lErr_cursDekr3
		end
		else
		begin 
			goto lNext_cursDekr3
		end
	end



	set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)
	if @Cnt2 = 0
	begin --nie moze sie zdarzyc				
		if @DokKAZLokata = 0		
		begin
			ROLLBACK TRAN				
			RAISERROR('200:Zapis %s nie jest poprawnie zaksięgowany na konto podmiotu', 16, 1, @Dokument2) 
			set @rv = 301
			goto lErr_cursDekr3
		end
		else
		begin
			goto lNext_cursDekr3
		end
	end		
	else if @Cnt2 &gt; 1
	begin
		if @DokTyp = 784
		begin
			/*
			1. dla KB jesli jest dekret w oparciu o to rozliczenie to go zostaw , pozostale wyrzuc
			2. dla KB jesli nie jest dekret w oparciu o to rozliczenie to wyrzuc wszystkie w oparciu o rozliczenie i zostaw tylko w oparciu o kase
				jesli jest to wyceniane KW to pomin rowniez w oparciu o kase dla ktorych DT_WycenaParID &lt;&gt; R2_WycenaParID
			*/
			
			Delete from @Nierozliczone
			where Numer = 2
				and DekretKAZRoz &lt;&gt; @R2_ID			
				and exists (select b.Numer from @Nierozliczone b where b.Numer = 2 and b.DekretKAZRoz = @R2_ID)
	
		
	

			Delete from @Nierozliczone
			where Numer = 2
				and DekretKAZRoz &lt;&gt; 0
				and not exists (select b.Numer from @Nierozliczone b where b.Numer = 2 and b.DekretKAZRoz = @R2_ID)
				and exists (select b.Numer from @Nierozliczone b where b.Numer = 2 and b.DekretKAZRoz &lt;&gt; 0)



			set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
			if @Cnt2 = 0
			begin				
				ROLLBACK TRAN				
				RAISERROR('200:Dekret zapisu rozliczającego %s nie posiada pozycji powstałej w oparciu o Kasę', 16, 1, @Dokument2) 
				set @rv = 301
				goto lErr_cursDekr3
			end



			Delete from @Nierozliczone
			where Numer = 2
				and DekretKAZRoz = 0
				and not exists (select b.Numer from @Nierozliczone b where b.Numer = 2 and b.DekretKAZRoz = @R2_ID)
				and exists (select b.Numer from @Nierozliczone b where b.Numer = 2 and b.DT_WycenaParID &lt;&gt; 0)
				and DT_WycenaParID &lt;&gt; @R2_WycenaParID


			set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
			if @Cnt2 = 0
			begin				
				ROLLBACK TRAN				
				RAISERROR('200:Rozliczenie z zapisem %s jest błędne. Usuń rozliczenie i wykonaj operację ponownie', 16, 1, @Dokument2) 
				set @rv = 301
				goto lErr_cursDekr3
			end
		end



		set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
		if @Cnt2 &gt; 1
		begin
			set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2 and Rozliczony = 1),0)	
			if @Cnt2 &gt; 0
			begin			
				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) &lt;&gt; 0),0)
				if @Cnt2 &gt; 0
				begin
					if @Cnt2 &gt; 1
					begin
						ROLLBACK TRAN				
						RAISERROR('200:Dla dokumentu %s dokonano już rozrachunku wraz z rozliczeniem na więcej niż jednym dekrecie', 16, 1, @Dokument2) 
						set @rv = 301
						goto lErr_cursDekr3
					end
					else
					begin
						delete from @Nierozliczone where Numer = 2 and isnull(MaRozliczenie,0) = 0

						set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
						if @Cnt2 = 0 ---nie powinno sie zdarzyc
						begin					
							ROLLBACK TRAN				
							RAISERROR('200:Na dekrecie dokumentu %s dokonano już rozrachunku bez rozliczenia', 16, 1, @Dokument2) 
							set @rv = 301
							goto lErr_cursDekr3
						end				
					end
				end
				else
				begin
					delete from @Nierozliczone where Numer = 2 and Rozliczony &lt;&gt; 0 

					set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
					if @Cnt2 = 0
					begin					
						ROLLBACK TRAN				
						RAISERROR('200:Na dekrecie dokumentu %s dokonano już rozrachunku bez rozliczenia', 16, 1, @Dokument2) 
						set @rv = 301
						goto lErr_cursDekr3
					end			
				end												
			end
			else
			begin --nie ma rozrachowanych
				DELETE FROM a 
				FROM @Nierozliczone a 
						JOIN @Nierozliczone b 
							ON a.Numer=b.Numer 
							AND not (a.GIDNumer=b.GIDNumer and a.GIDLp=b.GIDLp and a.DC=b.DC)
				WHERE a.Numer = 2 AND a.KwotaSys = 0 AND b.KwotaSys &lt;&gt; 0;


				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
				if @Cnt2 &gt; 1
				begin
					set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)	
					if @Cnt1 = 1
					begin
						DELETE FROM a 
						FROM @Nierozliczone a 
						WHERE a.Numer = 2 
							AND EXISTS(SELECT * FROM @Nierozliczone b WHERE b.Numer = 1 AND b.Znak = a.Znak)


						set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)	
						if @Cnt2 &gt; 1
						begin							
							ROLLBACK TRAN				
							RAISERROR('200:Dla dokumentu %s nie można ustalić pozycji dekretu do rozrachunku (1)', 16, 1, @Dokument2) 
							set @rv = 301
							goto lErr_cursDekr3
						end
					end
					else
					begin						
						ROLLBACK TRAN				
						RAISERROR('200:Dla dokumentu %s nie można ustalić pozycji dekretu do rozrachunku (2)', 16, 1, @Dokument2) 
						set @rv = 301
						goto lErr_cursDekr3
					end
				end
			end
		end
		--else --ok 1 dekret
	end
	
				

	set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)
	if @Cnt1 &gt; 1
	begin
		DELETE FROM a 
		FROM @Nierozliczone a 
		WHERE a.Numer = 1
			AND EXISTS(SELECT * FROM @Nierozliczone b WHERE b.Numer = 2 AND b.Znak = a.Znak)

		set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)
		if @Cnt1 &gt; 1
		begin
			DELETE FROM a FROM @Nierozliczone a 
			WHERE a.Numer = 1 AND 
			NOT EXISTS(SELECT * 
				FROM @Nierozliczone b 
					left join cdn.KontaNastLinki c
						on b.KontoNumer = c.KLI_NastNumer and a.KontoNumer = c.KLI_PoprzNumer
					left join cdn.KontaNastLinki d
						on a.KontoNumer = d.KLI_NastNumer and b.KontoNumer = d.KLI_PoprzNumer
				WHERE b.Numer = 3-a.Numer AND b.Znak = 3-a.Znak AND not (c.KLI_NastNumer is null and d.KLI_NastNumer is null))

			set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)
			if @Cnt1 &gt; 1
			begin				
				ROLLBACK TRAN				
				RAISERROR('200:Na księgowanym dokumencie %s nie można ustalić pozycji dekretu do rozrachunku wraz z rozliczeniem', 16, 1, @Dokument1) 		
				set @rv = 301
				goto lErr_cursDekr3
			end
		end
	end					


	set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 1),0)
	if @Cnt1 &gt; 1
	begin
		ROLLBACK TRAN				
		RAISERROR('200:Na księgowanym dokumencie %s nie można ustalić pozycji dekretu do rozrachunku wraz z rozliczeniem', 16, 1, @Dokument1) 
		set @rv = 301
		goto lErr_cursDekr3
	end
	set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone where Numer = 2),0)
	if @Cnt2 &gt; 1
	begin		
		ROLLBACK TRAN				
		RAISERROR('200:Dla dokumentu rozliczającego %s nie można ustalić pozycji dekretu do rozrachunku wraz z rozliczeniem', 16, 1, @Dokument2) 
		set @rv = 301
		goto lErr_cursDekr3
	end

		
	goto lRozrachunek

lNext_cursDekr3:	

	fetch next from cursDekr3 into @ParID, @R2_ID, @R2_WycenaParID, @DokTyp, @DokNumer, @DokLp, @DokKAZLokata
end


goto lExit_ok
---------------------------------------------------------------------------------------


lRozrachunek:


if @TrybRozrachunek = 3
begin
	set @DokumentRK = @KonfDokumentRK
	set @DokumentRKAutomat = @KonfDokumentRKAutomat
end
else
begin
	set @DokumentRK = 1
	set @DokumentRKAutomat = 1
end


if @TrybRozrachunek = 1 or 
	(@TrybRozrachunek = 2 and @bPobierzDekr1 = 1) or 
	(@TrybRozrachunek = 3 and (@bKAZzRozl = 1 or @bPobierzDekr1 = 1 or (@GIDTyp = 784 and @KAZZnak = 1 and @KAZWycenaKolejnosc &lt;&gt; 0 and @KAZKursWgWyceny &lt;&gt; 0)))
begin
	SELECT 
		@KwotaDTWal1 = KwotaWal, 
		@KwotaDTSys1 = KwotaSys, 
		@DataRoz1 = Data, 
  		@Waluta1 = Waluta, 
  		@KursDTL1 = KursL,
		@KursDTM1 = KursM,
		@Dekret1DC = DC, 
		@Konto1 = Konto, 
		@Konto1Numer = KontoNumer, 
		@Konto1TypPozabil = KontoTypPozabil,
		@Znak1 = Znak,
  		@KontoWal1 = KontoWal, 
		@KontoWal1Numer = KontoWalNumer, 
  		@Dekret1Numer = GIDNumer, 
		@Dekret1Lp = GIDLp,
		@Kurs1 = case when DTKwotaWal is null then 1 else DTKwotaSys/(case when isnull(DTKwotaWal,0)=0 then 1 else isnull(DTKwotaWal,0) end) end
	FROM @Nierozliczone WHERE Numer = 1


	IF @@ERROR &lt;&gt; 0
	BEGIN
		ROLLBACK TRAN
		RAISERROR('200:Błąd pobrania wiersza do rozrachunku', 16, 1) 
		set @rv = 301
		goto lErr_Rozrachunek
	END

	set @bPobierzDekr1 = 0
end


SELECT 
	@KwotaDTWal2 = KwotaWal, 
	@KwotaDTSys2 = KwotaSys, 
	@DataRoz2 = Data, 
  	@Waluta2 = Waluta, 
  	@KursDTL2 = KursL,
	@KursDTM2 = KursM,
	@Dekret2DC = DC, 
	@Konto2 = Konto, 
	@Konto2Numer = KontoNumer, 
	@Konto2TypPozabil = KontoTypPozabil,
	@Znak2 = Znak,
  	@KontoWal2 = KontoWal, 
	@KontoWal2Numer = KontoWalNumer, 
  	@Dekret2Numer = GIDNumer, 
	@Dekret2Lp = GIDLp,
	@Kurs2 = Kurs,
	@Termin2 = Termin,
	@KwotaRozWal = KwotaRozWal,
	@KwotaRozSys = KwotaRozSys, 
	@R2_Wycena = R2_Wycena,
	@R2_WycenaParID = R2_WycenaParID,
	@IDRoz = IDRoz,
	@Dokument2 = Dokument,
	@r2_strona = r2_Strona,
	@DataRozliczenia = DataRozl,
	@R2_RK = R2_RK,
	@R2_RKStrona = R2_RKStrona
FROM @Nierozliczone WHERE Numer = 2


IF @@ERROR &lt;&gt; 0
BEGIN
	ROLLBACK TRAN
	RAISERROR('200:Błąd pobrania wiersza do rozrachunku', 16, 1) 
	set @rv = 301
	goto lErr_Rozrachunek
END



SET @Sav1Numer = @Dekret1Numer 
SET @Sav1Lp = @Dekret1Lp 
SET @Sav1DC	= @Dekret1DC 




set @RoznicaKursowa = 0		
set @KwotaWal = 0
set @KwotaSys = 0
SET @Dod1 = 0
SET @Dod2 = 0
set @RKN_ID = 0



IF @Dekret1Numer = @Dekret2Numer AND @Dekret1Lp = @Dekret2Lp
BEGIN
	ROLLBACK TRAN
	RAISERROR('501:Nie można rozrachować dekretu z nim samym. Rozrachunek niemożliwy.', 16, 1) 
	set @rv = 301
	goto lErr_Rozrachunek
END

IF @Znak1 = @Znak2 
BEGIN
	ROLLBACK TRAN
	if @TrybRozrachunek = 3
		RAISERROR('502:Rozrachunek niemożliwy. Dekrety możliwe do rozrachunku posiadają konta po tej samej stronie', 16, 1) 
	else
		RAISERROR('502:Rozrachunek wyceny niemożliwy. Dekrety możliwe do rozrachunku posiadają konta po tej samej stronie', 16, 1) 
	set @rv = 301
	goto lErr_Rozrachunek
END




-- sprawdzenie waluty
IF @Waluta1 &lt;&gt; @Waluta2 AND @Waluta1 &lt;&gt; @WalutaSys AND @Waluta2 &lt;&gt; @WalutaSys
BEGIN
	ROLLBACK TRAN
	RAISERROR('101:Niezgodne waluty rozrachunku.', 16, 1) 
	set @rv = 301
	goto lErr_Rozrachunek
END


IF @Konto1TypPozabil&lt;&gt;@Konto2TypPozabil
BEGIN
	ROLLBACK TRAN
	RAISERROR('102:Nie można dokonywać rozrachunku na kontach o różnych typach - bilansowe, pozabilansowe', 16, 1) 
	set @rv = 301
	goto lErr_Rozrachunek
END


if (@Waluta1 &lt;&gt; @WalutaSys or @Waluta2 &lt;&gt; @WalutaSys) and @Waluta1 = @Waluta2
begin

	--sprawdz czy rozliczane dokumenty maja wystawiony dokument RK
	set @RKN_ID = isnull((select max(RKNID) 
				from 
					(select R2_Dok1Numer RKNID
					from cdn.Rozliczenia
					where R2_Dok1Typ = 435 and R2_ParID = @ParID
					and R2_Dok2Typ = @GIDTyp and R2_Dok2Numer = @GIDNumer and R2_Dok2Lp = @GIDLp
					UNION all
					select R2_Dok1Numer RKNID
					from cdn.Rozliczenia
					where R2_Dok1Typ = 435 and R2_ParID = @ParID 
					and R2_Dok2Typ = @DokTyp and R2_Dok2Numer = @DokNumer and R2_Dok2Lp = @DokLp
					UNION all
					select R2_Dok2Numer RKNID
					from cdn.Rozliczenia
					where R2_Dok2Typ = 435 and R2_ParID = @ParID
					and R2_Dok1Typ = @GIDTyp and R2_Dok1Numer = @GIDNumer and R2_Dok1Lp = @GIDLp
					UNION all
					select R2_Dok2Numer RKNID
					from cdn.Rozliczenia
					where R2_Dok2Typ = 435 and R2_ParID = @ParID 
					and R2_Dok1Typ = @DokTyp and R2_Dok1Numer = @DokNumer and R2_Dok1Lp = @DokLp
					) a1
				),0)


	if @RKN_ID &lt;&gt; 0
		set @DokumentRK_Zrodlowy = cdn.NazwaObiektu (435, @RKN_ID, 0, 2)
	else
		set @DokumentRK_Zrodlowy = ''
end
else
begin
	set @DokumentRK_Zrodlowy = ''
	set @RKN_ID = 0
end




exec cdn.UstalKwoteRozliczenia 
	@Waluta1,
	@KwotaRozWal,
	@KwotaRozSys,
	@KwotaDTWal1,
	@KwotaDTSys1,						
	@Waluta2,
	@KwotaRozWal,
	@KwotaRozSys,
	@KwotaDTWal2,
	@KwotaDTSys2,							
	@WalutaSys,
	0,
	0,
	@poz_DecKwota,
	1,
	0,
	@Kurs1 output,
	@Kurs2 output,
	@KwotaWal output,
	@KwotaSys output,
	@RozliczenieCalkowite output,
	@RoznicaKursowa output,
	@StronaRK output,
	@BZ output,
	@KwotaRozSys1 output,
	@KwotaRozSys2 output,
	@StronaRozl output





IF @KwotaRozWal &gt; @KwotaWal 
BEGIN
	set @szMsg1 = convert(varchar, @KwotaRozWal)
	set @szMsg2 = convert(varchar, @KwotaWal)
	ROLLBACK TRAN
	if @TrybRozrachunek = 3
		RAISERROR('111:Operacja anulowana. Kwota rozliczenia %s z dokumentem %s jest większa od dopuszczalnej kwoty rozrachunku %s na zapisach księgowych. ', 16, 1, @szMsg1, @Dokument2, @szMsg2) 
	else
		RAISERROR('111:Operacja anulowana. Kwota rozliczenia wyceny %s z dokumentem %s jest większa od dopuszczalnej kwoty rozrachunku %s na zapisach księgowych. ', 16, 1, @szMsg1, @Dokument2, @szMsg2) 

	set @rv = 301
	goto lErr_Rozrachunek
END



IF @KwotaRozWal = @KwotaWal and @KwotaRozSys &lt;&gt; @KwotaSys
BEGIN
	ROLLBACK TRAN
	RAISERROR('111:Operacja anulowana. Kurs na dokumencie źródłowym %s jest różny od kursu na dekrecie księgowym dokumentu ', 16, 1,@Dokument2) 
	set @rv = 301
	goto lErr_Rozrachunek
END


if @StronaRK = 2
begin
	set @KursDTL = @KursDTL1
	set @KursDTM = @KursDTM1
end
else
begin
	set @KursDTL = @KursDTL2
	set @KursDTM = @KursDTM2
end


set @KwotaWal = @KwotaRozWal
set @KwotaSys = @KwotaRozSys



if @RKN_ID &lt;&gt; 0
begin
	if @DokumentRK = 0
	BEGIN
		ROLLBACK TRAN
		RAISERROR('113:Operacja anulowana. Do księgowanego dokumentu %s jest wystawiony dokument różnicy kursowej niezgodnie z ustawieniami w konfiguracji', 16, 1, @Dokument2) 
		set @rv = 301
		goto lErr_Rozrachunek
	END	


	if @DokumentRKAutomat = 0
	begin
	--ksieguj recznie dokument roznicy kursowej			

		set @RoznicaKursowa = 0		
		set @KwotaWal = 0
		set @KwotaSys = 0
		SET @Dod1 = 0
		SET @Dod2 = 0
		set @RKN_ID = 0

		goto lNextRozrachunek
	end	


	--pobierz dane dokumentu RK			
	select 
		@RoznicaKursowa = RKN_Kwota,
		@RKN_DataRozl = RKN_DataRozl,
		@RK_R2_ID = R2_ID,
		@RK_R2_DokTyp = R2_Dok2Typ,
		@RK_R2_DokNumer = R2_Dok2Numer,
		@StronaRK_Rozl = 1,
		@RKN_BZ = RKN_BZ,
		@RKN_Seria = RKN_Seria,
		@RKN_DataWyst = RKN_DataWyst,
		@RKN_Numer = RKN_Numer
	from cdn.RozniceKursowe 
		left join cdn.Rozliczenia
			on 435 = R2_Dok1Typ and RkN_ID = R2_Dok1Numer
	where RKN_ID = @RKN_ID

	


	if isnull(@RK_R2_ID,0) = 0
		select 
			@RK_R2_ID = R2_ID,
			@RK_R2_DokTyp = R2_Dok1Typ,
			@RK_R2_DokNumer = R2_Dok1Numer,
			@StronaRK_Rozl = 2
		from cdn.Rozliczenia
		where 435 = R2_Dok2Typ and @RKN_ID = R2_Dok2Numer			



	IF EXISTS(SELECT ZRO_TRNTyp FROM CDN.Zrodla with(nolock) 
		JOIN CDN.Dekrety 
			ON ZRO_DTTyp=DT_GIDTyp AND ZRO_DTNumer=DT_GIDnumer AND ZRO_DTLp=DT_GIDLp 
 			WHERE ZRO_TRNTyp = 435 AND ZRO_TRNNumer = @RKN_ID)

		SET @RKN_Zaksiegowano = 1
	ELSE
		SET @RKN_Zaksiegowano = 0		



	if isnull(@RKN_Zaksiegowano,0) &lt;&gt; 0
	BEGIN
		ROLLBACK TRAN
		RAISERROR('112:Błąd danych. Dokument różnic kursowych %s jest już zaksięgowany', 16, 1, @DokumentRK_Zrodlowy) 
		set @rv = 301
		goto lErr_Rozrachunek
	END	



	--ustal strone RK z dokumentu RK
	if @RK_R2_DokTyp = @GIDTyp and @RK_R2_DokNumer = @GIDNumer
		set @StronaRK = 1
	else
		set @StronaRK = 2



	set @BZ = @RKN_BZ
	
end
else -- nie ma dok RK
begin
	if (@Waluta1 &lt;&gt; @WalutaSys or @Waluta2 &lt;&gt; @WalutaSys) and @Waluta1 = @Waluta2
	begin

		set @RoznicaKursowa = isnull(@R2_RK,0)


		if @TrybRozrachunek &lt;&gt; 3 and @RoznicaKursowa &lt;&gt; 0		
		BEGIN
			ROLLBACK TRAN
			RAISERROR('112:Wykonana wcześniej wycena z zapisem %s jest błędna. Brak dokumentu różnic kursowych', 16, 1, @Dokument2) 				
			set @rv = 301
			goto lErr_Rozrachunek
		END					

		
		if @r2_strona = isnull(@R2_RKStrona,0)
			set @StronaRK = 1	
		else
			set @StronaRK = 2


		if @Kurs1 = @Kurs2
			set @BZ = 1
	end
end
	



-- ewentualna kompensata
SELECT @DataDzisiejszaKomp = ISNULL(KON_Wartosc,0) FROM CDN.Konfig with(nolock) WHERE KON_Numer = 2058



IF @DataDzisiejszaKomp = 2
	IF @Termin1 &lt; @Termin2
		SET @DataKomp = @Termin2
	ELSE
		SET @DataKomp = @Termin1
ELSE
	IF @DataRoz1 &lt; @DataRoz2
		SET @DataKomp = @DataRoz2
	ELSE
		SET @DataKomp = @DataRoz1




IF @DataDzisiejszaKomp = 1 and @DataKomp &lt; @DataDzisiejsza
		SET @DataKomp = @DataDzisiejsza  



if @DataKomp &lt; @DataRozliczenia 
	SET @DataKomp = @DataRozliczenia




--ustal date rozrachunku
if @DataRoz1 &lt; @DataRoz2
	set @DataRozrachunku = @DataRoz2
else
	set @DataRozrachunku = @DataRoz1



if @DataKomp &lt; @DataRozrachunku 
	SET @DataKomp = @DataRozrachunku



set @OldKonto1Numer = @Konto1Numer
set @OldKonto2Numer = @Konto2Numer
set @OldKonto1 = @Konto1
set @OldKonto2 = @Konto2
set @OldKontoWal1Numer = @KontoWal1Numer
set @OldKontoWal2Numer = @KontoWal2Numer
set @OldKontoWal1 = @KontoWal1
set @OldKontoWal2 = @KontoWal2



EXEC @KontaNieTozsame = CDN.PorownajKonta @DataRozrachunku, @Konto1Numer OUTPUT, @Konto1 OUTPUT, @Konto2Numer OUTPUT, @Konto2 OUTPUT, @KontoWal1Numer OUTPUT, @KontoWal1 OUTPUT, @KontoWal2Numer OUTPUT, @KontoWal2 OUTPUT


if @KontaNieTozsame = -1
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. Błędne parametry procedury cdn.PorownajKonta ', 16, 1) 
	set @rv = 301
	goto lErr_Rozrachunek
end
else if @KontaNieTozsame = 2
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe rozrachowywanych dekretów są ze sobą tożsame, pozabilansowe nie', 16, 1) 
	set @rv = 301
	goto lErr_Rozrachunek
end
else if @KontaNieTozsame = 3
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe i pozabilansowe jednego z rozrachowywanych dekretów nie są z tego samego okresu ', 16, 1) 
	set @rv = 301
	goto lErr_Rozrachunek
end
else if @KontaNieTozsame = 4
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. W okresie, w którym dokonywany jest rozrachunek nie istnieje konto tożsame do konta rozrachowywanego dekretu ', 16, 1) 
	set @rv = 301
	goto lErr_Rozrachunek
end
else if @KontaNieTozsame = 5
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. Nie istnieje konto o podanym identyfikatorze ', 16, 1) 
	set @rv = 301
	goto lErr_Rozrachunek
end
else if @KontaNieTozsame = 1
BEGIN
	SET @OpisKompensaty = 'Kompensata: ' + RTRIM( @Dokument1 ) + ' - ' + RTRIM( @Dokument2 )


	if @DataKomp &gt; @DataRozrachunku 
	begin
		SET @DataRozrachunku = @DataKomp

		set @Konto1Numer = @OldKonto1Numer
		set @Konto2Numer = @OldKonto2Numer
		set @Konto1 = @OldKonto1
		set @Konto2 = @OldKonto2
		set @KontoWal1Numer = @OldKontoWal1Numer
		set @KontoWal2Numer = @OldKontoWal2Numer
		set @KontoWal1 = @OldKontoWal1
		set @KontoWal2 = @OldKontoWal2



	  	EXEC @KontaNieTozsame = CDN.PorownajKonta @DataRozrachunku, @Konto1Numer OUTPUT, @Konto1 OUTPUT, @Konto2Numer OUTPUT, @Konto2 OUTPUT, @KontoWal1Numer OUTPUT, @KontoWal1 OUTPUT, @KontoWal2Numer OUTPUT, @KontoWal2 OUTPUT

		
		--tutaj powinny co najwyzej byc bledy 1, 4
		if @KontaNieTozsame = -1
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. Błędne parametry procedury cdn.PorownajKonta ', 16, 1) 
			set @rv = 301
			goto lErr_Rozrachunek
		end
		else if @KontaNieTozsame = 2
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe rozrachowywanych dekretów są ze sobą tożsame, pozabilansowe nie', 16, 1) 
			set @rv = 301
			goto lErr_Rozrachunek
		end
		else if @KontaNieTozsame = 3
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe i pozabilansowe jednego z rozrachowywanych dekretów nie są z tego samego okresu ', 16, 1) 
			set @rv = 301
			goto lErr_Rozrachunek
		end
		else if @KontaNieTozsame = 4
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. W okresie, w którym dokonywany jest rozrachunek z dekretem kompensacyjnym nie istnieje konto tożsame do konta rozrachowywanego dekretu ', 16, 1) 
			set @rv = 301
			goto lErr_Rozrachunek
		end
		else if @KontaNieTozsame = 5
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. Nie istnieje konto o podanym identyfikatorze ', 16, 1) 
			set @rv = 301
			goto lErr_Rozrachunek
		end
		--else if @KontaNieTozsame = 1
		--begin

		--end
	end



	IF @Znak1 = 1
	BEGIN
		EXEC CDN.DodajKompensate @GIDFirma, @DataRozrachunku, @UserID, @KwotaSys, @WalutaSys, 
		@Konto2, @Konto2Numer, @Konto1, @Konto1Numer,  
		@KwotaWal, @KontoWal2, @KontoWal2Numer,  @Waluta2,
		@KwotaWal, @KontoWal1, @KontoWal1Numer,  @Waluta1, @KursDTL, @KursDTM,
		@OpisKompensaty, @KompGIDNumer OUTPUT, @DataDzisiejsza
	END
	ELSE
	BEGIN
		EXEC CDN.DodajKompensate @GIDFirma, @DataRozrachunku, @UserID, @KwotaSys, @WalutaSys, 
		@Konto1, @Konto1Numer,  @Konto2, @Konto2Numer,  
		@KwotaWal, @KontoWal1, @KontoWal1Numer,  @Waluta1,
		@KwotaWal, @KontoWal2, @KontoWal2Numer,  @Waluta2, @KursDTL, @KursDTM,
		@OpisKompensaty, @KompGIDNumer OUTPUT, @DataDzisiejsza
	END


	IF @@TRANCOUNT = 0
	begin
		set @rv = 301
		goto lErr_Rozrachunek
	end


	
	INSERT INTO CDN.Rozliczenia(
	  R2_Dekret1Numer, R2_Dekret1Lp, R2_Dekret1DC, R2_Waluta1, R2_KwotaWal1, 
	  R2_Dekret2Numer, R2_Dekret2Lp, R2_Dekret2DC, R2_Waluta2, R2_KwotaWal2, 
	  R2_KwotaSys, R2_DataRozrachunku, R2_OpeNumerRZ, 
	  R2_GIDFirma, R2_Dekret1Dod, R2_Dekret2Dod, R2_ParID,
	  R2_Wycena, R2_WycenaParID, R2_PozostajeZWyc, R2_PozostajeZWycSys ) 
	VALUES( 
	  @Dekret1Numer, @Dekret1Lp, @Dekret1DC, @Waluta1, @KwotaWal, 
	  @KompGIDNumer, 1, 3-@Znak1, @Waluta2, @KwotaRozWal, 
	  @KwotaRozSys, @DataRozrachunku, @UserID,
	  @GIDFirma, 0, 1, @ParID,
	  case when @TrybRozrachunek &lt;&gt; 3 then 1 else 0 end, @R2_WycenaParID, 0, 0 )
	IF @@ERROR &lt;&gt; 0
	BEGIN
		ROLLBACK TRAN
		RAISERROR('102:Błąd dodania rozliczenia', 16, 1) 
		set @rv = 301
		goto lErr_Rozrachunek
	END



	UPDATE CDN.Dekrety SET 
		DT_Pozostaje = DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END,
		DT_Rozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END = DT_Kwota THEN 0 ELSE 1 END,
		DT_Nierozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END = 0 THEN 0 ELSE 1 END
	WHERE DT_GIDNumer = @Dekret1Numer AND DT_GIDLp = @Dekret1Lp AND DT_DC = @Dekret1DC


	IF @@ERROR &lt;&gt; 0
	BEGIN
		ROLLBACK TRAN
		RAISERROR('202:Błąd aktualizacji tabeli Dekrety', 16, 1) 
		set @rv = 301
		goto lErr_Rozrachunek
	END


	
	UPDATE CDN.Dekrety SET 
		DT_Pozostaje = DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END,
		DT_Rozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END = DT_Kwota THEN 0 ELSE 1 END,
		DT_Nierozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END = 0 THEN 0 ELSE 1 END
	WHERE DT_GIDNumer = @KompGIDNumer AND DT_GIDLp = 1 AND DT_DC = 3-@Znak1


	IF @@ERROR &lt;&gt; 0
	BEGIN
		ROLLBACK TRAN
		RAISERROR('202:Błąd aktualizacji tabeli dekrety', 16, 1) 
		set @rv = 301
		goto lErr_Rozrachunek
	END

	SET @Dekret1Numer = @KompGIDNumer
	SET @Dekret1Lp = 1
	SET @Dekret1DC = @Znak1	
	SET @Dod1 = 1
END


IF @KwotaSys = 0 
BEGIN
	RAISERROR( '360:Dekret wynikowy został rozrachowany z innym dekretem. Kwota pozostająca do rozrachunku jest mniejsza niż kwota rozliczenia. Księgowanie niemożliwe.', 16, 1) 
	ROLLBACK TRAN 		
	set @rv = 301
	goto lErr_Rozrachunek
END


if @r2_strona = 1
begin	
	UPDATE CDN.Rozliczenia SET 
		R2_Dekret1Numer = @Dekret1Numer, 
		R2_Dekret1Lp = @Dekret1Lp, 
		R2_Dekret1DC = @Dekret1DC, 
		R2_Dekret1Dod = @Dod1,
		R2_Dekret2Numer = @Dekret2Numer, 
		R2_Dekret2Lp = @Dekret2Lp, 
		R2_Dekret2DC = @Dekret2DC, 
		R2_Dekret2Dod = @Dod2,
		R2_KwotaSys = @KwotaSys, 
		R2_KwotaWal1 = @KwotaWal, 
		R2_KwotaWal2 = @KwotaWal, 
		R2_DataRozrachunku = @DataRozrachunku,
		R2_OpeNumerRZ = @UserID
	WHERE R2_ID = @IDRoz
end
else
begin	
	UPDATE CDN.Rozliczenia SET 
		R2_Dekret1Numer = @Dekret2Numer, 
		R2_Dekret1Lp = @Dekret2Lp, 
		R2_Dekret1DC = @Dekret2DC, 
		R2_Dekret1Dod = @Dod2,
		R2_Dekret2Numer = @Dekret1Numer, 
		R2_Dekret2Lp = @Dekret1Lp, 
		R2_Dekret2DC = @Dekret1DC, 
		R2_Dekret2Dod = @Dod1,
		R2_KwotaSys = @KwotaSys, 
		R2_KwotaWal1 = @KwotaWal, 
		R2_KwotaWal2 = @KwotaWal, 
		R2_DataRozrachunku = @DataRozrachunku,
		R2_OpeNumerRZ = @UserID
	WHERE R2_ID = @IDRoz
end


IF @@ERROR &lt;&gt; 0
BEGIN
	RAISERROR( '36:Błąd księgowania', 16, 1) 
	ROLLBACK TRAN 
	set @rv = 301
	goto lErr_Rozrachunek
END




-- aktualizacja flag i kwot na dekretach
UPDATE CDN.Dekrety SET 
	DT_Pozostaje = DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END,
	DT_Rozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END = DT_Kwota THEN 0 ELSE 1 END,
	DT_Nierozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END = 0 THEN 0 ELSE 1 END
WHERE DT_GIDNumer = @Dekret1Numer AND DT_GIDLp = @Dekret1Lp AND DT_DC = @Dekret1DC


IF @@ERROR &lt;&gt; 0
BEGIN
	ROLLBACK TRAN
	RAISERROR('202:Błąd aktualizacji tabeli dekrety', 16, 1) 
	set @rv = 301
	goto lErr_Rozrachunek
END



UPDATE CDN.Dekrety SET 
	DT_Pozostaje = DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END,
	DT_Rozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END = DT_Kwota THEN 0 ELSE 1 END,
	DT_Nierozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END = 0 THEN 0 ELSE 1 END
WHERE DT_GIDNumer = @Dekret2Numer AND DT_GIDLp = @Dekret2Lp AND DT_DC = @Dekret2DC


IF @@ERROR &lt;&gt; 0
BEGIN
	ROLLBACK TRAN
	RAISERROR('202:Błąd aktualizacji tabeli dekrety', 16, 1) 
	set @rv = 301
	goto lErr_Rozrachunek
END



SET @Dekret1Numer = @Sav1Numer
SET @Dekret1Lp = @Sav1Lp
SET @Dekret1DC = @Sav1DC	




IF (@RKN_ID = 0 and @RoznicaKursowa &lt;&gt; 0) or (@RKN_ID &lt;&gt; 0 and @DokumentRKAutomat &lt;&gt; 0) 
BEGIN

	
	SELECT @DataDzisiejszaRK = ISNULL(KON_Wartosc,0) FROM CDN.Konfig with(nolock) WHERE KON_Numer = 2057
	


	if @RKN_ID &lt;&gt; 0
	begin
		if @RKN_DataRozl &gt; @DataRozrachunku	
			SET @DataRK = @RKN_DataRozl
		else
			SET @DataRK = @DataRozrachunku
	end
	else
		SET @DataRK = @DataRozrachunku
	

	--IF @DataDzisiejszaRK = 1 and @DataRK &lt; @DataDzisiejsza --data dzisiejsza dotyczy dok Rk a nie dekretu RK
 --   	SET @DataRK = @DataDzisiejsza  --DATEDIFF( dd, '18001228', Getdate() )
						



	set @Konto1Numer = @OldKonto1Numer
	set @Konto2Numer = @OldKonto2Numer
	set @Konto1 = @OldKonto1
	set @Konto2 = @OldKonto2



	EXEC @KontaNieTozsame = CDN.PorownajKonta @DataRK, @Konto1Numer OUTPUT, @Konto1 OUTPUT, @Konto2Numer OUTPUT, @Konto2 OUTPUT 

	if @KontaNieTozsame = -1
	begin
		ROLLBACK TRAN
		RAISERROR('102:Błąd sprawdzania tożsamości kont. Błędne parametry procedury cdn.PorownajKonta ', 16, 1) 
		set @rv = 301
		goto lErr_Rozrachunek
	end
	else if @KontaNieTozsame = 2
	begin
		ROLLBACK TRAN
		RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe rozrachowywanych dekretów są ze sobą tożsame, pozabilansowe nie', 16, 1) 
		set @rv = 301
		goto lErr_Rozrachunek
	end
	else if @KontaNieTozsame = 3
	begin
		ROLLBACK TRAN
		RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe i pozabilansowe jednego z rozrachowywanych dekretów nie są z tego samego okresu ', 16, 1) 
		set @rv = 301
		goto lErr_Rozrachunek
	end
	else if @KontaNieTozsame = 4
	begin
		ROLLBACK TRAN
		RAISERROR('102:Błąd sprawdzania tożsamości kont. W okresie, w którym dokonywany jest rozrachunek nie istnieje konto tożsame do konta rozrachowywanego dekretu ', 16, 1) 
		set @rv = 301
		goto lErr_Rozrachunek
	end
	else if @KontaNieTozsame = 5
	begin
		ROLLBACK TRAN
		RAISERROR('102:Błąd sprawdzania tożsamości kont. Nie istnieje konto o podanym identyfikatorze ', 16, 1) 
		set @rv = 301
		goto lErr_Rozrachunek
	end





	-- obliczenie kont waluty do RK
	SELECT @OkresRK = OKR_ID FROM CDN.Okresy with(nolock) WHERE @DataRK BETWEEN OKR_Poczatek AND OKR_Koniec



	--zapis ksiegowy RK
	exec cdn.UstalKontaRK
		@Kurs1,
		@Kurs2,
		@Znak1,
		@Znak2,
		@StronaRK,
		@Dokument1,
		@Dokument2,
		@OkresRK,
		@Waluta1,
		@Konto1,
		@Konto1Numer,
		@Konto2,
		@Konto2Numer,
		@KontoDT output,
		@KontoDTNumer output,
		@KontoCT output,
		@KontoCTNumer output,
		@DekretRKDC output,
		@OpisRK output,
		@BZ



	IF @KontoDTNumer IS NULL OR @KontoCTNumer IS NULL
	BEGIN
		ROLLBACK TRAN
	  	RAISERROR('301:Brak konta różnic kursowych waluty %s. Uzupełnij konto RK na formatce waluty.', 16, 1, @Waluta1 ) 
		set @rv = 301
		goto lErr_Rozrachunek
	END


	EXEC CDN.DodajRozniceKursowa @GIDFirma, @DataRK, @UserID, @RoznicaKursowa, @WalutaSys, 
	@KontoDT, @KontoDTNumer, @KontoCT, @KontoCTNumer, @OpisRK, @RKDekretNumer OUTPUT, @DataDzisiejsza, @DokumentRK_Zrodlowy

	
	

	IF @@TRANCOUNT = 0
	begin
		set @rv = 301
		goto lErr_Rozrachunek
	end
	
	

	if @RKN_ID &lt;&gt; 0 and @DokumentRKAutomat &lt;&gt; 0 --podepnij do dokumentu RK
	begin			
		declare @TS int
		set @TS = datediff(ss,'19900101',GETDATE())

		--dodaj zrodla
		INSERT INTO [CDN].[Zrodla]([ZRO_TRNTyp], [ZRO_TRNFirma], [ZRO_TRNNumer], [ZRO_TRNLp], [ZRO_DTTyp], [ZRO_DTFirma], [ZRO_DTNumer], [ZRO_DTLp], [ZRO_DataOddzialu], [ZRO_DataCentrali])
		VALUES(435, @GidFirma, @RKN_ID, 0, 432, @GIDFirma, @RKDekretNumer, 0, @TS, 0)

		if @@Error&lt;&gt; 0
		begin
			rollback tran
			
			set @rv = 301
			goto lErr_Rozrachunek
		end

		--dodaj predekrety
		INSERT INTO [CDN].[Predekrety]([PDT_GIDTyp], [PDT_GIDFirma], [PDT_GIDNumer], [PDT_GIDLp], [PDT_Opis], [PDT_Kwota], [PDT_KwotaWal], [PDT_KontoDebet], [PDT_KontoCredit], [PDT_KontoDebetR], [PDT_KontoCreditR], [PDT_Wyrazenie], [PDT_KontoDebetDef], [PDT_KontoCreditDef], [PDT_Wykonuj], [PDT_Warunek], [PDT_ZROTyp], [PDT_ZROFirma], [PDT_ZRONumer], [PDT_ZROLp], [PDT_ZalozKontoDebet], [PDT_ZalozKontoCredit], [PDT_Waluta], [PDT_KursL], [PDT_KursM], [PDT_SymbolKontaDebet], [PDT_SymbolKontaCredit], [PDT_TypKwoty], [PDT_DELNumer], [PDT_DELLp], [PDT_DataWyst], [PDT_DataOper], [PDT_KontoDTNazwa], [PDT_KontoCTNazwa], [PDT_PdmTypDT], [PDT_PdmNumerDT], [PDT_PdmTypCT], [PDT_PdmNumerCT], [PDT_WycenaParID])
		VALUES(435, @GidFirma, @RKN_ID, 1, @OpisRK, @RoznicaKursowa, @RoznicaKursowa, @KontoDT, @KontoCT, '', '', 'AUTO', '', '', 1, '', 0, 0, 0, 0, 0, 0, @WalutaSys, 1, 1, 0, 0, -1, 0, 0, 0, 0, '', '',0,0,0,0,0)

		if @@Error&lt;&gt; 0
		begin
			rollback tran
			
			set @rv = 301
			goto lErr_Rozrachunek
		end

		--aktualizuj dekrety na rozliczeniu dokumentu RK
		if @StronaRK = 1
		begin
			set @tmpDekretNumer = @Dekret1Numer
			set @tmpDekretLp = @Dekret1Lp
			set @tmpDekretDC = @Dekret1DC
			set @tmpZnak = @Znak1
		end
		else
		begin
			set @tmpDekretNumer = @Dekret2Numer
			set @tmpDekretLp = @Dekret2Lp
			set @tmpDekretDC = @Dekret2DC
			set @tmpZnak = @Znak2
		end



		if @StronaRK_Rozl = 1
			update cdn.Rozliczenia set
				r2_Dekret1Numer = @RKDekretNumer,
				r2_Dekret1Lp = 1,
				r2_Dekret1DC = @DekretRKDC, --case when @tmpZnak = @tmpDekretDC then 3-@tmpDekretDC else @tmpDekretDC end,
				r2_Dekret1Dod = 0,

				r2_Dekret2Numer = @tmpDekretNumer,
				r2_Dekret2Lp = @tmpDekretLp,
				r2_Dekret2DC = @tmpDekretDC,
				r2_Dekret2Dod = 0,

				r2_DataRozrachunku = @DataRK,
				r2_OpeNumerRZ = @UserID
			where r2_ID = @RK_R2_ID
		else
			update cdn.Rozliczenia set
				r2_Dekret1Numer = @tmpDekretNumer,
				r2_Dekret1Lp = @tmpDekretLp,
				r2_Dekret1DC = @tmpDekretDC,
				r2_Dekret1Dod = 0,

				r2_Dekret2Numer = @RKDekretNumer,
				r2_Dekret2Lp = 1,
				r2_Dekret2DC = @DekretRKDC, --case when @tmpZnak = @tmpDekretDC then 3-@tmpDekretDC else @tmpDekretDC end,
				r2_Dekret2Dod = 0,

				r2_DataRozrachunku = @DataRK,
				r2_OpeNumerRZ = @UserID
			where r2_ID = @RK_R2_ID


		IF @@ERROR &lt;&gt; 0
		BEGIN
		    ROLLBACK TRAN
		    RAISERROR('202:Błąd aktualizacji tabeli Rozliczenia', 16, 1) 
		    set @rv = 301
			goto lErr_Rozrachunek
		END

		declare @RKN_Dziennik varchar(3)
		SELECT @RKN_Dziennik = KON_Wartosc FROM CDN.Konfig WITH(NOLOCK) WHERE KON_Numer=2047;


		UPDATE cdn.RozniceKursowe set 
			RKN_SchTyp = 6339,
			RKN_SchNumer = 1,
			RKN_Dziennik = @RKN_Dziennik,
			RKN_DataKsiegowania = @DataRK,
			RKN_Zaksiegowano = 1,
			RKN_OpeNumerM = @UserID
		where RKN_ID = @RKN_ID

		IF @@ERROR &lt;&gt; 0
		BEGIN
		    ROLLBACK TRAN
		    RAISERROR('202:Błąd aktualizacji tabeli RozniceKursowe', 16, 1) 
		    set @rv = 301
			goto lErr_Rozrachunek
		END



		if isnull((select KON_Wartosc FROM CDN.Konfig WITH(NOLOCK) WHERE KON_Numer=20103),0) &lt;&gt; 0
		begin
			if isnull((select KON_Wartosc FROM CDN.Konfig WITH(NOLOCK) WHERE KON_Numer=20104),0) = 0
			begin
				set @DataRKN_Rok = year(dateadd(dd, @RKN_DataWyst, '18001228'))
				
				update cdn.Dziennik set 
					DZK_Identyfikator = cdn.NumerDokumentu(435, 0, 0, @RKN_Numer, @DataRKN_Rok, @RKN_Seria, 0)
				where DZK_GIDNumer = @RKDekretNumer

				IF @@ERROR &lt;&gt; 0
				BEGIN
					ROLLBACK TRAN
					RAISERROR('401:Błąd zapisu do tabeli Dziennik', 16, 1) 
					set @rv = 301
					goto lErr_Rozrachunek
				END
			end
		end




		--aktualizuj kwoty pozostaje na dekretach
		set @tmpRoznicaKursowa = @RoznicaKursowa

	
		--dekret dokumentu 
		UPDATE CDN.Dekrety SET 
			DT_Pozostaje = DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @tmpRoznicaKursowa ELSE 0 END,
		  	DT_Rozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @tmpRoznicaKursowa ELSE 0 END = DT_Kwota THEN 0 ELSE 1 END,
		  	DT_Nierozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @tmpRoznicaKursowa ELSE 0 END = 0 THEN 0 ELSE 1 END
		WHERE DT_GIDNumer = @tmpDekretNumer AND DT_GIDLp = @tmpDekretLp AND DT_DC = @tmpDekretDC and DT_WalutaObca = 0
	
	
		IF @@ERROR &lt;&gt; 0
		BEGIN
		    ROLLBACK TRAN
		    RAISERROR('202:Błąd aktualizacji tabeli dekrety', 16, 1) 
		    set @rv = 301
			goto lErr_Rozrachunek
		END



		
		--dekret roznicy kursowej
		UPDATE CDN.Dekrety SET 
			DT_Pozostaje = DT_Pozostaje - SIGN(DT_Kwota) * @tmpRoznicaKursowa,
		  	DT_Rozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * @tmpRoznicaKursowa = DT_Kwota THEN 0 ELSE 1 END,
		  	DT_Nierozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * @tmpRoznicaKursowa = 0 THEN 0 ELSE 1 END
		WHERE DT_GIDNumer = @RKDekretNumer AND DT_GIDLp = 1 AND DT_DC = @DekretRKDC and DT_WalutaObca = 0
	
		IF @@ERROR &lt;&gt; 0
		BEGIN
		    ROLLBACK TRAN
		    RAISERROR('202:Błąd aktualizacji tabeli dekrety.', 16, 1) 
		    set @rv = 301
			goto lErr_Rozrachunek
		END
	end
	else
	begin	
		-- nie ma dok RK			
		IF @StronaRK = 1
		begin
			
			EXEC CDN.DodajRozrachunek @GIDFirma, @Dekret1Numer,@Dekret1Lp,@Dekret1DC, @RKDekretNumer, 1, 0, 0, @UserID, @ParID, 2, @DataDzisiejsza, 1, 1, @R2_Wycena, @R2_WycenaParID
		end
		ELSE
		begin
			EXEC CDN.DodajRozrachunek @GIDFirma, @Dekret2Numer,@Dekret2Lp,@Dekret2DC, @RKDekretNumer, 1, 0, 0, @UserID, @ParID, 2, @DataDzisiejsza, 1, 1, @R2_Wycena, @R2_WycenaParID
		end
		
		IF @@TRANCOUNT = 0
		begin
			set @rv = 301
			goto lErr_Rozrachunek
		end
	end		
END



lNextRozrachunek:
	
SET @KwotaDTSys1 = @KwotaDTSys1 - @KwotaSys - CASE WHEN @StronaRK = 1 THEN @RoznicaKursowa ELSE 0 END
SET @KwotaDTWal1 = @KwotaDTWal1 - @KwotaWal



if @TrybRozrachunek = 1
	goto lNext_cursDekr1
else if @TrybRozrachunek = 2
	goto lNext_cursDekr2
else if @TrybRozrachunek = 3
	goto lNext_cursDekr3



goto lExit_Ok



lErr_Rozrachunek:
if @TrybRozrachunek = 1
	goto lErr_cursDekr1
else if @TrybRozrachunek = 2
	goto lErr_cursDekr2
else if @TrybRozrachunek = 3
	goto lErr_cursDekr3


lErr_cursDekr1:
	CLOSE cursDekr1
	DEALLOCATE cursDekr1

	goto lErr


lErr_cursDekr2:
	CLOSE cursDekr2
	DEALLOCATE cursDekr2

	goto lErr


lErr_cursDekr3:
	CLOSE cursDekr3
	DEALLOCATE cursDekr3

	goto lErr


lErr:
	goto lExit


lExit_ok:
	commit tran	
	drop table #Nierozliczone
	goto lExit


lExit:	
	return @rv


</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="Przyznanie praw do procedury SkojarzRozrachunek"></A><PRE>
          <FONT SIZE="2"><I>/* Przyznanie praw do procedury SkojarzRozrachunek */</I><BR>
GRANT EXECUTE ON CDN.SkojarzRozrachunek TO CDNRaport
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>