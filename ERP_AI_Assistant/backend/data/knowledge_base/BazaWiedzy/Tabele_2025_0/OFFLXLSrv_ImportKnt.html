<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="OFFLXLSrv_ImportKnt"></A><PRE>
          <FONT SIZE="2"><I>/* OFFLXLSrv_ImportKnt */</I><BR>
CREATE PROCEDURE CDN.OFFLXLSrv_ImportKnt
 @ID	INT		  -- ID oddziału	
,@xml	TEXT
,@Opcje INT = 0   -- Maska bitowa opcji importu: (1) - logowanie wszystkich operacji
,@LogID	INT = -1  -- ID loga synchronizacji 

AS
	RAISERROR('Procedura OFFLXLSrv_ImportKnt nie jest obługiwana na MSSQL 2000',16,1)
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="OFFLXLSrv_ImportKnt"></A><PRE>
          <FONT SIZE="2"><I>/* OFFLXLSrv_ImportKnt */</I><BR>
CREATE PROCEDURE CDN.OFFLXLSrv_ImportKnt
 @ID INT          -- ID oddziału
,@xml XML
,@Opcje INT = 0   -- Maska bitowa opcji importu: (1) - logowanie wszystkich operacji
,@LogID INT = -1  -- ID loga synchronizacji

AS
SET NOCOUNT ON
DECLARE @Knt_GIDTyp SMALLINT,
        @Knt_GIDFirma INT,
        @Knt_GIDNumer INT,
        @Knt_GIDLp SMALLINT,
        @Knt_KnATyp SMALLINT,
        @Knt_KnAFirma INT,
        @Knt_KnANumer INT,
        @Knt_KnALp SMALLINT,
        @Knt_Typ SMALLINT,
        @Knt_Akwizytor SMALLINT,
        @Knt_Akronim VARCHAR(20),
        @Knt_AkronimFormat VARCHAR(30),
        @Knt_FppKod VARCHAR(8),
        @Knt_Nazwa1 VARCHAR(50),
        @Knt_Nazwa2 VARCHAR(50),
        @Knt_Nazwa3 VARCHAR(250), -- zwiększono z 50 do 250 (TFS[122530])
        @Knt_KodP VARCHAR(10),
        @Knt_Miasto VARCHAR(30),
        @Knt_Ulica VARCHAR(30),
        @Knt_Adres VARCHAR(30),
        @Knt_NipE VARCHAR(20),
        @Knt_Nip VARCHAR(20),
        @Knt_NipTmp VARCHAR(20),
        @Knt_NipPrefiks VARCHAR(2),
        @Knt_Regon VARCHAR(20),
        @Knt_Pesel VARCHAR(11),
        @Knt_KontoDostawcy VARCHAR(30),
        @Knt_KontoOdbiorcy VARCHAR(30),
        @Knt_Kraj VARCHAR(2),
        @Knt_Powiat VARCHAR(30),
        @Knt_Gmina VARCHAR(30),
        @Knt_Wojewodztwo VARCHAR(30),
        @Knt_RegionCRM INT,
        @Knt_GLN VARCHAR(13),
        @Knt_Telefon1 VARCHAR(30),
        @Knt_Telefon2 VARCHAR(30),
        @Knt_Fax VARCHAR(30),
        @Knt_Modem VARCHAR(30),
        @Knt_Telex VARCHAR(30),
        @Knt_EMail VARCHAR(255),
        @Knt_URL VARCHAR(255),
        @Knt_BnkTyp SMALLINT,
        @Knt_BnkFirma INT,
        @Knt_BnkNumer INT,
        @Knt_BnkLp SMALLINT,
        @Knt_NrRachunku VARCHAR(50),
        @Knt_Soundex VARCHAR(20),
        @Knt_Rabat DECIMAL(5, 2),
        @Knt_LimitWart DECIMAL(15, 2),
        @Knt_MaxLimitWart DECIMAL(15, 2),
        @Knt_LimitPoTerminie DECIMAL(15, 2),
        @Knt_LimitOkres SMALLINT,
        @Knt_Dewizowe SMALLINT,
        @Knt_Symbol VARCHAR(3),
        @Knt_NrKursu SMALLINT,
        @Knt_Cena SMALLINT,
        @Knt_FormaPl SMALLINT,
        @Knt_Marza DECIMAL(5, 2),
        @Knt_TypKarty SMALLINT,
        @Knt_NumerKarty VARCHAR(16),
        @Knt_DataKarty INT,
        @Knt_Ean VARCHAR(16),
        @Knt_ObcaKarta SMALLINT,
        @Knt_Osoba SMALLINT,
        @Knt_ExpoKraj SMALLINT,
        @Knt_SeriaFa VARCHAR(5),
        @Knt_PlatnikVat SMALLINT,
        @Knt_TypDok SMALLINT,
        @Knt_Status SMALLINT,
        @Knt_Koncesja INT,
        @Knt_DataKoncesji INT,
        @Knt_FAVATData INT,
        @Knt_SposobDostawy VARCHAR(20),
        @Knt_HasloChk VARCHAR(2),
        @Knt_HasloKontrahent VARCHAR(11),
        @Knt_Dzialalnosc SMALLINT,
        @Knt_ZTrTyp SMALLINT,
        @Knt_ZTrFirma INT,
        @Knt_ZTrNumer INT,
        @Knt_ZTrLp SMALLINT,
        @Knt_OpeTyp SMALLINT,
        @Knt_OpeFirma INT,
        @Knt_OpeNumer INT,
        @Knt_OpeLp SMALLINT,
        @Knt_AkwTyp SMALLINT,
        @Knt_AkwFirma INT,
        @Knt_AkwNumer INT,
        @Knt_AkwLp SMALLINT,
        @Knt_PrcTyp SMALLINT,
        @Knt_PrcFirma INT,
        @Knt_PrcNumer INT,
        @Knt_PrcLp SMALLINT,
        @Knt_Atrybut1 VARCHAR(20),
        @Knt_Format1 SMALLINT,
        @Knt_Wartosc1 VARCHAR(20),
        @Knt_Atrybut2 VARCHAR(20),
        @Knt_Format2 SMALLINT,
        @Knt_Wartosc2 VARCHAR(20),
        @Knt_Atrybut3 VARCHAR(20),
        @Knt_Format3 SMALLINT,
        @Knt_Wartosc3 VARCHAR(20),
        @Knt_AkwProwizja DECIMAL(7, 4),
        @Knt_Umowa VARCHAR(30),
        @Knt_DataW INT,
        @Knt_LastModL INT,
        @Knt_LastModO INT,
        @Knt_LastModC INT,
        @Knt_FaVATOsw VARCHAR(30),
        @Knt_CechaOpis VARCHAR(20),
        @Knt_AutoPotwierdzenie SMALLINT,
        @Knt_Aktywna INT,
        @Knt_Wsk SMALLINT,
        @Knt_MagTyp SMALLINT,
        @Knt_MagFirma INT,
        @Knt_MagNumer INT,
        @Knt_MagLp SMALLINT,
        @Knt_OutlookUrl VARCHAR(255),
        @Knt_Nieaktywny SMALLINT,
        @Knt_Zrodlo INT,
        @Knt_Branza INT,
        @Knt_Rodzaj INT,
        @Knt_RolaPartnera INT,
        @Knt_Odleglosc DECIMAL(10, 2),
        @Knt_KarTyp SMALLINT,
        @Knt_KarFirma INT,
        @Knt_KarNumer INT,
        @Knt_KarLp SMALLINT,
        @Knt_NRB SMALLINT,
        @Knt_Archiwalny SMALLINT,
        @Knt_AdresNieAktualny SMALLINT,
        @Knt_LastTransLockDate INT,
        @Knt_OpeTypM SMALLINT,
        @Knt_OpeFirmaM INT,
        @Knt_OpeNumerM INT,
        @Knt_OpeLpM SMALLINT,
        @Knt_BlokadaTransakcji SMALLINT,
        @Knt_Oddzialowy SMALLINT,
        @Knt_Spedytor SMALLINT,
        @Knt_TerminPlKa INT,
        @Knt_FormaPlKa INT,
        @Knt_TerminPlZak INT,
        @Knt_FormaPlZak INT,
        @Knt_SpTerminPlSpr INT,
        @Knt_SpTerminPlRK INT,
        @Knt_SpTerminPlZak INT,
        @Knt_LimitTerminowy SMALLINT,
        @Knt_DataWygasniecia INT,
        @Knt_PIN VARCHAR(4),
        @Knt_Priorytet INT,
        @Knt_FrsID INT,
        @Knt_Controlling SMALLINT,
        @Knt_RolnikRyczaltowy SMALLINT,
        @Knt_PriorytetRez SMALLINT,
        @Knt_Powiazany SMALLINT,
        @Knt_PlatnoscKaucji SMALLINT,
        @Knt_TerminRozliczeniaKaucji INT,
        @Knt_KnPTyp SMALLINT,
        @Knt_KnPNumer INT,
        @Knt_KnPParam SMALLINT,
        @Knt_DataUtworzenia INT,
        @Knt_DokumentTozsamosci VARCHAR(50),
        @Knt_DataWydania INT,
        @Knt_OrganWydajacy VARCHAR(50),
        @Knt_MaxDniPoTerminie INT,
		@Knt_KnGTyp SMALLINT,
		@Knt_KnGNumer INT,
		@Knt_KalendarzDst INT,
		@Knt_KalendarzWys INT,
		@Knt_Punkty DECIMAL(8,2),
        @Knt_Opis VARCHAR(1999),
		@Knt_MSTwrGrupaNumer INT,
		@Knt_SplitPayment TINYINT
        
DECLARE	@Akronim_prv		VARCHAR(20),
		@Nazwa1_prv			VARCHAR(50),
		@Nazwa2_prv			VARCHAR(50),
		@Nazwa3_prv			VARCHAR(250), -- zwiększono z 50 do 250 (TFS[122530])
		@KodP_prv			VARCHAR(10),
		@Miasto_prv			VARCHAR(30),
		@Ulica_prv			VARCHAR(30),
		@Adres_prv			VARCHAR(30),
		@Kraj_prv		VARCHAR(2),
		@NipPrefiks_prv	VARCHAR(2),
		@NipE_prv		VARCHAR(20),
		@Regon_prv		VARCHAR(20),
		@Pesel_prv		VARCHAR(11),
		@Telefon_prv	VARCHAR(30),
		@Telefon2_prv	VARCHAR(30),
		@Fax_prv		VARCHAR(30),
		@Modem_prv		VARCHAR(30),
		@Telex_prv		VARCHAR(30),
		@Email_prv		VARCHAR(255),
		@Powiat_prv		VARCHAR(30),
		@Gmina_prv		VARCHAR(30),
		@Wojewodztwo_prv	VARCHAR(30),
		@RegionCRM_prv	INT,
		@GLN_prv		VARCHAR(13),
		@NRB_prv		SMALLINT,
		@BankTyp_prv	SMALLINT,
		@NrRachunku_prv	VARCHAR(50)

DECLARE	@Knt_KntGrpTyp INT,        --Grupa domyślna kontrahenta
        @Knt_KntGrpFirma INT,
        @Knt_KntGrpNumer INT,
        @Knt_GIDNumerC INT,     --GIDNumer kontrahenta w centrali
        @Knt_KnANumerC INT,     --GIDNumer adresu kontrahenta w centrali
        @Knt_Platnik VARCHAR(20),
		@Knt_Jednorazowy BIT,    -- Czy kontrahent jednorazowy
        @GIDFirma INT,
		@PcK_Typ  INT,			 -- Typ oddziału
		@KntAkronimLog	VARCHAR(20),
		@KnGETyp		INT,
		@KnGENumer		INT,
		@PcK_TSSynchrKntPtw INT,
		@PcK_CentrumId INT


DECLARE	@index					INT,
        @max_index              INT,
        @ok_index               INT,
        @buffer_size			INT,
        @xml_buffer             XML,
        @xml_tmp                XML,
        @xml_child              XML

DECLARE	@Opis                   VARCHAR(512)

SET @xml = @xml.query('/KNTI/KNT')

SELECT  @index = 0,
        @ok_index = 0,
        @max_index = CAST(CAST(@xml.query ('count(KNT)') AS VARCHAR(20)) AS INT),
        @buffer_size = 200

SELECT @Opis = 'Kontrahenci', @GIDFirma = CDN.GIDFirma()

SELECT @Pck_Typ = PcK_Typ,
       @KnGETyp = PcK_KnGETyp,
       @KnGENumer = PcK_KnGENumer,
		@PcK_TSSynchrKntPtw = PcK_TSSynchrKntPtw,@PcK_CentrumId = PcK_CentrumID
FROM CDN.PicoKonfig WHERE PcK_PicoId = @ID

Declare @ImpKntWymagajPotwierdzenia BIT
SELECT @ImpKntWymagajPotwierdzenia = PcK_ImpKntWymagajPotwierdzenia FROM CDN.PicoKonfig where PcK_PicoID = @ID
 
 
EXEC CDN.Log_OtworzPoziom @LogID, @Opis

IF @PcK_Typ = 5
BEGIN
	SET CONTEXT_INFO 0x53796E63
END

WHILE @index &lt; @max_index
BEGIN
   SET XACT_ABORT ON;

   BEGIN TRY
       BEGIN TRANSACTION;

       IF @index % @buffer_size = 0
           SET @xml_buffer = ( SELECT @xml.query('KNT[position()&gt; sql:variable("@index") and position() &lt;= sql:variable("@index") + sql:variable("@buffer_size") ] ')  )
       SET @xml_tmp = ( SELECT @xml_buffer.query('KNT[position()= (sql:variable("@index") mod sql:variable("@buffer_size")) + 1 ] ')  )

       SELECT
            @Knt_GIDTyp = 32,
            @Knt_GIDFirma = @GIDFirma,
            @Knt_GIDNumer = KNT.Attribute.value('@GIDNumer','INT'), --GIDNumer kontrahenta w centrali
            @Knt_GIDNumerC = KNT.Attribute.value('@GIDNumerC','INT'), --GIDNumer kontrahenta w centrali
			@Knt_GIDLp = 0,
			@Knt_KnATyp = KNT.Attribute.value('@KnATyp','SMALLINT'),
			@Knt_KnAFirma = @GIDFirma,
			@Knt_KnANumer = KNT.Attribute.value('@KnANumer','INT'),
			@Knt_KnALp = KNT.Attribute.value('@KnALp','SMALLINT'),
			@Knt_Typ = KNT.Attribute.value('@Typ','SMALLINT'),
			@Knt_Akwizytor = KNT.Attribute.value('@Akwizytor','SMALLINT'),
			@Knt_Akronim = KNT.Attribute.value('@Akronim','VARCHAR(20)'),
			@Knt_AkronimFormat = KNT.Attribute.value('@AkronimFormat','VARCHAR(30)'),
			@Knt_FppKod = KNT.Attribute.value('@FppKod','VARCHAR(8)'),
			@Knt_Nazwa1 = KNT.Attribute.value('@Nazwa1','VARCHAR(50)'),
			@Knt_Nazwa2 = KNT.Attribute.value('@Nazwa2','VARCHAR(50)'),
			@Knt_Nazwa3 = KNT.Attribute.value('@Nazwa3','VARCHAR(250)'), -- zwiększono z 50 do 250 (TFS[122530])
			@Knt_KodP = KNT.Attribute.value('@KodP','VARCHAR(10)'),
			@Knt_Miasto = KNT.Attribute.value('@Miasto','VARCHAR(30)'),
			@Knt_Ulica = KNT.Attribute.value('@Ulica','VARCHAR(30)'),
			@Knt_Adres = KNT.Attribute.value('@Adres','VARCHAR(30)'),
			@Knt_NipE = KNT.Attribute.value('@NipE','VARCHAR(20)'),
			@Knt_Nip = KNT.Attribute.value('@Nip','VARCHAR(20)'),
			@Knt_NipPrefiks = KNT.Attribute.value('@NipPrefiks','VARCHAR(2)'),
			@Knt_Regon = KNT.Attribute.value('@Regon','VARCHAR(20)'),
			@Knt_Pesel = KNT.Attribute.value('@Pesel','VARCHAR(11)'),
			@Knt_KontoDostawcy = NULL, --KNT.Attribute.value('@KontoDostawcy','VARCHAR(30)'),
			@Knt_KontoOdbiorcy = NULL, --KNT.Attribute.value('@KontoOdbiorcy','VARCHAR(30)'),
			@Knt_Kraj = KNT.Attribute.value('@Kraj','VARCHAR(2)'),
			@Knt_Powiat = KNT.Attribute.value('@Powiat','VARCHAR(30)'),
            @Knt_Gmina = KNT.Attribute.value('@Gmina','VARCHAR(30)'),
            @Knt_Wojewodztwo = KNT.Attribute.value('@Wojewodztwo','VARCHAR(30)'),
            @Knt_RegionCRM = KNT.Attribute.value('@RegionCRM','INT'),
            @Knt_GLN = KNT.Attribute.value('@GLN','VARCHAR(13)'),
            @Knt_Telefon1 = KNT.Attribute.value('@Telefon1','VARCHAR(30)'),
            @Knt_Telefon2 = KNT.Attribute.value('@Telefon2','VARCHAR(30)'),
            @Knt_Fax = KNT.Attribute.value('@Fax','VARCHAR(30)'),
            @Knt_Modem = KNT.Attribute.value('@Modem','VARCHAR(30)'),
            @Knt_Telex = KNT.Attribute.value('@Telex','VARCHAR(30)'),
            @Knt_EMail = KNT.Attribute.value('@EMail','VARCHAR(255)'),
            @Knt_URL = KNT.Attribute.value('@URL','VARCHAR(255)'),
            @Knt_BnkTyp = KNT.Attribute.value('@BnkTyp','SMALLINT'),
            @Knt_BnkFirma = CASE WHEN ISNULL(@Knt_BnkTyp,0) = 0 THEN 0 ELSE @GIDFirma END,
            @Knt_BnkNumer = KNT.Attribute.value('@BnkNumer','INT'),
            @Knt_BnkLp = 0,
            @Knt_NrRachunku = KNT.Attribute.value('@NrRachunku','VARCHAR(50)'),
            @Knt_Soundex = KNT.Attribute.value('@Soundex','VARCHAR(20)'),
            @Knt_Rabat = KNT.Attribute.value('@Rabat','DECIMAL(5, 2)'),
            @Knt_LimitWart = KNT.Attribute.value('@LimitWart','DECIMAL(15, 2)'),
            @Knt_MaxLimitWart = KNT.Attribute.value('@MaxLimitWart','DECIMAL(15, 2)'),
            @Knt_LimitPoTerminie = KNT.Attribute.value('@LimitPoTerminie','DECIMAL(15, 2)'),
            @Knt_LimitOkres = KNT.Attribute.value('@LimitOkres','SMALLINT'),
            @Knt_Dewizowe = KNT.Attribute.value('@Dewizowe','SMALLINT'),
            @Knt_Symbol = KNT.Attribute.value('@Symbol','VARCHAR(3)'),
            @Knt_NrKursu = KNT.Attribute.value('@NrKursu','SMALLINT'),
            @Knt_Cena = KNT.Attribute.value('@Cena','SMALLINT'),
            @Knt_FormaPl = KNT.Attribute.value('@FormaPl','SMALLINT'),
            @Knt_Marza = KNT.Attribute.value('@Marza','DECIMAL(5, 2)'),
            @Knt_TypKarty = KNT.Attribute.value('@TypKarty','SMALLINT'),
            @Knt_NumerKarty = KNT.Attribute.value('@NumerKarty','VARCHAR(16)'),
            @Knt_DataKarty = KNT.Attribute.value('@DataKarty','INT'),
            @Knt_Ean = KNT.Attribute.value('@Ean','VARCHAR(16)'),
            @Knt_ObcaKarta = KNT.Attribute.value('@ObcaKarta','SMALLINT'),
            @Knt_Osoba = ISNULL(KNT.Attribute.value('@Osoba','SMALLINT'), 0),
            @Knt_ExpoKraj = KNT.Attribute.value('@ExpoKraj','SMALLINT'),
            @Knt_SeriaFa = KNT.Attribute.value('@SeriaFa','VARCHAR(5)'),
            @Knt_PlatnikVat = KNT.Attribute.value('@PlatnikVat','SMALLINT'),
            @Knt_TypDok = KNT.Attribute.value('@TypDok','SMALLINT'),
            @Knt_Status = KNT.Attribute.value('@Status','SMALLINT'),
            @Knt_Koncesja = KNT.Attribute.value('@Koncesja','INT'),
            @Knt_DataKoncesji = KNT.Attribute.value('@DataKoncesji','INT'),
            @Knt_FAVATData = KNT.Attribute.value('@FAVATData','INT'),
            @Knt_SposobDostawy = KNT.Attribute.value('@SposobDostawy','VARCHAR(20)'),
            @Knt_HasloChk = KNT.Attribute.value('@HasloChk','VARCHAR(2)'),
            @Knt_HasloKontrahent = KNT.Attribute.value('@HasloKontrahent','VARCHAR(11)'),
            @Knt_Dzialalnosc = KNT.Attribute.value('@Dzialalnosc','SMALLINT'),
            @Knt_ZTrTyp = KNT.Attribute.value('@ZTrTyp','SMALLINT'),
            @Knt_ZTrFirma = CASE WHEN ISNULL(@Knt_ZTrTyp,0) = 0 THEN 0 ELSE @GIDFirma END,
            @Knt_ZTrNumer = KNT.Attribute.value('@ZTrNumer','INT'),
            @Knt_ZTrLp = 0,
            @Knt_OpeTyp = KNT.Attribute.value('@OpeTyp','SMALLINT'),
            @Knt_OpeFirma = CASE WHEN ISNULL(@Knt_OpeTyp,0) = 0 THEN 0 ELSE @GIDFirma END,
            @Knt_OpeNumer = KNT.Attribute.value('@OpeNumer','INT'),
            @Knt_OpeLp = 0,
            @Knt_AkwTyp = CASE WHEN KNT.Attribute.value('@AkwTyp','SMALLINT')=0 THEN NULL ELSE KNT.Attribute.value('@AkwTyp','SMALLINT') END,
            @Knt_AkwFirma = CASE WHEN ISNULL(@Knt_AkwTyp,0) = 0 THEN NULL ELSE @GIDFirma END,
            @Knt_AkwNumer = CASE WHEN ISNULL(@Knt_AkwTyp,0) = 0 THEN NULL ELSE KNT.Attribute.value('@AkwNumer','INT') END,
            @Knt_AkwLp = 0,
            @Knt_PrcTyp = CASE WHEN KNT.Attribute.value('@PrcTyp','SMALLINT')=0 THEN NULL ELSE KNT.Attribute.value('@PrcTyp','SMALLINT') END,
            @Knt_PrcFirma = CASE WHEN ISNULL(@Knt_PrcTyp,0) = 0 THEN NULL ELSE @GIDFirma END,
            @Knt_PrcNumer = CASE WHEN ISNULL(@Knt_PrcTyp,0) = 0 THEN NULL ELSE KNT.Attribute.value('@PrcNumer','INT') END,
            @Knt_PrcLp = 0,
            @Knt_Atrybut1 = KNT.Attribute.value('@Atrybut1','VARCHAR(20)'),
            @Knt_Format1 = KNT.Attribute.value('@Format1','SMALLINT'),
            @Knt_Wartosc1 = KNT.Attribute.value('@Wartosc1','VARCHAR(20)'),
            @Knt_Atrybut2 = KNT.Attribute.value('@Atrybut2','VARCHAR(20)'),
            @Knt_Format2 = KNT.Attribute.value('@Format2','SMALLINT'),
            @Knt_Wartosc2 = KNT.Attribute.value('@Wartosc2','VARCHAR(20)'),
            @Knt_Atrybut3 = KNT.Attribute.value('@Atrybut3','VARCHAR(20)'),
            @Knt_Format3 = KNT.Attribute.value('@Format3','SMALLINT'),
            @Knt_Wartosc3 = KNT.Attribute.value('@Wartosc3','VARCHAR(20)'),
            @Knt_AkwProwizja = KNT.Attribute.value('@AkwProwizja','DECIMAL(7, 4)'),
            @Knt_Umowa = KNT.Attribute.value('@Umowa','VARCHAR(30)'),
            @Knt_DataW = KNT.Attribute.value('@DataW','INT'),
            @Knt_LastModL = KNT.Attribute.value('@LastModL','INT'),
            @Knt_LastModO = KNT.Attribute.value('@LastModO','INT'),
			@Knt_LastModC = KNT.Attribute.value('@LastModC','INT'),
			@Knt_FaVATOsw = KNT.Attribute.value('@FaVATOsw','VARCHAR(30)'),
			@Knt_CechaOpis = KNT.Attribute.value('@CechaOpis','VARCHAR(20)'),
			@Knt_AutoPotwierdzenie = KNT.Attribute.value('@AutoPotwierdzenie','SMALLINT'),
			@Knt_Aktywna = KNT.Attribute.value('@Aktywna','INT'),
			@Knt_Wsk = KNT.Attribute.value('@Wsk','SMALLINT'),
			@Knt_MagNumer = CASE WHEN ISNULL(@Knt_MagNumer,0) = 0 THEN NULL ELSE KNT.Attribute.value('@MagNumer','INT') END,
			@Knt_MagTyp = CASE WHEN @Knt_MagNumer=NULL THEN NULL ELSE KNT.Attribute.value('@MagTyp','SMALLINT') END,
			@Knt_MagFirma = CASE WHEN @Knt_MagNumer = NULL THEN NULL ELSE @GIDFirma END,
			@Knt_MagLp = 0,
			@Knt_OutlookUrl = KNT.Attribute.value('@OutlookUrl','VARCHAR(255)'),
			@Knt_Nieaktywny = KNT.Attribute.value('@Nieaktywny','SMALLINT'),
			@Knt_Zrodlo = CASE WHEN KNT.Attribute.value('@Zrodlo','INT')=0 THEN NULL ELSE KNT.Attribute.value('@Zrodlo','INT') END,
			@Knt_Branza = CASE WHEN KNT.Attribute.value('@Branza','INT')=0 THEN NULL ELSE KNT.Attribute.value('@Branza','INT') END,
			@Knt_Rodzaj = CASE WHEN KNT.Attribute.value('@Rodzaj','INT')=0 THEN NULL ELSE KNT.Attribute.value('@Rodzaj','INT') END,
			@Knt_RolaPartnera = CASE WHEN KNT.Attribute.value('@RolaPartnera','INT')=0 THEN NULL ELSE KNT.Attribute.value('@RolaPartnera','INT') END,
			@Knt_Odleglosc = KNT.Attribute.value('@Odleglosc','DECIMAL(10, 2)'),
			@Knt_KarTyp = CASE WHEN KNT.Attribute.value('@KarTyp','SMALLINT')=0 THEN NULL ELSE KNT.Attribute.value('@KarTyp','SMALLINT') END,
			@Knt_KarFirma = CASE WHEN ISNULL(@Knt_KarTyp,0) = 0 THEN NULL ELSE @GIDFirma END,
			@Knt_KarNumer = CASE WHEN ISNULL(@Knt_KarTyp,0) = 0 THEN NULL ELSE KNT.Attribute.value('@KarNumer','INT') END,
			@Knt_KarLp = 0,
			@Knt_NRB = KNT.Attribute.value('@NRB','SMALLINT'),
			@Knt_Archiwalny = ISNULL(KNT.Attribute.value('@Archiwalny','SMALLINT'),0),
			@Knt_AdresNieAktualny = KNT.Attribute.value('@AdresNieAktualny','SMALLINT'),
			@Knt_LastTransLockDate = KNT.Attribute.value('@LastTransLockDate','INT'),
			@Knt_OpeTypM = KNT.Attribute.value('@OpeTypM','SMALLINT'),
			@Knt_OpeFirmaM = CASE WHEN ISNULL(@Knt_OpeTypM,0) = 0 THEN 0 ELSE @GIDFirma END,
			@Knt_OpeNumerM = KNT.Attribute.value('@OpeNumerM','INT'),
			@Knt_OpeLpM = 0,
			@Knt_BlokadaTransakcji = KNT.Attribute.value('@BlokadaTransakcji','SMALLINT'),
			@Knt_Oddzialowy = KNT.Attribute.value('@Oddzialowy','SMALLINT'),
			@Knt_Spedytor = KNT.Attribute.value('@Spedytor','SMALLINT'),
			@Knt_TerminPlKa = KNT.Attribute.value('@TerminPlKa','INT'),
			@Knt_FormaPlKa = KNT.Attribute.value('@FormaPlKa','INT'),
			@Knt_TerminPlZak = KNT.Attribute.value('@TerminPlZak','INT'),
			@Knt_FormaPlZak = KNT.Attribute.value('@FormaPlZak','INT'),
			@Knt_SpTerminPlSpr = KNT.Attribute.value('@SpTerminPlSpr','INT'),
			@Knt_SpTerminPlRK = KNT.Attribute.value('@SpTerminPlRK','INT'),
			@Knt_SpTerminPlZak = KNT.Attribute.value('@SpTerminPlZak','INT'),
            @Knt_LimitTerminowy = KNT.Attribute.value('@LimitTerminowy','SMALLINT'),
            @Knt_DataWygasniecia = KNT.Attribute.value('@DataWygasniecia','INT'),
            @Knt_PIN = KNT.Attribute.value('@PIN','VARCHAR(4)'),
            @Knt_Priorytet = CASE WHEN KNT.Attribute.value('@Priorytet','INT')=0 THEN NULL ELSE KNT.Attribute.value('@Priorytet','INT') END,
            @Knt_FrsID = KNT.Attribute.value('@FrsID','INT'),
            @Knt_Controlling = KNT.Attribute.value('@Controlling','SMALLINT'),
            @Knt_RolnikRyczaltowy = KNT.Attribute.value('@RolnikRyczaltowy','SMALLINT'),
            @Knt_PriorytetRez = KNT.Attribute.value('@PriorytetRez','SMALLINT'),
            @Knt_Powiazany = KNT.Attribute.value('@Powiazany','SMALLINT'),
            @Knt_PlatnoscKaucji = KNT.Attribute.value('@PlatnoscKaucji','SMALLINT'),
            @Knt_TerminRozliczeniaKaucji = KNT.Attribute.value('@TerminRozliczeniaKaucji','INT'),
            @Knt_KnPTyp = CASE WHEN KNT.Attribute.value('@KnPTyp','SMALLINT')=0 THEN NULL ELSE KNT.Attribute.value('@KnPTyp','SMALLINT') END,
            @Knt_KnPNumer = CASE WHEN ISNULL(@Knt_KnPTyp,0) = 0 THEN NULL ELSE KNT.Attribute.value('@KnPNumer','INT') END,
            @Knt_KnPParam = CASE WHEN ISNULL(@Knt_KnPTyp,0) = 0 THEN NULL ELSE KNT.Attribute.value('@KnPParam','SMALLINT') END,
            @Knt_DataUtworzenia = KNT.Attribute.value('@DataUtworzenia','INT'),
            @Knt_DokumentTozsamosci = KNT.Attribute.value('@DokumentTozsamosci','VARCHAR(50)'),
            @Knt_DataWydania = KNT.Attribute.value('@DataWydania','INT'),
            @Knt_OrganWydajacy = KNT.Attribute.value('@OrganWydajacy','VARCHAR(50)'),
            @Knt_MaxDniPoTerminie = KNT.Attribute.value('@MaxDniPoTerminie','INT'),
			@Knt_KnGTyp = KNT.Attribute.value('@KnGTyp','SMALLINT'),
			@Knt_KnGNumer = KNT.Attribute.value('@KnGNumer','INT'),
			@Knt_KalendarzDst = KNT.Attribute.value('@KalendarzDst','INT'),
			@Knt_KalendarzWys = KNT.Attribute.value('@KalendarzWys','INT'),
			@Knt_Punkty = KNT.Attribute.value('@Punkty','DECIMAL(8,2)'),
            @Knt_Opis = KNT.Attribute.value('@Opis','VARCHAR(1999)'),
            @Knt_KntGrpTyp = -32,
            @Knt_KntGrpFirma = @GIDFirma,
            @Knt_KntGrpNumer = KNT.Attribute.value('@GrupaDom','INT'),
            @Knt_Platnik = @Knt_Akronim,
			@Knt_MSTwrGrupaNumer=KNT.Attribute.value('@Knt_MSTwrGrupaNumer','INT'),
			@Knt_SplitPayment=KNT.Attribute.value('@SplitPayment','TINYINT')
        FROM @xml_tmp.nodes('KNT') AS KNT(Attribute)
        
		/* - Ustawienie parametrów oraz wstępna walidacja danych - */
        SET @KntAkronimLog = @Knt_Akronim
        
		-- Sprawdzenie czy kontrahent jednorazowy
		SELECT @Knt_Jednorazowy = CASE WHEN @PcK_Typ = 5 AND @Knt_GIDNumer = 1 THEN 1 ELSE 0 END
						
		IF @PcK_Typ = 5 AND ISNULL(@Knt_Oddzialowy,0) = 0 SET @Knt_Oddzialowy = 1				
		
		-- Wypełnienie Nip na podstawie NipE
		IF ISNULL(@Knt_Nip,'') = '' AND ISNULL(@Knt_NipE,'') &lt;&gt; ''   
		    SET @Knt_Nip = REPLACE(REPLACE(@Knt_NipE,'-',''),' ','')

        -- Ustawienie grupy importu kontrahenta
        IF ISNULL(@Knt_KntGrpNumer,0) = 0
		    SELECT @Knt_KntGrpNumer = PcK_KnGINumer FROM CDN.PicoKonfig WHERE PcK_PicoID = @ID

        -- Ustawienie operatora synchronizującego na podstawie ostatniej sesji
        IF ISNULL(@Knt_OpeNumer,0) = 0
            SELECT TOP 1
                @Knt_OpeNumer = Ope_GIDNumer
                ,@Knt_OpeFirma = @GIDFirma
                ,@Knt_OpeTyp = 128
            FROM CDN.Sesje JOIN CDN.OpeKarty ON SES_OpeIdent = Ope_Ident
            WHERE SES_Modul = 'Administrator oddziałów' ORDER BY SES_SesjaID DESC

        -- Jeżeli nie przesłany identyfikator to identyfikacja kontrahenta po GIDNumerze oddziału
        IF ISNULL(@Knt_GIDNumerC,0) = 0
		    SELECT @Knt_GIDNumerC = PcL_ObiNumer FROM CDN.PicoLog WHERE PcL_PcKID = @ID AND PcL_ObiTyp = 32 AND PcL_ObiektID = @Knt_GIDNumer

        --Sprawdzenie czy taki kontrahent rzeczywiście w centrali istnieje
        IF NOT EXISTS(SELECT * FROM CDN.KntKarty WHERE Knt_GIDNumer = @Knt_GIDNumerC)
        BEGIN
			DELETE FROM CDN.PicoLog WHERE PcL_PcKID = @ID AND PcL_ObiTyp = 32 AND PcL_ObiektID = @Knt_GIDNumer
			SET @Knt_GIDNumerC = NULL
        END

		IF @Pck_Typ = 5
		BEGIN
			--Identyfikacja kontrahenta po kodzie/akronimie, NIP-ie, mieście, nazwie1
	        IF	ISNULL(@Knt_GIDNumerC,0) = 0 AND RTRIM(LTRIM(@Knt_Nip)) &lt;&gt; ''
		        SELECT @Knt_GIDNumerC = Knt_GIDNumer 
		        FROM CDN.KntKarty 
		        WHERE Knt_Akronim = @Knt_Akronim AND 
					Knt_Nip = @Knt_Nip AND 
					Knt_Miasto = @Knt_Miasto AND 
					Knt_Nazwa1 = @Knt_Nazwa1 AND
					Knt_Archiwalny = 0
		END
		ELSE
		BEGIN 
			--Identyfikacja kontrahenta po NIP-ie i mieście
		    IF ISNULL(@Knt_GIDNumerC,0) = 0 AND RTRIM(LTRIM(@Knt_Nip)) &lt;&gt; ''
		    BEGIN
			   	--Uwzglednienie parametru Kontrola parametrów kontrahenta: 0-nie porównuj z istniejącymi 1,2-znajdź podobnych
				IF EXISTS(SELECT Kon_Wartosc FROM CDN.Konfig WHERE  Kon_Numer = 9962 AND Kon_Wartosc &gt; 0)
					SELECT @Knt_GIDNumerC = Knt_GIDNumer FROM CDN.KntKarty WHERE Knt_Nip = @Knt_Nip AND Knt_Miasto = @Knt_Miasto AND Knt_Archiwalny = 0
  			END
		END
		IF @Knt_Symbol IS NULL
			SELECT @Knt_Symbol = Kon_Wartosc FROM CDN.Konfig WHERE Kon_Numer = 211

        /******** Sprawdzenie obecności rekordów w powiązanych tabelach ********/
        /******** Płatnik **********/
        IF ISNULL(@Knt_KnPTyp,0) &lt;&gt; 0 AND NOT EXISTS(SELECT * FROM CDN.KntKarty WHERE Knt_GIDTyp = @Knt_KnPTyp AND Knt_GIDNumer = @Knt_KnPNumer)
        BEGIN
            SELECT @Knt_KnPTyp = NULL, @Knt_KnPNumer = NULL
        END

        SELECT  @Knt_RegionCRM = CASE WHEN ISNULL(@Knt_RegionCRM,0) = 0 THEN NULL ELSE @Knt_RegionCRM END
               ,@Knt_GLN = CASE WHEN ISNULL(@Knt_GLN,0) = 0 THEN NULL ELSE @Knt_GLN END
		/* - Koniec Ustawienie parametrów oraz wstępna walidacja danych - */
       
        IF @Pck_Typ = 5 AND @Opcje = 1
		BEGIN
			SELECT @Opis = 'Import kontrahenta:' + @Knt_Akronim
			EXEC CDN.Log_OtworzPoziom @LogID, @Opis, 0
        END

        IF ISNULL(@Knt_GIDNumerC,0) = 0 AND @Knt_Jednorazowy = 0  --nowy kontrahent
        BEGIN
			--Sprawdzamy czy istnieje kontrahent o takim akronimie TODO: Przenieść do oddzielnej funkcji
            DECLARE @I INT
            SET @I=1
            WHILE @I &lt; 1000
            BEGIN
                SET @I=@I+1
                IF EXISTS ( SELECT Knt_GIDNumer FROM cdn.KntKarty WHERE Knt_Akronim = @Knt_Akronim )
                BEGIN
                    DECLARE  @Val1  VARCHAR(20),
                             @Val2  VARCHAR(20),
                             @AAA   VARCHAR(20)
                    SET @Knt_Akronim = REVERSE(@Knt_Akronim)
                    IF(CHARINDEX('(', @Knt_Akronim)!=0 AND substring(@Knt_Akronim,1,1)=')')
                    BEGIN
                        SET @Val1=substring(@Knt_Akronim,2,CHARINDEX('(', @Knt_Akronim)-2)
                        SET @Val2=substring(@Knt_Akronim,CHARINDEX('(', @Knt_Akronim)+1,20)
                        SET @AAA = REVERSE(@Val1) +2;
                        SET @Val2 = REVERSE(@Val2)
                        SET @Knt_Akronim=SUBSTRING(@Val2,1,20-LEN(@AAA)-2)+'('+CONVERT(VARCHAR(3),@AAA)+')'
                    END
                    ELSE
                    BEGIN
                        SET @Knt_Akronim = REVERSE(@Knt_Akronim)
                        SET @Knt_Akronim = substring(@Knt_Akronim,1,17)+'(2)'
                    END
                    SET @Knt_Platnik = @Knt_Akronim -- TFSID:87737
                END
				ELSE
				BEGIN
					BREAK
				END
            END

			-- Jeśli nip jest zły, kontrahent ma mieć pusty - do tej pory był błąd			
			IF @Knt_NipE is not null
			BEGIN
				-- sprawdzenie poprawności NIP'u			
				IF (upper(@Knt_NipPrefiks)='' OR upper(@Knt_NipPrefiks)='PL') and (UPPER(@Knt_Kraj)='PL' OR @Knt_Kraj='' OR @Knt_Kraj IS NULL)
				BEGIN
					Set @i = 1
					WHILE @i &lt;= LEN(@Knt_NipE)
					BEGIN
						IF NOT (ASCII(SUBSTRING(@Knt_NipE,@i,1)) &gt;= 48 AND ASCII(SUBSTRING(@Knt_NipE,@i,1)) &lt;= 57 OR ASCII(SUBSTRING(@Knt_NipE,@i,1)) = 45)
						BEGIN
							SET @Knt_NipE = ''											
						END
						Set @i = @i + 1
					END
					Set @Knt_NipTmp = REPLACE(@Knt_NipE,'-','')
					IF @Knt_NipTmp &lt;&gt; '' AND LEN(@Knt_NipTmp) &lt;&gt; 10
					BEGIN
						SET @Knt_NipE = ''	
					END
				END
			END			

			IF @Knt_NipPrefiks is null OR UPPER(@Knt_NipPrefiks) NOT IN (select KPC_Kod from cdn.KrajeCelne where KPC_GKrID = 1)
			BEGIN
				SET @Knt_NipPrefiks = ''
			END

			EXEC CDN.KntNowy 																
				 @Knt_KntGrpTyp
				,@Knt_KntGrpFirma
				,@Knt_KntGrpNumer
				,@Knt_OpeTyp
				,@Knt_OpeFirma
				,@Knt_OpeNumer
				,@Knt_Akronim
				,@Knt_Typ
				,@Knt_Akwizytor
				,@Knt_AkronimFormat
				,@Knt_Nazwa1
				,@Knt_Nazwa2
				,@Knt_Nazwa3
				,@Knt_KodP
				,@Knt_Miasto
				,@Knt_Ulica
				,@Knt_Adres
				,@Knt_NipE
				,@Knt_NipPrefiks
				,@Knt_Regon
				,@Knt_Pesel
				,@Knt_KontoDostawcy
				,@Knt_KontoOdbiorcy
				,@Knt_Telefon1
				,@Knt_Telefon2
				,@Knt_Fax
				,@Knt_Modem
				,@Knt_Telex
				,@Knt_EMail
				,@Knt_URL
				,@Knt_BnkTyp
				,@Knt_BnkFirma
				,@Knt_BnkNumer
				,@Knt_NrRachunku
				,@Knt_Rabat
				,@Knt_MaxLimitWart
				,@Knt_LimitPoTerminie
				,@Knt_LimitOkres
				,@Knt_Dewizowe
				,@Knt_Symbol
				,@Knt_Cena
				,@Knt_FormaPl
				,@Knt_Marza
				,@Knt_TypKarty
				,@Knt_NumerKarty
				,@Knt_DataKarty
				,@Knt_Ean
				,@Knt_ObcaKarta
				,@Knt_ExpoKraj
				,@Knt_SeriaFa
				,@Knt_PlatnikVat
				,@Knt_Status
				,@Knt_Koncesja
				,@Knt_DataKoncesji
				,@Knt_SposobDostawy
				,@Knt_Dzialalnosc
				,@Knt_AkwTyp
				,@Knt_AkwFirma
				,@Knt_AkwNumer
				,@Knt_AkwProwizja
				,@Knt_Umowa
				,@Knt_DataW
				,@Knt_FaVATOsw
                ,@Knt_FaVATData
                ,@Knt_CechaOpis
                ,@Knt_PrcTyp
                ,@Knt_PrcFirma
                ,@Knt_PrcNumer
                ,@Knt_AutoPotwierdzenie
                ,@Knt_MagTyp
                ,@Knt_MagFirma
                ,@Knt_MagNumer
                ,@Knt_OutlookUrl
                ,@Knt_Zrodlo
                ,@Knt_Branza
                ,@Knt_Rodzaj
                ,@Knt_RolaPartnera
                ,@Knt_Kraj
                ,@Knt_Odleglosc
                ,@Knt_KarTyp
                ,@Knt_KarFirma
                ,@Knt_KarNumer
                ,@Knt_Powiat
                ,@Knt_Gmina
                ,@Knt_Wojewodztwo
                ,@Knt_NRB
                ,@Knt_Archiwalny
                ,@Knt_AdresNieAktualny
                ,@Knt_BlokadaTransakcji
                ,@Knt_RegionCRM
                ,@Knt_GLN
                ,@Knt_Spedytor
                ,@Knt_TerminPlZak
                ,@Knt_FormaPlZak
                ,@Knt_SpTerminPlSpr
                ,@Knt_SpTerminPlZak
                ,@Knt_LimitTerminowy
                ,@Knt_DataWygasniecia
                ,@Knt_MaxDniPoTerminie
                ,@Knt_PIN
                ,@Knt_Priorytet
                ,@Knt_PriorytetRez
                ,@Knt_TerminRozliczeniaKaucji
                ,@Knt_PlatnoscKaucji
                ,@Knt_KnPTyp
                ,@Knt_KnPNumer
                ,@Knt_KnPParam
                ,@Knt_Platnik
                ,@Knt_Oddzialowy
                ,@Knt_FrSID
                ,@Knt_Powiazany
				,@Knt_KnGTyp
				,@Knt_KnGNumer
				,NULL
				,@Knt_KalendarzDst
				,@Knt_KalendarzWys
				,@Knt_Punkty
                ,@Knt_Opis
  				,NULL
                ,NULL
                ,NULL
                ,NULL
                ,NULL
                ,NULL
                ,NULL
                ,NULL
                ,NULL
                ,NULL
                ,@Knt_MSTwrGrupaNumer
				,NULL
				,NULL
				,NULL
				,NULL
				,NULL
				,@Knt_RolnikRyczaltowy
				,@Knt_DokumentTozsamosci
				,@Knt_DataWydania
				,@Knt_OrganWydajacy
				,@Knt_SplitPayment

            SELECT @Knt_GIDNumerC = Knt_GIDNumer, @Knt_KnANumerC = Knt_KnANumer, @Knt_KnATyp = ISNULL(@Knt_KnATyp, 864)
            FROM CDN.KntKarty WHERE Knt_Akronim = @Knt_Akronim

            INSERT INTO CDN.PicoLog (PcL_PcKID, PcL_ObiTyp, PcL_ObiNumer, PcL_ObiektID, PcL_Komentarz, PcL_Info, PcL_TStamp)
            SELECT  @ID ,@Knt_KnATyp, @Knt_KnANumerC, @Knt_KnANumer,'','',DATEDIFF(s,'1990-01-01',GETDATE())
            WHERE @Knt_KnANumer IS NOT NULL


            IF @xml_tmp.exist('/KNT/KNAI') = 1
            BEGIN
                SET @xml_child = @xml_tmp.query('/KNT/KNAI')
                EXEC CDN.OFFLXLSrv_ImportKnA @ID,@Knt_GIDNumerC,@xml_child
            END

            IF @xml_tmp.exist('/KNT/KNSI') = 1
            BEGIN
                SET @xml_child = @xml_tmp.query('/KNT/KNSI')
                EXEC CDN.OFFLXLSrv_ImportKnS @ID, @Knt_GIDNumerC,@xml_child
            END
            
			IF @xml_tmp.exist('/KNT/KLKI') = 1
            BEGIN
				SET @xml_child = @xml_tmp.query('/KNT/KLKI')
				EXEC CDN.OFFLXLSrv_ImportKLK @ID, @Knt_GIDNumerC, @xml_child, @LogID
			END
            

            IF @ImpKntWymagajPotwierdzenia = 0 AND @Knt_Osoba &gt;= 0 
			BEGIN
				UPDATE CDN.KntKarty SET Knt_Osoba = @Knt_Osoba WHERE Knt_GIDNumer = @Knt_GIDNumerC
			END
			ELSE IF @Knt_Osoba &lt; 0
			BEGIN
				SELECT @Knt_Osoba = ISNULL(KnS_KntLp,@Knt_Osoba) FROM CDN.PicoLog JOIN CDN.KntOsoby ON KnS_KntNumer = PcL_ObiNumer AND KnS_KntLp = ABS(PCL_ObiTyp) WHERE PcL_PckID = @ID AND PcL_ObiTyp &lt; 0 AND PcL_ObiektTyp = 8211
				IF @Knt_Osoba &gt; 0 UPDATE CDN.KntKarty SET Knt_Osoba = @Knt_Osoba WHERE Knt_GIDNumer = @Knt_GIDNumerC
			END
            
			IF @PcK_Typ = 5
            BEGIN
				UPDATE CDN.KntKarty 
				SET Knt_LastModC = @PcK_TSSynchrKntPtw
				WHERE Knt_GIDNumer = @Knt_GIDNumerC AND ISNULL(Knt_LastModC,0) &lt; @PcK_TSSynchrKntPtw
            END

            IF @Opcje = 1
            BEGIN
				IF @Pck_Typ = 5 
				BEGIN
					SELECT @Opis = 'Dodano kontrahenta '
					EXEC CDN.Log_Dopisz @LogID, @Opis, 0
					EXEC CDN.Log_ZamknijPoziom @LogID
				END
				ELSE
				BEGIN				            
					SELECT @Opis = @Knt_Akronim + ' -  dodano kontrahenta '
					EXEC CDN.Log_Dopisz @LogID, @Opis, 0
                END
            END

        END
        ELSE
		BEGIN
			IF @Knt_Jednorazowy &lt;&gt; 1
			BEGIN				
				SELECT @Knt_Akronim		= REPLACE(@Knt_Akronim,'''','''''')
				    ,@Knt_AkronimFormat = REPLACE(@Knt_AkronimFormat,'''','''''')
					,@Knt_Nazwa1		= REPLACE(@Knt_Nazwa1,'''','''''')
					,@Knt_Nazwa2		= REPLACE(@Knt_Nazwa2,'''','''''')
					,@Knt_Nazwa3		= REPLACE(@Knt_Nazwa3,'''','''''')
					,@Knt_KodP			= REPLACE(@Knt_KodP,'''','''''')
					,@Knt_Miasto		= REPLACE(@Knt_Miasto,'''','''''')
					,@Knt_Ulica			= REPLACE(@Knt_Ulica,'''','''''')
					,@Knt_Adres			= REPLACE(@Knt_Adres,'''','''''')
					
				IF @Pck_Typ = 5
                BEGIN
					-- Sprawdzenie na wypadek zmian wpływających na archiwizację adresu
                    SELECT 
					    @Akronim_prv = Knt_Akronim,
						@Nazwa1_prv = Knt_Nazwa1,
						@Nazwa2_prv = Knt_Nazwa2,
						@Nazwa3_prv = Knt_Nazwa3,
						@KodP_prv = Knt_KodP,
						@Miasto_prv = Knt_Miasto,
						@Ulica_prv = Knt_Ulica,
						@Adres_prv = Knt_Adres,
						@Kraj_prv = Knt_Kraj,
						@NipPrefiks_prv = Knt_NipPrefiks,
						@NipE_prv = Knt_NipE,
						@Regon_prv = Knt_Regon,
						@Pesel_prv = Knt_Pesel,
						@Telefon_prv = Knt_Telefon1,
						@Telefon2_prv = Knt_Telefon2,
						@Fax_prv = Knt_Fax,
						@Modem_prv = Knt_Modem,
						@Telex_prv = Knt_Telex,
						@Email_prv = Knt_EMail,
						@Powiat_prv = Knt_Powiat,
						@Gmina_prv = Knt_Gmina,
						@Wojewodztwo_prv = Knt_Wojewodztwo,
						@RegionCRM_prv = Knt_RegionCRM,
						@GLN_prv = Knt_GLN,
						@NRB_prv = Knt_NRB,
						@BankTyp_prv = Knt_BnkTyp,
						@NrRachunku_prv = Knt_NrRachunku
                    FROM CDN.KntKarty
                    WHERE Knt_GIDTyp = @Knt_GIDTyp AND 
                          Knt_GIDFirma = @Knt_GIDFirma AND 
                          Knt_GIDNumer = @Knt_GIDNumerC
                          
					-- Sprawdzenie czy nowy akronim kontrahenta istnieje w bazie TID[181284]
                    IF EXISTS(SELECT * FROM CDN.KntKarty WHERE Knt_Akronim LIKE @Knt_Akronim)
                    BEGIN
						-- Jeżeli tak to nie aktualizujemy
						SELECT @Knt_Akronim = @Akronim_prv
                    END      
                                                                                            
                    SELECT	@Knt_Akronim = CASE WHEN @Akronim_prv = @Knt_Akronim THEN NULL ELSE @Knt_Akronim END
							,@Knt_Nazwa1 = CASE WHEN @Nazwa1_prv = @Knt_Nazwa1 THEN NULL ELSE @Knt_Nazwa1 END
							,@Knt_Nazwa2 = CASE WHEN @Nazwa2_prv = @Knt_Nazwa2 THEN NULL ELSE @Knt_Nazwa2 END
							,@Knt_Nazwa3 = CASE WHEN @Nazwa3_prv = @Knt_Nazwa3 THEN NULL ELSE @Knt_Nazwa3 END
							,@Knt_KodP = CASE WHEN @KodP_prv = @Knt_KodP THEN NULL ELSE @Knt_KodP END
							,@Knt_Miasto = CASE WHEN @Miasto_prv = @Knt_Miasto THEN NULL ELSE @Knt_Miasto END
							,@Knt_Ulica = CASE WHEN @Ulica_prv = @Knt_Ulica THEN NULL ELSE @Knt_Ulica END
							,@Knt_Adres = CASE WHEN @Adres_prv = @Knt_Adres THEN NULL ELSE @Knt_Adres END
							,@Knt_Kraj = CASE WHEN @Kraj_prv = @Knt_Kraj THEN NULL ELSE @Knt_Kraj END
							,@Knt_NipPrefiks = CASE WHEN @NipPrefiks_prv = @Knt_NipPrefiks THEN NULL ELSE @Knt_NipPrefiks END
							,@Knt_NipE = CASE WHEN @NipE_prv = @Knt_NipE THEN NULL ELSE @Knt_NipE END
							,@Knt_Regon = CASE WHEN @Regon_prv = @Knt_Regon THEN NULL ELSE @Knt_Regon END
							,@Knt_Pesel = CASE WHEN @Pesel_prv = @Knt_Pesel THEN NULL ELSE @Knt_Pesel END
							,@Knt_Telefon1 = CASE WHEN @Telefon_prv = @Knt_Telefon1 THEN NULL ELSE @Knt_Telefon1 END
							,@Knt_Telefon2 = CASE WHEN @Telefon2_prv = @Knt_Telefon2 THEN NULL ELSE @Knt_Telefon2 END
							,@Knt_Fax = CASE WHEN @Fax_prv = @Knt_Fax THEN NULL ELSE @Knt_Fax END
							,@Knt_Modem = CASE WHEN @Modem_prv = @Knt_Modem THEN NULL ELSE @Knt_Modem END
							,@Knt_Telex = CASE WHEN @Telex_prv = @Knt_Telex THEN NULL ELSE @Knt_Telex END
							,@Knt_EMail = CASE WHEN @Email_prv = @Knt_EMail THEN NULL ELSE @Knt_EMail END
							,@Knt_Powiat = CASE WHEN @Powiat_prv = @Knt_Powiat THEN NULL ELSE @Knt_Powiat END
							,@Knt_Gmina = CASE WHEN @Gmina_prv = @Knt_Gmina THEN NULL ELSE @Knt_Gmina END
							,@Knt_Wojewodztwo = CASE WHEN @Wojewodztwo_prv = @Knt_Wojewodztwo THEN NULL ELSE @Knt_Wojewodztwo END
							,@Knt_RegionCRM = CASE WHEN @RegionCRM_prv = @Knt_RegionCRM THEN NULL ELSE @Knt_RegionCRM END
							,@Knt_GLN = CASE WHEN @GLN_prv = @Knt_GLN THEN NULL ELSE @Knt_GLN END
							,@Knt_NRB = CASE WHEN @NRB_prv = @Knt_NRB THEN NULL ELSE @Knt_NRB END
							,@Knt_BnkTyp = CASE WHEN @BankTyp_prv = @Knt_BnkTyp THEN NULL ELSE @Knt_BnkTyp END
							,@Knt_NrRachunku = CASE WHEN @NrRachunku_prv = @Knt_NrRachunku THEN NULL ELSE @Knt_NrRachunku END
					-- Koniec Sprawdzenie na wypadek zmian wpływających na archiwizację adresu

					-- Sprawdzamy czy kontrahent którego będziemy aktualizować znajduje się grupie (bądź podgrupie)
					-- wskazanej w konfiguracji oddziału jako grupa eksportu kontrahentów, jeżeli nie to musimy
					-- podpiąć tego kontrahenta rownież pod tą grupę
					IF NOT EXISTS(SELECT * FROM CDN.KntLinki
							WHERE KnL_GIDTyp = 32 
								AND KnL_GIDNumer = @Knt_GIDNumerC 
								AND KnL_GrOTyp = @KnGETyp
								AND KnL_GrONumer = @KnGENumer)
					BEGIN
						INSERT INTO CDN.KntGrupy(KnG_GIDTyp, KnG_GIDFirma, KnG_GIDNumer, KnG_GIDLp, KnG_GrOTyp, 
											KnG_GrOFirma, KnG_GrONumer, KnG_GrOLp, KnG_Akronim, KnG_CzasModyfikacji)
						SELECT KnT_GIDTyp, Knt_GIDFirma, Knt_GIDNumer, Knt_GIDLp,@KnGETyp,
							@GIDFirma,@KnGENumer,0,Knt_Akronim, DATEDIFF(s,CONVERT(datetime,'19900101',112),CONVERT(datetime,GetDate(),112))
						FROM CDN.KntKarty WHERE Knt_GIDTyp = 32 AND Knt_GIDNumer = @Knt_GIDNumerC
					END
				END	
				ELSE IF @PcK_Typ = 4 --MOS
				BEGIN
				--Sprawdzamy czy istnieje kontrahent o takim akronimie TFSID:463060
					SET @I=1
					WHILE @I &lt; 1000
					BEGIN
						SET @I=@I+1
						IF EXISTS ( SELECT Knt_GIDNumer FROM cdn.KntKarty WHERE Knt_Akronim = @Knt_Akronim AND Knt_GIDNumer &lt;&gt; @Knt_GIDNumerC)
						BEGIN
							SET @Knt_Akronim = REVERSE(@Knt_Akronim)
							IF(CHARINDEX('(', @Knt_Akronim)!=0 AND substring(@Knt_Akronim,1,1)=')')
							BEGIN
								SET @Val1=substring(@Knt_Akronim,2,CHARINDEX('(', @Knt_Akronim)-2)
								SET @Val2=substring(@Knt_Akronim,CHARINDEX('(', @Knt_Akronim)+1,20)
								SET @AAA = REVERSE(@Val1) +2;
								SET @Val2 = REVERSE(@Val2)
								SET @Knt_Akronim=SUBSTRING(@Val2,1,20-LEN(@AAA)-2)+'('+CONVERT(VARCHAR(3),@AAA)+')'
							END
							ELSE
							BEGIN
								SET @Knt_Akronim = REVERSE(@Knt_Akronim)
								SET @Knt_Akronim = substring(@Knt_Akronim,1,17)+'(2)'
							END
							SET @Knt_Platnik = @Knt_Akronim -- TFSID:87737
						END
						ELSE
						BEGIN
							BREAK
						END
					END
				END
				-- Koniec Sprawdzenie na wypadek zmian wpływających na archiwizację adresu
																	
				BEGIN
					EXEC CDN.KntModyfikacja
		                @Knt_GIDTyp
						,@Knt_GIDFirma
						,@Knt_GIDNumerC
						,@Knt_OpeTyp
						,@Knt_OpeFirma
						,@Knt_OpeNumer
						,@Knt_Typ
						,@Knt_Akwizytor
						,@Knt_Akronim
						,@Knt_AkronimFormat
						,@Knt_Nazwa1
						,@Knt_Nazwa2
						,@Knt_Nazwa3
						,@Knt_KodP
						,@Knt_Miasto
						,@Knt_Ulica
						,@Knt_Adres
						,@Knt_NipPrefiks
						,@Knt_NipE
						,@Knt_Regon
						,@Knt_Pesel
						,@Knt_Telefon1
						,@Knt_Telefon2
						,@Knt_Fax
						,@Knt_Modem
						,@Knt_Telex
						,@Knt_EMail
						,@Knt_URL
						,@Knt_BnkTyp
						,@Knt_BnkFirma
						,@Knt_BnkNumer
						,@Knt_NrRachunku
						,@Knt_Rabat
						,@Knt_MaxLimitWart
						,@Knt_LimitPoTerminie
						,@Knt_LimitOkres
						,@Knt_Dewizowe
						,@Knt_Symbol
						,@Knt_Cena
						,@Knt_FormaPl
						,@Knt_Marza
						,@Knt_TypKarty
						,@Knt_NumerKarty
						,@Knt_DataKarty
						,@Knt_Ean
						,@Knt_ObcaKarta
						,@Knt_ExpoKraj
						,@Knt_SeriaFa
						,@Knt_PlatnikVat
						,@Knt_Status
						--,@Knt_Koncesja
						--,@Knt_DataKoncesji
						,@Knt_SposobDostawy
						,@Knt_Dzialalnosc
						,@Knt_AkwTyp
						,@Knt_AkwFirma
						,@Knt_AkwNumer
						,@Knt_AkwProwizja
						,@Knt_Umowa
						,@Knt_DataW
						,@Knt_FaVATOsw
						,@Knt_FaVATData
						,@Knt_CechaOpis
						,@Knt_Wsk
						,@Knt_PrcTyp
						,@Knt_PrcFirma
						,@Knt_PrcNumer
						,@Knt_AutoPotwierdzenie
						,@Knt_MagTyp
						,@Knt_MagFirma
						,@Knt_MagNumer
						,@Knt_OutlookUrl
						,@Knt_Zrodlo
						,@Knt_Branza
						,@Knt_Rodzaj
						,@Knt_RolaPartnera
						,@Knt_Kraj
						,@Knt_Odleglosc
						,@Knt_KarTyp
						,@Knt_KarFirma
						,@Knt_KarNumer
						,@Knt_Powiat
						,@Knt_Gmina
						,@Knt_Wojewodztwo
						,@Knt_NRB
						,@Knt_Archiwalny
						,@Knt_AdresNieAktualny
						,@Knt_BlokadaTransakcji
						,@Knt_RegionCRM
						,@Knt_GLN
						,@Knt_Spedytor
						,@Knt_TerminPlZak
						,@Knt_FormaPlZak
						,@Knt_SpTerminPlSpr
						,@Knt_SpTerminPlZak
						,@Knt_LimitTerminowy
						,@Knt_DataWygasniecia
						,@Knt_MaxDniPoTerminie
						,@Knt_PIN
						,@Knt_Priorytet
						,@Knt_PriorytetRez
						,@Knt_TerminRozliczeniaKaucji
						,@Knt_PlatnoscKaucji
						,@Knt_KnPTyp
						,@Knt_KnPNumer
						,@Knt_KnPParam
						,@Knt_Oddzialowy
						,@Knt_Powiazany
						,@Knt_KnGTyp
						,@Knt_KnGNumer
						,@Knt_Opis
						,NULL
                        ,NULL
						,NULL
						,NULL --,@Knt_MSTwrGrupaNumer
                        ,NULL
                        ,NULL
                        ,NULL
                        ,NULL
                        ,NULL						
						,@Knt_MSTwrGrupaNumer
						,@Knt_RolnikRyczaltowy
						,@Knt_DokumentTozsamosci
						,@Knt_DataWydania
						,@Knt_OrganWydajacy
						,@Knt_SplitPayment

					IF @PcK_Typ = 5
					BEGIN
						-- Zapisanie mapowania dla adresu głównego (na wypadek archiwizacji)
						SELECT @Knt_KnANumerC = Knt_KnANumer, @Knt_KnATyp = Knt_KnATyp
						FROM CDN.KntKarty WHERE Knt_GIDNumer = @Knt_GIDNumerC
				
						IF EXISTS
						(
							SELECT * FROM CDN.PicoLog 
							WHERE PcL_PcKID = @ID AND PcL_ObiNumer = @Knt_KnANumerC AND PcL_ObiTyp = @Knt_KnATyp
						)
						BEGIN
							UPDATE CDN.PicoLog
							SET PcL_ObiektID = @Knt_KnANumer
							WHERE @Knt_KnANumer IS NOT NULL 
								AND PcL_PcKID = @ID AND PcL_ObiNumer = @Knt_KnANumerC AND PcL_ObiTyp = @Knt_KnATyp
						END
						ELSE
						BEGIN
							INSERT INTO CDN.PicoLog (PcL_PcKID, PcL_ObiTyp, PcL_ObiNumer, PcL_ObiektID, PcL_Komentarz, PcL_Info, PcL_TStamp)
							SELECT  @ID ,@Knt_KnATyp, @Knt_KnANumerC, @Knt_KnANumer,'','',DATEDIFF(s,'1990-01-01',GETDATE())
							WHERE @Knt_KnANumer IS NOT NULL
						END
					END
						ELSE IF @PcK_Typ = 4
						BEGIN
							-- Zapisanie mapowania dla adresu głównego (na wypadek archiwizacji)
                            SELECT @Knt_KnANumerC = Knt_KnANumer, @Knt_KnATyp = Knt_KnATyp
                            FROM CDN.KntKarty WHERE Knt_GIDNumer = @Knt_GIDNumerC

                            IF EXISTS
                            (
                                SELECT * FROM CDN.PicoLog
                                WHERE PcL_PcKID = @ID AND PcL_ObiNumer = @Knt_KnANumerC AND PcL_ObiTyp = @Knt_KnATyp
                            )
                            BEGIN
                                UPDATE CDN.PicoLog
                                SET PcL_ObiektID = @Knt_KnANumer, 
								PcL_TStamp = DATEDIFF(s,'1990-01-01',GETDATE())
                                WHERE @Knt_KnANumer IS NOT NULL
                                AND PcL_PcKID = @ID AND PcL_ObiNumer = @Knt_KnANumerC AND PcL_ObiTyp = @Knt_KnATyp
                            END
                            ELSE
								BEGIN
									INSERT INTO CDN.PicoLog (PcL_PcKID, PcL_ObiTyp, PcL_ObiNumer, PcL_ObiektID, PcL_Komentarz, PcL_Info, PcL_TStamp)
                                    SELECT  @ID ,@Knt_KnATyp, @Knt_KnANumerC, @Knt_KnANumer,'','',DATEDIFF(s,'1990-01-01',GETDATE())
                                    WHERE @Knt_KnANumer IS NOT NULL
                                END
						END
				END				
			END
												
            IF @xml_tmp.exist('/KNT/KNAI') = 1
            BEGIN
                SET @xml_child = @xml_tmp.query('/KNT/KNAI')
                EXEC CDN.OFFLXLSrv_ImportKnA @ID,@Knt_GIDNumerC,@xml_child
            END
            
            IF @xml_tmp.exist('/KNT/KNSI') = 1
            BEGIN
                SET @xml_child = @xml_tmp.query('/KNT/KNSI')
                EXEC CDN.OFFLXLSrv_ImportKnS @ID, @Knt_GIDNumerC,@xml_child
            END
            
			IF @xml_tmp.exist('/KNT/KLKI') = 1
            BEGIN
				SET @xml_child = @xml_tmp.query('/KNT/KLKI')
				EXEC CDN.OFFLXLSrv_ImportKLK @ID, @Knt_GIDNumerC, @xml_child, @LogID
            END
            
            IF @Knt_Osoba &gt;= 0 AND @ImpKntWymagajPotwierdzenia = 0 
			BEGIN
				UPDATE CDN.KntKarty SET Knt_Osoba = @Knt_Osoba WHERE Knt_GIDNumer = @Knt_GIDNumerC
			END
			ELSE IF @Knt_Osoba &lt; 0
			BEGIN
				SELECT @Knt_Osoba = ISNULL(KnS_KntLp,@Knt_Osoba) FROM CDN.PicoLog JOIN CDN.KntOsoby ON KnS_KntNumer = PcL_ObiNumer AND KnS_KntLp = ABS(PCL_ObiTyp) WHERE PcL_PckID = @ID AND PcL_ObiTyp &lt; 0 AND PcL_ObiektTyp = 8211
				IF @Knt_Osoba &gt; 0 UPDATE CDN.KntKarty SET Knt_Osoba = @Knt_Osoba WHERE Knt_GIDNumer = @Knt_GIDNumerC
			END
            
            IF @PcK_Typ = 5
            BEGIN
				UPDATE CDN.KntKarty 
				SET Knt_LastModC = @PcK_TSSynchrKntPtw
				WHERE Knt_GIDNumer = @Knt_GIDNumerC AND ISNULL(Knt_LastModC,0) &lt; @PcK_TSSynchrKntPtw
            END            

            IF @Opcje = 1
            BEGIN
				IF @Pck_Typ = 5 
				BEGIN 					
					SELECT @Opis = 'Zaktualizowano kontrahenta'
					EXEC CDN.Log_Dopisz @LogID, @Opis, 0
					EXEC CDN.Log_ZamknijPoziom @LogID
				END
				ELSE
				BEGIN
					SELECT @Opis = @KntAkronimLog + ' - zaktualizowano kontrahenta'
					EXEC CDN.Log_Dopisz @LogID, @Opis, 0
				END
            END
        END

        --Zapisanie identyfikatorów oddziałowych kontrahenta i adres aktualnego
        DELETE FROM CDN.PicoLog WHERE PcL_PcKID = @ID AND PcL_ObiTyp = 32 AND PcL_ObiNumer = @Knt_GIDNumerC

        INSERT INTO CDN.PicoLog (PcL_PcKID, PcL_ObiTyp, PcL_ObiNumer, PcL_ObiektID, PcL_Komentarz, PcL_Info, PcL_TStamp)
        VALUES (@ID ,@Knt_GIDTyp, @Knt_GIDNumerC, @Knt_GIDNumer,'','',DATEDIFF(s,'1990-01-01',GETDATE()) )

        /******* Import atrybutów towaru ********/
        IF @xml_tmp.exist('/KNT/ATRI') = 1
        BEGIN
            SET @xml_child = @xml_tmp.query('/KNT/ATRI')
            EXEC CDN.OFFLXLSrv_ImportAtr @Knt_GIDTyp, @Knt_GIDNumerC, @xml_child, @LogID
        END
		/******* Import załączników********/
		IF @xml_tmp.exist('/KNT/DABI') = 1
		BEGIN
			SET @xml_child = @xml_tmp.query('/KNT/DABI')
			EXEC CDN.OFFLXLSrv_ImportDAOXML @Knt_GIDTyp, @Knt_GIDNumerC, @xml_child, @LogID,0,@ID,@PcK_CentrumId
		END
        COMMIT TRANSACTION;
        SET @ok_index = @ok_index + 1
    END TRY

    BEGIN CATCH
        IF XACT_STATE() &lt;&gt; 0
        ROLLBACK TRANSACTION;

        SELECT @Opis = @Knt_Akronim + ' - błąd podczas importu kontrahenta: ' + CDN.Log_SzczegolyBledu(ERROR_NUMBER(),ERROR_PROCEDURE(),ERROR_LINE(),ERROR_MESSAGE())
        print @Opis
        EXEC CDN.Log_Dopisz @LogID, @Opis, 2
		IF @Pck_Typ = 5 EXEC CDN.Log_ZamknijPoziom @LogID
   END CATCH

   SET @index = @index + 1
END

SELECT @Opis = 'Ilość zaimportowanych kontrahentów: '  + CAST(@ok_index AS NVARCHAR(10)) + ' z ' + CAST(@max_index AS NVARCHAR(10))
EXEC CDN.Log_Dopisz @LogID, @Opis, 0
EXEC CDN.Log_ZamknijPoziom @LogID
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>