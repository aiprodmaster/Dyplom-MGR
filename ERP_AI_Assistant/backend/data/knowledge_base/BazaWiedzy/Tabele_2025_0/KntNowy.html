<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="Usuwanie procedury KntNowy"></A><PRE>
          <FONT SIZE="2" DISABLED="True"><I>/* Usuwanie procedury KntNowy */</I><BR>
IF EXISTS (
		SELECT *
		FROM sys.objects
		WHERE object_id = OBJECT_ID(N'[CDN].[KntNowy]')
			AND type IN (N'P', N'PC')
		)
	DROP PROCEDURE [CDN].[KntNowy]
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="Tworzenie procedury KntNowy"></A><PRE>
          <FONT SIZE="2"><I>/* Tworzenie procedury KntNowy */</I><BR>
CREATE PROCEDURE [CDN].[KntNowy]
	--parametry wymagalne
	@knwGrpTyp SMALLINT
	, @knwGrpFirma INT
	, @knwGrpNumer INT
	, @OpeTyp SMALLINT
	, @OpeFirma INT
	, @OpeNumer INT
	, @Akronim VARCHAR(20)
	,
	--parametry wyjsciowe
	--      @pkntGIDTyp smallint = 0 output,
	--      @pkntGIDFirma int = 0 output,
	--  @pkntGIDNumer int = 0 output,
	--parametry opcjonalne
	@Typ SMALLINT = NULL
	, @Akwizytor SMALLINT = NULL
	, @AkronimFormat VARCHAR(30) = NULL
	, @Nazwa1 VARCHAR(50) = NULL
	, @Nazwa2 VARCHAR(50) = NULL
	, @Nazwa3 VARCHAR(250) = NULL
	, @KodP VARCHAR(10) = NULL
	, @Miasto VARCHAR(30) = NULL
	, @Ulica VARCHAR(30) = NULL
	, @Adres VARCHAR(30) = NULL
	, @NipE VARCHAR(20) = NULL
	, @NipPrefiks VARCHAR(2) = NULL
	, @Regon VARCHAR(20) = NULL
	, @Pesel VARCHAR(11) = NULL
	, @KontoDostawcy VARCHAR(30) = NULL
	, @KontoOdbiorcy VARCHAR(30) = NULL
	, @Telefon1 VARCHAR(30) = NULL
	, @Telefon2 VARCHAR(30) = NULL
	, @Fax VARCHAR(30) = NULL
	, @Modem VARCHAR(30) = NULL
	, @Telex VARCHAR(30) = NULL
	, @EMail VARCHAR(40) = NULL
	, @URL VARCHAR(255) = NULL
	, @BnkTyp SMALLINT = NULL
	, @BnkFirma INT = NULL
	, @BnkNumer INT = NULL
	, @NrRachunku VARCHAR(50) = NULL
	, @Rabat DECIMAL(5, 2) = NULL
	, @MaxLimitWart DECIMAL(15, 2) = NULL
	, @LimitPoTerminie DECIMAL(15, 2) = NULL
	, @LimitOkres SMALLINT = NULL
	, @Dewizowe SMALLINT = NULL
	, @Symbol VARCHAR(3) = NULL
	, @Cena SMALLINT = NULL
	, @FormaPl SMALLINT = NULL
	, @Marza DECIMAL(5, 2) = NULL
	, @TypKarty SMALLINT = NULL
	, @NumerKarty VARCHAR(16) = NULL
	, @DataKarty INT = NULL
	, @Ean VARCHAR(16) = NULL
	, @ObcaKarta SMALLINT = NULL
	, @ExpoKraj SMALLINT = NULL
	, @SeriaFa VARCHAR(5) = NULL
	, @PlatnikVat SMALLINT = NULL
	, @Status SMALLINT = NULL
	, @Koncesja INT = NULL
	, @DataKoncesji INT = NULL
	, @SposobDostawy VARCHAR(20) = NULL
	, @Dzialalnosc SMALLINT = NULL
	, @AkwTyp SMALLINT = NULL
	, @AkwFirma INT = NULL
	, @AkwNumer INT = NULL
	, @AkwProwizja DECIMAL(7, 4) = NULL
	, @Umowa VARCHAR(30) = NULL
	, @DataW INT = NULL
	, @FaVATOsw VARCHAR(30) = NULL
	, @FaVATData INT = NULL
	, @CechaOpis VARCHAR(250) = NULL
	,
	--@Wsk smallint = NULL, --wykorzystywane przez API, do obsłużenia
	@PrcTyp SMALLINT = NULL
	, @PrcFirma INT = NULL
	, @PrcNumer INT = NULL
	, @AutoPotwierdzenie SMALLINT = NULL
	, @MagTyp SMALLINT = NULL
	, @MagFirma INT = NULL
	, @MagNumer INT = NULL
	, @OutlookUrl VARCHAR(255) = NULL
	, @Zrodlo INT = NULL
	, @Branza INT = NULL
	, @Rodzaj INT = NULL
	, @RolaPartnera INT = NULL
	, @Kraj VARCHAR(2) = NULL
	, @Odleglosc DECIMAL(10, 2) = NULL
	, @KarTyp SMALLINT = NULL
	, @KarFirma INT = NULL
	, @KarNumer INT = NULL
	, @Powiat VARCHAR(30) = NULL
	, @Gmina VARCHAR(30) = NULL
	, @Wojewodztwo VARCHAR(30) = NULL
	, @NRB SMALLINT = NULL
	, @Archiwalny SMALLINT = 0
	, @AdresNieAktualny SMALLINT = NULL
	, @BlokadaTransakcji SMALLINT = NULL
	, @RegionCRM INT = NULL
	, @GLN VARCHAR(12) = NULL
	, @Spedytor SMALLINT = NULL
	, @TerminPlZak INT = NULL
	, @FormaPlZak INT = NULL
	, @SpTerminPlSpr INT = NULL
	, @SpTerminPlZak INT = NULL
	, @LimitTerminowy SMALLINT = NULL
	, @DataWygasniecia INT = NULL
	, @MaxDniPoTerminie INT = NULL
	, @PIN VARCHAR(4) = NULL
	, @Priorytet INT = NULL
	, @PriorytetRez INT = NULL
	, @TerminRozliczeniaKaucji INT = NULL
	, @PlatnoscKaucji SMALLINT = NULL
	, @KnPTyp SMALLINT = NULL
	, @KnPNumer INT = NULL
	, @KnPParam SMALLINT = NULL
	, @Platnik VARCHAR(20) = NULL
	, @Oddzialowy SMALLINT = NULL
	, @FrSID INT = NULL
	, @Powiazany SMALLINT = NULL
	, @KnGTyp SMALLINT = NULL
	, @KnGNumer INT = NULL
	, @KontrahentGlowny VARCHAR(20) = NULL
	, @KalendarzDst INT = NULL
	, @KalendarzWys INT = NULL
	, @Punkty DECIMAL(14, 2) = NULL
	, @Opis VARCHAR(1999) = NULL
	,
	--9.5
	@OpiekunCzas INT = NULL
	, @OpiekunDataOd INT = NULL
	, @OpiekunDataDo INT = NULL
	,
	--10.6
	@OpeNumerW INT = NULL
	,
	--KAp:OpeNumer - Operator wystawiający
	@OpeHaslo VARCHAR(100) = NULL
	,
	--KAp:OpeHaslo - Hasło operatora wystawiającego
	@OpeNumerO INT = NULL
	,
	--KAp:OpeONumer - Operator odpowiedzialny za realizację
	@TwrGrupaNumer INT = NULL
	,
	--KAp:TwrGrupaNumer - Grupa towarów udostępniona kontrahentowi
	@SeriaKaP VARCHAR(5) = NULL
	,
	--KAp:Seria - Seria, z którą będą wystawiane dokumenty
	--11.0
	@PodatnikiemNabywca SMALLINT = NULL
	, @PrefiksObcy VARCHAR(10) = NULL
	, @MSTwrGrupaNumer INT = NULL
	,
	--Identyfikator grupy towarów dla Mobilnego Sprzedawcy
	--2013.5
	@StanPostep TINYINT = NULL
	, @ESKlep TINYINT = NULL
	,
	--2014.0
	@MagMSTyp SMALLINT = NULL
	, @MagMSFirma INT = NULL
	, @MagMSNumer INT = NULL
	--2017.1
	, @RolnikRyczaltowy TINYINT = NULL
	, @DokumentTozsamosci VARCHAR(50) = NULL
	, @DataWydania INT = NULL
	, @OrganWydajacy VARCHAR(50) = NULL
	--2018.2
	, @SplitPayment TINYINT = NULL
	, @GUID VARCHAR(40) = NULL
	, @GUIDdane VARCHAR(40) = NULL
	--2023.2
	, @KSeFWyslij TINYINT = NULL
	, @KSeFZrodlowy TINYINT = NULL
	--2025.0
	, @CharsetANSI TINYINT = NULL

	--Procedura zakłada kartę kontrahenta, dodaje odpowiednie zapisy w tabelach:
	--kntkarty,kntgrupy,kntgrupydom,kntadresy,kntopisy
	--oraz zakłada konta dostawcy/odbiorcy dla kontrahenta zgodnie z ustawieniami konfiguracyjnymi
	--Wersja 1.00   4.02.2004
	--Parametry obowiązkowe:
	--      @knwGrpTyp              GIDTyp wzorca
	--      @knwGrpFirma    GIDFirma wzorca
	--      @knwGrpNumer    GIDNumer wzorca
	--      @OpeTyp                 GIDTyp operatora zakładającego kartę kontrahenta
	--      @OpeFirma               GIDFirma operatora zakładającego kartę kontrahenta
	--      @OpeNumer               GIDNumer operatora zakładającego kartę kontrahenta
	--      @Akronim                Akronim zakładanego kontrahenta (gdy na grupie jest włączony check autoakronim to nie trzeba)
	-- Pozostałe parametry są opcjonalne, wszystkie mają ustawiony default NULL i jeśli takie są to wartości tych pól brane
	-- są z wzorca
	-- TS hasło operatora nie może być obsłużone bo trzeba by udostępnić algorytm szyfrujący w sql-u czego zrobić nie możemy
AS
DECLARE @pknw_grptyp SMALLINT
DECLARE @pknw_grpfirma INT
DECLARE @pknw_grpnumer INT
DECLARE @pkntGIDTyp SMALLINT
DECLARE @pkntGIDFirma INT
DECLARE @pkntGIDNumer INT
DECLARE @knaTyp SMALLINT
DECLARE @knaFirma INT
DECLARE @knaNumer INT
DECLARE @err INT
DECLARE @BnkNrRachunku VARCHAR(10)
DECLARE @OpeLimitKredytu DECIMAL(15, 2)
DECLARE @OpeLimitPoTerminie DECIMAL(5, 2)
DECLARE @LastTransLockDate INT
DECLARE @CyfraKontrolnaGLN INT
DECLARE @SoundExPL VARCHAR(20)
DECLARE @ZtrTyp SMALLINT
DECLARE @ZtrFirma INT
DECLARE @ZtrNumer INT
DECLARE @EanTyp SMALLINT
DECLARE @EanFirma INT
DECLARE @EanNumer INT
DECLARE @SyntetykaDost VARCHAR(30)
DECLARE @SyntetykaOdb VARCHAR(30)
DECLARE @ZalozKonto INT
DECLARE @Nip VARCHAR(20)
DECLARE @i INT
DECLARE @TylkoKntKonta SMALLINT
DECLARE @SmkID INT
DECLARE @Konto VARCHAR(30)
DECLARE @NazwaKonta VARCHAR(40)
DECLARE @PlatnikIstnieje SMALLINT
DECLARE @KntGlownyIstnieje SMALLINT
DECLARE @LimitBezOgraniczenia SMALLINT
-------------------------------------------------------------------------------------
DECLARE @KnW_GrpTyp SMALLINT
DECLARE @KnW_GrpFirma INT
DECLARE @KnW_GrpNumer INT
DECLARE @KnW_GrpLp SMALLINT
DECLARE @KnW_Typ SMALLINT
DECLARE @KnW_Akwizytor SMALLINT
DECLARE @KnW_Nazwa1 VARCHAR(50)
DECLARE @KnW_Nazwa2 VARCHAR(50)
DECLARE @KnW_Nazwa3 VARCHAR(250)
DECLARE @KnW_Akronim VARCHAR(20)
DECLARE @KnW_KodP VARCHAR(10)
DECLARE @KnW_Miasto VARCHAR(30)
DECLARE @KnW_Ulica VARCHAR(30)
DECLARE @KnW_Adres VARCHAR(30)
DECLARE @KnW_NipE VARCHAR(20)
DECLARE @KnW_Regon VARCHAR(20)
DECLARE @KnW_Wojewodztwo VARCHAR(30)
DECLARE @KnW_Gmina VARCHAR(30)
DECLARE @KnW_Powiat VARCHAR(30)
DECLARE @KnW_Pesel VARCHAR(11)
--declare               @KnW_KontoDostawcy varchar (30)
--declare               @KnW_KontoOdbiorcy varchar (30)
DECLARE @KnW_AkronimFormat VARCHAR(30)
DECLARE @KnW_BnkTyp SMALLINT
DECLARE @KnW_BnkFirma INT
DECLARE @KnW_BnkNumer INT
DECLARE @KnW_BnkLp SMALLINT
DECLARE @KnW_AkwTyp SMALLINT
DECLARE @KnW_AkwFirma INT
DECLARE @KnW_AkwNumer INT
DECLARE @KnW_AkwLp SMALLINT
DECLARE @KnW_Atrybut1 VARCHAR(15)
DECLARE @KnW_Format1 SMALLINT
DECLARE @KnW_Wartosc1 VARCHAR(20)
DECLARE @KnW_Atrybut2 VARCHAR(15)
DECLARE @KnW_Format2 SMALLINT
DECLARE @KnW_Wartosc2 VARCHAR(20)
DECLARE @KnW_Atrybut3 VARCHAR(15)
DECLARE @KnW_Format3 SMALLINT
DECLARE @KnW_Wartosc3 VARCHAR(20)
DECLARE @KnW_AkwProwizja DECIMAL(7, 4)
DECLARE @KnW_Rabat DECIMAL(5, 2)
DECLARE @KnW_LimitTerminowy INT
DECLARE @KnW_MaxLimitWart DECIMAL(15, 2)
DECLARE @KnW_LimitPoTerminie DECIMAL(15, 2)
DECLARE @KnW_DataWygasniecia INT
DECLARE @KnW_MaxDniPoTerminie INT
DECLARE @KnW_LimitOkres SMALLINT
DECLARE @KnW_Dewizowe SMALLINT
DECLARE @KnW_Symbol VARCHAR(3)
DECLARE @KnW_NrKursu SMALLINT
DECLARE @KnW_Cena SMALLINT
DECLARE @KnW_FormaPl SMALLINT
DECLARE @KnW_TypKarty SMALLINT
DECLARE @KnW_ExpoKraj SMALLINT
DECLARE @KnW_SeriaFa VARCHAR(5)
DECLARE @KnW_PlatnikVat SMALLINT
DECLARE @KnW_TypDok SMALLINT
DECLARE @KnW_Status SMALLINT
DECLARE @KnW_SposobDostawy VARCHAR(20)
DECLARE @KnW_CechaOpis VARCHAR(250)
DECLARE @KnW_PrcTyp SMALLINT
DECLARE @KnW_PrcFirma INT
DECLARE @KnW_PrcNumer INT
DECLARE @KnW_PrcLp SMALLINT
DECLARE @KAp_CzyPotwierdzone SMALLINT
DECLARE @KAp_MagTyp SMALLINT
DECLARE @KAp_MagFirma INT
DECLARE @KAp_MagNumer INT
DECLARE @KAp_MagLp SMALLINT
DECLARE @KnW_OutlookUrl VARCHAR(255)
DECLARE @KnW_Nieaktywny SMALLINT
DECLARE @KnW_Zrodlo INT
DECLARE @KnW_Branza INT
DECLARE @KnW_Rodzaj INT
DECLARE @KnW_RolaPartnera INT
DECLARE @KnW_Kraj VARCHAR(2)
DECLARE @KnW_KarTyp SMALLINT
DECLARE @KnW_KarFirma INT
DECLARE @KnW_KarNumer INT
DECLARE @KnW_KarLp SMALLINT
DECLARE @KnW_FormaPlZak INT
DECLARE @KnW_TerminPlZak INT
DECLARE @KnW_SpTerminPlZak INT
DECLARE @KnW_SpTerminSpr INT
DECLARE @KnW_Spedytor SMALLINT
DECLARE @KnW_PriorytetRez INT
DECLARE @KnW_TerminRozliczeniaKaucji INT
DECLARE @KnW_PlatnoscKaucji SMALLINT
DECLARE @KnW_KnPTyp SMALLINT
DECLARE @KnW_KnPNumer INT
DECLARE @KnW_KnPParam SMALLINT
DECLARE @KnW_Powiazany SMALLINT
DECLARE @KnW_KnGTyp SMALLINT
DECLARE @KnW_KnGNumer INT
DECLARE @KnW_KalendarzDst INT
DECLARE @KnW_KalendarzWys INT
DECLARE @KnW_RegionCRM INT
DECLARE @KnW_OpiekunCzas INT
DECLARE @KnW_OpiekunDataOd INT
DECLARE @KnW_OpiekunDataDo INT
--2017.1
DECLARE @KnW_RolnikRyczaltowy TINYINT = NULL
DECLARE @WartoscGIDFirma VARCHAR(20)
DECLARE @F1 VARCHAR(10)
DECLARE @F2 VARCHAR(10)
DECLARE @F3 VARCHAR(10)
DECLARE @Dzis INT
DECLARE @OkresID INT
DECLARE @KAp_OpeNumer INT
DECLARE @KAp_OpeHaslo VARCHAR(100)
DECLARE @KAp_OpeONumer INT
DECLARE @KAp_TwrGrupaNumer INT
DECLARE @KAp_Seria VARCHAR(5)
DECLARE @KnW_PodatnikiemNabywca SMALLINT
DECLARE @KAp_PrefiksObcy VARCHAR(10)
DECLARE @KnW_MSTwrGrupaNumer INT
DECLARE @KnW_AutoAkronim TINYINT --TS Bug #106426
DECLARE @KnW_ESklep TINYINT
DECLARE @KAp_MagMSTyp SMALLINT
DECLARE @KAp_MagMSFirma INT
DECLARE @KAp_MagMSNumer INT
DECLARE @KAp_MagMSLp SMALLINT
--2018.2
DECLARE @KnW_SplitPayment SMALLINT
DECLARE @WalutaSystemowa	VARCHAR(3)
DECLARE @KarWaluta	VARCHAR(3)
--2023.2
DECLARE @KnW_KSeFWyslij TINYINT
DECLARE @KnW_KSeFZrodlowy TINYINT
--2024.0
DECLARE @KntMetodaKasowa TINYINT

SET NOCOUNT ON
-------------------------------------------------------------------------------------
SET @pkntGIDTyp = 32

-------------------------------------------------------------------------------------
--ustalenie GIDFirma
SELECT @WartoscGIDFirma = sys_wartosc
FROM cdn.systemcdn
WHERE sys_id = 2

SELECT @F1 = SUBSTRING(@WartoscGIDFirma, 0, PATINDEX('%.%', @WartoscGIDFirma))

SET @WartoscGIDFirma = SUBSTRING(@WartoscGIDFirma, PATINDEX('%.%', @WartoscGIDFirma) + 1, LEN(@WartoscGIDFirma))

SELECT @F2 = SUBSTRING(@WartoscGIDFirma, 0, PATINDEX('%.%', @WartoscGIDFirma))

SET @WartoscGIDFirma = SUBSTRING(@WartoscGIDFirma, PATINDEX('%.%', @WartoscGIDFirma) + 1, LEN(@WartoscGIDFirma))

SELECT @F3 = SUBSTRING(@WartoscGIDFirma, 0, PATINDEX('%.%', @WartoscGIDFirma))

SET @WartoscGIDFirma = SUBSTRING(@WartoscGIDFirma, PATINDEX('%.%', @WartoscGIDFirma) + 1, LEN(@WartoscGIDFirma))
SET @pkntGIDFirma = CAST(@WartoscGIDFirma AS INT) + CAST(@F3 AS INT) * POWER(2, 8) + CAST(@F2 AS INT) * POWER(2, 16)

SELECT @WalutaSystemowa = RTRIM(LTRIM(Kon_Wartosc)) FROM CDN.Konfig WHERE Kon_Numer = 211

BEGIN TRANSACTION

SET @Dzis = DateDiff(d, convert(DATETIME, '1800-12-28', 120), getdate())

SELECT @OkresID = Okr_ID
FROM cdn.Okresy
WHERE Okr_Poczatek &lt;= @Dzis
	AND Okr_Koniec &gt;= @Dzis

-------------------------------------------------------------------------------------
--znaleznie gidnumeru nowego kontrahenta
-------------------------------------------------------------------------------------
--select top 1 @pkntGIDNumer=knt_gidnumer+1 from cdn.kntkarty
--order by knt_gidnumer desc
--if @pkntGIDNumer=0 begin
--              ROLLBACK TRAN
--              RAISERROR ('Nieokreślony błąd! - (1)', 16, 1)
--              return 1
--end
-------------------------------------------------------------------------------------
--znalezienie gidu adresu nowego kontrahenta
-------------------------------------------------------------------------------------
IF EXISTS (
		SELECT *
		FROM cdn.kntadresy
		WHERE kna_gidtyp = 864
		)
BEGIN
	SELECT TOP 1 @knaTyp = KnA_GIDTyp
		, @knaFirma = KnA_GIDFirma
		, @knaNumer = KnA_GIDNumer + 1
	FROM CDN.KntAdresy
	WHERE KnA_GIDTyp = 864
	ORDER BY KnA_GIDNumer DESC
END
ELSE
BEGIN
	SET @knaNumer = 1
	SET @knaTyp = 864
	SET @knaFirma = @pkntGIDFirma
END

IF @knaTyp IS NULL
	OR @knaFirma IS NULL
	OR @knaNumer IS NULL
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Brak definicji adresu! - (2)'
			, 16
			, 1
			)

	RETURN 2
END

-------------------------------------------------------------------------------------
--sprawdzenie czy istnieje wzorzec
-------------------------------------------------------------------------------------
IF NOT EXISTS (
		SELECT *
		FROM cdn.kntwzorce
		WHERE knw_grptyp = @knwGrpTyp
			AND knw_grpnumer = @knwGrpNumer
		)
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Nie znaleziono wzorca kontrahenta w tabeli KntWzorce [%d,%d]- (3)'
			, 16
			, 1
			, @knwGrpTyp
			, @knwGrpNumer
			)

	RETURN 3
END

-------------------------------------------------------------------------------------
--sprawdzenie czy istnieje operator
-------------------------------------------------------------------------------------
IF NOT EXISTS (
		SELECT *
		FROM cdn.opekarty
		WHERE ope_gidtyp = @OpeTyp
			AND ope_gidnumer = @OpeNumer
		)
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Nie znaleziono operatora [%d,%d] - (4)'
			, 16
			, 1
			, @OpeTyp
			, @OpeNumer
			)

	RETURN 4
END

-------------------------------------------------------------------------------------
--pobranie danych ze wzorca
SELECT @KnW_GrpTyp = KnW_GrpTyp
	, @KnW_GrpFirma = KnW_GrpFirma
	, @KnW_GrpNumer = KnW_GrpNumer
	, @KnW_GrpLp = KnW_GrpLp
	, @KnW_Typ = KnW_Typ
	, @KnW_Akwizytor = KnW_Akwizytor
	, @KnW_Nazwa1 = KnW_Nazwa1
	, @KnW_Nazwa2 = KnW_Nazwa2
	, @KnW_Nazwa3 = KnW_Nazwa3
	, @KnW_Akronim = KnW_Akronim
	, @KnW_KodP = KnW_KodP
	, @KnW_Miasto = KnW_Miasto
	, @KnW_Ulica = KnW_Ulica
	, @KnW_Adres = KnW_Adres
	, @KnW_NipE = KnW_NipE
	, @KnW_Regon = KnW_Regon
	, @KnW_Wojewodztwo = KnW_Wojewodztwo
	, @KnW_Gmina = KnW_Gmina
	, @KnW_Powiat = KnW_Powiat
	, @KnW_Pesel = KnW_Pesel
	,
	--@KnW_KontoDostawcy    =  KnW_KontoDostawcy,
	--@KnW_KontoOdbiorcy    =  KnW_KontoOdbiorcy,
	@KnW_AkronimFormat = KnW_AkronimFormat
	, @KnW_BnkTyp = KnW_BnkTyp
	, @KnW_BnkFirma = KnW_BnkFirma
	, @KnW_BnkNumer = KnW_BnkNumer
	, @KnW_BnkLp = KnW_BnkLp
	, @KnW_AkwTyp = KnW_AkwTyp
	, @KnW_AkwFirma = KnW_AkwFirma
	, @KnW_AkwNumer = KnW_AkwNumer
	, @KnW_AkwLp = KnW_AkwLp
	, @KnW_Atrybut1 = KnW_Atrybut1
	, @KnW_Format1 = KnW_Format1
	, @KnW_Wartosc1 = KnW_Wartosc1
	, @KnW_Atrybut2 = KnW_Atrybut2
	, @KnW_Format2 = KnW_Format2
	, @KnW_Wartosc2 = KnW_Wartosc2
	, @KnW_Atrybut3 = KnW_Atrybut3
	, @KnW_Format3 = KnW_Format3
	, @KnW_Wartosc3 = KnW_Wartosc3
	, @KnW_AkwProwizja = KnW_AkwProwizja
	, @KnW_Rabat = KnW_Rabat
	, @KnW_LimitTerminowy = KnW_LimitTerminowy
	, @KnW_MaxLimitWart = KnW_MaxLimitWart
	, @KnW_LimitPoTerminie = KnW_LimitPoTerminie
	, @KnW_DataWygasniecia = KnW_DataWygasniecia
	, @KnW_MaxDniPoTerminie = KnW_MaxDniPoTerminie
	, @KnW_LimitOkres = KnW_LimitOkres
	, @KnW_Dewizowe = KnW_Dewizowe
	, @KnW_Symbol = KnW_Symbol
	, @KnW_NrKursu = KnW_NrKursu
	, @KnW_Cena = KnW_Cena
	, @KnW_FormaPl = KnW_FormaPl
	, @KnW_TypKarty = KnW_TypKarty
	, @KnW_ExpoKraj = KnW_ExpoKraj
	, @KnW_SeriaFa = KnW_SeriaFa
	, @KnW_PlatnikVat = KnW_PlatnikVat
	, @KnW_TypDok = KnW_TypDok
	, @KnW_Status = KnW_Status
	, @KnW_SposobDostawy = KnW_SposobDostawy
	, @KnW_CechaOpis = KnW_CechaOpis
	, @KnW_PrcTyp = KnW_PrcTyp
	, @KnW_PrcFirma = KnW_PrcFirma
	, @KnW_PrcNumer = KnW_PrcNumer
	, @KnW_PrcLp = KnW_PrcLp
	, @KAp_CzyPotwierdzone = KAp_CzyPotwierdzone
	, @KAp_MagTyp = KAp_MagTyp
	, @KAp_MagFirma = KAp_MagFirma
	, @KAp_MagNumer = KAp_MagNumer
	, @KAp_MagLp = KAp_MagLp
	, @KnW_OutlookUrl = KnW_OutlookUrl
	, @KnW_Nieaktywny = KnW_Nieaktywny
	, @KnW_Zrodlo = KnW_Zrodlo
	, @KnW_Branza = KnW_Branza
	, @KnW_Rodzaj = KnW_Rodzaj
	, @KnW_RolaPartnera = KnW_RolaPartnera
	, @KnW_Kraj = KnW_Kraj
	, @KnW_KarTyp = KnW_KarTyp
	, @KnW_KarFirma = KnW_KarFirma
	, @KnW_KarNumer = KnW_KarNumer
	, @KnW_KarLp = KnW_KarLp
	, @KnW_FormaPlZak = KnW_FormaPlZak
	, @KnW_TerminPlZak = KnW_TerminPlZak
	, @KnW_SpTerminPlZak = KnW_SpTerminPlZak
	, @KnW_SpTerminSpr = KnW_SpTerminSpr
	, @KnW_Spedytor = KnW_Spedytor
	, @KnW_PriorytetRez = KnW_PriorytetRez
	, @KnW_TerminRozliczeniaKaucji = KnW_TerminRozliczeniaKaucji
	, @KnW_PlatnoscKaucji = KnW_PlatnoscKaucji
	, @KnW_KnPTyp = KnW_KnPTyp
	, @KnW_KnPNumer = KnW_KnPNumer
	, @KnW_KnPParam = KnW_KnPParam
	, @KnW_Powiazany = KnW_Powiazany
	, @KnW_KnGTyp = KnW_KnGTyp
	, @KnW_KnGNumer = KnW_KnGNumer
	, @KnW_KalendarzDst = KnW_KalendarzDst
	, @KnW_KalendarzWys = KnW_KalendarzWys
	, @KnW_RegionCRM = KnW_RegionCRM
	, @KAp_OpeNumer = KAp_OpeNumer
	, @KAp_OpeHaslo = KAp_OpeHaslo
	, @KAp_OpeONumer = KAp_OpeONumer
	, @KAp_TwrGrupaNumer = KAp_TwrGrupaNumer
	, @KAp_Seria = KAp_Seria
	, @KnW_PodatnikiemNabywca = KnW_PodatnikiemNabywca
	, @KAp_PrefiksObcy = KAp_PrefiksObcy
	, @KnW_MSTwrGrupaNumer = KnW_MSTwrGrupaNumer
	, @KnW_AutoAkronim = KnW_AutoAkronim
	, @KnW_ESklep = KnW_ESklep
	, @KAp_MagMSTyp = KAp_MagMSTyp
	, @KAp_MagMSFirma = KAp_MagMSFirma
	, @KAp_MagMSNumer = KAp_MagMSNumer
	, @KAp_MagMSLp = KAp_MagMSLp
	--2017.1
	, @KnW_RolnikRyczaltowy = KnW_RolnikRyczaltowy
	--2018.2
	, @KnW_SplitPayment = KnW_SplitPayment
	--2023.2
	, @KnW_KSeFWyslij = KnW_KSeFWyslij
	, @KnW_KSeFZrodlowy = KnW_KSeFZrodlowy
FROM cdn.kntwzorce
LEFT JOIN CDN.KntAplikacje
	ON KnW_GrpNumer = KAp_KntNumer
		AND KnW_GrpTyp = KAp_KntTyp
WHERE knw_grptyp = @knwGrpTyp
	AND knw_grpnumer = @knwGrpNumer

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Nieokreślony błąd! - (5)'
			, 16
			, 1
			)

	RETURN 5
END

--obsługa pól
-------------------------------------------------------------------------------------
--Knt_Akronim
-------------------------------------------------------------------------------------
IF @Akronim = ''
BEGIN
	IF @KnW_AutoAkronim &gt; 0
		--select @Akronim = isnull(max(Knt_GIDNumer),0)+1 from cdn.KntKarty with (nolock) 
		SELECT @Akronim = isnull(IDENT_CURRENT('CDN.KntKarty'), 0) + 1 --TS Bug #107710
	ELSE
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie podano akronimu kontrahenta - (40)'
				, 16
				, 1
				)

		RETURN 40
	END
END

IF EXISTS (
		SELECT *
		FROM cdn.kntkarty
		WHERE knt_akronim = @Akronim
		)
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Kontrahent o podanym akronimie [%s] już istnieje - (6)'
			, 16
			, 1
			, @Akronim
			)

	RETURN 6
END

-- obsługa pola knt_akronim i knt_soundex
SET @Akronim = UPPER(@Akronim)
SET @SoundExPL = CDN.SoundExPl(@Akronim)

-------------------------------------------------------------------------------------
-- Knt_Typ
-------------------------------------------------------------------------------------
IF @Typ IS NOT NULL
BEGIN
	IF @Typ NOT IN (8, 16, 24)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Knt_Typ [%d] - (7)'
				, 16
				, 1
				, @Typ
				)

		RETURN 7
	END
END
ELSE --jesli null to bierzemy z wzorca
	SET @Typ = @KnW_Typ

-------------------------------------------------------------------------------------
-- Knt_Akwizytor
-------------------------------------------------------------------------------------
IF @Akwizytor IS NOT NULL
BEGIN
	IF @Akwizytor NOT IN (0, 1)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Knt_Akwizytor [%d]  - (8)'
				, 16
				, 1
				, @Akwizytor
				)

		RETURN 8
	END
END
ELSE
	SET @Akwizytor = @KnW_Akwizytor

-------------------------------------------------------------------------------------
-- Knt_AkronimFormat
-------------------------------------------------------------------------------------
IF @AkronimFormat IS NULL
	SET @AkronimFormat = @KnW_AkronimFormat

-------------------------------------------------------------------------------------
-- Knt_Nazwa1
-------------------------------------------------------------------------------------
IF @Nazwa1 IS NULL
	SET @Nazwa1 = @KnW_Nazwa1

-------------------------------------------------------------------------------------
-- Knt_Nazwa2
-------------------------------------------------------------------------------------
IF @Nazwa2 IS NULL
	SET @Nazwa2 = @KnW_Nazwa2

-------------------------------------------------------------------------------------
-- Knt_Nazwa3
-------------------------------------------------------------------------------------
IF @Nazwa3 IS NULL
	SET @Nazwa3 = @KnW_Nazwa3

-------------------------------------------------------------------------------------
-- Knt_KodP
-------------------------------------------------------------------------------------
IF @KodP IS NULL
	SET @KodP = @KnW_KodP

-------------------------------------------------------------------------------------
-- Knt_Miasto
-------------------------------------------------------------------------------------
IF @Miasto IS NULL
	SET @Miasto = @KnW_Miasto

-------------------------------------------------------------------------------------
-- Knt_Ulica
-------------------------------------------------------------------------------------
IF @Ulica IS NULL
	SET @Ulica = @KnW_Ulica

-------------------------------------------------------------------------------------
-- Knt_Adres
-------------------------------------------------------------------------------------
IF @Adres IS NULL
	SET @Adres = @KnW_Adres

-------------------------------------------------------------------------------------
-- Knt_Kraj
-------------------------------------------------------------------------------------
IF @Kraj IS NULL
	SET @Kraj = @KnW_Kraj

-------------------------------------------------------------------------------------
-- Knt_NipPrefiks
-------------------------------------------------------------------------------------
IF @NipPrefiks IS NULL
BEGIN
	IF UPPER(@Kraj) IN ('AT', 'BE', 'CY', 'CZ', 'DE', 'DK', 'EE', 'ES', 'FI', 'FR', 'GB', 'GR', 'HU', 'IE', 'IT', 'LT', 'LU', 'LV', 'MT', 'NL', 'PT', 'SE', 'SI', 'SK')
		SET @NipPrefiks = UPPER(@Kraj)
	ELSE
		SET @NipPrefiks = ''
END

-- Knt_Status
IF @Status IS NOT NULL
BEGIN
	IF @Status NOT IN (1, 2)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Knt_Status [%d] - (18)'
				, 16
				, 1
				, @Status
				)

		RETURN 18
	END
END
ELSE
	SET @Status = isnull(@KnW_Status, 1)

IF @Status NOT IN (1, 2)
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Nieprawidłowa wartość pola Knt_Status z wzorca [%d] - (18)'
			, 16
			, 1
			, @Status
			)

	RETURN 18
END

-------------------------------------------------------------------------------------
-- Knt_PlatnikVat
-------------------------------------------------------------------------------------
IF @PlatnikVat IS NOT NULL
BEGIN
	IF @PlatnikVat NOT IN (0, 1)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Knt_PlatnikVat [%d] - (17)'
				, 16
				, 1
				, @PlatnikVat
				)

		RETURN 17
	END
END
ELSE IF @Status = 2 --TID:155976
	SET @PlatnikVat = 0
ELSE
	SET @PlatnikVat = @KnW_PlatnikVat

-- Knt_ExpoKraj
IF @ExpoKraj IS NOT NULL
BEGIN
	IF @ExpoKraj NOT IN (0, 1, 2, 3)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Knt_ExpoKraj [%d] - (16)'
				, 16
				, 1
				, @ExpoKraj
				)

		RETURN 16
	END
END
ELSE
	SET @ExpoKraj = @KnW_ExpoKraj

-- Knt_NipE
--IF @NipE is null
--      Set @NipE = @KnW_NipE
IF @NipE IS NOT NULL
BEGIN
	--sprawdzenie poprawności NIP'u
	IF @ExpoKraj = 1
		--IF (
		--	upper(@NipPrefiks) = ''
		--	OR upper(@NipPrefiks) = 'PL'
		--	)
		--AND (
		--	UPPER(@Kraj) = 'PL'
		--	OR @Kraj = ''
		--	)
	BEGIN
		SET @i = 1

		WHILE @i &lt;= LEN(@NipE)
		BEGIN
			IF NOT (
					ASCII(SUBSTRING(@NipE, @i, 1)) &gt;= 48
					AND ASCII(SUBSTRING(@NipE, @i, 1)) &lt;= 57
					OR ASCII(SUBSTRING(@NipE, @i, 1)) = 45
					)
			BEGIN
				ROLLBACK TRANSACTION

				RAISERROR (
						'Niepoprawny numer NIP [%s] - (44)'
						, 16
						, 1
						, @NipE
						)

				RETURN 44
			END

			SET @i = @i + 1
		END

		SET @Nip = REPLACE(@NipE, '-', '')

		IF @Nip &lt;&gt; ''
			AND LEN(@Nip) &lt;&gt; 10
		BEGIN
			ROLLBACK TRANSACTION

			RAISERROR (
					'Niepoprawny numer NIP [%s]- (44)'
					, 16
					, 1
					, @Nip
					)

			RETURN 44
		END
	END
	ELSE
		SET @Nip = REPLACE(@NipE, '-', '')
END
ELSE
BEGIN
	SET @NipE = @KnW_NipE

	--IF (
	--		upper(@NipPrefiks) = ''
	--		OR upper(@NipPrefiks) = 'PL'
	--		)
	--	AND (
	--		UPPER(@Kraj) = 'PL'
	--		OR @Kraj = ''
	--		)
	IF @ExpoKraj = 1
	BEGIN
		SET @Nip = REPLACE(@NipE, '-', '')

		IF @Nip &lt;&gt; ''
			AND LEN(@Nip) &lt;&gt; 10
		BEGIN
			ROLLBACK TRANSACTION

			RAISERROR (
					'Niepoprawny numer NIP [%s]- (44)'
					, 16
					, 1
					, @Nip
					)

			RETURN 44
		END
	END
	ELSE
		SET @Nip = REPLACE(@NipE, '-', '')
END

-- Knt_Regon
IF @Regon IS NULL
	SET @Regon = @KnW_Regon

-- Knt_Pesel
IF @Pesel IS NULL
	SET @Pesel = @KnW_Pesel

-- Knt_FormaPl
IF @FormaPl IS NULL
	SET @FormaPl = @KnW_FormaPl

-- Knt_FormaPlZak
IF @FormaPlZak IS NULL
	SET @FormaPlZak = @KnW_FormaPlZak

-- Knt_Powiat
IF @Powiat IS NULL
	SET @Powiat = @KnW_Powiat

-- Knt_Gmina
IF @Gmina IS NULL
	SET @Gmina = @KnW_Gmina

-- Knt_Wojewodztwo
IF @Wojewodztwo IS NULL
	SET @Wojewodztwo = @KnW_Wojewodztwo

-- MSTwrGrupaNumer
IF @MSTwrGrupaNumer IS NULL
	SET @MSTwrGrupaNumer = @KnW_MSTwrGrupaNumer

-- Knt_RegionCRM
IF @RegionCRM IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.Rejony
			WHERE REJ_Id = @RegionCRM
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono wartosci kategorii spośród kategorii Regiony CRM [%d] - (11)'
				, 16
				, 1
				, @RegionCRM
				)

		RETURN 11
	END
END
ELSE
	SET @RegionCRM = @KnW_RegionCRM

-- pobranie rejonu głównego z kodu pocztowego       
IF @RegionCRM IS NULL
	OR @RegionCRM = 0
BEGIN
	IF @KodP IS NOT NULL
		AND @KodP &lt;&gt; '00000'
		AND @KodP &lt;&gt; '00-000'
	BEGIN
		SELECT @RegionCRM = ISNULL(KnP_Region, 0)
		FROM CDN.KntKody
		WHERE KnP_KodP = @KodP
			AND KnP_Miasto = @Miasto
			AND KnP_Kraj = @Kraj
	END
END

-- KntOpiekun
IF @OpiekunCzas IS NULL
BEGIN
	SELECT TOP 1 @OpiekunCzas = KtO_PrcNumer
		, @OpiekunDataOd = KtO_DataOd
		, @OpiekunDataDo = KtO_DataDo
	FROM CDN.KntOpiekun
	WHERE KtO_KntTyp = @knwGrpTyp
		AND KtO_KntNumer = @knwGrpNumer
END
ELSE
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.PrcKarty
			WHERE Prc_GIDNumer = @OpiekunCzas
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono pracownika, który miałby być opiekunem czasowym [%d] - (11)'
				, 16
				, 1
				, @OpiekunCzas
				)

		RETURN 11
	END
END

--select @OpiekunCzas = ISNULL(@OpiekunCzas,0),@OpiekunDataOd = ISNULL(@OpiekunDataOd,0),@OpiekunDataDo = ISNULL(@OpiekunDataDo,0)
IF @OpiekunCzas IS NOT NULL
	AND (
		@OpiekunDataOd IS NULL
		OR @OpiekunDataOd &lt; 4
		OR @OpiekunDataOd &gt;= 93890
		)
	SELECT @OpiekunDataOd = DATEDIFF(d, '18001228', GETDATE())

IF @OpiekunCzas IS NOT NULL
	AND (
		@OpiekunDataDo IS NULL
		OR @OpiekunDataDo &lt; @OpiekunDataOd
		)
	SELECT @OpiekunDataDo = 93890

-- Knt_GLN
IF @GLN IS NOT NULL
BEGIN
	EXECUTE @err = Cdn.PoliczCyfreKontrolnaGLN @GLN
		, @CyfraKontrolnaGLN OUTPUT

	IF @err &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowy numer GLN [%s] - (48)'
				, 16
				, 1
				, @GLN
				)

		RETURN 48
	END
END

-- Knt_NRB + Knt_NrRachunku
IF @NRB IS NOT NULL
BEGIN --jeśli nrb ma byc zaznaczony to musi być podany bank i nr rachunku
	IF @NRB IN (0, 1)
	BEGIN
		IF @BnkTyp IS NOT NULL
			AND @BnkFirma IS NOT NULL
			AND @BnkNumer IS NOT NULL
			AND @NrRachunku IS NOT NULL
		BEGIN
			SELECT @BnkNrRachunku = bnk_numer
			FROM cdn.banki
			WHERE bnk_gidtyp = @BnkTyp
				AND bnk_gidnumer = @BnkNumer
		END
		ELSE
			SET @NRB = 0 --jesli nie podano banku to nrb nie moze byc zaznaczony

		IF @NRB = 1
		BEGIN --sprawdzanie czy można zaznaczyć ten check
			IF len(@NRRachunku) &lt; 24
				AND charindex(@BnkNrRachunku, @NrRachunku) = 0
				SET @NrRachunku = @BnkNrRachunku + '-' + @NrRachunku

			EXECUTE @err = Cdn.SprawdzPoprawnoscNRB @NrRachunku OUTPUT --zwracany numer z cyframi kontrolnymi

			IF @err &lt;&gt; 0
			BEGIN
				ROLLBACK TRANSACTION

				RAISERROR (
						'Nieprawidłowa wartość pola Knt_NRB [%s] - (43)'
						, 16
						, 1
						, @NrRachunku
						)

				RETURN 43
			END
					--Set @NRB = 0 --nr niezgodny z NRB, check nie moze byc zaznaczony
		END
		ELSE IF @NRB = 0
			AND len(@NRRachunku) &lt; 24
			AND charindex(@BnkNrRachunku, @NrRachunku) = 0
			SET @NrRachunku = @BnkNrRachunku + '-' + @NrRachunku
	END
	ELSE
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Knt_NRB [%d]- (12)'
				, 16
				, 1
				, @NRB
				)

		RETURN 12
	END
END

-- Knt_BnkGID + Knt_NrRachunku
IF @BnkTyp IS NOT NULL
	AND @BnkFirma IS NOT NULL
	AND @BnkNumer IS NOT NULL
	AND @NrRachunku IS NOT NULL
BEGIN
	--sprawdzenie czy bank istnieje
	IF NOT EXISTS (
			SELECT *
			FROM cdn.banki
			WHERE Bnk_GIDTyp = @BnkTyp
				AND Bnk_GIDNumer = @BnkNumer
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Podany bank nie istnieje [%d,%d]- (13)'
				, 16
				, 1
				, @BnkTyp
				, @BnkNumer
				)

		RETURN 13
	END
	ELSE
	BEGIN
		SELECT @BnkNrRachunku = Bnk_Numer
		FROM cdn.banki
		WHERE Bnk_GIDTyp = @BnkTyp
			AND Bnk_GIDNumer = @BnkNumer

		--tutaj trzeba sprawdzać check nrb i poprawnosc numeru rachunku
		IF @NRB IS NULL
		BEGIN
			IF @NrRachunku IS NOT NULL
				IF len(@NRRachunku) &lt; 24
					AND charindex(@BnkNrRachunku, @NrRachunku) = 0
					SET @NrRachunku = @BnkNrRachunku + '-' + @NrRachunku
				ELSE
					SET @NrRachunku = @BnkNrRachunku + '-'
		END
	END
END
ELSE
BEGIN
	SET @BnkTyp = @KnW_BnkTyp
	SET @BnkFirma = @KnW_BnkFirma
	SET @BnkNumer = @KnW_BnkNumer
END

-- Knt_Rabat
IF @Rabat IS NULL
	SET @Rabat = @KnW_Rabat
ELSE
BEGIN
	IF @Rabat &gt; 99.99
		OR @Rabat &lt; 0.00
	BEGIN
		ROLLBACK TRANSACTION

		DECLARE @RabatStr VARCHAR(10)

		SET @RabatStr = @Rabat

		RAISERROR (
				'Niedopuszczalna wartość rabatu [%s] - (14)'
				, 16
				, 1
				, @RabatStr
				)

		RETURN 14
	END
END

-- Knt_LimitTerminowy
IF @LimitTerminowy IS NOT NULL
BEGIN
	IF @LimitTerminowy NOT IN (0, 1)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Knt_LimitTerminowy [%d] - (32)'
				, 16
				, 1
				, @LimitTerminowy
				)

		RETURN 32
	END
END
ELSE
	SET @LimitTerminowy = @KnW_LimitTerminowy

IF @LimitTerminowy = 0
BEGIN
	SET @MaxLimitWart = 0
	SET @LimitPoTerminie = 0
END

-- Knt_MaxLimitWart
IF @MaxLimitWart IS NULL
	SET @MaxLimitWart = @KnW_MaxLimitWart

IF @MaxLimitWart IS NOT NULL
BEGIN
	SELECT @OpeLimitKredytu = Ope_LimitKredytu
		, @LimitBezOgraniczenia = Ope_LimitBezOgraniczenia
	FROM cdn.opekarty
	WHERE ope_gidtyp = @OpeTyp
		AND ope_gidnumer = @OpeNumer

	IF @MaxLimitWart &gt; @OpeLimitKredytu
		AND @LimitBezOgraniczenia = 0
		SET @MaxLimitWart = @OpeLimitKredytu
END

-- Knt_LimitPoTerminie
IF @LimitPoTerminie IS NULL
	SET @LimitPoTerminie = @KnW_LimitPoTerminie

IF @LimitPoTerminie IS NOT NULL
BEGIN
	SELECT @OpeLimitPoTerminie = Ope_LimitPoTerminie
		, @LimitBezOgraniczenia = Ope_LimitBezOgraniczenia
	FROM cdn.opekarty
	WHERE ope_gidtyp = @OpeTyp
		AND ope_gidnumer = @OpeNumer

	IF @LimitPoTerminie &gt; @OpeLimitPoTerminie
		AND @LimitBezOgraniczenia = 0
		SET @LimitPoTerminie = @OpeLimitPoTerminie
END

-- Knt_DataWygasniecia
IF @DataWygasniecia IS NULL
	SET @DataWygasniecia = @KnW_DataWygasniecia

-- Knt_MaxDniPoTerminie
IF @MaxDniPoTerminie IS NULL
	SET @MaxDniPoTerminie = @KnW_MaxDniPoTerminie

-- Knt_LimitOkres
IF @LimitOkres IS NULL
	SET @LimitOkres = @KnW_LimitOkres

-- Knt_Dewizowe
IF @Dewizowe IS NOT NULL
BEGIN
	IF @Dewizowe NOT IN (0, 1)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Knt_Dewizowe [%d] - (15)'
				, 16
				, 1
				, @Dewizowe
				)

		RETURN 15
	END
END
ELSE
	SET @Dewizowe = @KnW_Dewizowe

-- Knt_Symbol
IF @Symbol IS NULL
	SET @Symbol = @KnW_Symbol

-- Knt_Cena
IF @Cena IS NULL
	SET @Cena = @KnW_Cena

-- Knt_TypKarty
IF @TypKarty IS NULL
	SET @TypKarty = @KnW_TypKarty

-- Knt_SeriaFa
IF @SeriaFa IS NULL
	SET @SeriaFa = @KnW_SeriaFa

-- Knt_Koncesja
IF @Koncesja IS NOT NULL
	AND @Koncesja &gt; 0
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.SlownikiStruktura
			INNER JOIN CDN.Slowniki
				ON SLS_Id = SLW_SLSId
			WHERE SLW_ID = @Koncesja
				AND SLS_Predefiniowany = 128
			) --e_sls_Koncesje
	BEGIN
		/*ROLLBACK TRAN
                RAISERROR('Nieprawidłowa wartość pola Koncesja - (19)',16,1)
                RETURN 19*/
		SET @Koncesja = 0
	END
END
ELSE
BEGIN
	IF @Koncesja IS NULL
		SET @Koncesja = 0
END

-- Knt_SposobDostawy
IF @SposobDostawy IS NULL
	SET @SposobDostawy = @KnW_SposobDostawy

-- Knt_AkwGID + obsługa
IF @AkwTyp IS NOT NULL
	AND @AkwFirma IS NOT NULL
	AND @AkwNumer IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM cdn.kntkarty
			WHERE knt_gidtyp = @AkwTyp
				AND knt_gidnumer = @AkwNumer
			)
		AND NOT EXISTS (
			SELECT *
			FROM cdn.prckarty
			WHERE prc_gidtyp = @AkwTyp
				AND prc_gidnumer = @AkwNumer
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono akwizytora [%d,%d]- (20)'
				, 16
				, 1
				, @AkwTyp
				, @AkwNumer
				)

		RETURN 20
	END
END
ELSE
BEGIN
	SET @AkwTyp = @KnW_AkwTyp
	SET @AkwFirma = @KnW_AkwFirma
	SET @AkwNumer = @KnW_AkwNumer
END

-- Knt_AkwProwizja
IF @AkwProwizja IS NULL
	SET @AkwProwizja = @KnW_AkwProwizja

-- Knt_CechaOpis
IF @CechaOpis IS NULL
	SET @CechaOpis = @KnW_CechaOpis

-- Knt_PrcGID + obsługa
IF @PrcTyp IS NOT NULL
	AND @PrcFirma IS NOT NULL
	AND @PrcNumer IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM cdn.prckarty
			WHERE prc_gidtyp = @PrcTyp
				AND prc_gidnumer = @PrcNumer
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono pracownika [%d,%d] - (21)'
				, 16
				, 1
				, @PrcTyp
				, @PrcNumer
				)

		RETURN 21
	END
END
ELSE
BEGIN
	SET @PrcTyp = @KnW_PrcTyp
	SET @PrcFirma = @KnW_PrcFirma
	SET @PrcNumer = @KnW_PrcNumer
END

-- Knt_AutoPotwierdzenie
IF @AutoPotwierdzenie IS NOT NULL
BEGIN
	IF @AutoPotwierdzenie NOT IN (0, 1)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Knt_AutoPotwierdzenie [%d] - (22)'
				, 16
				, 1
				, @AutoPotwierdzenie
				)

		RETURN 22
	END
END

-- Knt_OutlookUrl
IF @OutlookUrl IS NULL
	SET @OutlookUrl = @KnW_OutlookUrl

-- Knt_Zrodlo
IF @Zrodlo IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.Slowniki
			INNER JOIN CDN.SlownikiStruktura
				ON SLW_SLSId = SLS_Id
			WHERE SLS_Predefiniowany = 18 /*e_sls_ZrodlaPochodzenia*/
				AND SLW_ID = @Zrodlo
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono wartości kategorii spośród kateroii Źródło pochodzenia [%d] - (24)'
				, 16
				, 1
				, @Zrodlo
				)

		RETURN 24
	END
END
ELSE
	SET @Zrodlo = @KnW_Zrodlo

-- Knt_Branza
IF @Branza IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.Slowniki
			INNER JOIN CDN.SlownikiStruktura
				ON SLW_SLSId = SLS_Id
			WHERE SLS_Predefiniowany = 9 /*e_sls_BranzeKontrahentow*/
				AND SLW_ID = @Branza
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono wartości kategorii spośród kateroii Branża kontrahenta [%d] - (25)'
				, 16
				, 1
				, @Branza
				)

		RETURN 25
	END
END
ELSE
	SET @Branza = @KnW_Branza

-- Knt_Rodzaj
IF @Rodzaj IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.Slowniki
			INNER JOIN CDN.SlownikiStruktura
				ON SLW_SLSId = SLS_Id
			WHERE SLS_Predefiniowany = 14 /*e_sls_RodzajeKontrahentow*/
				AND SLW_ID = @Rodzaj
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono wartości kategorii spośród kateroii Rodzaj kontrahenta [%d] - (26)'
				, 16
				, 1
				, @Rodzaj
				)

		RETURN 26
	END
END
ELSE
	SET @Rodzaj = @KnW_Rodzaj

-- Knt_RolaPartnera
IF @RolaPartnera IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.Slowniki
			INNER JOIN CDN.SlownikiStruktura
				ON SLW_SLSId = SLS_Id
			WHERE SLS_Predefiniowany = 16 /*e_sls_RolePartnera*/
				AND SLW_ID = @RolaPartnera
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono wartości kategorii spośród kateroii Rola partnera [%d] - (27)'
				, 16
				, 1
				, @RolaPartnera
				)

		RETURN 27
	END
END
ELSE
	SET @RolaPartnera = @KnW_RolaPartnera

-- Knt_Priorytet
IF @Priorytet IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.Slowniki
			INNER JOIN CDN.SlownikiStruktura
				ON SLW_SLSId = SLS_Id
			WHERE SLS_Predefiniowany = 12 /*e_sls_PriorytetyKontrahentow*/
				AND SLW_ID = @Priorytet
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono wartości kategorii spośród katergoii Priorytet kontrahenta [%d] - (28)'
				, 16
				, 1
				, @Priorytet
				)

		RETURN 28
	END
END

-- Knt_PriorytetRez
IF @PriorytetRez IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.Slowniki
			INNER JOIN CDN.SlownikiStruktura
				ON SLW_SLSId = SLS_Id
			WHERE SLS_Predefiniowany = 55 /*e_sls_PriorytetyRezerwacji*/
				AND SLW_WartoscL1 = @PriorytetRez
			)
		SET @PriorytetRez = 0
END
ELSE
	SET @PriorytetRez = @KnW_PriorytetRez

IF @PriorytetRez = 0
	SELECT @PriorytetRez = SLW_WartoscL1
	FROM CDN.Slowniki
	INNER JOIN CDN.SlownikiStruktura
		ON SLW_SLSId = SLS_Id
	WHERE SLS_Predefiniowany = 55 /*e_sls_PriorytetyRezerwacji*/
		AND SLW_Domyslny = 1

-- Knt_KarGID + obsługa
IF @KarTyp IS NOT NULL
	AND @KarFirma IS NOT NULL
	AND @KarNumer IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM cdn.rejestry
			WHERE kar_gidtyp = @KarTyp
				AND kar_gidnumer = @KarNumer
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono rejestru [%d,%d]- (29)'
				, 16
				, 1
				, @KarTyp
				, @KarNumer
				)

		RETURN 29
	END
END
--ELSE
--BEGIN
--	SET @KarTyp = @KnW_KarTyp
--	SET @KarFirma = @KnW_KarFirma
--	SET @KarNumer = @KnW_KarNumer
--END

-- Knt_BlokadaTransakcji + obsługa(operator blokujący transakcje)
IF @BlokadaTransakcji IS NOT NULL
BEGIN
	IF @BlokadaTransakcji NOT IN (0, 1)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Knt_BlokadaTransakcji [%d] - (30)'
				, 16
				, 1
				, @BlokadaTransakcji
				)

		RETURN 30
	END
	ELSE
		SET @LastTransLockDate = datediff(s, '19900101', getdate())

	SET @ZtrTyp = @OpeTyp
	SET @ZtrFirma = @OpeFirma
	SET @ZtrNumer = @OpeNumer
END
ELSE
BEGIN
	SET @ZtrTyp = 0
	SET @ZtrFirma = 0
	SET @ZtrNumer = 0
END

-- Knt_Spedytor
IF @Spedytor IS NOT NULL
BEGIN
	IF @Spedytor NOT IN (0, 1)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Knt_Spedytor [%d] - (31)'
				, 16
				, 1
				, @Spedytor
				)

		RETURN 31
	END
END
ELSE
	SET @Spedytor = @KnW_Spedytor

-- Knt_TerminPlZak
IF @TerminPlZak IS NULL
	SET @TerminPlZak = @KnW_TerminPlZak

-- Knt_SpTerminPlSpr
IF @SpTerminPlSpr IS NULL
	SET @SpTerminPlSpr = @KnW_SpTerminSpr

-- Knt_SpTerminPlZak
IF @SpTerminPlZak IS NULL
	SET @SpTerminPlZak = @KnW_SpTerminPlZak

-- Knt_TerminRozliczeniaKaucji
IF @TerminRozliczeniaKaucji IS NULL
	SET @TerminRozliczeniaKaucji = @KnW_TerminRozliczeniaKaucji

-- Knt_PlatnoscKaucji
IF @PlatnoscKaucji IS NULL
	SET @PlatnoscKaucji = @KnW_PlatnoscKaucji
ELSE
BEGIN
	IF @PlatnoscKaucji &gt; 0
		SET @PlatnoscKaucji = 1
	ELSE
		SET @PlatnoscKaucji = 0
END

-- Kontrahent główny
IF @KnGTyp = 32
	AND @KnGNumer IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM cdn.kntkarty
			WHERE knt_gidnumer = @KnGNumer
			)
	BEGIN
		IF @KontrahentGlowny IS NOT NULL
			SELECT @KnGNumer = Knt_GIDNumer
			FROM cdn.kntkarty
			WHERE knt_akronim = @KontrahentGlowny
	END
END
ELSE IF @KontrahentGlowny IS NOT NULL
BEGIN
	IF EXISTS (
			SELECT *
			FROM cdn.kntkarty
			WHERE knt_akronim = @KontrahentGlowny
			)
		SELECT @KnGTyp = Knt_GIDTyp
			, @KnGNumer = Knt_GIDNumer
		FROM cdn.kntkarty
		WHERE knt_akronim = @KontrahentGlowny
END
ELSE
BEGIN
	SET @KnGTyp = @KnW_KnGTyp
	SET @KnGNumer = @KnW_KnGNumer
END

--sprawdzenie kontrahenta głównego
SET @KntGlownyIstnieje = 0

IF @KnGTyp = 32
BEGIN
	IF EXISTS (
			SELECT *
			FROM cdn.kntkarty
			WHERE knt_gidnumer = @KnGNumer
			)
		SET @KntGlownyIstnieje = 1
END

-- Platnik
IF @KnPTyp = 32
	AND @KnPNumer IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM cdn.kntkarty
			WHERE knt_gidnumer = @KnPNumer
			)
	BEGIN
		IF @Platnik IS NOT NULL
			SELECT @KnPNumer = Knt_GIDNumer
			FROM cdn.kntkarty
			WHERE knt_akronim = @Platnik
	END
END
ELSE IF @KnPTyp = 48
	AND @KnPNumer IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM cdn.banki
			WHERE bnk_gidnumer = @KnPNumer
			)
	BEGIN
		IF @Platnik IS NOT NULL
			SELECT @KnPNumer = bnk_GIDNumer
			FROM cdn.banki
			WHERE bnk_kod = @Platnik
	END
END
ELSE IF @KnPTyp = 4304
	AND @KnPNumer IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM cdn.urzedy
			WHERE urz_gidnumer = @KnPNumer
			)
	BEGIN
		IF @Platnik IS NOT NULL
			SELECT @KnPNumer = Urz_GIDNumer
			FROM cdn.urzedy
			WHERE urz_akronim = @Platnik
	END
END
ELSE IF @KnPTyp = 944
	AND @KnPNumer IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM cdn.prckarty
			WHERE prc_gidnumer = @KnPNumer
			)
	BEGIN
		IF @Platnik IS NOT NULL
			SELECT @KnPNumer = prc_GIDNumer
			FROM cdn.prckarty
			WHERE prc_akronim = @Platnik
	END
END
ELSE IF @Platnik IS NOT NULL
BEGIN
	IF EXISTS (
			SELECT *
			FROM cdn.kntkarty
			WHERE knt_akronim = @Platnik
			)
		SELECT @KnPTyp = Knt_GIDTyp
			, @KnPNumer = Knt_GIDNumer
		FROM cdn.kntkarty
		WHERE knt_akronim = @Platnik
	ELSE IF EXISTS (
			SELECT *
			FROM cdn.banki
			WHERE bnk_kod = @Platnik
			)
		SELECT @KnPTyp = Bnk_GIDTyp
			, @KnPNumer = Bnk_GIDNumer
		FROM cdn.banki
		WHERE bnk_kod = @Platnik
	ELSE IF EXISTS (
			SELECT *
			FROM cdn.urzedy
			WHERE urz_akronim = @Platnik
			)
		SELECT @KnPTyp = Urz_GIDTyp
			, @KnPNumer = Urz_GIDNumer
		FROM cdn.urzedy
		WHERE urz_akronim = @Platnik
	ELSE IF EXISTS (
			SELECT *
			FROM cdn.prckarty
			WHERE prc_akronim = @Platnik
			)
		SELECT @KnPTyp = Prc_GIDTyp
			, @KnPNumer = Prc_GIDNumer
		FROM cdn.PrcKarty
		WHERE Prc_Akronim = @Platnik
END
ELSE
BEGIN
	SET @KnPTyp = @KnW_KnPTyp
	SET @KnPNumer = @KnW_KnPNumer
END

-- sprawdzenie płatnika
SET @PlatnikIstnieje = 0

IF @KnPTyp = 32
BEGIN
	IF EXISTS (
			SELECT *
			FROM cdn.kntkarty
			WHERE knt_gidnumer = @KnPNumer
			)
		SET @PlatnikIstnieje = 1
END
ELSE IF @KnPTyp = 48
BEGIN
	IF EXISTS (
			SELECT *
			FROM cdn.banki
			WHERE bnk_gidnumer = @KnPNumer
			)
		SET @PlatnikIstnieje = 1
END
ELSE IF @KnPTyp = 4304
BEGIN
	IF EXISTS (
			SELECT *
			FROM cdn.urzedy
			WHERE urz_gidnumer = @KnPNumer
			)
		SET @PlatnikIstnieje = 1
END
ELSE IF @KnPTyp = 944
BEGIN
	IF EXISTS (
			SELECT *
			FROM cdn.prckarty
			WHERE prc_gidnumer = @KnPNumer
			)
		SET @PlatnikIstnieje = 1
END

-- Knt_KnPParam
IF @KnPParam IS NULL
	OR @KnPParam NOT IN (0, 1)
	SET @KnPParam = @KnW_KnPParam

-- Knt_AdresNieAktualny
IF @AdresNieAktualny IS NOT NULL
BEGIN
	IF @AdresNieAktualny NOT IN (0, 1)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Knt_AdresNieAktualny [%d] - (41)'
				, 16
				, 1
				, @AdresNieAktualny
				)

		RETURN 41
	END
END

-- Knt_Archiwalny
IF @Archiwalny IS NOT NULL
BEGIN
	IF @Archiwalny NOT IN (0, 1)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Knt_Archiwalny [%d] - (42)'
				, 16
				, 1
				, @Archiwalny
				)

		RETURN 42
	END
END

-- Knt_Oddzialowy
IF @Oddzialowy IS NULL
	OR @Oddzialowy NOT IN (0, 1)
	SET @Oddzialowy = 0

-- Knt_Powiazany
IF @Powiazany IS NULL
	OR @Powiazany NOT IN (0, 1)
	SET @Powiazany = @KnW_Powiazany

-- Knt_Kalendarze
IF @KalendarzDst IS NULL
	SET @KalendarzDst = isnull(@KnW_KalendarzDst, 0)
ELSE IF @KalendarzDst &lt;&gt; 0
	AND NOT EXISTS (
		SELECT *
		FROM CDN.ProdKalendarze
		WHERE PKA_Id = @KalendarzDst
			AND PKA_Typ = 1
		)
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Nie ma kalendarza dostaw o podanym numerze [%d] - (43)'
			, 16
			, 1
			, @KalendarzDst
			)

	RETURN 43
END

IF @KalendarzWys IS NULL
	SET @KalendarzWys = isnull(@KnW_KalendarzWys, 0)
ELSE IF @KalendarzWys &lt;&gt; 0
	AND NOT EXISTS (
		SELECT *
		FROM CDN.ProdKalendarze
		WHERE PKA_Id = @KalendarzWys
			AND PKA_Typ = 2
		)
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Nie ma kalendarza wysyłek o podanym numerze [%d] - (44)'
			, 16
			, 1
			, @KalendarzWys
			)

	RETURN 44
END

-- KAp_OpeNumer
IF @OpeNumerW IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.OpeKarty
			WHERE Ope_GIDNumer = @OpeNumerW
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono operatora wystawiającego [%d] - (52)'
				, 16
				, 1
				, @OpeNumerW
				)

		RETURN 52
	END
END

-- KAp_OpeONumer
IF @OpeNumerO IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.OpeKarty
			WHERE Ope_GIDNumer = @OpeNumerO
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono operatora odpowiedzialnego za realizację [%d] - (53)'
				, 16
				, 1
				, @OpeNumerO
				)

		RETURN 53
	END
END

-- KAp_TwrGrupaNumer
IF @TwrGrupaNumer IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.TwrGrupy
			WHERE TwG_GIDTyp = - 16
				AND TwG_GIDNumer = @TwrGrupaNumer
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono grupy towarów udostępnionej kontrahentowi [%d] - (54)'
				, 16
				, 1
				, @TwrGrupaNumer
				)

		RETURN 54
	END
END

--Knt_PodatnikiemNabywca        
IF @PodatnikiemNabywca IS NOT NULL
BEGIN
	IF @PodatnikiemNabywca NOT IN (0, 1)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Knt_PodatnikiemNabywca [%d] - (55)'
				, 16
				, 1
				, @PodatnikiemNabywca
				)

		RETURN 55
	END
	ELSE
	BEGIN
		IF @ExpoKraj &lt;&gt; 1
			OR @PlatnikVat &lt;&gt; 1
			SET @PodatnikiemNabywca = 0
	END
END
ELSE IF @ExpoKraj = 1
	AND @PlatnikVat = 1
	SET @PodatnikiemNabywca = isnull(@KnW_PodatnikiemNabywca, 0)
ELSE
	SET @PodatnikiemNabywca = 0

--@RolnikRyczaltowy
IF @RolnikRyczaltowy NOT IN (0, 1)
	SET @RolnikRyczaltowy = @KnW_RolnikRyczaltowy

IF not (isnull(@RolnikRyczaltowy,0) = 1 or isnull(@Status,0) = 2) --detaliczny, finalny
	SELECT @DokumentTozsamosci = ''
		, @DataWydania = 0
		, @OrganWydajacy = ''

IF ISNULL(@RolnikRyczaltowy, 0) = 1 OR ISNULL(@PlatnikVat, 0) = 1
	SELECT @KntMetodaKasowa = 1	

-----------------------------------------------------------------------------------------------------
-- SplitPayment
-----------------------------------------------------------------------------------------------------
IF NOT isnull(@SplitPayment, @KnW_SplitPayment) = 0
	AND NOT (
		isnull(@SplitPayment, @KnW_SplitPayment) = 1
		AND isnull(@PlatnikVat, @KnW_PlatnikVat) = 1
		AND isnull(@Status, @KnW_Status) = 1
		AND (
			(
				isnull(@Dewizowe, @KnW_Dewizowe) = 1
				AND isnull(@Symbol, @KnW_Symbol) = 'PLN'
				)
			OR (
				isnull(@Dewizowe, @KnW_Dewizowe) = 0
				AND @WalutaSystemowa = 'PLN'
				)
			)
		)
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Nieprawidłowa wartość pola Knt_SplitPayment [%d] - (56)'
			, 16
			, 1
			, @SplitPayment
			)

	RETURN 56
END


-----------------------------------------------------------------------------------------------------
-- KSeFWyslij
-----------------------------------------------------------------------------------------------------
IF ISNULL(@KSeFWyslij, 0) NOT IN (0, 1, 3)
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Nieprawidłowa wartość pola Knt_KSeFWyslij [%d] - (57)'
			, 16
			, 1
			, @KSeFWyslij
			)

	RETURN 57
END

-----------------------------------------------------------------------------------------------------
-- KSeFZrodlowy
-----------------------------------------------------------------------------------------------------
IF ISNULL(@KSeFZrodlowy, 0) NOT IN (0, 1, 3)
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Nieprawidłowa wartość pola Knt_KSeFZrodlowy [%d] - (58)'
			, 16
			, 1
			, @KSeFZrodlowy
			)

	RETURN 58
END




INSERT INTO cdn.kntkarty (
	Knt_GIDTyp
	, Knt_GIDFirma
	,
	--Knt_GIDNumer,
	Knt_GIDLp
	,
	--Knt_KnATyp,
	--Knt_KnAFirma,
	--Knt_KnANumer,
	--Knt_KnALp,
	Knt_Typ
	, Knt_Akwizytor
	, Knt_Akronim
	, Knt_AkronimFormat
	, Knt_FppKod
	, Knt_Nazwa1
	, Knt_Nazwa2
	, Knt_Nazwa3
	, Knt_KodP
	, Knt_Miasto
	, Knt_Ulica
	, Knt_Adres
	, Knt_NipPrefiks
	, Knt_NipE
	, Knt_Nip
	, Knt_Regon
	, Knt_Pesel
	, Knt_KontoDostawcy
	, Knt_KontoOdbiorcy
	, Knt_Telefon1
	, Knt_Telefon2
	, Knt_Fax
	, Knt_Modem
	, Knt_Telex
	, Knt_EMail
	, Knt_URL
	, Knt_BnkTyp
	, Knt_BnkFirma
	, Knt_BnkNumer
	, Knt_BnkLp
	, Knt_NrRachunku
	, Knt_Soundex
	, Knt_Rabat
	, Knt_LimitWart
	, Knt_MaxLimitWart
	, Knt_LimitPoTerminie
	, Knt_LimitOkres
	, Knt_Dewizowe
	, Knt_Symbol
	, Knt_NrKursu
	, Knt_Cena
	, Knt_FormaPl
	, Knt_Marza
	, Knt_TypKarty
	, Knt_NumerKarty
	, Knt_DataKarty
	, Knt_Ean
	, Knt_ObcaKarta
	,
	--Knt_EanTyp,
	--Knt_EanFirma,
	--Knt_EanNumer,
	Knt_Osoba
	, Knt_ExpoKraj
	, Knt_SeriaFa
	, Knt_PlatnikVat
	, Knt_TypDok
	, Knt_Status
	, Knt_FAVATData
	, Knt_SposobDostawy
	, Knt_HasloChk
	, Knt_HasloKontrahent
	, Knt_Dzialalnosc
	, Knt_ZTrTyp
	, Knt_ZTrFirma
	, Knt_ZTrNumer
	, Knt_ZTrLp
	, Knt_OpeTyp
	, Knt_OpeFirma
	, Knt_OpeNumer
	, Knt_OpeLp
	, Knt_AkwTyp
	, Knt_AkwFirma
	, Knt_AkwNumer
	, Knt_AkwLp
	, Knt_Atrybut1
	, Knt_Format1
	, Knt_Wartosc1
	, Knt_Atrybut2
	, Knt_Format2
	, Knt_Wartosc2
	, Knt_Atrybut3
	, Knt_Format3
	, Knt_Wartosc3
	, Knt_AkwProwizja
	, Knt_Umowa
	, Knt_DataW
	, Knt_LastModL
	, Knt_LastModO
	,
	--Knt_LastModC,
	Knt_FaVATOsw
	, Knt_CechaOpis
	, Knt_Aktywna
	, Knt_Wsk
	, Knt_PrcTyp
	, Knt_PrcFirma
	, Knt_PrcNumer
	, Knt_PrcLp
	, Knt_OutlookUrl
	, Knt_Nieaktywny
	, Knt_Zrodlo
	, Knt_Branza
	, Knt_Rodzaj
	, Knt_RolaPartnera
	, Knt_Kraj
	, Knt_Odleglosc
	, Knt_KarTyp
	, Knt_KarFirma
	, Knt_KarNumer
	, Knt_KarLp
	, Knt_Powiat
	, Knt_Gmina
	, Knt_Wojewodztwo
	, Knt_NRB
	, Knt_Archiwalny
	, Knt_AdresNieAktualny
	, Knt_LastTransLockDate
	, Knt_OpeTypM
	, Knt_OpeFirmaM
	, Knt_OpeNumerM
	, Knt_OpeLpM
	, Knt_BlokadaTransakcji
	, Knt_RegionCRM
	, Knt_Oddzialowy
	,
	-- dodane w 3.1
	Knt_GLN
	, Knt_Spedytor
	, Knt_TerminPlKa
	, Knt_FormaPlKa
	, Knt_TerminPlZak
	, Knt_FormaPlZak
	, Knt_SpTerminPlSpr
	, Knt_SpTerminPlRK
	, Knt_SpTerminPlZak
	, Knt_LimitTerminowy
	, Knt_DataWygasniecia
	, Knt_MaxDniPoTerminie
	,
	--
	Knt_PIN
	, Knt_Priorytet
	, Knt_PriorytetRez
	, Knt_TerminRozliczeniaKaucji
	, Knt_PlatnoscKaucji
	, Knt_KnPTyp
	, Knt_KnPNumer
	, Knt_KnPParam
	, Knt_FrsID
	, Knt_Controlling
	, Knt_RolnikRyczaltowy
	, Knt_Powiazany
	, Knt_DataUtworzenia
	, Knt_DokumentTozsamosci
	, Knt_DataWydania
	, Knt_OrganWydajacy
	,
	--
	Knt_KalendarzDst
	, Knt_KalendarzWys
	, Knt_Punkty
	, Knt_KnCTyp
	, Knt_KnCNumer
	, Knt_EFaVatAktywne
	, Knt_EFaVatOsw
	, Knt_EFaVatDataDo
	, Knt_EFaVatEMail
	, Knt_PodatnikiemNabywca
	, Knt_MSTwrGrupaNumer
	, Knt_StanPostep
	, Knt_ESklep
	--2017.1.0
	, Knt_BlokadaZam
	, Knt_BlokadaZamTS
	, Knt_OpZTyp
	, Knt_OpZFirma
	, Knt_OpZNumer
	, Knt_OpZLp
	, Knt_TypDokZS
	, Knt_TypDokZZ
	, Knt_PojedynczeDokDoZam
	, Knt_MaxTerminPlSpr
	, Knt_MaxTerminPlZak
	, Knt_DataOdLoj
	, Knt_DataDoLoj
	, Knt_KartaLoj
	, Knt_PunktyOdebr
	, Knt_PunktyNalicz
	, Knt_PunktyKorekta
	, Knt_SplitPayment
	--2019.1
	,knt_GUID
	,knt_GUIDdane
	--2023.2
	, Knt_KSeFWyslij
	, Knt_KSeFZrodlowy
	--2024.0
	, Knt_MetodaKasowa
	--2025.0
	, Knt_CharsetANSI
	)
VALUES (
	@pkntGIDTyp
	, @pkntGIDFirma
	,
	--@pkntGIDNumer,
	0
	,
	--@knaTyp, --Knt_KnATyp,
	--@knaFirma, --Knt_KnAFirma,
	--@knaNumer, --Knt_KnANumer,
	--0, --Knt_KnALp,
	@Typ
	, @Akwizytor
	, @Akronim	
	--@KnW_Akronim,
	, isnull(@AkronimFormat,'')
	, ''	
	--@KnW_FppKod,
	, isnull(@Nazwa1,'')
	, isnull(@Nazwa2,'')
	, isnull(@Nazwa3,'')
	, isnull(@KodP,'')
	, isnull(@Miasto,'')
	, isnull(@Ulica,'')
	, isnull(@Adres,'')
	, isnull(@NipPrefiks,'')
	, isnull(@NipE,'')
	, isnull(@Nip,'')
	,
	--REPLACE(@NipE,'-',''), --@KnW_Nip,
	isnull(@Regon,'')
	, isnull(@Pesel,'')
	, ''
	,
	--@KontoDostawcy,
	''
	,
	--@KontoOdbiorcy,
	isnull(@Telefon1, '')
	,
	--@KnW_Telefon1,
	isnull(@Telefon2, '')
	,
	--@KnW_Telefon2,
	isnull(@Fax, '')
	,
	--@KnW_Fax,
	isnull(@Modem, '')
	,
	--@KnW_Modem,
	isnull(@Telex, '')
	,
	--@KnW_Telex,
	isnull(@EMail, '')
	,
	--@KnW_EMail,
	isnull(@URL, '')
	,
	--@KnW_URL,
	isnull(@BnkTyp,0)
	, isnull(@BnkFirma,0)
	, isnull(@BnkNumer,0)
	, 0
	,
	--@KnW_BnkLp,
	''--isnull(@NrRachunku, '')
	,
	--@KnW_NrRachunku,
	@SoundExPl
	, @Rabat
	, 0
	,
	--@KnW_LimitWart,
	@MaxLimitWart
	, @LimitPoTerminie
	, @LimitOkres
	, @Dewizowe
	, @Symbol
	, 0
	,
	--@KnW_NrKursu,
	@Cena
	, @FormaPl
	, isnull(@Marza, 0)	
	--@KnW_Marza,
	, isnull(@TypKarty,0)
	, isnull(@NumerKarty, '')
	,
	--@KnW_NumerKarty,
	isnull(@DataKarty, 0)
	,
	--@KnW_DataKarty,
	isnull(@Ean, '')
	,
	--@KnW_Ean,
	isnull(@ObcaKarta, 0)
	,
	--@KnW_ObcaKarta,
	--@EanTyp,      --do obsługi
	--@EanFirma,
	--@EanNumer,
	0
	,
	--@KnW_Osoba,
	@ExpoKraj
	, @SeriaFa
	, @PlatnikVat
	, 2033
	,
	--typdok
	@Status
	, isnull(@FaVatData, 0)
	,
	--@KnW_FAVATData,
	@SposobDostawy
	,
	--@KnW_SposobDostawy,
	''
	,
	--@KnW_HasloChk,
	''
	,
	--@KnW_HasloKontrahent,
	isnull(@Dzialalnosc, 0)
	,
	--@KnW_Dzialalnosc,
	@ZtrTyp
	,
	--@KnW_ZTrTyp,         --do obslugi
	@ZtrFirma
	,
	--@KnW_ZTrFirma,
	@ZtrNumer
	,
	--@KnW_ZTrNumer,
	0
	,
	--@KnW_ZTrLp,
	@OpeTyp
	,
	--@knt_opetyp,
	@OpeFirma
	,
	--@knt_opefirma,
	@OpeNumer
	,
	--@knt_openumer,
	0
	,
	--@knt_opelp,
	@AkwTyp
	, @AkwFirma
	, @AkwNumer
	, 0
	, @KnW_Atrybut1
	, @KnW_Format1
	, @KnW_Wartosc1
	, @KnW_Atrybut2
	, @KnW_Format2
	, @KnW_Wartosc2
	, @KnW_Atrybut3
	, @KnW_Format3
	, @KnW_Wartosc3
	, @AkwProwizja
	, isnull(@Umowa, '')
	,
	--@KnW_Umowa,
	isnull(@DataW, 0)
	,
	--@KnW_DataW,
	datediff(s, '19900101', getdate())
	, datediff(s, '19900101', getdate())
	,
	--Knt_LastModO
	--datediff ( s , '19900101' , getdate()),       --Knt_LastModC
	isnull(@FaVatOsw, '')
	,
	--@KnW_FaVATOsw,
	@CechaOpis
	, 0
	,
	--@KnW_Aktywna,
	0
	,
	--@KnW_Wsk,                  --do obsłużenia???
	@PrcTyp
	, @PrcFirma
	, @PrcNumer
	, 0
	,
	--prc_gidlp
	@OutlookUrl
	, @KnW_Nieaktywny
	, @Zrodlo
	, @Branza
	, @Rodzaj
	, @RolaPartnera
	, @Kraj
	, isnull(@Odleglosc, 0)
	,
	--@KnW_Odleglosc,
	0--@KarTyp
	,0-- @KarFirma
	,0-- @KarNumer
	, 0
	,
	--@KnW_KarLp,
	isnull(@Powiat,'')
	,
	--@KnW_Powiat,
	isnull(@Gmina,'')
	,
	--@KnW_Gmina,
	isnull(@Wojewodztwo,'')
	,
	--@KnW_Wojewodztwo,
	0 --isnull(@NRB, 0)
	,
	--@KnW_NRB,
	@Archiwalny
	,
	--@KnW_Archiwalny,
	isnull(@AdresNieAktualny, 0)
	,
	--@KnW_AdresNieAktualny,
	isnull(@LastTransLockDate, 0)
	,
	--@KnW_LastTransLockDate,
	@OpeTyp
	,
	--@knt_opetyp,
	@OpeFirma
	,
	--@knt_opefirma,
	@OpeNumer
	,
	--@knt_openumer,
	0
	,
	--@knt_opelp,
	isnull(@BlokadaTransakcji, 0)
	,
	--@KnW_BlokadaTransakcji,
	isnull(@RegionCRM, 0)
	,
	--@KnW_RegionCRM,
	@Oddzialowy
	,
	--@KnW_Oddzialowy,
	isnull(@GLN + CAST(@CyfraKontrolnaGLN AS VARCHAR), '')
	,
	--Knt_GLN,
	@Spedytor
	,
	--Knt_Spedytor,
	0
	,
	--Knt_TerminPlKa,
	0
	,
	--Knt_FormaPlKa,
	@TerminPlZak
	,
	--Knt_TerminPlZak,
	@FormaPlZak
	,
	--Knt_FormaPlZak,
	@SpTerminPlSpr
	,
	--Knt_SpTerminPlSpr,
	0
	,
	--Knt_SpTerminPlRK,
	@SpTerminPlZak
	,
	--Knt_SpTerminPlZak,
	isnull(@LimitTerminowy, 0)
	,
	--Knt_LimitTerminowy,
	isnull(@DataWygasniecia, 0)
	,
	--Knt_DataWygasniecia,
	isnull(@MaxDniPoTerminie, 0)
	,
	--Knt_MaxDniPoTerminie
	isnull(@PIN, '')
	,
	--@KnW_PIN,
	isnull(@Priorytet, 0)
	,
	--@KnW_Priorytet
	@PriorytetRez
	, @TerminRozliczeniaKaucji
	, @PlatnoscKaucji
	, @KnPTyp
	, @KnPNumer
	, @KnPParam
	, isnull(@FrSID, 0)
	,
	--Knt_FrsID
	0
	,
	--Knt_Controlling
	isnull(@RolnikRyczaltowy,0)
	,
	--Knt_RolnikRyczaltowy
	@Powiazany
	,
	--Knt_Powiazany
	datediff(s, '19900101', getdate())
	,
	--Knt_DataUtworzenia
	isnull(@DokumentTozsamosci,'')
	,
	--Knt_DokumentTozsamosci
	isnull(@DataWydania,0)
	,
	--Knt_DataWydania
	isnull(@OrganWydajacy,'')
	,
	--Knt_OrganWydajacy
	--
	@KalendarzDst
	,
	--Knt_KalendarzDst,
	@KalendarzWys
	,
	--Knt_KalendarzWys,
	isnull(@Punkty, 0)
	,
	--Knt_Punkty
	0
	,
	--Knt_KnCTyp,
	0
	,
	--Knt_KnCNumer,
	0
	,
	--Knt_EFaVatAktywne,
	''
	,
	--Knt_EFaVatOsw,
	0
	,
	--Knt_EFaVatDataDo,
	''
	,
	--Knt_EFaVatEMail
	isnull(@PodatnikiemNabywca, 0)
	,
	--Knt_PodatnikiemNabywca
	isnull(@MSTwrGrupaNumer, 0)
	, isnull(@StanPostep, 0)
	, ISNULL(@ESKlep, 0)
	--2017.1.0
	, 0 --Knt_BlokadaZam
	, 0 -- Knt_BlokadaZamTS
	, 0 -- Knt_OpZTyp
	, 0 -- Knt_OpZFirma
	, 0 -- Knt_OpZNumer
	, 0 -- Knt_OpZLp
	, 0 -- Knt_TypDokZS
	, 0 -- Knt_TypDokZZ
	, 0 -- Knt_PojedynczeDokDoZam
	, 0 -- Knt_MaxTerminPlSpr
	, 0 -- Knt_MaxTerminPlZak
	, 0 -- Knt_DataOdLoj
	, 0 -- Knt_DataDoLoj
	, '' -- Knt_KartaLoj
	, 0 -- Knt_PunktyOdebr
	, 0 -- Knt_PunktyNalicz
	, 0 -- Knt_PunktyKorekta
	--2017.2.0
	, isnull(@SplitPayment, @KnW_SplitPayment)
	--2019.1
	, isnull(@GUID, NEWID())
	, isnull(@GUIDdane, NEWID())
	--2023.2
	, isnull(@KSeFWyslij, @KnW_KSeFWyslij)
	, isnull(@KSeFZrodlowy, @KnW_KSeFZrodlowy)
	--2024.0
	, ISNULL(@KntMetodaKasowa, 0)
	--2025.0
	, isnull(@CharsetANSI, 238)
	)

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd dodawania kontrahenta! - (33)'
			, 16
			, 1
			)

	RETURN @@error
END

SELECT @pkntGIDNumer = SCOPE_IDENTITY()

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd pobrania numeru kontrahenta - (45)'
			, 16
			, 1
			)

	RETURN @@error
END

-- Opis kontrahenta - tabela kntopisy
IF @Opis IS NOT NULL
	AND @Opis &lt;&gt; ''
	INSERT INTO cdn.kntopisy (
		kno_knttyp
		, kno_kntfirma
		, kno_kntnumer
		, kno_kntlp
		, kno_typ
		, kno_opis
		, KnO_CzasModyfikacji
		)
	VALUES (
		@pkntGIDTyp
		, @pkntGIDFirma
		, @pkntGIDNumer
		, 1
		, 0
		, @Opis
		, DATEDIFF(s, '19900101', GETDATE())
		)

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd dodawania opisu kontrahenta! - (34)'
			, 16
			, 1
			)

	RETURN @@error
END

-- EanGID
IF @Ean IS NOT NULL
BEGIN
	IF EXISTS (
			SELECT *
			FROM cdn.kntkarty
			WHERE Knt_Ean = @Ean
				AND Knt_ObcaKarta = @ObcaKarta
				AND Knt_GIDNumer &lt;&gt; @pkntGIDNumer
				AND Knt_Ean &lt;&gt; ''
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Istnieje już kontrahent o takim kodzie Ean i takiej karcie [%s] - (47)'
				, 16
				, 1
				, @Ean
				)

		RETURN 7
	END
			--Set @EanTyp = 0
			--Set @EanFirma = 0
			--Set @EanNumer = 0
END

-- KntGrupy
INSERT INTO cdn.kntgrupy (
	KnG_GIDTyp
	, KnG_GIDFirma
	, KnG_GIDNumer
	, KnG_GIDLp
	, KnG_GrOTyp
	, KnG_GrOFirma
	, KnG_GrONumer
	, KnG_GrOLp
	, KnG_Akronim
	, KnG_CzasModyfikacji
	, KnG_OpeNumer
	, KnG_CzasZalozenia
	)
VALUES (
	@pkntGIDTyp
	, @pkntGIDFirma
	, @pkntGIDNumer
	, 0
	, @knwGrpTyp
	, @knwGrpFirma
	, @knwGrpNumer
	, 0
	, @Akronim
	, DATEDIFF(s, CONVERT(DATETIME, '1990-01-01', 120), CONVERT(DATETIME, GETDATE(), 120))
	, ISNULL(@OpeNumer, 0)
	, DATEDIFF(s, '19900101', GETDATE())
	)

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd tworzenia kntgrupy! - (35)'
			, 16
			, 1
			)

	RETURN @@error
END

-- KntGrupyDom
INSERT INTO cdn.kntgrupydom (
	KGD_GIDTyp
	, KGD_GIDFirma
	, KGD_GIDNumer
	, KGD_GIDLp
	, KGD_GrOTyp
	, KGD_GrOFirma
	, KGD_GrONumer
	, KGD_GrOLp
	, KGD_Kod
	)
VALUES (
	@pkntGIDTyp
	, @pkntGIDFirma
	, @pkntGIDNumer
	, 0
	, @knwGrpTyp
	, @knwGrpFirma
	, @knwGrpNumer
	, 0
	, @Akronim
	)

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd tworzenia kntgrupydom! - (36)'
			, 16
			, 1
			)

	RETURN @@error
END

-- kntadresy
INSERT INTO cdn.kntadresy (
	KnA_GIDTyp
	, KnA_GIDFirma
	, KnA_GIDLp
	, KnA_KntTyp
	, KnA_KntFirma
	, KnA_KntNumer
	, KnA_KntLp
	, KnA_DataArc
	, KnA_Akronim
	, KnA_Wysylkowy
	, KnA_Nazwa1
	, KnA_Nazwa2
	, KnA_Nazwa3
	, KnA_KodP
	, KnA_Miasto
	, KnA_Ulica
	, KnA_Adres
	, KnA_NipPrefiks
	, KnA_NipE
	, KnA_Nip
	, KnA_Regon
	, KnA_Pesel
	, KnA_KontoDostawcy
	, KnA_KontoOdbiorcy
	, KnA_Kraj
	, KnA_Powiat
	, KnA_Gmina
	, KnA_Wojewodztwo
	, KnA_RegionCRM
	, KnA_GLN
	, KnA_Telefon1
	, KnA_Telefon2
	, KnA_Fax
	, KnA_Modem
	, KnA_Telex
	, KnA_EMail
	, KnA_BnkTyp
	, KnA_BnkFirma
	, KnA_BnkNumer
	, KnA_BnkLp
	, KnA_NrRachunku
	, KnA_LastModL
	, KnA_Odleglosc
	, KnA_NRB
	, KnA_NiePublikuj
	, KnA_Domyslny
	, KnA_DokumentTozsamosci
	, KnA_DataWydania
	, KnA_OrganWydajacy
	, KnA_RolnikRyczaltowy
	, KnA_StanPostep
	, KnA_PlatnikVat
	, KnA_GPSSz
	, KnA_GPSDl
	, KnA_GPSDataPobrania
	, KnA_GPSGodzinaPobrania
	, KnA_KnaPierwotny
	, KnA_KnaArchiwizowanego
	, KnA_Osoba
	, KnA_Opis
	, KnA_CharsetANSI
	)
VALUES (
	@knaTyp
	, @knaFirma
	, 0
	, @pkntGidTyp
	, @pkntGidFirma
	, @pkntGidNumer
	, 0
	, 0 --kna_dataarc
	, @Akronim
	, 0 --wysyłkowy
	, @Nazwa1
	, @Nazwa2
	, @Nazwa3
	, @KodP
	, @Miasto
	, @Ulica
	, @Adres
	, @NipPrefiks
	, @NipE
	, @Nip --REPLACE(@NipE,'-',''),    --nip bez kresek
	, @Regon
	, @Pesel
	, ''
	, ''
	, @Kraj
	, @Powiat
	, @Gmina
	, @Wojewodztwo
	, isnull(@RegionCRM, 0)
	, isnull(@GLN + CAST(@CyfraKontrolnaGLN AS VARCHAR), '')
	, isnull(@Telefon1, '')
	, isnull(@Telefon2, '')
	, isnull(@Fax, '')
	, isnull(@Modem, '')
	, isnull(@Telex, '')
	, isnull(@EMail, '')
	, @BnkTyp
	, @BnkFirma
	, @BnkNumer
	, 0
	,'' --, isnull(@NrRachunku, '')
	, 0 --data ostatniej modyfikacji - do sprawdzenia
	, 0 --odległość
	, 0 --, isnull(@NRB, 0)
	, 0 --nie publikuj
	, 0 --domyślny
	, '' --KnA_DokumentTozsamosci
	, 0 --KnA_DataWydania
	, '' --KnA_OrganWydajacy
	, 0 --KnA_RolnikRyczaltowy
	, isnull(@StanPostep, 0)
	, isnull(@PlatnikVat, 0)
	, 0 --KnA_GPSSz
	, 0 --KnA_GPSDl
	, 0 --KnA_GPSDataPobrania
	, 0 --KnA_GPSGodzinaPobrania
	, 0 --KnA_KnaPierwotny
	, 0 --KnA_KnaArchiwizowanego
	, 0 --KnA_Osoba
	, '' --KnA_Opis
	, isnull(@CharsetANSI, 238)
	)

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd tworzenia kntadresy! - (37)'
			, 16
			, 1
			)

	RETURN @@error
END

SELECT @knaNumer = SCOPE_IDENTITY()

UPDATE cdn.KntAdresy
SET KnA_KnaPierwotny = @knaNumer
WHERE KnA_GIDNumer = @knaNumer

-- aktualizajca karty kontrahenta (adres, płatnik)
IF @PlatnikIstnieje = 0
BEGIN
	SET @KnPTyp = @pkntGIDTyp
	SET @KnPNumer = @pkntGIDNumer
END

IF @KntGlownyIstnieje = 0
BEGIN
	SET @KnGTyp = @pkntGIDTyp
	SET @KnGNumer = @pkntGIDNumer
END

UPDATE cdn.kntkarty
SET Knt_KnATyp = 864
	, Knt_KnAFirma = @pkntGIDFirma
	, Knt_KnANumer = @knaNumer
	, Knt_KnALp = 0
	, Knt_KnPTyp = @KnPTyp
	, Knt_KnPNumer = @KnPNumer
	, Knt_KnGTyp = @KnGTyp
	, Knt_KnGNumer = @KnGNumer
WHERE knt_gidnumer = @pkntGIDNumer

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd aktualizacji adresu na karcie kontrahenta - (46)'
			, 16
			, 1
			)

	RETURN @@error
END

IF isnull(@NrRachunku, '') &lt;&gt; ''
BEGIN
	INSERT INTO CDN.RachunkiBankowe (
		RkB_ObiTyp,
		RkB_ObiFirma,
		RkB_ObiNumer,
		RkB_ObiLp,
		RkB_NrRachunku,
		RkB_NrRachunkuE,
		RkB_IBAN,
		RkB_BnkTyp,
		RkB_BnkFirma,
		RkB_BnkNumer,
		RkB_BnkLp,
		RkB_Waluta,
		RkB_OpeUtworzyl,
		RkB_CzasUtworzenia,
		RkB_KntAdres,
		RkB_TypRachunku,
		RkB_Uwagi,
		RkB_CzasArchiwizacji,
		RkB_Domyslny,
		RkB_CzasModyfikacji,
		RkB_OpeModyfikowal
		)
	VALUES (
		@pkntGIDTyp,
		@pkntGIDFirma,
		@pkntGIDNumer,
		0,
		@NrRachunku,
		@NrRachunku,
		@NRB,
		@BnkTyp,
		@BnkFirma,
		@BnkNumer,
		0,
		'',
		@OpeNumer,
		DATEDIFF(s, '19900101', GETDATE()),
		0,
		0,
		'',
		0,
		1,
		DATEDIFF(s, '19900101', GETDATE()),
		@OpeNumer
		)

	IF @@error &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd dodawania rachunku do tabeli RachunkiBankowe - (57)',
				16,
				1
				)

		RETURN @@error
	END
END

IF @KarTyp IS NOT NULL
	AND @KarFirma IS NOT NULL
	AND @KarNumer IS NOT NULL
BEGIN
	INSERT INTO CDN.KntRejestr (
		KRj_ObiTyp,
		KRj_ObiFirma,
		KRj_ObiNumer,
		KRj_ObiLp,
		KRj_TypRejestru,
		KRj_Waluta,
		KRj_PrzypiszDoPlatnosci,
		KRj_NrRachunku,
		KRj_KarNumer,
		KRj_Uwagi,
		KRj_CzasArchiwizacji
		)
	VALUES (
		@pkntGIDTyp,
		@pkntGIDFirma,
		@pkntGIDNumer,
		0,		
		0,
		isnull((
				SELECT TOP 1 Kar_Waluta
				FROM cdn.Rejestry
				WHERE kar_gidtyp = @KarTyp
					AND kar_gidnumer = @KarNumer
					AND isnull(Kar_waluta, '') &lt;&gt; ''
				), @WalutaSystemowa),
		0,
		'',
		@KarNumer,
		'',
		0
		)
	IF @@error &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd dodawania rejestru do tabeli KntRejestr - (58)',
				16,
				1
				)

		RETURN @@error
	END
END

-- dodanie opeikuna knt
IF @OpiekunCzas IS NOT NULL
BEGIN
	DECLARE @KtOKntLp INT

	SELECT @KtOKntLp = IsNull(MAX(KtO_KntLp), 0) + 1
	FROM CDN.KntOpiekun
	WHERE KtO_KntNumer = @pkntGIDNumer
		AND KtO_KntTyp = 32

	INSERT INTO CDN.KntOpiekun (
		KtO_KntNumer
		, KtO_KntTyp
		, KtO_KntLp
		, KtO_PrcNumer
		, KtO_DataDo
		, KtO_DataOd
		, KtO_Glowny
		, KtO_OpeTyp
		, KtO_OpeFirma
		, KtO_OpeNumer
		, KtO_OpeLp
		, KtO_OpeTypM
		, KtO_OpeFirmaM
		, KtO_OpeNumerM
		, KtO_OpeLpM
		, KtO_Uwagi
		, KtO_CzasPrzypisania
		, KtO_CzasModyfikacji
		)
	VALUES (
		@pkntGIDNumer
		, 32
		, @KtOKntLp
		, @OpiekunCzas
		, @OpiekunDataDo
		, @OpiekunDataOd
		, 0
		,
		--KtO_Glowny,
		@OpeTyp
		,
		--KtO_OpeTyp,
		@OpeFirma
		,
		--KtO_OpeFirma,
		@OpeNumer
		,
		--KtO_OpeNumer,
		0
		,
		--KtO_OpeLp,
		@OpeTyp
		,
		--KtO_OpeTypM,
		@OpeFirma
		,
		--KtO_OpeFirmaM,
		@OpeNumer
		,
		--KtO_OpeNumerM,
		0
		,
		--KtO_OpeLpM,
		''
		,
		--KtO_Uwagi,
		DATEDIFF(s, '19900101', GETDATE())
		,
		--KtO_CzasPrzypisania,
		DATEDIFF(s, '19900101', GETDATE()) --KtO_CzasModyfikacji
		)

	IF @@error &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd dodawania opiekuna do tabeli KntOpiekun - (47)'
				, 16
				, 1
				)

		RETURN @@error
	END
END

-- dodanie rejonu knt
IF @RegionCRM IS NOT NULL
	AND @RegionCRM &lt;&gt; 0
BEGIN
	INSERT INTO CDN.KntRejony (
		KnR_KntNumer
		, KnR_KntTyp
		, KnR_Rejon
		, KnR_CzasPrzypisania
		)
	VALUES (
		@pkntGIDNumer
		, 32
		, @RegionCRM
		, DATEDIFF(s, CONVERT(DATETIME, '1990-01-01', 120), CONVERT(DATETIME, GETDATE(), 120))
		)

	IF @@error &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd dodawania rejonu do tabeli KntRejony - (49)'
				, 16
				, 1
				)

		RETURN @@error
	END
END

--przepisanie rejonów z kodu pocztowego
IF @KodP IS NOT NULL
	AND @KodP &lt;&gt; '00000'
	AND @KodP &lt;&gt; '00-000'
BEGIN
	INSERT INTO CDN.KntRejony (
		KnR_KntNumer
		, KnR_KntTyp
		, KnR_Rejon
		, KnR_CzasPrzypisania
		)
	SELECT @pkntGIDNumer
		, 32
		, REJ.Rejon
		, REJ.Data
	FROM (
		SELECT KKR_Rejon AS Rejon
			, DATEDIFF(s, CONVERT(DATETIME, '1990-01-01', 120), CONVERT(DATETIME, GETDATE(), 120)) AS Data
		FROM CDN.KntKody
		INNER JOIN CDN.KnPRejony
			ON KnP_Id = KKR_KnPId
		WHERE KnP_KodP = @KodP
			AND KnP_Miasto = @Miasto
			AND KnP_Kraj = @Kraj
			AND NOT EXISTS (
				SELECT *
				FROM CDN.KntRejony KR
				WHERE KR.KnR_KntNumer = @pkntGIDNumer
					AND KR.KnR_Rejon = KKR_Rejon
				)
		) AS REJ

	IF @@error &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd przy przepisywaniu rejonów z kodu pocztowego - (50)'
				, 16
				, 1
				)

		RETURN @@error
	END
END

-- Knt_KontoDostawcy
SET @ZalozKonto = 0

IF @KontoDostawcy IS NULL
BEGIN
	IF @Typ IN (8, 24)
	BEGIN
		--propozycja konta dostawcy
		SELECT @KontoDostawcy = Konto
			, @SyntetykaDost = Syntetyka
			, @ZalozKonto = ZalozKonto
			, @TylkoKntKonta = TylkoKntKonta
		FROM cdn.ProponujKontoKnt(@pkntGIDNumer, @Akronim, @NipE, @FormaPlZak, 8, 2)

		--założenie konta
		IF (
				@ZalozKonto = 1
				OR @TylkoKntKonta = 1
				)
			AND @KontoDostawcy &lt;&gt; ''
			AND @KontoDostawcy IS NOT NULL
		BEGIN
			SET @NazwaKonta = @Nazwa1 + ' ' + @Nazwa2 + ' ' + @Nazwa3

			EXECUTE CDN.ZalozKontoKnt @KontoDostawcy
				, @Akronim
				, @Miasto
				, @NazwaKonta
				, @pkntGIDTyp
				, @pkntGIDFirma
				, @pkntGIDNumer
				, 2
				, @TylkoKntKonta
				, @err OUTPUT

			IF @err &lt;&gt; 0
			BEGIN
				ROLLBACK TRANSACTION

				RAISERROR (
						'Błąd zakładania konta dostawcy - (38)'
						, 16
						, 1
						)

				RETURN @err
			END
		END
	END
	ELSE
		SET @KontoDostawcy = '' --@KnW_KontoDostawcy
END
ELSE --jeśli podano na wejście konto to sprawdzamy czy to konto istnieje
BEGIN
	IF NOT EXISTS (
			SELECT KKS_konto
			FROM cdn.konta
			WHERE kks_konto = @KontoDostawcy
				AND kks_okresID = @OkresID
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Podane konto %s nie istnieje - (9)'
				, 16
				, 1
				, @KontoDostawcy
				)

		RETURN 9
	END
END

-- Knt_KontoOdbiorcy
SET @ZalozKonto = 0

IF @KontoOdbiorcy IS NULL
BEGIN
	IF @Typ IN (16, 24)
	BEGIN
		--propozycja konta odbiorcy
		SELECT @KontoOdbiorcy = Konto
			, @SyntetykaOdb = Syntetyka
			, @ZalozKonto = ZalozKonto
			, @TylkoKntKonta = TylkoKntKonta
		FROM cdn.ProponujKontoKnt(@pkntGIDNumer, @Akronim, @NipE, @FormaPl, 16, 1)

		IF (
				@ZalozKonto = 1
				OR @TylkoKntKonta = 1
				)
			AND @KontoOdbiorcy &lt;&gt; ''
			AND @KontoOdbiorcy IS NOT NULL
		BEGIN
			SET @NazwaKonta = @Nazwa1 + ' ' + @Nazwa2 + ' ' + @Nazwa3

			EXECUTE CDN.ZalozKontoKnt @KontoOdbiorcy
				, @Akronim
				, @Miasto
				, @NazwaKonta
				, @pkntGIDTyp
				, @pkntGIDFirma
				, @pkntGIDNumer
				, 1
				, @TylkoKntKonta
				, @err OUTPUT

			IF @err &lt;&gt; 0
			BEGIN
				ROLLBACK TRANSACTION

				RAISERROR (
						'Błąd zakładania konta odbiorcy - (39)'
						, 16
						, 1
						)

				RETURN @err
			END
		END
	END
	ELSE
		SET @KontoOdbiorcy = '' --@KnW_KontoOdbiorcy
END
ELSE --jeśli podano na wejście konto to sprawdzamy czy to konto istnieje
BEGIN
	IF NOT EXISTS (
			SELECT KKS_Konto
			FROM cdn.konta
			WHERE kks_konto = @KontoOdbiorcy
				AND kks_OkresID = @OkresID
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Podane konto %s nie istnieje - (10)'
				, 16
				, 1
				, @KontoOdbiorcy
				)

		RETURN 10
	END
END

--zakładanie pozostałych kont
DECLARE SymboleKontCursor CURSOR
FOR
SELECT kkt_smkid
FROM cdn.kntkonta
WHERE kkt_knttyp = @knwGrpTyp
	AND kkt_kntnumer = @knwGrpNumer
	AND kkt_zalozkonto = 1

--ustalenie nazwy konta
SET @NazwaKonta = @Nazwa1 + ' ' + @Nazwa2 + ' ' + @Nazwa3

OPEN SymboleKontCursor

FETCH NEXT
FROM SymboleKontCursor
INTO @SmkID

WHILE @@FETCH_STATUS = 0
BEGIN
	SELECT @Konto = Konto
	FROM CDN.ProponujKontoKnt(@pkntGIDNumer, @Akronim, @NipE, 0, 0, @SmkID)

	EXECUTE CDN.ZalozKontoKnt @Konto
		, @Akronim
		, @Miasto
		, @NazwaKonta
		, @pkntGIDTyp
		, @pkntGIDFirma
		, @pkntGIDNumer
		, @SmkID
		, 0
		, @err OUTPUT

	FETCH NEXT
	FROM SymboleKontCursor
	INTO @SmkID
END

CLOSE SymboleKontCursor

DEALLOCATE SymboleKontCursor

--Koncesje -- begin
IF @Koncesja &gt; 0
BEGIN
	INSERT INTO CDN.KntKoncesje (
		KKo_KntTyp
		, KKo_KntNumer
		, KKo_Koncesja
		, KKo_WaznaDo
		, KKo_CzasUtworzenia
		, KKo_OpeUtworzyl
		, KKo_CzasModyfikacji
		, KKo_OpeModyfikowal
		)
	VALUES (
		@pkntGIDTyp --  &lt;KKo_KntTyp,smallint&gt;
		, @pkntGIDNumer --  &lt;KKo_KntNumer, int,&gt;
		, @Koncesja --  &lt;KKo_Koncesja, int,&gt;
		, IsNull(@DataKoncesji, DATEDIFF(d, '18001228', GETDATE()) + 365) --  &lt;KKo_WaznaDo, int,&gt;
		, DATEDIFF(s, '19900101', GETDATE()) --  &lt;KKo_CzasUtworzenia, int,&gt;
		, @OpeNumer --  &lt;KKo_OpeUtworzyl, int,&gt;
		, DATEDIFF(s, '19900101', GETDATE()) --  &lt;KKo_CzasModyfikacji, int,&gt;
		, @OpeNumer
		) --  &lt;KKo_OpeModyfikowal, int,&gt;   

	IF @@error &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd dodania koncesji! - (51)'
				, 16
				, 1
				)

		RETURN 51
	END
END
ELSE IF @Koncesja = - 1
BEGIN
	INSERT INTO CDN.KntKoncesje (
		KKo_KntTyp
		, KKo_KntNumer
		, KKo_Koncesja
		, KKo_WaznaDo
		, KKo_CzasUtworzenia
		, KKo_OpeUtworzyl
		, KKo_CzasModyfikacji
		, KKo_OpeModyfikowal
		)
	SELECT @pkntGIDTyp
		, @pkntGIDNumer
		, KKo_Koncesja
		, KKo_WaznaDo
		, DATEDIFF(s, '19900101', GETDATE())
		, @OpeNumer
		, DATEDIFF(s, '19900101', GETDATE())
		, @OpeNumer
	FROM CDN.KntKoncesje K1
	WHERE KKo_KntNumer = @knwGrpNumer
		AND KKo_KntTyp = @knwGrpTyp
END

--Koncesje -- end
--Magazyny -- begin
INSERT INTO CDN.KntMagazyny (
	KnM_KntTyp
	, KnM_KntNumer
	, KnM_MagNumer
	, KnM_PulpitKnt
	, KnM_MobSpr
	)
SELECT @pkntGIDTyp
	, @pkntGIDNumer
	, KnM_MagNumer
	, KnM_PulpitKnt
	, KnM_MobSpr
FROM CDN.KntMagazyny K1
WHERE KnM_KntNumer = @knwGrpNumer
	AND KnM_KntTyp = @knwGrpTyp
	AND NOT EXISTS (
		SELECT *
		FROM CDN.KntMagazyny K2
		WHERE KnM_KntNumer = @pkntGIDNumer
			AND KnM_KntTyp = @pkntGIDTyp
		)

--Magazyny -- end
-- KAp_MagGID
IF @MagTyp IS NOT NULL
	AND @MagFirma IS NOT NULL
	AND @MagNumer IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.KntMagazyny
			WHERE KnM_KntTyp = @pkntGIDTyp
				AND KnM_KntNumer = @pkntGIDNumer
				AND KnM_MagNumer = @MagNumer
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono magazynu [%d] - (23)'
				, 16
				, 1
				, @MagNumer
				)

		RETURN 23
	END
END

-- KAp_MagMSGID
IF @MagMSTyp IS NOT NULL
	AND @MagMSFirma IS NOT NULL
	AND @MagMSNumer IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.KntMagazyny
			WHERE KnM_KntTyp = @pkntGIDTyp
				AND KnM_KntNumer = @pkntGIDNumer
				AND KnM_MagNumer = @MagMSNumer
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie znaleziono magazynu [%d] - (56)'
				, 16
				, 1
				, @MagMSNumer
				)

		RETURN 56
	END
END

--Aplikacje -- begin
IF (
		@OpeNumerW IS NULL
		OR @OpeNumerW = 0
		) -- TS Bug #106500 and (@AutoPotwierdzenie is not null or @MagTyp is not null or @MagNumer is not null or @TwrGrupaNumer is not null or @SeriaKaP is not null or @PrefiksObcy is not null)
BEGIN
	SET @OpeNumerW = @KAp_OpeNumer
		--SET @OpeHaslo = @KAp_OpeHaslo	hasło zawsze ze wzorca bo nie może być szyfrowane jawnie
END

SET @OpeHaslo = @KAp_OpeHaslo

IF @OpeNumerW IS NOT NULL
	AND @OpeNumerW &gt; 0
BEGIN
	INSERT INTO [CDN].[KntAplikacje] (
		[KAp_KntTyp]
		, [KAp_KntNumer]
		, [KAp_OpeNumer]
		, [KAp_OpeHaslo]
		, [KAp_OpeONumer]
		, [KAp_MagTyp]
		, [KAp_MagFirma]
		, [KAp_MagNumer]
		, [KAp_MagLp]
		, [KAp_Seria]
		, [KAp_TwrGrupaNumer]
		, [KAp_CzyPotwierdzone]
		, [KAp_PrefiksObcy]
		, [KAp_MagMSTyp]
		, [KAp_MagMSFirma]
		, [KAp_MagMSNumer]
		, [KAp_MagMSLp]
		)
	VALUES (
		@pkntGIDTyp --KAp_KntTyp
		, @pkntGIDNumer --KAp_KntNumer
		, @OpeNumerW --KAp_OpeNumer
		, IsNull(@OpeHaslo, '') --KAp_OpeHaslo
		, IsNull(@OpeNumerO, @KAp_OpeONumer) --KAp_OpeONumer
		, IsNUll(@MagTyp, @KAp_MagTyp) --KAp_MagTyp
		, IsNUll(@MagFirma, @KAp_MagFirma) --KAp_MagFirma
		, IsNUll(@MagNumer, @KAp_MagNumer) --KAp_MagNumer
		, 0 --KAp_MagLp
		, IsNUll(@SeriaKAp, @KAp_Seria) --KAp_Seria
		, IsNUll(@TwrGrupaNumer, @KAp_TwrGrupaNumer) --KAp_TwrGrupaNumer
		, IsNUll(@AutoPotwierdzenie, @KAp_CzyPotwierdzone) --KAp_CzyPotwierdzone
		, ISNULL(@PrefiksObcy, @KAp_PrefiksObcy) --KAp_PrefiksObcy
		, IsNull(@MagMSTyp, @KAp_MagMSTyp) --KAp_MagMSTyp
		, IsNull(@MagMSFirma, @KAp_MagMSFirma) --KAp_MagMSFirma
		, IsNull(@MagMSNumer, @KAp_MagMSNumer) --KAp_MagMSNumer
		, 0 --KAp_MagMSLp
		)

	IF @@error = 0
	BEGIN
		IF @TwrGrupaNumer IS NULL
			INSERT INTO [CDN].[KntAplikacjeObiekty] (
				[KOb_KntNumer]
				, [KOb_KntTyp]
				, [KOb_ObiTyp]
				, [KOb_ObiFirma]
				, [KOb_ObiNumer]
				, [KOb_ObiLp]
				)
			SELECT @pkntGIDNumer
				, @pkntGIDTyp
				, [KOb_ObiTyp]
				, [KOb_ObiFirma]
				, [KOb_ObiNumer]
				, [KOb_ObiLp]
			FROM CDN.[KntAplikacjeObiekty]
			WHERE [KOb_KntTyp] = @knwGrpTyp
				AND [KOb_KntNumer] = @knwGrpNumer
		ELSE
		BEGIN
			IF NOT EXISTS (
					SELECT *
					FROM cdn.KntAplikacjeObiekty
					WHERE KOb_KntTyp = @pkntGIDTyp
						AND KOb_KntNumer = @pkntGIDNumer
						AND KOb_ObiNumer = @TwrGrupaNumer
						AND KOb_ObiTyp = - 16
					)
				INSERT INTO [CDN].[KntAplikacjeObiekty] (
					[KOb_KntNumer]
					, [KOb_KntTyp]
					, [KOb_ObiTyp]
					, [KOb_ObiFirma]
					, [KOb_ObiNumer]
					, [KOb_ObiLp]
					)
				VALUES (
					@pkntGIDNumer
					, @pkntGIDTyp
					, - 16
					, @pkntGIDFirma
					, @TwrGrupaNumer
					, 0
					)
		END
	END
END

--Aplikacje -- end
--Limity kredytowe - przepisanie ze wzorca
INSERT INTO CDN.KntLimityK (
	KLK_KntTyp
	, KLK_KntNumer
	, KLK_CzasModyfikacji
	, KLK_CzasUtworzenia
	, KLK_DataDo
	, KLK_DataOd
	, KLK_KursL
	, KLK_KursM
	, KLK_LimitPoTerminie
	, KLK_MaxLimitWart
	, KLK_NrKursu
	, KLK_OpeModyfikowal
	, KLK_OpeUtworzyl
	, KLK_PrzeliczajWg
	, KLK_Waluta
	)
SELECT @pkntGIDTyp
	, @pkntGIDNumer
	, DATEDIFF(s, '19900101', GETDATE())
	, DATEDIFF(s, '19900101', GETDATE())
	, KLK_DataDo
	, KLK_DataOd
	, KLK_KursL
	, KLK_KursM
	, KLK_LimitPoTerminie
	, KLK_MaxLimitWart
	, KLK_NrKursu
	, @OpeNumer
	, @OpeNumer
	, KLK_PrzeliczajWg
	, KLK_Waluta
FROM CDN.KntLimityK K1
WHERE KLK_KntNumer = @knwGrpNumer
	AND KLK_KntTyp = @knwGrpTyp

--Limity kredytowe -- end
--
COMMIT TRANSACTION

SELECT GIDTyp = @pkntGIDTyp
	, GIDFirma = @pkntGIDFirma
	, GIDNumer = @pkntGIDNumer

SET NOCOUNT OFF

RETURN 0
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="Przyznanie praw do procedury KntNowy"></A><PRE>
          <FONT SIZE="2"><I>/* Przyznanie praw do procedury KntNowy */</I><BR>
GRANT EXECUTE
	ON CDN.KntNowy
	TO CDNRaport
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>