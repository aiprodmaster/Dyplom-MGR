<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="KsiUmlHarmonogramSplat"></A><PRE>
          <FONT SIZE="2"><I>/* KsiUmlHarmonogramSplat */</I><BR>
CREATE PROCEDURE cdn.KsiUmlHarmonogramSplat (@Rok smallint, @Waluta varchar(3), @bWalutaSys tinyint, @Kurs decimal(15,10), @bUwzglRK tinyint ) as
begin
set nocount on


declare @data1 int
set @data1 = datediff(day,convert(datetime,'18001228',120),cdn.YMD(@Rok,1,1))
declare @data2 int
set @data2= datediff(day,convert(datetime,'18001228',120),cdn.YMD(@Rok,12,31))


declare @WalutaSys varchar(3)
SELECT @WalutaSys = KON_Wartosc FROM CDN.Konfig with(nolock) WHERE KON_Numer = 211


if @bWalutaSys = 0 or @Waluta = @WalutaSys or @Waluta = '2' --wszystko w sys
begin
	set @Kurs = 1.0
	
	if @bWalutaSys = 0 or @Waluta = @WalutaSys
		set @bUwzglRK = 0
end


select NrUmAkr, PdmFin, opisNetto,opisKapital,opisOdsetki,opisPlanVatOdl,opisPlanVatBez,opisVatOdl,opisVatBez,
/*
n1,k1,o1,vo1,vb1,
n2,k2,o2,vo2,vb2,
n3,k3,o3,vo3,vb3,
n4,k4,o4,vo4,vb4,
n5,k5,o5,vo5,vb5,
n6,k6,o6,vo6,vb6,
n7,k7,o7,vo7,vb7,
n8,k8,o8,vo8,vb8,
n9,k9,o9,vo9,vb9,
n10,k10,o10,vo10,vb10,
n11,k11,o11,vo11,vb11,
n12,k12,o12,vo12,vb12,
n1+n2+n3+n4+n5+n6+n7+n8+n9+n10+n11+n12 sn,
k1+k2+k3+k4+k5+k6+k7+k8+k9+k10+k11+k12 sk,
o1+o2+o3+o4+o5+o6+o7+o8+o9+o10+o11+o12 so,
vo1+vo2+vo3+vo4+vo5+vo6+vo7+vo8+vo9+vo10+vo11+vo12 svo,
vb1+vb2+vb3+vb4+vb5+vb6+vb7+vb8+vb9+vb10+vb11+vb12 svb,
*/

sum(n1) + case when @bUwzglRK=1 then SUM(rkU1)-SUM(rkD1) else 0 end n1,sum(k1) + case when @bUwzglRK=1 then SUM(rkU1)-SUM(rkD1) else 0 end k1,sum(o1) o1,sum(vpo1) vpo1,sum(vpb1) vpb1,sum(vo1) vo1,sum(vb1) vb1,
sum(n2) + case when @bUwzglRK=1 then SUM(rkU2)-SUM(rkD2) else 0 end n2,sum(k2) + case when @bUwzglRK=1 then SUM(rkU2)-SUM(rkD2) else 0 end k2,sum(o2) o2,sum(vpo2) vpo2,sum(vpb2) vpb2,sum(vo2) vo2,sum(vb2) vb2,
sum(n3) + case when @bUwzglRK=1 then SUM(rkU3)-SUM(rkD3) else 0 end n3,sum(k3) + case when @bUwzglRK=1 then SUM(rkU3)-SUM(rkD3) else 0 end k3,sum(o3) o3,sum(vpo3) vpo3,sum(vpb3) vpb3,sum(vo3) vo3,sum(vb3) vb3,
sum(n4) + case when @bUwzglRK=1 then SUM(rkU4)-SUM(rkD4) else 0 end n4,sum(k4) + case when @bUwzglRK=1 then SUM(rkU4)-SUM(rkD4) else 0 end k4,sum(o4) o4,sum(vpo4) vpo4,sum(vpb4) vpb4,sum(vo4) vo4,sum(vb4) vb4,
sum(n5) + case when @bUwzglRK=1 then SUM(rkU5)-SUM(rkD5) else 0 end n5,sum(k5) + case when @bUwzglRK=1 then SUM(rkU5)-SUM(rkD5) else 0 end k5,sum(o5) o5,sum(vpo5) vpo5,sum(vpb5) vpb5,sum(vo5) vo5,sum(vb5) vb5,
sum(n6) + case when @bUwzglRK=1 then SUM(rkU6)-SUM(rkD6) else 0 end n6,sum(k6) + case when @bUwzglRK=1 then SUM(rkU6)-SUM(rkD6) else 0 end k6,sum(o6) o6,sum(vpo6) vpo6,sum(vpb6) vpb6,sum(vo6) vo6,sum(vb6) vb6,
sum(n7) + case when @bUwzglRK=1 then SUM(rkU7)-SUM(rkD7) else 0 end n7,sum(k7) + case when @bUwzglRK=1 then SUM(rkU7)-SUM(rkD7) else 0 end k7,sum(o7) o7,sum(vpo7) vpo7,sum(vpb7) vpb7,sum(vo7) vo7,sum(vb7) vb7,
sum(n8) + case when @bUwzglRK=1 then SUM(rkU8)-SUM(rkD8) else 0 end n8,sum(k8) + case when @bUwzglRK=1 then SUM(rkU8)-SUM(rkD8) else 0 end k8,sum(o8) o8,sum(vpo8) vpo8,sum(vpb8) vpb8,sum(vo8) vo8,sum(vb8) vb8,
sum(n9) + case when @bUwzglRK=1 then SUM(rkU9)-SUM(rkD9) else 0 end n9,sum(k9) + case when @bUwzglRK=1 then SUM(rkU9)-SUM(rkD9) else 0 end k9,sum(o9) o9,sum(vpo9) vpo9,sum(vpb9) vpb9,sum(vo9) vo9,sum(vb9) vb9,
sum(n10) + case when @bUwzglRK=1 then SUM(rkU10)-SUM(rkD10) else 0 end n10,sum(k10) + case when @bUwzglRK=1 then SUM(rkU10)-SUM(rkD10) else 0 end k10,sum(o10) o10,sum(vpo10) vpo10,sum(vpb10) vpb10,sum(vo10) vo10,sum(vb10) vb10,
sum(n11) + case when @bUwzglRK=1 then SUM(rkU11)-SUM(rkD11) else 0 end n11,sum(k11) + case when @bUwzglRK=1 then SUM(rkU11)-SUM(rkD11) else 0 end k11,sum(o11) o11,sum(vpo11) vpo11,sum(vpb11) vpb11,sum(vo11) vo11,sum(vb11) vb11,
sum(n12) + case when @bUwzglRK=1 then SUM(rkU12)-SUM(rkD12) else 0 end n12,sum(k12) + case when @bUwzglRK=1 then SUM(rkU12)-SUM(rkD12) else 0 end k12,sum(o12) o12,sum(vpo12) vpo12,sum(vpb12) vpb12,sum(vo12) vo12,sum(vb12) vb12,
sum(n1)+sum(n2)+sum(n3)+sum(n4)+sum(n5)+sum(n6)+sum(n7)+sum(n8)+sum(n9)+sum(n10)+sum(n11)+sum(n12) + case when @bUwzglRK=1 then SUM(rkU1)+SUM(rkU2)+SUM(rkU3)+SUM(rkU4)+SUM(rkU5)+SUM(rkU6)+SUM(rkU7)+SUM(rkU8)+SUM(rkU9)+SUM(rkU10)+SUM(rkU11)+SUM(rkU12)-SUM(rkD1)-SUM(rkD2)-SUM(rkD3)-SUM(rkD4)-SUM(rkD5)-SUM(rkD6)-SUM(rkD7)-SUM(rkD8)-SUM(rkD9)-SUM(rkD10)-SUM(rkD11)-SUM(rkD12) else 0 end sn,
sum(k1)+sum(k2)+sum(k3)+sum(k4)+sum(k5)+sum(k6)+sum(k7)+sum(k8)+sum(k9)+sum(k10)+sum(k11)+sum(k12) + case when @bUwzglRK=1 then SUM(rkU1)+SUM(rkU2)+SUM(rkU3)+SUM(rkU4)+SUM(rkU5)+SUM(rkU6)+SUM(rkU7)+SUM(rkU8)+SUM(rkU9)+SUM(rkU10)+SUM(rkU11)+SUM(rkU12)-SUM(rkD1)-SUM(rkD2)-SUM(rkD3)-SUM(rkD4)-SUM(rkD5)-SUM(rkD6)-SUM(rkD7)-SUM(rkD8)-SUM(rkD9)-SUM(rkD10)-SUM(rkD11)-SUM(rkD12) else 0 end sk,
sum(o1)+sum(o2)+sum(o3)+sum(o4)+sum(o5)+sum(o6)+sum(o7)+sum(o8)+sum(o9)+sum(o10)+sum(o11)+sum(o12) so,
sum(vpo1)+sum(vpo2)+sum(vpo3)+sum(vpo4)+sum(vpo5)+sum(vpo6)+sum(vpo7)+sum(vpo8)+sum(vpo9)+sum(vpo10)+sum(vpo11)+sum(vpo12) svpo,
sum(vpb1)+sum(vpb2)+sum(vpb3)+sum(vpb4)+sum(vpb5)+sum(vpb6)+sum(vpb7)+sum(vpb8)+sum(vpb9)+sum(vpb10)+sum(vpb11)+sum(vpb12) svpb,
sum(vo1)+sum(vo2)+sum(vo3)+sum(vo4)+sum(vo5)+sum(vo6)+sum(vo7)+sum(vo8)+sum(vo9)+sum(vo10)+sum(vo11)+sum(vo12) svo,
sum(vb1)+sum(vb2)+sum(vb3)+sum(vb4)+sum(vb5)+sum(vb6)+sum(vb7)+sum(vb8)+sum(vb9)+sum(vb10)+sum(vb11)+sum(vb12) svb,

ULR_ULNID,
ULR_ULPLp,
max(GIDTyp) GIDTyp
from (
select distinct
case when ULR_ULPLp = 0 then NumerDokumentu else Srt_Akronim end NrUmAkr, PdmFin, opisNetto,opisKapital,opisOdsetki,opisPlanVatOdl,opisPlanVatBez,opisVatOdl,opisVatBez,

case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then nSys1 else n1*@Kurs end as n1,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then kSys1 else k1*@Kurs end as k1,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then oSys1 else o1*@Kurs end as o1,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpo1) OVER(Partition by ULR_ID) 
else
	sum(vpo1) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpo1,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpb1) OVER(Partition by ULR_ID) 
else
	sum(vpb1) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpb1,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vo1) OVER(Partition by ULR_ID) 
else
	sum(vo1) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vo1,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vb1) OVER(Partition by ULR_ID) 
else
	sum(vb1) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vb1,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkD1) OVER(Partition by ULR_ID) 
else
	sum(rkD1) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkD1,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkU1) OVER(Partition by ULR_ID) 
else
	sum(rkU1) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkU1,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then nSys2 else n2*@Kurs end as n2,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then kSys2 else k2*@Kurs end as k2,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then oSys2 else o2*@Kurs end as o2,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpo2) OVER(Partition by ULR_ID) 
else
	sum(vpo2) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpo2,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpb2) OVER(Partition by ULR_ID) 
else
	sum(vpb2) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpb2,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vo2) OVER(Partition by ULR_ID) 
else
	sum(vo2) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vo2,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vb2) OVER(Partition by ULR_ID) 
else
	sum(vb2) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vb2,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkD2) OVER(Partition by ULR_ID) 
else
	sum(rkD2) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkD2,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkU2) OVER(Partition by ULR_ID) 
else
	sum(rkU2) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkU2,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then nSys3 else n3*@Kurs end as n3,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then kSys3 else k3*@Kurs end as k3,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then oSys3 else o3*@Kurs end as o3,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpo3) OVER(Partition by ULR_ID) 
else
	sum(vpo3) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpo3,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpb3) OVER(Partition by ULR_ID) 
else
	sum(vpb3) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpb3,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vo3) OVER(Partition by ULR_ID) 
else
	sum(vo3) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vo3,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vb3) OVER(Partition by ULR_ID) 
else
	sum(vb3) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vb3,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkD3) OVER(Partition by ULR_ID) 
else
	sum(rkD3) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkD3,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkU3) OVER(Partition by ULR_ID) 
else
	sum(rkU3) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkU3,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then nSys4 else n4*@Kurs end as n4,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then kSys4 else k4*@Kurs end as k4,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then oSys4 else o4*@Kurs end as o4,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpo4) OVER(Partition by ULR_ID) 
else
	sum(vpo4) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpo4,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpb4) OVER(Partition by ULR_ID) 
else
	sum(vpb4) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpb4,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vo4) OVER(Partition by ULR_ID) 
else
	sum(vo4) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vo4,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vb4) OVER(Partition by ULR_ID) 
else
	sum(vb4) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vb4,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkD4) OVER(Partition by ULR_ID) 
else
	sum(rkD4) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkD4,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkU4) OVER(Partition by ULR_ID) 
else
	sum(rkU4) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkU4,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then nSys5 else n5*@Kurs end as n5,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then kSys5 else k5*@Kurs end as k5,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then oSys5 else o5*@Kurs end as o5,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpo5) OVER(Partition by ULR_ID) 
else
	sum(vpo5) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpo5,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpb5) OVER(Partition by ULR_ID) 
else
	sum(vpb5) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpb5,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vo5) OVER(Partition by ULR_ID) 
else
	sum(vo5) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vo5,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vb5) OVER(Partition by ULR_ID) 
else
	sum(vb5) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vb5,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkD5) OVER(Partition by ULR_ID) 
else
	sum(rkD5) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkD5,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkU5) OVER(Partition by ULR_ID) 
else
	sum(rkU5) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkU5,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then nSys6 else n6*@Kurs end as n6,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then kSys6 else k6*@Kurs end as k6,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then oSys6 else o6*@Kurs end as o6,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpo6) OVER(Partition by ULR_ID) 
else
	sum(vpo6) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpo6,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpb6) OVER(Partition by ULR_ID) 
else
	sum(vpb6) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpb6,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vo6) OVER(Partition by ULR_ID) 
else
	sum(vo6) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vo6,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vb6) OVER(Partition by ULR_ID) 
else
	sum(vb6) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vb6,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkD6) OVER(Partition by ULR_ID) 
else
	sum(rkD6) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkD6,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkU6) OVER(Partition by ULR_ID) 
else
	sum(rkU6) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkU6,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then nSys7 else n7*@Kurs end as n7,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then kSys7 else k7*@Kurs end as k7,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then oSys7 else o7*@Kurs end as o7,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpo7) OVER(Partition by ULR_ID) 
else
	sum(vpo7) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpo7,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpb7) OVER(Partition by ULR_ID) 
else
	sum(vpb7) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpb7,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vo7) OVER(Partition by ULR_ID) 
else
	sum(vo7) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vo7,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vb7) OVER(Partition by ULR_ID) 
else
	sum(vb7) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vb7,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkD7) OVER(Partition by ULR_ID) 
else
	sum(rkD7) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkD7,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkU7) OVER(Partition by ULR_ID) 
else
	sum(rkU7) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkU7,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then nSys8 else n8*@Kurs end as n8,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then kSys8 else k8*@Kurs end as k8,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then oSys8 else o8*@Kurs end as o8,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpo8) OVER(Partition by ULR_ID) 
else
	sum(vpo8) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpo8,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpb8) OVER(Partition by ULR_ID) 
else
	sum(vpb8) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpb8,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vo8) OVER(Partition by ULR_ID) 
else
	sum(vo8) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vo8,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vb8) OVER(Partition by ULR_ID) 
else
	sum(vb8) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vb8,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkD8) OVER(Partition by ULR_ID) 
else
	sum(rkD8) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkD8,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkU8) OVER(Partition by ULR_ID) 
else
	sum(rkU8) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkU8,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then nSys9 else n9*@Kurs end as n9,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then kSys9 else k9*@Kurs end as k9,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then oSys9 else o9*@Kurs end as o9,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpo9) OVER(Partition by ULR_ID) 
else
	sum(vpo9) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpo9,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpb9) OVER(Partition by ULR_ID) 
else
	sum(vpb9) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpb9,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vo9) OVER(Partition by ULR_ID) 
else
	sum(vo9) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vo9,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vb9) OVER(Partition by ULR_ID) 
else
	sum(vb9) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vb9,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkD9) OVER(Partition by ULR_ID) 
else
	sum(rkD9) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkD9,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkU9) OVER(Partition by ULR_ID) 
else
	sum(rkU9) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkU9,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then nSys10 else n10*@Kurs end as n10,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then kSys10 else k10*@Kurs end as k10,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then oSys10 else o10*@Kurs end as o10,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpo10) OVER(Partition by ULR_ID) 
else
	sum(vpo10) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpo10,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpb10) OVER(Partition by ULR_ID) 
else
	sum(vpb10) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpb10,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vo10) OVER(Partition by ULR_ID) 
else
	sum(vo10) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vo10,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vb10) OVER(Partition by ULR_ID) 
else
	sum(vb10) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vb10,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkD10) OVER(Partition by ULR_ID) 
else
	sum(rkD10) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkD10,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkU10) OVER(Partition by ULR_ID) 
else
	sum(rkU10) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkU10,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then nSys11 else n11*@Kurs end as n11,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then kSys11 else k11*@Kurs end as k11,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then oSys11 else o11*@Kurs end as o11,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpo11) OVER(Partition by ULR_ID) 
else
	sum(vpo11) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpo11,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpb11) OVER(Partition by ULR_ID) 
else
	sum(vpb11) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpb11,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vo11) OVER(Partition by ULR_ID) 
else
	sum(vo11) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vo11,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vb11) OVER(Partition by ULR_ID) 
else
	sum(vb11) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vb11,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkD11) OVER(Partition by ULR_ID) 
else
	sum(rkD11) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkD11,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkU11) OVER(Partition by ULR_ID) 
else
	sum(rkU11) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkU11,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then nSys12 else n12*@Kurs end as n12,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then kSys12 else k12*@Kurs end as k12,
case when @bWalutaSys = 1 or (@bWalutaSys = 2 and MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) &lt;&gt;0) then oSys12 else o12*@Kurs end as o12,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpo12) OVER(Partition by ULR_ID) 
else
	sum(vpo12) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpo12,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vpb12) OVER(Partition by ULR_ID) 
else
	sum(vpb12) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vpb12,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vo12) OVER(Partition by ULR_ID) 
else
	sum(vo12) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vo12,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(vb12) OVER(Partition by ULR_ID) 
else
	sum(vb12) OVER(Partition by ULR_ULNID, ULR_Numer) 
end vb12,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkD12) OVER(Partition by ULR_ID) 
else
	sum(rkD12) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkD12,
case when ULR_ULPLp &lt;&gt; 0 then
	sum(rkU12) OVER(Partition by ULR_ID) 
else
	sum(rkU12) OVER(Partition by ULR_ULNID, ULR_Numer) 
end rkU12,

ULR_ULNID,
ULR_ULPLp,
MAX(CASE WHEN TrV_GIDTyp&lt;&gt;2600 THEN TrV_GIDTyp ELSE 0 END) OVER(Partition by ULR_ID) GIDTyp



from (
	select 
	ULR_ID, ULR_Numer, ULR_ULNID, ULR_ULPLP, TRV_GIDTyp, NumerDokumentu, Srt_Akronim, 
	coalesce(Bnk_Kod,Knt_Akronim) as PdmFin, 
	'Netto (' + case when @bWalutaSys&lt;&gt;0 then @WalutaSys else ULN_Waluta end +')' opisNetto,
	'Kapitał (' + case when @bWalutaSys&lt;&gt;0 then @WalutaSys else ULN_Waluta end +')' opisKapital,
	'Odsetki (' + case when @bWalutaSys&lt;&gt;0 then @WalutaSys else ULN_Waluta end +')' opisOdsetki,
	'VAT odlicz.(P) (' + @WalutaSys + ')' opisPlanVatOdl,'VAT bez odlicz.(P) (' + @WalutaSys + ')' opisPlanVatBez,
	'VAT odlicz. (' + @WalutaSys + ')' opisVatOdl,'VAT bez odlicz. (' + @WalutaSys + ')' opisVatBez,

	--case when Miesiac = 1 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_NettoSys else ULR_Netto*@Kurs end else 0 end n1,
	--case when Miesiac = 1 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_KapitalSys else ULR_Kapital*@Kurs end else 0 end k1,
	--case when Miesiac = 1 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_OdsetkiSys else ULR_Odsetki*@Kurs end else 0 end o1,
	
	case when Miesiac = 1 then ULR_Netto else 0 end n1,
	case when Miesiac = 1 then ULR_NettoSys else 0 end nSys1,
	case when Miesiac = 1 then ULR_Kapital else 0 end k1,
	case when Miesiac = 1 then ULR_KapitalSys else 0 end kSys1,
	case when Miesiac = 1 then ULR_Odsetki else 0 end o1,
	case when Miesiac = 1 then ULR_OdsetkiSys else 0 end oSys1,	
	case when Miesiac = 1 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vpo1,
	case when Miesiac = 1 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vpb1,
	case when Miesiac = 1 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vo1,
	case when Miesiac = 1 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vb1,
	case when Miesiac = 1 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 1 then RKN_Kwota else 0 end else 0 end else 0 end rkD1,
	case when Miesiac = 1 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 2 then RKN_Kwota else 0 end else 0 end else 0 end rkU1,

	--case when Miesiac = 2 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_NettoSys else ULR_Netto*@Kurs end else 0 end n2,
	--case when Miesiac = 2 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_KapitalSys else ULR_Kapital*@Kurs end else 0 end k2,
	--case when Miesiac = 2 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_OdsetkiSys else ULR_Odsetki*@Kurs end else 0 end o2,
	case when Miesiac = 2 then ULR_Netto else 0 end n2,
	case when Miesiac = 2 then ULR_NettoSys else 0 end nSys2,
	case when Miesiac = 2 then ULR_Kapital else 0 end k2,
	case when Miesiac = 2 then ULR_KapitalSys else 0 end kSys2,
	case when Miesiac = 2 then ULR_Odsetki else 0 end o2,
	case when Miesiac = 2 then ULR_OdsetkiSys else 0 end oSys2,
	case when Miesiac = 2 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vpo2,
	case when Miesiac = 2 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vpb2,
	case when Miesiac = 2 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vo2,
	case when Miesiac = 2 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vb2,
	case when Miesiac = 2 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 1 then RKN_Kwota else 0 end else 0 end else 0 end rkD2,
	case when Miesiac = 2 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 2 then RKN_Kwota else 0 end else 0 end else 0 end rkU2,

	--case when Miesiac = 3 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_NettoSys else ULR_Netto*@Kurs end else 0 end n3,
	--case when Miesiac = 3 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_KapitalSys else ULR_Kapital*@Kurs end else 0 end k3,
	--case when Miesiac = 3 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_OdsetkiSys else ULR_Odsetki*@Kurs end else 0 end o3,
	case when Miesiac = 3 then ULR_Netto else 0 end n3,
	case when Miesiac = 3 then ULR_NettoSys else 0 end nSys3,
	case when Miesiac = 3 then ULR_Kapital else 0 end k3,
	case when Miesiac = 3 then ULR_KapitalSys else 0 end kSys3,
	case when Miesiac = 3 then ULR_Odsetki else 0 end o3,
	case when Miesiac = 3 then ULR_OdsetkiSys else 0 end oSys3,	
	case when Miesiac = 3 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vpo3,
	case when Miesiac = 3 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vpb3,
	case when Miesiac = 3 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vo3,
	case when Miesiac = 3 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vb3,
	case when Miesiac = 3 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 1 then RKN_Kwota else 0 end else 0 end else 0 end rkD3,
	case when Miesiac = 3 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 2 then RKN_Kwota else 0 end else 0 end else 0 end rkU3,

	--case when Miesiac = 4 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_NettoSys else ULR_Netto*@Kurs end else 0 end n4,
	--case when Miesiac = 4 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_KapitalSys else ULR_Kapital*@Kurs end else 0 end k4,
	--case when Miesiac = 4 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_OdsetkiSys else ULR_Odsetki*@Kurs end else 0 end o4,
	case when Miesiac = 4 then ULR_Netto else 0 end n4,
	case when Miesiac = 4 then ULR_NettoSys else 0 end nSys4,
	case when Miesiac = 4 then ULR_Kapital else 0 end k4,
	case when Miesiac = 4 then ULR_KapitalSys else 0 end kSys4,
	case when Miesiac = 4 then ULR_Odsetki else 0 end o4,
	case when Miesiac = 4 then ULR_OdsetkiSys else 0 end oSys4,	
	case when Miesiac = 4 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vpo4,
	case when Miesiac = 4 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vpb4,
	case when Miesiac = 4 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vo4,
	case when Miesiac = 4 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vb4,
	case when Miesiac = 4 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 1 then RKN_Kwota else 0 end else 0 end else 0 end rkD4,
	case when Miesiac = 4 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 2 then RKN_Kwota else 0 end else 0 end else 0 end rkU4,

	--case when Miesiac = 5 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_NettoSys else ULR_Netto*@Kurs end else 0 end n5,
	--case when Miesiac = 5 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_KapitalSys else ULR_Kapital*@Kurs end else 0 end k5,
	--case when Miesiac = 5 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_OdsetkiSys else ULR_Odsetki*@Kurs end else 0 end o5,
	case when Miesiac = 5 then ULR_Netto else 0 end n5,
	case when Miesiac = 5 then ULR_NettoSys else 0 end nSys5,
	case when Miesiac = 5 then ULR_Kapital else 0 end k5,
	case when Miesiac = 5 then ULR_KapitalSys else 0 end kSys5,
	case when Miesiac = 5 then ULR_Odsetki else 0 end o5,
	case when Miesiac = 5 then ULR_OdsetkiSys else 0 end oSys5,
	case when Miesiac = 5 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vpo5,
	case when Miesiac = 5 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vpb5,
	case when Miesiac = 5 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vo5,
	case when Miesiac = 5 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vb5,
	case when Miesiac = 5 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 1 then RKN_Kwota else 0 end else 0 end else 0 end rkD5,
	case when Miesiac = 5 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 2 then RKN_Kwota else 0 end else 0 end else 0 end rkU5,

	--case when Miesiac = 6 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_NettoSys else ULR_Netto*@Kurs end else 0 end n6,
	--case when Miesiac = 6 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_KapitalSys else ULR_Kapital*@Kurs end else 0 end k6,
	--case when Miesiac = 6 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_OdsetkiSys else ULR_Odsetki*@Kurs end else 0 end o6,
	case when Miesiac = 6 then ULR_Netto else 0 end n6,
	case when Miesiac = 6 then ULR_NettoSys else 0 end nSys6,
	case when Miesiac = 6 then ULR_Kapital else 0 end k6,
	case when Miesiac = 6 then ULR_KapitalSys else 0 end kSys6,
	case when Miesiac = 6 then ULR_Odsetki else 0 end o6,
	case when Miesiac = 6 then ULR_OdsetkiSys else 0 end oSys6,	
	case when Miesiac = 6 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vpo6,
	case when Miesiac = 6 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vpb6,
	case when Miesiac = 6 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vo6,
	case when Miesiac = 6 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vb6,
	case when Miesiac = 6 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 1 then RKN_Kwota else 0 end else 0 end else 0 end rkD6,
	case when Miesiac = 6 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 2 then RKN_Kwota else 0 end else 0 end else 0 end rkU6,

	--case when Miesiac = 7 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_NettoSys else ULR_Netto*@Kurs end else 0 end n7,
	--case when Miesiac = 7 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_KapitalSys else ULR_Kapital*@Kurs end else 0 end k7,
	--case when Miesiac = 7 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_OdsetkiSys else ULR_Odsetki*@Kurs end else 0 end o7,
	case when Miesiac = 7 then ULR_Netto else 0 end n7,
	case when Miesiac = 7 then ULR_NettoSys else 0 end nSys7,
	case when Miesiac = 7 then ULR_Kapital else 0 end k7,
	case when Miesiac = 7 then ULR_KapitalSys else 0 end kSys7,
	case when Miesiac = 7 then ULR_Odsetki else 0 end o7,
	case when Miesiac = 7 then ULR_OdsetkiSys else 0 end oSys7,	
	case when Miesiac = 7 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vpo7,
	case when Miesiac = 7 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vpb7,
	case when Miesiac = 7 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vo7,
	case when Miesiac = 7 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vb7,
	case when Miesiac = 7 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 1 then RKN_Kwota else 0 end else 0 end else 0 end rkD7,
	case when Miesiac = 7 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 2 then RKN_Kwota else 0 end else 0 end else 0 end rkU7,

	--case when Miesiac = 8 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_NettoSys else ULR_Netto*@Kurs end else 0 end n8,
	--case when Miesiac = 8 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_KapitalSys else ULR_Kapital*@Kurs end else 0 end k8,
	--case when Miesiac = 8 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_OdsetkiSys else ULR_Odsetki*@Kurs end else 0 end o8,
	case when Miesiac = 8 then ULR_Netto else 0 end n8,
	case when Miesiac = 8 then ULR_NettoSys else 0 end nSys8,
	case when Miesiac = 8 then ULR_Kapital else 0 end k8,
	case when Miesiac = 8 then ULR_KapitalSys else 0 end kSys8,
	case when Miesiac = 8 then ULR_Odsetki else 0 end o8,
	case when Miesiac = 8 then ULR_OdsetkiSys else 0 end oSys8,	
	case when Miesiac = 8 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vpo8,
	case when Miesiac = 8 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vpb8,
	case when Miesiac = 8 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vo8,
	case when Miesiac = 8 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vb8,
	case when Miesiac = 8 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 1 then RKN_Kwota else 0 end else 0 end else 0 end rkD8,
	case when Miesiac = 8 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 2 then RKN_Kwota else 0 end else 0 end else 0 end rkU8,

	--case when Miesiac = 9 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_NettoSys else ULR_Netto*@Kurs end else 0 end n9,
	--case when Miesiac = 9 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_KapitalSys else ULR_Kapital*@Kurs end else 0 end k9,
	--case when Miesiac = 9 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_OdsetkiSys else ULR_Odsetki*@Kurs end else 0 end o9,
	case when Miesiac = 9 then ULR_Netto else 0 end n9,
	case when Miesiac = 9 then ULR_NettoSys else 0 end nSys9,
	case when Miesiac = 9 then ULR_Kapital else 0 end k9,
	case when Miesiac = 9 then ULR_KapitalSys else 0 end kSys9,
	case when Miesiac = 9 then ULR_Odsetki else 0 end o9,
	case when Miesiac = 9 then ULR_OdsetkiSys else 0 end oSys9,	
	case when Miesiac = 9 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vpo9,
	case when Miesiac = 9 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vpb9,
	case when Miesiac = 9 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vo9,
	case when Miesiac = 9 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vb9,
	case when Miesiac = 9 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 1 then RKN_Kwota else 0 end else 0 end else 0 end rkD9,
	case when Miesiac = 9 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 2 then RKN_Kwota else 0 end else 0 end else 0 end rkU9,

	--case when Miesiac = 10 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_NettoSys else ULR_Netto*@Kurs end else 0 end n10,
	--case when Miesiac = 10 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_KapitalSys else ULR_Kapital*@Kurs end else 0 end k10,
	--case when Miesiac = 10 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_OdsetkiSys else ULR_Odsetki*@Kurs end else 0 end o10,
	case when Miesiac = 10 then ULR_Netto else 0 end n10,
	case when Miesiac = 10 then ULR_NettoSys else 0 end nSys10,
	case when Miesiac = 10 then ULR_Kapital else 0 end k10,
	case when Miesiac = 10 then ULR_KapitalSys else 0 end kSys10,
	case when Miesiac = 10 then ULR_Odsetki else 0 end o10,
	case when Miesiac = 10 then ULR_OdsetkiSys else 0 end oSys10,	
	case when Miesiac = 10 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vpo10,
	case when Miesiac = 10 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vpb10,
	case when Miesiac = 10 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vo10,
	case when Miesiac = 10 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vb10,
	case when Miesiac = 10 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 1 then RKN_Kwota else 0 end else 0 end else 0 end rkD10,
	case when Miesiac = 10 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 2 then RKN_Kwota else 0 end else 0 end else 0 end rkU10,

	--case when Miesiac = 11 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_NettoSys else ULR_Netto*@Kurs end else 0 end n11,
	--case when Miesiac = 11 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_KapitalSys else ULR_Kapital*@Kurs end else 0 end k11,
	--case when Miesiac = 11 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_OdsetkiSys else ULR_Odsetki*@Kurs end else 0 end o11,
	case when Miesiac = 11 then ULR_Netto else 0 end n11,
	case when Miesiac = 11 then ULR_NettoSys else 0 end nSys11,
	case when Miesiac = 11 then ULR_Kapital else 0 end k11,
	case when Miesiac = 11 then ULR_KapitalSys else 0 end kSys11,
	case when Miesiac = 11 then ULR_Odsetki else 0 end o11,
	case when Miesiac = 11 then ULR_OdsetkiSys else 0 end oSys11,
	case when Miesiac = 11 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vpo11,
	case when Miesiac = 11 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vpb11,
	case when Miesiac = 11 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vo11,
	case when Miesiac = 11 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vb11,
	case when Miesiac = 11 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 1 then RKN_Kwota else 0 end else 0 end else 0 end rkD11,
	case when Miesiac = 11 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 2 then RKN_Kwota else 0 end else 0 end else 0 end rkU11,

	--case when Miesiac = 12 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_NettoSys else ULR_Netto*@Kurs end else 0 end n12,
	--case when Miesiac = 12 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_KapitalSys else ULR_Kapital*@Kurs end else 0 end k12,
	--case when Miesiac = 12 then case when @bWalutaSys = 1 or (@bWalutaSys = 2 and isnull(TrV_GIDTyp,0)&lt;&gt;0) then ULR_OdsetkiSys else ULR_Odsetki*@Kurs end else 0 end o12,
	case when Miesiac = 12 then ULR_Netto else 0 end n12,
	case when Miesiac = 12 then ULR_NettoSys else 0 end nSys12,
	case when Miesiac = 12 then ULR_Kapital else 0 end k12,
	case when Miesiac = 12 then ULR_KapitalSys else 0 end kSys12,
	case when Miesiac = 12 then ULR_Odsetki else 0 end o12,
	case when Miesiac = 12 then ULR_OdsetkiSys else 0 end oSys12,
	case when Miesiac = 12 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vpo12,
	case when Miesiac = 12 and TrV_GIDTyp=2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vpb12,
	case when Miesiac = 12 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =1 or TrV_OdliczeniaVat =3) then TRV_VatP else 0 end vo12,
	case when Miesiac = 12 and TrV_GIDTyp&lt;&gt;2600 and (TrV_OdliczeniaVat =2) then TRV_VatP else 0 end vb12,
	case when Miesiac = 12 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 1 then RKN_Kwota else 0 end else 0 end else 0 end rkD12,
	case when Miesiac = 12 then case when @bWalutaSys &lt;&gt; 0 then case when RKN_Znak = 2 then RKN_Kwota else 0 end else 0 end else 0 end rkU12
	


	from 
	(
		select
			ULR_ID,
			ULR_Numer,
			CDN.NumerDokumentu(2600,0,0,ULN_ULNNumer,ULN_ULNRok, ULN_ULNSeria, ULN_ULNMiesiac) as NumerDokumentu,
			ULN_Waluta,
			ULR_ULNID,
			ULR_ULPLp, 
			month(dateadd(day,ULR_Termin,convert(datetime,'18001228',120))) as Miesiac,				
			ULR_Netto, ULR_Kapital, ULR_Odsetki,
			ULR_NettoSys, ULR_KapitalSys, ULR_OdsetkiSys,
			Srt_Akronim, Bnk_Kod, Knt_Akronim,
			TrV_OdliczeniaVat,TrV_VatP,
			TRV_GIDTyp,
			RKN_Znak, RKN_Kwota
		from cdn.UmlRaty
				join cdn.UmlNag
					on ULR_ULNID = ULN_ID
				left join cdn.UmlPrzedmioty
					  on ULR_ULNID = ULP_ULNId and ULR_ULPLp = ULP_Lp		
				left join cdn.SrtKarty
					  on ULP_SRTNumer = Srt_GIDNumer
				--left join cdn.TraVat
				--	  on ULR_ID = TrV_ULRID
				left join 
					(select  TRV_GIDTyp TRV_GIDTyp, TRV_GIDNumer TRV_GIDNumer, TRV_GIDLp TRV_GIDLp, TRV_VatP TRV_VatP, TrV_OdliczeniaVat TrV_OdliczeniaVat, TrV_ULRID TrV_ULRID
					from cdn.TraVat 
					union all
					select MEE_GIDTyp, MEE_GIDNumer, MEE_GIDLp, 0, 0, MEE_ULRID
					from cdn.MemElem
					) dok
						on ULR_ID = TrV_ULRID 
				left join cdn.RozniceKursowe
					on dok.TRV_GIDTyp = RKN_Dok1Typ and dok.TRV_GIDNumer = RKN_Dok1Numer and dok.TRV_GIDLp = RKN_Dok1Lp
						and 2600 = RKN_Dok2Typ and ULR_ID = RKN_Dok2Numer and 0 = RKN_Dok2Lp
				left join cdn.KntKarty
					  on ULN_PodmFinansTyp = 32 and ULN_PodmFinansNumer = Knt_GIDNumer
				left join cdn.Banki
					  on ULN_PodmFinansTyp = 48 and ULN_PodmFinansNumer = Bnk_GIDNumer						  
		where ULR_Termin between @Data1 and @Data2 and (ULN_Waluta = @Waluta or @Waluta in ('1','2'))				
	) as src		
) a
) a0
group by ULR_ULNID, ULR_ULPLp, NrUmAkr, PdmFin, opisNetto,opisKapital,opisOdsetki,opisPlanVatOdl,opisPlanVatBez,opisVatOdl,opisVatBez
order by ULR_ULNID--, ULR_ULPLp

set nocount off
end
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>