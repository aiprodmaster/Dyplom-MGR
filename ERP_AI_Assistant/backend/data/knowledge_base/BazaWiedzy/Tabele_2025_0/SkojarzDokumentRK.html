<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="Kasowanie procedury SkojarzDokumentRK"></A><PRE>
          <FONT SIZE="2" DISABLED="True"><I>/* Kasowanie procedury SkojarzDokumentRK */</I><BR>
if exists (select name from sysobjects where name = 'SkojarzDokumentRK' and type = 'P')
  drop procedure CDN.SkojarzDokumentRK;
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="Tworzenie procedury SkojarzDokumentRK"></A><PRE>
          <FONT SIZE="2"><I>/* Tworzenie procedury SkojarzDokumentRK */</I><BR>
CREATE PROCEDURE CDN.SkojarzDokumentRK
@GIDFirma int,
@RKN_ID INT,
@UserID INT,
@DataDzisiejsza INT

-------------------------
AS

-- deklaracje

DECLARE @Nierozliczone TABLE(
Numer    SMALLINT,
GIDNumer INT,
GIDLp    SMALLINT,
DC       SMALLINT,
KwotaSys DECIMAL(15,2),
KwotaWal DECIMAL(15,2),
Konto    VARCHAR(50),
KontoNumer INT,
KontoTypPozabil TINYINT,
KontoWal VARCHAR(50),
KontoWalNumer INT,
Waluta   VARCHAR(3),
KursL	 DECIMAL(29,10),
KursM	 DECIMAL(29,10),
Znak     SMALLINT,
Data     INT,
Dokument VARCHAR(40),
Nierozliczony smallint,
Rozliczony smallint,
MaRozliczenie smallint,
DT_WycenaParID int,
KontoRej tinyint
  );

DECLARE @KontaNieTozsame INT
DECLARE @OpisRK VARCHAR(80)
DECLARE @OpisKompensaty VARCHAR(80)
DECLARE @Dokument1 VARCHAR(40)
DECLARE @Dokument2 VARCHAR(40) 
DECLARE @Dokument3 VARCHAR(40) 
DECLARE @Zwykle1 SMALLINT
DECLARE @Zwykle2 SMALLINT
DECLARE @Zwykle3 SMALLINT
DECLARE @Dod1 SMALLINT
DECLARE @Dod2 SMALLINT
DECLARE @Dod3 SMALLINT
DECLARE @KompGIDNumer INT
DECLARE @DataDzisiejszaKomp INT;
DECLARE @DataKomp INT
DECLARE @KontoWal1 VARCHAR(50)
DECLARE @KontoWal2 VARCHAR(50)
DECLARE @KontoWal3 VARCHAR(50)
DECLARE @KontoWal1Numer INT
DECLARE @KontoWal2Numer INT
DECLARE @KontoWal3Numer INT

DECLARE @Waluta1 VARCHAR(3)
DECLARE @Waluta2 VARCHAR(3)
DECLARE @Waluta3 VARCHAR(3)
DECLARE @KwotaWal DECIMAL(15,2)
DECLARE @KwotaSys DECIMAL(15,2)
DECLARE @KwotaTRWal1 DECIMAL(15,2)
DECLARE @KwotaTRSys1 DECIMAL(15,2)
DECLARE @KwotaTRWal2 DECIMAL(15,2)
DECLARE @KwotaTRSys2 DECIMAL(15,2)
DECLARE @Dekret1Numer INT
DECLARE @Dekret1Lp SMALLINT
DECLARE @Dekret1DC SMALLINT
DECLARE @Dekret2Numer INT
DECLARE @Dekret2Lp SMALLINT
DECLARE @Dekret2DC SMALLINT
DECLARE @Dekret3Numer INT
DECLARE @Dekret3Lp SMALLINT
DECLARE @Dekret3DC SMALLINT
DECLARE @Zaksiegowany1 SMALLINT
DECLARE @Zaksiegowany2 SMALLINT
DECLARE @Data1 INT
DECLARE @Data2 INT
DECLARE @WalutaSys VARCHAR(3)

DECLARE @SavDekret1Numer int
DECLARE @SavDekret1Lp smallint
DECLARE @SavDekret1DC smallint

DECLARE @Cnt1 SMALLINT;
DECLARE @Cnt2 SMALLINT;
DECLARE @Cnt3 SMALLINT;
DECLARE @Cnt4 SMALLINT;
DECLARE @RoznicaKursowa DECIMAL(15,2);
DECLARE @KontoDT VARCHAR(50);
DECLARE @KontoCT VARCHAR(50);
DECLARE @KontoDTNumer INT;
DECLARE @KontoCTNumer INT;
DECLARE @Znak1 INT
DECLARE @Znak2 INT
DECLARE @Znak3 INT
DECLARE @Rozliczony1 INT
DECLARE @Rozliczony2 INT
DECLARE @ZnakTR1 INT
DECLARE @ZnakTR2 INT


DECLARE @DataDzisiejszaRK INT;
DECLARE @OkresRK INT
DECLARE @StronaRK SMALLINT
DECLARE @StronaRozl tinyint

DECLARE @KwotaWal1 DECIMAL(15,2)
DECLARE @KwotaSys1 DECIMAL(15,2)
DECLARE @KwotaWal2 DECIMAL(15,2)
DECLARE @KwotaSys2 DECIMAL(15,2)
DECLARE @DataRoz1 INT
DECLARE @DataRoz2 INT
DECLARE @DataRoz3 INT
DECLARE @DataRoz  INT

DECLARE @Konto1 VARCHAR(50)
DECLARE @Konto2 VARCHAR(50)
DECLARE @Konto3 VARCHAR(50)
DECLARE @Konto1Numer INT
DECLARE @Konto2Numer INT
DECLARE @Konto3Numer INT
DECLARE @Konto1TypPozabil TINYINT
DECLARE @Konto2TypPozabil TINYINT
DECLARE @Konto3TypPozabil TINYINT
DECLARE @Termin1 INT
DECLARE @Termin2 INT




declare @poz_DecKwota smallint
set @poz_DecKwota = 2 
declare @Kurs1 decimal(29,10)
declare @Kurs2 decimal(29,10)
declare @DataRozliczenia int
declare @DataRozrachunku int
declare @DataRK int


declare @RozliczenieCalkowite smallint
declare @KwotaDTWal1 decimal(15,2)
declare @KwotaDTSys1 decimal(15,2)
declare @KwotaDTWal2 decimal(15,2)
declare @KwotaDTSys2 decimal(15,2)
declare @KwotaDTWal3 decimal(15,2)
declare @KwotaDTSys3 decimal(15,2)

declare @KursDTL1 decimal(29,10)
declare @KursDTM1 decimal(29,10)
declare @KursDTL2 decimal(29,10)
declare @KursDTM2 decimal(29,10)
declare @KursDTL decimal(29,10)
declare @KursDTM decimal(29,10)

declare @RKN_Dok1Typ smallint
declare @RKN_Dok1Numer int
declare @RKN_Dok1Lp smallint

declare @RKN_Dok2Typ smallint
declare @RKN_Dok2Numer int
declare @RKN_Dok2Lp smallint

declare @RKN_Kwota decimal(15,2)
declare @RKN_DataRozl int

DECLARE @RKN_Dok1KwotaSys DECIMAL(15,2)
DECLARE @RKN_Dok2KwotaSys DECIMAL(15,2)

declare @R2_KwotaSys decimal(15,2)
declare @R2_KwotaWal1 decimal(15,2)
declare @R2_DataRozliczenia int
declare @R2_ParID int
declare @R2_ID int
declare @r2_strona smallint


declare @RK_R2_KwotaSys decimal(15,2)
declare @RK_R2_KwotaWal1 decimal(15,2)
declare @RK_R2_DataRozliczenia int
declare @RK_R2_ParID int
declare @RK_R2_ID int
declare @RK_StronaRozl smallint


declare @GIDTyp1 smallint
declare @GIDNumer1 int
declare @GIDLp1 smallint

declare @GIDTyp2 smallint
declare @GIDNumer2 int
declare @GIDLp2 smallint


declare @szMsg1 varchar(30)
declare @szMsg2 varchar(30)

declare @BZ smallint
declare @RKN_BZ smallint
declare @BezRozrachunku smallint
set @BezRozrachunku = 0


declare @Err int
declare @RCount int
declare @Wycena tinyint
declare @R2_WycenaParID int
declare @WycenaParID int
declare @KAZWycenaKolejnosc1 tinyint
declare @KAZWycenaKolejnosc2 tinyint
declare @KAZKursWgWyceny1 tinyint
declare @KAZKursWgWyceny2 tinyint

declare @OldKonto1Numer int
declare @OldKonto2Numer int
declare @OldKonto3Numer int
declare @OldKonto1 VARCHAR(50)
declare @OldKonto2 VARCHAR(50)
declare @OldKonto3 VARCHAR(50)
declare @OldKontoWal1Numer int
declare @OldKontoWal2Numer int
declare @OldKontoWal3Numer int
declare @OldKontoWal1 VARCHAR(50)
declare @OldKontoWal2 VARCHAR(50)
declare @OldKontoWal3 VARCHAR(50)


-- początek transakcji
SET NOCOUNT ON


BEGIN TRAN





SELECT @WalutaSys = KON_Wartosc FROM CDN.Konfig with(nolock) WHERE KON_Numer = 211



SET @Dod1 = 0
SET @Dod2 = 0
SET @Dod3 = 0



--pobierz dok RK
select
	@RKN_Dok1Typ = RKN_Dok1Typ,
	@RKN_Dok1Numer = RKN_Dok1Numer,
	@RKN_Dok1Lp = RKN_Dok1Lp,

	@RKN_Dok2Typ = RKN_Dok2Typ,
	@RKN_Dok2Numer = RKN_Dok2Numer,
	@RKN_Dok2Lp = RKN_Dok2Lp,

	@RKN_Kwota = RKN_Kwota,
	@RKN_DataRozl = RKN_DataRozl,
	
	@RKN_BZ = RKN_BZ,

	@RKN_Dok1KwotaSys = RKN_Dok1KwotaSys,
	@RKN_Dok2KwotaSys = RKN_Dok2KwotaSys

from cdn.RozniceKursowe
where RKN_ID = @RKN_ID

select @Err = @@Error, @RCount = @@ROWCount

if @Err &lt;&gt; 0
BEGIN
  ROLLBACK TRAN
  RAISERROR('100:Błąd odczytu dokumentu Różnicy Kursowej', 16, 1) 
  RETURN 100
END

if @Rcount = 0
BEGIN
  ROLLBACK TRAN
  RAISERROR('100:Brak rekordu w tabeli RozniceKursowe', 16, 1) 
  RETURN 100
END



--pobierz rozliczenie z dok RK
select 
	@GIDTyp1 = GIDTyp1,
	@GIDNumer1 = GIDNumer1,
	@GIDLp1 = GIDLp1,	
	@RK_r2_KwotaSys = RK_r2_KwotaSys,
	@RK_r2_DataRozliczenia = RK_r2_DataRozliczenia,
	@RK_r2_parid = RK_r2_parid,
	@RK_r2_ID = RK_r2_ID,
	@RK_StronaRozl = RK_StronaRozl
from (
	select 
		r2_Dok2Typ GIDTyp1,
		r2_Dok2Numer GIDNumer1,
		r2_Dok2Lp GIDLp1,	
		r2_KwotaSys RK_r2_KwotaSys,
		r2_DataRozliczenia RK_r2_DataRozliczenia,
		r2_id RK_r2_id,
		r2_parid RK_r2_parid,
		1 RK_StronaRozl
	from cdn.Rozliczenia
	where r2_Dok1Typ = 435 and r2_Dok1Numer = @RKN_ID
	Union all
	select 
		r2_Dok1Typ GIDTyp1,
		r2_Dok1Numer GIDNumer1,
		r2_Dok1Lp GIDLp1,	
		r2_KwotaSys RK_r2_KwotaSys,
		r2_DataRozliczenia RK_r2_DataRozliczenia,
		r2_id RK_r2_id,
		r2_parid RK_r2_parid,
		2 RK_StronaRozl
	from cdn.Rozliczenia
	where r2_Dok2Typ = 435 and r2_Dok2Numer = @RKN_ID
) as a1


IF @@ERROR &lt;&gt; 0
BEGIN
  ROLLBACK TRAN
  RAISERROR('101:Błąd odczytu rozliczenia dokumentu Różnicy Kursowej', 16, 1) 
  RETURN 101
END





--pobierz rozliczenie dokumentow skladowych
select 
	@GIDTyp2 = GIDTyp2,
	@GIDNumer2 = GIDNumer2,
	@GIDLp2 = GIDLp2,		
	@r2_KwotaSys = r2_KwotaSys,
	@r2_KwotaWal1 = r2_KwotaWal1,
	@r2_DataRozliczenia = r2_DataRozliczenia,
	@r2_id = r2_id,
	@r2_parid = r2_parid,
	@r2_strona = r2_strona,
	@Wycena = R2_Wycena,
	@R2_WycenaParID = R2_WycenaParID
from (
	select 
		r2_Dok2Typ GIDTyp2,
		r2_Dok2Numer GIDNumer2,
		r2_Dok2Lp GIDLp2,	
		r2_KwotaSys r2_KwotaSys,
		r2_KwotaWal1 r2_KwotaWal1,
		r2_DataRozliczenia r2_DataRozliczenia,
		r2_id r2_id,
		r2_parid r2_parid,
		1 r2_strona,
		r2_wycena,
		r2_wycenaparID
	from cdn.Rozliczenia
	where r2_Dok1Typ = @GIDTyp1 and r2_Dok1Numer = @GIDNumer1 and r2_Dok1Lp = @GIDLp1 and R2_ParID = @RK_r2_parid and r2_ID &lt;&gt; @RK_r2_ID
	Union all
	select 
		r2_Dok1Typ GIDTyp2,
		r2_Dok1Numer GIDNumer2,
		r2_Dok1Lp GIDLp2,	
		r2_KwotaSys r2_KwotaSys,
		r2_KwotaWal1 r2_KwotaWal1,
		r2_DataRozliczenia r2_DataRozliczenia,
		r2_id r2_id,
		r2_parid r2_parid,
		2 r2_strona,
		r2_wycena,
		r2_wycenaparID
	from cdn.Rozliczenia
	where r2_Dok2Typ = @GIDTyp1 and r2_Dok2Numer = @GIDNumer1 and r2_Dok2Lp = @GIDLp1 and R2_ParID = @RK_r2_parid and r2_ID &lt;&gt; @RK_r2_ID
) as a1
IF @@ERROR &lt;&gt; 0
BEGIN
  ROLLBACK TRAN
  RAISERROR('103:Błąd odczytu rozliczenia dokumentów źródłowych', 16, 1) 
  RETURN 103
END


if isnull(@GIDTyp2,0) = 0
BEGIN
  ROLLBACK TRAN
  RAISERROR('102:Błąd danych. Brak rozliczenia dla dokumentu różnicy kursowej', 16, 1) 
  RETURN 102
END



if ((@RKN_Dok1Typ = @GIDTyp1 and @RKN_Dok1Numer = @GIDNumer1 and @RKN_Dok1Lp = @GIDLp1) and
	(@RKN_Dok2Typ &lt;&gt; @GIDTyp2 or @RKN_Dok2Numer &lt;&gt; @GIDNumer2 or @RKN_Dok2Lp &lt;&gt; @GIDLp2)) or
	((@RKN_Dok2Typ = @GIDTyp1 and @RKN_Dok2Numer = @GIDNumer1 and @RKN_Dok2Lp = @GIDLp1) and
	(@RKN_Dok1Typ &lt;&gt; @GIDTyp2 or @RKN_Dok1Numer &lt;&gt; @GIDNumer2 or @RKN_Dok1Lp &lt;&gt; @GIDLp2))
BEGIN
  ROLLBACK TRAN
  RAISERROR('102:Błąd danych. Dokument różnicy kursowej jest rozliczony z innym dokumentem niż wskazany na dokumencie', 16, 1) 
  RETURN 102
END



if @Wycena = 1
	set @WycenaParID = @R2_ParID



-- pobranie dokumentów i dekretów
IF @GIDTyp1 = 784
begin
	SELECT 
		@Waluta1 = KAZ_WalutaRoz, 
		@Kurs1 = KAZ_KursL/KAZ_KursM,
		@Zaksiegowany1 = KAZ_Zaksiegowano, 
		@Data1 = KAZ_DataZapisu, 
		@ZnakTR1 = KAZ_Znak, 
		@Rozliczony1 = KAZ_Rozliczony, 
		@Termin1 = KAZ_DataZapisu,
		@KAZWycenaKolejnosc1 = KAZ_WycenaKolejnosc,
		@KAZKursWgWyceny1 = KAZ_KursWgWyceny
	FROM CDN.Zapisy with (updlock) WHERE KAZ_GIDNumer = @GIDNumer1


	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('104:Błąd odczytu dokumentu źródłowego', 16, 1) 
	  RETURN 104
	END
end
ELSE
BEGIN
	SELECT 
		@Waluta1 = TRDV_Waluta, 
		@Kurs1 = TRDV_KursL / TRDV_KursM,
		@Zaksiegowany1 = TRDV_Zaksiegowano, 
		@Data1 = TRDV_Data, 
		@ZnakTR1 = CASE WHEN TRDV_Kwota &gt;= 0 THEN 3-TRDV_Typ ELSE TRDV_Typ END, 
		@Rozliczony1 = TRDV_Rozliczona, 
		@Termin1 = TRDV_Termin
	FROM CDN.TrpDokView with (updlock)
	WHERE TRDV_GIDTyp = @GIDTyp1 AND TRDV_GIDNumer = @GIDNumer1 AND TRDV_GIDLp=@GIDLp1


	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('104:Błąd odczytu dokumentu źródłowego', 16, 1) 
	  RETURN 104
	END


	IF EXISTS(SELECT * FROM CDN.Zrodla with(nolock) JOIN CDN.Dekrety 
			ON ZRO_DTTyp=DT_GIDTyp AND ZRO_DTNumer=DT_GIDnumer AND ZRO_DTLp=DT_GIDLp 
	     	WHERE ZRO_TRNTyp = @GIDTyp1 AND ZRO_TRNNumer = @GIDNumer1 AND ZRO_TRNLp = @GIDLp1)


		SET @Zaksiegowany1 = 1
	ELSE
		SET @Zaksiegowany1 = 0


	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('104:Błąd odczytu dokumentu źródłowego', 16, 1) 
	  RETURN 104
	END
END






IF @GIDTyp2 = 784
begin
	SELECT 
		@Waluta2 = KAZ_WalutaRoz, 
		@Kurs2 = KAZ_KursL/KAZ_KursM,
		@Zaksiegowany2 = KAZ_Zaksiegowano, 
		@Data2 = KAZ_DataZapisu, 
		@ZnakTR2 = KAZ_Znak, 
		@Rozliczony2 = KAZ_Rozliczony, 
		@Termin2 = KAZ_DataZapisu,
		@KAZWycenaKolejnosc2 = KAZ_WycenaKolejnosc,
		@KAZKursWgWyceny2 = KAZ_KursWgWyceny
	FROM CDN.Zapisy with (updlock) WHERE KAZ_GIDNumer = @GIDNumer2

	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('104:Błąd odczytu dokumentu źródłowego', 16, 1) 
	  RETURN 104
	END
end
ELSE
BEGIN
	SELECT 
		@Waluta2 = TRDV_Waluta, 
		@Kurs2 = TRDV_KursL / TRDV_KursM,
		@Zaksiegowany2 = TRDV_Zaksiegowano, 
		@Data2 = TRDV_Data, 
		@ZnakTR2 = CASE WHEN TRDV_Kwota &gt;= 0 THEN 3-TRDV_Typ ELSE TRDV_Typ END, 
		@Rozliczony2 = TRDV_Rozliczona, 
		@Termin2 = TRDV_Termin
	FROM CDN.TrpDokView with (updlock) 
	WHERE TRDV_GIDTyp = @GIDTyp2 AND TRDV_GIDNumer = @GIDNumer2 AND TRDV_GIDLp=@GIDLp2


	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('104:Błąd odczytu dokumentu źródłowego', 16, 1) 
	  RETURN 104
	END


	IF EXISTS(SELECT * FROM CDN.Zrodla with(nolock) JOIN CDN.Dekrety 
				ON ZRO_DTTyp=DT_GIDTyp AND ZRO_DTNumer=DT_GIDnumer AND ZRO_DTLp=DT_GIDLp 
	      		WHERE ZRO_TRNTyp = @GIDTyp2 AND ZRO_TRNNumer = @GIDNumer2 AND ZRO_TRNLp = @GIDLp2 AND ZRO_DTTyp=432)

		SET @Zaksiegowany2 = 1
	ELSE
		SET @Zaksiegowany2 = 0


	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('104:Błąd odczytu dokumentu źródłowego', 16, 1) 
	  RETURN 104
	END
END

---opisy dokumentow
set @Dokument1 = cdn.NazwaObiektu (@GIDTyp1, @GIDNumer1, 0, 2)
set @Dokument2 = cdn.NazwaObiektu (@GIDTyp2, @GIDNumer2, 0, 2)



-- sprawdzenie waluty
IF @Waluta1 &lt;&gt; @Waluta2
BEGIN
  ROLLBACK TRAN
  RAISERROR('105:Rozliczane dokumenty różnią się walutą: %s &lt;&gt; %s. Rozliczenie niemożliwe!', 16, 1, @Waluta1, @Waluta2 ) 
  RETURN 105
END


IF (@Rozliczony1 = 2 OR @Rozliczony2 = 2) 
BEGIN
  ROLLBACK TRAN
  RAISERROR('106:Jeden z dokumentów lub oba dokumenty nie są przeznaczone do rozliczenia. Rozliczenie niemożliwe.', 16, 1) 
  RETURN 106
END


IF @ZnakTR1 = @ZnakTR2
BEGIN
  ROLLBACK TRAN
  RAISERROR('107:Oba dokumenty są zobowiązaniami lub oba są należnościami. Rozliczenie niemożliwe.', 16, 1) 
  RETURN 107
END


IF @Zaksiegowany1 = 0 or @Zaksiegowany2 = 0
BEGIN
  ROLLBACK TRAN
  RAISERROR('108:Operacja anulowana. Jeden z dokumentów źródłowych nie jest zaksięgowany.', 16, 1) 
  RETURN 108
END
	


DELETE FROM @Nierozliczone;


INSERT INTO @Nierozliczone( Numer, GIDNumer, GIDLp, DC, KwotaSys, KwotaWal, Konto, KontoNumer, KontoTypPozabil, KontoWal, KontoWalNumer, Waluta, KursL, KursM, Znak, Data, Dokument, Nierozliczony, Rozliczony, DT_WycenaParID ) 
SELECT 1, DT_GIDNumer, DT_GIDLp, DT_DC,
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_Konto ELSE '' END), 
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_GIDNumer ELSE '' END), 
MAX( CASE WHEN DT_Waluta = @WalutaSys AND KKS_TypKonta=6 THEN 1 ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_Konto ELSE '' END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_GIDNumer ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_Waluta ELSE '' END ),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN DT_KursKwota ELSE 1 END ),
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_KursKwota ELSE 1 END ),
MAX( DT_Znak ), 
MAX( DT_DataDekr ),
MAX( DEL_DokumentZrodlowy ),
Max( DT_Nierozliczony ),
Max( DT_Rozliczony ),
max( DEL_WycenaParID )
FROM CDN.Dekrety with(updlock)
	JOIN CDN.Konta 
		ON DT_KKSNumer = KKS_GIDNumer
	JOIN CDN.Zrodla with(nolock) 
		ON ZRO_DTTyp = DT_GIDTyp AND ZRO_DTNumer = DT_GIDNumer AND ZRO_DTLp = DT_GIDLp
	JOIN CDN.DziennikElem with(nolock)
		ON DT_GIDNumer = DEL_GIDNumer AND DT_GIDLp = DEL_GIDLp
WHERE ZRO_TRNTyp = @GIDTyp1 AND ZRO_TRNNumer = @GIDNumer1 AND ZRO_TRNLp = @GIDLp1 AND (DT_Nierozliczony = 1 OR DT_Rozliczony=1)
	AND KKS_Rozrachunkowe &lt;&gt; 0
GROUP BY DT_GIDNumer, DT_GIDLp, DT_DC



IF @@Error &lt;&gt; 0
BEGIN
  ROLLBACK TRAN
  RAISERROR('108:Błąd pobrania dekretów', 16, 1) 
  RETURN 108
END



INSERT INTO @Nierozliczone( Numer, GIDNumer, GIDLp, DC, KwotaSys, KwotaWal, Konto, KontoNumer, KontoTypPozabil, KontoWal, KontoWalNumer, Waluta, KursL, KursM, Znak, Data, Dokument, Nierozliczony, Rozliczony, DT_WycenaParID ) 
SELECT 2, DT_GIDNumer, DT_GIDLp, DT_DC,
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_Konto ELSE '' END), 
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_GIDNumer ELSE '' END), 
MAX( CASE WHEN DT_Waluta = @WalutaSys AND KKS_TypKonta=6 THEN 1 ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_Konto ELSE '' END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_GIDNumer ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_Waluta ELSE '' END),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN DT_KursKwota ELSE 1 END ),
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_KursKwota ELSE 1 END ),
MAX( DT_Znak ), 
MAX( DT_DataDekr ),
MAX( DEL_DokumentZrodlowy ),
Max( DT_Nierozliczony ),
Max( DT_Rozliczony ),
max( DEL_WycenaParID )
FROM CDN.Dekrety with(updlock)
	JOIN CDN.Konta 
		ON DT_KKSNumer = KKS_GIDNumer
	JOIN CDN.Zrodla with(nolock)
		ON ZRO_DTTyp = DT_GIDTyp AND ZRO_DTNumer = DT_GIDNumer AND ZRO_DTLp = DT_GIDLp
	JOIN CDN.DziennikElem with(nolock) 
		ON DT_GIDNumer = DEL_GIDNumer AND DT_GIDLp = DEL_GIDLp
WHERE ZRO_TRNTyp = @GIDTyp2 AND ZRO_TRNNumer = @GIDNumer2 AND ZRO_TRNLp = @GIDLp2 AND (DT_Nierozliczony = 1 OR DT_Rozliczony=1)
	AND KKS_Rozrachunkowe &lt;&gt; 0
GROUP BY DT_GIDNumer, DT_GIDLp, DT_DC


IF @@Error &lt;&gt; 0
BEGIN
  ROLLBACK TRAN
  RAISERROR('108:Błąd pobrania dekretów', 16, 1) 
  RETURN 108
END


INSERT INTO @Nierozliczone( Numer, GIDNumer, GIDLp, DC, KwotaSys, KwotaWal, Konto, KontoNumer, KontoTypPozabil, KontoWal, KontoWalNumer, Waluta, KursL, KursM, Znak, Data, Dokument, Nierozliczony, Rozliczony, DT_WycenaParID ) 
SELECT 3, DT_GIDNumer, DT_GIDLp, DT_DC,
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_Konto ELSE '' END), 
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_GIDNumer ELSE '' END), 
MAX( CASE WHEN DT_Waluta = @WalutaSys AND KKS_TypKonta=6 THEN 1 ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_Konto ELSE '' END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_GIDNumer ELSE 0 END), 
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_Waluta ELSE '' END),
MAX( CASE WHEN DT_Waluta = @WalutaSys THEN DT_KursKwota ELSE 1 END ),
MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_KursKwota ELSE 1 END ),
MAX( DT_Znak ), 
MAX( DT_DataDekr ),
MAX( DEL_DokumentZrodlowy ),
Max( DT_Nierozliczony ),
Max( DT_Rozliczony ),
max( DEL_WycenaParID )
FROM CDN.Dekrety with(updlock)
	JOIN CDN.Konta 
		ON DT_KKSNumer = KKS_GIDNumer
	JOIN CDN.Zrodla with(nolock)
		ON ZRO_DTTyp = DT_GIDTyp AND ZRO_DTNumer = DT_GIDNumer AND ZRO_DTLp = DT_GIDLp
	JOIN CDN.DziennikElem with(nolock) 
		ON DT_GIDNumer = DEL_GIDNumer AND DT_GIDLp = DEL_GIDLp
WHERE ZRO_TRNTyp = 435 AND ZRO_TRNNumer = @RKN_ID AND ZRO_TRNLp = 0 AND (DT_Nierozliczony = 1 OR DT_Rozliczony=1)
GROUP BY DT_GIDNumer, DT_GIDLp, DT_DC


IF @@Error &lt;&gt; 0
BEGIN
  ROLLBACK TRAN
  RAISERROR('108:Błąd pobrania dekretów', 16, 1) 
  RETURN 108
END


	
UPDATE @Nierozliczone SET Waluta = @WalutaSys WHERE Waluta = '';


---- kojarzenie dekretów


--zaznacz konta rejestru

update @Nierozliczone set
	KontoRej = 
	case when (len(rtrim(KontoWal)) &gt; 0 
			and exists(select KAR_KontoKasy
						from cdn.Rejestry
						where KontoWal = KAR_KontoKasy))
				or exists(select KAR_KontoKasy
						from cdn.Rejestry
						where Konto = KAR_KontoKasy) 
	then 1 else 0 end	

if @@Error &lt;&gt; 0
begin			
	ROLLBACK TRAN				
	RAISERROR('200:Błąd odczytu z tabeli cdn.Rejestry', 16, 1) 
	RETURN 100		
end



set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)


if @Cnt1 = 0 
begin
	ROLLBACK TRAN				
	RAISERROR('200:Na dekrecie dokumentu %s brak kont rozrachunkowych', 16, 1, @Dokument1) 
	RETURN 100
end
if @Cnt2 = 0 
begin
	ROLLBACK TRAN				
	RAISERROR('200:Na dekrecie dokumentu %s brak kont rozrachunkowych', 16, 1, @Dokument2) 
	RETURN 100
end

	

if @GIDTyp1 = 784
begin
	if @Wycena = 0
	begin --normalne rozliczenie
		if exists(select PDT_GIDNumer from cdn.Predekrety 
				where PDT_GIDTyp = 784 and PDT_GIDNumer = @GIDNumer1 
				and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0)
		begin --zaksiegowany schematem			
			if exists(select PDT_GIDNumer from cdn.Predekrety 
					where PDT_GIDTyp = 784 and PDT_GIDNumer = @GIDNumer1 
					and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) = @r2_id)
			begin --w oparciu o to rozliczenie ksiegowano 
				--usun w oparciu o pozostale rozliczenia i kase
				DELETE FROM a
				FROM @Nierozliczone a 
				WHERE a.Numer = 1 AND 
					not exists (select PDT_GIDNumer from cdn.Predekrety 
						where PDT_GIDTyp = 784 and PDT_GIDNumer = @GIDNumer1 
						and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) = @r2_id
						and isnull(PDT_DelNumer,0) = a.GIDNumer and isnull(PDT_DelLp,0) = a.GIDLp )

			end
			else
			begin 
				if @ZnakTR1 = 1 and @KAZWycenaKolejnosc1 &lt;&gt; 0 and @KAZKursWgWyceny1 &lt;&gt; 0
				begin --ma rozne kursy

					--usun w oparciu o rozliczenia i w oparciu o kase DT_WycenaParID &lt;&gt; @R2_ParID
					DELETE FROM a
					FROM @Nierozliczone a 
					WHERE a.Numer = 1 AND a.DT_WycenaParID &lt;&gt; @R2_WycenaParID

					set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
					if @Cnt1 = 0 
					begin
						RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu powstałego w oparciu o Kasę na konto podmiotu o odpowiednim kursie', 16, 1, @Dokument1) 
						RETURN 100
					end								
				end
				else
				begin --skasuj wszystkie dekrety ksiegowane w oparciu o rozliczenia
					DELETE FROM a
					FROM @Nierozliczone a 
					WHERE a.Numer = 1 AND 
						exists (select PDT_GIDNumer from cdn.Predekrety 
							where PDT_GIDTyp = 784 and PDT_GIDNumer = @GIDNumer1 
							and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0
							and isnull(PDT_DelNumer,0) = a.GIDNumer and isnull(PDT_DelLp,0) = a.GIDLp )


					set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
					if @Cnt1 = 0 
					begin
						RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu powstałego w oparciu o Kasę', 16, 1, @Dokument1) 
						RETURN 100
					end						
				end			


				DELETE FROM a
				FROM @Nierozliczone a 
				WHERE a.Numer = 1 AND a.KontoRej = 1
				
				set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
				if @Cnt1 = 0 
				begin
					RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu powstałego w oparciu o Kasę na konto podmiotu', 16, 1, @Dokument1) 
					RETURN 100
				end
			end			
		end
		else
		begin --ksiegowany normalnie
			if @ZnakTR1 = 1 and @KAZWycenaKolejnosc1 &lt;&gt; 0 and @KAZKursWgWyceny1 &lt;&gt; 0
			begin --ma rozne kursy

				--usun dekrety DT_WycenaParID &lt;&gt; @R2_ParID
				DELETE FROM a
				FROM @Nierozliczone a 
				WHERE a.Numer = 1 AND a.DT_WycenaParID &lt;&gt; @R2_WycenaParID

				set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
				if @Cnt1 = 0 
				begin
					RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu na konto podmiotu o odpowiednim kursie', 16, 1, @Dokument1) 
					RETURN 100
				end			
			end


			DELETE FROM a
			FROM @Nierozliczone a 
			WHERE a.Numer = 1 AND a.KontoRej = 1
			
			set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
			if @Cnt1 = 0 
			begin
				RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu na konto podmiotu ', 16, 1, @Dokument1) 
				RETURN 100
			end			
		end
	end
	else --wycena
	begin
			if @ZnakTR1 = 1 and @KAZWycenaKolejnosc1 &lt;&gt; 0 and @KAZKursWgWyceny1 &lt;&gt; 0
			begin --ma rozne kursy

				--usun dekrety DT_WycenaParID &lt;&gt; @R2_ParID
				DELETE FROM a
				FROM @Nierozliczone a 
				WHERE a.Numer = 1 AND a.DT_WycenaParID &lt;&gt; @R2_ParID

				set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
				if @Cnt1 = 0 
				begin
					RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu na konto rejestru o odpowiednim kursie', 16, 1, @Dokument1) 
					RETURN 100
				end			
			end
			else -- z kursem ustalonym lub KP
			begin
				if exists(select PDT_GIDNumer from cdn.Predekrety 
						where PDT_GIDTyp = 784 and PDT_GIDNumer = @GIDNumer1 
						and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0)
				begin --skasuj oparte o rozliczenia
					DELETE FROM a
					FROM @Nierozliczone a 
					WHERE a.Numer = 1 AND 
						exists (select PDT_GIDNumer from cdn.Predekrety 
							where PDT_GIDTyp = 784 and PDT_GIDNumer = @GIDNumer1 
							and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0
							and isnull(PDT_DelNumer,0) = a.GIDNumer and isnull(PDT_DelLp,0) = a.GIDLp )


					set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
					if @Cnt1 = 0 
					begin
						RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu powstałego w oparciu o Kasę', 16, 1, @Dokument1) 
						RETURN 100
					end						
				end
			end


			DELETE FROM a
			FROM @Nierozliczone a 
			WHERE a.Numer = 1 AND a.KontoRej = 0
			
			set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
			if @Cnt1 = 0 
			begin
				RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu na konto rejestru o odpowiednim kursie', 16, 1, @Dokument1) 
				RETURN 100
			end
	end
end




if @GIDTyp2 = 784
begin
	if @Wycena = 0
	begin --normalne rozliczenie
		if exists(select PDT_GIDNumer from cdn.Predekrety 
				where PDT_GIDTyp = 784 and PDT_GIDNumer = @GIDNumer2 
				and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0)
		begin --zaksiegowany schematem		
			if exists(select PDT_GIDNumer from cdn.Predekrety 
					where PDT_GIDTyp = 784 and PDT_GIDNumer = @GIDNumer2 
					and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) = @r2_id)
			begin --w oparciu o to rozliczenie ksiegowano 
				--usun w oparciu o pozostale rozliczenia i kase
				DELETE FROM a
				FROM @Nierozliczone a 
				WHERE a.Numer = 2 AND 
					not exists (select PDT_GIDNumer from cdn.Predekrety 
						where PDT_GIDTyp = 784 and PDT_GIDNumer = @GIDNumer2 
						and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) = @r2_id
						and isnull(PDT_DelNumer,0) = a.GIDNumer and isnull(PDT_DelLp,0) = a.GIDLp )

			end
			else
			begin 
				if @ZnakTR2 = 1 and @KAZWycenaKolejnosc2 &lt;&gt; 0 and @KAZKursWgWyceny2 &lt;&gt; 0
				begin --ma rozne kursy

					--usun w oparciu o rozliczenia i w oparciu o kase DT_WycenaParID &lt;&gt; @R2_ParID
					DELETE FROM a
					FROM @Nierozliczone a 
					WHERE a.Numer = 2 AND a.DT_WycenaParID &lt;&gt; @R2_WycenaParID

					set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
					if @Cnt2 = 0 
					begin
						RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu powstałego w oparciu o Kasę na konto podmiotu o odpowiednim kursie', 16, 1, @Dokument2) 
						RETURN 100
					end			
				end
				else
				begin --skasuj wszystkie dekrety ksiegowane w oparciu o rozliczenia
					DELETE FROM a
					FROM @Nierozliczone a 
					WHERE a.Numer = 2 AND 
						exists (select PDT_GIDNumer from cdn.Predekrety 
							where PDT_GIDTyp = 784 and PDT_GIDNumer = @GIDNumer2 
							and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0
							and isnull(PDT_DelNumer,0) = a.GIDNumer and isnull(PDT_DelLp,0) = a.GIDLp )


					set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
					if @Cnt2 = 0 
					begin
						RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu powstałego w oparciu o Kasę', 16, 1, @Dokument2) 
						RETURN 100
					end						
				end			

				DELETE FROM a
				FROM @Nierozliczone a 
				WHERE a.Numer = 2 AND a.KontoRej = 1
				
				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
				if @Cnt2 = 0 
				begin
					RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu powstałego w oparciu o Kasę na konto podmiotu', 16, 1, @Dokument2) 
					RETURN 100
				end
			end			
		end
		else
		begin --ksiegowany normalnie
			if @ZnakTR2 = 1 and @KAZWycenaKolejnosc2 &lt;&gt; 0 and @KAZKursWgWyceny2 &lt;&gt; 0
			begin --ma rozne kursy

				--usun dekrety DT_WycenaParID &lt;&gt; @R2_ParID
				DELETE FROM a
				FROM @Nierozliczone a 
				WHERE a.Numer = 2 AND a.DT_WycenaParID &lt;&gt; @R2_WycenaParID

				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
				if @Cnt2 = 0 
				begin
					RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu na konto podmiotu o odpowiednim kursie', 16, 1, @Dokument2) 
					RETURN 100
				end			
			end

			DELETE FROM a
			FROM @Nierozliczone a 
			WHERE a.Numer = 2 AND a.KontoRej = 1
			
			set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
			if @Cnt2 = 0 
			begin
				RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu na konto podmiotu', 16, 1, @Dokument2) 
				RETURN 100
			end			
		end
	end
	else --wycena
	begin
			if @ZnakTR2 = 1 and @KAZWycenaKolejnosc2 &lt;&gt; 0 and @KAZKursWgWyceny2 &lt;&gt; 0
			begin --ma rozne kursy

				--usun dekrety DT_WycenaParID &lt;&gt; @R2_ParID
				DELETE FROM a
				FROM @Nierozliczone a 
				WHERE a.Numer = 2 AND a.DT_WycenaParID &lt;&gt; @R2_ParID

				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
				if @Cnt2 = 0 
				begin
					RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu na konto rejestru o odpowiednim kursie', 16, 1, @Dokument2) 
					RETURN 100
				end			
			end
			else -- z kursem ustalonym lub KP
			begin
				if exists(select PDT_GIDNumer from cdn.Predekrety 
						where PDT_GIDTyp = 784 and PDT_GIDNumer = @GIDNumer2 
						and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0)
				begin
					DELETE FROM a
					FROM @Nierozliczone a 
					WHERE a.Numer = 2 AND 
						exists (select PDT_GIDNumer from cdn.Predekrety 
							where PDT_GIDTyp = 784 and PDT_GIDNumer = @GIDNumer2 
							and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0
							and isnull(PDT_DelNumer,0) = a.GIDNumer and isnull(PDT_DelLp,0) = a.GIDLp )


					set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
					if @Cnt2 = 0 
					begin
						RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu powstałego w oparciu o Kasę', 16, 1, @Dokument2) 
						RETURN 100
					end						
				end
			end


			DELETE FROM a
			FROM @Nierozliczone a 
			WHERE a.Numer = 2 AND a.KontoRej = 0
			
			set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
			if @Cnt2 = 0 
			begin
				RAISERROR('200:Zapis %s był błędnie zaksięgowany. Brak dekretu na konto rejestru o odpowiednim kursie', 16, 1, @Dokument2) 
				RETURN 100
			end
	end
end




/*
I.dla wyceny
	1. dla KW
		pomin tez ktore nie sa zwiazene w dana wycena DT_WycenaParID &lt;&gt; R2_ParID
		pomin te ktore nie maja konta rejestru
	2. dla KP
		pomin oparte o rozliczenia
		pomin te ktore nie maja konta rejestru
II. normalne rozliczenie
	1. dla KW
		jesli podlegal wycenie
			jesli zaksiegowany schematem to
				jesli istnieje dekret powstaly o to rozliczenie
					pomin wszystkie za wyjatkiem tego dekretu
				jesli nie
					pomin wszystkie za wyjatkiem DT_WycenaParID = R2_WycenaParID
					pomin wszystkie z kontem rejestru		
			jesli nie jest zaksiegowany schematem
				pomin wszystkie za wyjatkiem DT_WycenaParID = R2_WycenaParID
				pomin wszystkie z kontem rejestru
		jesli nie
			tak samo jak KP	
	2. dla KP
		jesli ksiegowany schematem
			jesli istnieje dekret powstaly o to rozliczenie
				pomin wszystkie za wyjatkiem tego dekretu
			jesli nie
				pomin wszystkie w oparciu o rozliczenie
				pomin wszystkie z kontem rejestru		
		jesli nie
			pomin wszystkie z kontami rejestru
*/


set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)


if @Cnt1 &gt; 0
begin

	select @Cnt1 = max(Numer)
	from @Nierozliczone 
	where Rozliczony &lt;&gt; 0 and Numer = 1
	


	IF isnull(@Cnt1,0) &lt;&gt; 0 --sa jakies rozrachowane na konta zwykle rozrachunkowe
	begin
		update @Nierozliczone set
			MaRozliczenie = 
			case when exists(select b.R2_ID from 
				(select R2_ParID from cdn.Rozliczenia where R2_Dekret1Numer = GIDNumer and R2_Dekret1Lp = GIDLp and R2_Dekret1DC = DC and R2_Wycena = @Wycena
				union all
				select R2_ParID from cdn.Rozliczenia where R2_Dekret2Numer = GIDNumer and R2_Dekret2Lp = GIDLp and R2_Dekret2DC = DC and R2_Wycena = @Wycena) a
				join cdn.Rozliczenia b on a.R2_ParID = b.R2_ParID and b.R2_Dok1Typ &lt;&gt; 0 and b.R2_Dok2Typ &lt;&gt; 0)
			then 1 else 0 end			
		where Numer = 1 and Rozliczony &lt;&gt; 0

		set @Cnt1 = 0

		SELECT @Cnt1 = count(Numer)
		FROM @Nierozliczone 
		WHERE Numer = 1 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) &lt;&gt; 0


		if isnull(@Cnt1,0) &gt; 1 --dla ktorejs z platnosci rozrachowano wiecej niz jeden dekret
		BEGIN
			set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 1)
			ROLLBACK TRAN
			RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Na dekrecie płatności dokumentu (%s) dokonano już rozrachunku na więcej niż jednym koncie', 16, 1, @szMsg1) 
			RETURN 301
		END
		ELSE
		BEGIN

			if @Rozliczony1 = 2 or @Rozliczony2 = 2
			begin -- ma byc bez rozliczenia

				DELETE FROM @Nierozliczone 
				WHERE Numer = 1 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) &lt;&gt; 0


			end
			else
			begin --ma byc z rozliczeniem

				if isnull(@Cnt1,0) = 1
				begin --jest jeden rozrachunek z rozliczeniem

					SELECT @Dekret1Numer = GIDNumer , @Dekret1Lp = GIDLp, @Dekret1DC = DC
					FROM @Nierozliczone 
					WHERE Numer = 1 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) &lt;&gt; 0
					
		
					DELETE FROM @Nierozliczone 
					WHERE Numer = 1 and not (@Dekret1Numer = GIDNumer and @Dekret1Lp = GIDLp and @Dekret1DC = DC)
		
		
					SELECT @Cnt1 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1
					if @Cnt1 &gt; 1 
					BEGIN --nie powinno sie zdarzyc
						ROLLBACK TRAN
						RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych (3)', 16, 1) 
						RETURN 301
					END
				end
				else
				begin -- nie ma wogole rozrachowanych z rozliczeniem
					DELETE FROM @Nierozliczone 
					WHERE Numer = 1 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) = 0

					SELECT @Cnt1 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1
					if @Cnt1 = 0 
					BEGIN 
						ROLLBACK TRAN
						RAISERROR('200:Dla danej płatności brak dekretów nierozrachowanych lub rozrachowanych wraz z rozliczeniem', 16, 1) 
						RETURN 301
					END
				end
			end
				
		END
	end
end
else
begin
	set @BezRozrachunku = 1
	goto lKoniecRozrachunku
end


if @Cnt2 &gt; 0
begin

	select @Cnt2 = max(Numer)
	from @Nierozliczone 
	where Rozliczony &lt;&gt; 0 and Numer = 2
	


	IF isnull(@Cnt2,0) &lt;&gt; 0 --sa jakies rozrachowane na konta zwykle rozrachunkowe
	begin
		update @Nierozliczone set
			MaRozliczenie = 
			case when exists(select b.R2_ID from 
				(select R2_ParID from cdn.Rozliczenia where R2_Dekret1Numer = GIDNumer and R2_Dekret1Lp = GIDLp and R2_Dekret1DC = DC and R2_Wycena = @Wycena
				union all
				select R2_ParID from cdn.Rozliczenia where R2_Dekret2Numer = GIDNumer and R2_Dekret2Lp = GIDLp and R2_Dekret2DC = DC and R2_Wycena = @Wycena) a
				join cdn.Rozliczenia b on a.R2_ParID = b.R2_ParID and b.R2_Dok1Typ &lt;&gt; 0 and b.R2_Dok2Typ &lt;&gt; 0)
			then 1 else 0 end			
		where Numer = 2 and Rozliczony &lt;&gt; 0

		set @Cnt2 = 0

		SELECT @Cnt2 = count(Numer)
		FROM @Nierozliczone 
		WHERE Numer = 2 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) &lt;&gt; 0


		if isnull(@Cnt2,0) &gt; 1 --dla ktorejs z platnosci rozrachowano wiecej niz jeden dekret
		BEGIN
			set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 2)
			ROLLBACK TRAN
			RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Na dekrecie płatności dokumentu (%s) dokonano już rozrachunku na więcej niż jednym koncie', 16, 1, @szMsg1) 
			RETURN 301
		END
		ELSE
		BEGIN

			if @Rozliczony1 = 2 or @Rozliczony2 = 2
			begin -- ma byc bez rozliczenia

				DELETE FROM @Nierozliczone 
				WHERE Numer = 2 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) &lt;&gt; 0


			end
			else
			begin --ma byc z rozliczeniem

				if isnull(@Cnt2,0) = 1
				begin --jest jeden rozrachunek z rozliczeniem

					SELECT @Dekret2Numer = GIDNumer , @Dekret2Lp = GIDLp, @Dekret2DC = DC
					FROM @Nierozliczone 
					WHERE Numer = 2 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) &lt;&gt; 0
					
		
					DELETE FROM @Nierozliczone 
					WHERE Numer = 2 and not (@Dekret2Numer = GIDNumer and @Dekret2Lp = GIDLp and @Dekret2DC = DC)
		
		
					SELECT @Cnt2 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2
					if @Cnt2 &gt; 1 
					BEGIN --nie powinno sie zdarzyc
						ROLLBACK TRAN
						RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych (4)', 16, 1) 
						RETURN 301
					END
				end
				else
				begin -- nie ma wogole rozrachowanych z rozliczeniem
					DELETE FROM @Nierozliczone 
					WHERE Numer = 2 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) = 0


					SELECT @Cnt2 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2
					if @Cnt2 = 0 
					BEGIN 
						ROLLBACK TRAN
						RAISERROR('200:Dla danej płatności brak dekretów nierozrachowanych lub rozrachowanych wraz z rozliczeniem', 16, 1) 
						RETURN 301
					END
				end
			end
				
		END
	end
end
else
begin
	set @BezRozrachunku = 1
	goto lKoniecRozrachunku
end



SELECT @Cnt1 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1;
SELECT @Cnt2 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2;




IF @Cnt1 = 1 AND @Cnt2 = 2
	DELETE FROM a FROM @Nierozliczone a WHERE a.Numer = 2 AND EXISTS(SELECT * FROM @Nierozliczone b WHERE b.Numer = 1 AND b.Znak = a.Znak)
ELSE IF @Cnt1 = 2 AND @Cnt2 = 1
  	DELETE FROM a FROM @Nierozliczone a WHERE a.Numer = 1 AND EXISTS(SELECT * FROM @Nierozliczone b WHERE b.Numer = 2 AND b.Znak = a.Znak)





SELECT @Cnt1 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1;
SELECT @Cnt2 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2;



IF @Cnt1 &lt;&gt; 1 OR @Cnt2 &lt;&gt; 1
BEGIN

	IF @Cnt1 &lt;&gt; 1
		DELETE FROM a FROM @Nierozliczone a JOIN @Nierozliczone b ON a.Numer=b.Numer AND (a.GIDNumer&lt;&gt;b.GIDNumer OR a.GIDLp&lt;&gt;b.GIDLp OR a.DC&lt;&gt;b.DC)
		WHERE a.Numer = 1 AND a.KwotaSys = 0 AND b.KwotaSys &lt;&gt; 0;


	IF @Cnt2 &lt;&gt; 1
		DELETE FROM a FROM @Nierozliczone a JOIN @Nierozliczone b ON a.Numer=b.Numer AND (a.GIDNumer&lt;&gt;b.GIDNumer OR a.GIDLp&lt;&gt;b.GIDLp OR a.DC&lt;&gt;b.DC)
		WHERE a.Numer = 2 AND a.KwotaSys = 0 AND b.KwotaSys &lt;&gt; 0;


	SELECT @Cnt1 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1;
	SELECT @Cnt2 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2;


	IF @Cnt1 &lt;&gt; 1 OR @Cnt2 &lt;&gt; 1
	BEGIN
		DELETE FROM a FROM @Nierozliczone a 
		WHERE a.Numer in (1,2) 
		and NOT EXISTS(SELECT * 
					FROM @Nierozliczone b 
						left join cdn.KontaNastLinki c
							on b.KontoNumer = c.KLI_NastNumer and a.KontoNumer = c.KLI_PoprzNumer
						left join cdn.KontaNastLinki d
							on a.KontoNumer = d.KLI_NastNumer and b.KontoNumer = d.KLI_PoprzNumer
					WHERE b.Numer in (1,2) and b.Numer = 3-a.Numer AND b.Znak = 3-a.Znak AND not (c.KLI_NastNumer is null and d.KLI_NastNumer is null))



		SELECT @Cnt1 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1;
		SELECT @Cnt2 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2;

		IF @Cnt1 &lt;&gt; 1 OR @Cnt2 &lt;&gt; 1
		BEGIN
			ROLLBACK TRAN
			RAISERROR('300:Niemożliwe ustalenie kont rozrachunkowych (5)', 16, 1) 
			RETURN 300
		END
	END
END






SELECT @Cnt3 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 3;
IF @Cnt3 = 1
BEGIN
	DELETE FROM a FROM @Nierozliczone a WHERE a.Numer = 3 AND 
	not EXISTS(SELECT * FROM @Nierozliczone b WHERE b.Numer = 1 AND b.Znak = 3-a.Znak 
			and exists (
				select KLI_NastNumer from cdn.KontaNastLinki 
				where KLI_NastNumer = b.KontoNumer and KLI_PoprzNumer = a.KontoNumer
				union all
				select KLI_NastNumer from cdn.KontaNastLinki 
				where KLI_NastNumer = a.KontoNumer and KLI_PoprzNumer = b.KontoNumer
				)
		)

	SELECT @Cnt3 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 3;

	IF @Cnt3 = 0
	BEGIN		
		ROLLBACK TRAN
		RAISERROR('300:Na schemacie księgowym dokumentu różnicy kursowej konto rozrachunkowe dokumentu jest po niewłaściwej stronie', 16, 1) 
		RETURN 300
	END		
END
ELSE IF @Cnt3 &gt; 1
BEGIN
	DELETE FROM a FROM @Nierozliczone a WHERE a.Numer = 3 AND 
	not EXISTS(SELECT * FROM @Nierozliczone b WHERE b.Numer = 1 AND b.Znak = 3-a.Znak 
			and exists (
				select KLI_NastNumer from cdn.KontaNastLinki 
				where KLI_NastNumer = b.KontoNumer and KLI_PoprzNumer = a.KontoNumer
				union all
				select KLI_NastNumer from cdn.KontaNastLinki 
				where KLI_NastNumer = a.KontoNumer and KLI_PoprzNumer = b.KontoNumer
				 )
		)


	SELECT @Cnt3 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 3;

	IF @Cnt3 &gt; 1
	BEGIN
		DELETE FROM a FROM @Nierozliczone a JOIN @Nierozliczone b ON a.Numer=b.Numer AND (a.GIDNumer&lt;&gt;b.GIDNumer OR a.GIDLp&lt;&gt;b.GIDLp OR a.DC&lt;&gt;b.DC)
		WHERE a.Numer = 3 AND a.KwotaSys = 0 AND b.KwotaSys &lt;&gt; 0
			and exists (
				select KLI_NastNumer from cdn.KontaNastLinki 
				where KLI_NastNumer = b.KontoNumer and KLI_PoprzNumer = a.KontoNumer
				union all
				select KLI_NastNumer from cdn.KontaNastLinki 
				where KLI_NastNumer = a.KontoNumer and KLI_PoprzNumer = b.KontoNumer
				 )


		SELECT @Cnt3 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 3;

		IF @Cnt3 &lt;&gt; 1
		BEGIN		
			ROLLBACK TRAN
			RAISERROR('300:Niemożliwe ustalenie kont rozrachunkowych (6)', 16, 1) 
			RETURN 300
		END
	END
	else if @Cnt3 &lt;&gt; 1
	begin
		ROLLBACK TRAN
		RAISERROR('300:Niemożliwe ustalenie kont rozrachunkowych (7)', 16, 1) 
		RETURN 300
	end	
END
ELSE IF @Cnt3 = 0
BEGIN		
	ROLLBACK TRAN
	RAISERROR('300:Operacja anulowana. Brak dekretu różnicy kursowej koniecznego do rozrachunku', 16, 1) 
	RETURN 300
END	




--koniec kojarzenia-------------------------


SELECT 
	@Dekret1Numer = GIDNumer, 
	@Dekret1Lp = GIDLp, 
	@KwotaDTWal1 = KwotaWal, 
	@KwotaDTSys1 = KwotaSys, 
	@DataRoz1 = Data, 
	@Waluta1 = Waluta, 
	@KursDTL1 = KursL,
	@KursDTM1 = KursM,	
	@Dekret1DC = DC, 
	@Konto1 = Konto, 
	@Konto1Numer = KontoNumer, 
	@Konto1TypPozabil = KontoTypPozabil,
	@Znak1 = Znak, 
	--@Dokument1 = Dokument,
	@KontoWal1 = KontoWal, 
	@KontoWal1Numer = KontoWalNumer
FROM @Nierozliczone WHERE Numer = 1



IF @@ERROR &lt;&gt; 0
BEGIN
  ROLLBACK TRAN
  RAISERROR('200:Błąd pobrania wiersza do rozrachunku', 16, 1) 
  RETURN 200
END



set @SavDekret1Numer = @Dekret1Numer
set @SavDekret1Lp = @Dekret1Lp
set @SavDekret1DC = @Dekret1DC



SELECT 
	@Dekret2Numer = GIDNumer, 
	@Dekret2Lp = GIDLp, 
	@KwotaDTWal2 = KwotaWal, 
	@KwotaDTSys2 = KwotaSys, 
	@DataRoz2 = Data, 
	@Waluta2 = Waluta, 
	@KursDTL2 = KursL,
	@KursDTM2 = KursM,
	@Dekret2DC = DC, 
	@Konto2 = Konto, 
	@Konto2Numer = KontoNumer, 
	@Konto2TypPozabil = KontoTypPozabil,
	@Znak2 = Znak, 
	--@Dokument2 = Dokument,
	@KontoWal2 = KontoWal, 
	@KontoWal2Numer = KontoWalNumer
FROM @Nierozliczone WHERE Numer = 2


IF @@ERROR &lt;&gt; 0
BEGIN
  ROLLBACK TRAN
  RAISERROR('200:Błąd pobrania wiersza do rozrachunku', 16, 1) 
  RETURN 200
END



-- sprawdzenie waluty
IF @Waluta1 &lt;&gt; @Waluta2 --AND @Waluta1 &lt;&gt; @WalutaSys AND @Waluta2 &lt;&gt; @WalutaSys
BEGIN
  ROLLBACK TRAN
  RAISERROR('101:Niezgodne waluty rozrachunku.', 16, 1) 
  RETURN 101
END



IF @Znak1 = @Znak2 
BEGIN
  ROLLBACK TRAN
  RAISERROR('102:Zapisy księgowe wynikające z księgowania dokumentów mają konta rozrachunkowe po tej samej stronie. Rozrachunek niemożliwy.', 16, 1) 
  RETURN 102
END


IF @Konto1TypPozabil&lt;&gt;@Konto2TypPozabil
BEGIN
	ROLLBACK TRAN
	RAISERROR('102:Nie można dokonywać rozrachunku na kontach o różnych typach - bilansowe, pozabilansowe', 16, 1) 
	RETURN 102
END


SELECT 
	@Dekret3Numer = GIDNumer, 
	@Dekret3Lp = GIDLp, 
	@KwotaDTWal3 = KwotaWal, 
	@KwotaDTSys3 = KwotaSys, 
	@DataRoz3 = Data, 
	@Waluta3 = Waluta, 	
	@Dekret3DC = DC, 
	@Konto3 = Konto, 
	@Konto3Numer = KontoNumer, 
	@Konto3TypPozabil = KontoTypPozabil,
	@Znak3 = Znak, 
	@Dokument3 = Dokument,
	@KontoWal3 = KontoWal, 
	@KontoWal3Numer = KontoWalNumer
FROM @Nierozliczone WHERE Numer = 3


IF @@ERROR &lt;&gt; 0
BEGIN
  ROLLBACK TRAN
  RAISERROR('200:Błąd pobrania wiersza do rozrachunku', 16, 1) 
  RETURN 200
END


exec cdn.UstalKwoteRozliczenia 
	@Waluta1,
	@R2_KwotaWal1,
	@R2_KwotaSys,
	@KwotaDTWal1,
	@KwotaDTSys1,						
	@Waluta2,
	@R2_KwotaWal1,
	@R2_KwotaSys,
	@KwotaDTWal2,
	@KwotaDTSys2,						
	@WalutaSys,
	0,
	0,
	@poz_DecKwota,
	1,
	0,
	@Kurs1 output,
	@Kurs2 output,
	@KwotaWal output,
	@KwotaSys output,
	@RozliczenieCalkowite output,
	@RoznicaKursowa output,
	@StronaRK output,
	@BZ output,
	@RKN_Dok1KwotaSys output,
	@RKN_Dok2KwotaSys output,
	@StronaRozl output


set @BZ = @RKN_BZ


IF @R2_KwotaWal1 &gt; @KwotaWal 
BEGIN
	set @szMsg1 = convert(varchar, @R2_KwotaWal1)
	set @szMsg2 = convert(varchar, @KwotaWal)
	ROLLBACK TRAN
	RAISERROR('111:Operacja anulowana. Kwota rozliczenia %s z dokumentem %s jest większa od dopuszczalnej kwoty rozrachunku na zapisach księgowych %s ', 16, 1, @szMsg1, @Dokument2, @szMsg2) 
	RETURN 111
END


IF @R2_KwotaWal1 = @KwotaWal and @R2_KwotaSys &lt;&gt; @KwotaSys
BEGIN
	ROLLBACK TRAN
	if @StronaRK = 1
		RAISERROR('111:Operacja anulowana. Kurs na dokumencie %s jest różny od kursu na dekretacji dokumentu ', 16, 1, @Dokument2) 
	else
		RAISERROR('111:Operacja anulowana. Kurs na dokumencie %s jest różny od kursu na dekretacji dokumentu ', 16, 1, @Dokument1) 

	RETURN 111
END




if @RK_R2_KwotaSys &gt; @KwotaDTSys3
BEGIN
	ROLLBACK TRAN
	RAISERROR('111:Operacja anulowana. Kwota rozliczenia z dokumentem różnicy kursowej jest większa od dopuszczalnej kwoty rozrachunku na zapisach księgowych. ', 16, 1, @Dokument2) 
	RETURN 111
END



if @StronaRK = 2
begin
	set @KursDTL = @KursDTL1
	set @KursDTM = @KursDTM1
end
else
begin
	set @KursDTL = @KursDTL2
	set @KursDTM = @KursDTM2
end



if @DataRoz1 &gt; @DataRoz3
	set @DataRK = @DataRoz1
else
	set @DataRK = @DataRoz3




set @OldKonto1Numer = @Konto1Numer
set @OldKonto2Numer = @Konto2Numer
set @OldKonto3Numer = @Konto3Numer
set @OldKonto1 = @Konto1
set @OldKonto2 = @Konto2
set @OldKonto3 = @Konto3
set @OldKontoWal1Numer = @KontoWal1Numer
set @OldKontoWal2Numer = @KontoWal2Numer
set @OldKontoWal3Numer = @KontoWal3Numer
set @OldKontoWal1 = @KontoWal1
set @OldKontoWal2 = @KontoWal2
set @OldKontoWal3 = @KontoWal3




EXEC @KontaNieTozsame = CDN.PorownajKonta @DataRK, @Konto1Numer OUTPUT, @Konto1 OUTPUT, @Konto3Numer OUTPUT, @Konto3 OUTPUT 

if @KontaNieTozsame = -1
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. Błędne parametry procedury cdn.PorownajKonta ', 16, 1) 
	RETURN 102			
end
else if @KontaNieTozsame = 2
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe rozrachowywanych dekretów są ze sobą tożsame, pozabilansowe nie', 16, 1) 
	RETURN 102			
end
else if @KontaNieTozsame = 3
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe i pozabilansowe jednego z rozrachowywanych dekretów nie są z tego samego okresu ', 16, 1) 
	RETURN 102			
end
else if @KontaNieTozsame = 4
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. W okresie, w którym dokonywany jest rozrachunek nie istnieje konto tożsame do konta rozrachowywanego dekretu ', 16, 1) 
	RETURN 102			
end
else if @KontaNieTozsame = 5
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. Nie istnieje konto o podanym identyfikatorze ', 16, 1) 
	RETURN 102			
end
else if @KontaNieTozsame = 1
	BEGIN
	ROLLBACK TRAN
	RAISERROR('111:Operacja anulowana. Niemożliwe ustalenie konta do rozrachunku na dokumencie Różnicy Kursowej ', 16, 1, @Dokument2) 
	RETURN 111
END




set @Dod1 = 0
set @Dod3 = 0



--rozliczenie z dok RK
if @RK_StronaRozl = 1
	UPDATE CDN.Rozliczenia SET 
		R2_Dekret2Numer = @Dekret1Numer, 
		R2_Dekret2Lp = @Dekret1Lp, 
		R2_Dekret2DC = @Dekret1DC, 
		R2_Dekret2Dod = @Dod1,
	
		R2_Dekret1Numer = @Dekret3Numer, 
		R2_Dekret1Lp = @Dekret3Lp, 
		R2_Dekret1DC = @Dekret3DC, 
		R2_Dekret1Dod = @Dod3,
	
		R2_KwotaSys = @RK_R2_KwotaSys, 
		R2_KwotaWal1 = 0,
		R2_KwotaWal2 = 0,
		R2_DataRozrachunku = @DataRK,
		R2_OpeNumerRZ = @UserID
	
	WHERE R2_ID = @RK_R2_ID

else
	UPDATE CDN.Rozliczenia SET 
		R2_Dekret1Numer = @Dekret1Numer, 
		R2_Dekret1Lp = @Dekret1Lp, 
		R2_Dekret1DC = @Dekret1DC, 
		R2_Dekret1Dod = @Dod1,
	
		R2_Dekret2Numer = @Dekret3Numer, 
		R2_Dekret2Lp = @Dekret3Lp, 
		R2_Dekret2DC = @Dekret3DC, 
		R2_Dekret2Dod = @Dod3,
	
		R2_KwotaSys = @RK_R2_KwotaSys, 
		R2_KwotaWal1 = 0,
		R2_KwotaWal2 = 0,
		R2_DataRozrachunku = @DataRK,
		R2_OpeNumerRZ = @UserID
	
	WHERE R2_ID = @RK_R2_ID



IF @@ERROR &lt;&gt; 0
BEGIN
	ROLLBACK TRAN
	RAISERROR('102:Błąd aktualizacji rozrachunku z dekretem różnicy kursowej', 16, 1) 
	RETURN 102
END



---------- dekret kompensacyjny ------------
set @DataRozliczenia = @R2_DataRozliczenia	


SELECT @DataDzisiejszaKomp = ISNULL(KON_Wartosc,0) FROM CDN.Konfig with(nolock) WHERE KON_Numer = 2058



IF @DataDzisiejszaKomp = 2
	IF @Termin1 &lt; @Termin2
		SET @DataKomp = @Termin2
	ELSE
		SET @DataKomp = @Termin1
ELSE
	IF @DataRoz1 &lt; @DataRoz2
		SET @DataKomp = @DataRoz2
	ELSE
		SET @DataKomp = @DataRoz1




IF @DataDzisiejszaKomp = 1 and @DataKomp &lt; @DataDzisiejsza
	SET @DataKomp = @DataDzisiejsza  



if @DataKomp &lt; @DataRozliczenia 
	SET @DataKomp = @DataRozliczenia
	
		


--ustal date rozrachunku
if @DataRoz1 &lt; @DataRoz2
	set @DataRozrachunku = @DataRoz2
else
	set @DataRozrachunku = @DataRoz1



if @DataKomp &lt; @DataRozrachunku 
	SET @DataKomp = @DataRozrachunku



set @Konto1Numer = @OldKonto1Numer
set @Konto2Numer = @OldKonto2Numer
set @Konto1 = @OldKonto1
set @Konto2 = @OldKonto2
set @KontoWal1Numer = @OldKontoWal1Numer
set @KontoWal2Numer = @OldKontoWal2Numer
set @KontoWal1 = @OldKontoWal1
set @KontoWal2 = @OldKontoWal2




EXEC @KontaNieTozsame = CDN.PorownajKonta @DataKomp, @Konto1Numer OUTPUT, @Konto1 OUTPUT, @Konto2Numer OUTPUT, @Konto2 OUTPUT, @KontoWal1Numer OUTPUT, @KontoWal1 OUTPUT, @KontoWal2Numer OUTPUT, @KontoWal2 OUTPUT


if @KontaNieTozsame = -1
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. Błędne parametry procedury cdn.PorownajKonta ', 16, 1) 
	RETURN 102			
end
else if @KontaNieTozsame = 2
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe rozrachowywanych dekretów są ze sobą tożsame, pozabilansowe nie', 16, 1) 
	RETURN 102			
end
else if @KontaNieTozsame = 3
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe i pozabilansowe jednego z rozrachowywanych dekretów nie są z tego samego okresu ', 16, 1) 
	RETURN 102			
end
else if @KontaNieTozsame = 4
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. W okresie, w którym dokonywany jest rozrachunek nie istnieje konto tożsame do konta rozrachowywanego dekretu ', 16, 1) 
	RETURN 102			
end
else if @KontaNieTozsame = 5
begin
	ROLLBACK TRAN
	RAISERROR('102:Błąd sprawdzania tożsamości kont. Nie istnieje konto o podanym identyfikatorze ', 16, 1) 
	RETURN 102			
end
else if @KontaNieTozsame = 1
BEGIN

	SET @OpisKompensaty = 'Kompensata: ' + RTRIM( @Dokument1 ) + ' - ' + RTRIM( @Dokument2 )


	if @DataKomp &gt; @DataRozrachunku 
	begin
		SET @DataRozrachunku = @DataKomp

		set @Konto1Numer = @OldKonto1Numer
		set @Konto2Numer = @OldKonto2Numer
		set @Konto1 = @OldKonto1
		set @Konto2 = @OldKonto2
		set @KontoWal1Numer = @OldKontoWal1Numer
		set @KontoWal2Numer = @OldKontoWal2Numer
		set @KontoWal1 = @OldKontoWal1
		set @KontoWal2 = @OldKontoWal2



	  	EXEC @KontaNieTozsame = CDN.PorownajKonta @DataRozrachunku, @Konto1Numer OUTPUT, @Konto1 OUTPUT, @Konto2Numer OUTPUT, @Konto2 OUTPUT, @KontoWal1Numer OUTPUT, @KontoWal1 OUTPUT, @KontoWal2Numer OUTPUT, @KontoWal2 OUTPUT

		
		--tutaj powinny co najwyzej byc bledy 1, 4
		if @KontaNieTozsame = -1
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. Błędne parametry procedury cdn.PorownajKonta ', 16, 1) 
			RETURN 102			
		end
		else if @KontaNieTozsame = 2
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe rozrachowywanych dekretów są ze sobą tożsame, pozabilansowe nie', 16, 1) 
			RETURN 102			
		end
		else if @KontaNieTozsame = 3
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe i pozabilansowe jednego z rozrachowywanych dekretów nie są z tego samego okresu ', 16, 1) 
			RETURN 102			
		end
		else if @KontaNieTozsame = 4
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. W okresie, w którym dokonywany jest rozrachunek z dekretem kompensacyjnym nie istnieje konto tożsame do konta rozrachowywanego dekretu ', 16, 1) 
			RETURN 102			
		end
		else if @KontaNieTozsame = 5
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. Nie istnieje konto o podanym identyfikatorze ', 16, 1) 
			RETURN 102			
		end
		--else if @KontaNieTozsame = 1
		--begin

		--end
	end


	IF @Znak1 = 1
	BEGIN
		EXEC CDN.DodajKompensate @GIDFirma, @DataRozrachunku, @UserID, @R2_KwotaSys, @WalutaSys, 
		      @Konto2, @Konto2Numer, @Konto1, @Konto1Numer,  
		      @R2_KwotaWal1, @KontoWal2, @KontoWal2Numer,  @Waluta2,
		      @R2_KwotaWal1, @KontoWal1, @KontoWal1Numer,  @Waluta1, @KursDTL, @KursDTM,
		      @OpisKompensaty, @KompGIDNumer OUTPUT, @DataDzisiejsza
	END
	ELSE
	BEGIN
	 	EXEC CDN.DodajKompensate @GIDFirma, @DataRozrachunku, @UserID, @R2_KwotaSys, @WalutaSys, 
		      @Konto1, @Konto1Numer,  @Konto2, @Konto2Numer,  
		      @R2_KwotaWal1, @KontoWal1, @KontoWal1Numer,  @Waluta1,
		      @R2_KwotaWal1, @KontoWal2, @KontoWal2Numer,  @Waluta2, @KursDTL, @KursDTM,
		      @OpisKompensaty, @KompGIDNumer OUTPUT, @DataDzisiejsza
	END


	IF @@TRANCOUNT = 0
		RETURN 0




	INSERT INTO CDN.Rozliczenia(
	  R2_Dekret1Numer, R2_Dekret1Lp, R2_Dekret1DC, R2_Waluta1, R2_KwotaWal1, 
	  R2_Dekret2Numer, R2_Dekret2Lp, R2_Dekret2DC, R2_Waluta2, R2_KwotaWal2, 
	  R2_KwotaSys, R2_DataRozrachunku, R2_OpeNumerRZ, 
	  R2_GIDFirma, R2_Dekret1Dod, R2_Dekret2Dod, R2_ParID,
	  R2_Wycena, 
	  R2_PozostajeZWyc, 
	  R2_PozostajeZWycSys, 
	  R2_WycenaParID ) 
	VALUES( 
	  @Dekret1Numer, @Dekret1Lp, @Dekret1DC, @Waluta1, @R2_KwotaWal1, 
	  @KompGIDNumer, 1, 3-@Znak1, @Waluta2, @R2_KwotaWal1, 
	  @R2_KwotaSys, @DataRozrachunku, @UserID,
	  @GIDFirma, 0, 1, @R2_ParID,
	  @Wycena,
	  0,
	  0,
	  @R2_WycenaParID )


	IF @@ERROR &lt;&gt; 0
	BEGIN
		ROLLBACK TRAN
		RAISERROR('102:Błąd dodania rozrachunku z dekretem kompensacyjnym', 16, 1) 
		RETURN 102
	END




	SET @Dekret1Numer = @KompGIDNumer
	SET @Dekret1Lp = 1
	SET @Dekret1DC = @Znak1
	SET @Dod1 = 1

	SET @Dod2 = 0
end



if @r2_strona = 1
begin
	UPDATE CDN.Rozliczenia SET 
		R2_Dekret1Numer = @Dekret1Numer, 
		R2_Dekret1Lp = @Dekret1Lp, 
		R2_Dekret1DC = @Dekret1DC, 
		R2_Dekret1Dod = @Dod1,
		R2_Dekret2Numer = @Dekret2Numer, 
		R2_Dekret2Lp = @Dekret2Lp, 
		R2_Dekret2DC = @Dekret2DC, 
		R2_Dekret2Dod = @Dod2,
		R2_KwotaSys = @R2_KwotaSys, 
		R2_KwotaWal1 = @R2_KwotaWal1, 
		R2_KwotaWal2 = @R2_KwotaWal1,
		R2_DataRozrachunku = @DataRozrachunku,
		R2_OpeNumerRZ = @UserID
	WHERE R2_ID = @R2_ID
end
else	
begin
	UPDATE CDN.Rozliczenia SET 
		R2_Dekret1Numer = @Dekret2Numer, 
		R2_Dekret1Lp = @Dekret2Lp, 
		R2_Dekret1DC = @Dekret2DC, 
		R2_Dekret1Dod = @Dod2,
		R2_Dekret2Numer = @Dekret1Numer, 
		R2_Dekret2Lp = @Dekret1Lp, 
		R2_Dekret2DC = @Dekret1DC, 
		R2_Dekret2Dod = @Dod1,
		R2_KwotaSys = @R2_KwotaSys, 
		R2_KwotaWal1 = @R2_KwotaWal1, 
		R2_KwotaWal2 = @R2_KwotaWal1,
		R2_DataRozrachunku = @DataRozrachunku,
		R2_OpeNumerRZ = @UserID
	WHERE R2_ID = @R2_ID
end



IF @@ERROR &lt;&gt; 0
BEGIN
	ROLLBACK TRAN
	RAISERROR('102:Błąd aktualizacji rozrachunku z dekretem kompensacyjnym', 16, 1) 
	RETURN 102
END





--aktualizuj kwoty pozostaje na dekretach

--dekret kompensacyjny
if @KompGIDNumer &lt;&gt; 0
begin
	UPDATE CDN.Dekrety SET 
		DT_Pozostaje = DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @R2_KwotaSys ELSE @R2_KwotaWal1 END,
  		DT_Rozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @R2_KwotaSys ELSE @R2_KwotaWal1 END = DT_Kwota THEN 0 ELSE 1 END,
  		DT_Nierozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @R2_KwotaSys ELSE @R2_KwotaWal1 END = 0 THEN 0 ELSE 1 END
  	WHERE DT_GIDNumer = @KompGIDNumer AND DT_GIDLp = 1 --AND DT_DC = 3-@Znak1


  	IF @@ERROR &lt;&gt; 0
  	BEGIN
    		ROLLBACK TRAN
    		RAISERROR('202:Błąd aktualizacji tabeli dekrety', 16, 1) 
    		RETURN 202
  	END
end		



--dekret 2 dokumentu
UPDATE CDN.Dekrety SET 
	DT_Pozostaje = DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @R2_KwotaSys ELSE @R2_KwotaWal1 END,
  	DT_Rozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @R2_KwotaSys ELSE @R2_KwotaWal1 END = DT_Kwota THEN 0 ELSE 1 END,
  	DT_Nierozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @R2_KwotaSys ELSE @R2_KwotaWal1 END = 0 THEN 0 ELSE 1 END
WHERE DT_GIDNumer = @Dekret2Numer AND DT_GIDLp = @Dekret2Lp AND DT_DC = @Dekret2DC


IF @@ERROR &lt;&gt; 0
BEGIN
    ROLLBACK TRAN
    RAISERROR('202:Błąd aktualizacji tabeli dekrety', 16, 1) 
    RETURN 202
END




set @Dekret1Numer = @SavDekret1Numer
set @Dekret1Lp = @SavDekret1Lp
set @Dekret1DC = @SavDekret1DC


--dekret dokumentu 1
UPDATE CDN.Dekrety SET 
	DT_Pozostaje = DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @R2_KwotaSys + @RK_R2_KwotaSys ELSE @R2_KwotaWal1 END,
  	DT_Rozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @R2_KwotaSys + @RK_R2_KwotaSys ELSE @R2_KwotaWal1 END = DT_Kwota THEN 0 ELSE 1 END,
  	DT_Nierozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @R2_KwotaSys + @RK_R2_KwotaSys ELSE @R2_KwotaWal1 END = 0 THEN 0 ELSE 1 END
WHERE DT_GIDNumer = @Dekret1Numer AND DT_GIDLp = @Dekret1Lp AND DT_DC = @Dekret1DC

IF @@ERROR &lt;&gt; 0
BEGIN
    ROLLBACK TRAN
    RAISERROR('202:Błąd aktualizacji tabeli dekrety', 16, 1) 
    RETURN 202
END




--dekret roznicy kursowej
UPDATE CDN.Dekrety SET 
	DT_Pozostaje = DT_Pozostaje - SIGN(DT_Kwota) * @RK_R2_KwotaSys,
  	DT_Rozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * @RK_R2_KwotaSys = DT_Kwota THEN 0 ELSE 1 END,
  	DT_Nierozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * @RK_R2_KwotaSys = 0 THEN 0 ELSE 1 END
WHERE DT_GIDNumer = @Dekret3Numer AND DT_GIDLp = @Dekret3Lp AND DT_DC = @Dekret3DC and DT_WalutaObca = 0

IF @@ERROR &lt;&gt; 0
BEGIN
    ROLLBACK TRAN
    RAISERROR('202:Błąd aktualizacji tabeli dekrety.', 16, 1) 
    RETURN 202
END



lKoniecRozrachunku:

-- koniec transakcji i powrót
COMMIT TRAN
SET NOCOUNT OFF

</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="Przyznanie praw do procedury SkojarzDokumentRK"></A><PRE>
          <FONT SIZE="2"><I>/* Przyznanie praw do procedury SkojarzDokumentRK */</I><BR>
GRANT EXECUTE ON CDN.SkojarzDokumentRK TO CDNRaport
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>