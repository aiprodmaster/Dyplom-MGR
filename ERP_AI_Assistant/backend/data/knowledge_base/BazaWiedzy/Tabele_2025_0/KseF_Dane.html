<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="KSeF_Dane"></A><PRE>
          <FONT SIZE="2"><I>/* KSeF_Dane */</I><BR>
CREATE  PROCEDURE CDN.KSeF_Dane
(
	@GidNumer int,
	@GidTyp SMALLINT
)
AS
BEGIN
CREATE TABLE #DANE 
(	
	GidNumer int,
	GidTyp SMALLINT, 
	PodatnikPrefiksNIP VARCHAR(2),	
	PodatnikNIP VARCHAR(20),		
	PodatnikImiePierwsze VARCHAR(30),
	PodatnikNazwisko VARCHAR(81),
	PodatnikPelnaNazwa VARCHAR(127),
	PodatnikKodKraju VARCHAR(2),
	PodatnikWojewodztwo VARCHAR(20),	
	PodatnikPowiat VARCHAR(36),	
	PodatnikGmina VARCHAR(20),	
	PodatnikUlica VARCHAR(30),
	PodatnikNrDomu VARCHAR(10),
	PodatnikNrLokalu VARCHAR(10),
	PodatnikMiejscowosc VARCHAR(30),
	PodatnikKodPocztowy VARCHAR(10),
	PodatnikPoczta VARCHAR(30),
	PodatnikGLN VARCHAR(13),	
	PodatnikEmail VARCHAR(40),	
	PodatnikTel VARCHAR(16),	
	NabywcaPrefiksNIP VARCHAR(2),
	NabywcaNIP VARCHAR(50),
	NabywcaNrID VARCHAR(20),
	NabywcaBrakID VARCHAR(1),
	NabywcaImiePierwsze VARCHAR(30),
	NabywcaNazwisko VARCHAR(81),
	NabywcaPelnaNazwa VARCHAR(256),		
	NabywcaKodKraju VARCHAR(2),
	NabywcaWojewodztwo VARCHAR(30),		
	NabywcaPowiat VARCHAR(30),		
	NabywcaGmina VARCHAR(30),		
	NabywcaUlica VARCHAR(30),
	NabywcaNrDomu VARCHAR(9),
	NabywcaNrLokalu VARCHAR(10),
	NabywcaMiejscowosc VARCHAR(30),
	NabywcaKodPocztowy VARCHAR(10),
	NabywcaGLN VARCHAR(13),		
	NabywcaPoczta VARCHAR(30),
	NabywcaEmail VARCHAR(255),	
	NabywcaTel VARCHAR(30),		
	KodWaluty VARCHAR(3),
	DataWystawienia INTEGER,		
	NumerFaktury VARCHAR(40),		
	DataDostawy INTEGER,			
	SumaNettoStawkaPodstawowa decimal(18,2),		
	SumaVATStawkaPodstawowa decimal(18,2),			
	SumaVATStawkaPodstawowaPLN decimal(18,2),		
	SumaNettoStawkaObnizona decimal(18,2),			
	SumaVATStawkaObnizona decimal(18,2),			
	SumaVATStawkaObnizonaPLN decimal(18,2),			
	SumaNettoStawkaObnizonaDruga decimal(18,2),		
	SumaVATStawkaObnizonaDruga decimal(18,2),		
	SumaVATStawkaObnizonaDrugaPLN decimal(18,2),	
	SumaNettoStawkaObnizonaTrzecia decimal(18,2),	
	SumaVATStawkaObnizonaTrzecia decimal(18,2),		
	SumaVATStawkaObnizonaTrzeciaPLN decimal(18,2),	
	SumaNettoStawkiExportowe decimal(18,2),			
	SumaVATOSS decimal(18,2),					
	SumaNetto0 decimal(18,2),					
	SumaNettoZW decimal(18,2),					
	SumaBrutto decimal(18,2),					
	MetodaKasowa VARCHAR(1),		
	Samofakturowanie VARCHAR(1),		
	OdwrotneObciazenie VARCHAR(1),		
	PodzielonaPlatnosc VARCHAR(1),		
	SprzedazZwolniona VARCHAR(1),		
	SprzedazZWUstawa VARCHAR(256),				
	SprzedazZWDyrektywa VARCHAR(256),			
	SprzedazZWPodstawa VARCHAR(256),			
	NSTWDT VARCHAR(1),		
	NSTDataDopuszczenia VARCHAR(512),			
	NSTPrzebieg VARCHAR(512),					
	NSTPlywGodzRobocze VARCHAR(512),			
	NSTPowGodzRobocze VARCHAR(512),				
	FakturaUproszczona VARCHAR(1),		
	FakturaVATMarza VARCHAR(1),		
	MarzaBiuraPodrozy VARCHAR(1),
	MarzaTowaryUzywane VARCHAR(1),
	MarzaDzielaSztuki VARCHAR(1),
	MarzaKolekcjonerskieAntyki VARCHAR(1),
	RodzajFaktury VARCHAR(256),		
	PrzyczynaKorekty VARCHAR(255),		
	OkresFaKorygowanej VARCHAR(256),					
	FakturaLiczbaWierszy VARCHAR(10),
	SumaNettoElementow decimal(18,2),
	SumaBruttoElementow decimal(18,2),
	SpiNumer INTEGER,
	FakturaDoParagonu VARCHAR(1),		
	FakturaPowiazanyNabywca VARCHAR(1),	
	DodatkowyOpisKlucz VARCHAR(5),		
	DodatkowyOpisWartosc VARCHAR(256),	
	StopkaFaktury VARCHAR(512),			
	StopkaKRS VARCHAR(11),				
	StopkaREGON VARCHAR(20),			
	StopkaBDO VARCHAR(20),
	FlagaNB VARCHAR(1)

)
create clustered index DanePrimary on #Dane (gidNumer,gidTyp)

create table #DaneWiersz 
(	
	ElementLp INTEGER,
	ElementNazwa VARCHAR(255),			
	ElementJM VARCHAR(8),				
	ElementIlosc decimal(18,4),			
	ElementCenaNetto decimal(18,2),		
	ElementCenaBrutto decimal(18,2),	
	ElementWartoscNetto decimal(18,2),	
	ElementWartoscBrutto decimal(18,2),	
	ElementStawkaVAT VARCHAR(8),		
	ElementStawkaVATOSS decimal(9,6),	
	wierszGidNumer INTEGER,
	wierszGidTyp SMALLINT,
	wierszGidLp SMALLINT,
	wierszSpiNumer INTEGER,
	wierszSpiTyp SMALLINT,
	wierszSpiLp SMALLINT,
	CzySpinacz TINYINT,
	ElementKodCN VARCHAR(10),	
	ElementOpis	VARCHAR(3999)	
)
create clustered index DaneWierszPrimary on #DaneWiersz (wierszGidNumer)

CREATE TABLE #StawkiVatZ (
	TRV_numer					int,
	TRV_typ						smallint,
	TRV_VatR_stawka_4			decimal(18,2),	
	TRV_NettoR_stawka_5			decimal(18,2), 
	TRV_VatR_stawka_5_pln		decimal(18,2), 
	TRV_VatR_stawka_5			decimal(18,2),	
	TRV_NettoR_stawka_7_8		decimal(18,2), 
	TRV_VatR_stawka_7_8_pln     decimal(18,2), 
	TRV_VatR_stawka_7_8			decimal(18,2),	
	TRV_NettoR_stawka_22_23		decimal(18,2), 
	TRV_VatR_stawka_22_23_pln	decimal(18,2), 
	TRV_VatR_stawka_22_23		decimal(18,2),	
	TRV_NettoR_flaga2_oo		decimal(18,2), 
	TRV_VatR_flaga2_oo_pln      decimal(18,2), 
	TRV_NettoR_flaga2			decimal(18,2),	
	TRV_NettoR_stawka_0_flaga1	decimal(18,2),	
	TRV_NettoR_flaga0			decimal(18,2),	
	TRV_VAT_DOPTK				decimal(18,2)	
	)
create clustered index StawkiVatZPrimary on #StawkiVatZ (TRV_numer,TRV_typ)

CREATE TABLE #Atrybuty_Ksef (
	ATR_GIDNUMER		INT,	
	ATR_P_22A			VARCHAR(512),	
	ATR_P_22B			VARCHAR(512),	
	ATR_P_22C			VARCHAR(512),	
	ATR_KSEF_P_22A		VARCHAR(512),	
	ATR_KSEF_P_22B		VARCHAR(512),	
	ATR_KSEF_P_22C		VARCHAR(512),	
	ATR_KSEF_P_22D		VARCHAR(512),	
	ATR_P_23			NVARCHAR(5),	
	ATR_KSEF_P_23		NVARCHAR(5),	
	ATR_P_PMarzy_3_1	NVARCHAR(5),	
	ATR_P_PMarzy_3_2	NVARCHAR(5),	
	ATR_P_PMarzy_3_3	NVARCHAR(5),	
	ATR_P_16			NVARCHAR(5),	
	ATR_KSEF_P_16		NVARCHAR(5),	
	ATR_P_17			NVARCHAR(5),	
	ATR_KSEF_P_17		NVARCHAR(5),	
	ATR_P_22			NVARCHAR(5),		
	ATR_KSEF_P_22		NVARCHAR(5),		
	ATR_KSEF_Nabywca_NrID	NVARCHAR(50),	
	ATR_KSEF_Nabywca_ImiePierwsze NVARCHAR(30),	
	ATR_KSEF_Nabywca_Nazwisko NVARCHAR(81),	
	ATR_KSEF_Nabywca_Ulica VARCHAR(30),	
	ATR_KSEF_Nabywca_NrDomu VARCHAR(9),	
	ATR_KSEF_Nabywca_NrLokalu VARCHAR(10),
	ATR_KSEF_Odbiorca_NrID	NVARCHAR(50),	
	ATR_KSEF_Odbiorca_ImiePierwsze NVARCHAR(30),	
	ATR_KSEF_Odbiorca_Nazwisko NVARCHAR(81),	
	ATR_KSEF_Odbiorca_Ulica VARCHAR(30),	
	ATR_KSEF_Odbiorca_NrDomu VARCHAR(9),	
	ATR_KSEF_Odbiorca_NrLokalu VARCHAR(10),
	ATR_KSEF_Platnik_NrID	NVARCHAR(50),	
	ATR_KSEF_Platnik_ImiePierwsze NVARCHAR(30),	
	ATR_KSEF_Platnik_Nazwisko NVARCHAR(81),	
	ATR_KSEF_Platnik_Ulica VARCHAR(30),	
	ATR_KSEF_Platnik_NrDomu VARCHAR(9),	
	ATR_KSEF_Platnik_NrLokalu VARCHAR(10)	
	)
create clustered index Atrybuty_KSeFPrimary on #Atrybuty_Ksef (ATR_GIDNUMER)

CREATE TABLE #Atrybuty_KsefKorygowanych (
	ATR_KSEFKorygowanych_GIDNUMER INT,
	ATR_KSEFKorygowanych_Nabywca_NrID	NVARCHAR(50),	
	ATR_KSEFKorygowanych_Nabywca_ImiePierwsze NVARCHAR(30),	
	ATR_KSEFKorygowanych_Nabywca_Nazwisko NVARCHAR(81),	
	ATR_KSEFKorygowanych_Nabywca_Ulica VARCHAR(30),	
	ATR_KSEFKorygowanych_Nabywca_NrDomu VARCHAR(9),	
	ATR_KSEFKorygowanych_Nabywca_NrLokalu VARCHAR(10)
)
create clustered index Atrybuty_KSeFKorygowanychPrimary on #Atrybuty_KsefKorygowanych (ATR_KSEFKorygowanych_GIDNUMER)

CREATE TABLE #FakturyZaliczkowe (
	FZ_GidNumer		INT,	
	FZ_GidTyp		smallint,
	FZ_FakturaZaliczkowaNumer VARCHAR(40)
	)
create clustered index FakturyZaliczkowePrimary on #FakturyZaliczkowe (FZ_GidNumer)

CREATE TABLE #DaneFaKorygowanej (
	DFK_GidNumer		INT,	
	DFK_GidTyp		smallint,
	DFK_DataWystFaKorygowanej INTEGER,	
	DFK_NrFaKorygowanej VARCHAR(40),	
	DFK_NrKSeFFaKorygowanej VARCHAR(40)
	)
create clustered index #DaneFaKorygowanejPrimary on #DaneFaKorygowanej (DFK_GidNumer)

CREATE TABLE #Podmiot3 (
	P3_Podmiot3Rola VARCHAR(1),	
	P3_Podmiot3NIP VARCHAR(50),	
	P3_Podmiot3NrID VARCHAR(20),	
	P3_Podmiot3BrakID VARCHAR(1),	
	P3_Podmiot3ImiePierwsze VARCHAR(30),	
	P3_Podmiot3Nazwisko VARCHAR(81),	
	P3_Podmiot3PelnaNazwa VARCHAR(256),	
	P3_Podmiot3KodKraju VARCHAR(2),	
	P3_Podmiot3Wojewodztwo VARCHAR(30),	
	P3_Podmiot3Powiat VARCHAR(30),		
	P3_Podmiot3Gmina VARCHAR(30),		
	P3_Podmiot3Ulica VARCHAR(30),	
	P3_Podmiot3NrDomu VARCHAR(9),	
	P3_Podmiot3NrLokalu VARCHAR(10),	
	P3_Podmiot3Miejscowosc VARCHAR(30),	
	P3_Podmiot3KodPocztowy VARCHAR(10),	
	P3_Podmiot3Poczta VARCHAR(30),		
	P3_Podmiot3GLN VARCHAR(13),		
	P3_Podmiot3Email VARCHAR(255),		
	P3_Podmiot3Tel VARCHAR(30)	
	)
CREATE TABLE #Podmiot2K(
	P2K_KorDanychNabywcaPrefiksNIP VARCHAR(2),	
	P2K_KorDanychNabywcaNIP VARCHAR(50),		
	P2K_KorDanychNabywcaNrID VARCHAR(20),		
	P2K_KorDanychNabywcaBrakID VARCHAR(1),		
	P2K_KorDanychNabywcaImiePierwsze VARCHAR(30),	
	P2K_KorDanychNabywcaNazwisko VARCHAR(81),	
	P2K_KorDanychNabywcaPelnaNazwa VARCHAR(256),	
	P2K_KorDanychNabywcaKodKraju VARCHAR(2),	
	P2K_KorDanychNabywcaWojewodztwo VARCHAR(30),	
	P2K_KorDanychNabywcaPowiat VARCHAR(30),		
	P2K_KorDanychNabywcaGmina VARCHAR(30),		
	P2K_KorDanychNabywcaUlica VARCHAR(30),		
	P2K_KorDanychNabywcaNrDomu VARCHAR(9),		
	P2K_KorDanychNabywcaNrLokalu VARCHAR(10),	
	P2K_KorDanychNabywcaMiejscowosc VARCHAR(30),	
	P2K_KorDanychNabywcaKodPocztowy VARCHAR(10),	
	P2K_KorDanychNabywcaPoczta VARCHAR(30),		
	P2K_KorDanychNabywcaGLN VARCHAR(13)			
	)
CREATE TABLE #ZamowienieNumer(
	ZN_GidNumer		INT,	
	ZN_GidTyp		smallint,
	ZN_NrZamowienia VARCHAR(40)
)
CREATE TABLE #NumeryWZ(
	NW_GidNumer		INT,	
	NW_GidTyp		smallint,
	NW_NumerWZ VARCHAR(40)
)
CREATE TABLE #PartieTmp(
	DokGIDTyp		SMALLINT,
	DokGIDNumer		INT,
	kodTowaru		VARCHAR(40),
	cecha			VARCHAR(255),
	ean				VARCHAR(40),
	DataW			INT
)
CREATE TABLE #Partie(
	NrPartiiTowaru	VARCHAR(350)
)

declare
	@walutaSys		VARCHAR(512),
	@InterpretujTransDostOpodatkPozaTerytKrajWSt0JakoKrajowa VARCHAR(512) = (select isnull((select kon_wartosc from cdn.konfig where Kon_Numer=20143),0)),
	@sSQL nvarchar(max),
	@fz_tmp int,
	@CzyWysylacOpisElementowFaktury VARCHAR(512) = (select isnull((select kon_wartosc from cdn.konfig where Kon_Numer=7416),0)),
	@CzyJednostkaPomocnicza VARCHAR(512) = (select isnull((select kon_wartosc from cdn.konfig where Kon_Numer=7415),0)),
	@nrZ_tmp int,
	@nw_tmp int,
	@id int,
	@ilosc decimal(18,4),
	@czyKorektaReczna smallint,
	@czyKorektaCI smallint,
	@czyKorekta tinyint,
	@gidNumerOrg int,
	@gidTypOrg smallint,
	@wierszGidNumer INTEGER,
	@wierszGidTyp SMALLINT,
	@wierszGidLp SMALLINT,
	@spiNumer INTEGER = (select TrN_SpiNumer from cdn.TraNag where TrN_GIDNumer = @GidNumer and TrN_GIDTyp = @GidTyp),
	@spiTyp SMALLINT = (select TrN_SpiTyp from cdn.TraNag where TrN_GIDNumer = @GidNumer and TrN_GIDTyp = @GidTyp),
	@TMPTYP SMALLINT,
	@TMPNUMER INT,
	@NrPartiiTowaruTMP VARCHAR(350),
	@kodTowaruTMP VARCHAR(40),
	@cechaTMP VARCHAR(255),
	@eanTMP VARCHAR(40),
	@DataWTMP INT,
	@CzyWysylacNrPartii VARCHAR(512) = (select isnull((select kon_wartosc from cdn.konfig where Kon_Numer=7419),0)),
	@CzyWysylacSystemowyNrDok VARCHAR(512) = (select isnull((select kon_wartosc from cdn.konfig where Kon_Numer=7417),0))

declare wierszeKursor cursor
	for select wierszGidNumer, wierszGidTyp, wierszGidLp from #DaneWiersz;
declare kursorPartie CURSOR 
	FOR SELECT * FROM #PartieTmp;

	--pobieranie numeru oryginału korekty dokumentu handlowego (bez korekt zbiorczych i ręcznych)
	    IF exists (SELECT * FROM CDN.TraNag WHERE TrN_GIDNumer = @GidNumer and TrN_GIDTyp = @GidTyp 
		and ((TrN_ZwrNumer &lt;&gt; TrN_GIDNumer and TrN_ZwrNumer &lt;&gt; 0) or (TrN_ZwrNumer &lt;&gt; TrN_GIDNumer and TrN_ZwrTyp &lt;&gt; TrN_GIDTyp)))
	BEGIN
		IF (@GidTyp&amp;8 = 0)
		BEGIN
			SET @czyKorekta = 0
		END
		ELSE
		BEGIN
			SET @gidNumerOrg = @GidNumer
			SET @gidTypOrg = @GidTyp
			SET @czyKorekta = 1
		END
		WHILE @czyKorekta = 1
		BEGIN
			SELECT @gidNumerOrg = TrN_ZwrNumer, @gidTypOrg = TrN_ZwrTyp FROM CDN.TraNag WHERE TrN_GIDNumer = @gidNumerOrg and TrN_GIDTyp = @gidTypOrg
			IF (@gidTypOrg&amp;8 = 0)
			BEGIN
				SET @czyKorekta = 0
			END
		END
	END

SELECT @walutaSys = Kon_Wartosc FROM CDN.Konfig WHERE Kon_Numer=211

INSERT INTO #StawkiVatZ(TRV_numer,TRV_typ) values (@GidNumer, @Gidtyp)

INSERT INTO  #Atrybuty_Ksef select
	trv_numer,
	/*ATR_P_22A*/(SELECT TOP 1 Atr_Wartosc FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'JPK_P_22A' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_P_22B*/(SELECT TOP 1 Atr_Wartosc FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'JPK_P_22B' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_P_22C*/(SELECT TOP 1 Atr_Wartosc FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'JPK_P_22C' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_P_22A*/(SELECT TOP 1 Atr_Wartosc FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_P_22A' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_P_22B*/(SELECT TOP 1 Atr_Wartosc FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_P_22B' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_P_22C*/(SELECT TOP 1 Atr_Wartosc FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_P_22C' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_P_22D*/(SELECT TOP 1 Atr_Wartosc FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_P_22D' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_P_23*/(SELECT TOP 1 case when Atr_Wartosc ='TAK' OR Atr_Wartosc ='YES'  then 'true' else 'false' end  FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'JPK_P_23' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_P_23*/(SELECT TOP 1 case when Atr_Wartosc ='TAK' OR Atr_Wartosc ='YES'  then 'true' else 'false' end  FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_P_23' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_P_PMarzy_3_1*/(SELECT TOP 1 case when Atr_Wartosc ='TAK' OR Atr_Wartosc ='YES'  then 'true' else 'false' end  FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_P_PMarzy_3_1' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_P_PMarzy_3_2*/(SELECT TOP 1 case when Atr_Wartosc ='TAK' OR Atr_Wartosc ='YES'  then 'true' else 'false' end  FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_P_PMarzy_3_2' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_P_PMarzy_3_3*/(SELECT TOP 1 case when Atr_Wartosc ='TAK' OR Atr_Wartosc ='YES'  then 'true' else 'false' end  FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_P_PMarzy_3_3' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_P_16*/(SELECT TOP 1 case when Atr_Wartosc ='TAK' OR Atr_Wartosc ='YES'  then 'true' else 'false' end  FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'JPK_P_16' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_P_16*/(SELECT TOP 1 case when Atr_Wartosc ='TAK' OR Atr_Wartosc ='YES'  then 'true' else 'false' end  FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_P_16' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_P_17*/(SELECT TOP 1 case when Atr_Wartosc ='TAK' OR Atr_Wartosc ='YES'  then 'true' else 'false' end  FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'JPK_P_17' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_P_17*/(SELECT TOP 1 case when Atr_Wartosc ='TAK' OR Atr_Wartosc ='YES'  then 'true' else 'false' end  FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_P_17' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_P_22*/(SELECT TOP 1 case when Atr_Wartosc ='TAK' OR Atr_Wartosc ='YES'  then 'true' else 'false' end  FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'JPK_P_22' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_P_22*/(SELECT TOP 1 case when Atr_Wartosc ='TAK' OR Atr_Wartosc ='YES'  then 'true' else 'false' end  FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_P_22' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Nabywca_NrID*/(SELECT TOP 1 left(Atr_Wartosc,50) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Nabywca_NrID' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Nabywca_ImiePierwsze*/(SELECT TOP 1 left(Atr_Wartosc,30) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Nabywca_ImiePierwsze' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Nabywca_Nazwisko*/(SELECT TOP 1 left(Atr_Wartosc,81) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Nabywca_Nazwisko' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Nabywca_Ulica*/(SELECT TOP 1 left(Atr_Wartosc,30) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Nabywca_Ulica' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Nabywca_NrDomu*/(SELECT TOP 1 left(Atr_Wartosc,9) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Nabywca_NrDomu' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Nabywca_NrLokalu*/(SELECT TOP 1 left(Atr_Wartosc,10) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Nabywca_NrLokalu' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Odbiorca_NrID*/(SELECT TOP 1 left(Atr_Wartosc,50) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Odbiorca_NrID' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Odbiorca_ImiePierwsze*/(SELECT TOP 1 left(Atr_Wartosc,30) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Odbiorca_ImiePierwsze' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Odbiorca_Nazwisko*/(SELECT TOP 1 left(Atr_Wartosc,81) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Odbiorca_Nazwisko' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Odbiorca_Ulica*/(SELECT TOP 1 left(Atr_Wartosc,30) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Odbiorca_Ulica' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Odbiorca_NrDomu*/(SELECT TOP 1 left(Atr_Wartosc,9) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Odbiorca_NrDomu' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Odbiorca_NrLokalu*/(SELECT TOP 1 left(Atr_Wartosc,10) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Odbiorca_NrLokalu' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Platnik_NrID*/(SELECT TOP 1 left(Atr_Wartosc,50) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Platnik_NrID' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Platnik_ImiePierwsze*/(SELECT TOP 1 left(Atr_Wartosc,30) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Platnik_ImiePierwsze' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Platnik_Nazwisko*/(SELECT TOP 1 left(Atr_Wartosc,81) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Platnik_Nazwisko' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Platnik_Ulica*/(SELECT TOP 1 left(Atr_Wartosc,30) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Platnik_Ulica' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Platnik_NrDomu*/(SELECT TOP 1 left(Atr_Wartosc,9) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Platnik_NrDomu' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Platnik_NrLokalu*/(SELECT TOP 1 left(Atr_Wartosc,10) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Platnik_NrLokalu' AND Atr_ObiNumer = trv_numer AND Atr_ObiTyp = trv_typ AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0)
	from  #StawkiVatZ

INSERT INTO  #Atrybuty_KsefKorygowanych select
	org.TrN_GIDNumer,
	/*ATR_KSEF_Nabywca_NrID*/(SELECT TOP 1 left(Atr_Wartosc,50) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Nabywca_NrID' AND Atr_ObiNumer = org.TrN_GIDNumer AND Atr_ObiTyp = org.TrN_GIDTyp AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Nabywca_ImiePierwsze*/(SELECT TOP 1 left(Atr_Wartosc,30) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Nabywca_ImiePierwsze' AND Atr_ObiNumer = org.TrN_GIDNumer AND Atr_ObiTyp = org.TrN_GIDTyp  AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Nabywca_Nazwisko*/(SELECT TOP 1 left(Atr_Wartosc,81) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Nabywca_Nazwisko' AND Atr_ObiNumer = org.TrN_GIDNumer AND Atr_ObiTyp = org.TrN_GIDTyp  AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Nabywca_Ulica*/(SELECT TOP 1 left(Atr_Wartosc,30) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Nabywca_Ulica' AND Atr_ObiNumer = org.TrN_GIDNumer AND Atr_ObiTyp = org.TrN_GIDTyp  AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Nabywca_NrDomu*/(SELECT TOP 1 left(Atr_Wartosc,9) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Nabywca_NrDomu' AND Atr_ObiNumer = org.TrN_GIDNumer AND Atr_ObiTyp = org.TrN_GIDTyp  AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0),
	/*ATR_KSEF_Nabywca_NrLokalu*/(SELECT TOP 1 left(Atr_Wartosc,10) FROM CDN.Atrybuty JOIN CDN.AtrybutyKlasy ON AtK_ID=Atr_AtkId WHERE ATK_NAZWA = 'KSEF_Nabywca_NrLokalu' AND Atr_ObiNumer = org.TrN_GIDNumer AND Atr_ObiTyp = org.TrN_GIDTyp  AND Atr_ObiLp = 0 AND Atr_ObiSubLp = 0)
	FROM cdn.TraNag kor  
	JOIN cdn.TraNag org ON org.TrN_GIDNumer = kor.TrN_ZwrNumer and org.TrN_GIDTyp = kor.TrN_ZwrTyp
	WHERE kor.TrN_GIDNumer = @GidNumer and kor.TrN_GIDTyp = @GidTyp 

UPDATE Atrybuty
SET	
	ATR_P_22A	= case when ATR_P_22A IS null then '' else ATR_P_22A end,
	ATR_P_22B	= case when ATR_P_22B IS null then '' else ATR_P_22B end,	
	ATR_P_22C	= case when ATR_P_22C IS null then '' else ATR_P_22C end,
	ATR_KSEF_P_22A	= case when ATR_KSEF_P_22A IS null then '' else ATR_KSEF_P_22A end,
	ATR_KSEF_P_22B	= case when ATR_KSEF_P_22B IS null then '' else ATR_KSEF_P_22B end,
	ATR_KSEF_P_22C	= case when ATR_KSEF_P_22C IS null then '' else ATR_KSEF_P_22C end,
	ATR_KSEF_P_22D	= case when ATR_KSEF_P_22D IS null then '' else ATR_KSEF_P_22D end,
	ATR_P_23		= case when ATR_P_23 IS null then 'false' else ATR_P_23 end,
	ATR_KSEF_P_23	= case when ATR_KSEF_P_23 IS null then 'false' else ATR_KSEF_P_23 end,
	ATR_P_PMarzy_3_1	= case when ATR_P_PMarzy_3_1 IS null then 'false' else ATR_P_PMarzy_3_1 end,
	ATR_P_PMarzy_3_2	= case when ATR_P_PMarzy_3_2 IS null then 'false' else ATR_P_PMarzy_3_2 end,
	ATR_P_PMarzy_3_3	= case when ATR_P_PMarzy_3_3 IS null then 'false' else ATR_P_PMarzy_3_3 end,
	ATR_P_16		= case when ATR_P_16 IS null then 'false'  else ATR_P_16 end,
	ATR_KSEF_P_16	= case when ATR_KSEF_P_16 IS null then 'false'  else ATR_KSEF_P_16 end,
	ATR_P_17		= case when ATR_P_17 IS null then 'false'  else ATR_P_17 end,
	ATR_KSEF_P_17	= case when ATR_KSEF_P_17 IS null then 'false'  else ATR_KSEF_P_17 end,
	ATR_P_22		= case when ATR_P_22 IS null then 'false'  else ATR_P_22 end,
	ATR_KSEF_P_22	= case when ATR_KSEF_P_22 IS null then 'false'  else ATR_KSEF_P_22 end,
	ATR_KSEF_Nabywca_NrID	= case when ATR_KSEF_Nabywca_NrID IS null then '' else ATR_KSEF_Nabywca_NrID end,
	ATR_KSEF_Nabywca_ImiePierwsze = case when ATR_KSEF_Nabywca_ImiePierwsze IS null then '' else ATR_KSEF_Nabywca_ImiePierwsze end,
	ATR_KSEF_Nabywca_Nazwisko	  = case when ATR_KSEF_Nabywca_Nazwisko IS null then '' else ATR_KSEF_Nabywca_Nazwisko end,
	ATR_KSEF_Nabywca_Ulica		  = case when ATR_KSEF_Nabywca_Ulica IS null then '' else ATR_KSEF_Nabywca_Ulica end,
	ATR_KSEF_Nabywca_NrDomu		  = case when ATR_KSEF_Nabywca_NrDomu IS null then '' else ATR_KSEF_Nabywca_NrDomu end,
	ATR_KSEF_Nabywca_NrLokalu	  = case when ATR_KSEF_Nabywca_NrLokalu IS null then '' else ATR_KSEF_Nabywca_NrLokalu end,	 
	ATR_KSEF_Odbiorca_NrID	= case when ATR_KSEF_Odbiorca_NrID IS null then '' else ATR_KSEF_Odbiorca_NrID end,
	ATR_KSEF_Odbiorca_ImiePierwsze = case when ATR_KSEF_Odbiorca_ImiePierwsze IS null then '' else ATR_KSEF_Odbiorca_ImiePierwsze end,
	ATR_KSEF_Odbiorca_Nazwisko	  = case when ATR_KSEF_Odbiorca_Nazwisko IS null then '' else ATR_KSEF_Odbiorca_Nazwisko end,
	ATR_KSEF_Odbiorca_Ulica		  = case when ATR_KSEF_Odbiorca_Ulica IS null then '' else ATR_KSEF_Odbiorca_Ulica end,
	ATR_KSEF_Odbiorca_NrDomu		  = case when ATR_KSEF_Odbiorca_NrDomu IS null then '' else ATR_KSEF_Odbiorca_NrDomu end,
	ATR_KSEF_Odbiorca_NrLokalu	  = case when ATR_KSEF_Odbiorca_NrLokalu IS null then '' else ATR_KSEF_Odbiorca_NrLokalu end,	
	ATR_KSEF_Platnik_NrID	= case when ATR_KSEF_Platnik_NrID IS null then '' else ATR_KSEF_Platnik_NrID end,
	ATR_KSEF_Platnik_ImiePierwsze = case when ATR_KSEF_Platnik_ImiePierwsze IS null then '' else ATR_KSEF_Platnik_ImiePierwsze end,
	ATR_KSEF_Platnik_Nazwisko	  = case when ATR_KSEF_Platnik_Nazwisko IS null then '' else ATR_KSEF_Platnik_Nazwisko end,
	ATR_KSEF_Platnik_Ulica		  = case when ATR_KSEF_Platnik_Ulica IS null then '' else ATR_KSEF_Platnik_Ulica end,
	ATR_KSEF_Platnik_NrDomu		  = case when ATR_KSEF_Platnik_NrDomu IS null then '' else ATR_KSEF_Platnik_NrDomu end,
	ATR_KSEF_Platnik_NrLokalu	  = case when ATR_KSEF_Platnik_NrLokalu IS null then '' else ATR_KSEF_Platnik_NrLokalu end
FROM #Atrybuty_Ksef AS Atrybuty

UPDATE AtrybutyKorygowanych
SET	
	ATR_KSEFKorygowanych_Nabywca_NrID	= case when ATR_KSEFKorygowanych_Nabywca_NrID IS null then '' else ATR_KSEFKorygowanych_Nabywca_NrID end,
	ATR_KSEFKorygowanych_Nabywca_ImiePierwsze = case when ATR_KSEFKorygowanych_Nabywca_ImiePierwsze IS null then '' else ATR_KSEFKorygowanych_Nabywca_ImiePierwsze end,
	ATR_KSEFKorygowanych_Nabywca_Nazwisko	  = case when ATR_KSEFKorygowanych_Nabywca_Nazwisko IS null then '' else ATR_KSEFKorygowanych_Nabywca_Nazwisko end,
	ATR_KSEFKorygowanych_Nabywca_Ulica		  = case when ATR_KSEFKorygowanych_Nabywca_Ulica IS null then '' else ATR_KSEFKorygowanych_Nabywca_Ulica end,
	ATR_KSEFKorygowanych_Nabywca_NrDomu		  = case when ATR_KSEFKorygowanych_Nabywca_NrDomu IS null then '' else ATR_KSEFKorygowanych_Nabywca_NrDomu end,
	ATR_KSEFKorygowanych_Nabywca_NrLokalu	  = case when ATR_KSEFKorygowanych_Nabywca_NrLokalu IS null then '' else ATR_KSEFKorygowanych_Nabywca_NrLokalu end
FROM #Atrybuty_KsefKorygowanych AS AtrybutyKorygowanych

UPDATE sv 
	SET TRV_VatR_stawka_4 = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) THEN VatRWal ELSE TRV_VatR END	--P_14_4	
	FROM #StawkiVatZ AS sv
	INNER JOIN (
        SELECT TRV_GIDTyp,TRV_GIDNUMER, SUM(TRV_VatR) as TRV_VatR,SUM(ROUND(TRV_VatR*TrN_KursM/TrN_KursL,2)) as VatRWal
        FROM CDN.TRAVAT	
		JOIN CDN.TraNag on TrN_GIDNumer = TrV_GIDNumer AND TrN_GIDTyp = TrV_GIDTyp	
        WHERE (TrV_ExpoNorm = 20 and TrV_FlagaVat = 2) or (TrV_ExpoNorm = 1 and TrV_StawkaPod = 4)
        GROUP BY TRV_GIDTyp,TrV_GIDNumer) tv ON tv.TRV_GIDNUMER = sv.TRV_numer AND tv.TRV_GIDTyp = sv.TRV_typ


UPDATE sv
	SET TRV_NettoR_stawka_5 = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) THEN trv_wartoscWal ELSE TRV_NettoR END,	--P_13_3	
		TRV_VatR_stawka_5 = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) THEN  VatRWal ELSE TRV_VatR END,				--P_14_3	
		TRV_VatR_stawka_5_pln = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) AND TrN_Waluta &lt;&gt; @walutaSys THEN TRV_VatR ELSe 0 end		--P_14_3W	
	FROM #StawkiVatZ AS sv
	INNER JOIN (
        SELECT TrN_Waluta,TRV_GIDTyp,TRV_GIDNUMER, SUM(TRV_NettoR) as TRV_NettoR,SUM(TRV_VatR) as TRV_VatR,SUM(ROUND(TRV_VatR*TrN_KursM/TrN_KursL,2)) as VatRWal,
		case when TrN_FlagaNB = 'N' then sum(TrV_WartoscWal) else sum(TrV_WartoscWal*100/(100+TrV_StawkaPod)) end as trv_wartoscWal
        FROM CDN.TRAVAT		
		JOIN CDN.TraNag on TrN_GIDNumer = TrV_GIDNumer AND TrN_GIDTyp = TrV_GIDTyp		
        WHERE (TRV_STAWKAPOD IN (5) AND NOT (TrV_ExpoNorm in(6,7,21) AND TrV_RodzajZakupu = 8) AND NOT TrV_ExpoNorm = 26)
        GROUP BY TrN_Waluta,TRV_GIDTyp,TrV_GIDNumer,TrN_FlagaNB) tv
    ON tv.TRV_GIDNUMER = sv.TRV_numer AND tv.TRV_GIDTyp = sv.TRV_typ

UPDATE sv
	SET TRV_NettoR_stawka_7_8 = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) THEN trv_wartoscWal ELSE TRV_NettoR END,		--P_13_2	
		TRV_VatR_stawka_7_8 = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) THEN  VatRWal ELSE TRV_VatR END,				--P_14_2	
		TRV_VatR_stawka_7_8_pln = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) AND TrN_Waluta &lt;&gt; @walutaSys THEN TRV_VatR ELSe 0 end	--P_14_2W	
	FROM #StawkiVatZ AS sv
	INNER JOIN (
        SELECT TrN_Waluta,TRV_GIDTyp,TRV_GIDNUMER,SUM(TRV_NettoR) as TRV_NettoR,SUM(TRV_VatR) as TRV_VatR,SUM(ROUND(TRV_VatR*TrN_KursM/TrN_KursL,2)) as VatRWal,
		case when TrN_FlagaNB = 'N' then sum(TrV_WartoscWal) else sum(TrV_WartoscWal*100/(100+TrV_StawkaPod)) end as trv_wartoscWal
        FROM CDN.TRAVAT
		JOIN CDN.TraNag on TrN_GIDNumer = TrV_GIDNumer AND TrN_GIDTyp = TrV_GIDTyp	
        WHERE (TRV_STAWKAPOD IN (7,8) AND NOT (TrV_ExpoNorm in(6,7,21) AND TrV_RodzajZakupu = 8) AND NOT TrV_ExpoNorm = 26)
        GROUP BY TrN_Waluta,TRV_GIDTyp,TrV_GIDNumer,TrN_FlagaNB) tv
    ON tv.TRV_GIDNUMER = sv.TRV_numer AND tv.TRV_GIDTyp = sv.TRV_typ

UPDATE sv
	SET TRV_NettoR_stawka_22_23 = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) THEN trv_wartoscWal ELSE TRV_NettoR END,	--P_13_1	
		TRV_VatR_stawka_22_23 = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) THEN  VatRWal ELSE TRV_VatR END,				--P_14_1	
		TRV_VatR_stawka_22_23_pln = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) AND TrN_Waluta &lt;&gt; @walutaSys THEN TRV_VatR ELSe 0 end		--P_14_1W	
	FROM #StawkiVatZ AS sv
	INNER JOIN(
        SELECT TrN_Waluta,TRV_GIDTyp,TRV_GIDNUMER,SUM(TRV_NettoR) as TRV_NettoR,SUM(TRV_VatR) as TRV_VatR,SUM(ROUND(TRV_VatR*TrN_KursM/TrN_KursL,2)) as VatRWal,
		case WHEN TrN_FlagaNB = 'N' then sum(TrV_WartoscWal) else sum(TrV_WartoscWal*100/(100+TrV_StawkaPod)) end as trv_wartoscWal
        FROM CDN.TRAVAT
		JOIN CDN.TraNag on TrN_GIDNumer = TrV_GIDNumer AND TrN_GIDTyp = TrV_GIDTyp
        WHERE (TRV_STAWKAPOD IN (22,23) AND NOT (TrV_ExpoNorm in(6,7,21) AND TrV_RodzajZakupu = 8) AND NOT TrV_ExpoNorm = 26)
        GROUP BY TrN_Waluta,TRV_GIDTyp,TrV_GIDNumer,TrN_FlagaNB) tv
    ON tv.TRV_GIDNUMER = sv.TRV_numer AND tv.TRV_GIDTyp = sv.TRV_typ
	
UPDATE sv
	SET TRV_NettoR_flaga2_oo = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) THEN trv_wartoscWal ELSE TRV_NettoR END,		--P_13_4	
	TRV_VatR_flaga2_oo_pln = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) AND TrN_Waluta &lt;&gt; @walutaSys THEN TRV_VatR ELSe 0 end		--P_14_4W	
	FROM #StawkiVatZ AS sv
	INNER JOIN(
        SELECT TrN_Waluta,TRV_GIDTyp,TRV_GIDNUMER,SUM(TRV_NettoR) as TRV_NettoR,SUM(TRV_VatR) as TRV_VatR,
		case WHEN TrN_FlagaNB = 'N' then sum(TrV_WartoscWal) else sum(TrV_WartoscWal*100/(100+TrV_StawkaPod)) end as trv_wartoscWal
		FROM CDN.TRAVAT
		JOIN CDN.TraNag on TrN_GIDNumer = TrV_GIDNumer AND TrN_GIDTyp = TrV_GIDTyp	
        where (TrV_ExpoNorm = 20 and TrV_FlagaVat = 2) or (TrV_ExpoNorm = 1 and TrV_StawkaPod = 4)
        GROUP BY TrN_Waluta,TRV_GIDTyp,TrV_GIDNumer,TrN_FlagaNB) tv
    ON tv.TRV_GIDNUMER = sv.TRV_numer AND tv.TRV_GIDTyp = sv.TRV_typ

UPDATE sv
	SET TRV_NettoR_flaga2 = CASE 
	WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) THEN trv_wartoscWal	--P_13_5	
	ELSE TRV_NettoR END
	FROM #StawkiVatZ AS sv
	INNER JOIN(
        SELECT TRV_GIDTyp,TRV_GIDNUMER,SUM(TRV_NettoR) as TRV_NettoR,
		case WHEN TrN_FlagaNB = 'N' then sum(TrV_WartoscWal) else sum(ROUND(TrV_WartoscWal/(1+TrV_StawkaPod/100),2)) end as trv_wartoscWal,
		SUM(TrV_StawkaPod) as trv_stawkaPod, TrN_FlagaNB
		FROM CDN.TRAVAT
		JOIN CDN.TraNag ON TrN_GIDTyp=TRV_GIDTyp AND TrN_GIDNumer=TRV_GIDNumer
        where 
			(TrV_ExpoNorm in (1,2,3,4,5,8,9,16,17,18,19) and TrV_FlagaVat = 2)
			or (TrV_ExpoNorm in (6,7,21) and TrV_RodzajZakupu = 8)
			or (TrV_ExpoNorm in (6,7) and TrV_RodzajZakupu &lt;&gt; 8 and TrV_FlagaVat = 2)
			or (TrV_ExpoNorm = 21 and TrV_RodzajZakupu &lt;&gt; 8 and TrV_StawkaPod = 0)
			or (TrV_ExpoNorm = 23 and TrV_FlagaVat in (0,2))
			or (TrV_ExpoNorm = 23 and @InterpretujTransDostOpodatkPozaTerytKrajWSt0JakoKrajowa = '0' AND TrV_StawkaPod = 0)
			or (TrV_ExpoNorm=26)
        GROUP BY TRV_GIDTyp,TrV_GIDNumer,TrN_FlagaNB) tv
    ON TRV_GIDNUMER = sv.TRV_numer AND tv.TRV_GIDTyp = sv.TRV_typ


UPDATE sv
	SET TRV_NettoR_stawka_0_flaga1 = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) THEN trv_wartoscWal ELSE TRV_NettoR END		--P_13_6	
	FROM #StawkiVatZ AS sv
	INNER JOIN(
        SELECT TRV_GIDNUMER,TRV_GIDTYP,SUM(TrV_WartoscWal) AS TrV_WartoscWal,SUM(TRV_NettoR) AS TRV_NettoR
        FROM CDN.TRAVAT
		JOIN CDN.TraNag ON TrN_GIDTyp=TRV_GIDTyp AND TrN_GIDNumer=TRV_GIDNumer
        WHERE (TrV_FlagaVat = 1 AND TrV_StawkaPod =  0) AND NOT (TrV_ExpoNorm in (6,7) and TrV_RodzajZakupu = 8) 
		AND NOT TrV_ExpoNorm in (21,26) AND NOT(@InterpretujTransDostOpodatkPozaTerytKrajWSt0JakoKrajowa = '0' AND TrV_ExpoNorm=23)
        GROUP BY TRV_GIDTYP,TrV_GIDNumer) tv
    ON tv.TRV_GIDNUMER = sv.TRV_numer AND tv.TRV_GIDTYP = sv.TRV_typ


UPDATE sv
	SET TRV_NettoR_flaga0 = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) THEN trv_wartoscWal ELSE TRV_NettoR END	--P_13_7 
	FROM #StawkiVatZ AS sv
	INNER JOIN(
        SELECT TRV_GIDNUMER,TRV_GIDTYP,SUM(TrV_WartoscWal) AS TrV_WartoscWal,SUM(TRV_NettoR) AS TRV_NettoR
        FROM CDN.TRAVAT
		JOIN CDN.TraNag ON TrN_GIDTyp=TRV_GIDTyp AND TrN_GIDNumer=TRV_GIDNumer
        WHERE TrV_FlagaVat = 0 AND NOT (TrV_ExpoNorm in (6,7) and TrV_RodzajZakupu = 8) AND NOT TrV_ExpoNorm in (21,23,26)
        GROUP BY TRV_GIDTYP,TrV_GIDNumer) tv
    ON tv.TRV_GIDNUMER = sv.TRV_numer AND tv.TRV_GIDTYP = sv.TRV_typ
		
UPDATE sv
	SET TRV_VAT_DOPTK = CASE WHEN  TRV_GIDTyp IN (2037,1828,2045,1836) THEN  VatRWal ELSE TRV_VatR END	--P_14_5
	FROM #StawkiVatZ AS sv
	INNER JOIN (
        SELECT TrN_Waluta,TRV_GIDTyp,TRV_GIDNUMER, SUM(TRV_NettoR) as TRV_NettoR,SUM(TRV_VatR) as TRV_VatR,SUM(ROUND(TRV_VatR*TrN_KursM/TrN_KursL,2)) as VatRWal
        FROM CDN.TRAVAT		
		JOIN CDN.TraNag on TrN_GIDNumer = TrV_GIDNumer AND TrN_GIDTyp = TrV_GIDTyp	
        WHERE Trn_ProceduraOSS = 1 
        GROUP BY TrN_Waluta,TRV_GIDTyp,TrV_GIDNumer) tv
    ON tv.TRV_GIDNUMER = sv.TRV_numer AND tv.TRV_GIDTyp = sv.TRV_typ

insert into #Dane
	select distinct  --FAKTURA SPRZEDAŻ		
	/*gidnumer*/		T1.TrN_GIDNumer,
	/*gidtyp*/		T1.TrN_GIDTyp,
	/*PodatnikPrefiksNIP*/ case when t1.TrN_ExpoNorm in (6,7,8,9,10,11,12,13,16,17,18,19,21) then centrum.Frm_NipPrefiks else '' end,
	/*PodatnikNIP*/ coalesce((case when REPLACE(centrum.Frm_NIP,'-','') like '[1-9][1-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]' OR REPLACE(centrum.Frm_NIP,'-','') like'[1-9][0-9][1-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]' THEN REPLACE(centrum.Frm_NIP ,'-','') ELSE centrum.Frm_NIP end),(case when REPLACE(glowna.Frm_NIP,'-','') like '[1-9][1-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]' OR REPLACE(glowna.Frm_NIP,'-','') like'[1-9][0-9][1-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]' THEN REPLACE(glowna.Frm_NIP ,'-','') ELSE glowna.Frm_NIP end)),
	/*PodatnikImiePierwsze*/ case when centrum.Frm_DRodzaj is not null then
									case when (LEN(centrum.Frm_DNazwa) - LEN(REPLACE(centrum.Frm_DNazwa, ',', ''))) = 2 then
										case when centrum.Frm_DRodzaj = 2 then rtrim(ltrim(left((select left(right(centrum.Frm_DNazwa, len(centrum.Frm_DNazwa)- CHARINDEX(',', centrum.Frm_DNazwa)), charindex(',',right(centrum.Frm_DNazwa, len(centrum.Frm_DNazwa)- CHARINDEX(',', centrum.Frm_DNazwa)))-1)),30))) 
										else '' 
										end
									else
										case when centrum.Frm_DRodzaj = 2 then rtrim(ltrim(left((select RIGHT(centrum.Frm_DNazwa, CHARINDEX(',', reverse(centrum.Frm_DNazwa)) -1)),30)))
										else '' 
										end
									end
								else
									case when (LEN(centrum.Frm_DNazwa) - LEN(REPLACE(centrum.Frm_DNazwa, ',', ''))) = 2 then
										case when glowna.Frm_DRodzaj = 2 then rtrim(ltrim(left((select left(right(glowna.Frm_DNazwa, len(glowna.Frm_DNazwa)- CHARINDEX(',', glowna.Frm_DNazwa)), charindex(',',right(glowna.Frm_DNazwa, len(glowna.Frm_DNazwa)- CHARINDEX(',', glowna.Frm_DNazwa)))-1)),30))) 
										else ''
										end
									else
										case when glowna.Frm_DRodzaj = 2 then rtrim(ltrim(left((select RIGHT(glowna.Frm_DNazwa, CHARINDEX(',', reverse(glowna.Frm_DNazwa)) -1)),30)))
										else ''
										end
									end
								end, 
	/*PodatnikNazwisko*/ case when centrum.Frm_DRodzaj is not null then
								case when centrum.Frm_DRodzaj = 2 then rtrim(ltrim(left((select SUBSTRING(centrum.Frm_DNazwa,0,CHARINDEX(',',centrum.Frm_DNazwa))),81)))
								else '' 
								end
							else
								case when glowna.Frm_DRodzaj = 2 then rtrim(ltrim(left((select SUBSTRING(glowna.Frm_DNazwa,0,CHARINDEX(',',glowna.Frm_DNazwa))),81))) 
								else '' 
								end
							end,
	/*PodatnikPelnaNazwa*/ case when centrum.Frm_DRodzaj is not null then
								case when centrum.Frm_DRodzaj = 1 then centrum.Frm_DNazwa 
								else ''
								end
							else
								case when glowna.Frm_DRodzaj = 1 then glowna.Frm_DNazwa
								else '' 
								end
							end,
	/*PodatnikKodKraju*/ isnull(case when centrum.Frm_DKraj is not null then
								case when centrum.Frm_DKraj = 'Polska' then 'PL' 
								else KPC_Kod 
								end
							else
								case when glowna.Frm_DKraj = 'Polska' then 'PL' 
								else KPC_Kod 
								end
							end,'PL'),
	/*PodatnikWojewodztwo*/ coalesce(centrum.Frm_DWojewodztwo,glowna.Frm_DWojewodztwo),
	/*PodatnikPowiat*/		left(coalesce(centrum.Frm_DPowiat,glowna.Frm_DPowiat),36),
	/*PodatnikGmina*/		coalesce(centrum.Frm_DGmina,glowna.Frm_DGmina),
	/*PodatnikUlica*/	coalesce(centrum.Frm_DUlica,glowna.Frm_DUlica),
	/*PodatnikNrDomu*/	left(coalesce(centrum.Frm_DNrDomu,glowna.Frm_DNrDomu),9),
	/*PodatnikNrLokalu*/ coalesce(centrum.Frm_DNrLokalu,glowna.Frm_DNrLokalu),
	/*PodatnikMiejscowosc*/ coalesce(centrum.Frm_DMiasto,glowna.Frm_DMiasto),
	/*PodatnikKodPocztowy*/ coalesce(centrum.Frm_DKodP,glowna.Frm_DKodP),
	/*PodatnikPoczta*/	coalesce(centrum.Frm_DPoczta,glowna.Frm_DPoczta),
	/*PodatnikGLN*/		coalesce(centrum.Frm_GLN,glowna.Frm_GLN),
	/*PodatnikEmail*/	coalesce(centrum.Frm_DEmailSekretariat,glowna.Frm_DEmailSekretariat),
	/*PodatnikTel*/		left(coalesce(centrum.Frm_DTelefon,glowna.Frm_DTelefon),16),
	/*NabywcaPrefiksNIP*/ case when t1.TrN_ExpoNorm in (6,7,8,9,10,11,12,13,16,17,18,19,21) then KnA_NipPrefiks else '' end,
	/*NabywcaNIP*/ case when ATR_KSEF_Nabywca_NrID &lt;&gt; '' or (KnA_Kraj &lt;&gt; 'PL' and KnA_Kraj &lt;&gt; '') then '' else KnA_Nip end,
	/*NabywcaNrID*/ case when ATR_KSEF_Nabywca_NrID &lt;&gt; '' then ATR_KSEF_Nabywca_NrID
						when (KnA_Kraj &lt;&gt; 'PL' and KnA_Kraj &lt;&gt;'') then KnA_NipE 
						else ''
						end,
	/*NabywcaBrakID*/ case when ATR_KSEF_Nabywca_NrID = '' and KnA_Nip = '' then '1' else '' end,
	/*NabywcaImiePierwsze*/ case when Knt_Status = 2 then 
									case when ATR_KSEF_Nabywca_ImiePierwsze &lt;&gt; '' then left(ATR_KSEF_Nabywca_ImiePierwsze,30) 
									else left((select LEFT(KnA_Nazwa1, case when  CHARINDEX(' ', KnA_Nazwa1 ) = 0 then LEN(KnA_Nazwa1) 
									else CHARINDEX(' ', KnA_Nazwa1) -1 end)),30) end
							else '' end,
	/*NabywcaNazwisko*/ case when Knt_Status = 2 then
								case when ATR_KSEF_Nabywca_Nazwisko &lt;&gt; '' then left(ATR_KSEF_Nabywca_Nazwisko,81) 
								else left((select RIGHT(KnA_Nazwa1, case when  CHARINDEX(' ', KnA_Nazwa1 ) = 0 then LEN(KnA_Nazwa1) 
								else CHARINDEX(' ', reverse(KnA_Nazwa1)) -1 end)),81) end
						else '' end,	
	/*NabywcaPelnaNazwa*/ case when Knt_Status = 1 then left(KnA_Nazwa1+' '+KnA_Nazwa2+' '+KnA_Nazwa3,256) else '' end,
	/*NabywcaKodKraju*/ case when KnA_Kraj = 'PL' or KnA_Kraj = '' then 'PL' else KnA_Kraj end,
	/*NabywcaWojewodztwo*/	KnA_Wojewodztwo,
	/*NabywcaPowiat*/		KnA_Powiat,
	/*NabywcaGmina*/		KnA_Gmina,
	/*NabywcaUlica*/ case when ATR_KSEF_Nabywca_Ulica = '&lt;Brak&gt;'then ''
						when ATR_KSEF_Nabywca_Ulica &lt;&gt; '&lt;Brak&gt;' and ATR_KSEF_Nabywca_Ulica &lt;&gt; '' then ATR_KSEF_Nabywca_Ulica
						else cdn.ParsujAdres(KnA_Ulica,1) end,
	/*NabywcaNrDomu*/ case when ATR_KSEF_Nabywca_NrDomu &lt;&gt; '' then left(ATR_KSEF_Nabywca_NrDomu,9) else left(cdn.ParsujAdres(KnA_Ulica,2),9) end,
	/*NabywcaNrLokalu*/ case when ATR_KSEF_Nabywca_NrLokalu &lt;&gt; '' then left(ATR_KSEF_Nabywca_NrLokalu,10) else left(cdn.ParsujAdres(KnA_Ulica,3),10) end,
	/*NabywcaMiejscowosc*/ KnA_Miasto,
	/*NabywcaKodPocztowy*/ KnA_KodP,
	/*NabywcaGLN*/		KnA_GLN,
	/*NabywcaPoczta*/	KnA_Miasto,
	/*NabywcaEmail*/	KnA_Email,
	/*NabywcaTel*/		left(Kna_Telefon1,16),
	/*KodWaluty*/		CASE WHEN t1.TRn_GIDTyp IN (2037,1828,2045,1836) then 
								CASE WHEN upper(t1.TrN_Waluta) = 'ZŁ' or upper(t1.TrN_Waluta) = 'ZŁ.' then 'PLN'
									else t1.TrN_Waluta
									end
							else 'PLN' end, 
	/*DataWystawienia*/  t1.TrN_Data2,
	/*NumerFaktury*/	case when @CzyWysylacSystemowyNrDok = 0 then 
							t1.trn_dokumentobcy
						else 							
							cdn.NumerDokumentuZ(t1.TrN_GidTyp,t1.TrN_SpiTyp,t1.TrN_TrNTyp,t1.TrN_TrNNumer,t1.TrN_TrNRok,t1.TrN_TrNSeria,t1.TrN_TrNMiesiac,t1.TrN_ZwrTyp,t1.TrN_ZwrNumer,t1.TrN_WMS)
						end,
	/*DataDostawy*/ case when t1.TrN_GIDTyp in (2033,2035,1824,2037,1828) then t1.TrN_Data3
						when t1.Trn_GidTyp in (2041,2045) and t1.TrN_ZwrTyp = t1.TrN_GIDTyp and t1.TrN_ZwrNumer = 0 then t1.TrN_Data3
						when (t1.Trn_GidTyp in (2041,2045) and (TrS_ZwrTyp &lt;&gt; t1.TrN_GIDTyp or t1.TrN_ZwrTyp &lt;&gt; t1.TrN_GIDTyp)) or (t1.Trn_GidTyp in (2041,2045) and (TrS_ZwrTyp = t1.TrN_GIDTyp or t1.TrN_ZwrTyp = t1.TrN_GIDTyp) and (TrS_ZwrNumer &lt;&gt; t1.TrN_GIDNumer or t1.TrN_ZwrNumer &lt;&gt; t1.TrN_GIDNumer)) or (t1.TrN_GIDTyp in (2043, 1832, 1836) or (t1.Trn_GidTyp in (2041, 2045) and t1.TrN_KorektaDanych = 1)) then (select TrN_Data3 from cdn.TraNag where TrN_GIDNumer = @gidNumerOrg)
						when t1.TrN_GIDTyp in (2041,2045) and ((TrS_ZwrTyp = t1.TrN_GIDTyp and TrS_ZwrNumer = t1.TrN_GIDNumer) or (t1.Trn_ZwrTyp = t1.TrN_GIDTyp and t1.Trn_ZwrNumer = t1.TrN_GIDNumer)) then t1.TrN_DataSprOrg
					end,
	/*SumaNettoStawkaPodstawowa */ 			isnull(TRV_NettoR_stawka_22_23,0),
	/*SumaVATStawkaPodstawowa */ 			isnull(TRV_VatR_stawka_22_23,0),
	/*SumaVATStawkaPodstawowaPLN */ 		isnull(TRV_VatR_stawka_22_23_pln,0),
	/*SumaNettoStawkaObnizona */ 			isnull(TRV_NettoR_stawka_7_8,0),
	/*SumaVATStawkaObnizona */ 				isnull(TRV_VatR_stawka_7_8,0),
	/*SumaVATStawkaObnizonaPLN */ 			isnull(TRV_VatR_stawka_7_8_pln,0),
	/*SumaNettoStawkaObnizonaDruga */ 		isnull(TRV_NettoR_stawka_5,0),
	/*SumaVATStawkaObnizonaDruga */ 		isnull(TRV_VatR_stawka_5,0),
	/*SumaVATStawkaObnizonaDrugaPLN */ 		isnull(TRV_VatR_stawka_5_pln,0),
	/*SumaNettoStawkaObnizonaTrzecia */		isnull(TRV_NettoR_flaga2_oo,0),
	/*SumaVATStawkaObnizonaTrzecia */ 		isnull(TRV_VatR_stawka_4,0),
	/*SumaVATStawkaObnizonaTrzeciaPLN */ 	isnull(TRV_VatR_flaga2_oo_pln,0),
	/*SumaNettoStawkiExportowe */ 			isnull(TRV_NettoR_flaga2,0),
	/*SumaVATOSS */ 						isnull(TRV_VAT_DOPTK,0),
	/*SumaNetto0 */ 						isnull(TRV_NettoR_stawka_0_flaga1,0),
	/*SumaNettoZW */ 						isnull(TRV_NettoR_flaga0,0),
	/*SumaBrutto*/  ROUND(CASE WHEN T1.TRN_GIDTyp IN (2037,2045,1828,1836) THEN 
				Case when t1.TrN_FlagaNB = 'N' THEN T1.TrN_WartoscWal + t1.TrN_VatR*t1.TrN_KursM/t1.TrN_KursL ELSE T1.TrN_WartoscWal END
				ELSE T1.TRN_NettoR + T1.TRN_VatR END,2),
	/*MetodaKasowa */ 		case when ATR_KSEF_P_16 = 'true' then '1' 
								when ATR_P_16 = 'true' then '1' 
								else '2' end,
	/*Samofakturowanie */ 	case when ATR_KSEF_P_17 = 'true' then '1' 
								when ATR_P_17 = 'true' then '1' 
								else '2' end,
	/*OdwrotneObciazenie*/  case 
				when (t1.TrN_ExpoNorm in (20) OR (t1.TrN_ExpoNorm = 6 AND t1.TrN_RodzajZakupu = 8)) then '1' 
				else '2' end, 
	/*PodzielonaPlatnosc*/		CASE WHEN t1.TrN_MPP = 1 THEN '1' ELSE '2' END,
	/*SprzedazZwolniona*/	case when exists(select * from CDN.TraVat tv2 where tv2.TrV_GIDTyp = T1.TRN_gidtyp AND trv_gidnumer = T1.TRN_gidnumer AND TrV_FlagaVat = 0) then '1' else '2' end, 
	/*SprzedazZWUstawa*/	case when T1.TRN_PodstawaZW = 1 then T1.TRN_przyczynazw else '' end,
	/*SprzedazZWDyrektywa*/	case when T1.TRN_PodstawaZW = 2 then T1.TRN_przyczynazw else '' end,
	/*SprzedazZWPodstawa*/	case when T1.TRN_PodstawaZW = 3 then T1.TRN_przyczynazw else '' end,
	/*NSTWDT */ 			case when ATR_KSEF_P_22 = 'true' then '1' 
								when ATR_P_22 = 'true' then '1' 
								else '2' end,
	/*NSTDataDopuszczenia */ 	case when ATR_KSEF_P_22A &lt;&gt; '' then ATR_KSEF_P_22A 
									when ATR_P_22A &lt;&gt; '' then ATR_P_22A 
									else '' end, 
	/*NSTPrzebieg */ 			case when ATR_KSEF_P_22B &lt;&gt; '' then ATR_KSEF_P_22B 
									when ATR_P_22B &lt;&gt; '' then ATR_P_22B 
									else '' end,
	/*NSTPlywGodzRobocze */ 	case when ATR_KSEF_P_22C &lt;&gt; '' then ATR_KSEF_P_22C 
									when ATR_P_22C &lt;&gt; '' then ATR_P_22C 
									else '' end,
	/*NSTPowGodzRobocze */ 	ATR_KSEF_P_22D,			
	/*FakturaUproszczona */ case when ATR_KSEF_P_23 = 'true' then '1' 
								when ATR_P_23 = 'true' then '1' 
								else '2' end,
	/*FakturaVATMarza */ 	case when ATR_P_PMarzy_3_1 = 'true' or ATR_P_PMarzy_3_2 = 'true' or ATR_P_PMarzy_3_3 = 'true' or EXISTS(SELECT * FROM CDN.TraJPK WHERE TrJ_TrNNumer = t1.trn_gidnumer AND TrJ_TrNTyp = t1.trn_gidtyp and TrJ_Wartosc = 'MR_T') then '1' else '2' end,
	/*MarzaBiuraPodrozy */	case when EXISTS(SELECT * FROM CDN.TraJPK WHERE TrJ_TrNNumer = t1.trn_gidnumer AND TrJ_TrNTyp = t1.trn_gidtyp and TrJ_Wartosc = 'MR_T')  then '1' else '' end,
	/*MarzaTowaryUzywane */ case when ATR_P_PMarzy_3_1 = 'true' then '1' else '' end,
	/*MarzaDziekaSztuki */	case when ATR_P_PMarzy_3_2 = 'true' then '1' else '' end,
	/*MarzaKolekcjonerskieAntyki */ case when ATR_P_PMarzy_3_3 = 'true' then '1' else '' end, 
	/*RodzajFaktury*/		case when t1.TrN_Gidtyp in (1824,1828) then 'ZAL' 
									when t1.TrN_GIDTyp in (1832, 1836) then 'KOR_ZAL'
									when t1.TrN_GIDTyp in  (2033, 2037) and t1.Trn_SpiTyp&lt;&gt;0 AND EXISTS(SELECT * FROM CDN.TraRozliczZal WHERE TRZ_KonNumer = t1.trn_gidnumer AND TRZ_KonTyp = t1.trn_gidtyp) then 'ROZ'
									when t1.TrN_GIDTyp in  (2033, 2037) and t1.Trn_SpiTyp&lt;&gt;0 AND NOT EXISTS(SELECT * FROM CDN.TraRozliczZal WHERE TRZ_KonNumer = t1.trn_gidnumer AND TRZ_KonTyp = t1.trn_gidtyp) then 'VAT'
									when t1.TrN_GIDTyp in  (2033, 2037) and t1.Trn_SpiTyp = 0  AND EXISTS(SELECT * FROM CDN.TraRozliczZal JOIN cdn.TraNag spiety ON spiety.TrN_GIDTyp=TRZ_KonTyp AND spiety.TrN_GIDNumer=TRZ_KonNumer	 WHERE spiety.TrN_SpiNumer = t1.trn_gidnumer AND spiety.TrN_SpiTyp = t1.trn_gidtyp) then 'ROZ'
									when t1.TrN_GIDTyp in  (2033, 2037) and t1.Trn_SpiTyp = 0  AND NOT EXISTS(SELECT * FROM CDN.TraRozliczZal JOIN cdn.TraNag spiety ON spiety.TrN_GIDTyp=TRZ_KonTyp AND spiety.TrN_GIDNumer=TRZ_KonNumer	 WHERE spiety.TrN_SpiNumer = t1.trn_gidnumer AND spiety.TrN_SpiTyp = t1.trn_gidtyp) then 'VAT'
									when t1.TrN_GIDTyp = 2035 then 'VAT'
									when t1.TrN_GIDTyp in (2041,2045) and t1.TrN_SpiTyp &lt;&gt; 0 AND EXISTS(SELECT * FROM CDN.TraRozliczZal WHERE TRZ_KonNumer = TrS_OrgNumer AND TRZ_KonTyp = TrS_OrgTyp) and t1.TrN_KorektaDanych = 0 then 'KOR_ROZ'
									when t1.TrN_GIDTyp in (2041,2045) and t1.TrN_SpiTyp &lt;&gt; 0 AND (NOT EXISTS(SELECT * FROM CDN.TraRozliczZal WHERE TRZ_KonNumer = TrS_OrgNumer AND TRZ_KonTyp = TrS_OrgTyp) or t1.TrN_KorektaDanych = 1)then 'KOR'
									when t1.TrN_GIDTyp in (2041,2045) and t1.trn_SpiTyp=0 and t1.Trn_ZwrTyp&lt;&gt;t1.Trn_Gidtyp AND EXISTS(SELECT * FROM CDN.TraRozliczZal JOIN cdn.TraNag spiety ON spiety.TrN_GIDTyp=TRZ_KonTyp AND spiety.TrN_GIDNumer=TRZ_KonNumer	 WHERE spiety.TrN_SpiNumer = t1.TrN_ZwrNumer AND spiety.TrN_SpiTyp = t1.TrN_ZwrTyp) and t1.TrN_KorektaDanych = 0 then 'KOR_ROZ'
									when t1.TrN_GIDTyp in (2041,2045) and t1.trn_SpiTyp=0 and t1.Trn_ZwrTyp&lt;&gt;t1.Trn_Gidtyp AND (NOT EXISTS(SELECT * FROM CDN.TraRozliczZal JOIN cdn.TraNag spiety ON spiety.TrN_GIDTyp=TRZ_KonTyp AND spiety.TrN_GIDNumer=TRZ_KonNumer	 WHERE spiety.TrN_SpiNumer = t1.TrN_ZwrNumer AND spiety.TrN_SpiTyp = t1.TrN_ZwrTyp) or t1.TrN_KorektaDanych = 1 ) then 'KOR'
									when t1.TrN_GIDTyp in (2041,2045) and t1.trn_SpiTyp=0 and t1.TrN_KorektaDanych = 1 then 'KOR'
									when t1.TrN_GIDTyp in (2041, 2045) and t1.Trn_ZwrTyp=t1.Trn_GidTyp and t1.Trn_ZwrNumer=0 then 'KOR'
									when t1.TrN_GIDTyp = 2043 then 'KOR'
									else ''
								END,  
	/*PrzyczynaKorekty*/		case when t1.TrN_GIDTyp &amp; 8  = 8 then t1.TrN_PrzyczynaKorekty else '' end,	
	/*OkresFaKorygowanej*/	case when t1.TrN_Gidtyp in (2041,2045) and t1.Trn_ZwrTyp=t1.Trn_GidTyp and t1.Trn_ZwrNumer=0 then 'Od: '+cast(DateAdd(d,t1.TrN_DataOdKor,convert(date,'28-12-1800',105)) as nvarchar(10))+' Do: '+cast(DateAdd(d,t1.TrN_DataDoKor,convert(date,'28-12-1800',105)) as nvarchar(10))
								else ''
								end, 	
	/*FakturaLiczbaWierszy */ 0,
	/*SumaNettoElementow */ 0,
	/*SumaBruttoElementow */ 0,	
	/*SpiNumer*/			case when t1.TRN_SPITYP &lt; 0 then t1.TRN_GIDNUMER else t1.TrN_SpiNumer end as TrN_SpiNumer,
	/*FakturaDoParagonu*/	case when t1.TrN_DokTypJPK = 'FP' then '1' else '' end,
	/*FakturaPowiazanyNabywca*/ case when EXISTS(SELECT * FROM CDN.TraJPK WHERE TrJ_TrNNumer = t1.trn_gidnumer AND TrJ_TrNTyp = t1.trn_gidtyp and TrJ_Wartosc = 'TP') then '1' else '' end,
	/*DodatkowyOpisKlucz*/		case when EXISTS(SELECT * FROM CDN.TrNOpisy WHERE TnO_TrnTyp = t1.TrN_GIDTyp AND TnO_TrnNumer = t1.TrN_GIDNumer) then 'Opis' else '' end,
	/*DodatkowyOpisWartosc*/	coalesce((SELECT TOP 1 left(TnO_Opis,255) FROM CDN.TrNOpisy WHERE TnO_TrnTyp = t1.TrN_GIDTyp AND TnO_TrnNumer = t1.TrN_GIDNumer),''),
	/*StopkaFaktury*/		case when @GidTyp in (2033,2035,2041,2043) then coalesce((select Slw_Nazwa from cdn.DokDefinicje join cdn.Slowniki on Dok_StopkaWydruku = Slw_Id where Dok_FrsId = t1.Trn_FrsId and Dok_GidTyp = 2033),'')
								when @GidTyp in (1824,1832) then coalesce((select Slw_Nazwa from cdn.DokDefinicje join cdn.Slowniki on Dok_StopkaWydruku = Slw_Id where Dok_FrsId = t1.Trn_FrsId and Dok_GidTyp = 1824),'')
								when @GidTyp in (2037,2045) then coalesce((select Slw_Nazwa from cdn.DokDefinicje join cdn.Slowniki on Dok_StopkaWydruku = Slw_Id where Dok_FrsId = t1.Trn_FrsId and Dok_GidTyp = 2037),'')
								when @GidTyp in (1828,1836) then coalesce((select Slw_Nazwa from cdn.DokDefinicje join cdn.Slowniki on Dok_StopkaWydruku = Slw_Id where Dok_FrsId = t1.Trn_FrsId and Dok_GidTyp = 1828),'')
							else ''
							end,
	/*StopkaKRS*/			case when t1.TrN_FrmNumer &lt;&gt; 0 then centrum.Frm_DNumerRej
							else glowna.Frm_DNumerRej
							end,
	/*StopkaREGON*/			case when t1.TrN_FrmNumer &lt;&gt; 0 then 
								case when centrum.Frm_DRodzaj = 1 then centrum.Frm_DRegon
								else ''
								end
							else 
								case when glowna.Frm_DRodzaj = 1 then glowna.Frm_DRegon
								else ''
								end							
							end,							
	/*StopkaBDO*/			case when t1.TrN_FrmNumer &lt;&gt; 0 then centrum.Frm_NumerBDO
							else glowna.Frm_NumerBDO
							end,
	/*FlagaNB*/				t1.TrN_FlagaNB
	from cdn.TraNag t1
	JOIN #StawkiVatZ ON T1.TRN_GIDNumer = TRV_numer AND T1.TRN_GIDTyp = TRV_typ
	LEFT JOIN cdn.firma centrum on T1.TRN_frmnumer = centrum.Frm_gidnumer
	LEFT JOIN cdn.KntAdresy on (case when t1.trn_gidtyp in (2000,2001,2005,2033,2037,1824,1828,2035) then t1.TrN_KAGNumer else t1.trn_knanumer end) = KnA_GidNumer
	LEFT JOIN #Atrybuty_Ksef on T1.TRN_GIDNumer = ATR_GIDNUMER
	LEFT JOIN cdn.tranag tz ON tz.trn_dokumentobcy &lt;&gt; t1.trn_dokumentobcy AND tz.TrN_GIDNumer = (select top 1 trs_orgnumer from CDN.TraSElem where TrS_GIDNumer=t1.TrN_GIDNumer and TrS_OrgTyp &amp; 8 =0) AND t1.trn_gidtyp in (2041,1832,2045,1836,2043)
	JOIN CDN.KntKarty ON Knt_GIDNumer=KnA_KntNumer
	LEFT JOIN CDN.KrajeCelne ON centrum.Frm_DKraj = KPC_NazwaPL
	LEFT JOIN CDN.TraSElem ON t1.TrN_GIDTyp = TrS_GIDTyp AND t1.TrN_GIDNumer = TrS_GIDNumer
	LEFT JOIN CDN.KSeFDokumenty ON TrS_OrgTyp = KSF_DokTyp AND TrS_OrgNumer = KSF_DokNumer	
	LEFT JOIN CDN.Firma glowna ON glowna.Frm_GidNumer = (select FRS_FrmNumer from CDN.FrmStruktura where FRS_StrTyp = 1000 and FRS_Warstwa = 1)
	where (TrS_GIDNumer IS NOT NULL AND TrS_ZwrLp &gt; 0) or TrS_GIDNumer IS NULL

	/*NrFaZaliczkowej*/ SET @fz_tmp = (SELECT
			CASE WHEN t1.TRN_GIDTYP IN (1824,1828) 
				THEN 1
			WHEN T1.TRN_GIDTYP NOT IN (1832,1836) AND T1.TrN_SpiNumer = 0 
				AND EXISTS(SELECT * FROM CDN.TraRozliczZal JOIN CDN.TRANAG spiety on TRZ_KonNumer = spiety.trn_gidnumer AND TRZ_KonTyp = spiety.trn_gidtyp WHERE SPIETY.TrN_SpiNumer = t1.trn_gidnumer AND SPIETY.TrN_SpiTyp = t1.trn_gidtyp)
				THEN 2
			WHEN T1.TRN_GIDTYP NOT IN (1832,1836) 
				AND EXISTS(SELECT * FROM CDN.TraRozliczZal WHERE TRZ_KonNumer = t1.trn_gidnumer AND TRZ_KonTyp = t1.trn_gidtyp)
				THEN 3
			END
		FROM CDN.TraNag t1 WHERE t1.TrN_GIDNumer = @GidNumer and t1.TrN_GIDTyp = @GidTyp)

	IF @fz_tmp = 1
	BEGIN
	INSERT INTO #FakturyZaliczkowe(FZ_GidNumer,FZ_GidTyp,FZ_FakturaZaliczkowaNumer)  
		SELECT DISTINCT @GidNumer, @GidTyp, 
		case when @CzyWysylacSystemowyNrDok = 0 then
			zal.Trn_DokumentObcy 
		else
				cdn.NumerDokumentuZ(zal.TrN_GidTyp,zal.TrN_SpiTyp,zal.TrN_TrNTyp,zal.TrN_TrNNumer,zal.TrN_TrNRok,zal.TrN_TrNSeria,zal.TrN_TrNMiesiac,zal.TrN_ZwrTyp,zal.TrN_ZwrNumer,zal.TrN_WMS)
		end
		FROM CDN.tranag zal join CDN.TraNag t1 ON t1.TrN_GIDNumer = @GidNumer and t1.TrN_GIDTyp = @GidTyp  where zal.TrN_GIDTyp &amp; 8 = 0 AND zal.Trn_DokumentObcy &lt;&gt; '' AND zal.TrN_ZaNNumer &lt;&gt; 0 AND zal.TrN_ZaNNumer = t1.TrN_ZaNNumer AND zal.TrN_ZaNTyp = t1.TrN_ZaNTyp AND zal.TrN_gidnumer &lt; t1.TrN_GidNumer  AND zal.TrN_stan  in (3,4,5) and zal.TrN_GIDTyp in (1824,1828)
	END
	IF @fz_tmp = 2
	BEGIN
	INSERT INTO #FakturyZaliczkowe(FZ_GidNumer,FZ_GidTyp,FZ_FakturaZaliczkowaNumer) 
		SELECT DISTINCT @GidNumer, @GidTyp, 
		case when @CzyWysylacSystemowyNrDok = 0 then
			zal.Trn_DokumentObcy 
		else
				cdn.NumerDokumentuZ(zal.TrN_GidTyp,zal.TrN_SpiTyp,zal.TrN_TrNTyp,zal.TrN_TrNNumer,zal.TrN_TrNRok,zal.TrN_TrNSeria,zal.TrN_TrNMiesiac,zal.TrN_ZwrTyp,zal.TrN_ZwrNumer,zal.TrN_WMS)
		end 
		FROM CDN.TraRozliczZal JOIN CDN.TRANAG spiety on TRZ_KonNumer = spiety.trn_gidnumer AND TRZ_KonTyp = spiety.trn_gidtyp JOIN CDN.TraNag zal on TRZ_ZalNumer = zal.TrN_GIDNumer AND TRZ_ZalTyp = zal.TrN_GIDTyp  join CDN.TraNag t1 ON t1.TrN_GIDNumer = @GidNumer and t1.TrN_GIDTyp = @GidTyp WHERE zal.TrN_GIDTyp &amp; 8 = 0 AND SPIETY.TrN_SpiNumer = t1.trn_gidnumer AND SPIETY.TrN_SpiTyp = t1.trn_gidtyp AND zal.Trn_DokumentObcy &lt;&gt; '' and zal.TrN_GIDTyp in (1824,1828)
	END
	IF @fz_tmp = 3
	BEGIN
	INSERT INTO #FakturyZaliczkowe(FZ_GidNumer,FZ_GidTyp,FZ_FakturaZaliczkowaNumer) 
		SELECT DISTINCT @GidNumer, @GidTyp, 
		case when @CzyWysylacSystemowyNrDok = 0 then
			zal.Trn_DokumentObcy 
		else
				cdn.NumerDokumentuZ(zal.TrN_GidTyp,zal.TrN_SpiTyp,zal.TrN_TrNTyp,zal.TrN_TrNNumer,zal.TrN_TrNRok,zal.TrN_TrNSeria,zal.TrN_TrNMiesiac,zal.TrN_ZwrTyp,zal.TrN_ZwrNumer,zal.TrN_WMS)
		end 
		FROM CDN.TraRozliczZal JOIN CDN.TraNag zal on TRZ_ZalNumer = zal.TrN_GIDNumer AND TRZ_ZalTyp = zal.TrN_GIDTyp join CDN.TraNag t1 ON t1.TrN_GIDNumer = @GidNumer and t1.TrN_GIDTyp = @GidTyp WHERE zal.TrN_GIDTyp &amp; 8 = 0 AND TRZ_KonNumer = t1.trn_gidnumer AND TRZ_KonTyp = t1.trn_gidtyp AND zal.Trn_DokumentObcy &lt;&gt; '' and zal.TrN_GIDTyp in (1824,1828)
	END	

	INSERT INTO #DaneFaKorygowanej (DFK_GidNumer,DFK_GidTyp,DFK_DataWystFaKorygowanej,DFK_NrFaKorygowanej,DFK_NrKSeFFaKorygowanej)
		SELECT DISTINCT @GidNumer, @GidTyp,
		/*DataWystFaKorygowanej*/ 	isnull(case when (t1.TrN_GIDTyp in (2041,2045) and ((TrS_ZwrTyp &lt;&gt; t1.TrN_GIDTyp or t1.TrN_ZwrTyp &lt;&gt; t1.TrN_GIDTyp) or t1.TrN_KorektaDanych = 1)) or t1.TrN_GIDTyp in (1832,1836,2043) then 
											case when ksef.ksf_TStampWyslania is not null then ksef.ksf_TStampWyslania/86400+69035 
											else (select ksf_TStampWyslania from CDN.KSeFDokumenty where t1.TrN_ZwrTyp = KSF_DokTyp AND t1.TrN_ZwrNumer = KSF_DokNumer)/86400+69035 
											end
										when t1.TrN_GIDTyp in (2041,2045) and t1.TrN_ZwrTyp = t1.TrN_GIDTyp and t1.TrN_ZwrNumer = 0 and korZbOrg.TrN_SpiTyp &gt; 0 then ksefKorZb.ksf_TStampWyslania/86400+69035
										when t1.TrN_GIDTyp in (2041,2045) and t1.TrN_ZwrTyp = t1.TrN_GIDTyp and t1.TrN_ZwrNumer = 0 and korZbOrg.TrN_SpiTyp &lt; 0 then 
												(select ksf_TStampWyslania from CDN.KSeFDokumenty where korZbOrg.TrN_GIDTyp = KSF_DokTyp AND korZbOrg.TrN_GIDNumer = KSF_DokNumer)/86400+69035
										when t1.TrN_GIDTyp in (2041,2045) and ((TrS_ZwrTyp = t1.TrN_GIDTyp and TrS_ZwrNumer = t1.TrN_GIDNumer) or (t1.Trn_ZwrTyp = t1.TrN_GIDTyp and t1.Trn_ZwrNumer = t1.TrN_GIDNumer)) then t1.TrN_DataWystOrg 
										else 
											case when t1.trn_gidtyp in (2041,1832,2045,1836,2043) then 
												ksef.KSF_TStampWyslania/86400+69035 
											end
									end,0),
		/*NrFaKorygowanej*/	isnull(case when t1.TrN_GIDTyp in (2041,2045) and ((TrS_ZwrTyp = t1.TrN_GIDTyp and TrS_ZwrNumer = 0) or (t1.TrN_ZwrTyp = t1.TrN_GIDTyp and t1.TrN_ZwrNumer = 0)) then 
									case when korZbWZK.TrN_GIDNumer IS NOT NULL then 
										case when  korZbOrg.TrN_SpiTyp &lt; 0 then
											case when @CzyWysylacSystemowyNrDok = 0 then
												(select TrN_DokumentObcy from cdn.TraNag where TrN_GIDTyp = korZbOrg.TrN_GIDTyp and TrN_GIDNumer = korZbOrg.TrN_GIDNumer)
											else
												(select CDN.NumerDokumentuZ(TrN_GidTyp,TrN_SpiTyp,TrN_TrNTyp,TrN_TrNNumer,TrN_TrNRok,TrN_TrNSeria,TrN_TrNMiesiac,TrN_ZwrTyp,TrN_ZwrNumer,default) 
													from cdn.TraNag where TrN_GIDTyp = korZbOrg.TrN_GIDTyp and TrN_GIDNumer = korZbOrg.TrN_GIDNumer)
											end
										else
											case when @CzyWysylacSystemowyNrDok = 0 then
												(select TrN_DokumentObcy from cdn.TraNag where TrN_GIDTyp = korZbOrg.TrN_SpiTyp and TrN_GIDNumer = korZbOrg.TrN_SpiNumer)
											else
												(select CDN.NumerDokumentuZ(TrN_GidTyp,TrN_SpiTyp,TrN_TrNTyp,TrN_TrNNumer,TrN_TrNRok,TrN_TrNSeria,TrN_TrNMiesiac,TrN_ZwrTyp,TrN_ZwrNumer,default) 
													from cdn.TraNag where TrN_GIDTyp = korZbOrg.TrN_SpiTyp and TrN_GIDNumer = korZbOrg.TrN_SpiNumer)
											end
										end
									else
										''
									end
								else
								case 
										when t1.trn_gidtyp in (2041,2045) and  ((TrS_ZwrTyp = t1.TrN_GIDTyp and TrS_ZwrNumer = t1.TrN_GIDNumer) or (t1.TrN_ZwrTyp = t1.TrN_GIDTyp and t1.TrN_ZwrNumer = t1.TrN_GIDNumer)) then
												T1.TrN_NrKorekty 
										when t1.trn_gidtyp in (2041,1832,2045,1836,2043) then 
											case when @CzyWysylacSystemowyNrDok = 0 then
												(select TrN_DokumentObcy from cdn.TraNag where TrN_GIDTyp = @gidTypOrg and TrN_GIDNumer = @gidNumerOrg)  
											else
												(select CDN.NumerDokumentuZ(TrN_GidTyp,TrN_SpiTyp,TrN_TrNTyp,TrN_TrNNumer,TrN_TrNRok,TrN_TrNSeria,TrN_TrNMiesiac,TrN_ZwrTyp,TrN_ZwrNumer,default) 
												from cdn.TraNag where TrN_GIDTyp = @gidTypOrg and TrN_GIDNumer = @gidNumerOrg)
											end
									end 
								end,''),
		/*NrKSeFFaKorygowanej*/ isnull(case when (t1.TrN_GIDTyp in (2041,2045) and ((TrS_ZwrTyp &lt;&gt; t1.TrN_GIDTyp or t1.TrN_ZwrTyp &lt;&gt; t1.TrN_GIDTyp) or t1.TrN_KorektaDanych = 1))  or t1.TrN_GIDTyp in (1832,1836,2043) then
										case when ksef.ksf_TStampWyslania is not null then ksef.KSF_Numer
										else (select KSF_Numer from CDN.KSeFDokumenty where t1.TrN_ZwrTyp = KSF_DokTyp AND t1.TrN_ZwrNumer = KSF_DokNumer)
										end
									when t1.TrN_GIDTyp in (2041,2045) and t1.TrN_ZwrTyp = t1.TrN_GIDTyp and t1.TrN_ZwrNumer = 0 and korZbOrg.TrN_SpiTyp &gt; 0 then ksefKorZb.KSF_Numer
									when t1.TrN_GIDTyp in (2041,2045) and t1.TrN_ZwrTyp = t1.TrN_GIDTyp and t1.TrN_ZwrNumer = 0 and korZbOrg.TrN_SpiTyp &lt; 0 then 
												(select KSF_Numer from CDN.KSeFDokumenty where korZbOrg.TrN_GIDTyp = KSF_DokTyp AND korZbOrg.TrN_GIDNumer = KSF_DokNumer)
									when t1.TrN_GIDTyp in (2041,2045) and ((TrS_ZwrTyp = t1.TrN_GIDTyp and TrS_ZwrNumer = t1.TrN_GIDNumer) or (t1.Trn_ZwrTyp = t1.TrN_GIDTyp and t1.Trn_ZwrNumer = t1.TrN_GIDNumer)) then t1.TrN_KSeFNumerOrg 
									else 
										case when t1.trn_gidtyp in (2041,1832,2045,1836,2043) then 
											ksef.KSF_Numer
										end
									end,'')
		FROM cdn.TraNag t1
		LEFT JOIN cdn.tranag tz ON tz.trn_dokumentobcy &lt;&gt; t1.trn_dokumentobcy AND tz.TrN_GIDNumer = (select top 1 trs_orgnumer from CDN.TraSElem where TrS_GIDNumer=t1.TrN_GIDNumer and TrS_OrgTyp &amp; 8 =0) AND t1.trn_gidtyp in (2041,1832,2045,1836,2043)
		LEFT JOIN CDN.TraSElem ON t1.TrN_GIDTyp = TrS_GIDTyp AND t1.TrN_GIDNumer = TrS_GIDNumer
		LEFT JOIN CDN.KSeFDokumenty ksef ON KSF_DokTyp = @gidTypOrg AND KSF_DokNumer = @gidNumerOrg	
		left join  cdn.tranag korZbWZK on korZbWZK.TrN_SpiTyp=t1.TrN_GIDTyp and korZbWZK.TrN_SpiNumer=t1.TrN_GIDNumer
		left join  cdn.tranag korZbOrg on korZbOrg.TrN_GIDTyp=korZbWZK.TrN_ZwrTyp and korZbOrg.TrN_GIDNumer=korZbWZK.TrN_ZwrNumer
		LEFT JOIN CDN.KSeFDokumenty ksefKorZb ON korZbOrg.TrN_SpiTyp = ksefKorZb.KSF_DokTyp AND korZbOrg.TrN_SpiNumer = ksefKorZb.KSF_DokNumer	
		where t1.TrN_GIDNumer = @GidNumer and t1.TrN_GIDTyp = @GidTyp AND @GidTyp IN (2041,2043,1832,2045,1836) and ((TrS_GIDNumer IS NOT NULL AND TrS_ZwrLp &gt; 0) or TrS_GIDNumer IS NULL)

	--Odbiorca (knt docelowy)
	INSERT INTO #Podmiot3
	SELECT DISTINCT 
	/*Podmiot3Rola*/	'1',
	/*Podmiot3NIP*/ case when ATR_KSEF_Odbiorca_NrID &lt;&gt; '' or (KnA_Kraj &lt;&gt; 'PL' and KnA_Kraj &lt;&gt; '') then '' else KnA_Nip end,
	/*Podmiot3NrID*/ case when ATR_KSEF_Odbiorca_NrID &lt;&gt; '' then ATR_KSEF_Odbiorca_NrID
						when (KnA_Kraj &lt;&gt; 'PL' and KnA_Kraj &lt;&gt;'') then KnA_NipE 
						else ''
						end,
	/*Podmiot3BrakID*/ case when ATR_KSEF_Odbiorca_NrID = '' and KnA_Nip = '' then '1' else '' end,
	/*Podmiot3ImiePierwsze*/ case when Knt_Status = 2 then 
									case when ATR_KSEF_Odbiorca_ImiePierwsze &lt;&gt; '' then left(ATR_KSEF_Odbiorca_ImiePierwsze,30) 
									else left((select LEFT(KnA_Nazwa1, case when  CHARINDEX(' ', KnA_Nazwa1 ) = 0 then LEN(KnA_Nazwa1) 
									else CHARINDEX(' ', KnA_Nazwa1) -1 end)),30) end
							else '' end,
	/*Podmiot3Nazwisko*/ case when Knt_Status = 2 then
								case when ATR_KSEF_Odbiorca_Nazwisko &lt;&gt; '' then left(ATR_KSEF_Odbiorca_Nazwisko,81) 
								else left((select RIGHT(KnA_Nazwa1, case when  CHARINDEX(' ', KnA_Nazwa1 ) = 0 then LEN(KnA_Nazwa1) 
								else CHARINDEX(' ', reverse(KnA_Nazwa1)) -1 end)),81) end
						else '' end,	
	/*Podmiot3PelnaNazwa*/ case when Knt_Status = 1 then left(KnA_Nazwa1+' '+KnA_Nazwa2+' '+KnA_Nazwa3,256) else '' end,
	/*Podmiot3KodKraju*/ case when KnA_Kraj = 'PL' or KnA_Kraj = '' then 'PL' else KnA_Kraj end,
	/*Podmiot3Wojewodztwo*/	KnA_Wojewodztwo,
	/*Podmiot3Powiat*/		KnA_Powiat,
	/*Podmiot3Gmina*/		KnA_Gmina,
	/*Podmiot3Ulica*/ case when ATR_KSEF_Odbiorca_Ulica = '&lt;Brak&gt;'then ''
						when ATR_KSEF_Odbiorca_Ulica &lt;&gt; '&lt;Brak&gt;' and ATR_KSEF_Odbiorca_Ulica &lt;&gt; '' then ATR_KSEF_Odbiorca_Ulica
						else cdn.ParsujAdres(KnA_Ulica,1) end,
	/*Podmiot3NrDomu*/ case when ATR_KSEF_Odbiorca_NrDomu &lt;&gt; '' then left(ATR_KSEF_Odbiorca_NrDomu,9) else left(cdn.ParsujAdres(KnA_Ulica,2),9) end,
	/*Podmiot3NrLokalu*/ case when ATR_KSEF_Odbiorca_NrLokalu &lt;&gt; '' then left(ATR_KSEF_Odbiorca_NrLokalu,10) else left(cdn.ParsujAdres(KnA_Ulica,3),10) end,
	/*Podmiot3Miejscowosc*/ KnA_Miasto,
	/*Podmiot3KodPocztowy*/ KnA_KodP,
	/*Podmiot3Poczta*/	KnA_Miasto,
	/*Podmiot3GLN*/		KnA_GLN,
	/*Podmiot3Email*/	KnA_Email,
	/*Podmiot3Tel*/		left(Kna_Telefon1,16)
	FROM cdn.TraNag
	LEFT JOIN cdn.KntAdresy on TrN_AdWNumer = KnA_GIDNumer
	LEFT JOIN #Atrybuty_Ksef on TRN_GIDNumer = ATR_GIDNUMER
	JOIN CDN.KntKarty ON Knt_GIDNumer=KnA_KntNumer
	WHERE TrN_GIDNumer = @GidNumer and TrN_GIDTyp = @GidTyp and Trn_AdWNumer&lt;&gt;Trn_KnANumer

	--Płatnik
	INSERT INTO #Podmiot3
	SELECT DISTINCT 
	/*Podmiot3Rola*/	'5',
	/*Podmiot3NIP*/ case when ATR_KSEF_Platnik_NrID &lt;&gt; '' or (KnA_Kraj &lt;&gt; 'PL' and KnA_Kraj &lt;&gt; '') then '' else KnA_Nip end,
	/*Podmiot3NrID*/ case when ATR_KSEF_Platnik_NrID &lt;&gt; '' then ATR_KSEF_Platnik_NrID
						when (KnA_Kraj &lt;&gt; 'PL' and KnA_Kraj &lt;&gt;'') then KnA_NipE 
						else ''
						end,
	/*Podmiot3BrakID*/ case when ATR_KSEF_Platnik_NrID = '' and KnA_Nip = '' then '1' else '' end,
	/*Podmiot3ImiePierwsze*/ case when Knt_Status = 2 then 
									case when ATR_KSEF_Platnik_ImiePierwsze &lt;&gt; '' then left(ATR_KSEF_Platnik_ImiePierwsze,30) 
									else left((select LEFT(KnA_Nazwa1, case when  CHARINDEX(' ', KnA_Nazwa1 ) = 0 then LEN(KnA_Nazwa1) 
									else CHARINDEX(' ', KnA_Nazwa1) -1 end)),30) end
							else '' end,
	/*Podmiot3Nazwisko*/ case when Knt_Status = 2 then
								case when ATR_KSEF_Platnik_Nazwisko &lt;&gt; '' then left(ATR_KSEF_Platnik_Nazwisko,81) 
								else left((select RIGHT(KnA_Nazwa1, case when  CHARINDEX(' ', KnA_Nazwa1 ) = 0 then LEN(KnA_Nazwa1) 
								else CHARINDEX(' ', reverse(KnA_Nazwa1)) -1 end)),81) end
						else '' end,	
	/*Podmiot3PelnaNazwa*/ case when Knt_Status = 1 then left(KnA_Nazwa1+' '+KnA_Nazwa2+' '+KnA_Nazwa3,256) else '' end,
	/*Podmiot3KodKraju*/ case when KnA_Kraj = 'PL' or KnA_Kraj = '' then 'PL' else KnA_Kraj end,
	/*Podmiot3Wojewodztwo*/	KnA_Wojewodztwo,
	/*Podmiot3Powiat*/		KnA_Powiat,
	/*Podmiot3Gmina*/		KnA_Gmina,
	/*Podmiot3Ulica*/ case when ATR_KSEF_Platnik_Ulica = '&lt;Brak&gt;'then ''
						when ATR_KSEF_Platnik_Ulica &lt;&gt; '&lt;Brak&gt;' and ATR_KSEF_Platnik_Ulica &lt;&gt; '' then ATR_KSEF_Platnik_Ulica
						else cdn.ParsujAdres(KnA_Ulica,1) end,
	/*Podmiot3NrDomu*/ case when ATR_KSEF_Platnik_NrDomu &lt;&gt; '' then left(ATR_KSEF_Platnik_NrDomu,9) else left(cdn.ParsujAdres(KnA_Ulica,2),9) end,
	/*Podmiot3NrLokalu*/ case when ATR_KSEF_Platnik_NrLokalu &lt;&gt; '' then left(ATR_KSEF_Platnik_NrLokalu,10) else left(cdn.ParsujAdres(KnA_Ulica,3),10) end,
	/*Podmiot3Miejscowosc*/ KnA_Miasto,
	/*Podmiot3KodPocztowy*/ KnA_KodP,
	/*Podmiot3Poczta*/	KnA_Miasto,
	/*Podmiot3GLN*/		KnA_GLN,
	/*Podmiot3Email*/	KnA_Email,
	/*Podmiot3Tel*/		left(Kna_Telefon1,16)
	FROM cdn.TraNag
	LEFT JOIN cdn.KntAdresy on TrN_AdPNumer = KnA_GIDNumer
	LEFT JOIN #Atrybuty_Ksef on TRN_GIDNumer = ATR_GIDNUMER
	JOIN CDN.KntKarty ON Knt_GIDNumer=KnA_KntNumer
	WHERE TrN_GIDNumer = @GidNumer and TrN_GIDTyp = @GidTyp and Trn_AdPNumer&lt;&gt;Trn_KnANumer

	--korekta danych kontrahenta
	INSERT INTO #Podmiot2K
	SELECT DISTINCT
	/*P2K_KorDanychNabywcaPrefiksNIP*/	case when kor.TrN_ExpoNorm in (6,7,8,9,10,11,12,13,16,17,18,19,21) then KnA_NipPrefiks else '' end,
	/*P2K_KorDanychNabywcaNIP*/			case when ATR_KSEFKorygowanych_Nabywca_NrID &lt;&gt; '' or (KnA_Kraj &lt;&gt; 'PL' and KnA_Kraj &lt;&gt; '') then '' else KnA_Nip end,
	/*P2K_KorDanychNabywcaNrID*/		case when ATR_KSEFKorygowanych_Nabywca_NrID &lt;&gt; '' then ATR_KSEFKorygowanych_Nabywca_NrID
										when (KnA_Kraj &lt;&gt; 'PL' and KnA_Kraj &lt;&gt;'') then KnA_NipE 
										else ''
										end,
	/*P2K_KorDanychNabywcaBrakID*/		case when ATR_KSEFKorygowanych_Nabywca_NrID = '' and KnA_Nip = '' then '1' else '' end,
	/*P2K_KorDanychNabywcaImiePierwsze*/ case when Knt_Status = 2 then 
										case when ATR_KSEFKorygowanych_Nabywca_ImiePierwsze &lt;&gt; '' then ATR_KSEFKorygowanych_Nabywca_ImiePierwsze 
											else (select LEFT(KnA_Nazwa1, case when  CHARINDEX(' ', KnA_Nazwa1 ) = 0 then LEN(KnA_Nazwa1) 
													else CHARINDEX(' ', KnA_Nazwa1) -1 end)) end
									else '' end,
	/*P2K_KorDanychNabywcaNazwisko*/	case when Knt_Status = 2 then
										case when ATR_KSEFKorygowanych_Nabywca_Nazwisko &lt;&gt; '' then ATR_KSEFKorygowanych_Nabywca_Nazwisko 
											else (select RIGHT(KnA_Nazwa1, case when  CHARINDEX(' ', KnA_Nazwa1 ) = 0 then LEN(KnA_Nazwa1) 
													else CHARINDEX(' ', reverse(KnA_Nazwa1)) -1 end)) end
									else '' end,
	/*P2K_KorDanychNabywcaPelnaNazwa*/	case when Knt_Status = 1 then KnA_Nazwa1+' '+KnA_Nazwa2+' '+KnA_Nazwa3 else '' end,
	/*P2K_KorDanychNabywcaKodKraju*/	case when KnA_Kraj = 'PL' or KnA_Kraj = '' then 'PL' else KnA_Kraj end,
	/*P2K_KorDanychNabywcaWojewodztwo*/ KnA_Wojewodztwo,
	/*P2K_KorDanychNabywcaPowiat*/		KnA_Powiat,
	/*P2K_KorDanychNabywcaGmin*/		KnA_Gmina,
	/*P2K_KorDanychNabywcaUlica*/		case when ATR_KSEFKorygowanych_Nabywca_Ulica = '&lt;Brak&gt;'then ''
									when ATR_KSEFKorygowanych_Nabywca_Ulica &lt;&gt; '&lt;Brak&gt;' and ATR_KSEFKorygowanych_Nabywca_Ulica &lt;&gt; '' then ATR_KSEFKorygowanych_Nabywca_Ulica
									else cdn.ParsujAdres(KnA_Ulica,1) end,
	/*P2K_KorDanychNabywcaNrDomu*/		case when ATR_KSEFKorygowanych_Nabywca_NrDomu &lt;&gt; '' then ATR_KSEFKorygowanych_Nabywca_NrDomu else cdn.ParsujAdres(KnA_Ulica,2) end,
	/*P2K_KorDanychNabywcaNrLokalu*/	case when ATR_KSEFKorygowanych_Nabywca_NrLokalu &lt;&gt; '' then ATR_KSEFKorygowanych_Nabywca_NrLokalu else cdn.ParsujAdres(KnA_Ulica,3) end,
	/*P2K_KorDanychNabywcaMiejscowosc*/	KnA_Miasto,
	/*P2K_KorDanychNabywcaKodPocztowy*/	KnA_KodP,
	/*P2K_KorDanychNabywcaPoczta*/		KnA_Miasto,
	/*P2K_KorDanychNabywcaGLN*/			KnA_GLN
	FROM cdn.TraNag kor  
	JOIN cdn.TraNag org ON org.TrN_GIDNumer = kor.TrN_ZwrNumer and org.TrN_GIDTyp = kor.TrN_ZwrTyp
	LEFT JOIN cdn.KntAdresy on org.TrN_KnANumer = KnA_GIDNumer
	LEFT JOIN #Atrybuty_KsefKorygowanych on org.TRN_GIDNumer = ATR_KSEFKorygowanych_GIDNUMER
	JOIN CDN.KntKarty ON Knt_GIDNumer=KnA_KntNumer
	WHERE kor.TrN_GIDNumer = @GidNumer and kor.TrN_GIDTyp = @GidTyp 
			and kor.Trn_GidTyp in (2041, 2043, 1832, 2045, 1836) and kor.Trn_KorektaDanych=1 
			and kor.TrN_KnANumer &lt;&gt; org.TrN_KnANumer

	--Numery zamówień
	SET @nrZ_tmp = (SELECT	
			CASE WHEN ((TrN_GIDTyp in (2033,2037,1824,1828) and TrN_SpiTyp &gt; 0) 
							or ((TrN_GIDTyp in (2033,2037) and TrN_SpiTyp = 0) or TrN_GIDTyp = 2035) 
							or (TrN_GIDTyp in (2033,2037) and TrN_SpiTyp &lt; 0 )) 
							and TrN_ZamDokumentObcy &lt;&gt; ''
				THEN 1	--FS,FSE,FSL,FEL
			WHEN TrN_GIDTyp in (2033,2037,1824,1828) and TrN_ZaNTyp = 960 and TrN_ZaNNumer &lt;&gt; 0 and TrN_ZamDokumentObcy = ''
				THEN 2	--FS,FSE,FSL,FEL
			WHEN TrN_GIDTyp in (2033,2037,1824,1828) and TrN_ZaNTyp = 960 and TrN_ZaNNumer = 0 and TrN_ZamDokumentObcy = ''
				THEN 3	--FS,FSE,FSL,FEL
			WHEN (TrN_GIDTyp in (2033,2037) and TrN_SpiTyp = 0) or TrN_GIDTyp = 2035 and TrN_ZamDokumentObcy = ''
				THEN 4	--(S)FS,(S)FSE,RA			
			WHEN TrN_GIDTyp in (2033,2037) and TrN_SpiTyp &lt; 0 and TrN_ZamDokumentObcy = ''
				THEN 5	--(s)FS,(s)FSE
			END
		from cdn.TraNag
		where TrN_GIDNumer = @GidNumer and TrN_GIDTyp = @GidTyp )

	IF @nrZ_tmp = 1
	BEGIN
	INSERT INTO #ZamowienieNumer(ZN_GidNumer,ZN_GidTyp,ZN_NrZamowienia)  
		SELECT DISTINCT @GidNumer, @GidTyp, TrN_ZamDokumentObcy 
			from cdn.TraNag where TrN_GIDNumer = @GidNumer and TrN_GIDTyp = @GidTyp 
	END

	IF @nrZ_tmp = 2
	BEGIN
	INSERT INTO #ZamowienieNumer(ZN_GidNumer,ZN_GidTyp,ZN_NrZamowienia)  
		SELECT DISTINCT @GidNumer, @GidTyp, (select isnull(CDN.NumerDokumentu( CDN.DokMapTypDokumentu (ZaN_GIDTyp,ZaN_ZamTyp, ZaN_Rodzaj),0,0,ZaN_ZamNumer,ZaN_ZamRok,ZaN_ZamSeria,ZaN_ZamMiesiac),'') 
			from cdn.ZamNag where ZaN_GIDNumer = TrN_ZaNNumer and ZaN_GIDTyp = TrN_ZaNTyp) from cdn.TraNag where TrN_GIDNumer = @GidNumer and TrN_GIDTyp = @GidTyp 
	END

	IF @nrZ_tmp = 3
	BEGIN
	INSERT INTO #ZamowienieNumer(ZN_GidNumer,ZN_GidTyp,ZN_NrZamowienia)  
		SELECT DISTINCT @GidNumer, @GidTyp, (select isnull(CDN.NumerDokumentu( CDN.DokMapTypDokumentu (ZaN_GIDTyp,ZaN_ZamTyp, ZaN_Rodzaj),0,0,ZaN_ZamNumer,ZaN_ZamRok,ZaN_ZamSeria,ZaN_ZamMiesiac),'') 
			from cdn.ZamNag where ZaN_GIDNumer = TrS_ZlcNumer and ZaN_GIDTyp = TrS_ZlcTyp) from cdn.TraNag join cdn.TraSElem on TrN_GIDTyp=TrS_GIDTyp AND TrN_GIDNumer=TrS_GIDNumer
			where TrN_GIDNumer = @GidNumer and TrN_GIDTyp = @GidTyp and TrS_ZlcTyp = 960
	END

	IF @nrZ_tmp = 4	
	BEGIN
	INSERT INTO #ZamowienieNumer(ZN_GidNumer,ZN_GidTyp,ZN_NrZamowienia)  
		SELECT DISTINCT @GidNumer, @GidTyp, 
		(select isnull(CDN.NumerDokumentu( CDN.DokMapTypDokumentu (ZaN_GIDTyp,ZaN_ZamTyp, ZaN_Rodzaj),0,0,ZaN_ZamNumer,ZaN_ZamRok,ZaN_ZamSeria,ZaN_ZamMiesiac),''))
		from cdn.TraNag spinacz 
			join cdn.TraNag spiety on spinacz.TrN_GIDNumer = spiety.TrN_SpiNumer and spinacz.TrN_GIDTyp = spiety.TrN_SpiTyp 
			join cdn.TraSElem on spiety.TrN_GIDTyp=TrS_GIDTyp AND spiety.TrN_GIDNumer=TrS_GIDNumer
			join cdn.ZamNag on ZaN_GIDNumer = TrS_ZlcNumer and ZaN_GIDTyp = TrS_ZlcTyp
			where spinacz.TrN_GIDNumer = @GidNumer and spinacz.TrN_GIDTyp = @GidTyp and TrS_ZlcTyp = 960
	END

	IF @nrZ_tmp = 5
	BEGIN
	INSERT INTO #ZamowienieNumer(ZN_GidNumer,ZN_GidTyp,ZN_NrZamowienia)  
		SELECT DISTINCT @GidNumer, @GidTyp, (select isnull(CDN.NumerDokumentu( CDN.DokMapTypDokumentu (ZaN_GIDTyp,ZaN_ZamTyp, ZaN_Rodzaj),0,0,ZaN_ZamNumer,ZaN_ZamRok,ZaN_ZamSeria,ZaN_ZamMiesiac),''))
		from cdn.TraNag spinacz
			join cdn.TraSElem elemSpinacza on spinacz.TrN_GIDTyp=elemSpinacza.TrS_ZwrTyp AND spinacz.TrN_GIDNumer=elemSpinacza.TrS_ZwrNumer
			join cdn.TraNag spiety on spiety.TrN_GIDTyp = elemSpinacza.TrS_SpiTyp and spiety.TrN_GIDNumer = elemSpinacza.TrS_SpiNumer
			join cdn.TraSElem elemSpietego on spiety.TrN_GIDTyp=elemSpietego.TrS_ZwrTyp AND spiety.TrN_GIDNumer=elemSpietego.TrS_ZwrNumer
			join cdn.ZamNag on ZaN_GIDNumer = elemSpietego.TrS_ZlcNumer and ZaN_GIDTyp = elemSpietego.TrS_ZlcTyp
		where spinacz.TrN_GIDNumer = @GidNumer and spinacz.TrN_GIDTyp = @GidTyp
	END
	--Numery WZ
	SET @nw_tmp = (SELECT
			CASE WHEN TrN_GIDTyp in (2033, 2041, 2037, 2045) and TrN_SpiTyp = 0 and Trn_ZwrTyp &lt;&gt; Trn_GidTyp 
				THEN 1	--spinacze nagłówkowe i spinacze koret nagłówkowych
			WHEN TrN_SpiTyp = -TrN_GIDTyp
				THEN 2	--spinacze elementów		
			END
		from cdn.TraNag
		where TrN_GIDNumer = @GidNumer and TrN_GIDTyp = @GidTyp )
	
	IF @nw_tmp = 1
	BEGIN
	INSERT INTO #NumeryWZ(NW_GidNumer,NW_GidTyp,NW_NumerWZ)  
		SELECT DISTINCT @GidNumer, @GidTyp, 
			case when @CzyWysylacSystemowyNrDok = 0 then
			spiety.Trn_DokumentObcy
			else
				cdn.NumerDokumentuZ(spiety.TrN_GidTyp,spiety.TrN_SpiTyp,spiety.TrN_TrNTyp,spiety.TrN_TrNNumer,spiety.TrN_TrNRok,spiety.TrN_TrNSeria,spiety.TrN_TrNMiesiac,spiety.TrN_ZwrTyp,spiety.TrN_ZwrNumer,spiety.TrN_WMS)
			end
		from cdn.TraNag spinacz 
			join cdn.TraNag spiety on spinacz.TrN_GIDNumer = spiety.TrN_SpiNumer and spinacz.TrN_GIDTyp = spiety.TrN_SpiTyp
			where spinacz.TrN_GIDNumer = @GidNumer and spinacz.TrN_GIDTyp = @GidTyp
	END

	IF @nw_tmp = 2
	BEGIN
	INSERT INTO #NumeryWZ(NW_GidNumer,NW_GidTyp,NW_NumerWZ)  
		SELECT DISTINCT @GidNumer, @GidTyp, 
			case when @CzyWysylacSystemowyNrDok = 0 then
				spiety.Trn_DokumentObcy
			else
				cdn.NumerDokumentuZ(spiety.TrN_GidTyp,spiety.TrN_SpiTyp,spiety.TrN_TrNTyp,spiety.TrN_TrNNumer,spiety.TrN_TrNRok,spiety.TrN_TrNSeria,spiety.TrN_TrNMiesiac,spiety.TrN_ZwrTyp,spiety.TrN_ZwrNumer,spiety.TrN_WMS)
			end
		from cdn.TraNag spinacz
			join cdn.TraSElem on spinacz.TrN_GIDTyp=TrS_ZwrTyp AND spinacz.TrN_GIDNumer=TrS_ZwrNumer
			join cdn.TraNag spiety on spiety.TrN_GIDTyp = TrS_SpiTyp and spiety.TrN_GIDNumer = TrS_SpiNumer
			where TrS_GIDNumer = @GidNumer and TrS_GIDTyp = @GidTyp
	END
			
	--DOKUMENT NIESPIĘTY SPRZEDAŻOWY/SPINACZ ELEMENTÓW
	insert into #DaneWiersz 
	select distinct 

	
	/*ElementLp*/	GidLp,
	/*ElementNazwa*/ case when A.TrN_TrNTyp in (12,13) AND (A.TrE_GIDNumer is null OR A.tre_TwrNazwa = '') then 'Koszt' when A.TrE_GIDNumer is null then  (case when A.trn_gidtyp in (1824,1828,1832,1836) then 'Zaliczka na poczet zamówienia – '+ ISNULL(CDN.NumerDokumentu( CDN.DokMapTypDokumentu (ZaN_GIDTyp,ZaN_ZamTyp, ZaN_Rodzaj),0,0,ZaN_ZamNumer,ZaN_ZamRok,ZaN_ZamSeria,ZaN_ZamMiesiac),'') else '' end) else isnull(A.tre_TwrNazwa,'') end,
	/*ElementJM*/	case when A.tre_gidnumer is null  then (select Twr_Jm from cdn.twrkarty where twr_gidnumer = 0) else 
						case when @CzyJednostkaPomocnicza = 0 then Twr_Jm else A.TrE_JmZ end
					end,
	/*ElementIlosc*/ SumTreIlosc,
	/*ElementCenaNetto*/ CenaNetto,
	/*ElementCenaBrutto*/	CenaBrutto,
	/*ElementWartoscNetto*/ KsiegowaNetto,	
	/*ElementWartoscBrutto*/ KsiegowaBrutto,	
	/*ElementStawkaVAT*/ StawkaPod,		
	/*ElementStawkaVATOSS*/ StawkaVatOSS,	
	/*wierszGidNumer*/	TrN_GIDNumer,
	/*WierszGidTyp*/	TrN_GIDTyp,
	/*WierszGidLp*/		wierszGidLp,
	/*WierszSpiNumer*/	TrN_SpiNumer,
	/*WierszSpiTyp*/	TrN_SpiTyp,
	/*WierszSpiLp*/		TrN_SpiLp,
	/*CzySpinacz*/		CzySpinacz,
	/*ElementKodCN*/	ElemKodCN,
	/*ElementOpis*/		ElemOpis
		from
		(
		select distinct
	/*P_8B*/		case when t1.tre_gidnumer is null  then 1 
					else
						(select case when @CzyJednostkaPomocnicza = 0 then sum(t2.tre_ilosc) else sum(t2.tre_ilosc)*t2.TrE_PrzeliczM/t2.TrE_PrzeliczL end 
								from cdn.traelem t2 where t2.tre_gidnumer = t1.tre_gidnumer AND abs(t2.tre_gidlp) = abs(t1.tre_gidlp) group by t2.TrE_PrzeliczM, t2.TrE_PrzeliczL) 
					end SumTreIlosc,
	/*P_9A*/	isnull(
				case when t1.tre_gidnumer is null then 
					case when trn_gidtyp in (1828,1836,2037,2045) then
						(Trv_wartoscwal/(100+TRV_StawkaPod))*100
					else
						TrV_NettoR
					end
				else
					case when t1.tre_gidtyp in (2041,1832,2045,1836) then
						case when t2.tre_gidnumer is not null then
							case when trn_flagaNB = 'N' then
								case when @CzyJednostkaPomocnicza = 0 then (t1.TrE_Cena-t1.TrE_CenaPoRabacie)+(t2.TrE_Cena-t2.TrE_CenaPoRabacie)
								else ((t1.TrE_Cena-t1.TrE_CenaPoRabacie) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM)+((t2.TrE_Cena-t2.TrE_CenaPoRabacie)*t2.Tre_PrzeliczL/t2.Tre_PrzeliczM)
								end 
							else
								case when @CzyJednostkaPomocnicza = 0 then ((t1.TrE_Cena-t1.TrE_CenaPoRabacie)*100/(100+t1.tre_stawkapod))+((t2.TrE_Cena-t2.TrE_CenaPoRabacie)*100/(100+t2.tre_stawkapod))
								else (((t1.TrE_Cena-t1.TrE_CenaPoRabacie)*100/(100+t1.tre_stawkapod))*t1.Tre_PrzeliczL/t1.Tre_PrzeliczM)+(((t2.TrE_Cena-t2.TrE_CenaPoRabacie)*100/(100+t2.tre_stawkapod))*t2.Tre_PrzeliczL/t2.Tre_PrzeliczM)
								end
							end
						else
							case when trn_flagaNB = 'N' then
								case when TrN_GIDTyp in (2041,2045) AND TrN_Zwrnumer=TrN_GIDNumer AND TrN_SpiNumer &lt;&gt; 0 AND TrN_TrNTyp = 3 then 
									case when @CzyJednostkaPomocnicza = 0 then t1.tre_cena-t1.TrE_CenaPrzedKorekta 
									else (t1.tre_cena-t1.TrE_CenaPrzedKorekta) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
									end
								else
									case when @CzyJednostkaPomocnicza = 0 then t1.TrE_Cena-t1.TrE_CenaPoRabacie 
									else (t1.TrE_Cena-t1.TrE_CenaPoRabacie)*t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
									end
								end
							else
								case when TrN_GIDTyp in (2041,2045) AND TrN_Zwrnumer=TrN_GIDNumer AND TrN_SpiNumer &lt;&gt; 0 AND TrN_TrNTyp = 3 then
									case when @CzyJednostkaPomocnicza = 0 then (t1.tre_cena-t1.TrE_CenaPrzedKorekta)*100/(100+t1.tre_stawkapod) 
									else ((t1.tre_cena-t1.TrE_CenaPrzedKorekta)*100/(100+t1.tre_stawkapod))*t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
									end
								else
									case when @CzyJednostkaPomocnicza = 0 then (t1.TrE_Cena-t1.TrE_CenaPoRabacie)*100/(100+t1.tre_stawkapod) 
									else ((t1.TrE_Cena-t1.TrE_CenaPoRabacie)*100/(100+t1.tre_stawkapod)) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
									end
								end
							end
						end
					else
						case when trn_flagaNB = 'N' then
							case when @CzyJednostkaPomocnicza = 0 then t1.TrE_Cena
							else t1.TrE_Cena *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
							end
						else 
							case when @CzyJednostkaPomocnicza = 0 then t1.TrE_Cena*100/(100+t1.tre_stawkapod)
							else (t1.TrE_Cena*100/(100+t1.tre_stawkapod)) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
							end
						end
					end
				end,0) CenaNetto,			
	/*P_9B*/isnull(
				case when t1.tre_gidnumer is null then 
					case when trn_gidtyp in (1828,1836,2037,2045) then
						TrV_WartoscWal
					else
						TrV_NettoR+TrV_VatR
					end
				else
					case when t1.tre_gidtyp in (2041,1832,2045,1836) then
						case when t2.tre_gidnumer is not null then
							case when trn_flagaNB = 'B' then
								case when @CzyJednostkaPomocnicza = 0 then (t1.TrE_Cena-t1.TrE_CenaPoRabacie)+(t2.TrE_Cena-t2.TrE_CenaPoRabacie)
								else ((t1.TrE_Cena-t1.TrE_CenaPoRabacie)*t1.Tre_PrzeliczL/t1.Tre_PrzeliczM)+((t2.TrE_Cena-t2.TrE_CenaPoRabacie)*t2.Tre_PrzeliczL/t2.Tre_PrzeliczM)
								end
							else
								case when @CzyJednostkaPomocnicza = 0 then  ((t1.TrE_Cena-t1.TrE_CenaPoRabacie)*(100+t1.tre_stawkapod)/100)+((t2.TrE_Cena-t2.TrE_CenaPoRabacie)*(100+t2.tre_stawkapod)/100)
								else (((t1.TrE_Cena-t1.TrE_CenaPoRabacie)*(100+t1.tre_stawkapod)/100)*t1.Tre_PrzeliczL/t1.Tre_PrzeliczM)+(((t2.TrE_Cena-t2.TrE_CenaPoRabacie)*(100+t2.tre_stawkapod)/100)*t2.Tre_PrzeliczL/t2.Tre_PrzeliczM)
								end
							end
						else
							case when trn_flagaNB = 'B' then
								case when TrN_GIDTyp in (2041,2045) AND TrN_Zwrnumer=TrN_GIDNumer AND TrN_SpiNumer &lt;&gt; 0 AND TrN_TrNTyp = 3 then 
									case when @CzyJednostkaPomocnicza = 0 then t1.tre_cena-t1.TrE_CenaPrzedKorekta
									else (t1.tre_cena-t1.TrE_CenaPrzedKorekta) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
									end
								else
									case when @CzyJednostkaPomocnicza = 0 then t1.TrE_Cena-t1.TrE_CenaPoRabacie 
									else (t1.TrE_Cena-t1.TrE_CenaPoRabacie) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
									end
								end
							else
								case when TrN_GIDTyp in (2041,2045) AND TrN_Zwrnumer=TrN_GIDNumer AND TrN_SpiNumer &lt;&gt; 0 AND TrN_TrNTyp = 3 then 
									case when @CzyJednostkaPomocnicza = 0 then (t1.tre_cena-t1.TrE_CenaPrzedKorekta)*(100+t1.tre_stawkapod)/100 
									else ((t1.tre_cena-t1.TrE_CenaPrzedKorekta)*(100+t1.tre_stawkapod)/100) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
									end
								else
									case when @CzyJednostkaPomocnicza = 0 then (t1.TrE_Cena-t1.TrE_CenaPoRabacie)*(100+t1.tre_stawkapod)/100 
									else ((t1.TrE_Cena-t1.TrE_CenaPoRabacie)*(100+t1.tre_stawkapod)/100) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
									end
								end
							end
						end
					else
						case when trn_flagaNB = 'B' then
							case when @CzyJednostkaPomocnicza = 0 then t1.TrE_Cena
							else t1.TrE_Cena *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
							end
						else 
							case when @CzyJednostkaPomocnicza = 0 then t1.TrE_Cena*(100+t1.tre_stawkapod)/100
							else (t1.TrE_Cena*(100+t1.tre_stawkapod)/100) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
							end
						end
					end
				end,0) CenaBrutto,
	/*P_11*/isnull(case when t1.tre_gidnumer is null then 
					case when trn_gidtyp in (1828,1836,2037,2045) then
						(TrV_WartoscWal/(100+TrV_StawkaPod))*100
					else
						TrV_NettoR
					end
				else	
					case when trn_gidtyp in (2041,1832,2045,1836) AND t2.tre_gidnumer is not null then
						(select top 1 tr1.TRE_KSIEGOWANETTO + tr2.TrE_KsiegowaNetto
						from CDN.TraElem tr1 inner JOIN CDN.TraElem tr2 on tr1.TrE_GIDLp = -tr2.tre_gidlp AND tr1.tre_gidnumer  = tr2.tre_gidnumer
						where tr1.TrE_GIDLp &lt;0 AND tr2.tre_gidlp &gt;0 AND tr1.TrE_GIDNumer  =TrN_GIDNumer AND tr1.TrE_GIDTyp = trn_gidtyp AND abs(tr1.TrE_GIDLp)= abs(t1.tre_gidlp)) 
						* case when trn_gidtyp in (2045) then t1.tre_kursm/t1.tre_kursl else 1 end
					when  t1.tre_gidtyp in (1828,1836,2037,2045) then
						case when trn_flagaNB = 'N' then
							t1.TrE_WartoscPoRabacie
						else
							t1.TrE_WartoscPoRabacie*100/(100+t1.tre_stawkapod)
						end					
					else
						t1.TrE_KsiegowaNetto
					end
				end,0) KsiegowaNetto,
	/*P_11A*/isnull(case when t1.tre_gidnumer is null then 
					case when trn_gidtyp in (1828,1836,2037,2045) then
						TrV_WartoscWal
					else
						TrV_NettoR+TrV_VatR
					end
				else
					case when trn_gidtyp in (2041,1832,2045,1836) AND t2.tre_gidnumer is not null then
						(select top 1 tr1.TRE_KSIEGOWABrutto + tr2.TrE_KsiegowaBrutto
						from CDN.TraElem tr1 inner JOIN CDN.TraElem tr2 on tr1.TrE_GIDLp = -tr2.tre_gidlp AND tr1.tre_gidnumer  = tr2.tre_gidnumer
						where tr1.TrE_GIDLp &lt;0 AND tr2.tre_gidlp &gt;0 AND tr1.TrE_GIDNumer  =TrN_GIDNumer AND tr1.TrE_GIDTyp = trn_gidtyp AND abs(tr1.TrE_GIDLp)= abs(t1.tre_gidlp)) 
						* case when trn_gidtyp in (2045) then t1.tre_kursm/t1.tre_kursl else 1 end
					when t1.tre_gidtyp in (1828,1836,2037,2045) then
						case when trn_flagaNB = 'B' then
							t1.TrE_WartoscPoRabacie
						else
							t1.TrE_WartoscPoRabacie*(100+t1.tre_stawkapod)/100
						end 
					else
						t1.TrE_KsiegowaBrutto
					end
				end,0) KsiegowaBrutto,
	/*P_12*/CASE WHEN TrN_ExpoNorm = 26 THEN 
			''
			ELSE
				isnull(case when t1.TRE_gidnumer is NOT null then 
						case
							when (t1.TrE_FlagaVat = 2 and TrN_ExpoNorm in (1,2,3,4,5,8,9,16,17,18,19)) or (TrN_ExpoNorm in (6,7,21) and TrN_RodzajZakupu = 8)
								or (TrN_ExpoNorm in (6,7) and TrN_RodzajZakupu &lt;&gt; 8 and t1.TrE_FlagaVat = 2) or (TrN_ExpoNorm = 21 and TrN_RodzajZakupu &lt;&gt; 8 and t1.TrE_StawkaPod = 0)
								or (t1.tre_FlagaVAT in (0,2) AND TrN_ExpoNorm = 23)
								or (TrN_ExpoNorm = 23 AND @InterpretujTransDostOpodatkPozaTerytKrajWSt0JakoKrajowa='0' AND t1.tre_StawkaPod = 0)
									THEN 'np'
							when TrN_ExpoNorm = 20 AND  t1.tre_flagavat = 2 THEN 'oo' 
							when t1.tre_flagavat=2 then '' 
							when t1.tre_flagavat=0 AND NOT (TrN_ExpoNorm in (6,7) and TrN_RodzajZakupu = 8) AND NOT TrN_ExpoNorm in (21,23,26) then 'zw' 
							else 
								CASE
									WHEN (TrN_ExpoNorm &lt;&gt; 26) THEN 'Stawka'+cast(cast(t1.TrE_StawkaPod as int) as nvarchar) 
								ELSE
									'' 
								end
							END
					else 
						case 
							when (TrV_FlagaVat = 2 and TrN_ExpoNorm in (1,2,3,4,5,8,9,16,17,18,19)) or (TrN_ExpoNorm in (6,7,21) and TrN_RodzajZakupu = 8)
								or (TrN_ExpoNorm in (6,7) and TrN_RodzajZakupu &lt;&gt; 8 and TrV_FlagaVat = 2) or (TrN_ExpoNorm = 21 and TrN_RodzajZakupu &lt;&gt; 8 and TrV_StawkaPod = 0)
								or (TrV_FlagaVat in (0,2) AND TrN_ExpoNorm = 23)
								or (TrN_ExpoNorm = 23 AND @InterpretujTransDostOpodatkPozaTerytKrajWSt0JakoKrajowa='0' AND TrV_StawkaPod = 0) THEN 'np'
							when TrN_ExpoNorm = 20 AND TRV_flagavat = 2 THEN 'oo' 
							when TRV_flagavat=2 then '' 
							when TrV_FlagaVat=0 AND NOT (TrN_ExpoNorm in (6,7) and TrN_RodzajZakupu = 8) AND NOT TrN_ExpoNorm in (21,23,26) then 'zw' 
							else CASE
									WHEN (TrN_ExpoNorm &lt;&gt; 26) THEN 'Stawka'+cast(cast(TrV_StawkaPod as int) as nvarchar) 
								ELSE
									'' 
								end
							END
					end,0)
				END
				StawkaPod,
	/*P_12_XII*/CASE WHEN TrN_ExpoNorm = 26 THEN
				isnull(case when t1.TRE_gidnumer is NOT null then t1.TrE_StawkaPod
				else TrV_StawkaPod
				end,0)
				ELSE 0.000000
				END as StawkaVatOSS,
			TrN_GIDNumer,
			TrN_GIDTyp,
			CASE WHEN t1.TrE_Pozycja IS NULL THEN TrN_GIDLp ELSE t1.TrE_Pozycja END GIDLp,
			ABS(TrN_SpiTyp) AS TrN_SpiTyp,
			CASE WHEN TRN_SPITYP &lt; 0 THEN TRN_GIDNUMER ELSE TrN_SpiNumer END AS TrN_SpiNumer,
			CASE WHEN TRN_SPILp &lt; 0 THEN TrN_GIDLp ELSE TrN_SpiLp END AS TrN_SpiLp,
			0 CzySpinacz,
			case when t1.TrE_PCN &lt;&gt; '' then
				case when substring(t1.TrE_PCN,9,1) &lt;&gt; '0' OR substring(t1.TrE_PCN,10,1) &lt;&gt; '0' then t1.TrE_PCN
				when substring(t1.TrE_PCN,9,1) = '0' AND substring(t1.TrE_PCN,10,1) = '0' then substring(t1.TrE_PCN,1,8)
				else ''
				end 
			else ''
			end as ElemKodCN,
			case when @CzyWysylacOpisElementowFaktury = 1 then left(coalesce(TeO_Opis,''),50)
			else ''
			end as ElemOpis,
			TrN_ZaNNumer,
			TrN_TrNTyp,
			t1.TrE_GIDNumer,
			t1.TrE_TwrNazwa,
			t1.TrE_TwrNumer,
			t1.TrE_JmZ,
			TrN_FlagaNB,
			TrS_OrgLp as wierszGidLp
		from CDN.TraNag
		JOIN #Dane on  TrN_GidTyp = #Dane.GidTyp AND TrN_GIDNumer = #Dane.GidNumer
		LEFT JOIN CDN.TraElem t1 on t1.tre_GIDNumer = TrN_GIDNumer AND TrN_GIDTyp = t1.tre_GIDTyp
		LEFT JOIN cdn.TraElem t2 on 
				t1.tre_GIDNumer = t2.tre_GIDNumer 
				AND t1.tre_GIDlp + t2.tre_GIDlp = 0
				AND t1.TrE_TwrNumer = t2.TrE_TwrNumer
		LEFT JOIN cdn.travat on  TrN_GIDTyp=TRV_GIDTyp AND TrN_GIDNumer=TRV_GIDNumer AND t1.TrE_GIDNumer is null
		LEFT JOIN #Atrybuty_Ksef on TRN_GIDNumer = ATR_GIDNUMER
		LEFT JOIN cdn.TreOpisy on t1.TrE_GIDTyp=TeO_TreTyp AND t1.TrE_GIDNumer=TeO_TreNumer AND t1.TrE_GIDLp=TeO_TreLp
		LEFT JOIN cdn.TraSElem on t1.TrE_GIDNumer=TrS_GIDNumer AND t1.TrE_GIDLp=TrS_GIDLp
		where 
		trn_korektaDanych &lt;&gt; 1 AND
		GidTyp not in (1824,1828,1832,1836) AND
		(t1.tre_gidlp&gt;0 AND (t2.tre_gidlp&lt;0 OR t2.tre_gidlp is null) OR t1.TRE_GIDLP IS NULL)
		AND  TrN_GIDTyp in (2033,1824,2037,1828,2041,1832,2045,1836,2034,2042)
		AND not(TrN_Spinumer = 0 AND TrN_GIDTyp in (2033,2041,2037,2045,2035,2043)  AND trn_spityp &gt;=0)
		) A
		LEFT JOIN cdn.zamnag on A.TrN_ZaNNumer = zan_gidnumer
		LEFT JOIN cdn.twrkarty on Twr_GIDNumer=A.tre_TwrNumer 

	--SPINACZ NAGŁÓWKOWY
	insert into #DaneWiersz
	select distinct 
		/*ElementLp*/	GidLp,
		/*ElementNazwa*/ case when A.TrN_TrNTyp in (12,13) AND (A.TrE_GIDNumer is null OR A.tre_TwrNazwa = '') then 'Koszt' when A.TrE_GIDNumer is null then  (case when A.trn_gidtyp in (1824,1828,1832,1836) then 'Zaliczka na poczet zamówienia – '+ ISNULL(CDN.NumerDokumentu( CDN.DokMapTypDokumentu (ZaN_GIDTyp,ZaN_ZamTyp, ZaN_Rodzaj),0,0,ZaN_ZamNumer,ZaN_ZamRok,ZaN_ZamSeria,ZaN_ZamMiesiac),'') else '' end) else isnull(A.tre_TwrNazwa,'') end,
		/*ElementJM*/	case when A.tre_gidnumer is null  then (select Twr_Jm from cdn.twrkarty where twr_gidnumer = 0) else 
							case when @CzyJednostkaPomocnicza = 0 then Twr_Jm else A.TrE_JmZ end
						end, 
		/*ElementIlosc*/ SumTreIlosc,	
		/*ElementCenaNetto*/ CenaNetto, 
		/*ElementCenaBrutto*/ CenaBrutto, 
		/*ElementWartoscNetto*/ KsiegowaNetto,	
		/*ElementWartoscBrutto*/ KsiegowaBrutto,	
		/*ElementStawkaVAT*/ StawkaPod,		
		/*ElementStawkaVATOSS*/ StawkaVatOSS,	
		/*wierszGidNumer*/	TrN_GIDNumer,
		/*WierszGidTyp*/	TrN_GIDTyp,
		/*WierszGidLp*/		wierszGidLp,
		/*WierszSpiNumer*/	TrN_SpiNumer,
		/*WierszSpiTyp*/	TrN_SpiTyp,
		/*WierszSpiLp*/		TrN_SpiLp,
		/*CzySpinacz*/		CzySpinacz,
		/*ElementKodCN*/	ElemKodCN,
		/*ElementOpis*/		ElemOpis
	from
		(
		select distinct
		/*P_8B*/	case when t1.tre_gidnumer is null  then 1 
					else 
						(select top 1 case when @CzyJednostkaPomocnicza = 0 then sum(t2.tre_ilosc) else sum(t2.tre_ilosc)*t2.TrE_PrzeliczM/t2.TrE_PrzeliczL end  
							from cdn.traelem t2 where t2.tre_gidnumer = t1.tre_gidnumer AND abs(t2.tre_gidlp) = abs(t1.tre_gidlp) group by t2.TrE_PrzeliczM, t2.TrE_PrzeliczL) 
					end SumTreIlosc,
		/*P_9A*/	isnull(case when t1.tre_gidnumer is null then 
					case when spiety.trn_gidtyp in (1828,1836,2037,2045) then
						(Trv_wartoscwal/(100+TRV_StawkaPod))*100
					else
						TrV_NettoR
					end
					else
						case when t1.tre_gidtyp in (2041,1832,2045,1836) then
							case when t2.tre_gidnumer is not null then
								case when spiety.trn_flagaNB = 'N' then
									case when @CzyJednostkaPomocnicza = 0 then (t1.TrE_Cena-t1.TrE_CenaPoRabacie)+(t2.TrE_Cena-t2.TrE_CenaPoRabacie)
									else ((t1.TrE_Cena-t1.TrE_CenaPoRabacie) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM)+((t2.TrE_Cena-t2.TrE_CenaPoRabacie)*t2.Tre_PrzeliczL/t2.Tre_PrzeliczM)
									end
								else
									case when @CzyJednostkaPomocnicza = 0 then ((t1.TrE_Cena-t1.TrE_CenaPoRabacie)*100/(100+t1.tre_stawkapod))+((t2.TrE_Cena-t2.TrE_CenaPoRabacie)*100/(100+t2.tre_stawkapod))
									else (((t1.TrE_Cena-t1.TrE_CenaPoRabacie)*100/(100+t1.tre_stawkapod))*t1.Tre_PrzeliczL/t1.Tre_PrzeliczM)+(((t2.TrE_Cena-t2.TrE_CenaPoRabacie)*100/(100+t2.tre_stawkapod))*t2.Tre_PrzeliczL/t2.Tre_PrzeliczM)
									end
								end
							else
								case when spiety.trn_flagaNB = 'N' then
									case when spiety.TrN_GIDTyp in (2041,2045) AND spiety.TrN_Zwrnumer=spiety.TrN_GIDNumer AND spiety.TrN_SpiNumer &lt;&gt; 0 AND spiety.TrN_TrNTyp = 3 then 
										case when @CzyJednostkaPomocnicza = 0 then (t1.tre_cena-t1.TrE_CenaPrzedKorekta) 
										else (t1.tre_cena-t1.TrE_CenaPrzedKorekta) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM 
										end 
									else
										case when @CzyJednostkaPomocnicza = 0 then t1.TrE_Cena-t1.TrE_CenaPoRabacie 
										else (t1.TrE_Cena-t1.TrE_CenaPoRabacie) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
										end 
									end
								else
									case when spiety.TrN_GIDTyp in (2041,2045) AND spiety.TrN_Zwrnumer=spiety.TrN_GIDNumer AND spiety.TrN_SpiNumer &lt;&gt; 0 AND spiety.TrN_TrNTyp = 3 then 
										case when @CzyJednostkaPomocnicza = 0 then (t1.tre_cena-t1.TrE_CenaPrzedKorekta)*100/(100+t1.tre_stawkapod) 
										else ((t1.tre_cena-t1.TrE_CenaPrzedKorekta)*100/(100+t1.tre_stawkapod)) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
										end 
									else
										case when @CzyJednostkaPomocnicza = 0 then (t1.TrE_Cena-t1.TrE_CenaPoRabacie)*100/(100+t1.tre_stawkapod) 
										else ((t1.TrE_Cena-t1.TrE_CenaPoRabacie)*100/(100+t1.tre_stawkapod)) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
										end
									end
								end
							end
						else
							case when spiety.trn_flagaNB = 'N' then
								case when @CzyJednostkaPomocnicza = 0 then t1.TrE_Cena
								else t1.TrE_Cena *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
								end
							else 
								case when @CzyJednostkaPomocnicza = 0 then t1.TrE_Cena*100/(100+t1.tre_stawkapod)
								else (t1.TrE_Cena*100/(100+t1.tre_stawkapod)) *t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
								end
							end
						end
					end,0) CenaNetto,
		/*P_9B*/ isnull(case when t1.tre_gidnumer is null then 
					case when spiety.trn_gidtyp in (1828,1836,2037,2045) then
						TrV_WartoscWal
					else
						TrV_NettoR+TrV_VatR
					end
					else
						case when t1.tre_gidtyp in (2041,1832,2045,1836) then
							case when t2.tre_gidnumer is not null then
								case when spiety.trn_flagaNB = 'B' then
									case when @CzyJednostkaPomocnicza = 0 then (t1.TrE_Cena-t1.TrE_CenaPoRabacie)+(t2.TrE_Cena-t2.TrE_CenaPoRabacie)
									else ((t1.TrE_Cena-t1.TrE_CenaPoRabacie)*t1.Tre_PrzeliczL/t1.Tre_PrzeliczM)+((t2.TrE_Cena-t2.TrE_CenaPoRabacie)*t2.Tre_PrzeliczL/t2.Tre_PrzeliczM)
									end
								else
									case when @CzyJednostkaPomocnicza = 0 then ((t1.TrE_Cena-t1.TrE_CenaPoRabacie)*(100+t1.tre_stawkapod)/100)+((t2.TrE_Cena-t2.TrE_CenaPoRabacie)*(100+t2.tre_stawkapod)/100)
									else (((t1.TrE_Cena-t1.TrE_CenaPoRabacie)*(100+t1.tre_stawkapod)/100)*t1.Tre_PrzeliczL/t1.Tre_PrzeliczM)+(((t2.TrE_Cena-t2.TrE_CenaPoRabacie)*(100+t2.tre_stawkapod)/100)*t2.Tre_PrzeliczL/t2.Tre_PrzeliczM)
									end
								end
							else
								case when spiety.trn_flagaNB = 'B' then
									case when spiety.TrN_GIDTyp in (2041,2045) AND spiety.TrN_Zwrnumer=spiety.TrN_GIDNumer AND spiety.TrN_SpiNumer &lt;&gt; 0 AND spiety.TrN_TrNTyp = 3 then 
										case when @CzyJednostkaPomocnicza = 0 then t1.tre_cena-t1.TrE_CenaPrzedKorekta 
										else (t1.tre_cena-t1.TrE_CenaPrzedKorekta)*t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
										end
									else
										case when @CzyJednostkaPomocnicza = 0 then t1.TrE_Cena-t1.TrE_CenaPoRabacie 
										else (t1.TrE_Cena-t1.TrE_CenaPoRabacie)*t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
										end
									end
								else
									case when spiety.TrN_GIDTyp in (2041,2045) AND spiety.TrN_Zwrnumer=spiety.TrN_GIDNumer AND spiety.TrN_SpiNumer &lt;&gt; 0 AND spiety.TrN_TrNTyp = 3 then 
										case when @CzyJednostkaPomocnicza = 0 then (t1.tre_cena-t1.TrE_CenaPrzedKorekta)*(100+t1.tre_stawkapod)/100 
										else ((t1.tre_cena-t1.TrE_CenaPrzedKorekta)*(100+t1.tre_stawkapod)/100)*t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
										end
									else
										case when @CzyJednostkaPomocnicza = 0 then (t1.TrE_Cena-t1.TrE_CenaPoRabacie)*(100+t1.tre_stawkapod)/100
										else ((t1.TrE_Cena-t1.TrE_CenaPoRabacie)*(100+t1.tre_stawkapod)/100)*t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
										end
									end
								end
							end
						else
							case when spiety.trn_flagaNB = 'B' then
								case when @CzyJednostkaPomocnicza = 0 then t1.TrE_Cena
								else t1.TrE_Cena*t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
								end
							else 
								case when @CzyJednostkaPomocnicza = 0 then t1.TrE_Cena*(100+t1.tre_stawkapod)/100
								else (t1.TrE_Cena*(100+t1.tre_stawkapod)/100)*t1.Tre_PrzeliczL/t1.Tre_PrzeliczM
								end
							end
						end
					end,0) CenaBrutto,
		/*P_11*/ isnull(case when t1.tre_gidnumer is null then 
						case when spiety.trn_gidtyp in (1828,1836,2037,2045) then
							TrV_WartoscWal
						else
							TrV_NettoR
						end
					else
						case when spiety.trn_gidtyp in (2041,1832,2045,1836,2009,2013,2042) AND t2.tre_gidnumer is not null then						
							(select top 1 tr1.TRE_KSIEGOWANETTO + tr2.TrE_KsiegowaNetto
							from CDN.TraElem tr1 inner JOIN CDN.TraElem tr2 on tr1.TrE_GIDLp = -tr2.tre_gidlp AND tr1.tre_gidnumer  = tr2.tre_gidnumer
							where tr1.TrE_GIDLp &lt;0 AND tr2.tre_gidlp &gt;0 AND tr1.TrE_GIDNumer  =spiety.trn_GIDNumer AND tr1.TrE_GIDTyp = spiety.trn_gidtyp AND abs(tr1.TrE_GIDLp)= abs(t1.tre_gidlp)) 
							* case when spiety.trn_gidtyp in (2013) then t1.tre_kursm/t1.tre_kursl else 1 end
						when t1.tre_gidtyp in (1828,1836,2037,2045,2005,2013) then
							case when spiety.trn_flagaNB = 'N' then
								t1.TrE_WartoscPoRabacie
							else
								t1.TrE_WartoscPoRabacie*100/(100+t1.tre_stawkapod)
							end
						else
							t1.TrE_KsiegowaNetto
						end
					end,0) KsiegowaNetto,
		/*P_11A*/ isnull(case when t1.tre_gidnumer is null then 
						case when spiety.trn_gidtyp in (1828,1836,2037,2045) then
							TrV_WartoscWal
						else
							TrV_NettoR+TrV_VatR
						end
					else
						case when spiety.trn_gidtyp in (2041,1832,2045,1836,2009,2013,2042) AND t2.tre_gidnumer is not null then
							(select top 1 tr1.TRE_KSIEGOWABrutto + tr2.TrE_KsiegowaBrutto
							from CDN.TraElem tr1 inner JOIN CDN.TraElem tr2 on tr1.TrE_GIDLp = -tr2.tre_gidlp AND tr1.tre_gidnumer  = tr2.tre_gidnumer
							where tr1.TrE_GIDLp &lt;0 AND tr2.tre_gidlp &gt;0 AND tr1.TrE_GIDNumer  =spiety.trn_GIDNumer AND tr1.TrE_GIDTyp = spiety.trn_gidtyp AND abs(tr1.TrE_GIDLp)= abs(t1.tre_gidlp)) 
							* case when spiety.trn_gidtyp in (2013) then t1.tre_kursm/t1.tre_kursl else 1 end
						when t1.tre_gidtyp in (1828,1836,2037,2045,2005,2013) then
							case when spiety.trn_flagaNB = 'B' then
								t1.TrE_WartoscPoRabacie
							else
								t1.TrE_WartoscPoRabacie*(100+t1.tre_stawkapod)/100
							end
						else
							t1.TrE_KsiegowaBrutto
						end
					end,0) KsiegowaBrutto,
		/*P_12*/ CASE WHEN spinacz.TrN_ExpoNorm = 26 THEN 
			''
			ELSE
				isnull(case when t1.TRE_gidnumer is NOT null then 
						case
							when (t1.TrE_FlagaVat = 2 and spinacz.TrN_ExpoNorm in (1,2,3,4,5,8,9,16,17,18,19)) or (spinacz.TrN_ExpoNorm in (6,7,21) and spinacz.TrN_RodzajZakupu = 8)
								or (spinacz.TrN_ExpoNorm in (6,7) and spinacz.TrN_RodzajZakupu &lt;&gt; 8 and t1.TrE_FlagaVat = 2) or (spinacz.TrN_ExpoNorm = 21 and spinacz.TrN_RodzajZakupu &lt;&gt; 8 and t1.TrE_StawkaPod = 0)
								or (t1.tre_FlagaVAT in (0,2) AND spinacz.TrN_ExpoNorm = 23)
								or (spinacz.TrN_ExpoNorm = 23 AND @InterpretujTransDostOpodatkPozaTerytKrajWSt0JakoKrajowa='0' AND t1.tre_StawkaPod = 0)
									THEN 'np'
							when spinacz.TrN_ExpoNorm = 20 AND  t1.tre_flagavat = 2 THEN 'oo' 
							when t1.tre_flagavat=2 then '' 
							when t1.tre_flagavat=0 AND NOT (spinacz.TrN_ExpoNorm in (6,7) and spinacz.TrN_RodzajZakupu = 8) AND NOT spinacz.TrN_ExpoNorm in (21,23,26) then 'zw' 
							else 
								CASE
									WHEN (spinacz.TrN_ExpoNorm &lt;&gt; 26) THEN 'Stawka'+cast(cast(t1.TrE_StawkaPod as int) as nvarchar) 
								ELSE
									'' 
								end
							END
					else 
						case 
							when (TrV_FlagaVat = 2 and spiety.TrN_ExpoNorm in (1,2,3,4,5,8,9,16,17,18,19)) or (spiety.TrN_ExpoNorm in (6,7,21) and spiety.TrN_RodzajZakupu = 8)
								or (spiety.TrN_ExpoNorm in (6,7) and spiety.TrN_RodzajZakupu &lt;&gt; 8 and TrV_FlagaVat = 2) or (spiety.TrN_ExpoNorm = 21 and spiety.TrN_RodzajZakupu &lt;&gt; 8 and TrV_StawkaPod = 0)
								or (TrV_FlagaVat in (0,2) AND spiety.TrN_ExpoNorm = 23)
								or (spiety.TrN_ExpoNorm = 23 AND @InterpretujTransDostOpodatkPozaTerytKrajWSt0JakoKrajowa='0' AND TrV_StawkaPod = 0) THEN 'np'
							when spiety.TrN_ExpoNorm = 20 AND TRV_flagavat = 2 THEN 'oo' 
							when TRV_flagavat=2 then '' 
							when TrV_FlagaVat=0 AND NOT (spiety.TrN_ExpoNorm in (6,7) and spiety.TrN_RodzajZakupu = 8) AND NOT spiety.TrN_ExpoNorm in (21,23,26) then 'zw' 
							else CASE
									WHEN (spiety.TrN_ExpoNorm &lt;&gt; 26) THEN 'Stawka'+cast(cast(TrV_StawkaPod as int) as nvarchar) 
								ELSE
									'' 
								end
							END
					end,0)
				END
				StawkaPod,
	/*P_12_XII*/CASE WHEN spinacz.TrN_ExpoNorm = 26 THEN
				isnull(case when t1.TRE_gidnumer is NOT null then t1.TrE_StawkaPod
				else TrV_StawkaPod
				end,0)
				ELSE 0.000000
				END as StawkaVatOSS,
			spiety.TrN_GIDNumer,
			spiety.TrN_GIDTyp,
			CASE WHEN t1.TrE_Pozycja IS NULL THEN SPINACZ.TRN_GIDLP ELSE t1.TrE_Pozycja END GIDLp,
			spiety.TrN_SpiTyp,
			spiety.TrN_SpiNumer,
			spiety.TrN_SpiLp,
			1 CzySpinacz,
			case when t1.TrE_PCN &lt;&gt; '' then
				case when substring(t1.TrE_PCN,9,1) &lt;&gt; '0' OR substring(t1.TrE_PCN,10,1) &lt;&gt; '0' then t1.TrE_PCN
				when substring(t1.TrE_PCN,9,1) = '0' AND substring(t1.TrE_PCN,10,1) = '0' then substring(t1.TrE_PCN,1,8)
				else ''
				end
			else ''
			end as ElemKodCN,
			case when @CzyWysylacOpisElementowFaktury = 1 then left(coalesce(TeO_Opis,''),50)
			else ''
			end as ElemOpis,
			spiety.TrN_ZaNNumer,
			spiety.TrN_TrNTyp,
			t1.TrE_GIDNumer,
			t1.TrE_TwrNazwa,
			t1.TrE_TwrNumer,
			t1.TrE_JmZ,
			TrS_OrgLp as wierszGidLp
			from CDN.TraNag spinacz
			JOIN #Dane on  spinacz.TrN_GidTyp = #Dane.GidTyp AND spinacz.TrN_GIDNumer = #Dane.GidNumer
			JOIN CDN.TraNag spiety on spiety.TrN_SpiNumer = spinacz.TrN_GIDNumer AND spiety.TrN_SpiTyp = spinacz.trn_gidtyp AND spiety.TrN_KorektaDanych = 0
			LEFT JOIN CDN.TraElem t1 on t1.tre_GIDNumer = spiety.trn_GIDNumer AND spiety.trn_GIDTyp = t1.tre_GIDTyp
			LEFT JOIN cdn.TraElem t2 on 
				t1.tre_GIDNumer = t2.tre_GIDNumer 
				AND t1.tre_GIDlp + t2.tre_GIDlp = 0
				AND t1.TrE_TwrNumer = t2.TrE_TwrNumer
			LEFT JOIN cdn.travat on  spiety.trn_GIDTyp=TRV_GIDTyp AND spiety.trn_GIDNumer=TRV_GIDNumer AND t1.TrE_GIDNumer is null
			LEFT JOIN cdn.TreOpisy on t1.TrE_GIDTyp=TeO_TreTyp AND t1.TrE_GIDNumer=TeO_TreNumer AND t1.TrE_GIDLp=TeO_TreLp			
			LEFT JOIN cdn.TraSElem on t1.TrE_GIDNumer=TrS_GIDNumer AND t1.TrE_GIDLp=TrS_GIDLp
			where 
			spinacz.trn_korektaDanych &lt;&gt; 1 AND
			(t1.tre_gidlp&gt;0 AND (t2.tre_gidlp&lt;0 OR t2.tre_gidlp is null) OR t1.TRE_GIDLP IS NULL)
			AND spinacz.TrN_Spinumer = 0 AND spinacz.trn_gidtyp in (2033,2041,2037,2045,2035,2043)
		) A
		LEFT JOIN cdn.zamnag on A.TrN_ZaNNumer = zan_gidnumer
		LEFT JOIN cdn.twrkarty on Twr_GIDNumer=A.tre_TwrNumer

		SET @id = 0 
		UPDATE #DaneWiersz SET @id = ElementLp = @id + 1 where ElementLp = 0
		IF (@gidTyp&amp;8 &lt;&gt; 0)
			begin
			OPEN wierszeKursor
				FETCH NEXT FROM wierszeKursor INTO @wierszGidNumer,	@wierszGidTyp, @wierszGidLp;

			WHILE @@FETCH_STATUS  = 0
			BEGIN
				SET @czyKorektaReczna = (select case when TrN_GIDTyp in (2041,2045) and TrN_ZwrTyp = TrN_GIDTyp and TrN_ZwrNumer = TrN_GIDNumer then 1 else 0 end 
											from cdn.TraNag 
											where TrN_GIDNumer = @GidNumer and TrN_GIDTyp = @GidTyp)

				SET @czyKorektaCI = (select case when exists (select * from cdn.TraSElem where TrS_GIDNumer = @wierszGidNumer and TrS_GIDTyp = @wierszGidTyp  and TrS_GIDLp = @wierszGidLp * (-1) ) then 1 else 0 end)	--sprawdzamy czy są rekordy z odwrotnym gidLp (ujemnym)
			
					if @czyKorektaCI = 0
					begin
						SET @ilosc = (select case when @CzyJednostkaPomocnicza = 0 then	
												case when @czyKorektaReczna = 0 then 
													sum(TrE_Ilosc) 
												else
													sum(TrE_IloscPrzedKorekta)
												end
											else 
												case when @czyKorektaReczna = 0 then 
													sum(TrE_Ilosc)*TrE_PrzeliczM/TrE_PrzeliczL 
												else
													sum(TrE_IloscPrzedKorekta)*TrE_PrzeliczM/TrE_PrzeliczL 
												end
											end  
											from (select distinct TrE_Ilosc,TrE_IloscPrzedKorekta,TrE_PrzeliczM,TrE_PrzeliczL,TrS_GIDNumer from cdn.TraSElem join cdn.TraElem on TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp 
											where TrS_OrgNumer = (select top 1 a.TrS_OrgNumer from cdn.TraSElem a where a.TrS_GIDNumer = @wierszGidNumer and a.TrS_GIDTyp = @wierszGidTyp) 
												and TrS_GIDNumer &lt;= @wierszGidNumer and TrS_OrgLp = @wierszGidLp) zrodlo group by TrE_PrzeliczM, TrE_PrzeliczL)
						end
					else
						begin
						SET @ilosc = (select case when @CzyJednostkaPomocnicza = 0 then 
												case when @czyKorektaReczna = 0 then 
													sum(TrE_Ilosc) 
												else
													sum(TrE_IloscPrzedKorekta)
												end
											else 
												case when @czyKorektaReczna = 0 then 
													sum(TrE_Ilosc)*TrE_PrzeliczM/TrE_PrzeliczL 
												else
													sum(TrE_IloscPrzedKorekta)*TrE_PrzeliczM/TrE_PrzeliczL 
												end
											end  
											from (select distinct TrE_Ilosc,TrE_IloscPrzedKorekta,TrE_PrzeliczM,TrE_PrzeliczL,TrS_GIDNumer from cdn.TraSElem join cdn.TraElem on TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp 
											where TrS_OrgNumer = (select top 1 a.TrS_OrgNumer from cdn.TraSElem a where a.TrS_GIDNumer = @wierszGidNumer and a.TrS_GIDTyp = @wierszGidTyp) 
												and TrS_GIDNumer &lt;= @wierszGidNumer and TrS_GIDLp &lt; 0 and TrS_OrgLp = @wierszGidLp) zrodlo group by TrE_PrzeliczM, TrE_PrzeliczL)
					end
				UPDATE #DaneWiersz SET ElementIlosc = @ilosc WHERE ((wierszGidNumer = @wierszGidNumer and wierszGidTyp = @wierszGidTyp and wierszGidLp = @wierszGidLp) or (wierszSpiNumer = @wierszGidNumer and wierszSpiTyp = @wierszGidTyp and wierszSpiLp = @wierszGidLp))
						and ElementIlosc = 0 and (wierszGidTyp in (2041, 2043, 1832, 2045, 1836) or wierszSpiTyp in (2041, 2043, 1832, 2045, 1836))
				UPDATE #DaneWiersz SET ElementCenaNetto = ElementWartoscNetto/ElementIlosc, ElementCenaBrutto = ElementWartoscBrutto/ElementIlosc
						WHERE ((wierszGidNumer = @wierszGidNumer and wierszGidTyp = @wierszGidTyp and wierszGidLp = @wierszGidLp) or (wierszSpiNumer = @wierszGidNumer and wierszSpiTyp = @wierszGidTyp and wierszSpiLp = @wierszGidLp))
						and (wierszGidTyp in (2041, 2043, 1832, 2045, 1836) or wierszSpiTyp in (2041, 2043, 1832, 2045, 1836))
				
				FETCH NEXT FROM wierszeKursor INTO @wierszGidNumer,	@wierszGidTyp, @wierszGidLp
			END
			CLOSE wierszeKursor;
			DEALLOCATE wierszeKursor;		
		end

		UPDATE #Dane SET FakturaLiczbaWierszy = DW.elLp,
		SumaNettoElementow = coalesce(DW.elWN,0),
		SumaBruttoElementow = coalesce(DW.elWB,0)
		FROM (SELECT count(ElementLp) as elLp, SUM(ElementWartoscNetto) as elWN, SUM(ElementWartoscBrutto) as elWB FROM #DaneWiersz where wierszGidLp is not null) DW
		IF @CzyWysylacNrPartii = 1
		BEGIN
			IF (@GidTyp in (2035,2043)) -- RA, RAK
				BEGIN
				INSERT INTO #PartieTmp 
					SELECT DISTINCT A.TrN_SpiTyp, A.TrN_SpiNumer, Twr_Kod, Dst_Cecha, Dst_Ean, Dst_DataW FROM CDN.Dostawy 
						JOIN CDN.TraSElem ON Dst_GIDNumer=TrS_DstNumer 
						JOIN CDN.TwrKarty ON Twr_GIDNumer=Dst_TwrNumer
						JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrS_GIDTyp AND A.TrN_GIDNumer=TrS_GIDNumer
						JOIN cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer
						WHERE B.TrN_GIDTyp = @GidTyp AND B.TrN_GIDNumer = @GidNumer AND Trs_Ilosc &lt;&gt;0 	
				END
			ELSE IF (@GidTyp = @spiTyp AND @GidNumer = @spiNumer)	--partie dokumentów niespiętych
				BEGIN
				INSERT INTO #PartieTmp 
				SELECT DISTINCT Trs_GIDTyp, TrS_GIDNumer, Twr_Kod, Dst_Cecha, Dst_Ean, Dst_DataW FROM CDN.Dostawy 
						JOIN CDN.TraSElem ON Dst_GIDNumer=TrS_DstNumer  
						JOIN CDN.TwrKarty ON Twr_GIDNumer=Dst_TwrNumer
						WHERE Trs_GIDTyp = @GidTyp AND TrS_GIDNumer = @GidNumer AND Trs_Ilosc &lt;&gt;0 					
				END
			ELSE IF ( @GidTyp = @spiTyp * (-1) AND @spiNumer = 0 AND @GidTyp not in (2044)) --partie spinacza elementów
				BEGIN
				INSERT INTO #PartieTmp
					SELECT DISTINCT B.Trs_GIDTyp, B.TrS_GIDNumer, Twr_Kod, Dst_Cecha, Dst_Ean, Dst_DataW FROM CDN.Dostawy 
						JOIN CDN.TraSElem A ON Dst_GIDNumer=A.TrS_DstNumer 
						JOIN cdn.TraSElem B on A.TrS_GIDNumer = B.TrS_SpiNumer AND A.TrS_GIDTyp = B.TrS_SpiTyp AND A.TrS_GIDLp = B.TrS_SpiLp AND A.TrS_SubGIDLp = B.TrS_SubSpiLp
						JOIN CDN.TwrKarty ON Twr_GIDNumer=Dst_TwrNumer
						WHERE A.Trs_Ilosc &lt;&gt;0  and B.Trs_GIDTyp = @GidTyp AND B.TrS_GIDNumer = @GidNumer
				END
			ELSE IF (@spiTyp = 0)	--partie spinacza nagłówkowego
				BEGIN
				INSERT INTO #PartieTmp 
					SELECT DISTINCT A.TrN_SpiTyp, A.TrN_SpiNumer, Twr_Kod, Dst_Cecha, Dst_Ean, Dst_DataW FROM CDN.Dostawy 
						JOIN CDN.TraSElem ON Dst_GIDNumer=TrS_DstNumer 
						JOIN CDN.TwrKarty ON Twr_GIDNumer=Dst_TwrNumer
						JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrS_GIDTyp AND A.TrN_GIDNumer=TrS_GIDNumer
						JOIN cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer
						WHERE B.TrN_GIDTyp = @GidTyp AND B.TrN_GIDNumer = @GidNumer AND Trs_Ilosc &lt;&gt;0 
			END
		END

	OPEN kursorPartie
	FETCH NEXT FROM kursorPartie INTO @TMPTYP, @TMPNUMER, @kodTowaruTMP, @cechaTMP, @eanTMP, @dataWTMP

	WHILE @@Fetch_Status = 0
	BEGIN
		IF (@kodTowaruTMP &lt;&gt; '')
			SET @NrPartiiTowaruTMP = @kodTowaruTMP + '; '
		IF (@cechaTMP &lt;&gt; '')
			SET @NrPartiiTowaruTMP = @NrPartiiTowaruTMP+ @cechaTMP + '; '
		IF (@eanTMP &lt;&gt; '')
			SET @NrPartiiTowaruTMP = @NrPartiiTowaruTMP+ @eanTMP + '; '
		IF (@dataWTMP &lt;&gt; 0)
			SET @NrPartiiTowaruTMP = @NrPartiiTowaruTMP+ CONVERT(varchar(10), DATEADD(day,@dataWTMP,CONVERT(DATETIME,'1800-12-28',120)), 120) + ';'

		SET @NrPartiiTowaruTMP = SUBSTRING(@NrPartiiTowaruTMP,0,LEN(@NrPartiiTowaruTMP));
		INSERT INTO #Partie VALUES (@NrPartiiTowaruTMP)

		FETCH NEXT FROM kursorPartie INTO @TMPTYP, @TMPNUMER, @kodTowaruTMP, @cechaTMP, @eanTMP, @dataWTMP
	END

	CLOSE kursorPartie
	DEALLOCATE kursorPartie

		IF EXISTS
        (
            SELECT *
            FROM tempdb..sysobjects
            WHERE id = OBJECT_ID('tempdb..##tmpKSEF')
                  AND type = 'U'
        )
            DROP TABLE ##tmpKSEF;

		IF EXISTS
        (
            SELECT *
            FROM tempdb..sysobjects
            WHERE id = OBJECT_ID('tempdb..##tmpDaneFaKorygowanej')
                  AND type = 'U'
        )
            DROP TABLE ##tmpDaneFaKorygowanej;

		IF EXISTS
        (
            SELECT *
            FROM tempdb..sysobjects
            WHERE id = OBJECT_ID('tempdb..##tmpPodmiot3')
                  AND type = 'U'
        )
            DROP TABLE ##tmpPodmiot3;

		IF EXISTS
        (
            SELECT *
            FROM tempdb..sysobjects
            WHERE id = OBJECT_ID('tempdb..##tmpPodmiot2K')
                  AND type = 'U'
        )
            DROP TABLE ##tmpPodmiot2K;

		IF EXISTS
        (
            SELECT *
            FROM tempdb..sysobjects
            WHERE id = OBJECT_ID('tempdb..##tmpFakturyZaliczkowe')
                  AND type = 'U'
        )
            DROP TABLE ##tmpFakturyZaliczkowe;

		IF EXISTS
        (
            SELECT *
            FROM tempdb..sysobjects
            WHERE id = OBJECT_ID('tempdb..##tmpZamowienie')
                  AND type = 'U'
        )
            DROP TABLE ##tmpZamowienie;

		IF EXISTS
        (
            SELECT *
            FROM tempdb..sysobjects
            WHERE id = OBJECT_ID('tempdb..##tmpZamowienieNumer')
                  AND type = 'U'
        )
            DROP TABLE ##tmpZamowienieNumer;

		IF EXISTS
        (
            SELECT *
            FROM tempdb..sysobjects
            WHERE id = OBJECT_ID('tempdb..##tmpNumeryWZ')
                  AND type = 'U'
        )
            DROP TABLE ##tmpNumeryWZ;

		IF EXISTS
        (
            SELECT *
            FROM tempdb..sysobjects
            WHERE id = OBJECT_ID('tempdb..##tmpPartie')
                  AND type = 'U'
        )
            DROP TABLE ##tmpPartie;

		set @sSQL = N'select 
						#Dane.*,
						case when coalesce(w1.ElementLp,w2.ElementLp) = 0 
						    then ROW_NUMBER() OVER(PARTITION BY coalesce(w1.WierszGidNumer,	w2.WierszGidNumer),coalesce(w1.ElementLp,w2.ElementLp) ORDER BY #Dane.GidNumer ASC)  
							else coalesce(w1.ElementLp, 	w2.ElementLp, 0) end ElementLp,		
						coalesce(w1.ElementNazwa, w2.ElementNazwa, '''') ElementNazwa,
						coalesce(w1.ElementJM, w2.ElementJM, '''')  ElementJM,
						coalesce(w1.ElementIlosc, w2.ElementIlosc, 0) ElementIlosc,
						coalesce(w1.ElementCenaNetto, w2.ElementCenaNetto, 0) ElementCenaNetto,
						coalesce(w1.ElementCenaBrutto, w2.ElementCenaBrutto, 0) ElementCenaBrutto,
						coalesce(w1.ElementWartoscNetto, w2.ElementWartoscNetto, 0) ElementWartoscNetto,
						coalesce(w1.ElementWartoscBrutto, w2.ElementWartoscBrutto, 0) ElementWartoscBrutto,
						coalesce(w1.ElementStawkaVat, w2.ElementStawkaVat, '''') ElementStawkaVat,
						coalesce(w1.ElementStawkaVatOSS, w2.ElementStawkaVatOSS, 0) ElementStawkaVatOSS,
						coalesce(w1.WierszGidNumer,	w2.WierszGidNumer, 0) WierszGidNumer,
						coalesce(w1.WierszGidTyp, w2.WierszGidTyp, 0) WierszGidTyp,
						coalesce(w1.WierszSpiNumer, w2.WierszSpiNumer, 0) WierszSpiNumer,																
						coalesce(w1.WierszSpiTyp, w2.WierszSpiTyp, 0) WierszSpiTyp,
						coalesce(w1.ElementKodCN, w2.ElementKodCN, '''') ElementKodCN,
						coalesce(w1.ElementOpis, w2.ElementOpis, '''') ElementOpis
						into ##tmpKSEF from #Dane 
					LEFT outer JOIN #DaneWiersz w1 on (#Dane.GidNumer = w1.WierszGidNumer AND w1.CzySpinacz = 0)  
					LEFT outer JOIN #DaneWiersz w2 on (#Dane.SpiNumer = 0 AND #Dane.GidNumer = w2.WierszSpiNumer AND w2.CzySpinacz = 1)
					 order by GidNumer;
					select * into ##tmpDaneFaKorygowanej FROM #DaneFaKorygowanej;
					select * into ##tmpPodmiot3 FROM #Podmiot3;
					select * into ##tmpPodmiot2K FROM #Podmiot2K;
					select * into ##tmpFakturyZaliczkowe from #FakturyZaliczkowe; 
					select * into ##tmpZamowienieNumer from #ZamowienieNumer order by ZN_NrZamowienia;
					select * into ##tmpNumeryWZ from #NumeryWZ order by NW_NumerWZ;
					select * into ##tmpPartie from #Partie;
					select DISTINCT KSeF_Dane_ZAM.* into ##tmpZamowienie from #Dane
						OUTER APPLY cdn.KSeF_Dane_ZAM(GidNumer)
						where gidTyp in (1824,1828);'

		exec sp_executeSQL @sSQL
END	
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>