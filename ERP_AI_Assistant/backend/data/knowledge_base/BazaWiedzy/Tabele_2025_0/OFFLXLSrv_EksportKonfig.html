<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="OFFLXLSrv_EksportKonfig"></A><PRE>
          <FONT SIZE="2"><I>/* OFFLXLSrv_EksportKonfig */</I><BR>
CREATE PROCEDURE CDN.OFFLXLSrv_EksportKonfig
 @ID	INT -- ID Oddziału
,@LogID INT = -1 -- ID Loga synchronizacji 
AS
	RAISERROR('Procedura OFFLXLSrv_EksportKonfig nie jest obługiwana na MSSQL 2000',16,1)
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="OFFLXLSrv_EksportKonfig"></A><PRE>
          <FONT SIZE="2"><I>/* OFFLXLSrv_EksportKonfig */</I><BR>
CREATE PROCEDURE CDN.OFFLXLSrv_EksportKonfig
 @ID	INT -- ID Oddziału
,@LogID INT = -1 -- ID Loga synchronizacji 
WITH EXECUTE AS SELF
AS
SET ARITHABORT ON

	DECLARE  @Pck_Typ INT
			,@PcK_CentrumId INT
			,@Pck_TSSynchrPtw INT
			,@PcK_TSSynchrMagPtw	INT
			,@PcK_TSSynchrSerPtw	INT
			,@PcK_TSSynchrBnkPtw	INT
			,@PcK_TSSynchrKarPtw	INT
			,@PcK_TSSynchrCechyPtw	INT
			,@PcK_TSSynchrFplPtw	INT
			,@PcK_TSSynchrNtcPtw	INT
			,@PcK_TSSynchrVATPtw	INT										
			,@PcK_TSSynchrJmPtw	INT
			,@PcK_TSSynchrOpePtw	INT
			,@PcK_TSSynchrPrcPtw	INT
			,@PcK_TSSynchrDokPtw	INT
			,@PcK_TSSynchrDSTPtw	INT	
			,@PcK_TSSynchrSLWPtw	INT		

	DECLARE	 @Opis VARCHAR(512)
			,@IloscWierszy INT

	SELECT @Pck_Typ = PcK_Typ, @PcK_CentrumId = PcK_CentrumID, @Pck_TSSynchrPtw = Pck_TSSynchrPtw
	FROM CDN.PicoKonfig 
	WHERE PcK_PicoID = @ID

	SET @PcK_TSSynchrMagPtw = 0;
	SET @PcK_TSSynchrSerPtw = 0;
	SET @PcK_TSSynchrBnkPtw = 0;
	SET @PcK_TSSynchrKarPtw = 0;
	SET @PcK_TSSynchrCechyPtw = 0;
	SET @PcK_TSSynchrFplPtw = 0;
	SET @PcK_TSSynchrNtcPtw = 0;
	SET @PcK_TSSynchrVATPtw = 0;
	SET @PcK_TSSynchrJmPtw = 0;
	SET @PcK_TSSynchrOpePtw = 0;
	SET @PcK_TSSynchrPrcPtw = 0;
	SET @PcK_TSSynchrDokPtw = 0;
	SET @PcK_TSSynchrDSTPtw = 0;
	SET @PcK_TSSynchrSLWPtw = 0;	

	-- Magazyny
	select @PcK_TSSynchrMagPtw=isnull(PcS_TSSynchrPtw,0) from cdn.PicoTimestamp where PcS_PcKID = @ID and PcS_OBITyp = 208
	-- Serie
	select @PcK_TSSynchrSerPtw=isnull(PcS_TSSynchrPtw,0) from cdn.PicoTimestamp where PcS_PcKID = @ID and PcS_OBITyp = 272		
	-- Banki
	select @PcK_TSSynchrBnkPtw=isnull(PcS_TSSynchrPtw,0) from cdn.PicoTimestamp where PcS_PcKID = @ID and PcS_OBITyp = 48		
	-- Rejestry kasowe
	select @PcK_TSSynchrKarPtw=isnull(PcS_TSSynchrPtw,0) from cdn.PicoTimestamp where PcS_PcKID = @ID and PcS_OBITyp = 752
	-- Klasy cech i cechy
	select @PcK_TSSynchrCechyPtw=isnull(PcS_TSSynchrPtw,0) from cdn.PicoTimestamp where PcS_PcKID = @ID and PcS_OBITyp = 192
	-- formy płatności
	select @PcK_TSSynchrFplPtw=isnull(PcS_TSSynchrPtw,0) from cdn.PicoTimestamp where PcS_PcKID = @ID and PcS_OBITyp = 736
	-- Definicje cen
	select @PcK_TSSynchrNtcPtw=isnull(PcS_TSSynchrPtw,0) from cdn.PicoTimestamp where PcS_PcKID = @ID and PcS_OBITyp = 64
	-- stawki VAT
	select @PcK_TSSynchrVATPtw=isnull(PcS_TSSynchrPtw,0) from cdn.PicoTimestamp where PcS_PcKID = @ID and PcS_OBITyp = 624
	-- Jednostki miary
	select @PcK_TSSynchrJmPtw=isnull(PcS_TSSynchrPtw,0) from cdn.PicoTimestamp where PcS_PcKID = @ID and PcS_OBITyp = 144
	-- Operatorzy
	select @PcK_TSSynchrOpePtw=isnull(PcS_TSSynchrPtw,0) from cdn.PicoTimestamp where PcS_PcKID = @ID and PcS_OBITyp = 128
	-- Pracownicy
	select @PcK_TSSynchrPrcPtw=isnull(PcS_TSSynchrPtw,0) from cdn.PicoTimestamp where PcS_PcKID = @ID and PcS_OBITyp = 944
	-- Definicje dokumentów
	select @PcK_TSSynchrDokPtw=isnull(PcS_TSSynchrPtw,0) from cdn.PicoTimestamp where PcS_PcKID = @ID and PcS_OBITyp = 4320
	-- Sposoby dostawy
	select @PcK_TSSynchrDSTPtw=isnull(PcS_TSSynchrPtw,0) from cdn.PicoTimestamp where PcS_PcKID = @ID and PcS_OBITyp = 976
	-- Slowniki SLW
	select @PcK_TSSynchrSLWPtw=isnull(PcS_TSSynchrPtw,0) from cdn.PicoTimestamp where PcS_PcKID = @ID and PcS_OBITyp = 8225

	IF @PcK_Typ = 3 -- XL
	BEGIN 
		/****** Konfig ******/
		SELECT @Opis = 'Konfiguracja'
		EXEC CDN.Log_OtworzPoziom @LogID, @Opis

		SELECT Kon_Numer					AS [@Numer],
			   Kon_Lp						AS [@Lp],
			   ISNULL(Kon_System,'')		AS [@System],	
			   ISNULL(Kon_Status,'')		AS [@Status],	
			   ISNULL(Kon_Wartosc,'')		AS [@Wartosc],
			   ISNULL(Kon_Komentarz,'')		AS [@Komentarz] 
		FROM CDN.Konfig
		WHERE Kon_Numer = 736 
		FOR XML PATH('KON'),ROOT('KONI')

		SET @IloscWierszy = @@ROWCOUNT

		SELECT @Opis = 'Ilość wyeksportowanych rekordów: '+ CAST(@IloscWierszy AS VARCHAR(10))
		EXEC CDN.Log_Dopisz @LogID, @Opis,0
		EXEC CDN.Log_ZamknijPoziom @LogID

		/****** Nazwy ******/
		SELECT @Opis = 'Nazwy'
		EXEC CDN.Log_OtworzPoziom @LogID, @Opis

		SELECT Naz_GIDTyp				AS [@GIDTyp],
			   Naz_GIDNumer				AS [@GIDNumer],
			   Naz_GIDLp				AS [@GIDLp],
			   ISNULL(Naz_Nazwa,'')		AS [@Nazwa],
			   ISNULL(Naz_Nazwa1,'')	AS [@Nazwa1],
			   ISNULL(Naz_Opis,'')		AS [@Opis]
		FROM CDN.Nazwy AS NAZ
		--WHERE Naz_GIDTyp IN (64,576,976)
		WHERE Naz_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @Pck_TSSynchrPtw else Naz_CzasModyfikacji end
		FOR XML PATH('NAZ'), ROOT('NAZI')

		SET @IloscWierszy = @@ROWCOUNT

		SELECT @Opis = 'Ilość wyeksportowanych rekordów: '+ CAST(@IloscWierszy AS VARCHAR(10))
		EXEC CDN.Log_Dopisz @LogID, @Opis,0
		EXEC CDN.Log_ZamknijPoziom @LogID


		/****** Slowniki ******/
		SELECT @Opis = 'Słowniki'
		EXEC CDN.Log_OtworzPoziom @LogID, @Opis
			  
		SELECT
			SLW_ID               AS [@ID],
			SLW_Predefiniowany   AS [@Predefiniowany],
			SLW_Kategoria        AS [@Kategoria],
			SLW_WartoscS         AS [@WartoscS],
			SLW_WartoscS1        AS [@WartoscS1],
			SLW_Nazwa            AS [@Nazwa],
			SLW_WartoscN1        AS [@WartoscN1],
			SLW_WartoscN2        AS [@WartoscN2],
			SLW_WartoscN3        AS [@WartoscN3],
			SLW_WartoscN4        AS [@WartoscN4],
			SLW_WartoscL1        AS [@WartoscL1],
			SLW_WartoscL2        AS [@WartoscL2],
			SLW_Konto            AS [@Konto],
			SLW_Aktywny          AS [@Aktywny],
			SLW_Domyslny         AS [@Domyslny],
			SLW_OptimaId         AS [@OptimaId]
		FROM CDN.Slowniki
			INNER JOIN CDN.SlownikiStruktura ON SLW_SLSId = SLS_Id
		WHERE (@Pck_Typ = 5 AND SLS_Predefiniowany &lt;&gt; 124) OR @Pck_Typ &lt;&gt; 5
		FOR XML PATH('SLW'),ROOT('SLWI')

		SET @IloscWierszy = @@ROWCOUNT

		SELECT @Opis = 'Ilość wyeksportowanych rekordów: '+ CAST(@IloscWierszy AS VARCHAR(10))
		EXEC CDN.Log_Dopisz @LogID, @Opis,0
		EXEC CDN.Log_ZamknijPoziom @LogID
	END


	/****** Magazyny ******/
	--- Do oddziału CDN RETAIL wysyłane są wszystkie magazyny dostępne w centrum oddziałowy + magazyn docelowy MMW
	SELECT  @Opis = 'Magazyny'
	EXEC CDN.Log_OtworzPoziom @LogID, @Opis	  

	SELECT 	MAG_GIDTyp           AS [@GIDTyp],
			MAG_GIDNumer         AS [@GIDNumer],
			MAG_GIDLp            AS [@GIDLp],
			CDN.XLValidateXMLChars(MAG_Kod)              AS [@Kod],
			CDN.XLValidateXMLChars(MAG_Nazwa)            AS [@Nazwa],
			MAG_KodP             AS [@KodP],
			CDN.XLValidateXMLChars(MAG_Miasto)           AS [@Miasto],
			CDN.XLValidateXMLChars(MAG_Ulica)            AS [@Ulica],
			MAG_Adres            AS [@Adres],
			MAG_PrcTyp           AS [@PrcTyp],
			MAG_PrcFirma         AS [@PrcFirma],
			MAG_PrcNumer         AS [@PrcNumer],
			MAG_PrcLp            AS [@PrcLp],
			MAG_Pojemnosc        AS [@Pojemnosc],
			MAG_Konto            AS [@Konto],
			CDN.XLValidateXMLChars(MAG_Opis)             AS [@Opis],
			MAG_Wewnetrzny       AS [@Wewnetrzny],
			MAG_Pico             AS [@Pico],
			MAG_Zarzadzanie      AS [@Zarzadzanie],
			MAG_KntTyp           AS [@KntTyp],
			MAG_KntFirma         AS [@KntFirma],
			MAG_KntNumer         AS [@KntNumer],
			MAG_KntLp            AS [@KntLp],
			MAG_Zablokowany      AS [@Zablokowany],
			MAG_DataInw          AS [@DataInw],
			MAG_KontoInw         AS [@KontoInw],
			MAG_Kraj             AS [@Kraj],
			CASE WHEN ISNULL(PcK_PicoID,0) = 0 THEN 0 ELSE 1 END AS [@Zamowien]
	FROM CDN.Magazyny 
		LEFT OUTER JOIN CDN.FrmObiekty ON FRO_GIDTyp = MAG_GIDTyp AND FRO_GIDNumer = MAG_GIDNumer AND FRO_FRMID = @PcK_CentrumId 
		LEFT OUTER JOIN CDN.PicoKonfig ON PcK_PicoID = @ID AND PcK_MagZamNumer = MAG_GIDNumer AND PcK_Typ = 5
	WHERE 
	((
		@PcK_Typ &lt;&gt; 3 AND 
		(FRO_FRMID IS NOT NULL OR MAG_GIDNumer IN (SELECT Dok_MagDNumer FROM CDN.DokDefinicje WHERE Dok_FrsId = @PcK_CentrumId AND Dok_GIDTyp = 1603)) AND 
		(Mag_Pico &lt;&gt; 0 OR (Mag_Pico = 0 AND PcK_MagZamNumer = MAG_GIDNumer))
	) OR @PcK_Typ = 3 )
	AND MAG_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrMagPtw else MAG_CzasModyfikacji end	
	FOR XML PATH('MAG'), ROOT('MAGI')

	SET @IloscWierszy = @@ROWCOUNT

	-- Wpisanie wysłanych magazynów do tabeli CDN.PicoLog
	INSERT INTO CDN.PicoLog 
	(
		PcL_PckID
		,PcL_ObiTyp
		,PcL_ObiNumer
		,PcL_ObiektID
		,PcL_ObiektTyp
		,PcL_Komentarz
		,PcL_Info
		,PcL_TStamp
	)
	SELECT 
		@ID						-- PcL_PckID
		,Mag_GIDTyp				-- PcL_ObiTyp
		,Mag_GIDNumer			-- PcL_ObiNumer
		,0						-- PcL_ObiektID
		,0						-- PcL_ObiektTyp
		,'Magazyn - ' + MAG_Kod	-- PcL_Komentarz
		,''						-- PcL_Info
		,DATEDIFF(ss,CONVERT(DATETIME,'1990-01-01',120),CONVERT(DATETIME,GETDATE(),120)) -- PcL_TStamp
	FROM CDN.Magazyny 
		LEFT OUTER JOIN CDN.FrmObiekty ON FRO_GIDTyp = MAG_GIDTyp AND FRO_GIDNumer = MAG_GIDNumer AND FRO_FRMID = @PcK_CentrumId 
		LEFT OUTER JOIN CDN.PicoKonfig ON PcK_PicoID = @ID AND PcK_MagZamNumer = MAG_GIDNumer AND PcK_Typ = 5
	WHERE	NOT EXISTS(SELECT * FROM CDN.PicoLog WHERE PcL_PcKID = @ID AND PcL_ObiTyp = MAG_GIDTyp AND PcL_ObiNumer = MAG_GIDNumer) AND 
			(FRO_FRMID IS NOT NULL OR MAG_GIDNumer IN (SELECT Dok_MagDNumer FROM CDN.DokDefinicje WHERE Dok_FrsId = @PcK_CentrumId AND Dok_GIDTyp = 1603)) AND 
			(Mag_Pico &lt;&gt; 0 OR (Mag_Pico = 0 AND PcK_MagZamNumer = MAG_GIDNumer))
			AND MAG_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrMagPtw else MAG_CzasModyfikacji end				

	SELECT @Opis = 'Ilość wyeksportowanych rekordów: '+ CAST(@IloscWierszy AS VARCHAR(10))
	EXEC CDN.Log_Dopisz @LogID, @Opis,0
	EXEC CDN.Log_ZamknijPoziom @LogID


	/****** Serie ******/
	SELECT @Opis = 'Serie'
	EXEC CDN.Log_OtworzPoziom @LogID, @Opis	  

	SELECT SER_GIDTyp				AS [@GIDTyp],
		   SER_GIDNumer				AS [@GIDNumer],
		   ISNULL(SER_GIDLp,0)		AS [@GIDLp],
	       ISNULL(SER_Nazwa,'')		AS [@Nazwa],
		   CDN.XLValidateXMLChars(ISNULL(SER_Opis,''))		AS [@Opis],
	       ISNULL(SER_RejVATSpr,'')	AS [@RejVATSpr],
		   ISNULL(SER_RejVATZak,'')	AS [@RejVATZak],
		   0						AS [@Oddzial],
		   ISNULL(SER_ZwrTyp,0)		AS [@ZwrTyp],
	       ISNULL(SER_ZwrNumer,0)	AS [@ZwrNumer],
		   ISNULL(SER_ZwrLp,0)		AS [@ZwrLp]
	FROM CDN.Serie
		LEFT OUTER JOIN CDN.FrmObiekty ON FRO_GIDTyp = SER_GIDTyp AND FRO_GIDNumer = SER_GIDNumer AND FRO_FRMID = @PcK_CentrumId 
	WHERE ((@PcK_Typ &lt;&gt; 3 AND FRO_FRMID IS NOT NULL) OR @PcK_Typ = 3)
		AND SER_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrSerPtw else SER_CzasModyfikacji end	
	FOR XML PATH('SER'), ROOT('SERI')

	SET @IloscWierszy = @@ROWCOUNT

	SELECT @Opis = 'Ilość wyeksportowanych rekordów: '+ CAST(@IloscWierszy AS VARCHAR(10))
	EXEC CDN.Log_Dopisz @LogID, @Opis,0
	EXEC CDN.Log_ZamknijPoziom @LogID


	/****** Banki ******/
	SELECT @Opis = 'Banki'
	EXEC CDN.Log_OtworzPoziom @LogID, @Opis

	SELECT DISTINCT 
		Bnk_GIDTyp           AS [@GIDTyp],
		Bnk_GIDNumer         AS [@GIDNumer],
		Bnk_GIDLp            AS [@GIDLp],
		CDN.XLValidateXMLChars(Bnk_Kod)              AS [@Kod],
		CDN.XLValidateXMLChars(Bnk_Nazwa)            AS [@Nazwa],
		CDN.XLValidateXMLChars(Bnk_Miasto)           AS [@Miasto],
		CDN.XLValidateXMLChars(Bnk_Ulica)            AS [@Ulica],
		Bnk_KodP             AS [@KodP],
		Bnk_Telefon          AS [@Telefon],
		Bnk_LastModL         AS [@LastModL],
		Bnk_LastModO         AS [@LastModO],
		Bnk_LastModC         AS [@LastModC],
		Bnk_Aktywny          AS [@Aktywny],
		Bnk_Wsk              AS [@Wsk],
		Bnk_Numer            AS [@Numer],
		Bnk_PKOBP            AS [@PKOBP],
		Bnk_Swift            AS [@Swift],
		Bnk_Kraj             AS [@Kraj],
		Bnk_KodKraju         AS [@KodKraju],
		Bnk_Wojewodztwo      AS [@Wojewodztwo],
		Bnk_Powiat           AS [@Powiat],
		Bnk_Gmina            AS [@Gmina],
		Bnk_Poczta           AS [@Poczta],
		Bnk_Modem            AS [@Modem],
		Bnk_Fax              AS [@Fax],
		Bnk_Url              AS [@Url],
		Bnk_Format           AS [@Format],
		Bnk_OddzialBRE       AS [@OddzialBRE],
		Bnk_KlientBRE        AS [@KlientBRE],
		Bnk_CzasRealizacji   AS [@CzasRealizacji],
		Bnk_OpeZTyp          AS [@OpeZTyp],
		Bnk_OpeZFirma        AS [@OpeZFirma],
		Bnk_OpeZNumer        AS [@OpeZNumer],
		Bnk_OpeZLp           AS [@OpeZLp],
		Bnk_TSZapisu         AS [@TSZapisu],
		Bnk_OpeMTyp          AS [@OpeMTyp],
		Bnk_OpeMFirma        AS [@OpeMFirma],
		Bnk_OpeMNumer        AS [@OpeMNumer],
		Bnk_OpeMLp           AS [@OpeMLp],
		Bnk_NRB              AS [@NRB],
		Bnk_Konto            AS [@Konto],
		Bnk_FBNId            AS [@FBNId],
		Bnk_FBNImpId         AS [@FBNImpId]
	FROM CDN.Banki
	JOIN CDN.PrcKarty on Prc_BnkTyp = Bnk_GIDTyp AND Prc_BnkNumer = Bnk_GIDNumer
	WHERE Bnk_LastModL &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrBnkPtw else Bnk_LastModL end		
	UNION ALL	  

	SELECT DISTINCT 
		Bnk_GIDTyp           AS [@GIDTyp],
		Bnk_GIDNumer         AS [@GIDNumer],
		Bnk_GIDLp            AS [@GIDLp],
		CDN.XLValidateXMLChars(Bnk_Kod)              AS [@Kod],
		CDN.XLValidateXMLChars(Bnk_Nazwa)            AS [@Nazwa],
		CDN.XLValidateXMLChars(Bnk_Miasto)           AS [@Miasto],
		CDN.XLValidateXMLChars(Bnk_Ulica)            AS [@Ulica],
		Bnk_KodP             AS [@KodP],
		Bnk_Telefon          AS [@Telefon],
		Bnk_LastModL         AS [@LastModL],
		Bnk_LastModO         AS [@LastModO],
		Bnk_LastModC         AS [@LastModC],
		Bnk_Aktywny          AS [@Aktywny],
		Bnk_Wsk              AS [@Wsk],
		Bnk_Numer            AS [@Numer],
		Bnk_PKOBP            AS [@PKOBP],
		Bnk_Swift            AS [@Swift],
		Bnk_Kraj             AS [@Kraj],
		Bnk_KodKraju         AS [@KodKraju],
		Bnk_Wojewodztwo      AS [@Wojewodztwo],
		Bnk_Powiat           AS [@Powiat],
		Bnk_Gmina            AS [@Gmina],
		Bnk_Poczta           AS [@Poczta],
		Bnk_Modem            AS [@Modem],
		Bnk_Fax              AS [@Fax],
		Bnk_Url              AS [@Url],
		Bnk_Format           AS [@Format],
		Bnk_OddzialBRE       AS [@OddzialBRE],
		Bnk_KlientBRE        AS [@KlientBRE],
		Bnk_CzasRealizacji   AS [@CzasRealizacji],
		Bnk_OpeZTyp          AS [@OpeZTyp],
		Bnk_OpeZFirma        AS [@OpeZFirma],
		Bnk_OpeZNumer        AS [@OpeZNumer],
		Bnk_OpeZLp           AS [@OpeZLp],
		Bnk_TSZapisu         AS [@TSZapisu],
		Bnk_OpeMTyp          AS [@OpeMTyp],
		Bnk_OpeMFirma        AS [@OpeMFirma],
		Bnk_OpeMNumer        AS [@OpeMNumer],
		Bnk_OpeMLp           AS [@OpeMLp],
		Bnk_NRB              AS [@NRB],
		Bnk_Konto            AS [@Konto],
		Bnk_FBNId            AS [@FBNId],
		Bnk_FBNImpId         AS [@FBNImpId]
	FROM CDN.Banki
	JOIN CDN.KntKarty ON Knt_BnkTyp = Bnk_GIDTyp AND Knt_BnkNumer = Bnk_GIDNumer
	JOIN CDN.PicoKonfig ON PcK_PicoID = @ID
	JOIN CDN.KntLinki ON KnL_GIDTyp = Knt_GIDTyp AND KnL_GIDNumer = Knt_GIDNumer 
	WHERE  Knt_Aktywna = 0 AND  KnL_GrOTyp = -32 AND  KnL_GrONumer = CASE WHEN PcK_KnGETyp = -32 THEN PcK_KnGENumer ELSE 0 END 
		   AND ( (Knt_AkwTyp = CASE WHEN PcK_KnGETyp &lt;&gt; -32 THEN PcK_KnGETyp   ELSE 0 END OR PcK_KnGETyp = -32) 
				 AND (Knt_AkwNumer = CASE WHEN PcK_KnGETyp &lt;&gt; -32 THEN PcK_KnGENumer ELSE 0 END OR PcK_KnGETyp = -32)
			   )	
		AND Bnk_LastModL &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrBnkPtw else Bnk_LastModL end	   
	UNION ALL	  	
	SELECT DISTINCT 
		Bnk_GIDTyp           AS [@GIDTyp],
		Bnk_GIDNumer         AS [@GIDNumer],
		Bnk_GIDLp            AS [@GIDLp],
		CDN.XLValidateXMLChars(Bnk_Kod)              AS [@Kod],
		CDN.XLValidateXMLChars(Bnk_Nazwa)            AS [@Nazwa],
		CDN.XLValidateXMLChars(Bnk_Miasto)           AS [@Miasto],
		CDN.XLValidateXMLChars(Bnk_Ulica)            AS [@Ulica],
		Bnk_KodP             AS [@KodP],
		Bnk_Telefon          AS [@Telefon],
		Bnk_LastModL         AS [@LastModL],
		Bnk_LastModO         AS [@LastModO],
		Bnk_LastModC         AS [@LastModC],
		Bnk_Aktywny          AS [@Aktywny],
		Bnk_Wsk              AS [@Wsk],
		Bnk_Numer            AS [@Numer],
		Bnk_PKOBP            AS [@PKOBP],
		Bnk_Swift            AS [@Swift],
		Bnk_Kraj             AS [@Kraj],
		Bnk_KodKraju         AS [@KodKraju],
		Bnk_Wojewodztwo      AS [@Wojewodztwo],
		Bnk_Powiat           AS [@Powiat],
		Bnk_Gmina            AS [@Gmina],
		Bnk_Poczta           AS [@Poczta],
		Bnk_Modem            AS [@Modem],
		Bnk_Fax              AS [@Fax],
		Bnk_Url              AS [@Url],
		Bnk_Format           AS [@Format],
		Bnk_OddzialBRE       AS [@OddzialBRE],
		Bnk_KlientBRE        AS [@KlientBRE],
		Bnk_CzasRealizacji   AS [@CzasRealizacji],
		Bnk_OpeZTyp          AS [@OpeZTyp],
		Bnk_OpeZFirma        AS [@OpeZFirma],
		Bnk_OpeZNumer        AS [@OpeZNumer],
		Bnk_OpeZLp           AS [@OpeZLp],
		Bnk_TSZapisu         AS [@TSZapisu],
		Bnk_OpeMTyp          AS [@OpeMTyp],
		Bnk_OpeMFirma        AS [@OpeMFirma],
		Bnk_OpeMNumer        AS [@OpeMNumer],
		Bnk_OpeMLp           AS [@OpeMLp],
		Bnk_NRB              AS [@NRB],
		Bnk_Konto            AS [@Konto],
		Bnk_FBNId            AS [@FBNId],
		Bnk_FBNImpId         AS [@FBNImpId]
	FROM CDN.Banki
		JOIN CDN.Rejestry ON Bnk_GIDNumer = KAR_BNKNumer
		LEFT OUTER JOIN CDN.FrmObiekty ON FRO_GIDTyp = KAR_GIDTyp AND FRO_GIDNumer = KAR_GIDNumer AND FRO_FRMID = @PcK_CentrumId 
	WHERE ((@PcK_Typ &lt;&gt; 3 AND FRO_FRMID IS NOT NULL) OR @PcK_Typ = 3)
	AND --Bnk_LastModL &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrBnkPtw else Bnk_LastModL end		
	((Bnk_LastModL &gt;= @PcK_TSSynchrBnkPtw) OR (KAR_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrKarPtw else KAR_CzasModyfikacji end)) -- TFS: 178523
	FOR XML PATH('BNK'), ROOT('BNKI')

	SET @IloscWierszy = @@ROWCOUNT

	SELECT @Opis = 'Ilość wyeksportowanych rekordów: '+ CAST(@IloscWierszy AS VARCHAR(10))
	EXEC CDN.Log_Dopisz @LogID, @Opis,0
	EXEC CDN.Log_ZamknijPoziom @LogID

	/****** Operacje kasowo-bankowe ******/
	IF @PcK_Typ &lt;&gt; 5 -- Do Retail nie wysylac operacji, nie sa obslugiwane
	BEGIN
		SELECT @Opis = 'Operacje kasowo-bankowe'
		EXEC CDN.Log_OtworzPoziom @LogID, @Opis

		SELECT 
			KAO_GIDTyp           AS [@GIDTyp],
			KAO_GIDNumer         AS [@GIDNumer],
			KAO_GIDLp            AS [@GIDLp],
			KAO_Kod              AS [@Kod],
			KAO_Nazwa            AS [@Nazwa],
			KAO_RP               AS [@RP],
			KAO_KontoPrzec       AS [@KontoPrzec],
			KAO_Typ              AS [@Typ],
			KAO_CiagNumeracji    AS [@CiagNumeracji],
			KAO_RodzajKursu      AS [@RodzajKursu],
			KAO_NumerKursu       AS [@NumerKursu],
			KAO_WplywaNaSrednia  AS [@WplywaNaSrednia],
			KAO_SCHTyp           AS [@SCHTyp],
			KAO_SCHNumer         AS [@SCHNumer],
			KAO_SCHLp            AS [@SCHLp],
			KAO_RodzajKategorii  AS [@RodzajKategorii],
			KAO_EdycjaKategorii  AS [@EdycjaKategorii],
			KAO_DataControllingowa AS [@DataControllingowa],
			KAO_DataKsiegowania  AS [@DataKsiegowania],
			KAO_ZalozKonto       AS [@ZalozKonto],
			KAO_Wyrazenie        AS [@Wyrazenie],
			KAO_SymbolKonta      AS [@SymbolKonta],
			KAO_Zaliczka         AS [@Zaliczka],
			KAO_Anulowanie       AS [@Anulowanie],
			KAO_NieRozliczaj     AS [@NieRozliczaj],
			KAO_Oddzial          AS [@Oddzial]
		FROM CDN.Operacje
			JOIN CDN.RejOp ON KRO_KAOTyp = KAO_GIDTyp AND KRO_KAONumer = KAO_GIDNumer
			LEFT OUTER JOIN CDN.FrmObiekty ON FRO_GIDTyp = KRO_KARTyp AND FRO_GIDNumer = KRO_KARNumer AND FRO_FRMID = @PcK_CentrumId 
		WHERE (@PcK_Typ &lt;&gt; 3 AND FRO_FRMID IS NOT NULL) OR @PcK_Typ = 3
		FOR XML PATH('KAO'), ROOT('KAOI')

		SET @IloscWierszy = @@ROWCOUNT

		SELECT @Opis = 'Ilość wyeksportowanych rekordów: '+ CAST(@IloscWierszy AS VARCHAR(10))
		EXEC CDN.Log_Dopisz @LogID, @Opis,0
		EXEC CDN.Log_ZamknijPoziom @LogID
	END	


	--;WITH RejestrRodzice(Id,GrONumer,GrOTyp,RejestryZRodzica,Poziom) AS
	--(
	--	SELECT FRS_Id,FRS_GrONumer,FRS_GrOTyp,FRS_RejestryZRodzica,1 FROM CDN.FrmStruktura WHERE FrS_Id = @FrS_ID
	--		UNION ALL
	--	SELECT FRS_Id,FRS_GrONumer,FRS_GrOTyp,FRS_RejestryZRodzica,Poziom + 1 FROM CDN.FrmStruktura 
	--	JOIN RejestrRodzice  ON FRS_GIDTyp = GrOTyp AND FRS_GIDNumer = GrONumer
	--) SELECT TOP 1 @FRS_RodzicId = Id FROM RejestrRodzice WHERE RejestryZRodzica = 0  ORDER BY Poziom ASC
	--SELECT @FRS_RodzicId = ISNULL(@FRS_RodzicId,1)
	--
	--SELECT @FRS_RodzicGIDNumer = FRS_GIDNumer FROM CDN.FrmStruktura WHERE FRS_Id = @FRS_RodzicId

	/****** Rejestry ******/
	SELECT @Opis = 'Rejestry'
	EXEC CDN.Log_OtworzPoziom @LogID, @Opis

	SELECT
		KAR_GIDTyp           AS [@GIDTyp],
		KAR_GIDNumer         AS [@GIDNumer],
		KAR_GIDLp            AS [@GIDLp],
		KAR_Seria            AS [@Seria],
		CDN.XLValidateXMLChars(KAR_Nazwa)            AS [@Nazwa],
		KAR_Typ              AS [@Typ],
		KAR_KontoKasy        AS [@KontoKasy],
		KAR_BNKTyp           AS [@BNKTyp],
		KAR_BNKNumer         AS [@BNKNumer],
		KAR_BNKLp            AS [@BNKLp],
		KAR_NrRachunku       AS [@NrRachunku],
		KAR_NRB              AS [@NRB],
		KAR_Modul            AS [@Modul],
		KAR_AutoRaport       AS [@AutoRaport],
		KAR_Okres            AS [@Okres],
		KAR_Waluta           AS [@Waluta],
		KAR_Dziennik         AS [@Dziennik],
		KAR_Bufor            AS [@Bufor],
		KAR_RachIdent        AS [@RachIdent],
		KAR_RachIdentNrKier  AS [@RachIdentNrKier],
		KAR_IdentKontr       AS [@IdentKontr],
		KAR_Oddzial          AS [@Oddzial],
		(SELECT
			KRO_KAOTyp           AS [@KAOTyp],
			KRO_KAONumer         AS [@KAONumer],
			KRO_KAOLp            AS [@KAOLp],
			KRO_Pozycja          AS [@Pozycja],
			KRO_NumerPoczatkowy  AS [@NumerPoczatkowy],
			KRO_SposobNumeracji  AS [@SposobNumeracji]
		 FROM CDN.RejOp
		 WHERE KRO_KARTyp = KAR_GIDTyp AND KRO_KARNumer = KAR_GIDNumer
		 FOR XML PATH('KRO'), ROOT('KROI'),TYPE )
	FROM CDN.Rejestry
		LEFT OUTER JOIN CDN.FrmObiekty ON FRO_GIDTyp = KAR_GIDTyp AND FRO_GIDNumer = KAR_GIDNumer AND FRO_FRMID = @PcK_CentrumId 
	WHERE ((@PcK_Typ &lt;&gt; 3 AND FRO_FRMID IS NOT NULL) OR @PcK_Typ = 3)
	AND KAR_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrKarPtw else KAR_CzasModyfikacji end	
	FOR XML PATH('KAR'), ROOT('KARI')

	-- Wpisanie wysłanych magazynów do tabeli CDN.PicoLog
	INSERT INTO CDN.PicoLog 
	(
		PcL_PckID
		,PcL_ObiTyp
		,PcL_ObiNumer
		,PcL_ObiektID
		,PcL_ObiektTyp
		,PcL_Komentarz
		,PcL_Info
		,PcL_TStamp
	)
	SELECT 
		@ID						-- PcL_PckID
		,KAR_GIDTyp				-- PcL_ObiTyp
		,KAR_GIDNumer			-- PcL_ObiNumer
		,0						-- PcL_ObiektID
		,0						-- PcL_ObiektTyp
		,'Rejestr - ' + KAR_Nazwa	-- PcL_Komentarz
		,''						-- PcL_Info
		,DATEDIFF(ss,CONVERT(DATETIME,'1990-01-01',120),CONVERT(DATETIME,GETDATE(),120)) -- PcL_TStamp
	FROM CDN.Rejestry
	LEFT OUTER JOIN CDN.FrmObiekty ON FRO_GIDTyp = KAR_GIDTyp AND FRO_GIDNumer = KAR_GIDNumer AND FRO_FRMID = @PcK_CentrumId 
	WHERE NOT EXISTS(SELECT * FROM CDN.PicoLog WHERE PcL_PcKID = @ID AND PcL_ObiTyp = KAR_GIDTyp AND PcL_ObiNumer = KAR_GIDNumer) AND 
		((@PcK_Typ &lt;&gt; 3 AND FRO_FRMID IS NOT NULL) OR @PcK_Typ = 3)
		AND KAR_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrKarPtw else KAR_CzasModyfikacji end	

	SET @IloscWierszy = @@ROWCOUNT

	SELECT @Opis = 'Ilość wyeksportowanych rekordów: '+ CAST(@IloscWierszy AS VARCHAR(10))
	EXEC CDN.Log_Dopisz @LogID, @Opis,0
	EXEC CDN.Log_ZamknijPoziom @LogID

	/****** Stanowiska ******/
	SELECT @Opis = 'Stanowiska'
	EXEC CDN.Log_OtworzPoziom @LogID, @Opis

	SELECT
		Sta_GIDTyp           AS [@GIDTyp],
		Sta_GIDNumer         AS [@GIDNumer],
		Sta_GIDLp            AS [@GIDLp],
		CDN.XLValidateXMLChars(Sta_Nazwa)            AS [@Nazwa],
		Sta_Moduly           AS [@Moduly],
		Sta_Aktywne          AS [@Aktywne],
		Sta_Wsk              AS [@Wsk],
		Sta_Licencje         AS [@Licencje],
		Sta_Dyrektor         AS [@Dyrektor],
		Sta_WidziCenyZakupu  AS [@WidziCenyZakupu],
		Sta_LimitKredytu     AS [@LimitKredytu],
		Sta_LimitPoTerminie  AS [@LimitPoTerminie],
		Sta_Administrator    AS [@Administrator],
		Sta_NTLogin          AS [@NTLogin],
		Sta_WidziKosztyZlecenia AS [@WidziKosztyZlecenia],
		Sta_GotowkaPotw      AS [@GotowkaPotw],
		Sta_ZamPotw          AS [@ZamPotw],
		Sta_LokatorTyp       AS [@LokatorTyp],
		Sta_LokatorCzas      AS [@LokatorCzas],
		Sta_OknaTryb         AS [@OknaTryb],
		Sta_Podsumowania     AS [@Podsumowania],
		Sta_PlusyNaDrzewach  AS [@PlusyNaDrzewach],
		Sta_MultiLogowanie   AS [@MultiLogowanie],
		Sta_FiltryObowiazkowe AS [@FiltryObowiazkowe],
		Sta_SerwerWydr       AS [@SerwerWydr],
		Sta_SerwerDrukarka   AS [@SerwerDrukarka],
		Sta_PracaTerminalowa AS [@PracaTerminalowa],
		Sta_LogCoWyswietlac  AS [@LogCoWyswietlac],
		Sta_LogZamknij       AS [@LogZamknij],
		Sta_Platnosci			AS [@Platnosci],
		Sta_AtrybutyZmianaKlawiatury AS [@AtrybutyZmianaKlawiatury],
		Sta_PriorytetRez		AS [@PriorytetRez],
		Sta_ZamykanieOkresu		AS [@ZamykanieOkresu],
		Sta_StrukturaMagazynu	AS [@StrukturaMagazynu],
		Sta_LimitBezOgraniczenia AS [@LimitBezOgraniczenia],
		Sta_PodgladDokumentow	AS [@PodgladDokumentow],
		Sta_RozliczenieKampanii	AS [@RozliczenieKampanii],
		StO_Opis AS [@Opis],
		(SELECT						   -- Zakazy stanowisk (tylko XL)
			StZ_ProcID					AS [@ProcID],
			ISNULL(StZ_MaskaFormy,0)	AS [@MaskaFormy],
			ISNULL(StZ_MaskaFormyAtr,0) AS [@MaskaFormyAtr]
		FROM CDN.StaZakazy
		WHERE @PcK_Typ = 3 AND StZ_StaTyp = Sta_GIDTyp AND StZ_StaNumer = Sta_GIDNumer
		FOR XML PATH('STZ'), ROOT('STZI'),TYPE ),
		(SELECT						   -- Konfiguracja stanowisk (tylko XL)		
			StK_Numer AS [@Numer],
			StK_Wartosc AS [@Wartosc],
			StK_System AS [@System]
		 FROM CDN.StaKonfig
		 WHERE @PcK_Typ = 3 AND StK_StaNumer = Sta_GIDNumer
		 FOR XML PATH('STK'), ROOT('STKI'),TYPE )
	FROM CDN.StaKarty
		LEFT OUTER JOIN CDN.StaOpisy ON StO_StaNumer = Sta_GIDNumer
	FOR XML PATH('STA'), ROOT('STAI')

	SET @IloscWierszy = @@ROWCOUNT

	SELECT @Opis = 'Ilość wyeksportowanych rekordów: '+ CAST(@IloscWierszy AS VARCHAR(10))
	EXEC CDN.Log_Dopisz @LogID, @Opis,0
	EXEC CDN.Log_ZamknijPoziom @LogID

	/****** Operatorzy ******/
	SELECT @Opis = 'Operatorzy'
	EXEC CDN.Log_OtworzPoziom @LogID, @Opis

	SELECT
		   Ope_GIDTyp                               AS [@GIDTyp],
		   Ope_GIDNumer                             AS [@GIDNumer],
		   ISNULL(Ope_GIDLp,0)                      AS [@GIDLp],
		   ISNULL(Ope_Ident,'')                     AS [@Ident],
		   ISNULL(Ope_StaTyp,0)                     AS [@StaTyp],
		   ISNULL(Ope_StaNumer,0)                   AS [@StaNumer],
		   ISNULL(Ope_StaLp,0)                      AS [@StaLp],
		   ISNULL(Ope_FrSId,0)                      AS [@FrSId],
		   CDN.XLValidateXMLChars(ISNULL(Ope_Nazwisko,''))                  AS [@Nazwisko],
		   ISNULL(Ope_Haslo,'')                     AS [@Haslo],
		   ISNULL(Ope_Haslo_chk,'')                 AS [@HasloChk],
		   ISNULL(Ope_Ident_baza,'')                AS [@IdentBaza],
		   ISNULL(Ope_Haslo_baza,'')                AS [@HasloBaza],
		   ISNULL(Ope_Administrator,0)              AS [@Administrator],
		   ISNULL(Ope_Zablokowane,0)                AS [@Zablokowane],
		   ISNULL(Ope_Kierownik,0)                  AS [@Kierownik],
		   ISNULL(Ope_NTSid,'')                     AS [@NTSid],
		   ISNULL(Ope_NTKonto,'')                   AS [@NTKonto],
		   ISNULL(Ope_NTLogin,0)                    AS [@NTLogin],
		   ISNULL(Ope_KaRTyp,0)                     AS [@KaRTyp],
		   ISNULL(Ope_KaRNumer,0)                   AS [@KaRNumer],
		   ISNULL(Ope_KaRLp,0)                      AS [@KaRLp],
		   ISNULL(Ope_BuforKasowy,0)                AS [@BuforKasowy],
		   ISNULL(Ope_Wsk,0)                        AS [@Wsk],
		   ISNULL(Ope_PrcTyp,0)                     AS [@PrcTyp],
		   ISNULL(Ope_PrcNumer,0)                   AS [@PrcNumer],
		   ISNULL(Ope_PrcLp,0)                      AS [@PrcLp],
		   ISNULL(Ope_Moduly,0)                     AS [@Moduly],
		   ISNULL(Ope_Dyrektor,0)                   AS [@Dyrektor],
		   ISNULL(Ope_WidziCenyZakupu,0)            AS [@WidziCenyZakupu],
		   ISNULL(Ope_WidziKosztyZlecenia,0)        AS [@WidziKosztyZlecenia],
		   ISNULL(Ope_LimitKredytu,0)               AS [@LimitKredytu],
		   ISNULL(Ope_LimitPoTerminie,0)            AS [@LimitPoTerminie],
		   ISNULL(Ope_GotowkaPotw,0)                AS [@GotowkaPotw],
		   ISNULL(Ope_ZamPotw,0)                    AS [@ZamPotw],
		   ISNULL(Ope_LokatorTyp,0)                 AS [@LokatorTyp],
		   ISNULL(Ope_LokatorCzas,0)                AS [@LokatorCzas],
		   ISNULL(Ope_OknaTryb,0)                   AS [@OknaTryb],
		   ISNULL(Ope_Podsumowania,0)               AS [@Podsumowania],
		   ISNULL(Ope_PlusyNaDrzewach,0)            AS [@PlusyNaDrzewach],
		   ISNULL(Ope_MultiLogowanie,0)             AS [@MultiLogowanie],
		   ISNULL(Ope_FiltryObowiazkowe,0)          AS [@FiltryObowiazkowe],
		   ISNULL(Ope_SerwerWydr,0)                 AS [@SerwerWydr],
		   ISNULL(Ope_SerwerDrukarka,'')            AS [@SerwerDrukarka],
		   ISNULL(Ope_EdycjaBudzetu,0)              AS [@EdycjaBudzetu],
		   ISNULL(Ope_DefiniowanieBudzetu,0)        AS [@DefiniowanieBudzetu],
		   ISNULL(Ope_OkresObrachunkowy,0)          AS [@OkresObrachunkowy],
		   ISNULL(Ope_PracaTerminalowa,0)           AS [@PracaTerminalowa],
		   ISNULL(Ope_LogCoWyswietlac,0)            AS [@LogCoWyswietlac],
		   ISNULL(Ope_LogZamknij,0)                 AS [@LogZamknij],
		   ISNULL(Ope_Platnosci,0)                  AS [@Platnosci],
		   ISNULL(Ope_AtrybutyZmianaKlawiatury,0)   AS [@AtrybutyZmianaKlawiatury],
		   ISNULL(Ope_PriorytetRez,0)               AS [@PriorytetRez],
		   ISNULL(Ope_NrKasjera,'')                 AS [@NrKasjera],
		   ISNULL(Ope_ZamykanieOkresu,0)            AS [@ZamykanieOkresu],
		   ISNULL(Ope_StrukturaMagazynu,0)          AS [@StrukturaMagazynu],
		   ISNULL(Ope_LimitBezOgraniczenia,0)       AS [@LimitBezOgraniczenia],
		   ISNULL(Ope_PodgladDokumentow,0)          AS [@PodgladDokumentow],
		   ISNULL(Ope_RozliczenieKampanii,0)		AS [@RozliczenieKampanii],
		   OpO_Opis									AS [@Opis],	
		   (SELECT									/*** Zakazy operatorów (tylko XL) ***/
				OpZ_ProcID					AS [@ProcID],
				ISNULL(OpZ_MaskaFormy,0)	AS [@MaskaFormy],
				ISNULL(OpZ_MaskaFormyAtr,0) AS [@MaskaFormyAtr]
			FROM CDN.OpeZakazy
			WHERE @PcK_Typ = 3 AND OpZ_OpeTyp = Ope_GIDTyp AND OpZ_OpeNumer = Ope_GIDNumer
			FOR XML PATH('OPZ'), ROOT('OPZI'),TYPE )
	FROM CDN.Opekarty
		LEFT OUTER JOIN CDN.OpeOpisy ON OpO_OpeNumer = Ope_GIDNumer AND OpO_OpeLp = 1
	WHERE (@Pck_Typ = 5 AND Ope_CzasModyfikacji &gt;= @PcK_TSSynchrOpePtw 
			AND Ope_GIDNumer IN (SELECT D.FRS_GIDNumer
							FROM CDN.FrmStruktura D
							INNER JOIN CDN.FrmStruktura R ON D.FRS_GROTyp = R.FRS_GIDTyp
									AND D.FRS_GRONumer = R.FRS_GIDNumer
									AND D.FRS_GROLp = R.FRS_GIDLp
							INNER JOIN CDN.PicoKonfig ON PcK_CentrumID = R.FRS_ID
							WHERE D.FRS_GIDTyp = 128 AND PcK_PicoID = @ID )
			) 
			OR @Pck_Typ &lt;&gt; 5
	FOR XML PATH('OPE'), ROOT('OPEI')

	SET @IloscWierszy = @@ROWCOUNT

	SELECT @Opis = 'Ilość wyeksportowanych rekordów: '+ CAST(@IloscWierszy AS VARCHAR(10))
	EXEC CDN.Log_Dopisz @LogID, @Opis,0
	EXEC CDN.Log_ZamknijPoziom @LogID


	/****** Pracownicy ******/
	SELECT @Opis = 'Pracownicy'
	EXEC CDN.Log_OtworzPoziom @LogID, @Opis
	  
	SELECT
		   Prc_GIDTyp                               AS [@GIDTyp],
		   Prc_GIDNumer                             AS [@GIDNumer],
		  ISNULL(Prc_GIDLp,0)                      AS [@GIDLp],
		   CDN.XLValidateXMLChars(ISNULL(Prc_Akronim,''))                   AS [@Akronim],
		   ISNULL(Prc_OpeTyp,0)                     AS [@OpeTyp],
		   ISNULL(Prc_OpeNumer,0)                   AS [@OpeNumer],
		   ISNULL(Prc_OpeLp,0)                      AS [@OpeLp],
		   ISNULL(Prc_BnkTyp,0)                     AS [@BnkTyp],
		   ISNULL(Prc_BnkNumer,0)                   AS [@BnkNumer],
		   ISNULL(Prc_BnkLp,0)                      AS [@BnkLp],
		   ISNULL(Prc_ZakTyp,0)                     AS [@ZakTyp],
		   ISNULL(Prc_ZakNumer,0)                   AS [@ZakNumer],
		   ISNULL(Prc_ZakLp,0)                      AS [@ZakLp],
		   CDN.XLValidateXMLChars(ISNULL(Prc_Imie1,''))                     AS [@Imie1],
		   CDN.XLValidateXMLChars(ISNULL(Prc_Imie2,''))                     AS [@Imie2],
		   CDN.XLValidateXMLChars(ISNULL(Prc_Nazwisko,''))                  AS [@Nazwisko],
		   ISNULL(Prc_KodP,'')                      AS [@KodP],
		   CDN.XLValidateXMLChars(ISNULL(Prc_Miasto,''))                    AS [@Miasto],
		   ISNULL(Prc_Poczta,'')                    AS [@Poczta],
		   CDN.XLValidateXMLChars(ISNULL(Prc_Ulica,''))                     AS [@Ulica],
		   ISNULL(Prc_NrDomu,'')                    AS [@NrDomu],
		   ISNULL(Prc_NrLokalu,'')                  AS [@NrLokalu],
		   ISNULL(Prc_NipE,'')                      AS [@NipE],
		   ISNULL(Prc_Nip,'')                       AS [@Nip],
		   ISNULL(Prc_Pesel,'')                     AS [@Pesel],
		   CDN.XLValidateXMLChars(ISNULL(Prc_EMail,''))                     AS [@EMail],
		   ISNULL(Prc_Telefon1,'')                  AS [@Telefon1],
		   ISNULL(Prc_TelefonWew1,'')               AS [@TelefonWew1],
		   ISNULL(Prc_Telefon2,'')                  AS [@Telefon2],
		   ISNULL(Prc_Telefon3,'')                  AS [@Telefon3],
		   ISNULL(Prc_URL,'')                       AS [@URL],
		   ISNULL(Prc_NrRachunku,'')                AS [@NrRachunku],
		   ISNULL(Prc_NRB,0)                        AS [@NRB],
		   ISNULL(Prc_KontoKs1,'')                  AS [@KontoKs1],
		   ISNULL(Prc_KontoKs2,'')                  AS [@KontoKs2],
		   ISNULL(Prc_KontoKs3,'')                  AS [@KontoKs3],
		   ISNULL(Prc_KontoKs4,'')                  AS [@KontoKs4],
		   ISNULL(Prc_KontoKs5,'')                  AS [@KontoKs5],
		   ISNULL(Prc_FormaNr,0)                    AS [@FormaNr],
		   ISNULL(Prc_Ksiegowany,0)                 AS [@Ksiegowany],
		   ISNULL(Prc_Archiwalny,0)                 AS [@Archiwalny],
		   ISNULL(Prc_ArchiwalnyData,0)             AS [@ArchiwalnyData],
		   ISNULL(Prc_WmrID,0)                      AS [@WmrID],
		   ISNULL(Prc_TypWymiaru,0)                 AS [@TypWymiaru],
		   ISNULL(Prc_Wyrazenie,0)                  AS [@Wyrazenie],
		   ISNULL(Prc_Inbox,'')                     AS [@Inbox],
		   ISNULL(Prc_FrSId,0)                      AS [@FrSId],
		   ISNULL(Prc_OptimaId,0)                   AS [@OptimaId],
		   ISNULL(Prc_NTSid,'')                     AS [@NTSid],
		   ISNULL(Prc_NTKonto,'')                   AS [@NTKonto],
		   Prc_Haslo                                AS [@Haslo],
		   ISNULL(Prc_Serwisant,0)                  AS [@Serwisant],
		   ISNULL(Prc_PKAId,0)                      AS [@PKAId],
		   ISNULL(Prc_Rodzaj,0)                     AS [@Rodzaj]
	FROM CDN.PrcKarty
	WHERE (@Pck_Typ = 5 AND Prc_CzasModyfikacji &gt;= @PcK_TSSynchrPrcPtw) OR @Pck_Typ &lt;&gt; 5
	FOR XML PATH('PRC'), ROOT('PRCI')

	UPDATE CDN.PrcKarty SET Prc_ZewnetrznySys = 1 WHERE @Pck_Typ = 5 AND Prc_CzasModyfikacji &gt;= @PcK_TSSynchrPrcPtw AND Prc_ZewnetrznySys = 0

	SET @IloscWierszy = @@ROWCOUNT

	SELECT @Opis = 'Ilość wyeksportowanych rekordów: '+ CAST(@IloscWierszy AS VARCHAR(10))
	EXEC CDN.Log_Dopisz @LogID, @Opis,0
	EXEC CDN.Log_ZamknijPoziom @LogID

	IF @PcK_Typ = 3 -- tylko XL
	BEGIN
		/****** Filtry ******/
		SELECT @Opis = 'Filtry'
		EXEC CDN.Log_OtworzPoziom @LogID, @Opis

		SELECT   FIL_ProcID AS [@ProcID] 
				,FIL_ListaID AS [@ListaID] 
				,FIL_Lp AS [@Lp] 
				,FIL_StaTyp AS [@StaTyp] 
				,FIL_StaNumer AS [@StaNumer] 
				,FIL_StaLp AS [@StaLp] 
				,CDN.XLValidateXMLChars(FIL_Nazwa) AS [@Nazwa] 
				,FIL_FiltrSym AS [@FiltrSym] 
				,FIL_FiltrSQL AS [@FiltrSQL] 
				,FIL_FiltrISAM AS [@FiltrISAM] 
				,FIL_Domyslny AS [@Domyslny] 
		FROM CDN.Filtry
		FOR XML PATH('FIL'), ROOT('FILI')

		SET @IloscWierszy = @@ROWCOUNT

		SELECT @Opis = 'Ilość wyeksportowanych filtrów: '+ CAST(@IloscWierszy AS VARCHAR(10))
		EXEC CDN.Log_Dopisz @LogID, @Opis,0
		EXEC CDN.Log_ZamknijPoziom @LogID
	END

	/****** Klasy cech******/
	SELECT @Opis = 'Klasy cech'
	EXEC CDN.Log_OtworzPoziom @LogID, @Opis

	SELECT   CCK_GIDTyp AS [@GIDTyp] 
			,CCK_GIDNumer AS [@GIDNumer] 
			,CCK_GIDLp AS [@GIDLp] 
			,CCK_Nazwa AS [@Nazwa] 
			,CCK_ZListy AS [@ZListy] 
			,CDN.XLValidateXMLChars(CCK_Opis) AS [@Opis] 
			,CCK_Zamknieta AS [@Zamknieta] 
	FROM CDN.CechyKlasy
	WHERE CCK_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrCechyPtw else CCK_CzasModyfikacji end		
	FOR XML PATH('CCK'), ROOT('CCKI')

	SET @IloscWierszy = @@ROWCOUNT

	SELECT @Opis = 'Ilość wyeksportowanych klas cech: '+ CAST(@IloscWierszy AS VARCHAR(10))
	EXEC CDN.Log_Dopisz @LogID, @Opis,0
	EXEC CDN.Log_ZamknijPoziom @LogID

	/****** Cechy ******/
	SELECT @Opis = 'Cechy'
	EXEC CDN.Log_OtworzPoziom @LogID, @Opis

	SELECT   CCh_GIDTyp AS [@GIDTyp] 
			,CCh_GIDNumer AS [@GIDNumer] 
			,CCh_GIDLp AS [@GIDLp] 
			,CCh_Cecha AS [@Cecha] 
			,CDN.XLValidateXMLChars(CCh_Opis) AS [@Opis] 
			,CCh_Aktywna AS [@Aktywna] 
			,CCh_Wsk AS [@Wsk] 
	FROM CDN.Cechy
	WHERE CCH_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrCechyPtw else CCH_CzasModyfikacji end			
	FOR XML PATH('CCH'), ROOT('CCHI')

	SET @IloscWierszy = @@ROWCOUNT

	SELECT @Opis = 'Ilość wyeksportowanych cech: '+ CAST(@IloscWierszy AS VARCHAR(10))
	EXEC CDN.Log_Dopisz @LogID, @Opis,0
	EXEC CDN.Log_ZamknijPoziom @LogID

	IF @Pck_Typ = 5
	BEGIN
		/****** Slowniki ******/
		SELECT @Opis = 'Słowniki'
		EXEC CDN.Log_OtworzPoziom @LogID, @Opis
			  
		SELECT DISTINCT
			SLW_ID               AS [@ID],
			SLS_Predefiniowany   AS [@KategoriaID],			
			CDN.XLValidateXMLChars(SLW_WartoscS)         AS [@WartoscS],
			SLW_Aktywny          AS [@Aktywny],
			SLW_Domyslny         AS [@Domyslny]
		FROM CDN.Slowniki
			INNER JOIN CDN.SlownikiStruktura ON SLW_SLSId = SLS_Id
			INNER JOIN CDN.PicoKonfig ON PcK_PicoID = @ID
			INNER JOIN CDN.TwrGrupy PCKTWG ON PCKTWG.TwG_SyncId = PcK_TwGNumer AND PCKTWG.TwG_GIDTyp = -16
			INNER JOIN CDN.TwrLinki ON TwL_GROTyp=PcK_TwGTyp AND TwL_GRONumer=PCKTWG.TwG_GIDNumer
			INNER JOIN CDN.TwrKarty ON Twr_MarkaId = SLW_ID AND Twr_GIDTyp = TwL_GIDTyp and Twr_GIDNumer = TwL_GIDNumer 	
		WHERE SLW_CzasModyfikacji &gt;= @PcK_TSSynchrSLWPtw or  Twr_LastModC &gt; @PcK_TSSynchrSLWPtw
		AND SLS_Predefiniowany = 105 
		FOR XML PATH('SLW'),ROOT('SLWI')

		SET @IloscWierszy = @@ROWCOUNT

		SELECT @Opis = 'Ilość wyeksportowanych rekordów: '+ CAST(@IloscWierszy AS VARCHAR(10))
		EXEC CDN.Log_Dopisz @LogID, @Opis,0
		EXEC CDN.Log_ZamknijPoziom @LogID
	END

	IF @PcK_Typ IN (1,5) -- Optima, RETAIL
	BEGIN 
		/****** Formy płatności ******/
		SELECT @Opis = 'Formy płatności'
		EXEC CDN.Log_OtworzPoziom @LogID, @Opis
		IF @Pck_Typ = 1
		BEGIN
			SELECT  Kon_Lp								AS [@ID]
				   ,RTRIM(SUBSTRING(Kon_Wartosc,21,10))	AS [@Rabat]
				   ,RTRIM(LEFT(Kon_Wartosc,20))			AS [@Nazwa]	
				   ,FRO_GID2Numer						AS [@NumerRejestru]      
				   ,FRO_DlaDetalu						AS [@Aktywna]
				   ,RTRIM(SUBSTRING(Kon_Wartosc,31,3))	AS [@Termin]
			FROM CDN.Konfig
			JOIN CDN.FrmObiekty ON FRO_GIDTyp = 736 AND Kon_Lp=FRO_GIDNumer 
			WHERE FRO_FRMID = @PcK_CentrumId ORDER BY Kon_Lp
			FOR XML PATH('FPL'),ROOT('FPLI')
			SET @IloscWierszy = @@ROWCOUNT
		END
		IF @Pck_Typ = 5
		BEGIN
			SELECT  Kon_Lp								AS [@ID]
				   ,RTRIM(SUBSTRING(Kon_Wartosc,21,10))	AS [@Rabat]
				   ,RTRIM(LEFT(Kon_Wartosc,20))			AS [@Nazwa]	
				   ,FRO_GID2Numer						AS [@NumerRejestru]
				   ,1-Kon_Archiwalny					AS [@Aktywna]
				   ,RTRIM(SUBSTRING(Kon_Wartosc,31,3))	AS [@Termin]
			FROM CDN.Konfig
			JOIN CDN.FrmObiekty ON FRO_GIDTyp = 736 AND Kon_Lp=FRO_GIDNumer 
			WHERE FRO_FRMID = @PcK_CentrumId AND FRO_DlaDetalu = 1 AND
				(
					Kon_Archiwalny = 0 OR 
					(
						Kon_Archiwalny = 1 AND 
						EXISTS
						(
							SELECT * 
							FROM CDN.PicoLog 
							WHERE PcL_PcKID = @ID AND
								PcL_ObiTyp = Kon_Numer AND 
								PcL_ObiNumer = Kon_Lp 
								
						)
					)
				)
			AND Kon_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrFplPtw else Kon_CzasModyfikacji end		
			ORDER BY Kon_Lp
			FOR XML PATH('FPL'),ROOT('FPLI')
			SET @IloscWierszy = @@ROWCOUNT
			
			-- Dopisanie wysłanych form płatności do tabeli CDN.PicoLog
			INSERT INTO CDN.PicoLog 
			(
				PcL_PckID
				,PcL_ObiTyp
				,PcL_ObiNumer
				,PcL_ObiektID
				,PcL_ObiektTyp
				,PcL_Komentarz
				,PcL_Info
				,PcL_TStamp
			)
			SELECT 
				@ID													-- PcL_PckID
				,Kon_Numer											-- PcL_ObiTyp
				,Kon_Lp												-- PcL_ObiNumer
				,0													-- PcL_ObiektID
				,0													-- PcL_ObiektTyp
				,'Forma płatności - ' + RTRIM(LEFT(Kon_Wartosc,20))	-- PcL_Komentarz
				,''													-- PcL_Info
				,DATEDIFF(ss,CONVERT(DATETIME,'1990-01-01',120),CONVERT(DATETIME,GETDATE(),120)) -- PcL_TStamp
			FROM CDN.Konfig
				JOIN CDN.FrmObiekty ON FRO_GIDTyp = Kon_Numer AND Kon_Lp=FRO_GIDNumer 
			WHERE Kon_Numer = 736 AND FRO_FRMID = @PcK_CentrumId AND FRO_DlaDetalu = 1 AND Kon_Archiwalny = 0 AND
				NOT EXISTS(SELECT * FROM CDN.PicoLog WHERE PcL_PcKID = @ID AND PcL_ObiTyp = Kon_Numer AND PcL_ObiNumer = Kon_Lp)
			AND Kon_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrFplPtw else Kon_CzasModyfikacji end				
			ORDER BY Kon_Lp	
		END
		SELECT @Opis = 'Ilość wyeksportowanych form płatności: '+ CAST(@IloscWierszy AS VARCHAR(10))
		EXEC CDN.Log_Dopisz @LogID, @Opis,0
		EXEC CDN.Log_ZamknijPoziom @LogID


		/****** Definicje cen ******/
		SELECT @Opis = 'Definicje cen'
		EXEC CDN.Log_OtworzPoziom @LogID, @Opis

		SELECT  Naz_GIDLp AS [@ID]
			   ,RTRIM(LEFT(Naz_Nazwa,10)) AS [@Nazwa]
			   ,CASE WHEN ISNULL(SUBSTRING(Naz_Nazwa,11,1),'N')='N' THEN 1 ELSE 2 END AS [@FlagaNB]
			   ,CASE WHEN Naz_GIDLp = FrS_CenaDomyslna THEN 1 ELSE 0 END AS [@Domyslna]				--TID[171020]
			   ,CASE WHEN ISNULL(SUBSTRING(Naz_Nazwa,12,1),'0')='0' THEN 0 ELSE 1 END AS [@Precyzja]
			   ,FRO_Autonomiczna AS [@Autonomiczna]
		FROM CDN.FrmObiekty  
		INNER JOIN CDN.FrmStruktura ON FrS_ID = FRO_FrmID											--TID[171019]
		LEFT OUTER JOIN CDN.Nazwy ON Naz_GIDLp = FRO_GIDLp AND Naz_GIDTyp = FRO_GIDTyp
		WHERE FRO_FRMID = @Pck_CentrumId AND FRO_GIDTyp = 64
		AND Naz_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrNtcPtw else Naz_CzasModyfikacji end
		
		UNION ALL
		SELECT 0
			   ,'Zakupu'
			   ,1
			   ,1
			   ,0
			   ,0
		FOR XML PATH('NTC'),ROOT('NTCI')

		SET @IloscWierszy = @@ROWCOUNT

		-- Oznaczenie typu ceny jako wysłany do oddziału
		;DISABLE TRIGGER [CDN].[Nazwy_CzasModyfikacji] on cdn.Nazwy

		UPDATE CDN.Nazwy
		SET Naz_Nazwa1 = '1'
		FROM CDN.FrmObiekty  
			INNER JOIN CDN.FrmStruktura ON FrS_ID = FRO_FrmID											--TID[171019]
			LEFT OUTER JOIN CDN.Nazwy ON Naz_GIDLp = FRO_GIDLp AND Naz_GIDTyp = FRO_GIDTyp
		WHERE FRO_FRMID = 5 AND FRO_GIDTyp = 64
		AND Naz_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrNtcPtw else Naz_CzasModyfikacji end

		;ENABLE TRIGGER [CDN].[Nazwy_CzasModyfikacji] on cdn.Nazwy

		SELECT @Opis = 'Ilość wyeksportowanych definicji cen: '+ CAST(@IloscWierszy AS VARCHAR(10))
		EXEC CDN.Log_Dopisz @LogID, @Opis,0
		EXEC CDN.Log_ZamknijPoziom @LogID


		/****** Stawki VAT ******/
		SELECT @Opis = 'Stawki VAT'
		EXEC CDN.Log_OtworzPoziom @LogID, @Opis

		SELECT   RTRIM(LEFT(Naz_Nazwa1,5)) AS [@StawkaPod]
			    ,Naz_Opis AS [@Opis]
				,SUBSTRING(Naz_Nazwa1,11,1) AS [@FlagaVat]
				,SUBSTRING(Naz_Nazwa,1,1) AS [@GrupaPod]
				,CASE WHEN EXISTS(SELECT Kon_Wartosc FROM CDN.Konfig WHERE Kon_Numer = 9913 AND Kon_Wartosc = Naz_Nazwa) THEN 1 ELSE 0 END
				 +2*CASE WHEN EXISTS(SELECT Kon_Wartosc FROM CDN.Konfig WHERE Kon_Numer = 9977 AND Kon_Wartosc = Naz_Nazwa) THEN 1 ELSE 0 END  AS [@Eksport]
				,CASE WHEN EXISTS(SELECT Kon_Wartosc FROM CDN.Konfig WHERE Kon_Numer = 981 AND Kon_Wartosc = Naz_Nazwa) THEN 1 ELSE 0 END AS [@Domyslna]
				, Naz_GIDLp AS [@GIDLp]
		FROM CDN.Nazwy
		WHERE Naz_GIDTyp = 624
		AND Naz_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrVATPtw else Naz_CzasModyfikacji end
	    FOR XML PATH('VAT'),ROOT('VATI')

		SET @IloscWierszy = @@ROWCOUNT

		SELECT @Opis = 'Ilość wyeksportowanych stawek VAT: '+ CAST(@IloscWierszy AS VARCHAR(10))
		EXEC CDN.Log_Dopisz @LogID, @Opis,0
		EXEC CDN.Log_ZamknijPoziom @LogID

		/****** Jednostki miar ******/
		SELECT @Opis = 'Jednostki miar'
		EXEC CDN.Log_OtworzPoziom @LogID, @Opis

		SELECT  Naz_GIDLp AS [@ID]
			   ,RTRIM(Naz_Nazwa) AS [@Nazwa]
			   ,RTRIM(Naz_Opis) AS [@Opis]
		FROM CDN.Nazwy
		WHERE Naz_GIDTyp = 144
		AND Naz_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrJmPtw else Naz_CzasModyfikacji end
		FOR XML PATH('JM'),ROOT('JMI')

		SET @IloscWierszy = @@ROWCOUNT

		SELECT @Opis = 'Ilość wyeksportowanych jednostek miar: '+ CAST(@IloscWierszy AS VARCHAR(10))
		EXEC CDN.Log_Dopisz @LogID, @Opis,0
		EXEC CDN.Log_ZamknijPoziom @LogID
		
		/****** Sposoby dostawy ******/
		SELECT @Opis = 'Sposoby dostawy'
		EXEC CDN.Log_OtworzPoziom @LogID, @Opis

		SELECT  Naz_GIDLp AS [@ID]
			   ,RTRIM(Naz_Nazwa) AS [@Nazwa]
			   ,RTRIM(Naz_Opis) AS [@Opis]
		FROM CDN.Nazwy
		WHERE Naz_GIDTyp = 976
		AND Naz_CzasModyfikacji &gt;= case when @Pck_Typ = 5 then @PcK_TSSynchrDSTPtw else Naz_CzasModyfikacji end
		FOR XML PATH('DST'),ROOT('DSTI')

		SET @IloscWierszy = @@ROWCOUNT

		SELECT @Opis = 'Ilość wyeksportowanych sposobów dostawy: '+ CAST(@IloscWierszy AS VARCHAR(10))
		EXEC CDN.Log_Dopisz @LogID, @Opis,0
		EXEC CDN.Log_ZamknijPoziom @LogID		
	END

</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>