<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="Kasowanie procedury DodajRozliczenie"></A><PRE>
          <FONT SIZE="2" DISABLED="True"><I>/* Kasowanie procedury DodajRozliczenie */</I><BR>
if exists (select name from sysobjects where name = 'DodajRozliczenie' and type = 'P')
  drop procedure CDN.DodajRozliczenie;
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="Tworzenie procedury DodajRozliczenie"></A><PRE>
          <FONT SIZE="2"><I>/* Tworzenie procedury DodajRozliczenie */</I><BR>
CREATE PROCEDURE CDN.DodajRozliczenie
@GIDFirma int,
@GIDTyp1 SMALLINT,
@GIDNumer1 INT,
@GIDLp1 SMALLINT,
@GIDTyp2 SMALLINT,
@GIDNumer2 INT,
@GIDLp2 SMALLINT,
@Kwota DECIMAL(15,2) OUTPUT,
@UserID INT,
@DataDzisiejsza INT,
@R2ParID INT OUTPUT,
@D1Numer INT = 0,
@D1Lp INT = 0,
@D1DC SMALLINT = 0,
@D2Numer INT = 0,
@D2Lp INT = 0,
@D2DC SMALLINT = 0,
@Wycena SMALLINT = 0,
@WycenaWskazanie tinyint = 0,
@WycenaParID int = 0,
@KWKursL DECIMAL(15,10) = 0,
@KWKursM DECIMAL(5) = 0,
@KWKwotaWal DECIMAL(15,2) = 0,
@KWKwotaSys DECIMAL(15,2) = 0
AS

-- deklaracje

DECLARE @Nierozliczone TABLE(
Numer    SMALLINT,
GIDNumer INT,
GIDLp    SMALLINT,
DC       SMALLINT,
KwotaSys DECIMAL(15,2),
KwotaWal DECIMAL(15,2),
Konto    VARCHAR(50),
KontoNumer INT,
KontoTypPozabil TINYINT,
KontoWal VARCHAR(50),
KontoWalNumer INT,
Waluta   VARCHAR(3),
KursL	 DECIMAL(29,10),
KursM	 DECIMAL(29,10),
Znak     SMALLINT,
Data     INT,
Dokument VARCHAR(40),
Nierozliczony smallint,
Rozliczony smallint,
MaRozliczenie smallint,
WycenaParID int,
KontoRej tinyint
  );

DECLARE @KontaNieTozsame INT
DECLARE @WolaneZRozrachunku SMALLINT
DECLARE @SavDekret1Numer INT
DECLARE @SavDekret1Lp SMALLINT
DECLARE @SavDekret1DC SMALLINT
DECLARE @OpisRK VARCHAR(80)
DECLARE @OpisKompensaty VARCHAR(80)
DECLARE @Dokument1 VARCHAR(40)
DECLARE @Dokument2 VARCHAR(40) 
DECLARE @Zwykle1 SMALLINT
DECLARE @Zwykle2 SMALLINT
DECLARE @Dod1 SMALLINT
DECLARE @Dod2 SMALLINT
DECLARE @KompGIDNumer INT
DECLARE @DataDzisiejszaKomp INT;
DECLARE @DataKomp INT
DECLARE @KontoWal1 VARCHAR(50)
DECLARE @KontoWal2 VARCHAR(50)
DECLARE @KontoWal1Numer INT
DECLARE @KontoWal2Numer INT

DECLARE @Waluta1 VARCHAR(3)
DECLARE @Waluta2 VARCHAR(3)
DECLARE @KwotaWal DECIMAL(15,2)
DECLARE @KwotaSys DECIMAL(15,2)
DECLARE @KwotaRozWal DECIMAL(15,2)
DECLARE @KwotaRozSys DECIMAL(15,2)
DECLARE @KwotaRozSys1 DECIMAL(15,2)
DECLARE @KwotaRozSys2 DECIMAL(15,2)
DECLARE @KwotaTRWal1 DECIMAL(15,2)
DECLARE @KwotaTRSys1 DECIMAL(15,2)
DECLARE @KwotaTRWal2 DECIMAL(15,2)
DECLARE @KwotaTRSys2 DECIMAL(15,2)
DECLARE @Dekret1Numer INT
DECLARE @Dekret1Lp SMALLINT
DECLARE @Dekret1DC SMALLINT
DECLARE @Dekret2Numer INT
DECLARE @Dekret2Lp SMALLINT
DECLARE @Dekret2DC SMALLINT
DECLARE @Zaksiegowany1 SMALLINT
DECLARE @Zaksiegowany2 SMALLINT
DECLARE @Data1 INT
DECLARE @Data2 INT
declare @CzasZapisu1 int
declare @CzasZapisu2 int
declare @KAZLokata1 tinyint
set @KAZLokata1 = 0
declare @KAZLokata2 tinyint
set @KAZLokata2 = 0
declare @KAZKursWgWyceny1 tinyint
declare @KAZKursWgWyceny2 tinyint
declare @KAZKrpLp1 int
declare @KAZKrpLp2 int
declare @DopasujKurs tinyint

DECLARE @WalutaSys VARCHAR(3)

DECLARE	@PdmTyp1 smallint
DECLARE	@PdmNumer1 int
DECLARE	@PdmTyp2 smallint
DECLARE	@PdmNumer2 int


DECLARE @Cnt1 SMALLINT;
DECLARE @Cnt2 SMALLINT;
DECLARE @RoznicaKursowa DECIMAL(15,2);
declare @DekretRKDC smallint
DECLARE @KontoDT VARCHAR(50);
DECLARE @KontoCT VARCHAR(50);
DECLARE @KontoDTNumer INT;
DECLARE @KontoCTNumer INT;
DECLARE @Znak1 INT
DECLARE @Znak2 INT
DECLARE @Rozliczony1 INT
DECLARE @Rozliczony2 INT
DECLARE @ZnakTR1 INT
DECLARE @ZnakTR2 INT


DECLARE @DataDzisiejszaRK INT;
DECLARE @OkresRK INT
DECLARE @StronaRK SMALLINT
DECLARE @StronaRozl tinyint
DECLARE @PozniejRozl tinyint


DECLARE @KwotaWal1 DECIMAL(15,2)
DECLARE @KwotaSys1 DECIMAL(15,2)
DECLARE @KwotaWal2 DECIMAL(15,2)
DECLARE @KwotaSys2 DECIMAL(15,2)
DECLARE @DataRoz1 INT
DECLARE @DataRoz2 INT
DECLARE @DataRoz  INT

declare @KursDTL1 decimal(29,10)
declare @KursDTM1 decimal(29,10)
declare @KursDTL2 decimal(29,10)
declare @KursDTM2 decimal(29,10)
declare @KursDTL decimal(29,10)
declare @KursDTM decimal(29,10)

DECLARE @Konto1 VARCHAR(50)
DECLARE @Konto2 VARCHAR(50)
DECLARE @Konto1Numer INT
DECLARE @Konto2Numer INT
DECLARE @Konto1TypPozabil TINYINT
DECLARE @Konto2TypPozabil TINYINT
DECLARE @Termin1 INT
DECLARE @Termin2 INT



declare @poz_DecKwota smallint
set @poz_DecKwota = 2 
declare @Kurs1 decimal(29,10)
declare @Kurs2 decimal(29,10)
declare @DataRozliczenia int
declare @DataRozrachunku int
declare @DataRK int
declare @DataRKN int
declare @DataRKN_Rok int
declare @DokumentRK smallint
declare @DokumentRKAutomat smallint
declare @RKDekretNumer int
declare @RKN_ID int

declare @tmpDokTyp smallint
declare @tmpDokNumer int
declare @tmpDokLp smallint


declare @tmpDekretNumer int
declare @tmpDekretLp smallint
declare @tmpDekretDC smallint
declare @tmpDekretDod smallint
declare @tmpDekretWaluta varchar(3)

declare @tmpRKDokTyp smallint
declare @tmpRKDokNumer int
declare @tmpRKDokLp smallint

declare @tmpRKDekretNumer int
declare @tmpRKDekretLp smallint
declare @tmpRKDekretDC smallint
declare @tmpRKDekretDod smallint

declare @tmpRoznicaKursowa decimal(15,2)


declare @RozliczenieCalkowite smallint
declare @KwotaDTWal1 decimal(15,2)
declare @KwotaDTSys1 decimal(15,2)
declare @KwotaDTWal2 decimal(15,2)
declare @KwotaDTSys2 decimal(15,2)
declare @BZ smallint
declare @BladKwoty smallint
set @BladKwoty = 0
declare @StronaKW tinyint
declare @ParID int
declare @err int
declare @RCount int
declare @szMsg1 varchar(20)
declare @TylkoRozrachunek smallint
set @TylkoRozrachunek = 0
declare @JestRozrachunek tinyint
set @JestRozrachunek = 0
set @StronaKW = 0
declare @OldKonto1Numer int
declare @OldKonto2Numer int
declare @OldKonto1 varchar(50)
declare @OldKonto2 varchar(50)
declare @OldKontoWal1Numer int
declare @OldKontoWal2Numer int
declare @OldKontoWal1 varchar(50)
declare @OldKontoWal2 varchar(50)
declare @EdycjaGIDTyp SMALLINT
declare @EdycjaGIDNumer INT
declare @RKN_Dziennik varchar(3)

-- początek transakcji
SET NOCOUNT ON

BEGIN TRAN

--zakladamy ze nie mozna jawnie rozliczac dokumentow roznic kursowych
if @GidTyp1 = 435 or @GidTyp2 = 435 
begin
	ROLLBACK TRAN
	raiserror('999:Błędne parametry wejściowe procedury DodajRozliczenie',16,1)
	return (999)
end



IF @D1DC &lt;&gt; 0 OR @D2DC &lt;&gt; 0
	SET @WolaneZRozrachunku = 1
ELSE
	SET @WolaneZRozrachunku = 0


SELECT @WalutaSys = KON_Wartosc FROM CDN.Konfig with(nolock) WHERE KON_Numer = 211


if @WolaneZRozrachunku &lt;&gt; 0
begin
	set @DokumentRK = 0 -- w przypadku rozrachowywania powstaje zawsze tylko zapis RK 
	set @DokumentRKAutomat = 1
end
else
begin
	if @Wycena = 0
	begin
		set @DokumentRK = isnull((SELECT KON_Wartosc FROM CDN.Konfig with(nolock) WHERE KON_Numer = 2095),0)
		set @DokumentRKAutomat = isnull((SELECT KON_Wartosc FROM CDN.Konfig with(nolock) WHERE KON_Numer = 2096),0)
	end
	else
	begin
		set @DokumentRK = 1
		set @DokumentRKAutomat = 1
	end			
end


SET @Dod1 = 0
SET @Dod2 = 0

-- pobranie dokumentów i dekretów
IF @GIDTyp1 = 784
BEGIN
	SELECT 
		@Waluta1 = case when @Wycena = 0 then KAZ_WalutaRoz else KAZ_Waluta end, 
		@KwotaTRWal1 = case when @Wycena = 0 then Abs(KAZ_PozostajeRoz) else abs(KAZ_PozostajeWycena) end, 
		@KwotaTRSys1 = case when @Wycena = 0 then Abs(KAZ_PozostajeSys) else abs(KAZ_PozostajeWycenaSys) end,
		@Kurs1 = KAZ_KursL/KAZ_KursM, --case when KAZ_KursKAZ_KwotaSys/case when KAZ_KwotaRoz=0 then 1 else KAZ_KwotaRoz end,
		@Zaksiegowany1 = KAZ_Zaksiegowano, 
		@Data1 = KAZ_DataZapisu, 
		@CzasZapisu1 = KAZ_CzasZapisu,
		@ZnakTR1 = KAZ_Znak, 
		@Rozliczony1 = KAZ_Rozliczony, 
		@Termin1 = KAZ_DataZapisu,
		@PdmTyp1 = KAZ_KntTyp,
		@PdmNumer1 = KAZ_KntNumer,
		@KAZLokata1 = KAZ_Lokata,
		@KAZKursWgWyceny1 = KAZ_KursWgWyceny,
		@KAZKrpLp1 = KAZ_KrpLp
	FROM CDN.Zapisy with (updlock) WHERE KAZ_GIDNumer = @GIDNumer1


	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('100:Błąd pobrania wiersza do rozliczenia', 16, 1) 
	  RETURN 100
	END		
END
ELSE
BEGIN
	SELECT 
		@Waluta1 = TRDV_Waluta, 
		@KwotaTRWal1 = Abs(TRDV_Pozostaje),
		@KwotaTRSys1 = CASE WHEN TRDV_Waluta = @WalutaSys THEN 
					Abs(TRDV_Pozostaje) 
				ELSE 
					abs(TRDV_PozostajeSys)
				END,
		@Kurs1 = TRDV_KursL / TRDV_KursM, --TRDV_KwotaSys/TRDV_Kwota, 
		@Zaksiegowany1 = TRDV_Zaksiegowano, 
		@Data1 = TRDV_Data, 
		@ZnakTR1 = CASE WHEN TRDV_Kwota &gt;= 0 THEN 3-TRDV_Typ ELSE TRDV_Typ END, 
		@Rozliczony1 = TRDV_Rozliczona, 
		@Termin1 = TRDV_Termin,
		@BladKwoty = case when isnull(TRDV_KwotaSys,0) = 0 and isnull(TRDV_Kwota,0) &lt;&gt; 0 then 1 else 0 end,
		@PdmTyp1 = TRDV_KntTyp,
		@PdmNumer1 = TRDV_KntNumer
	FROM CDN.TrpDokView with (updlock)
	WHERE TRDV_GIDTyp = @GIDTyp1 AND TRDV_GIDNumer = @GIDNumer1 AND TRDV_GIDLp=@GIDLp1

	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('100:Błąd pobrania wiersza do rozliczenia', 16, 1) 
	  RETURN 100
	END


	IF EXISTS(SELECT * FROM CDN.Zrodla with(nolock) JOIN CDN.Dekrety 
			ON ZRO_DTTyp=432 AND ZRO_DTNumer=DT_GIDnumer AND ZRO_DTLp=DT_GIDLp 
	     	WHERE ZRO_TRNTyp = @GIDTyp1 AND ZRO_TRNNumer = @GIDNumer1 AND ZRO_TRNLp = @GIDLp1)

		SET @Zaksiegowany1 = 1
	ELSE
		SET @Zaksiegowany1 = 0


	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('100:Błąd pobrania wiersza do rozliczenia', 16, 1) 
	  RETURN 100
	END
END


if @BladKwoty = 1 
BEGIN
  ROLLBACK TRAN
  RAISERROR('100:Operacja anulowana. Brak kwoty w walucie systemowej na płatności dokumentu', 16, 1) 
  RETURN 100
END
else
	set @BladKwoty = 0


IF @GIDTyp2 = 784
BEGIN
	SELECT 	
		@Waluta2 = case when @Wycena = 0 then KAZ_WalutaRoz else KAZ_Waluta end, 
		@KwotaTRWal2 = case when @Wycena = 0 then Abs(KAZ_PozostajeRoz) else abs(KAZ_PozostajeWycena) end, 
		@KwotaTRSys2 = case when @Wycena = 0 then Abs(KAZ_PozostajeSys) else abs(KAZ_PozostajeWycenaSys) end,
		@Kurs2 = KAZ_KursL/KAZ_KursM, --case when KAZ_KursKAZ_KwotaSys/case when KAZ_KwotaRoz=0 then 1 else KAZ_KwotaRoz end,
		@Zaksiegowany2 = KAZ_Zaksiegowano, 
		@Data2 = KAZ_DataZapisu, 
		@CzasZapisu2 = KAZ_CzasZapisu,
		@ZnakTR2 = KAZ_Znak, 
		@Rozliczony2 = KAZ_Rozliczony, 
		@Termin2 = KAZ_DataZapisu,
		@PdmTyp2 = KAZ_KntTyp,
		@PdmNumer2 = KAZ_KntNumer,
		@KAZLokata2 = KAZ_Lokata,
		@KAZKursWgWyceny2 = KAZ_KursWgWyceny,
		@KAZKrpLp2 = KAZ_KrpLp		
	FROM CDN.Zapisy with (updlock) WHERE KAZ_GIDNumer = @GIDNumer2

	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('100:Błąd pobrania wiersza do rozliczenia.', 16, 1) 
	  RETURN 100
	END
END
ELSE
BEGIN
	SELECT 
		@Waluta2 = TRDV_Waluta, 
		@KwotaTRWal2 = Abs(TRDV_Pozostaje),
		@KwotaTRSys2 = CASE WHEN TRDV_Waluta = @WalutaSys THEN 
					Abs(TRDV_Pozostaje) 
				ELSE 
					abs(TRDV_PozostajeSys)
				END,
		@Kurs2 = TRDV_KursL / TRDV_KursM, --TRDV_KwotaSys/TRDV_Kwota, 
		@Zaksiegowany2 = TRDV_Zaksiegowano, 
		@Data2 = TRDV_Data, 
		@ZnakTR2 = CASE WHEN TRDV_Kwota &gt;= 0 THEN 3-TRDV_Typ ELSE TRDV_Typ END, 
		@Rozliczony2 = TRDV_Rozliczona, 
		@Termin2 = TRDV_Termin,
		@BladKwoty = case when isnull(TRDV_KwotaSys,0) = 0 and isnull(TRDV_Kwota,0) &lt;&gt; 0 then 1 else 0 end,
		@PdmTyp2 = TRDV_KntTyp,
		@PdmNumer2 = TRDV_KntNumer
	FROM CDN.TrpDokView with (updlock) 
	WHERE TRDV_GIDTyp = @GIDTyp2 AND TRDV_GIDNumer = @GIDNumer2 AND TRDV_GIDLp=@GIDLp2


	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('100:Błąd pobrania wiersza do rozliczenia.', 16, 1) 
	  RETURN 100
	END


	IF EXISTS(SELECT * FROM CDN.Zrodla with(nolock) JOIN CDN.Dekrety 
				ON ZRO_DTTyp=432 AND ZRO_DTNumer=DT_GIDnumer AND ZRO_DTLp=DT_GIDLp 
	      		WHERE ZRO_TRNTyp = @GIDTyp2 AND ZRO_TRNNumer = @GIDNumer2 AND ZRO_TRNLp = @GIDLp2 AND ZRO_DTTyp=432)

		SET @Zaksiegowany2 = 1
	ELSE
		SET @Zaksiegowany2 = 0

	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('100:Błąd pobrania wiersza do rozliczenia.', 16, 1) 
	  RETURN 100
	END

END



if @BladKwoty = 1 
BEGIN
  ROLLBACK TRAN
  RAISERROR('100:Operacja anulowana. Brak kwoty w walucie systemowej na płatności dokumentu', 16, 1) 
  RETURN 100
END
else
	set @BladKwoty = 0



if @Wycena = 0 and ((@GIDTyp1 = 784 or @GIDTyp2 = 784) and (@KAZLokata1 = 1 or @KAZLokata2 = 1) and @KAZLokata1 &lt;&gt; @KAZLokata2)
BEGIN
  ROLLBACK TRAN  
  
  if @GIDTyp1 = 784 and @KAZLokata1 = 1
	if @Znak1 = 1
		RAISERROR('101:Operacja anulowana. Zapis bankowy zakładający lokatę może być rozliczony jedynie z zapisem bankowym zamykającym lokatę', 16, 1) 
	else
		RAISERROR('101:Operacja anulowana. Zapis bankowy zamykający lokatę może być rozliczony jedynie z zapisem bankowym zakładającym lokatę', 16, 1)

  
  if @GIDTyp2 = 784 and @KAZLokata2 = 1
	if @Znak2 = 1
		RAISERROR('101:Operacja anulowana. Zapis bankowy zakładający lokatę może być rozliczony jedynie z zapisem bankowym zamykającym lokatę', 16, 1) 
	else
		RAISERROR('101:Operacja anulowana. Zapis bankowy zamykający lokatę może być rozliczony jedynie z zapisem bankowym zakładającym lokatę', 16, 1) 


  
  RETURN 101
END


-- sprawdzenie waluty
IF @Waluta1 &lt;&gt; @Waluta2
BEGIN
  ROLLBACK TRAN
  RAISERROR('101:Rozliczane dokumenty różnią się walutą: %s &lt;&gt; %s. Rozliczenie niemożliwe!', 16, 1, @Waluta1, @Waluta2 ) 
  RETURN 101
END



if @Wycena = 1
begin
	if @Waluta1 = @WalutaSys or @Waluta2 = @WalutaSys
	begin
		ROLLBACK TRAN
		RAISERROR('101:Operacja anulowana. Rozliczanie wyceny musi być dla zapisów w walucie obcej', 16, 1) 
		RETURN 101
	end

	if @ZnakTR1 = 1 and @KAZKursWgWyceny1 &lt;&gt; 0 
		set @DopasujKurs = 1		
	else if @ZnakTR2 = 1 and @KAZKursWgWyceny2 &lt;&gt; 0 
		set @DopasujKurs = 2	
	else
	begin
		set @DopasujKurs = 0
		
		if @CzasZapisu1 &lt; @CzasZapisu2 --pozniejsza data
			set @PozniejRozl = 2
		ELSE if @CzasZapisu1 &gt; @CzasZapisu2				
			set @PozniejRozl = 1		
		ELSE if @CzasZapisu1 = @CzasZapisu2				
			if @KAZKrpLp1 &gt; @KAZKrpLp2
				set @PozniejRozl = 1
			else
				set @PozniejRozl = 2
	end			
end
else
begin
	set @DopasujKurs = 0
	set @WycenaWskazanie = 0
	
	--przy rozliczaniu z KW z kursem fifo/lifo
	if @GIDTyp1 = 784 and @ZnakTR1 = 1 and isnull(@KWKursL,0) &lt;&gt; 0
	begin
		set @Kurs1 = @KWKursL/case when @KWKursM &lt;&gt; 0 then @KWKursM else 1 end
		set @KwotaTRWal1 = @KWKwotaWal
		set @KwotaTRSys1 = @KWKwotaSys
		set @StronaKW = 1
	end
	else if @GIDTyp2 = 784 and @ZnakTR2 = 1 and isnull(@KWKursL,0) &lt;&gt; 0
	begin
		set @Kurs2 = @KWKursL/case when @KWKursM &lt;&gt; 0 then @KWKursM else 1 end
		set @KwotaTRWal2 = @KWKwotaWal
		set @KwotaTRSys2 = @KWKwotaSys
		set @StronaKW = 2
	end



	IF (@Rozliczony1 = 2 OR @Rozliczony2 = 2) 
	begin
		if @WolaneZRozrachunku &lt;&gt; 0
			set @TylkoRozrachunek = 1
		else
		BEGIN
		  ROLLBACK TRAN
		  RAISERROR('502:Jeden z dokumentów lub oba dokumenty nie są przeznaczone do rozliczenia. Rozliczenie niemożliwe.', 16, 1) 
		  RETURN 502
		END
	end
end



if @TylkoRozrachunek = 0
begin
	IF @ZnakTR1 = @ZnakTR2
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('501:Oba dokumenty są zobowiązaniami lub oba są należnościami. Rozliczenie niemożliwe.', 16, 1) 
	  RETURN 501
	END
end


if 1=2
begin
ROLLBACK TRAN


	drop table cdn.aa1
	select 
	@Waluta1 Waluta1,
	@KwotaTRWal1 KwotaTRWal1,
	@KwotaTRSys1 KwotaTRSys1,
	
	@Waluta2 Waluta2,
	@KwotaTRWal2 KwotaTRWal2,
	@KwotaTRSys2 KwotaTRSys2,
	

	@WalutaSys WalutaSys,
	@Kwota Kwota,
	@DopasujKurs DopasujKurs,
	@poz_DecKwota poz_DecKwota,
	
	@Kurs1 Kurs1,
	@Kurs2 Kurs2,
	@KwotaWal KwotaWal,
	@KwotaSys KwotaSys,
	@RozliczenieCalkowite RozliczenieCalkowite,
	@RoznicaKursowa RoznicaKursowa,
	@StronaRK StronaRK
	into cdn.aa1


			RAISERROR('203:aaa', 16, 1) 
			RETURN 203

end



exec cdn.UstalKwoteRozliczenia
			@Waluta1,
			@KwotaTRWal1,
			@KwotaTRSys1,
			null,
			null,
			@Waluta2,
			@KwotaTRWal2,
			@KwotaTRSys2,
			null,
			null,			
			@WalutaSys,
			@Kwota,
			0,
			@poz_DecKwota,
			0,
			@DopasujKurs,		
			@Kurs1 output,
			@Kurs2 output,
			@KwotaWal output,
			@KwotaSys output,
			@RozliczenieCalkowite output,
			@RoznicaKursowa output,
			@StronaRK output,
			@BZ output,
			@KwotaRozSys1 output,
			@KwotaRozSys2 output,
			@StronaRozl output
			
 
 
 if @@TRANCOUNT = 0
	return 205
	
 

if 1=2
begin
ROLLBACK TRAN


	drop table cdn.aa1
	select 
	@Waluta1 Waluta1,
	@KwotaTRWal1 KwotaTRWal1,
	@KwotaTRSys1 KwotaTRSys1,
	
	@Waluta2 Waluta2,
	@KwotaTRWal2 KwotaTRWal2,
	@KwotaTRSys2 KwotaTRSys2,
	

	@WalutaSys WalutaSys,
	@Kwota Kwota,
	@DopasujKurs DopasujKurs,
	@poz_DecKwota poz_DecKwota,
	
	@Kurs1 Kurs1,
	@Kurs2 Kurs2,
	@KwotaWal KwotaWal,
	@KwotaSys KwotaSys,
	@RozliczenieCalkowite RozliczenieCalkowite,
	@RoznicaKursowa RoznicaKursowa,
	@StronaRK StronaRK
	into cdn.aa1


			RAISERROR('203:aaa', 16, 1) 
			RETURN 203

end


IF @KwotaWal = 0 AND @KwotaSys = 0 
begin
	IF @WolaneZRozrachunku = 0
	BEGIN
		IF @Wycena = 0
		begin
			ROLLBACK TRAN
			RAISERROR('203:Jeden z dokumentów (lub oba dokumenty) został całkowicie rozliczony.', 16, 1) 
			RETURN 203
		end
		else
		begin
			ROLLBACK TRAN
			RAISERROR('203:Jeden z zapisów (lub oba zapisy) brały już udział w całości w wycenie', 16, 1) 
			RETURN 203
		end
	END
	ELSE
	BEGIN
		set @TylkoRozrachunek = 1
	END
end


--ustal date rozliczenia
if @Data1 &lt; @Data2 --pozniejsza data
	set @DataRozliczenia = @Data2 
ELSE 
	set @DataRozliczenia = @Data1




---opisy dokumentow
if @TylkoRozrachunek = 0
begin
	set @Dokument1 = cdn.NazwaObiektu (@GIDTyp1, @GIDNumer1, 0, 2)
	set @Dokument2 = cdn.NazwaObiektu (@GIDTyp2, @GIDNumer2, 0, 2)
end
else
begin
	select 
		@Dokument1 = cdn.NumerDekretu('', DT_Dziennik, DT_Rok, DT_Miesiac, DZK_RMNumer, DEL_Pozycja, DZK_Prosty, DZK_OkrSymbol)
	from cdn.Dekrety
		join cdn.DziennikElem
			on DT_GIDNumer = DEL_GIDNumer and DT_GIDLp = DEL_GIDLp
		join cdn.Dziennik
			on DEL_GIDNumer = DZK_GIDNumer 
	where DT_GIDNumer = @Dekret1Numer and DT_GIDLp = @Dekret1Lp and DT_DC = @Dekret1DC and DT_WalutaObca = 0


	select 
		@Dokument2 = cdn.NumerDekretu('', DT_Dziennik, DT_Rok, DT_Miesiac, DZK_RMNumer, DEL_Pozycja, DZK_Prosty, DZK_OkrSymbol)
	from cdn.Dekrety
		join cdn.DziennikElem
			on DT_GIDNumer = DEL_GIDNumer and DT_GIDLp = DEL_GIDLp
		join cdn.Dziennik
			on DEL_GIDNumer = DZK_GIDNumer 
	where DT_GIDNumer = @Dekret2Numer and DT_GIDLp = @Dekret2Lp and DT_DC = @Dekret2DC and DT_WalutaObca = 0
end





IF @Zaksiegowany1 = 1 AND @Zaksiegowany2 = 1
 and ((@RoznicaKursowa = 0 or (@RoznicaKursowa &lt;&gt; 0 and (@DokumentRK = 0 or (@DokumentRK &lt;&gt; 0 and @DokumentRKAutomat &lt;&gt; 0)))))
BEGIN
	--if @Wycena &lt;&gt; 0
	--begin
	--	ROLLBACK TRAN
	--	RAISERROR('203:Rozliczanie wyceny na zaksięgowanych zapisach niemożliwe. Odksięguj jeden z zapisów (przychodowy lub rozchodowy) i ponów operację rozliczania wyceny', 16, 1) 
	--	RETURN 203
	--end

	DELETE FROM @Nierozliczone;


  	INSERT INTO @Nierozliczone( Numer, GIDNumer, GIDLp, DC, KwotaSys, KwotaWal, Konto, KontoNumer, KontoTypPozabil, KontoWal, KontoWalNumer, Waluta, KursL, KursM, Znak, Data, Dokument, Nierozliczony, Rozliczony, WycenaParID ) 
	SELECT 1, DT_GIDNumer, DT_GIDLp, DT_DC,
	MAX( CASE WHEN DT_Waluta = @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END), 
	MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END),
	MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_Konto ELSE '' END), 
	MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_GIDNumer ELSE '' END), 
	MAX( CASE WHEN DT_Waluta = @WalutaSys AND KKS_TypKonta=6 THEN 1 ELSE 0 END), 
  	MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_Konto ELSE '' END), 
  	MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_GIDNumer ELSE 0 END), 
	MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_Waluta ELSE '' END ),
	MAX( CASE WHEN DT_Waluta = @WalutaSys THEN DT_KursKwota ELSE 1 END ),
	MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_KursKwota ELSE 1 END ),
	MAX( DT_Znak ), 
  	MAX( DT_DataDekr ),
  	MAX( DEL_DokumentZrodlowy ),
	Max( DT_Nierozliczony ),
	Max( DT_Rozliczony ),
	Max( DEL_WycenaParID )
	FROM CDN.Dekrety with(updlock)
		JOIN CDN.Konta 
			ON DT_KKSNumer = KKS_GIDNumer
  		JOIN CDN.Zrodla with(nolock) 
			ON ZRO_DTTyp = 432 AND ZRO_DTNumer = DT_GIDNumer AND ZRO_DTLp = DT_GIDLp
  		JOIN CDN.DziennikElem with(nolock)
			ON DT_GIDNumer = DEL_GIDNumer AND DT_GIDLp = DEL_GIDLp
  	WHERE ZRO_TRNTyp = @GIDTyp1 AND ZRO_TRNNumer = @GIDNumer1 AND ZRO_TRNLp = @GIDLp1 AND (DT_Nierozliczony = 1 OR DT_Rozliczony=1)
		AND KKS_Rozrachunkowe &lt;&gt; 0
	GROUP BY DT_GIDNumer, DT_GIDLp, DT_DC


	
	INSERT INTO @Nierozliczone( Numer, GIDNumer, GIDLp, DC, KwotaSys, KwotaWal, Konto, KontoNumer, KontoTypPozabil, KontoWal, KontoWalNumer, Waluta, KursL, KursM, Znak, Data, Dokument, Nierozliczony, Rozliczony, WycenaParID ) 
	SELECT 2, DT_GIDNumer, DT_GIDLp, DT_DC,
	MAX( CASE WHEN DT_Waluta = @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END), 
	MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN ABS(DT_Pozostaje) ELSE 0 END),
	MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_Konto ELSE '' END), 
	MAX( CASE WHEN DT_Waluta = @WalutaSys THEN KKS_GIDNumer ELSE '' END), 
	MAX( CASE WHEN DT_Waluta = @WalutaSys AND KKS_TypKonta=6 THEN 1 ELSE 0 END), 
	MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_Konto ELSE '' END), 
 	MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN KKS_GIDNumer ELSE 0 END), 
  	MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_Waluta ELSE '' END),
  	MAX( CASE WHEN DT_Waluta = @WalutaSys THEN DT_KursKwota ELSE 1 END ),
	MAX( CASE WHEN DT_Waluta &lt;&gt; @WalutaSys THEN DT_KursKwota ELSE 1 END ),
	MAX( DT_Znak ), 
  	MAX( DT_DataDekr ),
  	MAX( DEL_DokumentZrodlowy ),
	Max( DT_Nierozliczony ),
	Max( DT_Rozliczony ),
	Max( DEL_WycenaParID )
	FROM CDN.Dekrety with(updlock)
		JOIN CDN.Konta 
			ON DT_KKSNumer = KKS_GIDNumer
  		JOIN CDN.Zrodla with(nolock)
			ON ZRO_DTTyp = 432 AND ZRO_DTNumer = DT_GIDNumer AND ZRO_DTLp = DT_GIDLp
  		JOIN CDN.DziennikElem with(nolock) 
			ON DT_GIDNumer = DEL_GIDNumer AND DT_GIDLp = DEL_GIDLp
  	WHERE ZRO_TRNTyp = @GIDTyp2 AND ZRO_TRNNumer = @GIDNumer2 AND ZRO_TRNLp = @GIDLp2 AND (DT_Nierozliczony = 1 OR DT_Rozliczony=1)
		AND KKS_Rozrachunkowe &lt;&gt; 0
	GROUP BY DT_GIDNumer, DT_GIDLp, DT_DC

	
	UPDATE @Nierozliczone SET Waluta = @WalutaSys WHERE Waluta = '';
	
----------kojarzenie dekretow	
	update @Nierozliczone set
				MaRozliczenie = 0
				
				
				
	update b set b.MaRozliczenie = case a.Wycena --1 - normalne rozliczenie, 2 - rozliczenie wyceny, 0 - brak rozliczenia						
										when 1 then 2
										when 0 then 1
										when -1 then 0
										else 0
									end					
	from @Nierozliczone b
				join (select GIDNumer, GIDLp, DC, max(case when roz2.R2_Wycena is null then -1 else roz2.R2_Wycena end) Wycena 
						from @Nierozliczone
							left join (select R2_ParId, R2_Dekret1Numer R2_DekretNumer, R2_Dekret1Lp R2_DekretLp, R2_Dekret1DC R2_DekretDC
										from cdn.Rozliczenia
										union all
										select R2_ParId, R2_Dekret2Numer R2_DekretNumer, R2_Dekret2Lp R2_DekretLp, R2_Dekret2DC R2_DekretDC
										from cdn.Rozliczenia) roz
										on GIDNumer = roz.R2_DekretNumer and GIDLp = roz.R2_DekretLp and DC = roz.R2_DekretDC
							left join cdn.Rozliczenia roz2
									on roz.R2_ParID = roz2.R2_ParID and roz2.R2_Dok1Typ &lt;&gt; 0 and roz2.R2_Dok2Typ &lt;&gt; 0

									where Rozliczony &lt;&gt; 0
									group by GIDNumer, GIDLp, DC
						) a
				on b.GIDNumer = a.GIDNumer and b.GIDLp = a.GIDLp and b.DC = a.DC
	


	if @Wycena = 1
	begin
		update @Nierozliczone set
				KontoRej = 
				case when (len(rtrim(KontoWal)) &gt; 0 
						and exists(select KAR_KontoKasy
									from cdn.Rejestry
									where KontoWal = KAR_KontoKasy))
							or exists(select KAR_KontoKasy
									from cdn.Rejestry
									where Konto = KAR_KontoKasy) 
				then 1 else 0 end			


			
		
		--kasuj na konta nie rejestru
		delete from @Nierozliczone where KontoRej = 0		

	
		set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
		set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
	
		
		if @Cnt1 &gt; 1
		begin						
			--jesli bylo rozliczenie wyceny to skasuj pozostale
			set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1 and MaRozliczenie = 2),0)
			if @Cnt1 &gt; 0
			begin				
				delete from @Nierozliczone where Numer = 1 and MaRozliczenie &lt;&gt; 2
				
				set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
				if @Cnt1 &gt; 1
				begin					
					ROLLBACK TRAN
					RAISERROR('200:Nie można dokonać rozrachunku wyceny. Na dekrecie księgowym zapisu %s dokonywano rozrachunku wyceny na więcej niż jednym koncie', 16, 1, @Dokument1) 
					RETURN 301
				end
			end			
			
			--sprawdz rozrachowane bez rozliczenia
			set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
			if @Cnt1 &gt; 1
			begin
				set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1 and Rozliczony = 1 and MaRozliczenie = 0),0)
				if @Cnt1 &gt; 0
				begin
					delete from @Nierozliczone where Numer = 1 and Rozliczony = 1 and MaRozliczenie = 0

					set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
					if @Cnt1 = 0
					begin					
						ROLLBACK TRAN
						RAISERROR('200:Nie można dokonać rozrachunku wyceny. Na dekrecie księgowym zapisu %s na koncie rejetru dokonano już rozrachunku bez rozliczenia. Usuń rozrachunek na koncie rejestru i powtórz operację rozliczania wyceny', 16, 1, @Dokument1) 
						RETURN 301
					end
				end
			end
			
			set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
			if @Cnt1 &gt; 1 
			begin
				--jesli ksiegowanie schematem to kasuj ksiegowane w oparciu o rozliczenie	
				if exists(select PDT_GIDNumer from cdn.Predekrety 
					where PDT_GIDTyp = @GIDTyp1 and PDT_GIDNumer = @GIDNumer1 
					and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0)

				begin
				
					 --skasuj wszystkie dekrety ksiegowane w oparciu o rozliczenia
					DELETE FROM a
					FROM @Nierozliczone a 
					WHERE a.Numer = 1 AND 
						exists (select PDT_GIDNumer from cdn.Predekrety 
							where PDT_GIDTyp = @GIDTyp1 and PDT_GIDNumer = @GIDNumer1 
							and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0
							and isnull(PDT_DelNumer,0) = a.GIDNumer and isnull(PDT_DelLp,0) = a.GIDLp )
				end
			end
		end		
		else if @Cnt1 = 0
		begin			
			ROLLBACK TRAN
			RAISERROR('200:Nie można dokonać rozrachunku wyceny. Zapis %s nie jest poprawnie zaksięgowany na konto rejestru', 16, 1, @Dokument1) 
			RETURN 301
		end			
		
		
		
		
		
		if @Cnt2 &gt; 1
		begin
			--jesli bylo rozliczenie wyceny to skasuj pozostale
			set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2 and MaRozliczenie = 2),0)
			if @Cnt2 &gt; 0
			begin				
				delete from @Nierozliczone where Numer = 2 and MaRozliczenie &lt;&gt; 2
				
				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
				if @Cnt2 &gt; 1
				begin					
					ROLLBACK TRAN
					RAISERROR('200:Nie można dokonać rozrachunku wyceny. Na dekrecie księgowym zapisu %s dokonywano rozrachunku wyceny na więcej niż jednym koncie', 16, 1, @Dokument2) 
					RETURN 301
				end
			end			
			
			--sprawdz rozrachowane bez rozliczenia
			set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
			if @Cnt2 &gt; 1
			begin
				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2 and Rozliczony = 1 and MaRozliczenie = 0),0)
				if @Cnt2 &gt; 0
				begin
					delete from @Nierozliczone where Numer = 2 and Rozliczony = 1 and MaRozliczenie = 0

					set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
					if @Cnt2 = 0
					begin					
						ROLLBACK TRAN
						RAISERROR('200:Nie można dokonać rozrachunku wyceny. Na dekrecie księgowym zapisu %s na koncie rejetru dokonano już rozrachunku bez rozliczenia. Usuń rozrachunek na koncie rejestru i powtórz operację rozliczania wyceny', 16, 1, @Dokument2) 
						RETURN 301
					end
				end
			end
			
			set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
			if @Cnt2 &gt; 1 
			begin
				--jesli ksiegowanie schematem to kasuj ksiegowane w oparciu o rozliczenie	
				if exists(select PDT_GIDNumer from cdn.Predekrety 
					where PDT_GIDTyp = @GIDTyp2 and PDT_GIDNumer = @GIDNumer2 
					and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0)

				begin
				
					 --skasuj wszystkie dekrety ksiegowane w oparciu o rozliczenia
					DELETE FROM a
					FROM @Nierozliczone a 
					WHERE a.Numer = 2 AND 
						exists (select PDT_GIDNumer from cdn.Predekrety 
							where PDT_GIDTyp = @GIDTyp2 and PDT_GIDNumer = @GIDNumer2 
							and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0
							and isnull(PDT_DelNumer,0) = a.GIDNumer and isnull(PDT_DelLp,0) = a.GIDLp )
				end
			end
		end		
		else if @Cnt2 = 0
		begin			
			ROLLBACK TRAN
			RAISERROR('200:Nie można dokonać rozrachunku wyceny. Zapis %s nie jest poprawnie zaksięgowany na konto rejestru', 16, 1, @Dokument2) 
			RETURN 301
		end			
	end
	else
	begin
		--normalny rozrachunek
	
		if @GIDTyp1 = 784
		begin
			if exists(select PDT_GIDNumer from cdn.Predekrety 
					where PDT_GIDTyp = @GIDTyp1 and PDT_GIDNumer = @GIDNumer1 
					and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0)

			begin
				if not (@WolaneZRozrachunku &lt;&gt; 0 and @TylkoRozrachunek &lt;&gt; 0)
				begin
					 --skasuj wszystkie dekrety ksiegowane w oparciu o rozliczenia
					DELETE FROM a
					FROM @Nierozliczone a 
					WHERE a.Numer = 1 AND 
						exists (select PDT_GIDNumer from cdn.Predekrety 
							where PDT_GIDTyp = @GIDTyp1 and PDT_GIDNumer = @GIDNumer1 
							and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0
							and isnull(PDT_DelNumer,0) = a.GIDNumer and isnull(PDT_DelLp,0) = a.GIDLp )
				end
				else	
				begin
					-- tylko rozrachunek, jesli na takim dekrecie po obydwu stronach sa konta rozrachunkowe to go zostaw				
					DELETE FROM b
					FROM @Nierozliczone b
						join (
							select a.Numer, a.GIDNumer, a.GIDLp
							FROM @Nierozliczone a 
							WHERE a.Numer = 1 AND 
								exists (select PDT_GIDNumer from cdn.Predekrety 
									where PDT_GIDTyp = @GIDTyp1 and PDT_GIDNumer = @GIDNumer1 
									and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0
									and isnull(PDT_DelNumer,0) = a.GIDNumer and isnull(PDT_DelLp,0) = a.GIDLp )
							Group by a.Numer, a.GIDNumer, a.GIDLp
							having count(a.GIDNumer) = 1
							) c on b.GIDNumer = c.GIDNumer and b.GIDLp = c.GIDLp and b.Numer = c.Numer
				end
			end			
		end
		

		
		if @GIDTyp2 = 784
		begin
			if exists(select PDT_GIDNumer from cdn.Predekrety 
					where PDT_GIDTyp = @GIDTyp2 and PDT_GIDNumer = @GIDNumer2 
					and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0)

			begin 
				if not (@WolaneZRozrachunku &lt;&gt; 0 and @TylkoRozrachunek &lt;&gt; 0)
				begin
					--skasuj wszystkie dekrety ksiegowane w oparciu o rozliczenia
					DELETE FROM a
					FROM @Nierozliczone a 
					WHERE a.Numer = 2 AND 
						exists (select PDT_GIDNumer from cdn.Predekrety 
							where PDT_GIDTyp = @GIDTyp2 and PDT_GIDNumer = @GIDNumer2 
							and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0
							and isnull(PDT_DelNumer,0) = a.GIDNumer and isnull(PDT_DelLp,0) = a.GIDLp )
				end
				else
				begin
					-- tylko rozrachunek, jesli na takim dekrecie po obydwu stronach sa konta rozrachunkowe to go zostaw				
					DELETE FROM b
					FROM @Nierozliczone b
						join (
							select a.Numer, a.GIDNumer, a.GIDLp
							FROM @Nierozliczone a 
							WHERE a.Numer = 2 AND 
								exists (select PDT_GIDNumer from cdn.Predekrety 
									where PDT_GIDTyp = @GIDTyp2 and PDT_GIDNumer = @GIDNumer2 
									and isnull(PDT_ZroTyp,0) = 433 and isnull(PDT_ZroNumer,0) &lt;&gt; 0
									and isnull(PDT_DelNumer,0) = a.GIDNumer and isnull(PDT_DelLp,0) = a.GIDLp )
							Group by a.Numer, a.GIDNumer, a.GIDLp
							having count(a.GIDNumer) = 1
							) c on b.GIDNumer = c.GIDNumer and b.GIDLp = c.GIDLp and b.Numer = c.Numer
				end
			end
		end



		set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
		set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)


		
		if @StronaKW &lt;&gt; 1 --nie jest to KW z rozymi kursami w przypadku zwyklego rozliczenia
		begin
			if @Cnt1 &gt; 0 
			begin
				set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Rozliczony = 1 and Numer = 1),0)			
			
				IF isnull(@Cnt1,0) &lt;&gt; 0 --sa jakies rozrachowane na konta zwykle rozrachunkowe 
				begin

					--update @Nierozliczone set
					--	MaRozliczenie = 
					--	case when exists(select b.R2_ID from 
					--		(select R2_ParID from cdn.Rozliczenia where R2_Dekret1Numer = GIDNumer and R2_Dekret1Lp = GIDLp and R2_Dekret1DC = DC and R2_Wycena = 0
					--		union all
					--		select R2_ParID from cdn.Rozliczenia where R2_Dekret2Numer = GIDNumer and R2_Dekret2Lp = GIDLp and R2_Dekret2DC = DC and R2_Wycena = 0) a
					--		join cdn.Rozliczenia b on a.R2_ParID = b.R2_ParID and b.R2_Dok1Typ &lt;&gt; 0 and b.R2_Dok2Typ &lt;&gt; 0 and b.R2_Wycena = 0)
					--	then 1 else 0 end			
					--where Numer = 1 and Rozliczony &lt;&gt; 0 
			

					
					set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Rozliczony = 1 and Numer = 1 and isnull(MaRozliczenie,0) = 1),0)			
									
						
			
					if isnull(@Cnt1,0) &gt; 1 --dla ktorejs z platnosci rozrachowano wiecej niz jeden dekret
					BEGIN
						set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 1)
						ROLLBACK TRAN
						RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Na dekrecie płatności dokumentu (%s) dokonano już rozrachunku na więcej niż jednym koncie', 16, 1, @szMsg1) 
						RETURN 301
					END
					ELSE
					BEGIN
						if @Rozliczony1 = 2 or @Rozliczony2 = 2
						begin -- ma byc bez rozliczenia
			
							DELETE FROM @Nierozliczone 
							WHERE Numer = 1 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) &lt;&gt; 0

						end
						else
						begin --ma byc z rozliczeniem

							if isnull(@Cnt1,0) = 1
							begin --jest jeden rozrachunek z rozliczeniem

								--pobierz dekret rozrachowany z roliczeniem
								SELECT @Dekret1Numer = GIDNumer , @Dekret1Lp = GIDLp, @Dekret1DC = DC
								FROM @Nierozliczone 
								WHERE Numer = 1 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) = 1
								

								if @WolaneZRozrachunku &lt;&gt; 0 
								begin				
									if not (@Dekret1Numer = @D1Numer and @Dekret1Lp = @D1Lp and (@D1DC &lt;&gt; 0 and @Dekret1DC = @D1DC or @D1DC = 0))
									begin --wskazany dekret nie jest dekretem na ktorym jest rozliczenie
										set @TylkoRozrachunek = 1
									end
									else
									begin --jest tym samym
										if @KwotaWal = 0 AND @KwotaSys = 0 --jesli platnosci sa juz rozliczone
										begin
											goto lExit
										end
									end
								end
								else
								begin
									DELETE FROM @Nierozliczone 
									WHERE Numer = 1 and not (@Dekret1Numer = GIDNumer and @Dekret1Lp = GIDLp and @Dekret1DC = DC)
						
						
									SELECT @Cnt1 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1
									if @Cnt1 &gt; 1 
									BEGIN --nie powinno sie zdarzyc
										ROLLBACK TRAN
										RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych dokumentu %s (3)', 16, 1, @Dokument1) 
										RETURN 301
									END
								end
							end
							else
							begin -- nie ma wogole rozrachowanych z rozliczeniem

								DELETE FROM @Nierozliczone 
								WHERE Numer = 1 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) = 0
								
								set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)			
								if @Cnt1 = 0 
								BEGIN 
									ROLLBACK TRAN
									RAISERROR('200:Dla dokumentu %s brak dekretów nierozrachowanych lub rozrachowanych wraz z rozliczeniem', 16, 1,@Dokument1) 
									RETURN 301
								END
								
								if @GIDTyp1 = 784
								begin
									DELETE FROM @Nierozliczone 
									WHERE Numer = 1 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) = 2
									
									
									set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)			
									if @Cnt1 = 0 
									BEGIN 																		
										ROLLBACK TRAN
										if @WolaneZRozrachunku &lt;&gt; 0
											RAISERROR('200:Operacja anulowana. Wskazany dekret zapisu %s jest już rozrachowany z rozliczeniem wyceny', 16, 1, @Dokument1) 
										else
											RAISERROR('200:Operacja anulowana. Dekrety zapisu %s są już rozrachowane bez rozliczenia', 16, 1, @Dokument1) 
											
										RETURN 301
									END	
								end
							end
						end
							
					END
				end	
			end
			else
			begin		
				if not (@GIDTyp1 = 784 and @KAZLokata1 = 1)
				begin
					ROLLBACK TRAN
					if @GidTyp1 = 784				
						RAISERROR('200:Dla danego zapisu kasowo bankowego %s brak dekretów możliwych do rozrachowania', 16, 1, @Dokument1) 
					else
						RAISERROR('200:Dla danej płatności dokumentu %s brak dekretów nierozrachowanych lub rozrachowanych wraz z rozliczeniem', 16, 1, @Dokument1) 

					RETURN 301
				end
				else 
					goto lDoRozliczenia
					
			end
		end
		else
		begin
			--jest to KW z roznymi kursami 
			--normalne rozliczenie badz sam rozrachunek
			if @Cnt1 = 0
			begin
				if not (@GIDTyp1 = 784 and @KAZLokata1 = 1)
				begin
					set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 1)
					ROLLBACK TRAN
					RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Dla zapisu rozchodowego %s brak dekretu z kontem rozrachunkowym ', 16, 1, @szMsg1) 
					RETURN 301
				end
				else 
					goto lDoRozliczenia
			end

			if @TylkoRozrachunek = 0
			begin
				DELETE FROM @Nierozliczone 
				WHERE Numer = 1 and WycenaParID &lt;&gt; @WycenaParID

				set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
				if @Cnt1 = 0
				begin
					set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 1)
					ROLLBACK TRAN
					RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Dla zapisu rozchodowego %s brak dekretu wynikającego z wyceny. Odksięguj zapis %s i zaksięguj ponownie', 16, 1, @szMsg1, @szMsg1) 
					RETURN 301
				end
			end



			if @WolaneZRozrachunku &lt;&gt; 0
			begin
				DELETE FROM @Nierozliczone 
				WHERE Numer = 1 
				and not (GIDNumer = @D1Numer and GIDLp = @D1Lp and (@D1DC &lt;&gt; 0 and DC = @D1DC or @D1DC = 0))

				set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
				if @Cnt1 = 0 --nie powinno sie zdarzyc
				begin
					set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 1)
					ROLLBACK TRAN
					if @TylkoRozrachunek = 0
						RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Wskazany dekret zapisu KB %s nie jest związany ze podanym kursem ', 16, 1, @szMsg1) 
					else
						RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Wskazany dekret zapisu KB %s nie istnieje (1) ', 16, 1, @szMsg1) 
					RETURN 301
				end	
			end
			


			set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone 
			WHERE Numer = 1 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) &lt;&gt; 0),0)


			if @Rozliczony1 = 2 or @Rozliczony2 = 2
			begin -- ma byc bez rozliczenia tylko dla WykonujZrozrachunku
				if @Cnt1 = 1 -- ten jedyny jest juz rzrachowany z rozliczeniem
				begin
					set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 1)
					ROLLBACK TRAN
					RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Wskazany dekret zapisu %s jest już rozrachowany wraz z rozliczeniem', 16, 1, @szMsg1)
					RETURN 301
				end
			end
			else
			begin
				--ma byc z rozliczeniem
				DELETE FROM @Nierozliczone 
				WHERE Numer = 1 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) = 0


				set @Cnt1 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1),0)
				if @Cnt1 = 0 -- 
				begin
					set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 1)
					ROLLBACK TRAN
					RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Dla zapisu rozchodowego %s nie ma dekretu wynikającego z wyceny nierozrachowanego lub rozrachowanego wraz z rozliczeniem ', 16, 1, @szMsg1)
					RETURN 301
				end

			end
		end

		if @StronaKW &lt;&gt; 2
		begin
			if @Cnt2 &gt; 0 
			begin
			
				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Rozliczony = 1 and Numer = 2),0)

			
				IF isnull(@Cnt2,0) &lt;&gt; 0 --sa jakies rozrachowane na konta zwykle rozrachunkowe
				begin
					--update @Nierozliczone set
					--	MaRozliczenie = 
					--	case when exists(select b.R2_ID from 
					--		(select R2_ParID from cdn.Rozliczenia where R2_Dekret1Numer = GIDNumer and R2_Dekret1Lp = GIDLp and R2_Dekret1DC = DC and R2_Wycena = 0
					--		union all
					--		select R2_ParID from cdn.Rozliczenia where R2_Dekret2Numer = GIDNumer and R2_Dekret2Lp = GIDLp and R2_Dekret2DC = DC and R2_Wycena = 0) a
					--		join cdn.Rozliczenia b on a.R2_ParID = b.R2_ParID and R2_Dok1Typ &lt;&gt; 0 and R2_Dok2Typ &lt;&gt; 0 and b.R2_Wycena = 0)
					--	then 1 else 0 end			
					--where Numer = 2 and Rozliczony &lt;&gt; 0
			
					set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Rozliczony = 1 and Numer = 2 and isnull(MaRozliczenie,0) = 1),0)
					
			
					if isnull(@Cnt2,0) &gt; 1 --dla ktorejs z platnosci rozrachowano wiecej niz jeden dekret
					BEGIN
						set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 2)
						ROLLBACK TRAN
						RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Na dekrecie płatności dokumentu (%s) dokonano już rozrachunku na więcej niż jednym koncie', 16, 1, @szMsg1) 
						RETURN 301
					END
					ELSE
					BEGIN

						if @Rozliczony1 = 2 or @Rozliczony2 = 2
						begin -- ma byc bez rozliczenia
							DELETE FROM @Nierozliczone 
							WHERE Numer = 2 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) &lt;&gt; 0
						end
						else
						begin --ma byc z rozliczeniem
							if isnull(@Cnt2,0) = 1
							begin --jest jeden rozrachunek z rozliczeniem

								SELECT @Dekret2Numer = GIDNumer , @Dekret2Lp = GIDLp, @Dekret2DC = DC
								FROM @Nierozliczone 
								WHERE Numer = 2 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) = 1

					
								if @WolaneZRozrachunku &lt;&gt; 0 
								begin				
									if not (@Dekret2Numer = @D2Numer and @Dekret2Lp = @D2Lp and (@D2DC &lt;&gt; 0 and @Dekret2DC = @D2DC or @D2DC = 0))
									begin --wskazany dekret nie jest dekretem na ktorym jest rozliczenie
										set @TylkoRozrachunek = 1
									end
									else
									begin --jest tym samym
										if @KwotaWal = 0 AND @KwotaSys = 0 --jesli platnosci sa juz rozliczone
										begin
											goto lExit
										end
									end
								end
								else
								begin
									DELETE FROM @Nierozliczone 
									WHERE Numer = 2 and not (@Dekret2Numer = GIDNumer and @Dekret2Lp = GIDLp and @Dekret2DC = DC)
						
						
									set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Rozliczony = 1 and Numer = 2),0)
									if @Cnt2 &gt; 1 
									BEGIN --nie powinno sie zdarzyc
										ROLLBACK TRAN
										RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych dokumentu %s (4)', 16, 1,@Dokument2) 
										RETURN 301
									END
								end
							end
							else
							begin -- nie ma wogole rozrachowanych z rozliczeniem
								DELETE FROM @Nierozliczone 
								WHERE Numer = 2 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) = 0

								set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
								if @Cnt2 = 0 
								BEGIN 
									ROLLBACK TRAN
									RAISERROR('200:Dla dokumentu %s brak dekretów nierozrachowanych lub rozrachowanych wraz z rozliczeniem', 16, 1,@Dokument2) 
									RETURN 301
								END
								
								if @GIDTyp2 = 784
								begin
									DELETE FROM @Nierozliczone 
									WHERE Numer = 2 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) = 2
									
									set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)			
									if @Cnt2 = 0 
									BEGIN 
										ROLLBACK TRAN
										if @WolaneZRozrachunku &lt;&gt; 0
											RAISERROR('200:Operacja anulowana. Wskazany dekret zapisu %s jest już rozrachowany z rozliczeniem wyceny', 16, 1, @Dokument2) 
										else
											RAISERROR('200:Operacja anulowana. Dekrety zapisu %s są już rozrachowane bez rozliczenia', 16, 1, @Dokument2) 
											
										RETURN 301
									END	
								end
							end
						end
							
					END
				end
			end
			else
			begin
				if not (@GIDTyp2 = 784 and @KAZLokata2 = 1)		
				begin
					ROLLBACK TRAN
					if @GidTyp2 = 784
						RAISERROR('200:Dla danego zapisu kasowo bankowego %s brak dekretów możliwych do rozrachowania', 16, 1, @Dokument2) 
					else
						RAISERROR('200:Dla danej płatności dokumentu %s brak dekretów nierozrachowanych lub rozrachowanych wraz z rozliczeniem', 16, 1, @Dokument2) 

					RETURN 301
				end			
				else 
					goto lDoRozliczenia
			end
		end
		else
		begin
			--jest to KW z roznymi kursami 
			--normalne rozliczenie badz sam rozrachunek		
			if @Cnt2 = 0
			begin
				if not (@GIDTyp2 = 784 and @KAZLokata2 = 1)
				begin
					set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 2)
					ROLLBACK TRAN
					RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Dla zapisu rozchodowego %s brak dekretu z kontem rozrachunkowym ', 16, 1, @szMsg1) 
					RETURN 301
				end
				else 
					goto lDoRozliczenia
			end

			if @TylkoRozrachunek = 0
			begin
				DELETE FROM @Nierozliczone 
				WHERE Numer = 2 and WycenaParID &lt;&gt; @WycenaParID

				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
				if @Cnt2 = 0
				begin
					set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 2)
					ROLLBACK TRAN
					RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Dla zapisu rozchodowego %s brak dekretu wynikającego z wyceny. Odksięguj zapis %s i zaksięguj ponownie', 16, 1, @szMsg1, @szMsg1) 
					RETURN 301
				end
			end


			if @WolaneZRozrachunku &lt;&gt; 0
			begin
				DELETE FROM @Nierozliczone 
				WHERE Numer = 2
				and not (GIDNumer = @D2Numer and GIDLp = @D2Lp and (@D2DC &lt;&gt; 0 and DC = @D2DC or @D2DC = 0))

				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
				if @Cnt2 = 0 --nie powinno sie zdarzyc
				begin
					set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 2)
					ROLLBACK TRAN
					if @TylkoRozrachunek = 0
						RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Wskazany dekret zapisu KB %s nie jest związany ze podanym kursem ', 16, 1, @szMsg1) 
					else
						RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Wskazany dekret zapisu KB %s nie istnieje (2) ', 16, 1, @szMsg1) 
					RETURN 301
				end	
			end
			

			set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone 
			WHERE Numer = 2 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) &lt;&gt; 0),0)
													


			if @Rozliczony1 = 2 or @Rozliczony2 = 2
			begin -- ma byc bez rozliczenia tylko dla WykonujZrozrachunku
				if @Cnt2 = 1 -- ten jedyny jest juz rzrachowany z rozliczeniem
				begin
					set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 2)
					ROLLBACK TRAN
					RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Wskazany dekret zapisu %s jest już rozrachowany wraz z rozliczeniem', 16, 1, @szMsg1)
					RETURN 301
				end
			end
			else
			begin
				--ma byc z rozliczeniem
				DELETE FROM @Nierozliczone 
				WHERE Numer = 2 and Rozliczony &lt;&gt; 0 and isnull(MaRozliczenie,0) = 0


				set @Cnt2 = isnull((SELECT COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2),0)
				if @Cnt2 = 0 -- 
				begin
					set @szMsg1 = (select max(rtrim(Dokument)) from @Nierozliczone where Numer = 2)
					ROLLBACK TRAN
					RAISERROR('200:Niemożliwe ustalenie kont rozrachunkowych. Dla zapisu rozchodowego %s nie ma dekretu wynikającego z wyceny nierozrachowanego lub rozrachowanego wraz z rozliczeniem ', 16, 1, @szMsg1)
					RETURN 301
				end

			end
		end
		

		if @WolaneZRozrachunku &lt;&gt; 0
		begin
			--zostaw tylko wskazane dekrety
			DELETE FROM @Nierozliczone 
			WHERE Numer = 1 and not (GIDNumer = @D1Numer and GIDLp = @D1Lp and (@D1DC &lt;&gt; 0 and DC = @D1DC or @D1DC = 0))

			DELETE FROM @Nierozliczone 
			WHERE Numer = 2 and not (GIDNumer = @D2Numer and GIDLp = @D2Lp and (@D2DC &lt;&gt; 0 and DC = @D2DC or @D2DC = 0))	
		end
		else
		begin
			--jesli zapis KB to usun konto rejestru
			if @GIDTyp1 = 784
			begin
				SELECT @Cnt1 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1;

				if @Cnt1 &gt; 1
				begin --usun konta rejestru
					DELETE a
					FROM @Nierozliczone a
					WHERE a.Numer = 1 and
						exists ( select KAR_GIDNumer
							from cdn.Rejestry
							where a.Konto = KAR_KontoKasy 
							union all
							select KAR_GIDNumer
							from cdn.Rejestry
							where a.KontoWal = KAR_KontoKasy and a.KontoWal &lt;&gt; ''
							)
				end
			end		
		end	
	end --koniec normalny rozrachunek


	SELECT @Cnt1 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1;
	SELECT @Cnt2 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2;



	IF @Cnt1 = 1 AND @Cnt2 = 2
		DELETE FROM a FROM @Nierozliczone a WHERE a.Numer = 2 AND EXISTS(SELECT * FROM @Nierozliczone b WHERE b.Numer = 1 AND b.Znak = a.Znak)
	ELSE IF @Cnt1 = 2 AND @Cnt2 = 1
	  	DELETE FROM a FROM @Nierozliczone a WHERE a.Numer = 1 AND EXISTS(SELECT * FROM @Nierozliczone b WHERE b.Numer = 2 AND b.Znak = a.Znak)



	SELECT @Cnt1 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1;
	SELECT @Cnt2 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2;



  	IF @Cnt1 &lt;&gt; 1 OR @Cnt2 &lt;&gt; 1
  	BEGIN
		IF @Cnt1 &lt;&gt; 1
  			DELETE FROM a FROM @Nierozliczone a JOIN @Nierozliczone b ON a.Numer=b.Numer AND (a.GIDNumer&lt;&gt;b.GIDNumer OR a.GIDLp&lt;&gt;b.GIDLp OR a.DC&lt;&gt;b.DC)
    		WHERE a.Numer = 1 AND a.KwotaSys = 0 AND b.KwotaSys &lt;&gt; 0;


		SELECT @Cnt2 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2;
		IF @Cnt2 &lt;&gt; 1
			DELETE FROM a FROM @Nierozliczone a JOIN @Nierozliczone b ON a.Numer=b.Numer AND (a.GIDNumer&lt;&gt;b.GIDNumer OR a.GIDLp&lt;&gt;b.GIDLp OR a.DC&lt;&gt;b.DC)
			WHERE a.Numer = 2 AND a.KwotaSys = 0 AND b.KwotaSys &lt;&gt; 0;


		SELECT @Cnt1 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1;
		SELECT @Cnt2 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2;
		IF @Cnt1 &lt;&gt; 1 OR @Cnt2 &lt;&gt; 1
		BEGIN
			DELETE FROM a FROM @Nierozliczone a 
			WHERE NOT EXISTS(SELECT * 
					FROM @Nierozliczone b 
						left join cdn.KontaNastLinki c
							on b.KontoNumer = c.KLI_NastNumer and a.KontoNumer = c.KLI_PoprzNumer
						left join cdn.KontaNastLinki d
							on a.KontoNumer = d.KLI_NastNumer and b.KontoNumer = d.KLI_PoprzNumer
					WHERE b.Numer = 3-a.Numer AND b.Znak = 3-a.Znak AND not (c.KLI_NastNumer is null and d.KLI_NastNumer is null))


			SELECT @Cnt1 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 1;
			SELECT @Cnt2 = COUNT(Znak) FROM @Nierozliczone WHERE Numer = 2;



			IF @Cnt1 &lt;&gt; 1 OR @Cnt2 &lt;&gt; 1
			BEGIN
				ROLLBACK TRAN
				RAISERROR('300:Niemożliwe ustalenie kont rozrachunkowych (5)', 16, 1) 
				RETURN 300
			END
		END
	END

----------------- koniec kojarzenia
	set @JestRozrachunek = 1
	

	SELECT 	
		@Dekret1Numer = GIDNumer, 
		@Dekret1Lp = GIDLp, 
		@KwotaDTWal1 = KwotaWal, 
		@KwotaDTSys1 = KwotaSys, 
		@DataRoz1 = Data, 
		@Waluta1 = Waluta,
		@KursDTL1 = KursL,
		@KursDTM1 = KursM,
		@Dekret1DC = DC, 
		@Konto1 = Konto, 
		@Konto1Numer = KontoNumer, 
		@Konto1TypPozabil = KontoTypPozabil,
		@Znak1 = Znak, 
--		@Dokument1 = Dokument,
		@KontoWal1 = KontoWal, 
		@KontoWal1Numer = KontoWalNumer
	FROM @Nierozliczone WHERE Numer = 1



	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('200:Błąd pobrania wiersza do rozrachunku', 16, 1) 
	  RETURN 200
	END


	set @SavDekret1Numer = @Dekret1Numer
	set @SavDekret1Lp = @Dekret1Lp
	set @SavDekret1DC = @Dekret1DC



	SELECT 
		@Dekret2Numer = GIDNumer, 
		@Dekret2Lp = GIDLp, 
		@KwotaDTWal2 = KwotaWal, 
		@KwotaDTSys2 = KwotaSys, 
		@DataRoz2 = Data, 
		@Waluta2 = Waluta, 
		@KursDTL2 = KursL,
		@KursDTM2 = KursM,
		@Dekret2DC = DC, 
		@Konto2 = Konto, 
		@Konto2Numer = KontoNumer, 
		@Konto2TypPozabil = KontoTypPozabil,
		@Znak2 = Znak, 
--		@Dokument2 = Dokument,
		@KontoWal2 = KontoWal, 
		@KontoWal2Numer = KontoWalNumer
	FROM @Nierozliczone WHERE Numer = 2


	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('200:Błąd pobrania wiersza do rozrachunku', 16, 1) 
	  RETURN 200
	END



	-- sprawdzenie waluty
	IF @Waluta1 &lt;&gt; @Waluta2 --AND @Waluta1 &lt;&gt; @WalutaSys AND @Waluta2 &lt;&gt; @WalutaSys
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('101:Niezgodne waluty rozrachunku.', 16, 1) 
	  RETURN 101
	END


	IF @Znak1 = @Znak2 
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('102:Zapisy księgowe wynikające z księgowania dokumentów mają konta rozrachunkowe po tej samej stronie. Rozrachunek niemożliwy.', 16, 1) 
	  RETURN 102
	END

	IF @Konto1TypPozabil&lt;&gt;@Konto2TypPozabil
	BEGIN
		ROLLBACK TRAN
		RAISERROR('102:Nie można dokonywać rozrachunku na kontach o różnych typach - bilansowe, pozabilansowe', 16, 1) 
		RETURN 102
	END


	IF @TylkoRozrachunek &lt;&gt; 0
	BEGIN
		SET @GIDTyp1 = NULL
    	SET @GIDNumer1 = NULL
    	SET @GIDLp1 = NULL
    	SET @GIDTyp2 = NULL
    	SET @GIDNumer2 = NULL
    	SET @GIDLp2 = NULL

		--nie bierz pod uwage kwot z dokumentow do okreslania wielkosci rozliczenia
		set @KwotaTRWal1 = null
		set @KwotaTRSys1 = null

		set @KwotaTRWal2 = null
		set @KwotaTRSys2 = null
	END  


	set @KwotaRozWal = @KwotaWal
	set @KwotaRozSys = @KwotaSys


	exec cdn.UstalKwoteRozliczenia
				@Waluta1,
				@KwotaTRWal1,
				@KwotaTRSys1,
				@KwotaDTWal1,
				@KwotaDTSys1,						
				@Waluta2,
				@KwotaTRWal2,
				@KwotaTRSys2,
				@KwotaDTWal2,
				@KwotaDTSys2,						
				@WalutaSys,
				@Kwota,
				0,
				@poz_DecKwota,
				0,
				0,				
				@Kurs1 output,
				@Kurs2 output,
				@KwotaWal output,
				@KwotaSys output,
				@RozliczenieCalkowite output,
				@RoznicaKursowa output,
				@StronaRk output,
				@BZ output,
				@KwotaRozSys1 output,
				@KwotaRozSys2 output,
				@StronaRozl output

	
	
	if @StronaRk = 2
	begin
		set @KursDTL = @KursDTL1
		set @KursDTM = @KursDTM1
	end
	else
	begin
		set @KursDTL = @KursDTL2
		set @KursDTM = @KursDTM2
	end
	

	IF @KwotaRozWal = @KwotaWal and @KwotaRozSys &lt;&gt; @KwotaSys
	BEGIN
		ROLLBACK TRAN
		RAISERROR('111:Operacja anulowana. Kurs na dokumencie źródłowym jest różny od kursu na dekrecie księgowym dokumentu ', 16, 1) 
		RETURN 111
	END


	
	IF @KwotaWal = 0 AND @KwotaSys = 0 
		IF @WolaneZRozrachunku = 0
		BEGIN
			ROLLBACK TRAN
			RAISERROR('203:Jeden z dokumentów (lub oba dokumenty) został całkowicie rozliczony.', 16, 1) 
			RETURN 203
		END
		ELSE
		BEGIN

			goto lExit
		END





	--ustal date rozrachunku
	if @DataRoz1 &lt; @DataRoz2
		set @DataRozrachunku = @DataRoz2
	else
		set @DataRozrachunku = @DataRoz1



---------- dekret kompensacyjny ------------
	SELECT @DataDzisiejszaKomp = ISNULL(KON_Wartosc,0) FROM CDN.Konfig with(nolock) WHERE KON_Numer = 2058



	IF @DataDzisiejszaKomp = 2
		IF @Termin1 &lt; @Termin2
			SET @DataKomp = @Termin2
		ELSE
			SET @DataKomp = @Termin1
	ELSE
		IF @DataRoz1 &lt; @DataRoz2
			SET @DataKomp = @DataRoz2
		ELSE
			SET @DataKomp = @DataRoz1




  	IF @DataDzisiejszaKomp = 1 and @DataKomp &lt; @DataDzisiejsza
    		SET @DataKomp = @DataDzisiejsza  

	

	if @DataKomp &lt; @DataRozliczenia 
		SET @DataKomp = @DataRozliczenia
  	
    		

	if @DataKomp &lt; @DataRozrachunku 
		SET @DataKomp = @DataRozrachunku



	set @OldKonto1Numer = @Konto1Numer
	set @OldKonto2Numer = @Konto2Numer
	set @OldKonto1 = @Konto1
	set @OldKonto2 = @Konto2
	set @OldKontoWal1Numer = @KontoWal1Numer
	set @OldKontoWal2Numer = @KontoWal2Numer
	set @OldKontoWal1 = @KontoWal1
	set @OldKontoWal2 = @KontoWal2



  	EXEC @KontaNieTozsame = CDN.PorownajKonta @DataRozrachunku, @Konto1Numer OUTPUT, @Konto1 OUTPUT, @Konto2Numer OUTPUT, @Konto2 OUTPUT, @KontoWal1Numer OUTPUT, @KontoWal1 OUTPUT, @KontoWal2Numer OUTPUT, @KontoWal2 OUTPUT


	if @KontaNieTozsame = -1
	begin
		ROLLBACK TRAN
		RAISERROR('102:Błąd sprawdzania tożsamości kont. Błędne parametry procedury cdn.PorownajKonta ', 16, 1) 
		RETURN 102			
	end
	else if @KontaNieTozsame = 2
	begin
		ROLLBACK TRAN
		RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe rozrachowywanych dekretów są ze sobą tożsame, pozabilansowe nie', 16, 1) 
		RETURN 102			
	end
	else if @KontaNieTozsame = 3
	begin
		ROLLBACK TRAN
		RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe i pozabilansowe jednego z rozrachowywanych dekretów nie są z tego samego okresu ', 16, 1) 
		RETURN 102			
	end
	else if @KontaNieTozsame = 4
	begin
		ROLLBACK TRAN
		RAISERROR('102:Błąd sprawdzania tożsamości kont. W okresie, w którym dokonywany jest rozrachunek nie istnieje konto tożsame do konta rozrachowywanego dekretu ', 16, 1) 
		RETURN 102			
	end
	else if @KontaNieTozsame = 5
	begin
		ROLLBACK TRAN
		RAISERROR('102:Błąd sprawdzania tożsamości kont. Nie istnieje konto o podanym identyfikatorze ', 16, 1) 
		RETURN 102			
	end
	else if @KontaNieTozsame = 1
  	BEGIN

		SET @OpisKompensaty = 'Kompensata: ' + RTRIM( @Dokument1 ) + ' - ' + RTRIM( @Dokument2 )


		if @DataKomp &gt; @DataRozrachunku 
		begin
			SET @DataRozrachunku = @DataKomp

			set @Konto1Numer = @OldKonto1Numer
			set @Konto2Numer = @OldKonto2Numer
			set @Konto1 = @OldKonto1
			set @Konto2 = @OldKonto2
			set @KontoWal1Numer = @OldKontoWal1Numer
			set @KontoWal2Numer = @OldKontoWal2Numer
			set @KontoWal1 = @OldKontoWal1
			set @KontoWal2 = @OldKontoWal2



		  	EXEC @KontaNieTozsame = CDN.PorownajKonta @DataRozrachunku, @Konto1Numer OUTPUT, @Konto1 OUTPUT, @Konto2Numer OUTPUT, @Konto2 OUTPUT, @KontoWal1Numer OUTPUT, @KontoWal1 OUTPUT, @KontoWal2Numer OUTPUT, @KontoWal2 OUTPUT

			
			--tutaj powinny co najwyzej byc bledy 1, 4
			if @KontaNieTozsame = -1
			begin
				ROLLBACK TRAN
				RAISERROR('102:Błąd sprawdzania tożsamości kont. Błędne parametry procedury cdn.PorownajKonta ', 16, 1) 
				RETURN 102			
			end
			else if @KontaNieTozsame = 2
			begin
				ROLLBACK TRAN
				RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe rozrachowywanych dekretów są ze sobą tożsame, pozabilansowe nie', 16, 1) 
				RETURN 102			
			end
			else if @KontaNieTozsame = 3
			begin
				ROLLBACK TRAN
				RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe i pozabilansowe jednego z rozrachowywanych dekretów nie są z tego samego okresu ', 16, 1) 
				RETURN 102			
			end
			else if @KontaNieTozsame = 4
			begin
				ROLLBACK TRAN
				RAISERROR('102:Błąd sprawdzania tożsamości kont. W okresie, w którym dokonywany jest rozrachunek z dekretem kompensacyjnym nie istnieje konto tożsame do konta rozrachowywanego dekretu ', 16, 1) 
				RETURN 102			
			end
			else if @KontaNieTozsame = 5
			begin
				ROLLBACK TRAN
				RAISERROR('102:Błąd sprawdzania tożsamości kont. Nie istnieje konto o podanym identyfikatorze ', 16, 1) 
				RETURN 102			
			end			
		end



		IF @Znak1 = 1
		BEGIN
			EXEC CDN.DodajKompensate @GIDFirma, @DataRozrachunku, @UserID, @KwotaSys, @WalutaSys, 
			      @Konto2, @Konto2Numer, @Konto1, @Konto1Numer, 
			      @KwotaWal, @KontoWal2, @KontoWal2Numer, @Waluta2, 
			      @KwotaWal, @KontoWal1, @KontoWal1Numer, @Waluta1, @KursDTL, @KursDTM,
			      @OpisKompensaty, @KompGIDNumer OUTPUT, @DataDzisiejsza
		END
 		ELSE
		BEGIN
		 	EXEC CDN.DodajKompensate @GIDFirma, @DataRozrachunku, @UserID, @KwotaSys, @WalutaSys, 
			      @Konto1, @Konto1Numer, @Konto2, @Konto2Numer, 
			      @KwotaWal, @KontoWal1, @KontoWal1Numer, @Waluta1,
			      @KwotaWal, @KontoWal2, @KontoWal2Numer, @Waluta2, @KursDTL, @KursDTM,
			      @OpisKompensaty, @KompGIDNumer OUTPUT, @DataDzisiejsza
		END


		IF @@TRANCOUNT = 0
			RETURN 0



		INSERT INTO CDN.Rozliczenia(
		  R2_Dekret1Numer, R2_Dekret1Lp, R2_Dekret1DC, R2_Waluta1, R2_KwotaWal1, 
		  R2_Dekret2Numer, R2_Dekret2Lp, R2_Dekret2DC, R2_Waluta2, R2_KwotaWal2, 
		  R2_KwotaSys, R2_DataRozrachunku, R2_OpeNumerRZ, 
		  R2_GIDFirma, R2_Dekret1Dod, R2_Dekret2Dod, R2_RK, R2_RKStrona, 
		  R2_Wycena, 
		  R2_PozostajeZWyc, 
		  R2_PozostajeZWycSys, 
		  R2_WycenaParID)
		VALUES( 
		  @Dekret1Numer, @Dekret1Lp, @Dekret1DC, @Waluta1, @KwotaWal, 
		  @KompGIDNumer, 1, 3-@Znak1, @Waluta2, @KwotaWal, 
		  @KwotaSys, @DataRozrachunku, @UserID,
		  @GIDFirma, 0, 1, 0, 0, 
		  0, 
		  0,
		  0,
		  case when @Wycena&lt;&gt;0 then 0 else @WycenaParID end)


		IF @@ERROR &lt;&gt; 0
		BEGIN
			ROLLBACK TRAN
			RAISERROR('102:Błąd dodania rozrachunku z dekretem kompensacyjnym', 16, 1) 
			RETURN 102
		END



    	IF ISNULL(@ParID,0) = 0
      		SET @ParID = SCOPE_IDENTITY()


		
	    SET @Dekret1Numer = @KompGIDNumer
		SET @Dekret1Lp = 1
		SET @Dekret1DC = @Znak1	
		SET @Dod1 = 1		
	END

END


lDoRozliczenia:


IF @KwotaWal = 0 AND @KwotaSys = 0 AND @WolaneZRozrachunku = 0
BEGIN
  ROLLBACK TRAN
  RAISERROR('203:Jeden z dokumentów (lub oba dokumenty) został całkowicie rozliczony.', 16, 1) 
  RETURN 203
END





IF @KwotaWal &lt;&gt; 0 OR @KwotaSys &lt;&gt; 0
BEGIN

	-- dodanie rozliczenia
	INSERT INTO CDN.Rozliczenia(
	  R2_Dok1Typ, R2_Dok1Numer, R2_Dok1Lp, R2_Dekret1Numer, R2_Dekret1Lp, R2_Dekret1DC, R2_Waluta1, R2_KwotaWal1, 
	  R2_Dok2Typ, R2_Dok2Numer, R2_Dok2Lp, R2_Dekret2Numer, R2_Dekret2Lp, R2_Dekret2DC, R2_Waluta2, R2_KwotaWal2, 
	  R2_KwotaSys, R2_DataRozliczenia, 
	  R2_DataRozrachunku, 
	  R2_OpeNumerRL, R2_OpeNumerRZ, 
	  R2_ParID, 
	  R2_GIDFirma, R2_Dekret1Dod, R2_Dekret2Dod, R2_RK, R2_RKStrona, 
	  R2_Wycena, 
	  R2_PozostajeZWyc, 
	  R2_PozostajeZWycSys, 
	  R2_WycenaParID,
	  R2_WycenaWskazanie)
	VALUES( 
	  @GIDTyp1, @GIDNumer1, @GIDLp1, @Dekret1Numer, @Dekret1Lp, @Dekret1DC, @Waluta1, @KwotaWal, 
	  @GIDTyp2, @GIDNumer2, @GIDLp2, @Dekret2Numer, @Dekret2Lp, @Dekret2DC, @Waluta2, @KwotaWal, 
	  @KwotaSys, @DataRozliczenia, 
	  @DataRozrachunku,
	  CASE WHEN ISNULL(@GIDNumer1,0)&lt;&gt;0 AND ISNULL(@GIDNumer2,0)&lt;&gt;0 THEN @UserID ELSE NULL END, 
	  CASE WHEN ISNULL(@Dekret1Numer,0)&lt;&gt;0 AND ISNULL(@Dekret2Numer,0)&lt;&gt;0 THEN @UserID ELSE NULL END,
	  @ParID,
	  @GIDFirma, @Dod1, @Dod2, @RoznicaKursowa, @StronaRK, 
	  case when @Wycena&lt;&gt;0 then 1 else 0 end, 
	  case when @Wycena&lt;&gt;0 and @DopasujKurs&lt;&gt;0 then @KwotaWal else 0 end,
	  case when @Wycena&lt;&gt;0 and @DopasujKurs&lt;&gt;0 then 
			case 
			when @ZnakTR1 = 1 and @StronaRK = 1 then @KwotaSys + @RoznicaKursowa 
			when @ZnakTR2 = 1 and @StronaRK = 2 then @KwotaSys + @RoznicaKursowa 
			else @KwotaSys end 
	  else 0 end,
	  case when @Wycena&lt;&gt;0 and @DopasujKurs&lt;&gt;0 then 0 else @WycenaParID end,
	  @WycenaWskazanie)



	IF @@ERROR &lt;&gt; 0
	BEGIN
	  ROLLBACK TRAN
	  RAISERROR('102:Błąd dodania rozliczenia', 16, 1) 
	  RETURN 102
	END


	IF ISNULL(@ParID,0) = 0
		SET @ParID = SCOPE_IDENTITY()



	set @R2ParID = @ParID


	if @WycenaParID &lt;&gt; 0
	begin
		update cdn.Rozliczenia set
			R2_PozostajeZWyc = R2_PozostajeZWyc - @KwotaWal,
			R2_PozostajeZWycSys = R2_PozostajeZWycSys - @KwotaSys - case when @StronaKW = @StronaRK then @RoznicaKursowa else 0 end
		where R2_ID = @WycenaParID
		

		select @err = @@Error, @Rcount = @@RowCount
		if @err&lt;&gt;0
		begin
			rollback tran
			raiserror('201:Błąd aktualizacji kwot wyceny w tabeli cdn.Rozliczenia',16,1)
			return 201
		end			

		if @RCount = 0
		begin	
			rollback tran
			raiserror('201:Operacja anulowana. Nie znaleziono rekordu wyceny w tabeli cdn.Rozliczenia ID:%d',16,1,@WycenaParID)
			return 201
		end
	end
END



SET @Dekret1Numer = @SavDekret1Numer
SET @Dekret1Lp = @SavDekret1Lp
SET @Dekret1DC = @SavDekret1DC
SET @Dod1 = 0



IF @RoznicaKursowa &lt;&gt; 0
BEGIN

	if @Wycena = 0
	begin
		SELECT @DataDzisiejszaRK = ISNULL(KON_Wartosc,0) FROM CDN.Konfig with(nolock) WHERE KON_Numer = 2057


		--data na dokumencie RK
		IF @DataDzisiejszaRK = 1
			if @DataDzisiejsza &lt; @DataRozliczenia 
				SET @DataRKN = @DataRozliczenia
			else
	    		SET @DataRKN = @DataDzisiejsza  		
  		ELSE
			SET @DataRKN = @DataRozliczenia
	end
	else
		SET @DataRKN = @DataRozliczenia
		
		


	--dodaj ksiegowanie roznicy kursowej
	IF @JestRozrachunek &lt;&gt; 0
	BEGIN

		--data na zapisie ksiegowym RK
		if @DataRKN &lt; @DataRozrachunku		
			set @DataRK = @DataRozrachunku
		else
			set @DataRK = @DataRKN

	

		-- obliczenie kont waluty do RK
		SELECT @OkresRK = OKR_ID FROM CDN.Okresy with(nolock) WHERE @DataRK BETWEEN OKR_Poczatek AND OKR_Koniec
	
	
		set @Konto1Numer = @OldKonto1Numer
		set @Konto2Numer = @OldKonto2Numer
		set @Konto1 = @OldKonto1
		set @Konto2 = @OldKonto2

	
		EXEC @KontaNieTozsame = CDN.PorownajKonta @DataRK, @Konto1Numer OUTPUT, @Konto1 OUTPUT, @Konto2Numer OUTPUT, @Konto2 OUTPUT 


		if @KontaNieTozsame = -1
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. Błędne parametry procedury cdn.PorownajKonta ', 16, 1) 
			RETURN 102			
		end
		else if @KontaNieTozsame = 2
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe rozrachowywanych dekretów są ze sobą tożsame, pozabilansowe nie', 16, 1) 
			RETURN 102			
		end
		else if @KontaNieTozsame = 3
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. Konta bilansowe i pozabilansowe jednego z rozrachowywanych dekretów nie są z tego samego okresu ', 16, 1) 
			RETURN 102			
		end
		else if @KontaNieTozsame = 4
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. W okresie, w którym dokonywany jest rozrachunek nie istnieje konto tożsame do konta rozrachowywanego dekretu ', 16, 1) 
			RETURN 102			
		end
		else if @KontaNieTozsame = 5
		begin
			ROLLBACK TRAN
			RAISERROR('102:Błąd sprawdzania tożsamości kont. Nie istnieje konto o podanym identyfikatorze ', 16, 1) 
			RETURN 102			
		end

	
	
		--zapis ksiegowy RK
		exec cdn.UstalKontaRK
				@Kurs1,
				@Kurs2,
				@Znak1,
				@Znak2,
				@StronaRK,
				@Dokument1,
				@Dokument2,
				@OkresRK,
				@Waluta1,
				@Konto1,
				@Konto1Numer,
				@Konto2,
				@Konto2Numer,
				@KontoDT output,
				@KontoDTNumer output,
				@KontoCT output,
				@KontoCTNumer output,
				@DekretRKDC output,
				@OpisRK output,
				@BZ 
	
	
	
		IF @KontoDTNumer IS NULL OR @KontoCTNumer IS NULL
		BEGIN
			ROLLBACK TRAN
		  	RAISERROR('Brak konta różnic kursowych waluty %s. Uzupełnij konto RK na formatce waluty.', 16, 1, @Waluta1 ) 
		  	RETURN 301
	  	END
	
		

	  	EXEC CDN.DodajRozniceKursowa @GIDFirma, @DataRK, @UserID, @RoznicaKursowa, @WalutaSys, 
	    		@KontoDT, @KontoDTNumer, @KontoCT, @KontoCTNumer, @OpisRK, @RKDekretNumer OUTPUT, @DataDzisiejsza, ''
	

	
	  	IF @@TRANCOUNT = 0
	   		RETURN 0


		
		SELECT @RKN_Dziennik = KON_Wartosc FROM CDN.Konfig WITH(NOLOCK) WHERE KON_Numer=2047;
	END
	else
	begin
		set @RKN_Dziennik = ''
	end



	--dodaj dokument roznicy kursowej
	if @DokumentRK &lt;&gt; 0
	begin

		declare @RKN_Status smallint
		declare @RKN_StatusID int
		declare @RKN_Znak smallint

		exec cdn.UstalStatusZnakRKN @GIDTyp1, @ZnakTR1, @GIDTyp2, @ZnakTR2, @StronaRK, @Wycena, @RKN_Status output, @RKN_StatusID output, @RKN_Znak output

		if isnull(@RKN_Status,0) = -1
		begin
			ROLLBACK Tran
			RaisError('500:Niemożliwe ustalenie statusu dokumentu Różnicy Kursowej lub brak definicji statusów w Słownikach kategorii',16,1)
			return(500)
		end
		if @Wycena = 1
		begin
			set @RKN_Status = 107
			set @RKN_StatusID = (select top 1 SLW_ID from cdn.Slowniki with(nolock) where SLW_Predefiniowany = @RKN_Status)
			if isnull(@RKN_StatusID,0) = 0
				set @RKN_Status = -1
		end




		declare @RKN_Seria varchar(5)		
		set @RKN_Seria = ''


		declare @RKN_Numer int
		set @RKN_Numer = isnull((select max(RKN_Numer) from cdn.RozniceKursowe with(nolock) where RKN_Rok = year(dateadd(dd, @DataRKN, '18001228')) and RKN_Seria = @RKN_Seria),0) + 1

		declare @RKNDok_Nieksiegowac tinyint
		set @RKNDok_Nieksiegowac = isnull((select Dok_Nieksiegowac from cdn.DokDefinicje where Dok_GIDTyp=435 and Dok_FrsID=1),0)

		insert into cdn.RozniceKursowe 
			( 
			RKN_Dok1Typ, RKN_Dok1Firma, RKN_Dok1Numer, RKN_Dok1Lp, RKN_Dok1KwotaSys,
			RKN_Dok2Typ, RKN_Dok2Firma, RKN_Dok2Numer, RKN_Dok2Lp, RKN_Dok2KwotaSys,
			RKN_Rok, RKN_Miesiac, RKN_Numer, RKN_Seria, RKN_DokumentObcy,
			RKN_DataWyst, RKN_DataRozl, 
			RKN_Kwota,RKN_KwotaRozl,RKN_Znak,RKN_Status,RKN_StatusID,RKN_Zaksiegowano,RKN_NieKsiegowac,
			RKN_Opis,
			RKN_Dziennik,
			RKN_DataKsiegowania,
			RKN_SchTyp,
			RKN_SchNumer,
			RKN_WsSCHTyp,RKN_WsSCHNumer,
			RKN_WsStosujSchemat,RKN_WsDziennik,RKN_WsStosujDziennik,
			RKN_OpeNumerM, RKN_OpeNumerW, RKN_BZ)


		VALUES(
			@GIDTyp1, @GIDFirma, @GIDNumer1, @GIDLp1, @KwotaRozSys1,
			@GIDTyp2, @GIDFirma, @GIDNumer2, @GIDLp2, @KwotaRozSys2,
			year(dateadd(dd, @DataRKN, '18001228')), 0, @RKN_Numer, @RKN_Seria, '',
			@DataRKN, @DataRKN,
			@RoznicaKursowa,@KwotaWal,@RKN_Znak,@RKN_Status,@RKN_StatusID,case when @RKDekretNumer &lt;&gt; 0 then 1 else 0 end,@RKNDok_Nieksiegowac,
			'',
			case when @DokumentRKAutomat &lt;&gt; 0 and @RKDekretNumer &lt;&gt; 0 then @RKN_Dziennik else '' end,
			@DataRK,
			case when @DokumentRKAutomat &lt;&gt; 0 and @RKDekretNumer &lt;&gt; 0 then 6339 else 0 end,
			case when @DokumentRKAutomat &lt;&gt; 0 and @RKDekretNumer &lt;&gt; 0 then 1 else 0 end,
			0,0,
			0,'','',
			@UserID, @UserID, @BZ)

	

		IF @@ERROR &lt;&gt; 0
		BEGIN
		  ROLLBACK TRAN
		  RAISERROR('401:Błąd zapisu dokumentu różnic kursowych', 16, 1) 
		  RETURN 401
		END
	

		set @RKN_ID = SCOPE_IDENTITY()	



		if @RKDekretNumer &lt;&gt; 0
		begin			
			declare @TS int
			set @TS = datediff(ss,'19900101',GETDATE())
	
			--dodaj zrodla
			INSERT INTO [CDN].[Zrodla]([ZRO_TRNTyp], [ZRO_TRNFirma], [ZRO_TRNNumer], [ZRO_TRNLp], [ZRO_DTTyp], [ZRO_DTFirma], [ZRO_DTNumer], [ZRO_DTLp], [ZRO_DataOddzialu], [ZRO_DataCentrali])
			VALUES(435, @GidFirma, @RKN_ID, 0, 432, @GIDFirma, @RKDekretNumer, 0, @TS, 0)



			--dodaj predekrety
			INSERT INTO [CDN].[Predekrety]([PDT_GIDTyp], [PDT_GIDFirma], [PDT_GIDNumer], [PDT_GIDLp], [PDT_Opis], [PDT_Kwota], [PDT_KwotaWal], [PDT_KontoDebet], [PDT_KontoCredit], [PDT_KontoDebetR], [PDT_KontoCreditR], [PDT_Wyrazenie], [PDT_KontoDebetDef], [PDT_KontoCreditDef], [PDT_Wykonuj], [PDT_Warunek], [PDT_ZROTyp], [PDT_ZROFirma], [PDT_ZRONumer], [PDT_ZROLp], [PDT_ZalozKontoDebet], [PDT_ZalozKontoCredit], [PDT_Waluta], [PDT_KursL], [PDT_KursM], [PDT_SymbolKontaDebet], [PDT_SymbolKontaCredit], [PDT_TypKwoty], [PDT_DELNumer], [PDT_DELLp], [PDT_DataWyst], [PDT_DataOper], [PDT_KontoDTNazwa], [PDT_KontoCTNazwa], [PDT_PdmTypDT], [PDT_PdmNumerDT], [PDT_PdmTypCT], [PDT_PdmNumerCT], [PDT_WycenaParID])
			VALUES(435, @GidFirma, @RKN_ID, 1, @OpisRK, @RoznicaKursowa, @RoznicaKursowa, @KontoDT, @KontoCT, '', '', 'Kwota', '', '', 1, '', 0, 0, 0, 0, 0, 0, @WalutaSys, 1, 1, 0, 0, -1, 0, 0, 0, 0, '', '', 0, 0, 0, 0, 0)


			--zaktualizuj opis dokumentu
			set @DataRKN_Rok = year(dateadd(dd, @DataRKN, '18001228'))
			update cdn.Dziennik set 
				DZK_DokumentZrodlowy = cdn.NumerDokumentu(435, 0, 0, @RKN_Numer, @DataRKN_Rok, @RKN_Seria, 0)
			where DZK_GIDNumer = @RKDekretNumer

			IF @@ERROR &lt;&gt; 0
			BEGIN
			  ROLLBACK TRAN
			  RAISERROR('401:Błąd zapisu do tabeli Dziennik', 16, 1) 
			  RETURN 401
			END

			
			update cdn.DziennikElem set 
				DEL_DokumentZrodlowy = cdn.NumerDokumentu(435, 0, 0, @RKN_Numer, @DataRKN_Rok, @RKN_Seria, 0)
			where DEL_GIDNumer = @RKDekretNumer

			IF @@ERROR &lt;&gt; 0
			BEGIN
			  ROLLBACK TRAN
			  RAISERROR('401:Błąd zapisu do tabeli DziennikElem', 16, 1) 
			  RETURN 401
			END


			if isnull((select KON_Wartosc FROM CDN.Konfig WITH(NOLOCK) WHERE KON_Numer=20103),0) &lt;&gt; 0
			begin
				if isnull((select KON_Wartosc FROM CDN.Konfig WITH(NOLOCK) WHERE KON_Numer=20104),0) = 0
				begin
					update cdn.Dziennik set 
						DZK_Identyfikator = cdn.NumerDokumentu(435, 0, 0, @RKN_Numer, @DataRKN_Rok, @RKN_Seria, 0)
					where DZK_GIDNumer = @RKDekretNumer

					IF @@ERROR &lt;&gt; 0
					BEGIN
					  ROLLBACK TRAN
					  RAISERROR('401:Błąd zapisu do tabeli Dziennik', 16, 1) 
					  RETURN 401
					END
				end
			end

		end

		set @tmpRKDokTyp = 435
		set @tmpRKDokNumer = @RKN_ID
		set @tmpRKDokLp = 0		
	END


	if @RKN_ID &lt;&gt; 0 or @RKDekretNumer &lt;&gt; 0 --jesli jest roznica kursowa do zapisania (dokument lub dekret)
	begin

		if @StronaRK = 1 --ustal dokument z ktorym ma byc rozliczony dokument RK
		begin
			if @RKN_ID &lt;&gt; 0
			begin
				set @tmpDokTyp = @GIDTyp1
				set @tmpDokNumer = @GIDNumer1
				set @tmpDokLp = @GIDLp1
			end
			else
			begin
				set @tmpDokTyp = NULL
				set @tmpDokNumer = NULL
				set @tmpDokLp = NULL

				set @tmpRKDokTyp = NULL
				set @tmpRKDokNumer = NULL
				set @tmpRKDokLp = NULL		
			end

			set @tmpDekretWaluta = @Waluta1
	
	
			if @RKDekretNumer &lt;&gt; 0
			begin
				set @tmpDekretNumer = @Dekret1Numer
				set @tmpDekretLp = @Dekret1Lp
				set @tmpDekretDC = @Dekret1DC
				set @tmpDekretDod = 0
	
				set @tmpRKDekretNumer = @RKDekretNumer
				set @tmpRKDekretLp = 1
				set @tmpRKDekretDC = @DekretRKDC --case when @Znak1 = @Dekret1DC then 3-@tmpDekretDC else @tmpDekretDC end
				set @tmpRKDekretDod = case when @RKN_ID &lt;&gt; 0 then 0 else 1 end
			end
			else
			begin
				set @tmpDekretNumer = NULL
				set @tmpDekretLp = NULL
				set @tmpDekretDC = NULL
				set @tmpDekretDod = NULL
	
				set @tmpRKDekretNumer = NULL
				set @tmpRKDekretLp = NULL
				set @tmpRKDekretDC = NULL
				set @tmpRKDekretDod = NULL
			end
		end
		else
		begin
			if @RKN_ID &lt;&gt; 0
			begin
				set @tmpDokTyp = @GIDTyp2
				set @tmpDokNumer = @GIDNumer2
				set @tmpDokLp = @GIDLp2
			end
			else
			begin
				set @tmpDokTyp = NULL
				set @tmpDokNumer = NULL
				set @tmpDokLp = NULL

				set @tmpRKDokTyp = NULL
				set @tmpRKDokNumer = NULL
				set @tmpRKDokLp = NULL		
			end


			set @tmpDekretWaluta = @Waluta2
	
	
			if @RKDekretNumer &lt;&gt; 0
			begin
				set @tmpDekretNumer = @Dekret2Numer
				set @tmpDekretLp = @Dekret2Lp
				set @tmpDekretDC = @Dekret2DC
				set @tmpDekretDod = 0
	
				set @tmpRKDekretNumer = @RKDekretNumer
				set @tmpRKDekretLp = 1
				set @tmpRKDekretDC = @DekretRKDC --case when @Znak2 = @Dekret2DC then 3-@tmpDekretDC else @tmpDekretDC end
				set @tmpRKDekretDod = case when @RKN_ID &lt;&gt; 0 then 0 else 1 end
			end
			else
			begin
				set @tmpDekretNumer = NULL
				set @tmpDekretLp = NULL
				set @tmpDekretDC = NULL
				set @tmpDekretDod = NULL
				
				set @tmpRKDekretNumer = NULL
				set @tmpRKDekretLp = NULL
				set @tmpRKDekretDC = NULL
				set @tmpRKDekretDod = NULL
			end
		end
					
	
	
		--dodaj powiązanie
		INSERT INTO CDN.Rozliczenia(
		  R2_Dok1Typ, R2_Dok1Numer, R2_Dok1Lp, R2_Dekret1Numer, R2_Dekret1Lp, R2_Dekret1DC, R2_Waluta1, R2_KwotaWal1, 
		  R2_Dok2Typ, R2_Dok2Numer, R2_Dok2Lp, R2_Dekret2Numer, R2_Dekret2Lp, R2_Dekret2DC, R2_Waluta2, R2_KwotaWal2, 
		  R2_KwotaSys, 
	   	  R2_DataRozliczenia, 
		  R2_DataRozrachunku, 
		  R2_OpeNumerRL, R2_OpeNumerRZ, 
		  R2_ParID, 
		  R2_GIDFirma, R2_Dekret1Dod, R2_Dekret2Dod, R2_RK, R2_RKStrona, 
		  R2_Wycena, 
		  R2_PozostajeZWyc, 
		  R2_PozostajeZWycSys, 
		  R2_WycenaParID,
		  R2_WycenaWskazanie)
		VALUES( 
		  @tmpDokTyp, @tmpDokNumer, @tmpDokLp, @tmpDekretNumer, @tmpDekretLp, @tmpDekretDC, @tmpDekretWaluta, 0, 
		  @tmpRKDokTyp, @tmpRKDokNumer, @tmpRKDokLp, @tmpRKDekretNumer, @tmpRKDekretLp, @tmpRKDekretDC, @WalutaSys, 0, 
		  @RoznicaKursowa , 
		  case when @tmpRKDokTyp is null then 0 else @DataRKN end, 
		  case when @tmpRKDekretNumer is null then 0 else @DataRK end, 
		  CASE WHEN ISNULL(@GIDNumer1,0)&lt;&gt;0 AND ISNULL(@GIDNumer2,0)&lt;&gt;0 THEN @UserID ELSE NULL END, 
		  CASE WHEN ISNULL(@RKDekretNumer,0)&lt;&gt;0 THEN @UserID ELSE NULL END,
		  @ParID,
		  @GIDFirma, @tmpDekretDod, @tmpRKDekretDod, 0, 0, 
		  case when @Wycena&lt;&gt;0 then 1 else 0 end,
		  0,
		  0,
		  case when @Wycena&lt;&gt;0 then 0 else @WycenaParID end,
		  @WycenaWskazanie)
	
	
	
		IF @@ERROR &lt;&gt; 0
		BEGIN
		  ROLLBACK TRAN
		  RAISERROR('402:Błąd dodania dokumentu różnic kursowych do tabeli Rozliczen', 16, 1) 
		  RETURN 402
		END
	end		
end




if @KwotaWal &lt;&gt; 0 or @KwotaSys &lt;&gt; 0 
begin

	
	if @StronaRK = 1
		set @tmpRoznicaKursowa = @RoznicaKursowa
	else
		set @tmpRoznicaKursowa = 0
		

	

	-- aktualizacja kwot i flag dokumentów
	IF ISNULL(@GIDTyp1,0) = 784
	BEGIN
		if @Wycena = 0		
			UPDATE CDN.Zapisy SET 
				KAZ_PozostajeRoz = KAZ_PozostajeRoz - SIGN(KAZ_KwotaRoz) * @KwotaWal,
				KAZ_Pozostaje = KAZ_Pozostaje - SIGN(KAZ_Kwota) * CASE WHEN KAZ_Waluta = KAZ_WalutaRoz THEN @KwotaWal ELSE @KwotaSys + @tmpRoznicaKursowa END,
				KAZ_PozostajeSys = KAZ_PozostajeSys - SIGN(KAZ_Kwota) * (@KwotaSys + @tmpRoznicaKursowa),
				KAZ_Rozliczony = CASE WHEN KAZ_PozostajeRoz - SIGN(KAZ_KwotaRoz) * @KwotaWal = 0 THEN 1 ELSE 0 END,
				KAZ_DataRozliczenia = CASE WHEN KAZ_PozostajeRoz - SIGN(KAZ_KwotaRoz) * @KwotaWal = 0 
										THEN CASE WHEN KAZ_PozostajeRoz=KAZ_KwotaRoz THEN @DataRozliczenia ELSE CDN.KsiMaxDataRozliczenia(KAZ_GIDTyp,KAZ_GIDNumer,0) END
										ELSE 999999 END
				--KAZ_KntTyp = case when isnull(@PdmTyp1,0) = 0 then @PdmTyp2 else @PdmTyp1 end,
				--KAZ_KntNumer = case when isnull(@PdmNumer1,0) = 0 then @PdmNumer2 else @PdmNumer1 end
	  		WHERE KAZ_GIDNumer = @GIDNumer1
		else
		begin	
			if @DopasujKurs = 0		
				UPDATE CDN.Zapisy SET				
					KAZ_PozostajeWycena = KAZ_PozostajeWycena - sign(KAZ_Kwota) * @KwotaWal,
					KAZ_PozostajeWycenaSys = KAZ_PozostajeWycenaSys - SIGN(KAZ_Kwota) * (@KwotaSys + @tmpRoznicaKursowa),
					KAZ_Wyceniony = CASE WHEN KAZ_PozostajeWycena - SIGN(KAZ_Kwota) * @KwotaWal = 0 THEN 1 ELSE 0 END,
					KAZ_WycenaRK = KAZ_WycenaRK + sign(KAZ_Kwota) * case when @StronaRK = 2 then @RoznicaKursowa else 0 end,
					KAZ_WycenaRKStan = KAZ_WycenaRKStan + case when @RKN_Znak=1 then 1 else -1 end * case when @PozniejRozl = 1 then @RoznicaKursowa else 0 end
	  			WHERE KAZ_GIDNumer = @GIDNumer1	
			else
			begin
				if @DopasujKurs = 1
				begin
					UPDATE CDN.Zapisy SET
						KAZ_KwotaSys = KAZ_KwotaSys + sign(KAZ_Kwota) * @KwotaSys,
						KAZ_PozostajeSys = KAZ_PozostajeSys + SIGN(KAZ_Kwota) * @KwotaSys,
						KAZ_PozostajeWycena = KAZ_PozostajeWycena - sign(KAZ_Kwota) * @KwotaWal,						
						KAZ_Wyceniony = CASE WHEN KAZ_PozostajeWycena - SIGN(KAZ_Kwota) * @KwotaWal = 0 THEN 1 ELSE 0 END
	  				WHERE KAZ_GIDNumer = @GIDNumer1	
				end
				else
				begin
					UPDATE CDN.Zapisy SET
						KAZ_PozostajeWycena = KAZ_PozostajeWycena - sign(KAZ_Kwota) * @KwotaWal,
						KAZ_PozostajeWycenaSys = KAZ_PozostajeWycenaSys - SIGN(KAZ_Kwota) * (@KwotaSys + @tmpRoznicaKursowa),
						KAZ_Wyceniony = CASE WHEN KAZ_PozostajeWycena - SIGN(KAZ_Kwota) * @KwotaWal = 0 THEN 1 ELSE 0 END
	  				WHERE KAZ_GIDNumer = @GIDNumer1	
				end
			end
		end

		IF @@ERROR &lt;&gt; 0
		BEGIN
		    ROLLBACK TRAN
		    RAISERROR('3:Błąd aktualizacji wiersza w tabeli Zapisy.', 16, 1) 
		    RETURN 3
		END
	END
	ELSE
		IF @GIDTyp1 IS NOT NULL
		BEGIN
			UPDATE CDN.TraPlat SET 
				TRP_Pozostaje = TRP_Pozostaje - SIGN(TRP_Kwota) * @KwotaWal,
				TRP_PozostajeSys = TRP_PozostajeSys - SIGN(TRP_Kwota) * (@KwotaSys + @tmpRoznicaKursowa),
		        TRP_Rozliczona = CASE WHEN TRP_Pozostaje - SIGN(TRP_Kwota) * @KwotaWal = 0 THEN 1 ELSE 0 END,
				TRP_DataRozliczenia = CASE WHEN TRP_Pozostaje - SIGN(TRP_Kwota) * @KwotaWal = 0
										THEN CASE WHEN TRP_Pozostaje=TRP_Kwota THEN @DataRozliczenia ELSE CDN.KsiMaxDataRozliczenia(TRP_GIDTyp,TRP_GIDNumer,TRP_GIDLp) END
										ELSE 999999 END
		  	WHERE TRP_GIDTyp = @GIDTyp1 AND TRP_GIDNumer = @GIDNumer1 AND TRP_GIDLp = @GIDLp1


			IF @@ERROR &lt;&gt; 0
			BEGIN
			    ROLLBACK TRAN
			    RAISERROR('2:Błąd aktualizacji wiersza w tabeli TraPlat.', 16, 1) 
			    RETURN 2
			END


		  	EXEC CDN.AktualizujNaglowek @GIDTyp1, @GIDNumer1, @UserID, @GIDFirma, @EdycjaGIDTyp, @EdycjaGIDNumer

		  	IF @@TRANCOUNT = 0
		    	RETURN 0

			EXEC CDN.PrzeliczKwoteVatPodzielonejPlatnosci @GIDTyp1, @GIDNumer1, @GIDLp1

			IF @@TRANCOUNT = 0
		    	RETURN 2

		END



	if @StronaRK = 2
		set @tmpRoznicaKursowa = @RoznicaKursowa
	else
		set @tmpRoznicaKursowa = 0



	IF ISNULL(@GIDTyp2,0) = 784
	BEGIN
		if @Wycena = 0		
			UPDATE CDN.Zapisy SET 
				KAZ_PozostajeRoz = KAZ_PozostajeRoz - SIGN(KAZ_KwotaRoz) * @KwotaWal,
				KAZ_Pozostaje = KAZ_Pozostaje - SIGN(KAZ_Kwota) * CASE WHEN KAZ_Waluta = KAZ_WalutaRoz THEN @KwotaWal ELSE @KwotaSys + @tmpRoznicaKursowa END,
				KAZ_PozostajeSys = KAZ_PozostajeSys - SIGN(KAZ_Kwota) * (@KwotaSys + @tmpRoznicaKursowa),
				KAZ_Rozliczony = CASE WHEN KAZ_PozostajeRoz - SIGN(KAZ_KwotaRoz) * @KwotaWal = 0 THEN 1 ELSE 0 END,
				KAZ_DataRozliczenia = CASE WHEN KAZ_PozostajeRoz - SIGN(KAZ_KwotaRoz) * @KwotaWal = 0 
										THEN CASE WHEN KAZ_PozostajeRoz=KAZ_KwotaRoz THEN @DataRozliczenia ELSE CDN.KsiMaxDataRozliczenia(KAZ_GIDTyp,KAZ_GIDNumer,0) END
										ELSE 999999 END							
				--KAZ_KntTyp = case when isnull(@PdmTyp2,0) = 0 then @PdmTyp1 else @PdmTyp2 end,
				--KAZ_KntNumer = case when isnull(@PdmNumer2,0) = 0 then @PdmNumer1 else @PdmNumer2 end
	  		WHERE KAZ_GIDNumer = @GIDNumer2
		else
		begin	
			if @DopasujKurs = 0		
				UPDATE CDN.Zapisy SET				
					KAZ_PozostajeWycena = KAZ_PozostajeWycena - sign(KAZ_Kwota) * @KwotaWal,
					KAZ_PozostajeWycenaSys = KAZ_PozostajeWycenaSys - SIGN(KAZ_Kwota) * (@KwotaSys + @tmpRoznicaKursowa),
					KAZ_Wyceniony = CASE WHEN KAZ_PozostajeWycena - SIGN(KAZ_Kwota) * @KwotaWal = 0 THEN 1 ELSE 0 END,
					KAZ_WycenaRK = KAZ_WycenaRK + sign(KAZ_Kwota) * case when @StronaRK = 1 then @RoznicaKursowa else 0 end,
					KAZ_WycenaRKStan = KAZ_WycenaRKStan + case when @RKN_Znak=1 then 1 else -1 end * case when @PozniejRozl = 2 then @RoznicaKursowa else 0 end
	  			WHERE KAZ_GIDNumer = @GIDNumer2
			else
			begin
				if @DopasujKurs = 2
				begin
					UPDATE CDN.Zapisy SET
						KAZ_KwotaSys = KAZ_KwotaSys + sign(KAZ_Kwota) * @KwotaSys,
						KAZ_PozostajeSys = KAZ_PozostajeSys + SIGN(KAZ_Kwota) * @KwotaSys,
						KAZ_PozostajeWycena = KAZ_PozostajeWycena - sign(KAZ_Kwota) * @KwotaWal,						
						KAZ_Wyceniony = CASE WHEN KAZ_PozostajeWycena - SIGN(KAZ_Kwota) * @KwotaWal = 0 THEN 1 ELSE 0 END
	  				WHERE KAZ_GIDNumer = @GIDNumer2
				end
				else
				begin
					UPDATE CDN.Zapisy SET
						KAZ_PozostajeWycena = KAZ_PozostajeWycena - sign(KAZ_Kwota) * @KwotaWal,
						KAZ_PozostajeWycenaSys = KAZ_PozostajeWycenaSys - SIGN(KAZ_Kwota) * (@KwotaSys + @tmpRoznicaKursowa),
						KAZ_Wyceniony = CASE WHEN KAZ_PozostajeWycena - SIGN(KAZ_Kwota) * @KwotaWal = 0 THEN 1 ELSE 0 END
	  				WHERE KAZ_GIDNumer = @GIDNumer2	
				end
			end
		end


		IF @@ERROR &lt;&gt; 0
		BEGIN
		    ROLLBACK TRAN
		    RAISERROR('3:Błąd aktualizacji wiersza w tabeli Zapisy.', 16, 1) 
		    RETURN 3
		END
	END
	ELSE
		IF @GIDTyp2 IS NOT NULL
		BEGIN
		  	UPDATE CDN.TraPlat SET 
				TRP_Pozostaje = TRP_Pozostaje - SIGN(TRP_Kwota) * @KwotaWal,
				TRP_PozostajeSys = TRP_PozostajeSys - SIGN(TRP_Kwota) * (@KwotaSys + @tmpRoznicaKursowa),
		        TRP_Rozliczona = CASE WHEN TRP_Pozostaje - SIGN(TRP_Kwota) * @KwotaWal = 0 THEN 1 ELSE 0 END,
				TRP_DataRozliczenia = CASE WHEN TRP_Pozostaje - SIGN(TRP_Kwota) * @KwotaWal = 0
										THEN CASE WHEN TRP_Pozostaje=TRP_Kwota THEN @DataRozliczenia ELSE CDN.KsiMaxDataRozliczenia(TRP_GIDTyp,TRP_GIDNumer,TRP_GIDLp) END
										ELSE 999999 END
		 	WHERE TRP_GIDTyp = @GIDTyp2 AND TRP_GIDNumer = @GIDNumer2 AND TRP_GIDLp = @GIDLp2

			IF @@ERROR &lt;&gt; 0
			BEGIN
			    ROLLBACK TRAN
			    RAISERROR('2:Błąd aktualizacji wiersza w tabeli TraPlat.', 16, 1) 
			    RETURN 2
			END


			EXEC CDN.AktualizujNaglowek @GIDTyp2, @GIDNumer2, @UserID, @GIDFirma, @EdycjaGIDTyp, @EdycjaGIDNumer


			IF @@TRANCOUNT = 0
				RETURN 0

			EXEC CDN.PrzeliczKwoteVatPodzielonejPlatnosci @GIDTyp2, @GIDNumer2, @GIDLp2

			IF @@TRANCOUNT = 0
		    	RETURN 2
		END
END	


--aktualizuj kwoty pozostaje na dekretach
if @JestRozrachunek &lt;&gt; 0
begin

	if @RKDekretNumer &lt;&gt; 0 and @StronaRK = 1
		set @tmpRoznicaKursowa = @RoznicaKursowa
	else
		set @tmpRoznicaKursowa = 0




	--dekret kompensacyjny (z obydwu stron)
	if @KompGIDNumer &lt;&gt; 0
	begin
		UPDATE CDN.Dekrety SET 
			DT_Pozostaje = DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END,
	  		DT_Rozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END = DT_Kwota THEN 0 ELSE 1 END,
	  		DT_Nierozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys ELSE @KwotaWal END = 0 THEN 0 ELSE 1 END
	  	WHERE DT_GIDNumer = @KompGIDNumer AND DT_GIDLp = 1 --AND DT_DC = 3-@Znak1


	  	IF @@ERROR &lt;&gt; 0
	  	BEGIN
    		ROLLBACK TRAN
    		RAISERROR('202:Błąd aktualizacji tabeli dekrety', 16, 1) 
    		RETURN 202
	  	END
	end		





	--dekret dokumentu 1 (nie uwzgledniam znaku RK bo decyduje o tym strona konta)
	UPDATE CDN.Dekrety SET 
		DT_Pozostaje = DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys + @tmpRoznicaKursowa ELSE @KwotaWal END,
	  	DT_Rozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys + @tmpRoznicaKursowa ELSE @KwotaWal END = DT_Kwota THEN 0 ELSE 1 END,
	  	DT_Nierozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys + @tmpRoznicaKursowa ELSE @KwotaWal END = 0 THEN 0 ELSE 1 END
	WHERE DT_GIDNumer = @Dekret1Numer AND DT_GIDLp = @Dekret1Lp AND DT_DC = @Dekret1DC

	IF @@ERROR &lt;&gt; 0
	BEGIN
	    ROLLBACK TRAN
	    RAISERROR('202:Błąd aktualizacji tabeli dekrety', 16, 1) 
	    RETURN 202
	END




	if @RKDekretNumer &lt;&gt; 0 and @StronaRK = 2
		set @tmpRoznicaKursowa = @RoznicaKursowa
	else
		set @tmpRoznicaKursowa = 0


	--dekret 2 dokumentu
	UPDATE CDN.Dekrety SET 
		DT_Pozostaje = DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys + @tmpRoznicaKursowa ELSE @KwotaWal END,
	  	DT_Rozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys + @tmpRoznicaKursowa ELSE @KwotaWal END = DT_Kwota THEN 0 ELSE 1 END,
	  	DT_Nierozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * CASE WHEN DT_Waluta = @WalutaSys THEN @KwotaSys + @tmpRoznicaKursowa ELSE @KwotaWal END = 0 THEN 0 ELSE 1 END
	WHERE DT_GIDNumer = @Dekret2Numer AND DT_GIDLp = @Dekret2Lp AND DT_DC = @Dekret2DC


	IF @@ERROR &lt;&gt; 0
	BEGIN
	    ROLLBACK TRAN
	    RAISERROR('202:Błąd aktualizacji tabeli dekrety', 16, 1) 
	    RETURN 202
	END



	set @tmpRoznicaKursowa = @RoznicaKursowa

	--dekret roznicy kursowej
	if @RKDekretNumer &lt;&gt; 0
	begin
		UPDATE CDN.Dekrety SET 
			DT_Pozostaje = DT_Pozostaje - SIGN(DT_Kwota) * @tmpRoznicaKursowa,
		  	DT_Rozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * @tmpRoznicaKursowa = DT_Kwota THEN 0 ELSE 1 END,
		  	DT_Nierozliczony = CASE WHEN DT_Pozostaje - SIGN(DT_Kwota) * @tmpRoznicaKursowa = 0 THEN 0 ELSE 1 END
		WHERE DT_GIDNumer = @RKDekretNumer AND DT_GIDLp = 1 AND DT_DC = @tmpRKDekretDC and DT_WalutaObca = 0
	
		IF @@ERROR &lt;&gt; 0
		BEGIN
		    ROLLBACK TRAN
		    RAISERROR('202:Błąd aktualizacji tabeli dekrety.', 16, 1) 
		    RETURN 202
		END
	END
end

lExit:
-- koniec transakcji i powrót
COMMIT TRAN
SET NOCOUNT OFF
SET @Kwota = @KwotaWal
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="Przyznanie praw do procedury DodajRozliczenie"></A><PRE>
          <FONT SIZE="2"><I>/* Przyznanie praw do procedury DodajRozliczenie */</I><BR>
GRANT EXECUTE ON CDN.DodajRozliczenie TO CDNRaport
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>