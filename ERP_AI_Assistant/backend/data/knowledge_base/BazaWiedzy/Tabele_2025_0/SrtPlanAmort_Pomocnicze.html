<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="SrtPlanAmort_ZwiekszZmniejsz"></A><PRE>
          <FONT SIZE="2"><I>/* SrtPlanAmort_ZwiekszZmniejsz */</I><BR>
CREATE PROCEDURE cdn.SrtPlanAmort_ZwiekszZmniejsz (@Srt_GIDNumer INT, @SHE_GIDTyp int, @SHE_GIDNumer int, @SHE_GIDLp int, @_Debug smallint
	,@RokOdC int
	,@RokDoC int
	,@Srt_PodlegaAMP smallint 
	,@AMPUmorzenie smallint
	,@DataKoniecPierwszyRP_C int
	,@SrtGIDNumerPierwszeOT int
	,@Srt_MsNaliczania int
	,@Srt_MsNaliczaniaAm smallint
	,@Srt_MsNaliczaniaT3 int
	,@Srt_MsNaliczaniaT4 int
	,@Srt_MsNaliczaniaT5 int
	,@NaDzienC int
	,@DataZapisuC int	
) as
begin
set nocount on

	declare @ZO smallint= 2144,@ZM smallint= 2160,@OT smallint= 2048,@OTK smallint= 2176, @PK smallint= 2080,@LT smallint= 2096,@LTK smallint= 2224,
		@AM smallint= 2064,@AMK smallint= 2192,@AMP smallint= 6208,@AK smallint= 2304,@ZW smallint= 2288,@RN smallint= 2128,@WN smallint= 2112,@MW smallint= 2432,
		@MWK smallint= 2496,@ZKZ smallint= 2552,@ZSA smallint= 2556,@ZMT smallint= 2548,@RT smallint= 2532,@NT smallint= 2536;	

		declare @Dokument_LT_LKT_Likwidacja tinyint = 2, @Dokument_LT_LTK tinyint = 1, @Nie_LT_LTK tinyint = 0
        --ustaw zwiekszenia/zmniejszenia uwzgl. OT+OTK+MW+MWK-LT-LTK+PK (z dokl do miesiaca) (PK z tego samego miesiaca (z dokl do dnia))


    select mies,
        sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * s1) as s1,
        sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * s2) as s2,
		sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * s3) as s3,
		sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * s4) as s4,
		sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * s5) as s5,

        sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * n1) as n1,
        sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * n2) as n2,
        sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * n3) as n3,
        sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * n4) as n4,
		sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * n5) as n5,

		cast(0 as decimal(15,2)) as amLikw,		-- dawne s3; na potrzeby następnego zapytania, gdzie to pole było potrzebne

		sum( case   when she_gidtyp in(@LT, @LTK) then -1   when s1 &lt; 0 then 1   else 0   end   * s1 ) as s_min1,
        sum( case   when she_gidtyp in(@LT, @LTK) then -1   when s2 &lt; 0 then 1   else 0   end   * s2 ) as s_min2,
		sum( case   when she_gidtyp in(@LT, @LTK) then -1   when s3 &lt; 0 then 1   else 0   end   * s3 ) as s_min3,
		sum( case   when she_gidtyp in(@LT, @LTK) then -1   when s4 &lt; 0 then 1   else 0   end   * s4 ) as s_min4,
		sum( case   when she_gidtyp in(@LT, @LTK) then -1   when s5 &lt; 0 then 1   else 0   end   * s5 ) as s_min5,
			 	  										  					   			      		 
        sum( case   when she_gidtyp in(@LT, @LTK) then -1   when n1 &lt; 0 then 1   else 0   end   * n1 ) as n_min1,
        sum( case   when she_gidtyp in(@LT, @LTK) then -1   when n2 &lt; 0 then 1   else 0   end   * n2 ) as n_min2,
		sum( case   when she_gidtyp in(@LT, @LTK) then -1   when n3 &lt; 0 then 1   else 0   end   * n3 ) as n_min3,
        sum( case   when she_gidtyp in(@LT, @LTK) then -1   when n4 &lt; 0 then 1   else 0   end   * n4 ) as n_min4,
        sum( case   when she_gidtyp in(@LT, @LTK) then -1   when n5 &lt; 0 then 1   else 0   end   * n5 ) as n_min5,
	
		sum(case when she_gidtyp in(@LT, @LTK) and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s1 else 0 end) as Lt1,
		sum(case when she_gidtyp in(@LT, @LTK) and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s2 else 0 end) as Lt2,
		sum(case when she_gidtyp in(@LT, @LTK) and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s3 else 0 end) as Lt3,
		sum(case when she_gidtyp in(@LT, @LTK) and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s4 else 0 end) as Lt4,
		sum(case when she_gidtyp in(@LT, @LTK) and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s5 else 0 end) as Lt5,
		
        0 as ZwAK, 0 as ZmAK,

		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
					when she_gidtyp in (@OTK, @AMK, @MWK) then
						case when ZnakDokPierwotnego &amp; 1 &gt; 0 then s1 else 0 end
					else 
						case when s1 &lt; 0 then 0 else s1 end
				end else 0 end ) as s1zw,	-- s1w				

		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when ZnakDokPierwotnego &amp; 2 &gt; 0 then s2 else 0 end
				else
					case when s2 &lt; 0 then 0 else s2 end
				end else 0 end ) as s2zw,	-- s2w
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when ZnakDokPierwotnego &amp; 4 &gt; 0 then s3 else 0 end
				else 
					case when s3 &lt; 0 then 0 else s3 end
			end else 0 end ) as s3zw,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when ZnakDokPierwotnego &amp; 8 &gt; 0 then s4 else 0 end
				else 
					case when s4 &lt; 0 then 0 else s4 end
			end else 0 end ) as s4zw,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when ZnakDokPierwotnego &amp; 16 &gt; 0 then s5 else 0 end
				else 
					case when s5 &lt; 0 then 0 else s5 end
			end else 0 end ) as s5zw,
				
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s1
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when (ZnakDokPierwotnego &amp; 1 = 0) then s1 else 0 end
				else
					case when s1 &gt; 0 then 0 else s1 end
				end else 0 end ) as s1zm,	-- s3w
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s2
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when (ZnakDokPierwotnego &amp; 2 = 0) then s2 else 0 end
				else
					case when s2 &gt; 0 then 0 else s2 end
				end else 0 end ) as s2zm,	-- s4w
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s3
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when (ZnakDokPierwotnego &amp; 4 = 0) then s3 else 0 end
				else
					case when s3 &gt; 0 then 0 else s3 end
				end else 0 end ) as s3zm,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s4
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when (ZnakDokPierwotnego &amp; 8 = 0) then s4 else 0 end
				else
					case when s4 &gt; 0 then 0 else s4 end
				end else 0 end ) as s4zm,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s5
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when (ZnakDokPierwotnego &amp; 16 = 0) then s5 else 0 end
				else
					case when s5 &gt; 0 then 0 else s5 end
				end else 0 end ) as s5zm,


		-------	SYS	----------------
		sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * s1Sys) as s1Sys ,
        sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * s2Sys) as s2Sys,
		sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * s3Sys) as s3Sys,
		sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * s4Sys) as s4Sys,
		sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * s5Sys) as s5Sys,

        sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * n1Sys) as n1Sys ,
        sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * n2Sys) as n2Sys,				
        sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * n3Sys) as n3Sys,				
        sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * n4Sys) as n4Sys,				
        sum(case when she_gidtyp in(@LT, @LTK) then -1 else 1 end * n5Sys) as n5Sys,

		cast(0 as decimal(15,2)) as amLikwSys,		-- dawne s3Sys; na potrzeby następnego zapytania, gdzie to pole było potrzebne
		
		sum(case   when she_gidtyp in(@LT, @LTK) then -1   when s1 &lt; 0 then 1   else 0   end   * s1Sys) as s_min1Sys,									    
        sum(case   when she_gidtyp in(@LT, @LTK) then -1   when s2 &lt; 0 then 1   else 0   end   * s2Sys) as s_min2Sys,											    
		sum(case   when she_gidtyp in(@LT, @LTK) then -1   when s3 &lt; 0 then 1   else 0   end   * s3Sys) as s_min3Sys,											    
		sum(case   when she_gidtyp in(@LT, @LTK) then -1   when s4 &lt; 0 then 1   else 0   end   * s4Sys) as s_min4Sys,											    
		sum(case   when she_gidtyp in(@LT, @LTK) then -1   when s5 &lt; 0 then 1   else 0   end   * s5Sys) as s_min5Sys,											    
				  										  			         			     
        sum(case   when she_gidtyp in(@LT, @LTK) then -1   when n1 &lt; 0 then 1   else 0   end   * n1Sys) as n_min1Sys,									    
        sum(case   when she_gidtyp in(@LT, @LTK) then -1   when n2 &lt; 0 then 1   else 0   end   * n2Sys) as n_min2Sys,											    
		sum(case   when she_gidtyp in(@LT, @LTK) then -1   when n3 &lt; 0 then 1   else 0   end   * n3Sys) as n_min3Sys,											    
		sum(case   when she_gidtyp in(@LT, @LTK) then -1   when n4 &lt; 0 then 1   else 0   end   * n4Sys) as n_min4Sys,											    
		sum(case   when she_gidtyp in(@LT, @LTK) then -1   when n5 &lt; 0 then 1   else 0   end   * n5Sys) as n_min5Sys,
		        
        sum(case when she_gidtyp in(@LT, @LTK) and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s1Sys else 0 end) as Lt1Sys,
        sum(case when she_gidtyp in(@LT, @LTK) and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s2Sys else 0 end) as Lt2Sys,
        sum(case when she_gidtyp in(@LT, @LTK) and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s3Sys else 0 end) as Lt3Sys,
        sum(case when she_gidtyp in(@LT, @LTK) and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s4Sys else 0 end) as Lt4Sys,
        sum(case when she_gidtyp in(@LT, @LTK) and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s5Sys else 0 end) as Lt5Sys,

        0 as ZwAKSys, 0 as ZmAKSys,
        
        sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when ZnakDokPierwotnego &amp; 1 &gt; 0 then s1Sys else 0 end
				else 
					case when s1 &lt; 0 then 0 else s1Sys end
			end else 0 end
		) as s1zwSys,	-- s1wSys				
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when ZnakDokPierwotnego &amp; 2 &gt; 0 then s2Sys else 0 end
				else
					case when s2 &lt; 0 then 0 else s2Sys end
				end else 0 end
		) as s2zwSys	-- s2wSys
		, sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when ZnakDokPierwotnego &amp; 4 &gt; 0 then s3Sys else 0 end
				else
					case when s3 &lt; 0 then 0 else s3Sys end
				end else 0 end
		) as s3zwSys
		, sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when ZnakDokPierwotnego &amp; 8 &gt; 0 then s4Sys else 0 end
				else
					case when s4 &lt; 0 then 0 else s4Sys end
				end else 0 end
		) as s4zwSys
		, sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when ZnakDokPierwotnego &amp; 16 &gt; 0 then s5Sys else 0 end
				else
					case when s5 &lt; 0 then 0 else s5Sys end
				end else 0 end
		) as s5zwSys,
				
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s1Sys
				when she_gidtyp in (@OTK, @AMK, @MWK) then	
					case when ZnakDokPierwotnego &amp; 1 = 0 then s1Sys else 0 end
				else
					case when s1 &gt; 0 then 0 else s1Sys end
				end else 0 end						
		) as s1zmSys,	-- s3wSys
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s2Sys
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when ZnakDokPierwotnego &amp; 2 = 0 then s2Sys else 0 end
				else
					case when s2 &gt; 0 then 0 else s2Sys end
				end else 0 end
		) as s2zmSys		-- s4wSys
		, sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s3Sys
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when ZnakDokPierwotnego &amp; 4 = 0 then s3Sys else 0 end
				else
					case when s3 &gt; 0 then 0 else s3Sys end
				end else 0 end
		) as s3zmSys
		, sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s4Sys
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when ZnakDokPierwotnego &amp; 8 = 0 then s4Sys else 0 end
				else
					case when s4 &gt; 0 then 0 else s4Sys end
				end else 0 end
		) as s4zmSys
		, sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s5Sys
				when she_gidtyp in (@OTK, @AMK, @MWK) then
					case when ZnakDokPierwotnego &amp; 16 = 0 then s5Sys else 0 end
				else
					case when s5 &gt; 0 then 0 else s5Sys end
				end else 0 end
		) as s5zmSys
				
		, 0 as przylaczenie1, 0 as odlaczenie1, 0 as przylaczenie2, 0 as odlaczenie2, 0 as przylaczenie1Sys, 0 as odlaczenie1Sys, 0 as przylaczenie2Sys, 0 as odlaczenie2Sys

		, max(SHE_T1) SHE_T1, max(SHE_T2) SHE_T2, max(SHE_T3) SHE_T3, max(SHE_T4) SHE_T4, max(SHE_T5) SHE_T5

    into #tmpZwiekszenia
    from (  select she_gidtyp, she_data, cdn.datediffclarion(2, 0, she_data) as mies,
                SHE_KwotaInw as s1, SHE_PodstawaAm as s2, SHE_PodstawaAmTor3 as s3, SHE_PodstawaAmTor4 as s4, SHE_PodstawaAmTor5 as s5, --wg daty wystawienia
                case --wg miesiaca obowiazywania
                when ((she_gidtyp = @MW or she_gidtyp = @MWK ) and She_MsObow = 1)
                        or ( (she_gidtyp = @MW or she_gidtyp = @MWK)
								and She_MsObow = 2 and @Srt_PodlegaAMP &lt;&gt; 0 and @AMPUmorzenie &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- dla przyspieszonej z miesiaca przyjecia
                        or she_gidtyp = @PK
                        or ((she_gidtyp = @LT or she_gidtyp = @LTK) and isnull(she_likwidacja,0) &lt;&gt; 0)
                        or ( she_gidtyp in (@OT) and @Srt_MsNaliczania = 1 and she_gidnumer = @SrtGIDNumerPierwszeOT )	
                        or ( she_gidtyp in (@OT) and @Srt_MsNaliczania = 2 and she_gidnumer = @SrtGIDNumerPierwszeOT and @Srt_PodlegaAMP &lt;&gt; 0 and @AMPUmorzenie &lt;&gt; 0)
                        or ( she_gidtyp = @OTK and @Srt_MsNaliczania = 1 and isnull(#tmpOTK.shenumer,0) &lt;&gt; 0) --jesli korekta pierwszego OT	
                        or ( she_gidtyp = @OTK and @Srt_MsNaliczania = 2 and isnull(#tmpOTK.shenumer,0) &lt;&gt; 0 and @Srt_PodlegaAMP &lt;&gt; 0 and @AMPUmorzenie &lt;&gt; 0)	
                        or ( she_gidtyp in (@OT)  and she_gidnumer &lt;&gt; @SrtGIDNumerPierwszeOT and @Srt_PodlegaAMP &lt;&gt; 0 and @AMPUmorzenie &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- zwiekszenie sprzed 4.0 dla przysp z mies przyjecia	
                        or ( she_gidtyp = @OTK and #tmpOTK.shenumer is null and @Srt_PodlegaAMP &lt;&gt; 0 and @AMPUmorzenie &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- korekta zwiekszenie sprzed 4.0 dla przysp z mies przyjecia		
                        or ((she_gidtyp = @LT or she_gidtyp = @LTK) and isnull(she_likwidacja,0) = 0 and @Srt_PodlegaAMP &lt;&gt; 0 and @AMPUmorzenie &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- zmniejszenie sprzed 4.0 dla przysp z mies przyjecia

						or ( she_gidtyp = @NT and @Srt_MsNaliczania = 1 and SHE_TorUm_Lp &gt; 0 )	

                        then 0
                else
                        SHE_KwotaInw
                end as n1,
                case
                when ((she_gidtyp = @MW or she_gidtyp = @MWK ) and She_MsObowAm = 1)
                        or ( (she_gidtyp = @MW or she_gidtyp = @MWK ) 
								and She_MsObowAm = 2 and @Srt_PodlegaAMP &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- dla przyspieszonej z miesiaca przyjecia
                        or she_gidtyp = @PK
                        or ((she_gidtyp = @LT or she_gidtyp = @LTK) and isnull(she_likwidacja,0) &lt;&gt; 0)
                        or ( she_gidtyp in (@OT)  and @Srt_MsNaliczaniaAm = 1 and she_gidnumer = @SrtGIDNumerPierwszeOT)	
                        or ( she_gidtyp in (@OT)  and @Srt_MsNaliczaniaAm = 2 and she_gidnumer = @SrtGIDNumerPierwszeOT and @Srt_PodlegaAMP &lt;&gt; 0)	
                        or ( she_gidtyp = @OTK and @Srt_MsNaliczaniaAm = 1 and isnull(#tmpOTK.shenumer,0) &lt;&gt; 0) --jesli korekta pierwszego OT	
                        or ( she_gidtyp = @OTK and @Srt_MsNaliczaniaAm = 2 and isnull(#tmpOTK.shenumer,0) &lt;&gt; 0 and @Srt_PodlegaAMP &lt;&gt; 0)	
                        or ( she_gidtyp in (@OT)  and she_gidnumer &lt;&gt; @SrtGIDNumerPierwszeOT and @Srt_PodlegaAMP &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- zwiekszenie sprzed 4.0 dla przysp z mies przyjecia	
                        or ( she_gidtyp = @OTK and #tmpOTK.shenumer is null and @Srt_PodlegaAMP &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- korekta zwiekszenie sprzed 4.0 dla przysp z mies przyjecia	
                        or ((she_gidtyp = @LT or she_gidtyp = @LTK) and isnull(she_likwidacja,0) = 0 and @Srt_PodlegaAMP &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- zmniejszenie sprzed 4.0 dla przysp z mies przyjecia
						or ( she_gidtyp = @NT and @Srt_MsNaliczaniaAm = 1 and SHE_TorAm_Lp &gt; 0 )	
                        then 0
                else
                        SHE_PodstawaAm
                end as n2,

				case
                when ((she_gidtyp = @MW or she_gidtyp = @MWK ) and SHE_MsObowAmTor3 = 1)							
                        or she_gidtyp = @PK
                        or ((she_gidtyp = @LT or she_gidtyp = @LTK) and isnull(she_likwidacja,0) &lt;&gt; 0)
                        or ( she_gidtyp in (@OT)  and @Srt_MsNaliczaniaT3 = 1 and she_gidnumer = @SrtGIDNumerPierwszeOT)								
                        or ( she_gidtyp = @OTK and @Srt_MsNaliczaniaT3 = 1 and isnull(#tmpOTK.shenumer,0) &lt;&gt; 0) --jesli korekta pierwszego OT								
						or ( she_gidtyp = @NT and @Srt_MsNaliczaniaT3 = 1 and SHE_Tor3_Lp &gt; 0 )	
                        then 0
                else
                        SHE_PodstawaAmTor3
                end as n3,

				case
                when ((she_gidtyp = @MW or she_gidtyp = @MWK ) and SHE_MsObowAmTor4 = 1)							
                        or she_gidtyp = @PK
                        or ((she_gidtyp = @LT or she_gidtyp = @LTK) and isnull(she_likwidacja,0) &lt;&gt; 0)
                        or ( she_gidtyp in (@OT)  and @Srt_MsNaliczaniaT4 = 1 and she_gidnumer = @SrtGIDNumerPierwszeOT)								
                        or ( she_gidtyp = @OTK and @Srt_MsNaliczaniaT4 = 1 and isnull(#tmpOTK.shenumer,0) &lt;&gt; 0) --jesli korekta pierwszego OT								
						or ( she_gidtyp = @NT and @Srt_MsNaliczaniaT4 = 1 and SHE_Tor4_Lp &gt; 0 )	
                        then 0
                else
                        SHE_PodstawaAmTor4
                end as n4,

				case
                when ((she_gidtyp = @MW or she_gidtyp = @MWK ) and SHE_MsObowAmTor5 = 1)							
                        or she_gidtyp = @PK
                        or ((she_gidtyp = @LT or she_gidtyp = @LTK) and isnull(she_likwidacja,0) &lt;&gt; 0)
                        or ( she_gidtyp in (@OT)  and @Srt_MsNaliczaniaT5 = 1 and she_gidnumer = @SrtGIDNumerPierwszeOT)								
                        or ( she_gidtyp = @OTK and @Srt_MsNaliczaniaT5 = 1 and isnull(#tmpOTK.shenumer,0) &lt;&gt; 0) --jesli korekta pierwszego OT								
						or ( she_gidtyp = @NT and @Srt_MsNaliczaniaT5 = 1 and SHE_Tor5_Lp &gt; 0 )	
                        then 0
                else
                        SHE_PodstawaAmTor5
                end as n5,

                She_Likwidacja,
                case when SHE_GIDTyp IN (@OTK, @LTK, @AMK, @MWK) then CDN.SrtKorDokPierwotnyZnak(SHE_GIDTyp, SHE_GIDNumer) else -1 end ZnakDokPierwotnego
                        
                ,SHE_KwotaInwSys as s1Sys, SHE_PodstawaAmSys as s2Sys, SHE_PodstawaAmTor3Sys as s3Sys, SHE_PodstawaAmTor4Sys as s4Sys, SHE_PodstawaAmTor5Sys as s5Sys,
                case --wg miesiaca obowiazywania
                when ((she_gidtyp = @MW or she_gidtyp = @MWK ) and She_MsObow = 1)
                        or ((she_gidtyp = @MW or she_gidtyp = @MWK ) 
								and She_MsObow = 2 and @Srt_PodlegaAMP &lt;&gt; 0 and @AMPUmorzenie &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- dla przyspieszonej z miesiaca przyjecia
                        or she_gidtyp = @PK
                        or ((she_gidtyp = @LT or she_gidtyp = @LTK) and isnull(she_likwidacja,0) &lt;&gt; 0) 
                        or ( she_gidtyp in (@OT) and @Srt_MsNaliczania = 1 and she_gidnumer = @SrtGIDNumerPierwszeOT )	
                        or ( she_gidtyp in (@OT) and @Srt_MsNaliczania = 2 and she_gidnumer = @SrtGIDNumerPierwszeOT and @Srt_PodlegaAMP &lt;&gt; 0 and @AMPUmorzenie &lt;&gt; 0)	
                        or ( she_gidtyp = @OTK and @Srt_MsNaliczania = 1 and isnull(#tmpOTK.shenumer,0) &lt;&gt; 0) --jesli korekta pierwszego OT	
                        or ( she_gidtyp = @OTK and @Srt_MsNaliczania = 2 and isnull(#tmpOTK.shenumer,0) &lt;&gt; 0 and @Srt_PodlegaAMP &lt;&gt; 0 and @AMPUmorzenie &lt;&gt; 0)	
                        or ( she_gidtyp in (@OT) and she_gidnumer &lt;&gt; @SrtGIDNumerPierwszeOT and @Srt_PodlegaAMP &lt;&gt; 0 and @AMPUmorzenie &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- zwiekszenie sprzed 4.0 dla przysp z mies przyjecia	
                        or ( she_gidtyp = @OTK and #tmpOTK.shenumer is null and @Srt_PodlegaAMP &lt;&gt; 0 and @AMPUmorzenie &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- korekta zwiekszenie sprzed 4.0 dla przysp z mies przyjecia	
                        or ((she_gidtyp = @LT or she_gidtyp = @LTK) and isnull(she_likwidacja,0) = 0 and @Srt_PodlegaAMP &lt;&gt; 0 and @AMPUmorzenie &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- zmniejszenie sprzed 4.0 dla przysp z mies przyjecia
						or ( she_gidtyp = @NT and @Srt_MsNaliczania = 1 and SHE_TorAm_Lp &gt; 0 )	
                        then 0
                else
                        SHE_KwotaInwSys
                end as n1Sys,
                case
                when ((she_gidtyp = @MW or she_gidtyp = @MWK) and She_MsObowAm = 1)
                        or ((she_gidtyp = @MW or she_gidtyp = @MWK ) and She_MsObowAm = 2 and @Srt_PodlegaAMP &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- dla przyspieszonej z miesiaca przyjecia
                        or she_gidtyp = @PK
                        or ((she_gidtyp = @LT or she_gidtyp = @LTK) and isnull(she_likwidacja,0) &lt;&gt; 0) 
                        or ( she_gidtyp in (@OT) and @Srt_MsNaliczaniaAm = 1 and she_gidnumer = @SrtGIDNumerPierwszeOT)	
                        or ( she_gidtyp in (@OT) and @Srt_MsNaliczaniaAm = 2 and she_gidnumer = @SrtGIDNumerPierwszeOT and @Srt_PodlegaAMP &lt;&gt; 0)	
                        or ( she_gidtyp = @OTK and @Srt_MsNaliczaniaAm = 1 and isnull(#tmpOTK.shenumer,0) &lt;&gt; 0) --jesli korekta pierwszego OT	
                        or ( she_gidtyp = @OTK and @Srt_MsNaliczaniaAm = 2 and isnull(#tmpOTK.shenumer,0) &lt;&gt; 0 and @Srt_PodlegaAMP &lt;&gt; 0)	
                        or ( she_gidtyp = @OTK and she_gidnumer &lt;&gt; @SrtGIDNumerPierwszeOT and @Srt_PodlegaAMP &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- zwiekszenie sprzed 4.0 dla przysp z mies przyjecia	
                        or ( she_gidtyp = @OTK and #tmpOTK.shenumer is null and @Srt_PodlegaAMP &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- korekta zwiekszenie sprzed 4.0 dla przysp z mies przyjecia	
                        or ((she_gidtyp = @LT or she_gidtyp = @LTK) and isnull(she_likwidacja,0) = 0 and @Srt_PodlegaAMP &lt;&gt; 0 and @DataKoniecPierwszyRP_C &gt;= She_Data ) -- zmniejszenie sprzed 4.0 dla przysp z mies przyjecia
						or ( she_gidtyp = @NT and @Srt_MsNaliczaniaAm = 1 and SHE_TorAm_Lp &gt; 0 )	
                        then 0
                else
                        SHE_PodstawaAmSys
                end as n2Sys,

				case
                when ((she_gidtyp = @MW or she_gidtyp = @MWK) and SHE_MsObowAmTor3 = 1)							
                        or she_gidtyp = @PK
                        or ((she_gidtyp = @LT or she_gidtyp = @LTK) and isnull(she_likwidacja,0) &lt;&gt; 0) 
                        or ( she_gidtyp in (@OT) and @Srt_MsNaliczaniaT3 = 1 and she_gidnumer = @SrtGIDNumerPierwszeOT)								
                        or ( she_gidtyp = @OTK and @Srt_MsNaliczaniaT3 = 1 and isnull(#tmpOTK.shenumer,0) &lt;&gt; 0) --jesli korekta pierwszego OT								
						or ( she_gidtyp = @NT and @Srt_MsNaliczaniaT3 = 1 and SHE_Tor3_Lp &gt; 0 )	
                        then 0
                else
                        SHE_PodstawaAmTor3Sys
                end as n3Sys,

				case
                when ((she_gidtyp = @MW or she_gidtyp = @MWK) and SHE_MsObowAmTor4 = 1)							
                        or she_gidtyp = @PK
                        or ((she_gidtyp = @LT or she_gidtyp = @LTK) and isnull(she_likwidacja,0) &lt;&gt; 0) 
                        or ( she_gidtyp in (@OT) and @Srt_MsNaliczaniaT4 = 1 and she_gidnumer = @SrtGIDNumerPierwszeOT)								
                        or ( she_gidtyp = @OTK and @Srt_MsNaliczaniaT4 = 1 and isnull(#tmpOTK.shenumer,0) &lt;&gt; 0) --jesli korekta pierwszego OT								
						or ( she_gidtyp = @NT and @Srt_MsNaliczaniaT4 = 1 and SHE_Tor4_Lp &gt; 0 )	
                        then 0
                else
                        SHE_PodstawaAmTor4Sys
                end as n4Sys,

				case
                when ((she_gidtyp = @MW or she_gidtyp = @MWK) and SHE_MsObowAmTor5 = 1)							
                        or she_gidtyp = @PK
                        or ((she_gidtyp = @LT or she_gidtyp = @LTK) and isnull(she_likwidacja,0) &lt;&gt; 0) 
                        or ( she_gidtyp in (@OT) and @Srt_MsNaliczaniaT5 = 1 and she_gidnumer = @SrtGIDNumerPierwszeOT)								
                        or ( she_gidtyp = @OTK and @Srt_MsNaliczaniaT5 = 1 and isnull(#tmpOTK.shenumer,0) &lt;&gt; 0) --jesli korekta pierwszego OT								
						or ( she_gidtyp = @NT and @Srt_MsNaliczaniaT5 = 1 and SHE_Tor5_Lp &gt; 0 )	
                        then 0
                else
                        SHE_PodstawaAmTor5Sys
                end as n5Sys,
                SHE_PrzesStrona
				, SHE_TorUm_Lp SHE_T1, SHE_TorAm_Lp SHE_T2, SHE_Tor3_Lp SHE_T3, SHE_Tor4_Lp SHE_T4, SHE_Tor5_Lp SHE_T5
				
            from cdn.srthistelem left outer join #tmpOTK on she_gidTyp = shnTyp and she_gidNumer = sheNumer
            where she_srtnumer = @Srt_GIDNumer and
                    (@NaDzienC is null or ( not @NaDzienC is null and SHE_Data &lt;= @NaDzienC)) and
                    (@DataZapisuC is null or (not @DataZapisuC is null and SHE_DataZap &lt;= @DataZapisuC)) and
					she_gidtyp in (@OT, @OTK, @LT, @LTK, @MW, @MWK, @PK, @NT) 
					and ((@SHE_GIDNumer &lt;&gt; 0 and not (SHE_GIDTyp = @SHE_GIDTyp and SHE_GIDNumer = @SHE_GIDNumer and SHE_GIDLp = @SHE_GIDLp)) or @SHE_GIDNumer = 0)
                        
		) as a1
    group by mies
		
		
    update #tmpOdpisy set
        ZwiekszenieT1 = s1 - n1, --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam)
        ZwiekszenieT2 = s2 - n2,
        ZwiekszeniePlusT1 = s1 - n1 - (s_min1 - n_min1), --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam) tylko z wartoscia dodatnia
        ZwiekszeniePlusT2 = s2 - n2 - (s_min2 - n_min2),
        ZwiekszenieMiesT1 = s1, --zwiekszenie wystawione w danym miesiacu
        ZwiekszenieMiesT2 = s2,
        ZwiekszenieMsObow2T1 = n1, --zwiekszenie wystawione w danym miesiacu, obowiazujace w nastepnym
        ZwiekszenieMsObow2T2 = n2,
        ZwiekszenieLtT1 = Lt1, --zmiana wartosci przez calkowita likwidacje
        ZwiekszenieLtT2 = Lt2,
        ZwiekszenieT1w = s1zw,	-- zwiekszenia wartosci inw. korekty po tej samej stronie co pierwotny T1
        ZwiekszenieT2w = s2zw,
        ZmniejszenieT1w = s1zm,	-- zmniejszenia wartosci inw. korekty po tej samej stronie co pierwotny T1
        ZmniejszenieT2w = s2zm,
                
        ZwiekszenieT1Sys = s1Sys - n1Sys, --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam)
        ZwiekszenieT2Sys = s2Sys - n2Sys,
        ZwiekszeniePlusT1Sys = s1Sys - n1Sys - (s_min1Sys - n_min1Sys), --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam) tylko z wartoscia dodatnia
        ZwiekszeniePlusT2Sys = s2Sys - n2Sys - (s_min2Sys - n_min2Sys),
        ZwiekszenieMiesT1Sys = s1Sys, --zwiekszenie wystawione w danym miesiacu
        ZwiekszenieMiesT2Sys = s2Sys,
        ZwiekszenieMsObow2T1Sys = n1Sys, --zwiekszenie wystawione w danym miesiacu, obowiazujace w nastepnym
        ZwiekszenieMsObow2T2Sys = n2Sys,
        ZwiekszenieLtT1Sys = Lt1Sys, --zmiana wartosci przez calkowita likwidacje
        ZwiekszenieLtT2Sys = Lt2Sys,
        ZwiekszenieT1wSys = s1zwSys,	-- zwiekszenia wartosci inw. korekty po tej samej stronie co pierwotny T1
        ZwiekszenieT2wSys = s2zwSys,
        ZmniejszenieT1wSys = s1zmSys,	-- zmniejszenia wartosci inw. korekty po tej samej stronie co pierwotny T1
        ZmniejszenieT2wSys = s2zmSys,
                
		ZwiekszenieT3 = s3 - n3, --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam)                
        ZwiekszeniePlusT3 = s3 - n3 - (s_min3 - n_min3), --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam) tylko z wartoscia dodatnia                
        ZwiekszenieMiesT3 = s3, --zwiekszenie wystawione w danym miesiacu                
        ZwiekszenieMsObow2T3 = n3, --zwiekszenie wystawione w danym miesiacu, obowiazujace w nastepnym                
        ZwiekszenieLtT3 = Lt3, --zmiana wartosci przez calkowita likwidacje                
        ZwiekszenieT3w = s3zw,	-- zwiekszenia wartosci inw. korekty po tej samej stronie co pierwotny T3                
        ZmniejszenieT3w = s3zm,	-- zmniejszenia wartosci inw. korekty po tej samej stronie co pierwotny T3                
                
        ZwiekszenieT3Sys = s3Sys - n3Sys, --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam)                
        ZwiekszeniePlusT3Sys = s3Sys - n3Sys - (s_min3Sys - n_min3Sys), --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam) tylko z wartoscia dodatnia                
        ZwiekszenieMiesT3Sys = s3Sys, --zwiekszenie wystawione w danym miesiacu                
        ZwiekszenieMsObow2T3Sys = n3Sys, --zwiekszenie wystawione w danym miesiacu, obowiazujace w nastepnym                
        ZwiekszenieLtT3Sys = Lt3Sys, --zmiana wartosci przez calkowita likwidacje                
        ZwiekszenieT3wSys = s3zwSys,	-- zwiekszenia wartosci inw. korekty po tej samej stronie co pierwotny T3                
        ZmniejszenieT3wSys = s3zmSys,	-- zmniejszenia wartosci inw. korekty po tej samej stronie co pierwotny T3
				
        ZwiekszenieT4 = s4 - n4, --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam)                
        ZwiekszeniePlusT4 = s4 - n4 - (s_min4 - n_min4), --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam) tylko z wartoscia dodatnia                
        ZwiekszenieMiesT4 = s4, --zwiekszenie wystawione w danym miesiacu                
        ZwiekszenieMsObow2T4 = n4, --zwiekszenie wystawione w danym miesiacu, obowiazujace w nastepnym                
        ZwiekszenieLtT4 = Lt4, --zmiana wartosci przez calkowita likwidacje                
        ZwiekszenieT4w = s4zw,	-- zwiekszenia wartosci inw. korekty po tej samej stronie co pierwotny T4                
        ZmniejszenieT4w = s4zm,	-- zmniejszenia wartosci inw. korekty po tej samej stronie co pierwotny T4                
                
        ZwiekszenieT4Sys = s4Sys - n4Sys, --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam)                
        ZwiekszeniePlusT4Sys = s4Sys - n4Sys - (s_min4Sys - n_min4Sys), --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam) tylko z wartoscia dodatnia                
        ZwiekszenieMiesT4Sys = s4Sys, --zwiekszenie wystawione w danym miesiacu                
        ZwiekszenieMsObow2T4Sys = n4Sys, --zwiekszenie wystawione w danym miesiacu, obowiazujace w nastepnym                
        ZwiekszenieLtT4Sys = Lt4Sys, --zmiana wartosci przez calkowita likwidacje                
        ZwiekszenieT4wSys = s4zwSys,	-- zwiekszenia wartosci inw. korekty po tej samej stronie co pierwotny T4                
        ZmniejszenieT4wSys = s4zmSys,	-- zmniejszenia wartosci inw. korekty po tej samej stronie co pierwotny T4
				
		ZwiekszenieT5 = s5 - n5, --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam)                
        ZwiekszeniePlusT5 = s5 - n5 - (s_min5 - n_min5), --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam) tylko z wartoscia dodatnia                
        ZwiekszenieMiesT5 = s5, --zwiekszenie wystawione w danym miesiacu                
        ZwiekszenieMsObow2T5 = n5, --zwiekszenie wystawione w danym miesiacu, obowiazujace w nastepnym                
        ZwiekszenieLtT5 = Lt5, --zmiana wartosci przez calkowita likwidacje                
        ZwiekszenieT5w = s5zw,	-- zwiekszenia wartosci inw. korekty po tej samej stronie co pierwotny T5                
        ZmniejszenieT5w = s5zm,	-- zmniejszenia wartosci inw. korekty po tej samej stronie co pierwotny T5                
                
        ZwiekszenieT5Sys = s5Sys - n5Sys, --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam)                
        ZwiekszeniePlusT5Sys = s5Sys - n5Sys - (s_min5Sys - n_min5Sys), --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac obow ten sam) tylko z wartoscia dodatnia                
        ZwiekszenieMiesT5Sys = s5Sys, --zwiekszenie wystawione w danym miesiacu                
        ZwiekszenieMsObow2T5Sys = n5Sys, --zwiekszenie wystawione w danym miesiacu, obowiazujace w nastepnym                
        ZwiekszenieLtT5Sys = Lt5Sys, --zmiana wartosci przez calkowita likwidacje                
        ZwiekszenieT5wSys = s5zwSys,	-- zwiekszenia wartosci inw. korekty po tej samej stronie co pierwotny T5                
        ZmniejszenieT5wSys = s5zmSys	-- zmniejszenia wartosci inw. korekty po tej samej stronie co pierwotny T5
				
        , PrzylaczenieT1 = przylaczenie1, OdlaczenieT1 = odlaczenie1, PrzylaczenieT2 = przylaczenie2, OdlaczenieT2 = odlaczenie2
		, PrzylaczenieT1Sys = przylaczenie1Sys, OdlaczenieT1Sys = odlaczenie1Sys, PrzylaczenieT2Sys = przylaczenie2Sys, OdlaczenieT2Sys = odlaczenie2Sys
	
    from #tmpOdpisy inner join #tmpZwiekszenia on cdn.DateDiffClarion(2, 0, DataClarion1) = mies

		

    --miesiac nastepny
    update #tmpOdpisy set
        ZwiekszenieT1 = isnull(ZwiekszenieT1,0) + isnull(n1,0), --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac nastepny)
        ZwiekszenieT2 = isnull(ZwiekszenieT2,0) + isnull(n2,0),
        ZwiekszeniePlusT1 = isnull(ZwiekszeniePlusT1,0) + (isnull(n1,0) - isnull(n_min1,0)), --zwiekszenie dodatne
        ZwiekszeniePlusT2 = isnull(ZwiekszeniePlusT2,0) + (isnull(n2,0) - isnull(n_min2,0)),
                
        ZwiekszenieT1Sys = isnull(ZwiekszenieT1Sys,0) + isnull(n1Sys,0), --zwiekszenie obowiazujace jako podstawa w danym miesiacu (miesiac nastepny)
        ZwiekszenieT2Sys = isnull(ZwiekszenieT2Sys,0) + isnull(n2Sys,0),
        ZwiekszeniePlusT1Sys = isnull(ZwiekszeniePlusT1Sys,0) + (isnull(n1Sys,0) - isnull(n_min1Sys,0)), --zwiekszenie dodatne
        ZwiekszeniePlusT2Sys = isnull(ZwiekszeniePlusT2Sys,0) + (isnull(n2Sys,0) - isnull(n_min2Sys,0))

		,ZwiekszenieT3 = isnull(ZwiekszenieT3,0) + isnull(n3,0),                
        ZwiekszeniePlusT3 = isnull(ZwiekszeniePlusT3,0) + (isnull(n3,0) - isnull(n_min3,0)),                
        ZwiekszenieT3Sys = isnull(ZwiekszenieT3Sys,0) + isnull(n3Sys,0),                
        ZwiekszeniePlusT3Sys = isnull(ZwiekszeniePlusT3Sys,0) + (isnull(n3Sys,0) - isnull(n_min3Sys,0))

		,ZwiekszenieT4 = isnull(ZwiekszenieT4,0) + isnull(n4,0),                
        ZwiekszeniePlusT4 = isnull(ZwiekszeniePlusT4,0) + (isnull(n4,0) - isnull(n_min4,0)),                
        ZwiekszenieT4Sys = isnull(ZwiekszenieT4Sys,0) + isnull(n4Sys,0),                
        ZwiekszeniePlusT4Sys = isnull(ZwiekszeniePlusT4Sys,0) + (isnull(n4Sys,0) - isnull(n_min4Sys,0))

		,ZwiekszenieT5 = isnull(ZwiekszenieT5,0) + isnull(n5,0),                
        ZwiekszeniePlusT5 = isnull(ZwiekszeniePlusT5,0) + (isnull(n5,0) - isnull(n_min5,0)),                
        ZwiekszenieT5Sys = isnull(ZwiekszenieT5Sys,0) + isnull(n5Sys,0),                
        ZwiekszeniePlusT5Sys = isnull(ZwiekszeniePlusT5Sys,0) + (isnull(n5Sys,0) - isnull(n_min5Sys,0))
    from #tmpZwiekszenia where cdn.DateDiffClarion(2, 0, DataClarion1) = mies + 1

    delete from #tmpZwiekszenia

set nocount off
end
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="SrtPlanAmort_OdpisyAm"></A><PRE>
          <FONT SIZE="2"><I>/* SrtPlanAmort_OdpisyAm */</I><BR>
CREATE PROCEDURE cdn.SrtPlanAmort_OdpisyAm (@Srt_GIDNumer INT, @SHE_GIDTyp int, @SHE_GIDNumer int, @SHE_GIDLp int		, @_Debug smallint	
	,@RokOdC int
	,@RokDoC int
	,@Srt_PodlegaAMP smallint 
	,@AMPUmorzenie smallint
	,@DataKoniecPierwszyRP_C int
	,@SrtGIDNumerPierwszeOT int
	,@Srt_MsNaliczania int
	,@Srt_MsNaliczaniaAm smallint
	,@Srt_MsNaliczaniaT3 int
	,@Srt_MsNaliczaniaT4 int
	,@Srt_MsNaliczaniaT5 int
	,@NaDzienC int
	,@DataZapisuC int	
	) as
begin
set nocount on

	declare @ZO smallint= 2144,@ZM smallint= 2160,@OT smallint= 2048,@OTK smallint= 2176, @PK smallint= 2080,@LT smallint= 2096,@LTK smallint= 2224,
	@AM smallint= 2064,@AMK smallint= 2192,@AMP smallint= 6208,@AK smallint= 2304,@ZW smallint= 2288,@RN smallint= 2128,@WN smallint= 2112,@MW smallint= 2432,
	@MWK smallint= 2496,@ZKZ smallint= 2552,@ZSA smallint= 2556,@ZMT smallint= 2548,@RT smallint= 2532,@NT smallint= 2536;	


		--ustaw odpisy uwzgl. AM+AMK+AK+AMP-LT-LTK+PK+MW+MWK (z dokladnoscia do dnia) (MW, MWK wg mies obow)
        --insert into #tmpZwiekszenia
    select mies,
        sum(case when she_gidtyp  in (@LT, @LTK) then -1*s1 else s1 end) as s1,
        sum(case when she_gidtyp  in (@LT, @LTK) then -1*s2 else s2 end) as s2,
		sum(case when she_gidtyp  in (@LT, @LTK) then -1*s3 else s3 end) as s3,
		sum(case when she_gidtyp  in (@LT, @LTK) then -1*s4 else s4 end) as s4,
		sum(case when she_gidtyp  in (@LT, @LTK) then -1*s5 else s5 end) as s5,
                
		sum(case when (she_gidtyp = @MW or she_gidtyp = @MWK or she_gidtyp = @AK or she_gidtyp = @PK) then s1
                    when she_gidtyp = @LT and isnull(She_Likwidacja,0) = 0 then -1*s1
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) = 0 then -1*s1
                    else 0
        end) as n1, --odpisy zmieniajace netto teoret / T1

        sum(case when (she_gidtyp = @MW or she_gidtyp = @MWK or she_gidtyp = @PK) then s2 else 0 end) as n2, --odpisy zmieniajace netto teoret / T2

		sum(case when (she_gidtyp = @MW or she_gidtyp = @MWK or she_gidtyp = @AK or she_gidtyp = @PK) then s3
                    when she_gidtyp = @LT and isnull(She_Likwidacja,0) = 0 then -1*s3
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) = 0 then -1*s3
                    else 0
        end) as n3, --odpisy zmieniajace netto teoret / T3

		sum(case when (she_gidtyp = @MW or she_gidtyp = @MWK or she_gidtyp = @AK or she_gidtyp = @PK) then s4
                    when she_gidtyp = @LT and isnull(She_Likwidacja,0) = 0 then -1*s4
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) = 0 then -1*s4
                    else 0
        end) as n4, --odpisy zmieniajace netto teoret / T4

		sum(case when (she_gidtyp = @MW or she_gidtyp = @MWK or she_gidtyp = @AK or she_gidtyp = @PK) then s5
                    when she_gidtyp = @LT and isnull(She_Likwidacja,0) = 0 then -1*s5
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) = 0 then -1*s5
                    else 0
        end) as n5, --odpisy zmieniajace netto teoret / T5

        sum(case when (she_gidtyp = @MW or she_gidtyp = @MWK) then amLikw
                    when she_gidtyp = @LT and isnull(She_Likwidacja,0) = 0 then -1*amLikw
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) = 0 then -1*amLikw
                    else 0
        end) as amLikw, --	s3, --odpisy zmieniajace netto teoret (tylko dla toru amortyzacji zmniejszenie/likwidacja czesciowa)

        sum(case she_gidtyp when @AMP then s1 else 0 end) as s_min1, --odpisy przyspieszone
        sum(case she_gidtyp when @AMP then s2 else 0 end) as s_min2, --odpisy przyspieszone
		sum(case she_gidtyp when @AMP then s3 else 0 end) as s_min3, --odpisy przyspieszone
		sum(case she_gidtyp when @AMP then s4 else 0 end) as s_min4, --odpisy przyspieszone
		sum(case she_gidtyp when @AMP then s5 else 0 end) as s_min5, --odpisy przyspieszone

        cast(0 as decimal(15,2)) as n_min1,
        cast(0 as decimal(15,2)) as n_min2,
		cast(0 as decimal(15,2)) as n_min3,
		cast(0 as decimal(15,2)) as n_min4,
		cast(0 as decimal(15,2)) as n_min5,

        sum(case when she_gidtyp = @LT and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s1
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s1
                    else 0
        end) as Lt1,
        sum(case when she_gidtyp = @LT and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s2
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s2
                    else 0
        end) as Lt2,
		sum(case when she_gidtyp = @LT and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s3
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s3
                    else 0
        end) as Lt3,
		sum(case when she_gidtyp = @LT and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s4
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s4
                    else 0
        end) as Lt4,
		sum(case when she_gidtyp = @LT and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s5
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s5
                    else 0
        end) as Lt5,

        SUM(case when SHE_GIDTyp = @AK and s1 &gt; 0 then s1 else 0 end) ZwAK,			--?? do zastanowienia wielotorowosc		czy AK było tylko dla toru bilansowego, co z nowymi torami?
        SUM(case when SHE_GIDTyp = @AK and s1 &lt; 0 then s1 else 0 end) ZmAK,			--?? do zastanowienia wielotorowosc
                
        ---------------------------
        sum(case when SHE_Data between @RokOdC and @RokDoC then
					case 
					when she_gidtyp in (@LT, @LTK) then 0
					when she_gidtyp in (@OTK, @MWK) then		
						case when ZnakDokPierwotnego &amp; 1 &gt; 0 then s1 else 0 end
					else
						case when s1 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then s1 else 0 end
					end 
			else 0 end
		) as s1zw, --	s1w
								
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @MWK) then 		
					case when ZnakDokPierwotnego &amp; 2 &gt; 0 then s2 else 0 end
				else
					case when s2 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then s2 else 0 end
				end else 0 end
		) as s2zw,	-- s2w,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @MWK) then 		
					case when ZnakDokPierwotnego &amp; 4 &gt; 0 then s3 else 0 end
				else
					case when s3 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then s3 else 0 end
				end else 0 end
		) as s3zw,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @MWK) then 		
					case when ZnakDokPierwotnego &amp; 8 &gt; 0 then s4 else 0 end
				else
					case when s4 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then s4 else 0 end
				end else 0 end
		) as s4zw,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @MWK) then 		
					case when ZnakDokPierwotnego &amp; 16 &gt; 0 then s5 else 0 end
				else
					case when s5 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then s5 else 0 end
				end else 0 end
		) as s5zw,
				
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s1
				when she_gidtyp in (@OTK, @MWK) then
					case when ZnakDokPierwotnego &amp; 1 = 0 then s1 else 0 end
				else
					case when s1 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then 0 else s1 end
				end else 0 end
		) as s1zm,	-- s3w,				
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s2
				when she_gidtyp in (@OTK, @MWK) then 
					case when ZnakDokPierwotnego &amp; 2 = 0 then s2 else 0 end
				else
					case when s2 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then 0 else s2 end
				end else 0 end
		) as s2zm,	-- s4w,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s3
				when she_gidtyp in (@OTK, @MWK) then 
					case when ZnakDokPierwotnego &amp; 4 = 0 then s3 else 0 end
				else
					case when s3 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then 0 else s3 end
				end else 0 end
		) as s3zm,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s4
				when she_gidtyp in (@OTK, @MWK) then 
					case when ZnakDokPierwotnego &amp; 8 = 0 then s4 else 0 end
				else
					case when s4 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then 0 else s4 end
				end else 0 end
		) as s4zm,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s5
				when she_gidtyp in (@OTK, @MWK) then 
					case when ZnakDokPierwotnego &amp; 16 = 0 then s5 else 0 end
				else
					case when s5 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then 0 else s5 end
				end else 0 end
		) as s5zm,
		--- sys
								
        sum(case when she_gidtyp  in (@LT, @LTK) then -1*s1Sys else s1Sys end) as s1Sys,
        sum(case when she_gidtyp  in (@LT, @LTK) then -1*s2Sys else s2Sys end) as s2Sys,
		sum(case when she_gidtyp  in (@LT, @LTK) then -1*s3Sys else s3Sys end) as s3Sys,
		sum(case when she_gidtyp  in (@LT, @LTK) then -1*s4Sys else s4Sys end) as s4Sys,
		sum(case when she_gidtyp  in (@LT, @LTK) then -1*s5Sys else s5Sys end) as s5Sys,
        sum(case when (she_gidtyp = @MW or she_gidtyp = @MWK or she_gidtyp = @AK or she_gidtyp = @PK ) then s1Sys		
                    when she_gidtyp = @LT and isnull(She_Likwidacja,0) = 0 then -1*s1Sys
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) = 0 then -1*s1Sys
                    else 0
        end) as n1Sys, --odpisy zmieniajace netto teoret / T1
        sum(case when (she_gidtyp = @MW or she_gidtyp = @MWK or she_gidtyp = @PK ) then s2Sys else 0 end) as n2Sys, --odpisy zmieniajace netto teoret / T2
		sum(case when (she_gidtyp = @MW or she_gidtyp = @MWK or she_gidtyp = @AK or she_gidtyp = @PK ) then s3Sys		
                    when she_gidtyp = @LT and isnull(She_Likwidacja,0) = 0 then -1*s3Sys
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) = 0 then -1*s3Sys
                    else 0
        end) as n3Sys,
		sum(case when (she_gidtyp = @MW or she_gidtyp = @MWK or she_gidtyp = @AK or she_gidtyp = @PK ) then s4Sys		
                    when she_gidtyp = @LT and isnull(She_Likwidacja,0) = 0 then -1*s4Sys
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) = 0 then -1*s4Sys
                    else 0
        end) as n4Sys,
		sum(case when (she_gidtyp = @MW or she_gidtyp = @MWK or she_gidtyp = @AK or she_gidtyp = @PK ) then s5Sys		
                    when she_gidtyp = @LT and isnull(She_Likwidacja,0) = 0 then -1*s5Sys
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) = 0 then -1*s5Sys
                    else 0
        end) as n5Sys,

        sum(case when (she_gidtyp = @MW or she_gidtyp = @MWK ) then amLikwSys	--s3Sys		--&amp;&amp;&amp; Zest
                    when she_gidtyp = @LT and isnull(She_Likwidacja,0) = 0 then -1*amLikwSys
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) = 0 then -1*amLikwSys
                    else 0
        end) as amLikwSys,	 -- s3Sys, --odpisy zmieniajace netto teoret (tylko dla toru amortyzacji zmniejszenie/likwidacja czesciowa)

        sum(case she_gidtyp when @AMP then s1Sys else 0 end) as s_min1Sys, --odpisy przyspieszone
        sum(case she_gidtyp when @AMP then s2Sys else 0 end) as s_min2Sys, --odpisy przyspieszone
		sum(case she_gidtyp when @AMP then s3Sys else 0 end) as s_min3Sys, --odpisy przyspieszone
		sum(case she_gidtyp when @AMP then s4Sys else 0 end) as s_min4Sys, --odpisy przyspieszone
		sum(case she_gidtyp when @AMP then s5Sys else 0 end) as s_min5Sys, --odpisy przyspieszone

        cast(0 as decimal(15,2)) as n_min1Sys,
        cast(0 as decimal(15,2)) as n_min2Sys,
		cast(0 as decimal(15,2)) as n_min3Sys,
		cast(0 as decimal(15,2)) as n_min4Sys,
		cast(0 as decimal(15,2)) as n_min5Sys,
        sum(case when she_gidtyp = @LT and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s1Sys
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s1Sys
                    else 0
        end) as Lt1Sys ,
        sum(case when she_gidtyp = @LT and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s2Sys
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s2Sys
                    else 0
        end) as Lt2Sys,
		sum(case when she_gidtyp = @LT and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s3Sys
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s3Sys
                    else 0
        end) as Lt3Sys,
		sum(case when she_gidtyp = @LT and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s4Sys
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s4Sys
                    else 0
        end) as Lt4Sys,
		sum(case when she_gidtyp = @LT and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s5Sys
                    when she_gidtyp = @LTK and isnull(She_Likwidacja,0) &lt;&gt; 0 then -1*s5Sys
                    else 0
        end) as Lt5Sys,

        SUM(case when SHE_GIDTyp = @AK and s1 &gt; 0 then s1Sys else 0 end) ZwAKSys,		--?? do zastanowienia wielotorowosc,		czy AK było tylko dla toru bilansowego i co z nowymi torami?
        SUM(case when SHE_GIDTyp = @AK and s1 &lt; 0 then s1Sys else 0 end) ZmAKSys,		--?? do zastanowienia wielotorowosc
                
        ---------------------------
        sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @MWK) 
				then
					case when ZnakDokPierwotnego IN (1, 3) then s1Sys else 0 end
				else
					case when s1 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then s1Sys else 0 end
				end else 0 end						
		) as s1zwSys,	--s1wSys,				
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @MWK) 
				then
					case when ZnakDokPierwotnego IN (2, 3) then s2Sys else 0 end
				else
					case when s2 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then s2Sys else 0 end
				end else 0 end
		) as s2zwSys,	-- s2wSys,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @MWK) 
				then
					case when ZnakDokPierwotnego &amp; 4 &gt; 0 then s3Sys else 0 end
				else
					case when s3 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then s3Sys else 0 end
				end else 0 end
		) as s3zwSys,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @MWK) 
				then
					case when ZnakDokPierwotnego &amp; 8 &gt; 0 then s4Sys else 0 end
				else
					case when s4 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then s4Sys else 0 end
				end else 0 end
		) as s4zwSys,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then 0
				when she_gidtyp in (@OTK, @MWK) 
				then
					case when ZnakDokPierwotnego &amp; 16 &gt; 0 then s5Sys else 0 end
				else
					case when s5 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then s5Sys else 0 end
				end else 0 end
		) as s5zwSys,

		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s1Sys
				when she_gidtyp in (@OTK, @MWK) 
				then		
					case when ZnakDokPierwotnego IN (0, 2) then s1Sys else 0 end
				else
					case when s1 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then 0 else s1Sys end
				end else 0 end
		) as s1zmSys,	-- s3wSys,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s2Sys
				when she_gidtyp in (@OTK, @MWK) 
				then		
					case when ZnakDokPierwotnego IN (0, 1) then s2Sys else 0 end
				else
					case when s2 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then 0 else s2Sys end
				end else 0 end
		) as s2zmSys,	-- s4wSys
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s3Sys
				when she_gidtyp in (@OTK, @MWK) 
				then		
					case when ZnakDokPierwotnego &amp; 4 &gt; 0 then s3Sys else 0 end
				else
					case when s3 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then 0 else s3Sys end
				end else 0 end
		) as s3zmSys,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s4Sys
				when she_gidtyp in (@OTK, @MWK) 
				then		
					case when ZnakDokPierwotnego &amp; 4 &gt; 0 then s4Sys else 0 end
				else
					case when s4 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then 0 else s4Sys end
				end else 0 end
		) as s4zmSys,
		sum(case when SHE_Data between @RokOdC and @RokDoC then
				case when she_gidtyp in (@LT, @LTK) then -1*s5Sys
				when she_gidtyp in (@OTK, @MWK) 
				then		
					case when ZnakDokPierwotnego &amp; 4 &gt; 0 then s5Sys else 0 end
				else
					case when s5 &gt; 0 OR SHE_GIDTyp in (@AM, @AMK) then 0 else s5Sys end
				end else 0 end
		) as s5zmSys
				
		, 0 as przylaczenie1, 0 as odlaczenie1, 0 as przylaczenie2, 0 as odlaczenie2, 0 as przylaczenie1Sys, 0 as odlaczenie1Sys, 0 as przylaczenie2Sys, 0 as odlaczenie2Sys

		, max(SHE_T1) SHE_T1, max(SHE_T2) SHE_T2, max(SHE_T3) SHE_T3, max(SHE_T4) SHE_T4, max(SHE_T5) SHE_T5
	into #tmpZwiekszenia		
    from (  select she_data, cdn.datediffclarion(2, 0, she_data) as mies, she_gidtyp, SHE_KwotaUm as s1, SHE_KwotaAm as s2, isnull(SHE_KwotaAm_Likw,0) as amLikw, She_Likwidacja, 
				SHE_KwotaUmSys as s1Sys, SHE_KwotaAmSys as s2Sys, isnull(SHE_KwotaAm_LikwSys,0) as amLikwSys,
				case when SHE_GIDTyp IN (@OTK, @LTK, @AMK, @MWK) then CDN.SrtKorDokPierwotnyZnak(SHE_GIDTyp, SHE_GIDNumer) else -1 end ZnakDokPierwotnego
				, SHE_KwotaAmTor3 as s3, SHE_KwotaAmTor3Sys as s3Sys
				, SHE_KwotaAmTor4 as s4, SHE_KwotaAmTor4Sys as s4Sys
				, SHE_KwotaAmTor5 as s5, SHE_KwotaAmTor5Sys as s5Sys
				, SHE_TorUm_Lp SHE_T1, SHE_TorAm_Lp SHE_T2, SHE_Tor3_Lp SHE_T3, SHE_Tor4_Lp SHE_T4, SHE_Tor5_Lp SHE_T5
				--, isnull(SHE_KwotaAm_Likw,0) as s3,	isnull(SHE_KwotaAm_LikwSys,0) as s3Sys		-- 20.09 - 01:27 --?? do zastanowienia wielotorowosc
            from cdn.srthistelem                
            where she_srtnumer = @Srt_GIDNumer  and
                    (@NaDzienC is null or ( not @NaDzienC is null and SHE_Data &lt;= @NaDzienC)) and
                    (@DataZapisuC is null or (not @DataZapisuC is null and SHE_DataZap &lt;= @DataZapisuC)) and
                    (she_gidtyp = @AM or she_gidtyp = @AMK or she_gidtyp = @AK or she_gidtyp = @AMP or
                    she_gidtyp = @LT or she_gidtyp = @LTK or she_gidtyp = @PK or she_gidtyp = @MW or she_gidtyp = @MWK )	
                    and ((@SHE_GIDNumer &lt;&gt; 0 and not (SHE_GIDTyp = @SHE_GIDTyp and SHE_GIDNumer = @SHE_GIDNumer and SHE_GIDLp = @SHE_GIDLp)) or @SHE_GIDNumer = 0)
    ) as a1
    group by mies
  
        

    update #tmpOdpisy set
        OdpisyT1 = s1,OdpisyT2 = s2,
        OdpisyAMPT1 = s_min1,OdpisyAMPT2 = s_min2,
        OdpisyPKT1 = n1,OdpisyPKT2 = n2,
        OdpisyT2_Likw = amLikw,OdpisyLtT1 = Lt1,OdpisyLtT2 = Lt2,
        OdpisyAktZw = ZwAK,OdpisyAktZm = ZmAK,
        OdpisyZwT1 = s1zw,OdpisyZwT2 = s2zw,		-- zwiekszenia amortyzacji łącznie z mwk (korekty po tej samej stronie co pierwotny)
        OdpisyZmT1 = s1zm,OdpisyZmT2 = s2zm,		--s3w,s4w	-- zmniejszenia amortyzacji łącznie z mwk (korekty po tej samej stronie co pierwotny
        -- sys
        OdpisyT1Sys = s1Sys,OdpisyT2Sys = s2Sys,
        OdpisyAMPT1Sys = s_min1Sys,OdpisyAMPT2Sys = s_min2Sys,
        OdpisyPKT1Sys = n1Sys,OdpisyPKT2Sys = n2Sys,
        OdpisyT2_LikwSys = amLikwSys,OdpisyLtT1Sys = Lt1Sys,OdpisyLtT2Sys = Lt2Sys,
        OdpisyAktZwSys = ZwAKSys,OdpisyAktZmSys = ZmAKSys,
        OdpisyZwT1Sys = s1zwSys,OdpisyZwT2Sys = s2zwSys,	-- zwiekszenia amortyzacji łącznie z mwk (korekty po tej samej stronie co pierwotny)
        OdpisyZmT1Sys = s1zmSys,OdpisyZmT2Sys = s2zmSys,	-- s3wSys,s4wSys	-- zmniejszenia amortyzacji łącznie z mwk (korekty po tej samej stronie co pierwotny
				
		OdpisyT3 = s3,OdpisyAMPT3 = s_min3,OdpisyPKT3 = n3,OdpisyLtT3 = Lt3,OdpisyZwT3 = s3zw,OdpisyZmT3 = s3zm,
		OdpisyT4 = s4,OdpisyAMPT4 = s_min4,OdpisyPKT4 = n4,OdpisyLtT4 = Lt4,OdpisyZwT4 = s4zw,OdpisyZmT4 = s4zm,
		OdpisyT5 = s5,OdpisyAMPT5 = s_min5,OdpisyPKT5 = n5,OdpisyLtT5 = Lt5,OdpisyZwT5 = s5zw,OdpisyZmT5 = s5zm,
		-- sys                
        OdpisyT3Sys = s3Sys,OdpisyAMPT3Sys = s_min3Sys,OdpisyPKT3Sys = n3Sys,OdpisyLtT3Sys = Lt3Sys,OdpisyZwT3Sys = s3zwSys,OdpisyZmT3Sys = s3zmSys,
		OdpisyT4Sys = s4Sys,OdpisyAMPT4Sys = s_min4Sys,OdpisyPKT4Sys = n4Sys,OdpisyLtT4Sys = Lt4Sys,OdpisyZwT4Sys = s4zwSys,OdpisyZmT4Sys = s4zmSys,
		OdpisyT5Sys = s5Sys,OdpisyAMPT5Sys = s_min5Sys,OdpisyPKT5Sys = n5Sys,OdpisyLtT5Sys = Lt5Sys,OdpisyZwT5Sys = s5zwSys,OdpisyZmT5Sys = s5zmSys
				
		--?? do zastanowienia wielotorowosc co to za pola, czy mają znaczenie dla nowych torów itd.				
		--OdpisyAktZw = ZwAK,	??
        --OdpisyAktZm = ZmAK,	??
        --OdpisyAktZwSys = ZwAKSys,
        --OdpisyAktZmSys = ZmAKSys,
		--, Tor1Lp = SHE_T1, Tor2Lp = SHE_T2, Tor3Lp = SHE_T3, Tor4Lp = SHE_T4, Tor5Lp = SHE_T5
    from #tmpZwiekszenia where cdn.DateDiffClarion(2, 0, DataClarion1) = mies
        

    --if @@ROWCOUNT &gt; 0 set @SaOdpisy = 1
        
    if object_id('tempdb..#tmpZwiekszenia') is not null Drop table #tmpZwiekszenia

set nocount off
end
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="SrtPlanAmort_StawkaWsp"></A><PRE>
          <FONT SIZE="2"><I>/* SrtPlanAmort_StawkaWsp */</I><BR>
CREATE PROCEDURE cdn.SrtPlanAmort_StawkaWsp (@Srt_GIDNumer INT, @SHE_GIDTyp int, @SHE_GIDNumer int, @SHE_GIDLp int
		,@DataZapisuC int
		,@DataNT_T1 int,@DataNT_T2 int,@DataNT_T3 int,@DataNT_T4 int,@DataNT_T5 int
		--,@SrtLpNT_T1 int,@SrtLpNT_T2 int,@SrtLpNT_T3 int,@SrtLpNT_T4 int,@SrtLpNT_T5 int
		, @_Debug smallint
) as
begin
	set nocount on

	declare @ZO smallint= 2144,@ZM smallint= 2160,@OT smallint= 2048,@OTK smallint= 2176, @PK smallint= 2080,@LT smallint= 2096,@LTK smallint= 2224,
		@AM smallint= 2064,@AMK smallint= 2192,@AMP smallint= 6208,@AK smallint= 2304,@ZW smallint= 2288,@RN smallint= 2128,@WN smallint= 2112,@MW smallint= 2432,
		@MWK smallint= 2496,@ZKZ smallint= 2552,@ZSA smallint= 2556,@ZMT smallint= 2548,@RT smallint= 2532,@NT smallint= 2536,
		@bitT1 tinyint = 1, @bitT2 tinyint = 2, @bitT3 tinyint = 4, @bitT4 tinyint = 8, @bitT5 tinyint = 16

	--wstawienie stawek z dokumentow ZSA, ZMT (uwzgl. miesiac obowiazywania)
	declare @cursData int,@cursSrtLp int,
		@cursMsObowT1 smallint,@cursMsObowT2 smallint,		
		@cursStawkaT1 decimal(7,2),@cursStawkaT2 decimal(7,2),
		@cursWspT1 decimal(7,2),@cursWspT2 decimal(7,2),@cursWspDegrT1 decimal(7,2),@cursWspDegrT2 decimal(7,2),
		@cursGIDTyp smallint,@cursTor smallint,
		@cursMsObowT3 smallint,@cursStawkaT3 decimal(7,2),@cursWspT3 decimal(7,2),@cursWspDegrT3 decimal(7,2),
		@cursMsObowT4 smallint,@cursStawkaT4 decimal(7,2),@cursWspT4 decimal(7,2),@cursWspDegrT4 decimal(7,2),
		@cursMsObowT5 smallint,@cursStawkaT5 decimal(7,2),@cursWspT5 decimal(7,2),@cursWspDegrT5 decimal(7,2),
		@cursTor1 smallint,@cursTor2 smallint,@cursTor3 smallint,@cursTor4 smallint,@cursTor5 smallint

	
	DECLARE StawkaCursor CURSOR
	FOR select She_Data, She_SrtLp, She_MsObow, She_MsObowAm, She_GIDTyp, She_Stawka, She_StawkaAm, She_Tor
			, SHE_MsObowAmTor3, SHE_StawkaAmTor3, SHE_MsObowAmTor4, SHE_StawkaAmTor4, SHE_MsObowAmTor5, SHE_StawkaAmTor5
			, SHE_TorUm_Lp, SHE_TorAm_Lp, SHE_Tor3_Lp, SHE_Tor4_Lp, SHE_Tor5_Lp
		from cdn.SrtHistElem
		where SHE_SrtNumer = @Srt_GIDNumer and SHE_GIDTyp in (@ZSA, @ZMT)
			and (@DataZapisuC is null or (not @DataZapisuC is null and SHE_DataZap &lt;= @DataZapisuC))
			and ((@SHE_GIDNumer &lt;&gt; 0 and not (SHE_GIDTyp = @SHE_GIDTyp and SHE_GIDNumer = @SHE_GIDNumer and SHE_GIDLp = @SHE_GIDLp)) or @SHE_GIDNumer = 0)
		order by She_Data, She_SrtLp

	OPEN StawkaCursor

	FETCH NEXT FROM StawkaCursor into @cursData, @cursSrtLp, @cursMsObowT1, @cursMsObowT2, @cursGIDTyp, @cursStawkaT1, @cursStawkaT2, @cursTor
		, @cursMsObowT3, @cursStawkaT3, @cursMsObowT4, @cursStawkaT4, @cursMsObowT5, @cursStawkaT5
		, @cursTor1, @cursTor2, @cursTor3, @cursTor4, @cursTor5
	WHILE (@@fetch_status &lt;&gt; -1)
	BEGIN
		IF (@@fetch_status &lt;&gt; -2)
		BEGIN      

			update #tmpOdpisy set StawkaRokT1 = @cursStawkaT1
			where 
				@DataNT_T1 = 0 AND
				(
					(@cursGIDTyp = @ZSA and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT1) &gt; 0 and
						((@cursMsObowT1 = 1 and DataClarion2 &gt;= @cursData) or
						(@cursMsObowT1 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)))
				) OR
				@DataNT_T1 &gt; 0 AND
				(
					--(@cursGIDTyp = @ZSA and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1 AND (@DataNT_T1 &lt; @cursData or (@DataNT_T1 = @cursData AND @SrtLpNT_T1 &lt; @cursSrtLp)) ) or
					(@cursGIDTyp = @ZSA and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1 AND (@DataNT_T1 &lt;= @cursData and @cursTor1 &gt; 0) ) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT1) &gt; 0 and
						((@cursMsObowT1 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T1) or		--(@cursData &gt; @DataNT_T1 or (@cursData = @DataNT_T1 and @SrtLpNT_T1 &lt; @cursSrtLp) )) or
						(@cursMsObowT1 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and @DataNT_T1 &lt;= @cursData)
				)

			update #tmpOdpisy set StawkaRokT2 = @cursStawkaT2
			where @DataNT_T2 = 0 AND
				(
					(@cursGIDTyp = @ZSA and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT2) &gt; 0 and
						((@cursMsObowT2 = 1 and DataClarion2 &gt;= @cursData) or
						(@cursMsObowT2 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)))
				)OR
				@DataNT_T2 &gt; 0 AND
				(
					(@cursGIDTyp = @ZSA and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1 AND @DataNT_T2 &lt;= @cursData and @cursTor2 &gt; 0 ) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT2) &gt; 0 and
						((@cursMsObowT2 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T2) or
						(@cursMsObowT2 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and @DataNT_T2 &lt;= @cursData)
				)

			update #tmpOdpisy set StawkaRokT3 = @cursStawkaT3
			where @DataNT_T3 = 0 AND
				(
					(@cursGIDTyp = @ZSA and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT3) &gt; 0 and
						((@cursMsObowT3 = 1 and DataClarion2 &gt;= @cursData) or
						(@cursMsObowT3 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)))
				) OR
				@DataNT_T3 &gt; 0 AND
				(
					(@cursGIDTyp = @ZSA and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1 AND @DataNT_T3 &lt;= @cursData  and @cursTor3 &gt; 0) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT3) &gt; 0 and
						((@cursMsObowT3 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T3) or
						(@cursMsObowT3 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and @DataNT_T3 &lt;= @cursData)
				)

			update #tmpOdpisy set StawkaRokT4 = @cursStawkaT4
			where @DataNT_T4 = 0 AND
				(
					(@cursGIDTyp = @ZSA and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT4) &gt; 0 and
						((@cursMsObowT4 = 1 and DataClarion2 &gt;= @cursData) or
						(@cursMsObowT4 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)))
				)OR
				@DataNT_T4 &gt; 0 AND
				(
					(@cursGIDTyp = @ZSA and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1 AND @DataNT_T4 &lt;= @cursData and @cursTor4 &gt; 0) or --cdn.DateDiffClarion(2, @DataNT_T4, @cursData) &gt;= 0 ) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT4) &gt; 0 and
						((@cursMsObowT4 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T4) or
						(@cursMsObowT4 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and @DataNT_T4 &lt;= @cursData)
				)

			update #tmpOdpisy set StawkaRokT5 = @cursStawkaT5
			where @DataNT_T5 = 0 AND
				(
					(@cursGIDTyp = @ZSA and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT5) &gt; 0 and
						((@cursMsObowT5 = 1 and DataClarion2 &gt;= @cursData) or
						(@cursMsObowT5 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)))
				)OR
				@DataNT_T5 &gt; 0 AND
				(
					(@cursGIDTyp = @ZSA and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1 AND @DataNT_T5 &lt;= @cursData  and @cursTor5 &gt; 0) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT5) &gt; 0 and
						((@cursMsObowT5 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T5) or
						(@cursMsObowT5 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and @DataNT_T5 &lt;= @cursData)
				)
		END
		FETCH NEXT FROM StawkaCursor into @cursData, @cursSrtLp, @cursMsObowT1, @cursMsObowT2, @cursGIDTyp, @cursStawkaT1, @cursStawkaT2, @cursTor
			, @cursMsObowT3, @cursStawkaT3, @cursMsObowT4, @cursStawkaT4, @cursMsObowT5, @cursStawkaT5
			, @cursTor1, @cursTor2, @cursTor3, @cursTor4, @cursTor5
	END
	CLOSE StawkaCursor
	DEALLOCATE StawkaCursor
			
	


	--wstawienie wspolczynnikow z dokumentow ZW, ZMT (uwzgl miesiac obowiazywania)
	DECLARE WspCursor CURSOR
	FOR select She_Data, She_SrtLp, She_MsObow, She_MsObowAm, She_GIDTyp, She_WspUmAm, She_WspAm, She_WspDegr, She_WspDegrAm, She_Tor
			, SHE_MsObowAmTor3, SHE_WspAmTor3, SHE_WspDegrTor3, SHE_MsObowAmTor4, SHE_WspAmTor4, SHE_WspDegrTor4, SHE_MsObowAmTor5, SHE_WspAmTor5, SHE_WspDegrTor5
			, SHE_TorUm_Lp, SHE_TorAm_Lp, SHE_Tor3_Lp, SHE_Tor4_Lp, SHE_Tor5_Lp
		from cdn.SrtHistElem
		where SHE_SrtNumer = @Srt_GIDNumer
			and (SHE_GIDTyp in (@ZW, @ZMT))
			and (@DataZapisuC is null or (not @DataZapisuC is null and SHE_DataZap &lt;= @DataZapisuC))
			and ((@SHE_GIDNumer &lt;&gt; 0 and not (SHE_GIDTyp = @SHE_GIDTyp and SHE_GIDNumer = @SHE_GIDNumer and SHE_GIDLp = @SHE_GIDLp)) or @SHE_GIDNumer = 0)
		order by She_Data, She_SrtLp

	OPEN WspCursor

	FETCH NEXT FROM WspCursor into @cursData, @cursSrtLp, @cursMsObowT1, @cursMsObowT2, @cursGIDTyp, @cursWspT1, @cursWspT2, @cursWspDegrT1, @cursWspDegrT2, @cursTor
		, @cursMsObowT3, @cursWspT3, @cursWspDegrT3, @cursMsObowT4, @cursWspT4, @cursWspDegrT4, @cursMsObowT5, @cursWspT5, @cursWspDegrT5
		, @cursTor1, @cursTor2, @cursTor3, @cursTor4, @cursTor5
	WHILE (@@fetch_status &lt;&gt; -1)
	BEGIN
		IF (@@fetch_status &lt;&gt; -2)
		BEGIN

			update #tmpOdpisy set WspT1 = @cursWspT1, WspDegrT1 = @cursWspDegrT1
			where 
				@DataNT_T1 = 0 AND
				(
					(@cursGIDTyp = @ZW and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT1) &gt; 0 and
						((@cursMsObowT1 = 1 and DataClarion2 &gt;= @cursData) or
						(@cursMsObowT1 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)))
				) OR
				@DataNT_T1 &gt; 0 AND
				(
					(@cursGIDTyp = @ZW and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1 AND @DataNT_T1 &lt;= @cursData and @cursTor1 &gt; 0) or						
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT1) &gt; 0 and
						((@cursMsObowT1 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T1) or
						(@cursMsObowT1 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and @DataNT_T1 &lt;= @cursData)
				)

			update #tmpOdpisy set WspT2 = @cursWspT2, WspDegrT2 = @cursWspDegrT2
			where @DataNT_T2 = 0 AND
				(
					(@cursGIDTyp = @ZW and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT2) &gt; 0 and
						((@cursMsObowT2 = 1 and DataClarion2 &gt;= @cursData) or
						(@cursMsObowT2 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)))
				)OR
				@DataNT_T2 &gt; 0 AND
				(
					(@cursGIDTyp = @ZW and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1 AND @DataNT_T2 &lt;= @cursData and @cursTor2 &gt; 0 ) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT2) &gt; 0 and
						((@cursMsObowT2 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T2) or
						(@cursMsObowT2 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and @DataNT_T2 &lt;= @cursData)
				)

			update #tmpOdpisy set WspT3 = @cursWspT3, WspDegrT3 = @cursWspDegrT3
			where @DataNT_T3 = 0 AND
				(
					(@cursGIDTyp = @ZW and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT3) &gt; 0 and
						((@cursMsObowT3 = 1 and DataClarion2 &gt;= @cursData) or
						(@cursMsObowT3 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)))
				) OR
				@DataNT_T3 &gt; 0 AND
				(
					(@cursGIDTyp = @ZW and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1 AND @DataNT_T3 &lt;= @cursData and @cursTor3 &gt; 0 ) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT3) &gt; 0 and
						((@cursMsObowT3 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T3) or
						(@cursMsObowT3 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and @DataNT_T3 &lt;= @cursData)
				)
				
			update #tmpOdpisy set WspT4 = @cursWspT4, WspDegrT4 = @cursWspDegrT4
			where @DataNT_T4 = 0 AND
				(
					(@cursGIDTyp = @ZW and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT4) &gt; 0 and
						((@cursMsObowT4 = 1 and DataClarion2 &gt;= @cursData) or
						(@cursMsObowT4 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)))
				)OR
				@DataNT_T4 &gt; 0 AND
				(
					(@cursGIDTyp = @ZW and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1 AND @DataNT_T4 &lt;= @cursData and @cursTor4 &gt; 0) or --cdn.DateDiffClarion(2, @DataNT_T4, @cursData) &gt;= 0 ) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT4) &gt; 0 and
						((@cursMsObowT4 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T4) or
						(@cursMsObowT4 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and @DataNT_T4 &lt;= @cursData)
				)
							
			update #tmpOdpisy set WspT5 = @cursWspT5, WspDegrT5 = @cursWspDegrT5
			where @DataNT_T5 = 0 AND
				(
					(@cursGIDTyp = @ZW and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT5) &gt; 0 and
						((@cursMsObowT5 = 1 and DataClarion2 &gt;= @cursData) or
						(@cursMsObowT5 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)))
				)OR
				@DataNT_T5 &gt; 0 AND
				(
					(@cursGIDTyp = @ZW and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1 AND @DataNT_T5 &lt;= @cursData and @cursTor5 &gt; 0 ) or
					(@cursGIDTyp = @ZMT and (@cursTor &amp; @bitT5) &gt; 0 and
						((@cursMsObowT5 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T5) or
						(@cursMsObowT5 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and @DataNT_T5 &lt;= @cursData)
				)



		END
		FETCH NEXT FROM WspCursor into @cursData, @cursSrtLp, @cursMsObowT1, @cursMsObowT2, @cursGIDTyp, @cursWspT1, @cursWspT2, @cursWspDegrT1, @cursWspDegrT2, @cursTor
			, @cursMsObowT3, @cursWspT3, @cursWspDegrT3, @cursMsObowT4, @cursWspT4, @cursWspDegrT4, @cursMsObowT5, @cursWspT5, @cursWspDegrT5
			, @cursTor1, @cursTor2, @cursTor3, @cursTor4, @cursTor5
	END
	CLOSE WspCursor
	DEALLOCATE WspCursor


set nocount off
end
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="SrtPlanAmort_Metoda"></A><PRE>
          <FONT SIZE="2"><I>/* SrtPlanAmort_Metoda */</I><BR>
CREATE PROCEDURE cdn.SrtPlanAmort_Metoda (@Srt_GIDNumer INT, @SHE_GIDTyp int, @SHE_GIDNumer int, @SHE_GIDLp int
		,@DataZapisuC int, @Srt_Metoda_Jednorazowa tinyint	
		,@DataNT_T1 int,@DataNT_T2 int,@DataNT_T3 int,@DataNT_T4 int,@DataNT_T5 int
) as
begin
	set nocount on

	declare @ZO smallint= 2144,@ZM smallint= 2160,@OT smallint= 2048,@OTK smallint= 2176, @PK smallint= 2080,@LT smallint= 2096,@LTK smallint= 2224,
		@AM smallint= 2064,@AMK smallint= 2192,@AMP smallint= 6208,@AK smallint= 2304,@ZW smallint= 2288,@RN smallint= 2128,@WN smallint= 2112,@MW smallint= 2432,
		@MWK smallint= 2496,@ZKZ smallint= 2552,@ZSA smallint= 2556,@ZMT smallint= 2548,@RT smallint= 2532,@NT smallint= 2536,
		@bitT1 tinyint = 1, @bitT2 tinyint = 2, @bitT3 tinyint = 4, @bitT4 tinyint = 8, @bitT5 tinyint = 16


	declare @cursData int,@cursSrtLp int,
		@cursMsObowT1 smallint,@cursMsObowT2 smallint,
		@cursMetodaT1 smallint,@cursMetodaT2 smallint,		
		@cursGIDTyp smallint,@cursTor smallint,
		@cursMsObowT3 smallint,@cursMetodaT3 smallint,
		@cursMsObowT4 smallint,@cursMetodaT4 smallint,
		@cursMsObowT5 smallint,@cursMetodaT5 smallint,
		@cursTor1 smallint,@cursTor2 smallint,@cursTor3 smallint,@cursTor4 smallint,@cursTor5 smallint


	-- zmiana metody	
	if @Srt_Metoda_Jednorazowa &gt; 0
	begin
		DECLARE MetodaCursor CURSOR
		FOR select She_Data, She_SrtLp, She_MsObow, She_MsObowAm, She_MetodaUm, She_MetodaAm, She_Tor
				, SHE_MsObowAmTor3, SHE_MsObowAmTor4, SHE_MsObowAmTor5
				, SHE_MetodaAmTor3, SHE_MetodaAmTor4, SHE_MetodaAmTor5
				, SHE_TorUm_Lp, SHE_TorAm_Lp, SHE_Tor3_Lp, SHE_Tor4_Lp, SHE_Tor5_Lp
			from cdn.SrtHistElem
			where SHE_SrtNumer = @Srt_GIDNumer and SHE_GIDTyp = @ZMT
				and (@DataZapisuC is null or (not @DataZapisuC is null and SHE_DataZap &lt;= @DataZapisuC))
				and ((@SHE_GIDNumer &lt;&gt; 0 and not (SHE_GIDTyp = @SHE_GIDTyp and SHE_GIDNumer = @SHE_GIDNumer and SHE_GIDLp = @SHE_GIDLp)) or @SHE_GIDNumer = 0)
			order by She_Data, She_SrtLp

		OPEN MetodaCursor

		FETCH NEXT FROM MetodaCursor into @cursData, @cursSrtLp, @cursMsObowT1, @cursMsObowT2, @cursMetodaT1, @cursMetodaT2, @cursTor
			, @cursMsObowT3, @cursMsObowT4, @cursMsObowT5
			, @cursMetodaT3, @cursMetodaT4, @cursMetodaT5
			, @cursTor1, @cursTor2, @cursTor3, @cursTor4, @cursTor5
		WHILE (@@fetch_status &lt;&gt; -1)
		BEGIN
			IF (@@fetch_status &lt;&gt; -2)
			BEGIN

				--ustaw metody wg miesiaca obowiazywania

				update #tmpOdpisy set MetodaAmObowT1 = @cursMetodaT1
				where @DataNT_T1 = 0 AND
				(
					(@cursTor &amp; @bitT1) &gt; 0 and
						((@cursMsObowT1 = 1 and DataClarion2 &gt;= @cursData) or
						 (@cursMsObowT1 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1))
				) OR
				@DataNT_T1 &gt; 0 AND
				(
					(@cursTor &amp; @bitT1) &gt; 0 and
						((@cursMsObowT1 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T1) or
						 (@cursMsObowT1 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and 
					@DataNT_T1 &lt;= @cursData
				)

				update #tmpOdpisy set MetodaAmObowT2 = @cursMetodaT2
				where @DataNT_T2 = 0 AND
				(
					(@cursTor &amp; @bitT2) &gt; 0 and
						((@cursMsObowT2 = 1 and DataClarion2 &gt;= @cursData) or
						 (@cursMsObowT2 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1))
				) OR
				@DataNT_T2 &gt; 0 AND
				(
					(@cursTor &amp; @bitT2) &gt; 0 and
						((@cursMsObowT2 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T2) or
						 (@cursMsObowT2 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and 
					@DataNT_T2 &lt;= @cursData
				)
				
				update #tmpOdpisy set MetodaAmObowT3 = @cursMetodaT3
				where @DataNT_T3 = 0 AND
				(
					(@cursTor &amp; @bitT3) &gt; 0 and
						((@cursMsObowT3 = 1 and DataClarion2 &gt;= @cursData) or
						 (@cursMsObowT3 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1))
				) OR
				@DataNT_T3 &gt; 0 AND
				(
					(@cursTor &amp; @bitT3) &gt; 0 and
						((@cursMsObowT3 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T3) or
						 (@cursMsObowT3 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and 
					@DataNT_T3 &lt;= @cursData
				)
				
				update #tmpOdpisy set MetodaAmObowT4 = @cursMetodaT4
				where @DataNT_T4 = 0 AND
				(
					(@cursTor &amp; @bitT4) &gt; 0 and
						((@cursMsObowT4 = 1 and DataClarion2 &gt;= @cursData) or
						 (@cursMsObowT4 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1))
				) OR
				@DataNT_T4 &gt; 0 AND
				(
					(@cursTor &amp; @bitT4) &gt; 0 and
						((@cursMsObowT4 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T4) or
						 (@cursMsObowT4 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and 
					@DataNT_T4 &lt;= @cursData
				)

				update #tmpOdpisy set MetodaAmObowT5 = @cursMetodaT5
				where @DataNT_T5 = 0 AND
				(
					(@cursTor &amp; @bitT5) &gt; 0 and
						((@cursMsObowT5 = 1 and DataClarion2 &gt;= @cursData) or
						 (@cursMsObowT5 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1))
				) OR
				@DataNT_T5 &gt; 0 AND
				(
					(@cursTor &amp; @bitT5) &gt; 0 and
						((@cursMsObowT5 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T5) or
						 (@cursMsObowT5 = 2 and cdn.DateDiffClarion(2, @cursData, DataClarion2) &gt;= 1)) and 
					@DataNT_T5 &lt;= @cursData
				)


				--ustaw metody
				update #tmpOdpisy set  MetodaAmT1 = @cursMetodaT1
				where @DataNT_T1 = 0 AND
				(
					DataClarion2 &gt;= @cursData and (@cursTor &amp; @bitT1) &gt; 0
				) OR
				@DataNT_T1 &gt; 0 AND
				(
					(@cursTor &amp; @bitT1) &gt; 0 and
					(@cursMsObowT1 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T1) and 
					@DataNT_T1 &lt;= @cursData
				)

				update #tmpOdpisy set MetodaAmT2 = @cursMetodaT2
				where @DataNT_T2 = 0 AND
				(
					DataClarion2 &gt;= @cursData and (@cursTor &amp; @bitT2) &gt; 0
				) OR
				@DataNT_T2 &gt; 0 AND
				(
					(@cursTor &amp; @bitT2) &gt; 0 and
					(@cursMsObowT2 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T2) and 
					@DataNT_T2 &lt;= @cursData
				)

				update #tmpOdpisy set MetodaAmT3 = @cursMetodaT3
				where @DataNT_T3 = 0 AND
				(
					DataClarion2 &gt;= @cursData and (@cursTor &amp; @bitT3) &gt; 0
				) OR
				@DataNT_T3 &gt; 0 AND
				(
					(@cursTor &amp; @bitT3) &gt; 0 and
					(@cursMsObowT3 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T3) and 
					@DataNT_T3 &lt;= @cursData
				)

				update #tmpOdpisy set MetodaAmT4 = @cursMetodaT4
				where @DataNT_T4 = 0 AND
				(
					DataClarion2 &gt;= @cursData and (@cursTor &amp; @bitT4) &gt; 0
				) OR
				@DataNT_T4 &gt; 0 AND
				(
					(@cursTor &amp; @bitT4) &gt; 0 and
					(@cursMsObowT4 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T4) and 
					@DataNT_T4 &lt;= @cursData
				)

				update #tmpOdpisy set MetodaAmT5 = @cursMetodaT5
				where @DataNT_T5 = 0 AND
				(
					DataClarion2 &gt;= @cursData and (@cursTor &amp; @bitT5) &gt; 0
				) OR
				@DataNT_T5 &gt; 0 AND
				(
					(@cursTor &amp; @bitT5) &gt; 0 and
					(@cursMsObowT5 = 1 and DataClarion2 &gt;= @cursData and @cursData &gt; @DataNT_T5) and 
					@DataNT_T5 &lt;= @cursData
				)

			END
			FETCH NEXT FROM MetodaCursor into @cursData, @cursSrtLp, @cursMsObowT1, @cursMsObowT2, @cursMetodaT1, @cursMetodaT2, @cursTor
				, @cursMsObowT3, @cursMsObowT4, @cursMsObowT5, @cursMetodaT3, @cursMetodaT4, @cursMetodaT5
				, @cursTor1, @cursTor2, @cursTor3, @cursTor4, @cursTor5
		END
		CLOSE MetodaCursor
		DEALLOCATE MetodaCursor
	end


set nocount off
end
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>