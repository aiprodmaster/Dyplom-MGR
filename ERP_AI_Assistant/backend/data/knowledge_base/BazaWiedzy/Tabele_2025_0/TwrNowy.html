<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="[TwrNowy]"></A><PRE>
          <FONT SIZE="2"><I>/* [TwrNowy] */</I><BR>
CREATE PROCEDURE [CDN].[TwrNowy]
	--parametry wymagalne
	@twwGrpTyp SMALLINT
	, @twwGrpFirma INT
	, @twwGrpNumer INT
	, @OpeTyp SMALLINT
	, @OpeFirma INT
	, @OpeNumer INT
	, @Kod VARCHAR(40)
	--parametry wyjsciowe
	--      @ptwrGIDTyp smallint = 0 output,
	--      @ptwrGIDFirma int = 0 output,
	--		@ptwrGIDNumer int = 0 output,
	--parametry opcjonalne
	, @GIDTyp SMALLINT = NULL
	, @GIDFirma INT = NULL
	, @GIDNumer INT = NULL
	, @GIDLp SMALLINT = NULL
	, @Typ SMALLINT = NULL
	, @KodFormat VARCHAR(50) = NULL
	, @FPPKod VARCHAR(20) = NULL
	, @Nazwa VARCHAR(255) = NULL
	, @Nazwa1 VARCHAR(255) = NULL
	, @Certyfikat VARCHAR(40) = NULL
	, @Sww VARCHAR(20) = NULL
	, @Ean VARCHAR(40) = NULL
	, @Jm VARCHAR(8) = NULL
	, @Waga DECIMAL(7, 3) = NULL
	, @WJm VARCHAR(5) = NULL
	, @JmFormat SMALLINT = NULL
	, @IloscZam DECIMAL(11, 4) = NULL
	, @IloscMin DECIMAL(11, 4) = NULL
	, @IloscMax DECIMAL(11, 4) = NULL
	, @Ubytek DECIMAL(5, 2) = NULL
	, @Prog SMALLINT = NULL
	, @Upust SMALLINT = NULL
	, @UpustData SMALLINT = NULL
	, @UpustDataOd INT = NULL
	, @UpustDataDo INT = NULL
	, @UpustGodz SMALLINT = NULL
	, @UpustGodzOd INT = NULL
	, @UpustGodzDo INT = NULL
	, @AutoZam SMALLINT = NULL
	, @IloscAZam DECIMAL(11, 4) = NULL
	, @CzasDst INT = NULL
	, @CenaSpr SMALLINT = NULL
	, @JmDomyslna SMALLINT = NULL
	, @DstDomyslny SMALLINT = NULL
	, @RozliczMag SMALLINT = NULL
	, @Zakup SMALLINT = NULL
	, @Sprzedaz SMALLINT = NULL
	, @BlokujZmiane SMALLINT = NULL
	, @GrupaPod VARCHAR(1) = NULL
	, @Akcyza DECIMAL(5, 2) = NULL
	, @PrcTyp SMALLINT = NULL
	, @PrcFirma INT = NULL
	, @PrcNumer INT = NULL
	, @PrcLp SMALLINT = NULL
	, @KontaktTyp SMALLINT = NULL
	, @KontaktZa SMALLINT = NULL
	, @KontaktJC SMALLINT = NULL
	, @Okresowy SMALLINT = NULL
	, @Cel VARCHAR(200) = NULL
	, @Atrybut1 VARCHAR(20) = NULL
	, @Format1 SMALLINT = NULL
	, @Wartosc1 VARCHAR(20) = NULL
	, @Atrybut2 VARCHAR(20) = NULL
	, @Format2 SMALLINT = NULL
	, @Wartosc2 VARCHAR(20) = NULL
	, @Atrybut3 VARCHAR(20) = NULL
	, @Format3 SMALLINT = NULL
	, @Wartosc3 VARCHAR(20) = NULL
	, @Punkty DECIMAL(11, 2) = NULL
	, @Koncesja INT = NULL
	, @Konto1 VARCHAR(30) = NULL
	, @Konto2 VARCHAR(30) = NULL
	, @Konto3 VARCHAR(30) = NULL
	, @Polozenie VARCHAR(60) = NULL
	, @Katalog VARCHAR(40) = NULL
	, @WCenniku SMALLINT = NULL
	, @EdycjaNazwy SMALLINT = NULL
	, @BezRabatu SMALLINT = NULL
	, @KopiujOpis SMALLINT = NULL
	, @URL VARCHAR(255) = NULL
	, @Warunek VARCHAR(254) = NULL
	, @ObjetoscL DECIMAL(7, 2) = NULL
	, @ObjetoscM DECIMAL(5) = NULL
	, @LastModL INT = NULL
	, @LastModO INT = NULL
	, @LastModC INT = NULL
	, @TerminZwrotu INT = NULL
	, @ZakupAutoryz SMALLINT = NULL
	, @MagTyp SMALLINT = NULL
	, @MagFirma INT = NULL
	, @MagNumer INT = NULL
	, @MagLp SMALLINT = NULL
	, @MarzaMin DECIMAL(5, 2) = NULL
	, @KosztUslugi DECIMAL(15, 2) = NULL
	, @KosztUTyp SMALLINT = NULL
	, @CzasWykonania INT = NULL
	, @CzasWykonaniaJedn SMALLINT = NULL
	, @Clo DECIMAL(7, 2) = NULL
	, @PodatekImp DECIMAL(7, 2) = NULL
	, @StanInfoLimit SMALLINT = NULL
	, @StanInfoMax DECIMAL(15, 4) = NULL
	, @StanInfoProcent DECIMAL(3) = NULL
	, @Aktywna INT = NULL
	, @Wsk SMALLINT = NULL
	, @CCKTyp SMALLINT = NULL
	, @CCKFirma INT = NULL
	, @CCKNumer INT = NULL
	, @CCKLp SMALLINT = NULL
	, @PrdTyp SMALLINT = NULL
	, @PrdFirma INT = NULL
	, @PrdNumer INT = NULL
	, @PrdLp SMALLINT = NULL
	, @PCN VARCHAR(10) = NULL
	, @Notowania INT = NULL
	, @WagaBrutto DECIMAL(7, 3) = NULL
	, @WJmBrutto VARCHAR(5) = NULL
	, @GrupaPodSpr VARCHAR(1) = NULL
	, @Licencja SMALLINT = NULL
	, @Blokada SMALLINT = NULL
	, @Archiwalny SMALLINT = NULL
	, @JMCalkowita SMALLINT = NULL
	, @Oddzialowy SMALLINT = NULL
	, @JmDomyslnaZak SMALLINT = NULL
	, @KrajPoch VARCHAR(2) = NULL
	, @WspFin DECIMAL(10, 4) = NULL
	, @PobierzWgCech SMALLINT = NULL
	, @Kaucja SMALLINT = NULL
	, @SkNId INT = NULL
	, @RejWyposazenia SMALLINT = NULL
	, @OkresGwarancji INT = NULL
	, @GrupaWyposazenia INT = NULL
	, @ProdTechnologia INT = NULL
	, @ProdAktualnaWersja SMALLINT = NULL
	, @TwZOdNajwiekszego SMALLINT = NULL
	, @DataUtworzenia INT = NULL
	, @WymJm VARCHAR(5) = NULL
	, @PartiaDataW SMALLINT = NULL
	, @TerminW SMALLINT = NULL
	, @PartiaDostawa SMALLINT = NULL
	, @NrSeryjnyZCechy SMALLINT = NULL
	, @ESklep SMALLINT = NULL
	, @StawkaKGO INT = NULL
	, @DostawaEAN SMALLINT = NULL
	, @FlagaVat TINYINT = NULL
	, @Zrodlowa DECIMAL(5, 2) = NULL
	, @StawkaPod DECIMAL(5, 2) = NULL
	, @FlagaVatSpr TINYINT = NULL
	, @ZrodlowaSpr DECIMAL(5, 2) = NULL
	, @StawkaPodSpr DECIMAL(5, 2) = NULL
	, @MarkaId INT = NULL
	, @RejestrujUrzadzenie TINYINT = NULL
	, @RodzajUrzadzenia INT = NULL
	, @OpisUrzadzenia VARCHAR(511) = NULL
	, @Zlom TINYINT = NULL
	, @AnalizaABCYZ TINYINT = NULL
	--2013.3
	, @JMPulpitKnt INT = NULL
	, @JMiSklep INT = NULL
	, @PLM TINYINT = NULL
	, @MobSpr TINYINT = NULL
	, @RodzajId INT = NULL
	, @KategoriaABCXYZ VARCHAR(2) = NULL
	, @JMMobSpr SMALLINT = NULL
	, @Bon TINYINT = NULL
	, @RBoId INT = NULL
	--Procedura zakłada kartę towaru, dodaje odpowiednie zapisy w tabelach:
	--twrkarty,twrgrupy,twrgrupydom
	--Wersja 1.00   12.03.2010
	--	Parametry obowiązkowe:
	--      @twwGrpTyp      GIDTyp wzorca
	--      @twwGrpFirma    GIDFirma wzorca
	--      @twwGrpNumer    GIDNumer wzorca
	--      @OpeTyp         GIDTyp operatora zakładającego kartę towaru
	--      @OpeFirma       GIDFirma operatora zakładającego kartę towaru
	--      @OpeNumer       GIDNumer operatora zakładającego kartę towaru
	--      @Kod            Kod zakładanego towaru
	-- Pozostałe parametry są opcjonalne, wszystkie mają ustawiony default NULL i jeśli takie są to wartości tych pól brane
	-- są ze wzorca
AS
DECLARE @WartoscGIDFirma VARCHAR(20)
	, @F1 VARCHAR(10)
	, @F2 VARCHAR(10)
	, @F3 VARCHAR(10)
	, @Dzis INT
	, @DzisTS INT --2016.0.0 aktualny czas jako TimeStamp
	, @OkresID INT
	, @ptwrGIDTyp SMALLINT
	, @ptwrGIDFirma INT
	, @ptwrGIDNumer INT
DECLARE @W_OpeTyp SMALLINT
	, @W_OpeFirma INT
	, @W_OpeNumer INT
	, @W_Kod VARCHAR(40)
	, @W_GIDTyp SMALLINT
	, @W_GIDFirma INT
	, @W_GIDNumer INT
	, @W_GIDLp SMALLINT
	, @W_Typ SMALLINT
	, @W_KodFormat VARCHAR(50)
	, @W_FPPKod VARCHAR(20)
	, @W_Nazwa VARCHAR(255)
	, @W_Nazwa1 VARCHAR(255)
	, @W_Certyfikat VARCHAR(40)
	, @W_Sww VARCHAR(20)
	, @W_Ean VARCHAR(40)
	, @W_Jm VARCHAR(8)
	, @W_Waga DECIMAL(7, 3)
	, @W_WJm VARCHAR(5)
	, @W_JmFormat SMALLINT
	, @W_IloscZam DECIMAL(11, 4)
	, @W_IloscMin DECIMAL(11, 4)
	, @W_IloscMax DECIMAL(11, 4)
	, @W_Ubytek DECIMAL(5, 2)
	, @W_Prog SMALLINT
	, @W_Upust SMALLINT
	, @W_UpustData SMALLINT
	, @W_UpustDataOd INT
	, @W_UpustDataDo INT
	, @W_UpustGodz SMALLINT
	, @W_UpustGodzOd INT
	, @W_UpustGodzDo INT
	, @W_AutoZam SMALLINT
	, @W_IloscAZam DECIMAL(11, 4)
	, @W_CzasDst INT
	, @W_CenaSpr SMALLINT
	, @W_JmDomyslna SMALLINT
	, @W_DstDomyslny SMALLINT
	, @W_RozliczMag SMALLINT
	, @W_Zakup SMALLINT
	, @W_Sprzedaz SMALLINT
	, @W_BlokujZmiane SMALLINT
	, @W_GrupaPod VARCHAR(1)
	, @W_FlagaVat TINYINT
	, @W_Zrodlowa DECIMAL(5, 2)
	, @W_StawkaPod DECIMAL(5, 2)
	, @W_Akcyza DECIMAL(5, 2)
	, @W_PrcTyp SMALLINT
	, @W_PrcFirma INT
	, @W_PrcNumer INT
	, @W_PrcLp SMALLINT
	, @W_KontaktTyp SMALLINT
	, @W_KontaktZa SMALLINT
	, @W_KontaktJC SMALLINT
	, @W_Okresowy SMALLINT
	, @W_Cel VARCHAR(200)
	, @W_Atrybut1 VARCHAR(20)
	, @W_Format1 SMALLINT
	, @W_Wartosc1 VARCHAR(20)
	, @W_Atrybut2 VARCHAR(20)
	, @W_Format2 SMALLINT
	, @W_Wartosc2 VARCHAR(20)
	, @W_Atrybut3 VARCHAR(20)
	, @W_Format3 SMALLINT
	, @W_Wartosc3 VARCHAR(20)
	, @W_Punkty DECIMAL(11, 2)
	, @W_Koncesja INT
	, @W_Konto1 VARCHAR(30)
	, @W_Konto2 VARCHAR(30)
	, @W_Konto3 VARCHAR(30)
	, @W_Polozenie VARCHAR(60)
	, @W_Katalog VARCHAR(40)
	, @W_WCenniku SMALLINT
	, @W_EdycjaNazwy SMALLINT
	, @W_BezRabatu SMALLINT
	, @W_KopiujOpis SMALLINT
	, @W_URL VARCHAR(255)
	, @W_Warunek VARCHAR(254)
	, @W_ObjetoscL DECIMAL(7, 2)
	, @W_ObjetoscM DECIMAL(5)
	, @W_LastModL INT
	, @W_LastModO INT
	, @W_LastModC INT
	, @W_TerminZwrotu INT
	, @W_ZakupAutoryz SMALLINT
	, @W_MagTyp SMALLINT
	, @W_MagFirma INT
	, @W_MagNumer INT
	, @W_MagLp SMALLINT
	, @W_MarzaMin DECIMAL(5, 2)
	, @W_KosztUslugi DECIMAL(15, 2)
	, @W_KosztUTyp SMALLINT
	, @W_CzasWykonania INT
	, @W_CzasWykonaniaJedn SMALLINT
	, @W_Clo DECIMAL(7, 2)
	, @W_PodatekImp DECIMAL(7, 2)
	, @W_StanInfoLimit SMALLINT
	, @W_StanInfoMax DECIMAL(15, 4)
	, @W_StanInfoProcent DECIMAL(3)
	, @W_Aktywna INT
	, @W_Wsk SMALLINT
	, @W_CCKTyp SMALLINT
	, @W_CCKFirma INT
	, @W_CCKNumer INT
	, @W_CCKLp SMALLINT
	, @W_PrdTyp SMALLINT
	, @W_PrdFirma INT
	, @W_PrdNumer INT
	, @W_PrdLp SMALLINT
	, @W_PCN VARCHAR(10)
	, @W_Notowania INT
	, @W_WagaBrutto DECIMAL(7, 3)
	, @W_WJmBrutto VARCHAR(5)
	, @W_GrupaPodSpr VARCHAR(1)
	, @W_FlagaVatSpr TINYINT
	, @W_ZrodlowaSpr DECIMAL(5, 2)
	, @W_StawkaPodSpr DECIMAL(5, 2)
	, @W_Licencja SMALLINT
	, @W_Blokada SMALLINT
	, @W_Archiwalny SMALLINT
	, @W_JMCalkowita SMALLINT
	, @W_Oddzialowy SMALLINT
	, @W_JmDomyslnaZak SMALLINT
	, @W_KrajPoch VARCHAR(2)
	, @W_WspFin DECIMAL(10, 4)
	, @W_PobierzWgCech SMALLINT
	, @W_Kaucja SMALLINT
	, @W_SkNId INT
	, @W_RejWyposazenia SMALLINT
	, @W_OkresGwarancji INT
	, @W_GrupaWyposazenia INT
	, @W_ProdTechnologia INT
	, @W_ProdAktualnaWersja SMALLINT
	, @W_TwZOdNajwiekszego SMALLINT
	, @W_DataUtworzenia INT
	, @W_WymJm VARCHAR(5)
	, @W_PartiaDataW SMALLINT
	, @W_TerminW SMALLINT
	, @W_PartiaDostawa SMALLINT
	, @W_NrSeryjnyZCechy SMALLINT
	, @W_ESklep SMALLINT
	, @W_StawkaKGO INT
	, @W_DostawaEAN SMALLINT
	, @W_MarkaId INT
	, @W_Zlom TINYINT
	, @W_AnalizaABCYZ TINYINT
	--2013.3
	, @W_JMPulpitKnt INT
	, @W_JMiSklep INT
	, @W_PLM TINYINT
	, @W_MobSpr TINYINT
	, @W_RodzajId INT
	, @W_JMMobSpr TINYINT
	, @W_PIADostepnoscFlaga INT
	, @W_ObowPodSprId INT
	, @W_ObowPodZakId INT
	, @W_RodzajKosztu INT
	, @W_JMDopelnianiaMobSpr SMALLINT

SET NOCOUNT ON
SET @ptwrGIDTyp = 16

SELECT @WartoscGIDFirma = sys_wartosc
FROM cdn.systemcdn
WHERE sys_id = 2

SELECT @F1 = SUBSTRING(@WartoscGIDFirma, 0, PATINDEX('%.%', @WartoscGIDFirma))

SET @WartoscGIDFirma = SUBSTRING(@WartoscGIDFirma, PATINDEX('%.%', @WartoscGIDFirma) + 1, LEN(@WartoscGIDFirma))

SELECT @F2 = SUBSTRING(@WartoscGIDFirma, 0, PATINDEX('%.%', @WartoscGIDFirma))

SET @WartoscGIDFirma = SUBSTRING(@WartoscGIDFirma, PATINDEX('%.%', @WartoscGIDFirma) + 1, LEN(@WartoscGIDFirma))

SELECT @F3 = SUBSTRING(@WartoscGIDFirma, 0, PATINDEX('%.%', @WartoscGIDFirma))

SET @WartoscGIDFirma = SUBSTRING(@WartoscGIDFirma, PATINDEX('%.%', @WartoscGIDFirma) + 1, LEN(@WartoscGIDFirma))
SET @ptwrGIDFirma = CAST(@WartoscGIDFirma AS INT) + CAST(@F3 AS INT) * POWER(2, 8) + CAST(@F2 AS INT) * POWER(2, 16)

BEGIN TRANSACTION

SET @Dzis = DateDiff(d, convert(DATETIME, '1800-12-28', 120), getdate())
SET @DzisTS = datediff(s, '19900101', getdate())

SELECT @OkresID = Okr_ID
FROM cdn.Okresy
WHERE Okr_Poczatek &lt;= @Dzis
	AND Okr_Koniec &gt;= @Dzis

IF NOT EXISTS (
		SELECT *
		FROM cdn.TwrWzorce
		WHERE TwW_GrpTyp = @twwGrpTyp
			AND TwW_GrpNumer = @twwGrpNumer
		)
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Nie znaleziono wzorca towaru w tabeli TwrWzorce - (3)'
			, 16
			, 1
			)

	RETURN 3
END

IF NOT EXISTS (
		SELECT *
		FROM cdn.opekarty
		WHERE ope_gidtyp = @OpeTyp
			AND ope_gidnumer = @OpeNumer
		)
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Nie znaleziono operatora - (4)'
			, 16
			, 1
			)

	RETURN 4
END

IF @Archiwalny IS NOT NULL
BEGIN
	IF @Archiwalny NOT IN (
			0
			, 1
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Twr_Archiwalny - (32)'
				, 16
				, 1
				)

		RETURN 32
	END
END

IF @MarkaId IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.Slowniki
			INNER JOIN CDN.SlownikiStruktura ON SLW_SLSId = SLS_Id
			WHERE SLW_ID = @MarkaId
				AND SLS_Predefiniowany = 105 /*e_sls_MarkiTowarow*/
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa marka towaru - (33)'
				, 16
				, 1
				)

		RETURN 33
	END
END

IF @RejestrujUrzadzenie IS NOT NULL
BEGIN
	IF @RejestrujUrzadzenie NOT IN (
			0
			, 1
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa wartość pola Twr_RejestrujUrzadzenie - (34)'
				, 16
				, 1
				)

		RETURN 34
	END
END

IF @RodzajUrzadzenia IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.SrwUrzRodzaje
			WHERE SUR_Id = @RodzajUrzadzenia
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowy rodzaj urządzenia - (35)'
				, 16
				, 1
				)

		RETURN 35
	END
END

IF @RodzajId IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.Slowniki
			INNER JOIN CDN.SlownikiStruktura ON SLW_SLSId = SLS_Id
			WHERE SLW_ID = @RodzajId
				AND SLS_Predefiniowany = 117 /*e_sls_RodzajeTowarow*/
			)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nieprawidłowa marka towaru - (33)'
				, 16
				, 1
				)

		RETURN 33
	END
END



SELECT @W_Typ = TwW_Typ
	, @GIDFirma = @ptwrGIDFirma
	, @W_KodFormat = TwW_KodFormat
	, @W_Nazwa = TwW_Nazwa
	, @W_Nazwa1 = TwW_Nazwa1
	, @W_Certyfikat = TwW_Certyfikat
	, @W_Sww = TwW_Sww
	, @W_Jm = TwW_Jm
	, @W_Waga = TwW_Waga
	, @W_WJm = TwW_WJm
	, @W_JmFormat = TwW_JmFormat
	, @W_IloscZam = TwW_IloscZam
	, @W_IloscMin = TwW_IloscMin
	, @W_IloscMax = TwW_IloscMax
	, @W_Ubytek = TwW_Ubytek
	, @W_Prog = TwW_Prog
	, @W_Upust = TwW_Upust
	, @W_UpustData = TwW_UpustData
	, @W_UpustDataOd = TwW_UpustDataOd
	, @W_UpustDataDo = TwW_UpustDataDo
	, @W_UpustGodz = TwW_UpustGodz
	, @W_UpustGodzOd = TwW_UpustGodzOd
	, @W_UpustGodzDo = TwW_UpustGodzDo
	, @W_AutoZam = TwW_AutoZam
	, @W_IloscAZam = TwW_IloscAZam
	, @W_CzasDst = TwW_CzasDst
	, @W_CenaSpr = TwW_CenaSpr
	, @W_JmDomyslna = TwW_JmDomyslna
	, @W_DstDomyslny = TwW_DstDomyslny
	, @W_RozliczMag = TwW_RozliczMag
	, @W_Zakup = TwW_Zakup
	, @W_Sprzedaz = TwW_Sprzedaz
	, @W_BlokujZmiane = TwW_JMBlokujZmiane
	, @W_GrupaPod = TwW_GrupaPod
	, @W_FlagaVat = TwW_FlagaVat
	, @W_Zrodlowa = TwW_Zrodlowa
	, @W_StawkaPod = TwW_StawkaPod
	, @W_Akcyza = TwW_Akcyza
	--		,@W_PrcTyp 
	--		,@W_PrcFirma 
	--		,@W_PrcNumer 
	--		,@W_PrcLp 
	, @W_KontaktTyp = TwW_KontaktTyp
	, @W_KontaktZa = TwW_KontaktZa
	, @W_KontaktJC = TwW_KontaktJC
	, @W_Okresowy = TwW_Okresowy
	, @W_Cel = TwW_Cel
	, @W_Atrybut1 = TwW_Atrybut1
	, @W_Format1 = TwW_Format1
	, @W_Wartosc1 = TwW_Wartosc1
	, @W_Atrybut2 = TwW_Atrybut2
	, @W_Format2 = TwW_Format2
	, @W_Wartosc2 = TwW_Wartosc2
	, @W_Atrybut3 = TwW_Atrybut3
	, @W_Format3 = TwW_Format3
	, @W_Wartosc3 = TwW_Wartosc3
	, @W_Punkty = TwW_Punkty
	, @W_Koncesja = TwW_Koncesja
	, @W_Konto1 = TwW_Konto1
	, @W_Konto2 = TwW_Konto2
	, @W_Konto3 = TwW_Konto3
	, @W_Polozenie = TwW_Polozenie
	, @W_Katalog = TwW_Katalog
	, @W_WCenniku = TwW_WCenniku
	, @W_EdycjaNazwy = TwW_EdycjaNazwy
	, @W_BezRabatu = TwW_BezRabatu
	, @W_URL = TwW_URL
	, @W_Warunek = TwW_Warunek
	, @W_ObjetoscL = TwW_ObjetoscL
	, @W_ObjetoscM = TwW_ObjetoscM
	, @W_TerminZwrotu = TwW_TerminZwrotu
	, @W_ZakupAutoryz = TwW_ZakupAutoryz
	, @W_MagTyp = TwW_MagTyp
	, @W_MagFirma = TwW_MagFirma
	, @W_MagNumer = TwW_MagNumer
	, @W_MagLp = TwW_MagLp
	, @W_MarzaMin = TwW_MarzaMin
	, @W_KosztUslugi = TwW_KosztUslugi
	, @W_KosztUTyp = TwW_KosztUTyp
	, @W_CzasWykonania = TwW_CzasWykonania
	, @W_CzasWykonaniaJedn = TwW_CzasWykonaniaJedn
	, @W_Clo = TwW_Clo
	, @W_PodatekImp = TwW_PodatekImp
	, @W_StanInfoLimit = TwW_StanInfoLimit
	, @W_StanInfoMax = TwW_StanInfoMax
	, @W_StanInfoProcent = TwW_StanInfoProcent
	, @W_CCKTyp = TwW_CCKTyp
	, @W_CCKFirma = TwW_CCKFirma
	, @W_CCKNumer = TwW_CCKNumer
	, @W_CCKLp = TwW_CCKLp
	, @W_PrdTyp = TwW_PrdTyp
	, @W_PrdFirma = TwW_PrdFirma
	, @W_PrdNumer = TwW_PrdNumer
	, @W_PrdLp = TwW_PrdLp
	--		,@W_OpeTypM 
	--		,@W_OpeFirmaM 
	--		,@W_OpeNumerM 
	--		,@W_OpeLpM 
	, @W_PCN = TwW_PCN
	, @W_GrupaPodSpr = TwW_GrupaPodSpr
	, @W_FlagaVatSpr = TwW_FlagaVatSpr
	, @W_ZrodlowaSpr = TwW_ZrodlowaSpr
	, @W_StawkaPodSpr = TwW_StawkaPodSpr
	, @W_Archiwalny = TwW_Archiwalny
	, @W_JMCalkowita = TwW_JMCalkowita
	, @W_JmDomyslnaZak = TwW_JMDomyslnaZak
	, @W_KrajPoch = TwW_KrajPoch
	, @W_WspFin = TwW_WspFin
	, @W_PobierzWgCech = TwW_PobierzWgCech
	, @W_Kaucja = TwW_Kaucja
	, @W_SkNId = TwW_SKNId
	, @W_RejWyposazenia = TwW_RejWyposazenia
	, @W_OkresGwarancji = TwW_OkresGwarancji
	, @W_GrupaWyposazenia = TwW_GrupaWyposazenia
	, @W_WymJm = TwW_WymJm
	, @W_PartiaDataW = TwW_PartiaDataW
	, @W_TerminW = TwW_TerminW
	, @W_PartiaDostawa = TwW_PartiaDostawa
	, @W_ESklep = TwW_ESklep
	, @W_StawkaKGO = TwW_StawkaKGO
	, @W_DostawaEAN = TwW_DostawaEAN
	, @W_MarkaId = TwW_MarkaId
	, @W_Zlom = TwW_Zlom
	, @W_AnalizaABCYZ = TwW_AnalizaABCXYZ
	, @W_PIADostepnoscFlaga = TwW_PIADostepnoscFlaga
	, @W_ObowPodSprId = TwW_ObowPodSprId
	, @W_ObowPodZakId = TwW_ObowPodZakId
	, @W_RodzajKosztu = TwW_RodzajKosztu
	, @W_JMDopelnianiaMobSpr = TwW_JMDopelnianiaMobSpr
	, @W_MobSpr = TwW_MobSpr
	, @W_PLM = TwW_PLM
	, @W_WagaBrutto = TwW_WagaBrutto
FROM CDN.TwrWzorce
WHERE TwW_GrpTyp = @twwGrpTyp
	AND TwW_GrpNumer = @twwGrpNumer

IF IsNull(@Bon,0)=1 
BEGIN
	IF IsNull(@RBoId,0)=0 OR isnull(@CCKTyp, @W_CCKTyp)=0 OR isnull(@CCKNumer, @W_CCKNumer)=0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Nie podano rodzaju bonu i/lub nie przypisano klasy cechy - (353)'
				, 16
				, 1
				)

		RETURN 353
	END

	IF NOT EXISTS (SELECT * FROM CDN.RodzajeBonow WHERE Rbo_Id=@RBoId AND  RBo_Archiwalny=0 AND RBo_TwrTyp=0)
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błędny rodzaj bonu (brak, archiwalny bądź już powiązany z innym towarem) - (354)'
				, 16
				, 1
				)

		RETURN 354
	END
END

INSERT INTO CDN.TwrKarty (
	Twr_GIDTyp
	, Twr_GIDFirma
	--,Twr_GIDNumer
	, Twr_GIDLp
	, Twr_Typ
	, Twr_Kod
	, Twr_KodFormat
	, Twr_FPPKod
	, Twr_Nazwa
	, Twr_Nazwa1
	, Twr_Certyfikat
	, Twr_Sww
	, Twr_Ean
	, Twr_Jm
	, Twr_Waga
	, Twr_WJm
	, Twr_JmFormat
	, Twr_IloscZam
	, Twr_IloscMin
	, Twr_IloscMax
	, Twr_Ubytek
	, Twr_Prog
	, Twr_Upust
	, Twr_UpustData
	, Twr_UpustDataOd
	, Twr_UpustDataDo
	, Twr_UpustGodz
	, Twr_UpustGodzOd
	, Twr_UpustGodzDo
	, Twr_AutoZam
	, Twr_IloscAZam
	, Twr_CzasDst
	, Twr_CenaSpr
	, Twr_JmDomyslna
	, Twr_DstDomyslny
	, Twr_RozliczMag
	, Twr_Zakup
	, Twr_Sprzedaz
	, Twr_JMBlokujZmiane
	, Twr_GrupaPod
	, Twr_FlagaVat
	, Twr_Zrodlowa
	, Twr_StawkaPod
	, Twr_Akcyza
	, Twr_OpeTyp
	, Twr_OpeFirma
	, Twr_OpeNumer
	, Twr_OpeLp
	, Twr_PrcTyp
	, Twr_PrcFirma
	, Twr_PrcNumer
	, Twr_PrcLp
	, Twr_KontaktTyp
	, Twr_KontaktZa
	, Twr_KontaktJC
	, Twr_Okresowy
	, Twr_Cel
	, Twr_Atrybut1
	, Twr_Format1
	, Twr_Wartosc1
	, Twr_Atrybut2
	, Twr_Format2
	, Twr_Wartosc2
	, Twr_Atrybut3
	, Twr_Format3
	, Twr_Wartosc3
	, Twr_Punkty
	, Twr_Koncesja
	, Twr_Konto1
	, Twr_Konto2
	, Twr_Konto3
	, Twr_Polozenie
	, Twr_Katalog
	, Twr_WCenniku
	, Twr_EdycjaNazwy
	, Twr_BezRabatu
	, Twr_KopiujOpis
	, Twr_URL
	, Twr_Warunek
	, Twr_ObjetoscL
	, Twr_ObjetoscM
	, Twr_LastModL
	, Twr_LastModO
	, Twr_LastModC
	, Twr_TerminZwrotu
	, Twr_ZakupAutoryz
	, Twr_MagTyp
	, Twr_MagFirma
	, Twr_MagNumer
	, Twr_MagLp
	, Twr_MarzaMin
	, Twr_KosztUslugi
	, Twr_KosztUTyp
	, Twr_CzasWykonania
	, Twr_CzasWykonaniaJedn
	, Twr_Clo
	, Twr_PodatekImp
	, Twr_StanInfoLimit
	, Twr_StanInfoMax
	, Twr_StanInfoProcent
	, Twr_Aktywna
	, Twr_Wsk
	, Twr_CCKTyp
	, Twr_CCKFirma
	, Twr_CCKNumer
	, Twr_CCKLp
	, Twr_PrdTyp
	, Twr_PrdFirma
	, Twr_PrdNumer
	, Twr_PrdLp
	, Twr_OpeTypM
	, Twr_OpeFirmaM
	, Twr_OpeNumerM
	, Twr_OpeLpM
	, Twr_PCN
	, Twr_Notowania
	, Twr_WagaBrutto
	, Twr_WJmBrutto
	, Twr_GrupaPodSpr
	, Twr_FlagaVatSpr
	, Twr_ZrodlowaSpr
	, Twr_StawkaPodSpr
	, Twr_Licencja
	, Twr_Blokada
	, Twr_Archiwalny
	, Twr_JMCalkowita
	, Twr_Oddzialowy
	, Twr_JmDomyslnaZak
	, Twr_KrajPoch
	, Twr_WspFin
	, Twr_PobierzWgCech
	, Twr_Kaucja
	, Twr_SkNId
	, Twr_RejWyposazenia
	, Twr_OkresGwarancji
	, Twr_GrupaWyposazenia
	, Twr_ProdTechnologia
	, Twr_ProdAktualnaWersja
	, Twr_TwZOdNajwiekszego
	, Twr_DataUtworzenia
	, Twr_WymJm
	, Twr_PartiaDataW
	, Twr_TerminW
	, Twr_PartiaDostawa
	, Twr_NrSeryjnyZCechy
	, Twr_ESklep
	, Twr_StawkaKGO
	, Twr_DostawaEAN
	, Twr_MarkaId
	, Twr_RejestrujUrzadzenie
	, Twr_RodzajUrzadzenia
	, Twr_OpisUrzadzenia
	, Twr_Zlom
	, Twr_AnalizaABCXYZ
	--2013.3
	, Twr_JMPulpitKnt
	, Twr_JMiSklep
	, Twr_PLM
	, Twr_MobSpr
	, Twr_RodzajId
	, Twr_KategoriaABCXYZ
	, Twr_JMMobSpr
	, Twr_PIADostepnoscFlaga
	, Twr_ObowPodSprId
	, Twr_ObowPodZakId
	, Twr_RodzajKosztu
	, Twr_JMDopelnianiaMobSpr
	, Twr_Techniczna1
	, Twr_Techniczna2
	, Twr_Techniczna3
	, Twr_Techniczna4
	, Twr_Bon
	)
VALUES (
	isnull(@GIDTyp, @ptwrGIDTyp)
	, isnull(@GIDFirma, @ptwrGIDFirma)
	--,isnull(@GIDNumer,0)
	, isnull(@GIDLp, 0)
	, isnull(@Typ, @W_Typ)
	, isnull(@Kod, '')
	, isnull(@KodFormat, @W_KodFormat)
	, isnull(@FPPKod, '')
	, isnull(@Nazwa, @W_Nazwa)
	, isnull(@Nazwa1, @W_Nazwa1)
	, isnull(@Certyfikat, @W_Certyfikat)
	, isnull(@Sww, @W_Sww)
	, isnull(@Ean, '')
	, isnull(@Jm, @W_Jm)
	, isnull(@Waga, @W_Waga)
	, isnull(@WJm, @W_WJm)
	, isnull(@JmFormat, @W_JmFormat)
	, isnull(@IloscZam, @W_IloscZam)
	, isnull(@IloscMin, @W_IloscMin)
	, isnull(@IloscMax, @W_IloscMax)
	, isnull(@Ubytek, @W_Ubytek)
	, isnull(@Prog, @W_Prog)
	, isnull(@Upust, @W_Upust)
	, isnull(@UpustData, @W_UpustData)
	, isnull(@UpustDataOd, @W_UpustDataOd)
	, isnull(@UpustDataDo, @W_UpustDataDo)
	, isnull(@UpustGodz, @W_UpustGodz)
	, isnull(@UpustGodzOd, @W_UpustGodzOd)
	, isnull(@UpustGodzDo, @W_UpustGodzDo)
	, isnull(@AutoZam, @W_AutoZam)
	, isnull(@IloscAZam, @W_IloscAZam)
	, isnull(@CzasDst, @W_CzasDst)
	, isnull(@CenaSpr, @W_CenaSpr)
	, isnull(@JmDomyslna, @W_JmDomyslna)
	, isnull(@DstDomyslny, @W_DstDomyslny)
	, isnull(@RozliczMag, @W_RozliczMag)
	, isnull(@Zakup, @W_Zakup)
	, isnull(@Sprzedaz, @W_Sprzedaz)
	, isnull(@BlokujZmiane, @W_BlokujZmiane)
	, isnull(@GrupaPod, @W_GrupaPod)
	, isnull(@FlagaVat, @W_FlagaVat)
	, isnull(@Zrodlowa, @W_Zrodlowa)
	, isnull(@StawkaPod, @W_StawkaPod)
	, isnull(@Akcyza, @W_Akcyza)
	, isnull(@OpeTyp, 0)
	, isnull(@OpeFirma, @ptwrGIDFirma)
	, isnull(@OpeNumer, 0)
	, 0 --@OpeLp
	, isnull(@PrcTyp, 0)
	, isnull(@PrcFirma, @ptwrGIDFirma)
	, isnull(@PrcNumer, 0)
	, isnull(@PrcLp, 0)
	, isnull(@KontaktTyp, @W_KontaktTyp)
	, isnull(@KontaktZa, @W_KontaktZa)
	, isnull(@KontaktJC, @W_KontaktJC)
	, isnull(@Okresowy, @W_Okresowy)
	, isnull(@Cel, @W_Cel)
	, isnull(@Atrybut1, @W_Atrybut1)
	, isnull(@Format1, @W_Format1)
	, isnull(@Wartosc1, @W_Wartosc1)
	, isnull(@Atrybut2, @W_Atrybut2)
	, isnull(@Format2, @W_Format2)
	, isnull(@Wartosc2, @W_Wartosc2)
	, isnull(@Atrybut3, @W_Atrybut3)
	, isnull(@Format3, @W_Format3)
	, isnull(@Wartosc3, @W_Wartosc3)
	, isnull(@Punkty, @W_Punkty)
	, isnull(@Koncesja, @W_Koncesja)
	, isnull(@Konto1, @W_Konto1)
	, isnull(@Konto2, @W_Konto2)
	, isnull(@Konto3, @W_Konto3)
	, isnull(@Polozenie, @W_Polozenie)
	, isnull(@Katalog, @W_Katalog)
	, isnull(@WCenniku, @W_WCenniku)
	, isnull(@EdycjaNazwy, @W_EdycjaNazwy)
	, isnull(@BezRabatu, @W_BezRabatu)
	, isnull(@KopiujOpis, 0)
	, isnull(@URL, @W_URL)
	, isnull(@Warunek, @W_Warunek)
	, isnull(@ObjetoscL, @W_ObjetoscL)
	, isnull(@ObjetoscM, @W_ObjetoscM)
	, datediff(s, '19900101', getdate())
	, datediff(s, '19900101', getdate())
	, datediff(s, '19900101', getdate())
	, isnull(@TerminZwrotu, @W_TerminZwrotu)
	, isnull(@ZakupAutoryz, @W_ZakupAutoryz)
	, isnull(@MagTyp, @W_MagTyp)
	, isnull(@MagFirma, @W_MagFirma)
	, isnull(@MagNumer, @W_MagNumer)
	, isnull(@MagLp, @W_MagLp)
	, isnull(@MarzaMin, @W_MarzaMin)
	, isnull(@KosztUslugi, @W_KosztUslugi)
	, isnull(@KosztUTyp, @W_KosztUTyp)
	, isnull(@CzasWykonania, @W_CzasWykonania)
	, isnull(@CzasWykonaniaJedn, @W_CzasWykonaniaJedn)
	, isnull(@Clo, @W_Clo)
	, isnull(@PodatekImp, @W_PodatekImp)
	, isnull(@StanInfoLimit, @W_StanInfoLimit)
	, isnull(@StanInfoMax, @W_StanInfoMax)
	, isnull(@StanInfoProcent, @W_StanInfoProcent)
	, 0 --@Aktywna
	, isnull(@Wsk, 0)
	, isnull(@CCKTyp, @W_CCKTyp)
	, isnull(@CCKFirma, @W_CCKFirma)
	, isnull(@CCKNumer, @W_CCKNumer)
	, isnull(@CCKLp, @W_CCKLp)
	, isnull(@PrdTyp, @W_PrdTyp)
	, isnull(@PrdFirma, @W_PrdFirma)
	, isnull(@PrdNumer, @W_PrdNumer)
	, isnull(@PrdLp, @W_PrdLp)
	, isnull(@OpeTyp, 0)
	, isnull(@OpeFirma, @ptwrGIDFirma)
	, isnull(@OpeNumer, 0)
	, 0
	, isnull(@PCN, @W_PCN)
	, isnull(@Notowania, 0)
	, isnull(@WagaBrutto, 0)
	, isnull(@WJmBrutto, '')
	, isnull(@GrupaPodSpr, @W_GrupaPodSpr)
	, isnull(@FlagaVatSpr, @W_FlagaVatSpr)
	, isnull(@ZrodlowaSpr, @W_ZrodlowaSpr)
	, isnull(@StawkaPodSpr, @W_StawkaPodSpr)
	, isnull(@Licencja, 0)
	, isnull(@Blokada, 0)
	, isnull(@Archiwalny, @W_Archiwalny)
	, isnull(@JMCalkowita, @W_JMCalkowita)
	, isnull(@Oddzialowy, 0)
	, isnull(@JmDomyslnaZak, @W_JmDomyslnaZak)
	, isnull(@KrajPoch, @W_KrajPoch)
	, isnull(@WspFin, @W_WspFin)
	, isnull(@PobierzWgCech, @W_PobierzWgCech)
	, isnull(@Kaucja, @W_Kaucja)
	, isnull(@SkNId, @W_SkNId)
	, isnull(@RejWyposazenia, @W_RejWyposazenia)
	, isnull(@OkresGwarancji, @W_OkresGwarancji)
	, isnull(@GrupaWyposazenia, @W_GrupaWyposazenia)
	, isnull(@ProdTechnologia, 0)
	, isnull(@ProdAktualnaWersja, 0)
	, isnull(@TwZOdNajwiekszego, 0)
	, isnull(@DataUtworzenia, datediff(s, '19900101', getdate()))
	, isnull(@WymJm, @W_WymJm)
	, isnull(@PartiaDataW, @W_PartiaDataW)
	, isnull(@TerminW, @W_TerminW)
	, coalesce(@PartiaDostawa, @W_PartiaDostawa, 0)
	, isnull(@NrSeryjnyZCechy, 0)
	, coalesce(@ESklep, @W_ESklep, 0)
	, coalesce(@StawkaKGO, @W_StawkaKGO, 0)
	, coalesce(@DostawaEAN, @W_DostawaEAN, 0)
	, coalesce(@MarkaId, @W_MarkaId, 0)
	, isnull(@RejestrujUrzadzenie, 0)
	, isnull(@RodzajUrzadzenia, 0)
	, isnull(@OpisUrzadzenia, '')
	, coalesce(@Zlom, @W_Zlom, 0)
	, coalesce(@AnalizaABCYZ, @W_AnalizaABCYZ, 0)
	--2013.3
	, coalesce(@JMPulpitKnt, @W_JMPulpitKnt, 0)
	, coalesce(@JMiSklep, @W_JMiSklep, 0)
	, coalesce(@PLM, @W_PLM, 0)
	, coalesce(@MobSpr, @W_MobSpr, 0)
	, coalesce(@RodzajId, @W_RodzajId, 0)
	, isnull(@KategoriaABCXYZ, '')
	--2013.5
	, coalesce(@JMMobSpr, @W_JMMobSpr, 0)
	--2014.1
	, isnull(@W_PIADostepnoscFlaga, 0)
	, isnull(@W_ObowPodSprId, 0)
	, isnull(@W_ObowPodZakId, 0)
	--2015.1
	, isnull(@W_RodzajKosztu, 0)
	, isnull(@W_JMDopelnianiaMobSpr, 0)
	, ''
	, ''
	, ''
	, ''
	, isnull(@Bon, 0)
	)

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd dodawania karty towaru! - (33)'
			, 16
			, 1
			)

	RETURN @@error
END

SELECT @ptwrGIDNumer = SCOPE_IDENTITY()

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd pobrania numeru karty towaru - (45)'
			, 16
			, 1
			)

	RETURN @@error
END

INSERT INTO CDN.TwrGrupy (
	TwG_GIDTyp
	, TwG_GIDFirma
	, TwG_GIDNumer
	, TwG_GIDLp
	, TwG_GrOTyp
	, TwG_GrOFirma
	, TwG_GrONumer
	, TwG_GrOLp
	, TwG_Kod
	, TwG_Nazwa
	, TwG_CzasModyfikacji
	)
VALUES (
	@ptwrGIDTyp
	, @ptwrGIDFirma
	, @ptwrGIDNumer
	, 0
	, @twwGrpTyp
	, @twwGrpFirma
	, @twwGrpNumer
	, 0
	, @Kod
	, isnull(@Nazwa, @W_Nazwa)
	, datediff(s, '19900101', getdate())
	)

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd tworzenia twrgrupy! - (34)'
			, 16
			, 1
			)

	RETURN @@error
END

INSERT INTO CDN.TwrGrupyDom (
	TGD_GIDTyp
	, TGD_GIDFirma
	, TGD_GIDNumer
	, TGD_GIDLp
	, TGD_GrOTyp
	, TGD_GrOFirma
	, TGD_GrONumer
	, TGD_GrOLp
	, TGD_Kod
	)
VALUES (
	@ptwrGIDTyp
	, @ptwrGIDFirma
	, @ptwrGIDNumer
	, 0
	, @twwGrpTyp
	, @twwGrpFirma
	, @twwGrpNumer
	, 0
	, @Kod
	)

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd tworzenia twrgrupydom! - (35)'
			, 16
			, 1
			)

	RETURN @@error
END

IF EXISTS (
		--Bug #229196: Nieprawidłowe działanie API SQL do dodawania artykułu 
		SELECT *
		FROM cdn.TwrWzOpisy
		WHERE WTO_Opis &lt;&gt; ''
			AND WTO_GrpNumer = @twwGrpNumer
			AND WTO_GrpTyp = @twwGrpTyp
		)
BEGIN
	INSERT INTO CDN.TwrOpisy (
		TwO_TwrTyp
		, TwO_TwrFirma
		, TwO_TwrNumer
		, TwO_TwrLp
		, TwO_Typ
		, TwO_Jezyk
		, TwO_Opis
		, TwO_CzasModyfikacji
		)
	SELECT @ptwrGIDTyp
		, @ptwrGIDFirma
		, @ptwrGIDNumer
		, 1
		, WTO_Typ
		, 0
		, WTO_Opis
		, datediff(s, '19900101', getdate())
	FROM cdn.TwrWzOpisy
	WHERE WTO_GrpNumer = @twwGrpNumer
		AND WTO_GrpTyp = @twwGrpTyp
END
ELSE
BEGIN
	INSERT INTO CDN.TwrOpisy (
		TwO_TwrTyp
		, TwO_TwrFirma
		, TwO_TwrNumer
		, TwO_TwrLp
		, TwO_Typ
		, TwO_Jezyk
		, TwO_Opis
		, TwO_CzasModyfikacji
		)
	VALUES (
		@ptwrGIDTyp
		, @ptwrGIDFirma
		, @ptwrGIDNumer
		, 1
		, 0
		, 0
		, ''
		, datediff(s, '19900101', getdate())
		)

	IF @@error &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd tworzenia twropisy! - (37)'
				, 16
				, 1
				)

		RETURN @@error
	END
END

INSERT INTO CDN.TwrCeny (
	TwC_TwrTyp
	, TwC_TwrFirma
	, TwC_TwrNumer
	, TwC_TwrLp
	, TwC_Waluta
	, TwC_NrKursu
	, TwC_Marza
	, TwC_Wartosc
	, TwC_Zaok
	, TwC_Offset
	, TwC_Aktualizacja
	, TwC_Priorytet
	, TwC_CzasModyfikacji
	, TwC_KosztyDodatkowe
	, TwC_DokTyp
	, TwC_DokFirma
	, TwC_DokNumer
	, TwC_DokLp
	--2016.0.0
	, [TwC_TcnId]
	, [TwC_DataOd]
	, [TwC_RodzajPodstawy]
	, [TwC_KntTyp]
	, [TwC_KntFirma]
	, [TwC_KntNumer]
	, [TwC_KntLp]
	)
SELECT @ptwrGIDTyp
	, @ptwrGIDFirma
	, @ptwrGIDNumer
	, WTC_GrpLp
	, WTC_Waluta
	, WTC_NrKursu
	, WTC_Marza
	, 0
	, WTC_Zaok
	, WTC_Offset
	, WTC_Aktualizacja
	, WTC_Priorytet
	, @DzisTS
	, 0
	, 0
	, 0
	, 0
	, 0
	--2016.0.0
	, (
		SELECT TOP 1 TCN_Id
		FROM cdn.TwrCenyNag
		WHERE TCN_RodzajCeny = WTC_GrpLp
			AND TCN_Stan = 5 --potwierdzone
			AND TCN_DataOd &lt;= @DzisTS
		ORDER BY TCN_DataOd DESC
			, TCN_CzasModyfikacji DESC
		)
	, @DzisTS
	, WTC_RodzajPodstawy
	, WTC_KntTyp
	, WTC_KntFirma
	, WTC_KntNumer
	, WTC_KntLp
FROM CDN.TwrWzCeny
WHERE WTC_GrpTyp = @twwGrpTyp
	AND WTC_GrpNumer = @twwGrpNumer

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd tworzenia twrceny! - (38)'
			, 16
			, 1
			)

	RETURN @@error
END

IF EXISTS (
		SELECT *
		FROM CDN.TwrAplikacje
		WHERE TAP_ObiNumer = @twwGrpNumer
			AND TAP_ObiTyp = @twwGrptyp
		)
BEGIN
	INSERT INTO CDN.TwrAplikacje (
		TAP_ObiNumer
		, TAP_ObiTyp
		, TAP_Dostepnosc
		, TAP_GrupaiMall
		, TAP_iMall
		, TAP_KontrolaStanow
		, TAP_PodlegaRabatowaniu
		, TAP_Status
		, TAP_IndywKosztDst
		, TAP_Flagi
		, TAP_CzasModyfikacji
		, TAP_KosztDstWartosc
		)
	SELECT @ptwrGIDNumer
		, @ptwrGIDTyp
		, TAP_Dostepnosc
		, TAP_GrupaiMall
		, TAP_iMall
		, TAP_KontrolaStanow
		, TAP_PodlegaRabatowaniu
		, TAP_Status
		, TAP_IndywKosztDst
		, TAP_Flagi
		, datediff(s, '19900101', getdate())
		, TAP_KosztDstWartosc
	FROM CDN.TwrAplikacje
	WHERE TAP_ObiNumer = @twwGrpNumer
		AND TAP_ObiTyp = @twwGrptyp

	IF @@error &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd tworzenia twrAplikacje! - (39)'
				, 16
				, 1
				)

		RETURN @@error
	END
END
ELSE
BEGIN
	IF @ESklep = 1
	BEGIN
		INSERT INTO CDN.TwrAplikacje (
			TAP_ObiNumer
			, TAP_ObiTyp
			, TAP_Dostepnosc
			, TAP_GrupaiMall
			, TAP_iMall
			, TAP_KontrolaStanow
			, TAP_PodlegaRabatowaniu
			, TAP_Status
			, TAP_IndywKosztDst
			, TAP_Flagi
			, TAP_CzasModyfikacji
			, TAP_KosztDstWartosc
			)
		SELECT @ptwrGIDNumer
			, @ptwrGIDTyp
			, 0
			, 0
			, 0
			, 1
			, 0
			, 0
			, 0
			, 0
			, datediff(s, '19900101', getdate())
			, 0

		IF @@error &lt;&gt; 0
		BEGIN
			ROLLBACK TRANSACTION

			RAISERROR (
					'Błąd tworzenia twrAplikacje! - (40)'
					, 16
					, 1
					)

			RETURN @@error
		END
	END
END

IF EXISTS (
		SELECT *
		FROM CDN.TwrAplikacjeOpisy
		WHERE TPO_ObiNumer = @twwGrpNumer
			AND TPO_ObiTyp = @twwGrptyp
		)
BEGIN
	INSERT INTO CDN.TwrAplikacjeOpisy (
		TPO_ObiNumer
		, TPO_ObiTyp
		, TPO_JezykId
		, TPO_MetaOpis
		, TPO_OpisKrotki
		, TPO_SlowaKluczowe
		, TPO_TytulStrony
		, TPO_Url
		, TPO_SlowaKluczoweW
		, TPO_CzasModyfikacji
		)
	SELECT @ptwrGIDNumer
		, @ptwrGIDTyp
		, TPO_JezykId
		, TPO_MetaOpis
		, TPO_OpisKrotki
		, TPO_SlowaKluczowe
		, TPO_TytulStrony
		, TPO_Url
		, TPO_SlowaKluczoweW
		, datediff(s, '19900101', getdate())
	FROM CDN.TwrAplikacjeOpisy
	WHERE TPO_ObiNumer = @twwGrpNumer
		AND TPO_ObiTyp = @twwGrptyp

	IF @@error &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd tworzenia TWRAplikacjeOpisy! - (41)'
				, 16
				, 1
				)

		RETURN @@error
	END
END

INSERT INTO [CDN].[ProgiIloscAp] (
	[PIA_ObiNumer]
	, [PIA_ObiTyp]
	, [PIA_PrzedzialOd]
	, [PIA_PrzedzialDo]
	, [PIA_CzyIloscRzeczywista]
	, [PIA_CzyOpis]
	, [PIA_OpisTresc]
	, [PIA_CzyGrafika]
	, [PIA_GrafikaSciezka]
	, [PIA_CzyKolor]
	, [PIA_KolorNumer]
	, [PIA_DostepnoscFlaga]
	, [PIA_CzasModyfikacji]
	)
SELECT @ptwrGIDNumer
	, @ptwrGIDTyp
	, [PIA_PrzedzialOd]
	, [PIA_PrzedzialDo]
	, [PIA_CzyIloscRzeczywista]
	, [PIA_CzyOpis]
	, [PIA_OpisTresc]
	, [PIA_CzyGrafika]
	, [PIA_GrafikaSciezka]
	, [PIA_CzyKolor]
	, [PIA_KolorNumer]
	, [PIA_DostepnoscFlaga]
	, DATEDIFF(s, '19900101', getdate())
FROM [CDN].[ProgiIloscAp]
WHERE PIA_ObiTyp = @twwGrptyp
	AND PIA_ObiNumer = @twwGrpNumer

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd tworzenia ProgiIloscAp! - (42)'
			, 16
			, 1
			)

	RETURN @@error
END

INSERT INTO CDN.ProgiIloscAp (
	PIA_ObiNumer
	, PIA_ObiTyp
	, PIA_PrzedzialOd
	, PIA_PrzedzialDo
	, PIA_CzyIloscRzeczywista
	, PIA_CzyOpis
	, PIA_OpisTresc
	, PIA_CzyGrafika
	, PIA_GrafikaSciezka
	, PIA_CzyKolor
	, PIA_KolorNumer
	, PIA_DostepnoscFlaga
	, PIA_CzasModyfikacji
	)
SELECT @ptwrGIDNumer
	, @ptwrGIDTyp
	, PrzedzialOd
	, PrzedzialDo
	, 0
	, 0
	, ''
	, 0
	, ''
	, 0
	, 0
	, DostepnoscFlaga
	, DATEDIFF(s, '19900101', getdate())
FROM cdn.PobierzLukiWPrzedzialachDlaObiektu(@ptwrGIDNumer, @ptwrGIDTyp)

IF @@error &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd tworzenia ProgiIloscAp (uzupełnienie luk)! - (43)'
			, 16
			, 1
			)

	RETURN @@error
END

IF isnull(@Ean, '') &lt;&gt; ''
BEGIN
	INSERT INTO [CDN].[TwrKody] (
		[TwK_TypKodu]
		, [TwK_Kod]
		, [TwK_Jm]
		, [TwK_Opis]
		, [TwK_Rodzaj]
		, [TwK_TwrNumer]
		, [TwK_Pochodzenie]
		, [TwK_Domyslny]
		, [TwK_CzasModyfikacji]
		)
	VALUES (
		1
		, isnull(@Ean, '')
		, isnull(@Jm, @W_Jm)
		, ''
		, 0
		, @ptwrGIDNumer
		, 0
		, 1
		, datediff(s, '19900101', getdate())
		)

	IF @@error &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd tworzenia TwrKody! - (44)'
				, 16
				, 1
				)

		RETURN @@error
	END
END

IF IsNull(@Bon,0)=1 
BEGIN
	UPDATE CDN.RodzajeBonow SET Rbo_TwrTyp=@ptwrGIDTyp, Rbo_TwrNumer=@ptwrGIDNumer WHERE Rbo_Id=@RBoId

	IF @@error &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd podczas zapisu powiązania rodzajem bonu z towarem - (355)'
				, 16
				, 1
				)

		RETURN @@error
	END
END

COMMIT TRANSACTION

EXEC CDN.AtrKopiujAtrybuty @ZrdTyp = @twwGrpTyp
	, @ZrdFirma = @twwGrpFirma
	, @ZrdNumer = @twwGrpNumer
	, @ZrdLp = 0
	, @ZrdSubLp = 0
	, @DocTyp = @ptwrGIDTyp
	, @DocFirma = @ptwrGIDFirma
	, @DocNumer = @ptwrGIDNumer
	, @DocLp = 0
	, @DocSubLp = 0
	, @OpeTyp = 128
	, @OpeFirma = @ptwrGIDFirma
	, @OpeNumer = @OpeNumer
	, @OpeLp = 0
	, @Blad = 0

SELECT GIDTyp = @ptwrGIDTyp
	, GIDFirma = @ptwrGIDFirma
	, GIDNumer = @ptwrGIDNumer

SET NOCOUNT OFF

RETURN 0
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>