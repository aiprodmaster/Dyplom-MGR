<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="[XLNowyPlanProdukcji]"></A><PRE>
          <FONT SIZE="2"><I>/* [XLNowyPlanProdukcji] */</I><BR>
CREATE PROCEDURE [CDN].[XLNowyPlanProdukcji]
(
/* ==========================================================================================
        SQL API: Procedura serwerowa do dodawania planu produkcji

        Dla uproszczenia założono, że jeżeli w systemie zewnętrznym zostanie wystawiony plan produkcji,
        to w trakcie wystawiania jej przez API nie ma potrzeby kontrolowania uprawnień do obiektów, z których ona korzysta

        Parametry wejściowe:
   ========================================================================================== */
		@OpeWystNumer INT, --numer operatora wystawiającego	
        @FrsId INT,                             -- Identyfikator centrum struktury praw (właściciela dokumentu)
        @SesjaID	int, --ID bieżącej sesji
		@SkladnikiMPS	TINYINT=NULL, --maska bitowa dokumentow ktore maja byc brane pod uwage na planie, 1-ZS, 2-PLZ, 4 - ZP, 8 - ZW
        @MagNumer INT = NULL,			-- identyfikator magazyny
        @MagKod NVARCHAR(10) = NULL,	-- kod magazyny       
        @TwGNumer INT = NULL,			-- identyfikator grupy towarowej
		@PrzeliczenieRodzaj TINYINT=NULL, --Czy plan będzie przeliczany na termin czy na okres
		@PrzeliczenieOd INTEGER=NULL, --Od jakiej daty bedą uwzględniane dokumenty podczas przeliczania 
		@PrzeliczenieDo INTEGER=NULL, --Do jakiej daty bedą uwzględniane dokumenty podczas przeliczania 
		@OpeWystKod NVARCHAR(8)=null, --kod operatora wystawiającego, gdy nie znajdzie po numerze
		@DataCzasWyst INT=NULL, --data i czas wystawienia dokumentu, ilość sekund po 01-01-1990
		@OpeModNumer INT=null, --numer operatora modyfikującego
		@OpeModKod NVARCHAR(8)=null, --kod operatora modyfikującego, gdy nie znajdzie po numerze
		@DataCzasMod INT=NULL, --data i czas modyfikacji dokumentu, ilość sekund po 01-01-1990
        @Numer INT = NULL,                      -- Numer dokumentu
        @Seria NVARCHAR(5)=NULL,					-- Seria dokumentu
        @Rok INT = NULL,                      -- Rok dokumentu
        @Miesiac INT = NULL,                      -- Miesiac dokumentu
        @Opis NVARCHAR(1024)=NULL,				-- Opis
        @URL NVARCHAR(255)=NULL,					-- URL
        @DoProdukcjiPodst INT = 0,	-- Ilość do produkcji na podstawie (bitowo: 1-ilości minimalnej, 2-zapasu bezpieczeństwa, 4- EQQ, 8 - wielokrotności, 16 - po zaokrągleniu) 
        @DoZamowieniaPodst INT = 0,	-- Ilość do zamowienia na podstawie (bitowo: 2-zapasu bezpieczeństwa, 4- EQQ, 8 - wielokrotności, 16 - po zaokrągleniu) 
        @TylkoBraki INT = 0,	        -- Pokazuj tylko materiały których brakuje 
        @TylkoDoProdukcji INT = 0,	-- Pokazuj tylko pozycje, które trzeba wyprodukować
        @PrzekroczonaRealizacja INT =0,	-- Pokazuj produkty z przekroczonym terminem realizacji
        @BrakMaterialow INT = 0,	-- Pokazuj produkty dla których brakuje materiałów
        @RodzajMat INT = 0,     	-- Rodzaj Materiału (0 - wszystkie, 1 - surowce, 2 - półprodukty)
        @Tryb	TINYINT = 0,
        @Komunikat	TINYINT = 0,				-- Czy wyswietlac komunikat o bledzie	
		@MagDlaKolOgolnieDostepna SMALLINT = NULL,
		@MagNumerOgolnieDostepna INT = NULL,  --Magazyn dla kolumny ogolnie dostepna
		@MagKodOgolnieDostepna NVARCHAR(10) = NULL, -- kod magazynu dla kolumny ogolnie dostepna
		@MagDlaKolWDrodze SMALLINT = NULL,
		@MagNumerWDrodze INT = NULL, --Magazyn dla kolumny ogolnie dostepna
		@MagKodWDrodze NVARCHAR(10) = NULL, --kod magazynu dla kolumny ogolnie dostepna
		@ZakresRezerwacjiDlaProduktow SMALLINT = NULL, -- zakres rezerwacji do obliczania kolumnu ogolnie dostepna i w drodze
		@UwzgledniajJednLogDlaProduktow SMALLINT = NULL,
		@UwzgledniajJednLogDlaMaterialow SMALLINT = NULL

/* ==========================================================================================
        Błędy:
        1 : Wystąpił błąd podczas dodawania planu produkcji. Nie powiódł się zapis do tabeli CDN.ProdPlany
        2 : Wystąpił błąd podczas dodawania planu produkcji. Podany operator nie występuje w bazie.
        3 : Wystąpił błąd podczas dodawania planu produkcji. Podane centrum nie występuje w bazie.
        4 : Wystąpił błąd podczas dodawania planu produkcji. Niepoprawnie wybrane składniki MPS.
        5 : Wystąpił błąd podczas dodawania planu produkcji. Dokument o takim numerze już istnieje w bazie.
        6 : Wystąpił błąd podczas dodawania planu produkcji. Nie powiodło się dodawanie wpisu do tabeli CDN.ObiektyObce. 
        10: Wystąpił błąd podczas dodawania magazynu do planu produkcji. Nie powiodło się dodawanie wpisu do tabeli CDN.ProdPlanyMag.
        12: Wystąpił błąd podczas dodawania grupy towarowej do planu produkcji. Nie powiodło się dodawanie wpisu do tabeli CDN.ProdPlanyTwG.
   ========================================================================================== */
)
AS
BEGIN
	DECLARE @IDObiektu int
	DECLARE @Typ_ProdPlany INT			     
    DECLARE @TimeStamp INT
    DECLARE @PPLId INT
    DECLARE @Wynik INT
    DECLARE @PrzeliczenieRodzajTermin SMALLINT
    DECLARE @PrzeliczenieRodzajOkres SMALLINT
    DECLARE @PrzeliczenieRodzajDokument SMALLINT
    DECLARE @PrzeliczPPOkresPlanistycznyOd INT 
    DECLARE @PrzeliczPPOkresPlanistycznyCzasTrwania INT
	DECLARE @MagDlaKolWszystkie SMALLINT
	DECLARE @MagDlaKolWybrane	SMALLINT
	DECLARE @MagPrzypisanyDoOgolnieDostepna SMALLINT
	DECLARE @MagPrzypisanyDoWDrodze SMALLINT
	DECLARE @ZakresRezPrzeliczeniaPlanu SMALLINT
	DECLARE @WszystkieRezerwacje SMALLINT
	DECLARE @UwzgJednLog SMALLINT
	DECLARE @NieUwzgJednLog SMALLINT
	DECLARE @DokId INT
    SET @PrzeliczenieRodzajTermin = 1
    SET @PrzeliczenieRodzajOkres = 2
    SET @PrzeliczenieRodzajDokument = 3
    SET @PPLId = 0
	SET @Typ_ProdPlany = 14360 
    SET @TimeStamp = DATEDIFF(s,'19900101',GETDATE())
	SET @MagDlaKolWszystkie = 0
	SET @MagDlaKolWybrane = 1
	SET @MagPrzypisanyDoOgolnieDostepna = 1
	SET @MagPrzypisanyDoWDrodze = 2
	SET @ZakresRezPrzeliczeniaPlanu = 0
	SET @WszystkieRezerwacje = 1
	SET @NieUwzgJednLog = 0
	SET @UwzgJednLog = 1

    IF ISNULL(@PrzeliczenieOd,0) = 0 OR @PrzeliczenieOd &lt; 69035 SET @PrzeliczenieOd = @TimeStamp/86400+69035
    IF ISNULL(@PrzeliczenieDo,0) = 0 OR @PrzeliczenieDo = @PrzeliczenieOd SET @PrzeliczenieDo = @PrzeliczenieOd + DAY(DATEADD(dd,-DAY(getdate()),DATEADD(mm, 1,getdate())))
    IF @DataCzasWyst IS NULL OR @DataCzasWyst = 0 SET @DataCzasWyst = @TimeStamp
    IF @DataCzasMod IS NULL OR @DataCzasWyst &gt; @DataCzasMod SET @DataCzasMod = @DataCzasWyst
	SET NOCOUNT ON	
	--Operator wystawiający 
	SET @OpeWystNumer = COALESCE((SELECT Ope_GIDNumer FROM CDN.OpeKarty WHERE Ope_GIDNumer=@OpeWystNumer),(SELECT Ope_GIDNumer FROM CDN.OpeKarty WHERE Ope_Ident=@OpeWystKod))
	
	IF @OpeWystNumer IS NULL
	BEGIN
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowyPlanProdukcji: Wystąpił błąd podczas dodawania planu produkcji. Podany operator nie występuje w bazie.', 16, 1)
		SELECT 2 AS ERROR
		RETURN 2
	END	
	
	--Operator modyfikujący
	SET @OpeModNumer = COALESCE((SELECT Ope_GIDNumer FROM CDN.OpeKarty WHERE Ope_GIDNumer=@OpeModNumer),(SELECT Ope_GIDNumer FROM CDN.OpeKarty WHERE Ope_Ident=@OpeModKod),@OpeWystNumer)	
	IF @OpeModNumer IS NULL
	BEGIN
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowyPlanProdukcji: Wystąpił błąd podczas dodawania planu produkcji. Podany operator nie występuje w bazie.', 16, 1)
		SELECT 2 AS ERROR
		RETURN 2
	END
				
	--Właściciel		
	SET @FrsId = COALESCE((SELECT Frs_Id FROM CDN.FrmStruktura WHERE FRS_Id=@FrsId),(SELECT Ope_FrSId FROM CDN.OpeKarty WHERE Ope_GIDNumer=@OpeWystNumer))
 
	IF @FrsId IS NULL 
	BEGIN 
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowyPlanProdukcji: Podane centrum dla właściciela nie istnieje w bazie.', 16, 1)
		SELECT 3 AS ERROR
		RETURN 3
	END	

	SET @DokId = (SELECT Dok_Id FROM CDN.DokDefinicje WHERE Dok_GIDTyp = @Typ_ProdPlany AND Dok_FrsId = @FrsId)

	--Sposób przeliczania
	IF @PrzeliczenieRodzaj IS NULL OR @PrzeliczenieRodzaj NOT IN(@PrzeliczenieRodzajTermin,@PrzeliczenieRodzajOkres,@PrzeliczenieRodzajDokument) BEGIN 
		SET @PrzeliczenieRodzaj = (Select Dok_PPLSposobPrzeliczenia FROM CDN.DokDefinicje WHERE Dok_Id = @DokId)	
	END
	-- Ilość do produkcji na podstawie ilości minimalnej 
	IF @DoProdukcjiPodst IS NULL OR @DoProdukcjiPodst = 2 BEGIN 
		SET @DoProdukcjiPodst = (Select Dok_PPLDoProdukcjiPodst FROM CDN.DokDefinicje WHERE Dok_Id = @DokId)	
	END
	--sprawdzanie czy w czasie mieści sie conajmniej jeden okres planistyczny
	IF @PrzeliczenieRodzaj = @PrzeliczenieRodzajOkres BEGIN
		Select @PrzeliczPPOkresPlanistycznyOd = Dok_PlanProdukcjiOkresPlanistycznyOd/86400+69035, @PrzeliczPPOkresPlanistycznyCzasTrwania = Dok_PlanProdukcjiOkresPlanistycznyCzasTrwania FROM CDN.DokDefinicje WHERE Dok_Id = @DokId
		IF @PrzeliczenieDo &lt;= @PrzeliczPPOkresPlanistycznyOd BEGIN  
            SET @PrzeliczenieOd = @PrzeliczPPOkresPlanistycznyOd
            SET @PrzeliczenieDo = @PrzeliczenieOd + @PrzeliczPPOkresPlanistycznyCzasTrwania
        END 
        ELSE IF @PrzeliczPPOkresPlanistycznyOd &gt;= @PrzeliczenieOd and @PrzeliczenieDo - @PrzeliczPPOkresPlanistycznyOd &lt;  @PrzeliczPPOkresPlanistycznyCzasTrwania BEGIN
            SET @PrzeliczenieDo = @PrzeliczPPOkresPlanistycznyOd + @PrzeliczPPOkresPlanistycznyCzasTrwania
        END
        ELSE IF @PrzeliczenieDo - (@PrzeliczPPOkresPlanistycznyOd + @PrzeliczPPOkresPlanistycznyCzasTrwania * CEILING((@PrzeliczenieOd - @PrzeliczPPOkresPlanistycznyOd) / @PrzeliczPPOkresPlanistycznyCzasTrwania)) &lt; @PrzeliczPPOkresPlanistycznyCzasTrwania BEGIN
            SET @PrzeliczenieDo = @PrzeliczPPOkresPlanistycznyOd + @PrzeliczPPOkresPlanistycznyCzasTrwania * CEILING((@PrzeliczenieOd - @PrzeliczPPOkresPlanistycznyOd) / @PrzeliczPPOkresPlanistycznyCzasTrwania) + @PrzeliczPPOkresPlanistycznyCzasTrwania
        END
	END
	
	--Skladniki MPS
	IF @SkladnikiMPS IS NULL OR @SkladnikiMPS = 0 
	BEGIN
		SET @SkladnikiMPS = (Select Dok_PPLSkladnikiMPS FROM CDN.DokDefinicje WHERE Dok_Id = @DokId)
	END
	IF @SkladnikiMPS &lt; 0 OR @SkladnikiMPS &gt; 15
	BEGIN
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowyPlanProdukcji: Wystąpił błąd podczas dodawania planu produkcji. Niepoprawnie wybrane składniki MPS.', 16, 1)
		SELECT 4 AS ERROR
		RETURN 4
	END
	
	--Numerator dokumentu					
	IF EXISTS(SELECT * FROM CDN.Konfig WHERE kon_numer=992 AND (CHARINDEX('6',Kon_wartosc)&gt;0 OR CHARINDEX('7',Kon_wartosc)&gt;0)) -- czy numeracja z miesiącem
		IF @Miesiac IS NULL OR @Miesiac = 0 SET @Miesiac = MONTH(DATEADD(dd,@PrzeliczenieOd,CONVERT(DATETIME,'18001228',11)))
	ELSE
		SET @Miesiac = 0
		
	IF @Rok IS NULL OR @Rok = 0 SET @Rok = YEAR(DATEADD(dd,@PrzeliczenieOd,CONVERT(DATETIME,'18001228',11)))
	
	--pobieranie serii
	set @Seria=COALESCE(( Select SER_Nazwa FROM CDN.DokDefinicje 
						INNER JOIN CDN.Serie ON SER_GIDTyp = Dok_SerTyp AND SER_GIDNumer = Dok_SerNumer
						WHERE Dok_Id = @DokId AND SER_Nazwa=@Seria),
						(Select SER_Nazwa FROM CDN.DokDefinicje 
						INNER JOIN CDN.Serie ON SER_GIDTyp = Dok_SerTyp AND SER_GIDNumer = Dok_SerNumer
						WHERE Dok_Id = @DokId))
	
	IF ISNULL(@Numer,0)&lt;&gt;0 AND EXISTS(SELECT * FROM CDN.ProdPlany WHERE PPL_Rok=@Rok AND PPL_Miesiac=@Miesiac AND PPL_Seria=@Seria AND PPL_Numer=@Numer)
    BEGIN 
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowyPlanProdukcji: Wystąpił błąd podczas dodawania planu produkcji. Dokument o takim numerze już istnieje w bazie.', 16, 1)
		SELECT 5 AS ERROR
		RETURN 5
	END
 

	--Pobranie numeru dokumentu przed samym insertem
	if isnull(@Numer,0)=0
	 select @Numer=isnull(max(PPL_Numer),0)+1 from CDN.ProdPlany with(nolock) WHERE PPL_Seria=@Seria

	IF @MagDlaKolOgolnieDostepna IS NULL OR @MagDlaKolOgolnieDostepna NOT IN(@MagDlaKolWszystkie, @MagDlaKolWybrane) BEGIN 
		SET @MagDlaKolOgolnieDostepna = (Select Dok_PPLIloscOgolnieDostepna FROM CDN.DokDefinicje WHERE Dok_Id = @DokId)	
	END

	IF @MagDlaKolWDrodze IS NULL OR @MagDlaKolWDrodze NOT IN(@MagDlaKolWszystkie, @MagDlaKolWybrane) BEGIN 
		SET @MagDlaKolWDrodze = (Select Dok_PPLIloscWDrodze FROM CDN.DokDefinicje WHERE Dok_Id = @DokId)	
	END

	IF @ZakresRezerwacjiDlaProduktow IS NULL OR @ZakresRezerwacjiDlaProduktow NOT IN(@ZakresRezPrzeliczeniaPlanu, @WszystkieRezerwacje) BEGIN
		SET @ZakresRezerwacjiDlaProduktow = (SELECT Dok_ZakresRezerwacjiDlaProduktow FROM CDN.DokDefinicje WHERE Dok_Id = @DokId)
	END

	IF @UwzgledniajJednLogDlaProduktow IS NULL OR @UwzgledniajJednLogDlaProduktow NOT IN(@NieUwzgJednLog, @UwzgJednLog) BEGIN
		SET @UwzgledniajJednLogDlaProduktow = (SELECT Dok_UwzgJednLogProdukty FROM CDN.DokDefinicje WHERE Dok_Id = @DokId)
	END

	IF @UwzgledniajJednLogDlaMaterialow IS NULL OR @UwzgledniajJednLogDlaMaterialow NOT IN(@NieUwzgJednLog, @UwzgJednLog) BEGIN
		SET @UwzgledniajJednLogDlaMaterialow = (SELECT Dok_UwzgJednLogMaterialy FROM CDN.DokDefinicje WHERE Dok_Id = @DokId)
	END

	BEGIN TRAN

	INSERT INTO [CDN].[ProdPlany]
           ([PPL_PrzeliczenieRodzaj]
           ,[PPL_PrzeliczenieOd]
           ,[PPL_PrzeliczenieDo]
           ,[PPL_Przeliczenie]
           ,[PPL_PrzeliczenieDataCzas]
           ,[PPL_Rok]
           ,[PPL_Seria]
           ,[PPL_Miesiac]
           ,[PPL_Numer]
           ,[PPL_SkladnikiMPS]
           ,[PPL_OpeWNumer]
           ,[PPL_OpePNumer]
           ,[PPL_OpeMNumer]
           ,[PPL_OpePrzNumer]
           ,[PPL_DataCzasW]
           ,[PPL_DataCzasP]
           ,[PPL_DataCzasM]
           ,[PPL_DataCzasPrz]
           ,[PPL_Url]
           ,[PPL_Opis]
           ,[PPL_Aktywny]
           ,[PPL_Stan]
           ,[PPL_FrsId]
           ,[PPL_WSK]
           ,[PPL_ZmianyPoPrzeliczeniu]
           ,[PPL_DoProdukcjiPodst]
           ,[PPL_DoZamowieniaPodst]
           ,[PPL_TylkoBraki]
           ,[PPL_TylkoDoProdukcji]
           ,[PPL_PrzekroczonaRealizacja]
           ,[PPL_BrakMaterialow]
           ,[PPL_RodzajMat]
		   ,[PPL_MagDlaOgolnieDostepna]
		   ,[PPL_MagDlaWDrodze]
		   ,[PPL_ZakresRezerwacjiDlaProduktu]
		   ,[PPL_UwzgJednLogProdukty]
		   ,[PPL_UwzgJednLogMaterialy])
     VALUES
			(
			@PrzeliczenieRodzaj,
			@PrzeliczenieOd,
			@PrzeliczenieDo,
			0,
			0,
			@Rok,
			@Seria,
			@Miesiac,
			@Numer,
			@SkladnikiMPS,
			@OpeWystNumer,
			0,
			@OpeModNumer,
			0,
			@DataCzasWyst,
			0,
			@DataCzasMod,
			0,
			ISNULL(@URL,''),
			ISNULL(@Opis,''),
			@SesjaID,
			1,
			@FrsId,
			0,
			0,
			@DoProdukcjiPodst,
                        @DoZamowieniaPodst,
                        @TylkoBraki,
                        @TylkoDoProdukcji,
                        @PrzekroczonaRealizacja,
                        @BrakMaterialow,
                        @RodzajMat,
						@MagDlaKolOgolnieDostepna,
						@MagDlaKolWDrodze,
						@ZakresRezerwacjiDlaProduktow,
						@UwzgledniajJednLogDlaProduktow,
						@UwzgledniajJednLogDlaMaterialow
			)


	IF @@ROWCOUNT=0 BEGIN		
		ROLLBACK TRAN					
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowyPlanProdukcji: Wystąpił błąd podczas dodawania planu produkcji. Nie powiódł się zapis do tabeli CDN.ProdPlany.', 16, 1)	
		SELECT 1 AS ERROR
		RETURN 1
	END	
	--OK:
	SET @PPLId = scope_identity()
	
	SET @TwGNumer = (SELECT TOP 1 TwG_GIDNumer FROM CDN.TwrGrupy WHERE TwG_GIDNumer = @TwGNumer AND TwG_GIDTyp = -16)
	IF @TwGNumer IS NULL SET @TwGNumer = 0
	EXEC @Wynik = CDN.XLDodajTwrGrupaPlanProdukcji @PPLID, @SesjaID, @TwGNumer
	IF @Wynik &gt; 0 BEGIN						
		ROLLBACK TRAN
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowyPlanProdukcji: Wystąpił błąd podczas dodawania grupy towarowej do planu produkcji. Nie powiodło się dodawanie wpisu do tabeli CDN.ProdPlanyTwG.', 16, 1)
		SELECT @Wynik AS ERROR
		RETURN @Wynik
	END		
	IF @MagNumer &gt; -1 BEGIN
		SET @MagNumer = COALESCE((SELECT MAG_GIDNumer FROM CDN.Magazyny WHERE MAG_GIDNumer=@MagNumer),(SELECT MAG_GIDNumer FROM CDN.Magazyny WHERE MAG_Kod=@MagKod)) 	
		IF @MagNumer IS NULL BEGIN
			SET @MagNumer = (Select Dok_MagZNumer FROM CDN.DokDefinicje WHERE Dok_Id = @DokId)
		END
	END

	IF @MagNumer &gt; 0 BEGIN
		EXEC @Wynik = CDN.XLDodajMagazynPlanProdukcji @PPLID, @SesjaID, @MagNumer, NULL, 0, 1, DEFAULT
		IF @Wynik &gt; 0 BEGIN						
			ROLLBACK TRAN
			IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowyPlanProdukcji: Wystąpił błąd podczas dodawania magazynu do planu produkcji. Nie powiodło się dodawanie wpisu do tabeli CDN.ProdPlanyMag.', 16, 1)
			SELECT @Wynik AS ERROR
			RETURN @Wynik
		END	
		SET @MagKod = (SELECT MAG_Kod FROM CDN.Magazyny WHERE MAG_GIDNumer = @MagNumer)
	END	

	IF @MagDlaKolOgolnieDostepna = 1 BEGIN
		SET @MagNumerOgolnieDostepna = COALESCE((SELECT MAG_GIDNumer FROM CDN.Magazyny WHERE MAG_GIDNumer=@MagNumerOgolnieDostepna),
													(SELECT MAG_GIDNumer FROM CDN.Magazyny WHERE MAG_Kod=@MagKodOgolnieDostepna)) 	

		IF @MagNumerOgolnieDostepna IS NULL BEGIN
			IF (SELECT COUNT(MAG_GIDNumer) FROM CDN.Magazyny) &lt;&gt; (SELECT COUNT(DokM_MagNumer) FROM CDN.DokMagazyny WHERE DOKM_DokId = @DokId AND DOKM_Rodzaj =@MagPrzypisanyDoOgolnieDostepna)
			BEGIN
				DECLARE MagNumDlaOgolnieDostepna CURSOR FOR SELECT DOKM_MagNumer FROM CDN.DokMagazyny WHERE DOKM_DokId = @DokId AND DOKM_Rodzaj = @MagPrzypisanyDoOgolnieDostepna
				OPEN MagNumDlaOgolnieDostepna
				FETCH NEXT FROM MagNumDlaOgolnieDostepna INTO @MagNumerOgolnieDostepna
				WHILE @@FETCH_STATUS = 0
				BEGIN
					EXEC @Wynik = CDN.XLDodajMagazynPlanProdukcji @PPLID, @SesjaID, @MagNumerOgolnieDostepna, NULL, 0, 1, @MagPrzypisanyDoOgolnieDostepna
					IF @Wynik &gt; 0 BEGIN						
						ROLLBACK TRAN
						IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowyPlanProdukcji: Wystąpił błąd podczas dodawania magazynu do planu produkcji. Nie powiodło się dodawanie wpisu do tabeliCDN.ProdPlanyMag.', 16, 1)
						CLOSE MagNumDlaOgolnieDostepna
						DEALLOCATE MagNumDlaOgolnieDostepna
						SELECT @Wynik AS ERROR
						RETURN @Wynik
					END	
					FETCH NEXT FROM MagNumDlaOgolnieDostepna INTO @MagNumerOgolnieDostepna
				END
				CLOSE MagNumDlaOgolnieDostepna
				DEALLOCATE MagNumDlaOgolnieDostepna
			END
		END
		ELSE 
		BEGIN
			IF @MagNumerOgolnieDostepna &gt; 0 BEGIN
				EXEC @Wynik = CDN.XLDodajMagazynPlanProdukcji @PPLID, @SesjaID, @MagNumerOgolnieDostepna, NULL, 0, 1, @MagPrzypisanyDoOgolnieDostepna
				IF @Wynik &gt; 0 BEGIN						
					ROLLBACK TRAN
					IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowyPlanProdukcji: Wystąpił błąd podczas dodawania magazynu do planu produkcji. Nie powiodło się dodawanie wpisu do tabeliCDN.ProdPlanyMag.', 16, 1)
					SELECT @Wynik AS ERROR
					RETURN @Wynik
				END	
			END
			
		END
	END

	IF @MagDlaKolWDrodze = 1 BEGIN
		SET @MagNumerWDrodze = COALESCE((SELECT MAG_GIDNumer FROM CDN.Magazyny WHERE MAG_GIDNumer=@MagNumerWDrodze),
													(SELECT MAG_GIDNumer FROM CDN.Magazyny WHERE MAG_Kod=@MagKodWDrodze)) 	

		IF @MagNumerWDrodze IS NULL BEGIN
			IF (SELECT COUNT(MAG_GIDNumer) FROM CDN.Magazyny) &lt;&gt; (SELECT COUNT(DokM_MagNumer) FROM CDN.DokMagazyny WHERE DOKM_DokId = @DokId AND DOKM_Rodzaj = @MagPrzypisanyDoWDrodze)
			BEGIN
				DECLARE MagNumDlaWDrodze CURSOR FOR SELECT DOKM_MagNumer FROM CDN.DokMagazyny WHERE DOKM_DokId = @DokId AND DOKM_Rodzaj = @MagPrzypisanyDoWDrodze
				OPEN MagNumDlaWDrodze
				FETCH NEXT FROM MagNumDlaWDrodze INTO @MagNumerWDrodze
				WHILE @@FETCH_STATUS = 0
				BEGIN
					EXEC @Wynik = CDN.XLDodajMagazynPlanProdukcji @PPLID, @SesjaID, @MagNumerWDrodze, NULL, 0, 1, @MagPrzypisanyDoWDrodze
					IF @Wynik &gt; 0 BEGIN						
						ROLLBACK TRAN
						IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowyPlanProdukcji: Wystąpił błąd podczas dodawania magazynu do planu produkcji. Nie powiodło się dodawanie wpisu do tabeliCDN.ProdPlanyMag.', 16, 1)
						CLOSE MagNumDlaWDrodze
						DEALLOCATE MagNumDlaWDrodze
						SELECT @Wynik AS ERROR
						RETURN @Wynik
					END	
					FETCH NEXT FROM MagNumDlaWDrodze INTO @MagNumerWDrodze
				END

				CLOSE MagNumDlaWDrodze
				DEALLOCATE MagNumDlaWDrodze
			END
		END
		ELSE 
		BEGIN

			IF @MagNumerWDrodze &gt; 0 BEGIN
				EXEC @Wynik = CDN.XLDodajMagazynPlanProdukcji @PPLID, @SesjaID, @MagNumerWDrodze, NULL, 0, 1, @MagPrzypisanyDoWDrodze
				IF @Wynik &gt; 0 BEGIN						
					ROLLBACK TRAN
					IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowyPlanProdukcji: Wystąpił błąd podczas dodawania magazynu do planu produkcji. Nie powiodło się dodawanie wpisu do tabeliCDN.ProdPlanyMag.', 16, 1)
					SELECT @Wynik AS ERROR
					RETURN @Wynik
				END	
			END
		END
	END
	
			
	IF @Tryb = 1--tylko w trybie wewnetrznym
	BEGIN	
		SELECT @IDObiektu = ISNULL(MAX(OBO_IDObiektu),0)+1 FROM CDN.OBiektyObce WITH (NOLOCK)
		INSERT INTO CDN.ObiektyObce (OBO_IDSesji,OBO_GIDTyp,OBO_GIDFirma,OBO_GIDNumer,OBO_GIDLp,OBO_TSOtwarty,OBO_IdObiektu,OBO_IdAPI) VALUES(@SesjaID,@Typ_ProdPlany,0,@PPLId,0,@TimeStamp,@IDObiektu,0)
		IF @@ERROR &lt;&gt; 0
		BEGIN
			ROLLBACK TRAN
			RAISERROR('XLNowyPlanProdukcji: Wystąpił błąd podczas dodawania planu produkcji. Nie powiodło się dodawanie wpisu do tabeli CDN.ObiektyObce.',16,1)
			SELECT @Wynik AS ERROR
			RETURN 6
		END
	END
	COMMIT TRAN

	SELECT PPL_Id, PPL_PrzeliczenieRodzaj, PPL_PrzeliczenieOd, PPL_PrzeliczenieDo, PPL_Rok, PPL_Seria, PPL_Miesiac, PPL_Numer, PPL_SkladnikiMPS,
	PPL_OpeWNumer, @OpeWystKod PPL_OpeWKod, PPL_OpeMNumer, @OpeModKod PPL_OpeMKod, PPL_DataCzasW, PPL_DataCzasM, PPL_Url, PPL_Opis, PPL_FrsId, PPL_DoProdukcjiPodst,
	@MagNumer MagNumer, @MagKod MagKod, @TwGNumer TwGNumer, ISNULL(@IDObiektu,0) IDObiektu
	FROM CDN.ProdPlany(nolock) where PPL_Id = @PPLId
	SET NOCOUNT OFF
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XLDodajMagazynPlanProdukcji]"></A><PRE>
          <FONT SIZE="2"><I>/* [XLDodajMagazynPlanProdukcji] */</I><BR>
CREATE PROCEDURE [CDN].[XLDodajMagazynPlanProdukcji]
(
/* ==========================================================================================
        SQL API: Procedura serwerowa do dodawania magazynu do planu produkcji

        Parametry wejściowe:
   ========================================================================================== */
		@PlanProdId INT,					    -- identyfikator planu produkcji
        @SesjaID	int,				-- ID bieżącej sesji
        @MagNumer INT = NULL,			-- identyfikator magazyny
        @MagKod NVARCHAR(10) = NULL,	-- kod magazyny
        @Komunikat	TINYINT = 0,		-- Czy wyswietlac komunikat o bledzie	
        @ZwrocTylkoBledy TINYINT = 0,
		@MagDlaElem	TINYINT = 0			-- Magazyn dla którego elementu planu
/* ==========================================================================================
        Błędy:
        7 : Wystąpił błąd podczas dodawania magazynu do planu produkcji. Nie znalezionio planu produkcji.
        8 : Wystąpił błąd podczas dodawania magazynu do planu produkcji. Podany plan produkcji nie jest aktywny w obecnej sesji.
        9 : Wystąpił błąd podczas dodawania magazynu do planu produkcji. Nie znaleziono magazynu.
        10 : Wystąpił błąd podczas dodawania magazynu do planu produkcji. Nie powiodło się dodawanie wpisu do tabeli CDN.ProdPlanyMag.
   ========================================================================================== */
)
AS
BEGIN
DECLARE @PPLAktywny INT
DECLARE @PPLID INT
DECLARE @Typ_ProdPlany INT
DECLARE @DodMagNum INT
	     
SET @Typ_ProdPlany = 14360 

SET NOCOUNT ON	
	SET @PPLID = (SELECT PPL_Id FROM CDN.ProdPlany WHERE PPL_Id = @PlanProdId AND PPL_Aktywny = @SesjaID)
	
	IF @MagDlaElem = 0
	BEGIN
		SET @DodMagNum = COALESCE((SELECT MAG_GIDNumer FROM 
												CDN.ProdPlany
												CROSS APPLY CDN.DokDostepneMagazyny(PPL_FrsId,0,@Typ_ProdPlany,0,0,0,0)
												WHERE MAG_GIDNumer=@MagNumer AND PPL_ID = @PPLID),
							 (SELECT MAG_GIDNumer FROM 
												CDN.ProdPlany
												CROSS APPLY CDN.DokDostepneMagazyny(PPL_FrsId,0,@Typ_ProdPlany,0,0,0,0)
												WHERE MAG_Kod=@MagKod AND PPL_ID = @PPLID))
	END
	ELSE
	BEGIN
			SET @DodMagNum = COALESCE((SELECT MAG_GIDNumer FROM 
												CDN.ProdPlany
												CROSS JOIN CDN.Magazyny
												WHERE MAG_GIDNumer=@MagNumer AND PPL_ID = @PPLID),
							 (SELECT MAG_GIDNumer FROM 
												CDN.ProdPlany
												CROSS JOIN CDN.Magazyny
												WHERE MAG_Kod=@MagKod AND PPL_ID = @PPLID))
	END

	SELECT @PPLAktywny = PPL_Aktywny From CDN.ProdPlany WHERE PPL_Id = @PlanProdId
	IF @PPLAktywny IS NULL
	BEGIN			
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajMagazynPlanProdukcji: Wystąpił błąd podczas dodawania magazynu do planu produkcji. Nie znalezionio planu produkcji.', 16, 1)
		SELECT 7 AS ERROR
		RETURN 7
	END	
	IF @PPLAktywny != @SesjaID 	
	BEGIN		
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajMagazynPlanProdukcji: Wystąpił błąd podczas dodawania magazynu do planu produkcji. Podany plan produkcji nie jest aktywny w obecnej sesji.', 16, 1)
		SELECT 8 AS ERROR
		RETURN 8
	END
	IF @DodMagNum IS NULL
	BEGIN			
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajMagazynPlanProdukcji: Wystąpił błąd podczas dodawania magazynu do planu produkcji. Nie znaleziono magazynu.', 16, 1)
		SELECT 9 AS ERROR
		RETURN 9
	END	
	INSERT INTO CDN.ProdPlanyMag
			(
			[PPM_MagNumer],
			[PPM_PPLId],
			[PPM_MagDlaElem]
			)
	VALUES
			(
			@DodMagNum,
			@PPLID,
			@MagDlaElem
			)
			
	IF @@ROWCOUNT=0 BEGIN					
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajMagazynPlanProdukcji: Wystąpił błąd podczas dodawania magazynu do planu produkcji. Nie powiodło się dodawanie wpisu do tabeli CDN.ProdPlanyMag.', 16, 1)
		RETURN 10
	END	
	IF @ZwrocTylkoBledy = 0 SELECT MAG_GIDNumer MagNumer, MAG_Kod MagKod FROM CDN.Magazyny WHERE MAG_GIDNumer = @MagNumer
	RETURN 0
	SET NOCOUNT OFF
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XLUsunMagazynPlanProdukcji]"></A><PRE>
          <FONT SIZE="2"><I>/* [XLUsunMagazynPlanProdukcji] */</I><BR>
CREATE PROCEDURE [CDN].[XLUsunMagazynPlanProdukcji]
(
/* ==========================================================================================
        SQL API: Procedura serwerowa do dodawania magazynu do planu produkcji

        Parametry wejściowe:
   ========================================================================================== */
		@PlanProdId INT,				-- identyfikator planu produkcji
        @SesjaID	int,				-- ID bieżącej sesji
        @MagNumer INT = NULL,			-- identyfikator magazyny
        @MagKod NVARCHAR(10) = NULL,	-- kod magazyny
        @Komunikat	TINYINT = 0,		-- Czy wyswietlac komunikat o bledzie
		@MagDlaElem TINYINT = 0			-- Magazyn dla którego elementu planu
/* ==========================================================================================
        Błędy:
        7 : Wystąpił błąd podczas usuwania magazynu z planu produkcji. Nie znalezionio planu produkcji.
        8 : Wystąpił błąd podczas usuwania magazynu z planu produkcji. Podany plan produkcji nie jest aktywny w obecnej sesji.
        9 : Wystąpił błąd podczas usuwania magazynu z planu produkcji. Nie znaleziono magazynu.
        13 : Wystąpił błąd podczas usuwania magazynu z planu produkcji. Nie powiodło się usunięcie rekordu z tabeli CDN.ProdPlanyMag.
   ========================================================================================== */
)
AS
BEGIN
DECLARE @PPLAktywny INT

	SET @MagNumer = COALESCE((SELECT MAG_GIDNumer FROM CDN.Magazyny WHERE MAG_GIDNumer=@MagNumer),(SELECT MAG_GIDNumer FROM CDN.Magazyny WHERE MAG_Kod=@MagKod)) 
	DELETE FROM CDN.ProdPlanyMag 
		WHERE PPM_MagNumer = @MagNumer AND PPM_MagDlaElem = @MagDlaElem AND PPM_PPLId = ((SELECT PPL_Id FROM CDN.ProdPlany WHERE PPL_Id = @PlanProdId AND PPL_Aktywny = @SesjaID))			
	IF @@ROWCOUNT = 0 BEGIN	
		SELECT @PPLAktywny = PPL_Aktywny From CDN.ProdPlany WHERE PPL_Id = @PlanProdId
		IF @PPLAktywny IS NULL
		BEGIN			
			IF @Komunikat &lt;&gt; 0 RAISERROR ('XLUsunMagazynPlanProdukcji: Wystąpił błąd podczas usuwania magazynu z planu produkcji. Nie znalezionio planu produkcji.', 16, 1)
			RETURN 7
		END	
		IF @PPLAktywny != @SesjaID 	
		BEGIN		
			IF @Komunikat &lt;&gt; 0 RAISERROR ('XLUsunMagazynPlanProdukcji: Wystąpił błąd podczas usuwania magazynu z planu produkcji. Podany plan produkcji nie jest aktywny w obecnej sesji.', 16, 1)
			RETURN 8
		END	
		IF @MagNumer IS NULL
		BEGIN			
			IF @Komunikat &lt;&gt; 0 RAISERROR ('XLUsunMagazynPlanProdukcji: Wystąpił błąd podczas usuwania magazynu z planu produkcji. Nie znaleziono magazynu.', 16, 1)
			RETURN 9
		END				
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLUsunMagazynPlanProdukcji: Wystąpił błąd podczas usuwania magazynu z planu produkcji. Nie powiodło się usunięcie rekordu z tabeli CDN.ProdPlanyMag.', 16, 1)
		RETURN 13
	END	
RETURN 0
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XLDodajTwrGrupaPlanProdukcji]"></A><PRE>
          <FONT SIZE="2"><I>/* [XLDodajTwrGrupaPlanProdukcji] */</I><BR>
CREATE PROCEDURE [CDN].[XLDodajTwrGrupaPlanProdukcji]
(
/* ==========================================================================================
        SQL API: Procedura serwerowa do dodawania grupy towarów do planu produkcji

        Parametry wejściowe:
   ========================================================================================== */
		@PlanProdId INT,				-- identyfikator planu produkcji
        @SesjaID	int,				-- ID bieżącej sesji
        @TwrGrupaNumer INT ,			-- identyfikator grupy towarowej
        @Komunikat	TINYINT = 0			-- Czy wyswietlac komunikat o bledzie	
/* ==========================================================================================
        Błędy:
        7 : Wystąpił błąd podczas dodawania grupy towarowej do planu produkcji. Nie znalezionio planu produkcji.
        8 : Wystąpił błąd podczas dodawania grupy towarowej do planu produkcji. Podany plan produkcji nie jest aktywny w obecnej sesji.
        11 : Wystąpił błąd podczas dodawania grupy towarowej do planu produkcji. Nie znaleziono grupy towarowej.
        12 : Wystąpił błąd podczas dodawania grupy towarowej do planu produkcji. Nie powiodło się dodawanie wpisu do tabeli CDN.ProdPlanyTwG.
   ========================================================================================== */
)
AS
BEGIN
DECLARE @PPLAktywny INT
DECLARE @PPLID	INT

SET @PPLID = (SELECT PPL_Id FROM CDN.ProdPlany WHERE PPL_Id = @PlanProdId AND PPL_Aktywny = @SesjaID)
	INSERT INTO CDN.ProdPlanyTwG
			(
			[PPG_TwGNumer],
			[PPG_TwGTyp],
			[PPG_PPLId]
			)
	VALUES
			(
			@TwrGrupaNumer,
			-16,
			@PPLID
			)
			
	IF @@ROWCOUNT=0 BEGIN	
		SELECT @PPLAktywny = PPL_Aktywny From CDN.ProdPlany WHERE PPL_Id = @PlanProdId
		IF @PPLAktywny IS NULL
		BEGIN			
			IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajTwrGrupaPlanProdukcji: Wystąpił błąd podczas dodawania grupy towarowej do planu produkcji. Nie znalezionio planu produkcji.', 16, 1)
			RETURN 7
		END	
		IF @PPLAktywny != @SesjaID 	
		BEGIN		
			IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajTwrGrupaPlanProdukcji: Wystąpił błąd podczas dodawania grupy towarowej do planu produkcji. Podany plan produkcji nie jest aktywny w obecnej sesji.', 16, 1)
			RETURN 8
		END	
		IF @TwrGrupaNumer = 0 
		BEGIN			
			IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajMagazynPlanProdukcji: Wystąpił błąd podczas dodawania grupy towarowej do planu produkcji. Nie znaleziono grupy towarowej.', 16, 1)
			RETURN 11
		END				
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajMagazynPlanProdukcji: Wystąpił błąd podczas dodawania grupy towarowej do planu produkcji. Nie powiodło się dodawanie wpisu do tabeli CDN.ProdPlanyTwG.', 16, 1)
		RETURN 12
	END	
RETURN 0
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XLUsunTwrGrupaPlanProdukcji]"></A><PRE>
          <FONT SIZE="2"><I>/* [XLUsunTwrGrupaPlanProdukcji] */</I><BR>
CREATE PROCEDURE [CDN].[XLUsunTwrGrupaPlanProdukcji]
(
/* ==========================================================================================
        SQL API: Procedura serwerowa do usuwania grupy towarów do planu produkcji

        Parametry wejściowe:
   ========================================================================================== */
		@PlanProdId INT,			    -- identyfikator planu produkcji
        @SesjaID	int,				-- ID bieżącej sesji
        @TwGNumer INT ,			-- identyfikator grupy towarowej
        @Komunikat	TINYINT = 0			-- Czy wyswietlac komunikat o bledzie	
/* ==========================================================================================
        Błędy:
        7 : Wystąpił błąd podczas dodawania grupy towarowej do planu produkcji. Nie znalezionio planu produkcji.
        8 : Wystąpił błąd podczas dodawania grupy towarowej do planu produkcji. Podany plan produkcji nie jest aktywny w obecnej sesji.
        11 : Wystąpił błąd podczas dodawania grupy towarowej do planu produkcji. Nie znaleziono grupy towarowej.
        14 : Wystąpił błąd podczas dodawania grupy towarowej do planu produkcji. Nie powiodło się usuwanie rekordu z tabeli CDN.ProdPlanyTwG.
   ========================================================================================== */
)
AS
BEGIN
DECLARE @PPLAktywny INT

	DELETE FROM CDN.ProdPlanyTwG WHERE PPG_TwGNumer = @TwGNumer AND PPG_PPLId = (SELECT PPL_Id FROM CDN.ProdPlany WHERE PPL_Id = @PlanProdId AND PPL_Aktywny = @SesjaID)
			
	IF @@ROWCOUNT=0 BEGIN	
		SELECT @PPLAktywny = PPL_Aktywny From CDN.ProdPlany WHERE PPL_Id = @PlanProdId
		IF @PPLAktywny IS NULL
		BEGIN			
			IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajTwrGrupaPlanProdukcji: Wystąpił błąd podczas usuwania grupy towarowej z planu produkcji. Nie znalezionio planu produkcji.', 16, 1)
			RETURN 7
		END	
		IF @PPLAktywny != @SesjaID 	
		BEGIN		
			IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajTwrGrupaPlanProdukcji: Wystąpił błąd podczas usuwania grupy towarowej z planu produkcji. Podany plan produkcji nie jest aktywny w obecnej sesji.', 16, 1)
			RETURN 8
		END	
		IF @TwGNumer = 0 
		BEGIN			
			IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajMagazynPlanProdukcji: Wystąpił błąd podczas usuwania grupy towarowej z planu produkcji. Nie znaleziono grupy towarowej.', 16, 1)
			RETURN 11
		END				
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajMagazynPlanProdukcji: Wystąpił błąd podczas usuwania grupy towarowej z planu produkcji. Nie powiodło się usuwanie rekordu z tabeli CDN.ProdPlanyTwG.', 16, 1)
		RETURN 14
	END	
RETURN 0
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XLPrzeliczPlanProdukcji2]"></A><PRE>
          <FONT SIZE="2"><I>/* [XLPrzeliczPlanProdukcji2] */</I><BR>
CREATE PROCEDURE [CDN].[XLPrzeliczPlanProdukcji2](
/* ==========================================================================================
        Procedura serwerowa wołana wyłącznie z [CDN].[XLPrzeliczPlanProdukcji]
   ========================================================================================== */
         @PlanProdId INT,
		 @PrzeliczenieRodzaj INT,
		 @PrzeliczenieData INT,
		 @DoProdukcjiPodst INT,
         @FrsId INT,
         @KolejnePrzeliczeniePlanu TINYINT,
         @RezDataAkt INT,
         @PelneRozwiniecieMaterialowe INT,
         @TwrNumer INT,
         @DoZamowieniaPodst INT,
         @Stan TINYINT,
         @CzyNormatywyZMagazynu TINYINT,
		 @ZakresRezerwacjiOd INT,
		 @ZakresRezerwacjiDo INT
)
AS
BEGIN
    DECLARE @TerminPozycjeRozklad INT
    DECLARE @TechnologiaIdPozycjeRozklad INT
    DECLARE @TwrNumerPozycjeRozklad INT
    DECLARE @PPPIdPozycjeRozklad INT
    DECLARE @EdytowanyPozycjeRozklad INT
    DECLARE @IloscDoProdukcjiPozycjeRozklad DECIMAL(15, 4)
    DECLARE @IloscMinProdukcjiPozycjeRozklad DECIMAL(15, 4)
    DECLARE @IloscBrakNaMPSPozycjeRozklad DECIMAL(15, 4)
	DECLARE @IloscMPSRozklad DECIMAL(15, 4)
	DECLARE @IloscOgolnieDostepnaRozklad DECIMAL(15,4)
    DECLARE @ZapasBezpieczenstwaPozycjeRozklad DECIMAL(15, 4)
    DECLARE @EOQPozycjeRozklad DECIMAL(15, 4)
    DECLARE @WielokrotnoscPozycjeRozklad DECIMAL(15, 4)
    DECLARE @ZaokragleniePozycjeRozklad DECIMAL(15, 4)
    DECLARE @IloscWygenerowanoPozycjeRozklad DECIMAL(15, 4)
	DECLARE @IloscRezerwacjiRozklad DECIMAL(15,4)
    DECLARE @RozlozoneZasobyPozycjeRozklad TABLE (TechnologiaId INT, TwrNumer INT, Termin INT)

    DECLARE @PPT_IloscPotrzeba DECIMAL(15,4)
    DECLARE @PPT_IloscOgolnieDostepna DECIMAL(15,4)
    DECLARE @PPT_IloscZrealizowana DECIMAL(15,4)
    DECLARE @PPT_ZapasBezpieczenstwa DECIMAL(15,4)
    DECLARE @PPT_EOQ DECIMAL(15,4)
    DECLARE @PPT_Wielokrotnosc DECIMAL(15,4)
    DECLARE @DoZamowienia DECIMAL(15,4)
    DECLARE @PPT_Zaokraglenie DECIMAL (15,4)
    DECLARE @PPT_Id INT
	DECLARE @PPT_DoWykorzystania DECIMAL (15,4)

    DECLARE @Zapas DECIMAL(15,4)
    DECLARE @PPPDokZrdTypRozklad INT

	DECLARE @PotwierdzonyPlanProdukcji INT
	DECLARE @PrzeliczenieWgOkresuMRP INT
    DECLARE @PrzeliczenieWgTerminu INT
    DECLARE @PrzeliczenieWgOkresu INT
    DECLARE @PrzeliczenieWgDok INT
    DECLARE @MPSZS TINYINT
    DECLARE @MPSPLZ TINYINT
    DECLARE @MPSZP TINYINT
    DECLARE @MPSZW TINYINT
    DECLARE @RodzajZak SMALLINT
    DECLARE @RodzajSpr SMALLINT
    DECLARE @RodzajZS SMALLINT
    DECLARE @RodzajZWSpr SMALLINT
    DECLARE @RodzajZWZak SMALLINT
    DECLARE @RodzajZP SMALLINT
    DECLARE @RodzajPLZ SMALLINT
    DECLARE @EdycjaIlosc INT
    DECLARE @EdycjaDodanyRecznie INT
    DECLARE @EdycjaTermin INT
    DECLARE @EdycjaTerminDo INT
    DECLARE @TypZP INT
    DECLARE @Typ_ProdPlany INT
	DECLARE @MagWgPotrzeb TINYINT
	DECLARE @MagDlaKolOgolnieDostepna TINYINT
	DECLARE @MagDlaKolWDrodze TINYINT

	SET @TypZP =14343
	SET @PotwierdzonyPlanProdukcji =2
    SET @PrzeliczenieWgOkresuMRP = 4
    SET @PrzeliczenieWgTerminu = 3
    SET @PrzeliczenieWgOkresu = 2
    SET @PrzeliczenieWgDok = 1
    SET @MPSZS = 1
    SET @MPSPLZ = 2
    SET @MPSZP = 4
    SET @MPSZW = 8
    SET @RodzajZak = 0
    SET @RodzajZWZak = 1
    SET @RodzajSpr = 2
    SET @RodzajZS = 3
    SET @RodzajZP = 4
    SET @RodzajZWSpr = 5
    SET @RodzajPLZ = 6
    SET @EdycjaIlosc = 1
    SET @EdycjaDodanyRecznie = 2
    SET @EdycjaTermin = 4
    SET @EdycjaTerminDo = 8
	SET @MagWgPotrzeb = 0
	SET @MagDlaKolOgolnieDostepna = 1
	SET @MagDlaKolWDrodze = 2

	SET @Typ_ProdPlany = 14360

     DECLARE @Dok_PPLOptymalizacjaDoProdukcji INT
     IF (EXISTS(SELECT * FROM CDN.DokDefinicje WHERE Dok_FrsId = @FrsId AND Dok_GIDTyp = @Typ_ProdPlany AND Dok_PPLOptymalizacjaDoProdukcji=1))
		 SET @Dok_PPLOptymalizacjaDoProdukcji=1
     ELSE
		 SET @Dok_PPLOptymalizacjaDoProdukcji=0

     DECLARE @Dok_PPLOptymalizacjaDoZamowienia INT
     IF (EXISTS(SELECT * FROM CDN.DokDefinicje WHERE Dok_FrsId = @FrsId AND Dok_GIDTyp = @Typ_ProdPlany AND Dok_PPLOptymalizacjaDoZamowienia=1))
		SET @Dok_PPLOptymalizacjaDoZamowienia=1
     ELSE
        SET @Dok_PPLOptymalizacjaDoZamowienia=0

	DECLARE @ZrodloMagDlaKolOgolnieDostepna INT
	IF (SELECT PPL_MagDlaOgolnieDostepna FROM CDN.ProdPlany WHERE PPL_Id = @PlanProdId) = 1
		SET	@ZrodloMagDlaKolOgolnieDostepna = @MagDlaKolOgolnieDostepna
	ELSE
		SET	@ZrodloMagDlaKolOgolnieDostepna = @MagWgPotrzeb
			
	DECLARE @ZrodloMagDlaKolWDrodze INT
	IF (SELECT PPL_MagDlaWDrodze FROM CDN.ProdPlany WHERE PPL_Id = @PlanProdId) = 1
		SET	@ZrodloMagDlaKolWDrodze = @MagDlaKolWDrodze
	ELSE
		SET	@ZrodloMagDlaKolWDrodze = @MagWgPotrzeb	

	DECLARE @UwzgJedLogWMaterialach INT = 0
	SELECT @UwzgJedLogWMaterialach = PPL_UwzgJednLogMaterialy FROM CDN.ProdPlany WHERE PPL_Id = @PlanProdId

GOTO KolejnoscKrokow

AktuzalizacjaTerminowDokZwiazanychEdytowanychDlaProduktow:
	BEGIN
		IF @PrzeliczenieRodzaj = @PrzeliczenieWgOkresu
        BEGIN --wybrane wg okresu, tutaj termin brany jest z okresu planistycznego
			UPDATE CDN.ProdPlanyProdukty
            SET PPP_IloscOgolnieDostepna =  Case When TabPPP.OgolnieDostepna &lt; 0
					THEN 0 ELSE TabPPP.OgolnieDostepna End, 
				PPP_IloscWDrodze = TabPPP.WDrodze, 
				PPP_IloscNaZp = ISNULL((
					SELECT SUM(PZE_Ilosc)
                    FROM CDN.ProdZlecElem
						INNER JOIN CDN.DokZwiazane ON DOZ_DOKNumer = PZE_Id
							AND DOZ_DOKTyp = 14343
                    WHERE DOZ_ZRDNumer = PPP_Id
						AND DOZ_ZRDTyp = 14361
                ), 0), 
				PPP_IloscWToku = ISNULL(ZasobyMPS.IloscZasobPZA, 0) - ISNULL(ZasobyMPS.IloscPwPZA, 0), 
				PPP_IloscZrealizowana = ISNULL(ZasobyMPS.IloscPwPZA, 0), 
				PPP_IloscZaplanowana = ISNULL((
					SELECT SUM(PLK_Ilosc)
                    FROM CDN.ProdZlecElem
						INNER JOIN CDN.DokZwiazane ON DOZ_DOKNumer = PZE_Id
							AND DOZ_DOKTyp = 14343
                        INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                    WHERE DOZ_ZRDNumer = PPP_Id
						AND DOZ_ZRDTyp = 14361
                        AND PLK_ObiTyp = 2592
                ), 0)
            FROM CDN.ProdPlanyProdukty
				INNER JOIN (
					SELECT PPP_Id PPPId, (
							SELECT ISNULL(SUM(CASE
									WHEN Rodzaj &lt;= @RodzajZWZak
										THEN Ilosc
									WHEN RezGIDTyp = 2576
										THEN - Ilosc
								END), 0)
							FROM #tabCDNMPS MPSPom
							WHERE MPSPom.DataRealizacji &lt;= MPS.PPP_TerminDo
								AND (
									(
										MPSPom.DataRealizacji &gt; @PrzeliczenieData
											AND Rodzaj &lt;= @RodzajZWZak
									)
									OR Rodzaj &gt; @RodzajZWZak
							   )
							   AND MPS.PPP_TwrNumer = MPSPom.TwrNumer
							   AND MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo
							) + (
								SELECT ISNULL(SUM(MPSPom.Ilosc - MPSPom.IloscDst), 0)
                                FROM #tabCDNMPS MPSPom
                                WHERE MPSPom.MPSTyp &gt; 0
									AND MPSPom.RezGIDTyp = 2576
                                    AND MPSPom.DataRealizacji = MPS.PPP_TerminDo
                                    AND MPS.PPP_TwrNumer = MPSPom.TwrNumer
                            ) + ISNULL(SUM(CASE
										WHEN Twr_Typ IN (4,6)
											THEN 0
                                        ELSE Cast(CDN.SubstringEx(CDN.DokSumaStanowTowaru(Twr_GIDTyp, Twr_GIDFirma, Twr_GIDNumer, Twr_Typ, 32768, 1, 1, 0, 0, 2, 0, 0, MPS.PPP_TerminDo, 0, 2, @FrsId, 0, 0, 0, 0, 0, 0, - 1), ':', 1) AS DECIMAL(15, 4))
						END), 0) OgolnieDostepna, 
						(
							SELECT ISNULL(SUM(Ilosc), 0)
                            FROM #tabCDNMPS MPSPom
                            WHERE (
									(
										MPSPom.DataRealizacji &gt; MPS.PPP_TerminDo
											OR MPSPom.DataRealizacji &lt;= @PrzeliczenieData
                                    )
                                    AND Rodzaj = @RodzajZak
                            )
                            AND MPS.PPP_TwrNumer = MPSPom.TwrNumer
							AND MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo
                        ) WDrodze
                    FROM CDN.ProdPlanyProdukty MPS
                        INNER JOIN CDN.TwrKarty ON MPS.PPP_TwrNumer = Twr_GIDNumer
                    WHERE MPS.PPP_PPLId = @PlanProdId
						AND MPS.PPP_Edytowany &amp; @EdycjaDodanyRecznie &gt; 0
                    GROUP BY PPP_Id, MPS.PPP_Termin, MPS.PPP_TerminDo, Twr_GIDTyp, Twr_GIDFirma, Twr_GIDNumer, Twr_Typ, MPS.PPP_TwrNumer
                ) TabPPP ON TabPPP.PPPId = PPP_Id
                OUTER APPLY CDN.ProdPlanyZasobyMPS(PPP_Id, 14361, 0, PPP_TwrNumer, 0) ZasobyMPS
        END
        ELSE
        BEGIN
			UPDATE CDN.ProdPlanyProdukty
            SET PPP_IloscOgolnieDostepna = CASE WHEN TabPPP.OgolnieDostepna &lt; 0
						THEN 0 ELSE TabPPP.OgolnieDostepna 
				END, 
				PPP_IloscWDrodze = TabPPP.WDrodze, 
				PPP_IloscNaZp = ISNULL((
						SELECT SUM(PZE_Ilosc)
                        FROM CDN.ProdZlecElem
							INNER JOIN CDN.DokZwiazane ON DOZ_DOKNumer = PZE_Id
								AND DOZ_DOKTyp = 14343
                        WHERE DOZ_ZRDNumer = PPP_Id
							AND DOZ_ZRDTyp = 14361
                    ), 0), 
				PPP_IloscWToku = ISNULL(ZasobyMPS.IloscZasobPZA, 0) - ISNULL(ZasobyMPS.IloscPwPZA, 0), 
				PPP_IloscZrealizowana = ISNULL(ZasobyMPS.IloscPwPZA, 0), 
				PPP_IloscZaplanowana = ISNULL((
						SELECT SUM(PLK_Ilosc)
                        FROM CDN.ProdZlecElem
							INNER JOIN CDN.DokZwiazane ON DOZ_DOKNumer = PZE_Id
								AND DOZ_DOKTyp = 14343
                            INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                        WHERE DOZ_ZRDNumer = PPP_Id
							AND DOZ_ZRDTyp = 14361
                            AND PLK_ObiTyp = 2592
                ), 0)
			FROM CDN.ProdPlanyProdukty
                INNER JOIN (
                        SELECT PPP_Id PPPId, (
							SELECT ISNULL(SUM(CASE
									WHEN Rodzaj &lt;= @RodzajZWZak
										    THEN Ilosc
									WHEN RezGIDTyp = 2576
										    THEN - Ilosc
								END), 0)
                            FROM #tabCDNMPS MPSPom
                            WHERE MPSPom.DataRealizacji &lt;= MPS.PPP_Termin
								AND (
									(
										MPSPom.DataRealizacji &gt; @PrzeliczenieData
											AND 
											Rodzaj &lt;= @RodzajZWZak
                                   )
                                    OR Rodzaj &gt; @RodzajZWZak
                               )
                               AND MPS.PPP_TwrNumer = MPSPom.TwrNumer
							   AND MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo
						) + (
							SELECT ISNULL(SUM(MPSPom.Ilosc - MPSPom.IloscDst), 0)
                            FROM #tabCDNMPS MPSPom
                            WHERE MPSPom.MPSTyp &gt; 0
								AND MPSPom.RezGIDTyp = 2576
                                AND MPSPom.DataRealizacji = MPS.PPP_Termin
                                AND MPS.PPP_TwrNumer = MPSPom.TwrNumer
                        ) + ISNULL(SUM(CASE
										WHEN Twr_Typ IN (4, 6)
											THEN 0
										ELSE Cast(CDN.SubstringEx(CDN.DokSumaStanowTowaru(Twr_GIDTyp, Twr_GIDFirma, Twr_GIDNumer, Twr_Typ, 32768, 1, 1, 0, 0, 2, 0, 0, MPS.PPP_Termin, 0, 2, @FrsId, 0, 0, 0, 0, 0, 0, - 1), ':', 1) AS DECIMAL(15, 4))
						END), 0) OgolnieDostepna, (
							SELECT ISNULL(SUM(Ilosc), 0)
							FROM #tabCDNMPS MPSPom
							WHERE (
								(
									MPSPom.DataRealizacji &gt; MPS.PPP_Termin
										OR MPSPom.DataRealizacji &lt;= @PrzeliczenieData
								)
								AND Rodzaj = @RodzajZak
							)
							AND MPS.PPP_TwrNumer = MPSPom.TwrNumer
							AND MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo
						) WDrodze
                   FROM CDN.ProdPlanyProdukty MPS
						INNER JOIN CDN.TwrKarty ON MPS.PPP_TwrNumer = Twr_GIDNumer
							--left join #tabCDNStanSprzedaz StanS on StanS.DataRealizacji = MPS.PPP_Termin and StanS.TwrNumer = MPS.PPP_TwrNumer
                    WHERE MPS.PPP_PPLId = @PlanProdId
                            AND MPS.PPP_Edytowany &amp; @EdycjaDodanyRecznie &gt; 0
                    GROUP BY PPP_Id, MPS.PPP_Termin, Twr_GIDTyp, Twr_GIDFirma, Twr_GIDNumer, Twr_Typ, MPS.PPP_TwrNumer
				) TabPPP ON TabPPP.PPPId = PPP_Id
                OUTER APPLY CDN.ProdPlanyZasobyMPS(PPP_Id, 14361, 0, PPP_TwrNumer, 0) ZasobyMPS
        END


        IF @Stan &lt;&gt; @PotwierdzonyPlanProdukcji
			INSERT INTO CDN.DokZwiazane (DOZ_ZRDTyp, DOZ_ZRDFirma, DOZ_ZRDNumer, DOZ_ZRDLp, DOZ_DOKTyp, DOZ_DOKFirma, DOZ_DOKNumer, DOZ_DOKLp, DOZ_DataZwiazania, DOZ_PobierzWymiarAnalit)
			SELECT 14361, DokFirma, PPP_Id, 0, DokTyp, DokFirma, DokNumer, DokLp, DataZwiazania, 0
			FROM CDN.ProdPlanyProdukty
			INNER JOIN #tabProdPlanyProduktyDokZwiazane ON DokZrdNumer = PPP_DokZrdNumer
				AND DokZrdTyp = PPP_DokZrdTyp
				AND TechnologiaId = PPP_TechnologiaId
				AND Termin = PPP_Termin
				AND TerminDo = PPP_TerminDo
				AND TwrNumer = PPP_TwrNumer
				AND PPLId = PPP_PPLId

			UPDATE CDN.ProdPlanyProdukty
			SET PPP_IloscDoProdukcji = PPPE.PPP_IloscDoProdukcji, PPP_Edytowany = PPPE.PPP_Edytowany
			FROM CDN.ProdPlanyProdukty PPPG
			INNER JOIN #tabProdPlanyProduktyEdytowane PPPE ON PPPE.PPP_DokZrdNumer = PPPG.PPP_DokZrdNumer
				AND PPPE.PPP_DokZrdTyp = PPPG.PPP_DokZrdTyp
				AND PPPE.PPP_TechnologiaId = PPPG.PPP_TechnologiaId
				AND PPPE.PPP_Termin = PPPG.PPP_Termin
				AND PPPE.PPP_TerminDo = PPPG.PPP_TerminDo
				AND PPPE.PPP_TwrNumer = PPPG.PPP_TwrNumer
				AND PPPE.PPP_PPLId = PPPG.PPP_PPLId
			WHERE PPPE.PPP_Edytowany &amp; @EdycjaIlosc &gt; 0

			UPDATE CDN.ProdPlanyProdukty
			SET PPP_Lp = TabPPPLp.Lp
			FROM CDN.ProdPlanyProdukty
			INNER JOIN (
				SELECT PPP_Id PPPId, (
						SELECT ISNULL(MAX(PPP_Lp), 0) + 1
						FROM CDN.ProdPlanyProdukty
						WHERE PPP_PPLId = @PlanProdId
					) + ROW_NUMBER() OVER (ORDER BY PPP_DodanyLp) Lp
				FROM CDN.ProdPlanyProdukty
				WHERE PPP_PPLId = @PlanProdId
					AND PPP_Edytowany &amp; @EdycjaDodanyRecznie &gt; 0
			) TabPPPLp ON TabPPPLp.PPPId = PPP_Id
		END
    GOTO PoAktuzalizacjaTerminowDokZwiazanychEdytowanychDlaProduktow


OptymalizacjaIlosciDoProdukcjiDlaProduktow:
	CREATE TABLE #tmpProdZapas(
        TwrNr int,
        MagNr int,
        Technologia int,
        Zapas decimal(15,4)
    )
	INSERT INTO #tmpProdZapas
    SELECT DISTINCT PPP_TwrNumer, 1, PPP_TechnologiaId, 0 FROM CDN.ProdPlanyProdukty WHERE PPP_PPLId=@PlanProdId

    DECLARE @ZapasPozycjeRozklad DECIMAL(15,4)
    DECLARE PozycjeRozkladKursor CURSOR LOCAL FOR
		SELECT PPP_Id, PPP_TwrNumer, PPP_Termin, PPP_IloscMPS, PPP_IloscDoWykorzystania, PPP_IloscRez, PPP_IloscOgolnieDostepna, PPP_IloscDoProdukcji, PPP_IloscMinProdukcji, PPP_TechnologiaId, PPP_Edytowany, 
		PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, wygenerowane.Ilosc, PPP_IloscBrakNaMPS, PPP_DokZrdTyp, PPP_IloscNaZP,
		ISNULL(
                (
                    SELECT SUM(PPP_IloscMPS)
                    FROM CDN.ProdPlanyProdukty wew
                    WHERE wew.PPP_TwrNumer = zew.PPP_TwrNumer
                        AND wew.PPP_Termin &lt;= zew.PPP_Termin
                        AND wew.PPP_Id &lt; zew.PPP_Id
						AND wew.PPP_PPLId = @PlanProdId
                ), 
            0) ZapotrzebowanieDoAktMaterialu,
            ISNULL(
                (
                    SELECT SUM(PPP_IloscMPS)
                    FROM CDN.ProdPlanyProdukty wew
                    WHERE wew.PPP_TwrNumer = zew.PPP_TwrNumer
                        AND wew.PPP_Termin &lt; zew.PPP_Termin
						AND wew.PPP_PPLId = @PlanProdId
                        --AND wew.PPP_PPPId &lt; zew.PPP_PPPId
                ), 
            0) ZapotrzebowanieDoAktDnia,                
            ISNULL(
                (
                        SELECT SUM(PPP_IloscZrealizowana)
                        FROM CDN.ProdPlanyProdukty wew
                        WHERE wew.PPP_TwrNumer = zew.PPP_TwrNumer
                            AND wew.PPP_Termin &lt;= zew.PPP_Termin
							AND wew.PPP_PPLId = @PlanProdId
                            --AND wew.PPP_PPPId &lt;= zew.PPT_PPPId
                ),
            0) IloscZrealizowanaDoAktDnia
        FROM CDN.ProdPlanyProdukty zew
            OUTER APPLY (SELECT COALESCE(SUM(Ilosc),0) Ilosc FROM CDN.ProdPlanyProdWygenerowaneDok(PPP_Id, NULL) WHERE DOKTyp&lt;&gt;@TypZP) wygenerowane
        WHERE PPP_PPLId = @PlanProdId
        ORDER BY /*PPP_TwrNumer, PPP_TechnologiaId,*/ PPP_Termin, PPP_Id
	
	DECLARE @IloscDoWykorzystania DECIMAL(15,4)
	DECLARE @IloscNaZP DECIMAL(15,4)
	DECLARE @ZapasPrzedParam DECIMAL(15,4)
	DECLARE @ZapotrzebowanieDoAktMaterialu DECIMAL(15,4)
	DECLARE @ZapotrzebowanieDoAktDnia DECIMAL(15,4)
	DECLARE @IloscZrealizowanaDoAktDnia DECIMAL(15,4)
	DECLARE @DoZamowieniaProdukty DECIMAL(15,4)
	DECLARE @DoZamowieniaPrzedParam DECIMAL(15,4)
	DECLARE @IloscOgolnieDostepnaDoObliczeniaZamowienia DECIMAL(15,4)
	DECLARE @PozostalaIloscOgolnieDostepna DECIMAL(15,4)

    OPEN PozycjeRozkladKursor
    FETCH NEXT FROM PozycjeRozkladKursor
    INTO @PPPIdPozycjeRozklad, @TwrNumerPozycjeRozklad, @TerminPozycjeRozklad, @IloscMPSRozklad, @IloscDoWykorzystania, @IloscRezerwacjiRozklad, @IloscOgolnieDostepnaRozklad, 
		@IloscDoProdukcjiPozycjeRozklad, @IloscMinProdukcjiPozycjeRozklad, @TechnologiaIdPozycjeRozklad, @EdytowanyPozycjeRozklad, @ZapasBezpieczenstwaPozycjeRozklad, 
		@EOQPozycjeRozklad, @WielokrotnoscPozycjeRozklad, @ZaokragleniePozycjeRozklad, @IloscWygenerowanoPozycjeRozklad, @IloscBrakNaMPSPozycjeRozklad, 
		@PPPDokZrdTypRozklad, @IloscNaZP, @ZapotrzebowanieDoAktMaterialu, @ZapotrzebowanieDoAktDnia, @IloscZrealizowanaDoAktDnia

    WHILE @@FETCH_STATUS = 0
    BEGIN
		IF @PPPDokZrdTypRozklad = @TypZP
			SELECT @ZapasBezpieczenstwaPozycjeRozklad=0, @EOQPozycjeRozklad=0, @WielokrotnoscPozycjeRozklad=0, @ZaokragleniePozycjeRozklad=0

		IF @EdytowanyPozycjeRozklad &amp; @EdycjaIlosc &gt; 0 --ilosc ustawiona recznie, tylko zaktualizuj tabelę zapasu
		BEGIN
			UPDATE #tmpProdZapas SET Zapas = CASE
				WHEN (Zapas+@IloscDoProdukcjiPozycjeRozklad-@IloscBrakNaMPSPozycjeRozklad)&lt;=0 THEN 0
				ELSE Zapas+@IloscDoProdukcjiPozycjeRozklad-@IloscBrakNaMPSPozycjeRozklad END
			WHERE TwrNr=@TwrNumerPozycjeRozklad AND MagNr=1 AND Technologia=@TechnologiaIdPozycjeRozklad
		END
		ELSE --IF @Dok_PPLOptymalizacjaDoProdukcji = 1-- standardowa optymalizacjia
		BEGIN
		
			SET @IloscOgolnieDostepnaDoObliczeniaZamowienia =  @IloscOgolnieDostepnaRozklad  - 
				CASE WHEN (@ZapotrzebowanieDoAktMaterialu - @IloscZrealizowanaDoAktDnia) &lt; 0 THEN 0
					ELSE (@ZapotrzebowanieDoAktMaterialu - @IloscZrealizowanaDoAktDnia) END

			SET @IloscOgolnieDostepnaDoObliczeniaZamowienia = CASE WHEN @IloscOgolnieDostepnaDoObliczeniaZamowienia &lt; 0 THEN 0 ELSE @IloscOgolnieDostepnaDoObliczeniaZamowienia END

			IF  @Dok_PPLOptymalizacjaDoProdukcji = 1
				-- if zapas z poprzedniego istnieje + check na dokdef.
				SELECT @ZapasPozycjeRozklad = Zapas FROM #tmpProdZapas WHERE TwrNr = @TwrNumerPozycjeRozklad AND MagNr = 1 AND Technologia = @TechnologiaIdPozycjeRozklad
			ELSE
				SET @ZapasPozycjeRozklad = 0

			SET @ZapasPrzedParam = @ZapasPozycjeRozklad
			SET @DoZamowieniaProdukty = @IloscMPSRozklad - @IloscRezerwacjiRozklad - @IloscDoWykorzystania - @IloscNaZP
			SET @PozostalaIloscOgolnieDostepna = CASE WHEN @IloscOgolnieDostepnaDoObliczeniaZamowienia - @IloscDoWykorzystania &lt; 0 THEN 0 
													ELSE @IloscOgolnieDostepnaDoObliczeniaZamowienia - @IloscDoWykorzystania END
			IF @DoZamowieniaProdukty &gt; 0
			BEGIN
				SET @DoZamowieniaPrzedParam = @DoZamowieniaProdukty
				IF @DoZamowieniaProdukty - @ZapasPozycjeRozklad &gt; 0
				BEGIN
					SET @DoZamowieniaProdukty -= @ZapasPozycjeRozklad
					SET @ZapasPozycjeRozklad = 0
				END
				ELSE
				BEGIN
					SET @ZapasPozycjeRozklad -= @DoZamowieniaProdukty
					SET @DoZamowieniaProdukty = 0
				END
			END
			ELSE
			BEGIN
				SET @DoZamowieniaProdukty = 0
				SET @DoZamowieniaPrzedParam = 0
			END

			IF @DoZamowieniaProdukty &gt; 0 AND @DoProdukcjiPodst &amp; 2 &gt; 0
				SET @DoZamowieniaProdukty = @DoZamowieniaProdukty + @ZapasBezpieczenstwaPozycjeRozklad
			ELSE IF @DoZamowieniaProdukty = 0 AND @DoProdukcjiPodst &amp; 2 &gt; 0 AND @ZapasPozycjeRozklad &lt; @ZapasBezpieczenstwaPozycjeRozklad
				SET @DoZamowieniaProdukty = @ZapasBezpieczenstwaPozycjeRozklad - @PozostalaIloscOgolnieDostepna - @ZapasPozycjeRozklad

			SET @IloscDoProdukcjiPozycjeRozklad = CASE WHEN @DoZamowieniaProdukty &lt; 0 THEN 0 ELSE @DoZamowieniaProdukty END

			IF @IloscDoProdukcjiPozycjeRozklad &gt; 0
			BEGIN
				IF @DoProdukcjiPodst &amp; 1 &gt; 0 AND @IloscMinProdukcjiPozycjeRozklad &gt; 0 AND @IloscMinProdukcjiPozycjeRozklad &gt; @IloscDoProdukcjiPozycjeRozklad
					SET @IloscDoProdukcjiPozycjeRozklad = /*CEILING(@IloscDoProdukcjiPozycjeRozklad / */@IloscMinProdukcjiPozycjeRozklad/*) * @IloscMinProdukcjiPozycjeRozklad*/

				IF @DoProdukcjiPodst &amp; 4 &gt; 0 AND @IloscDoProdukcjiPozycjeRozklad &lt; @EOQPozycjeRozklad-- EQQ
					SET @IloscDoProdukcjiPozycjeRozklad=@EOQPozycjeRozklad

				IF @DoProdukcjiPodst &amp; 8 &gt; 0 AND @WielokrotnoscPozycjeRozklad &gt; 0
					SET @IloscDoProdukcjiPozycjeRozklad=CEILING(@IloscDoProdukcjiPozycjeRozklad / @WielokrotnoscPozycjeRozklad) * @WielokrotnoscPozycjeRozklad

				IF @DoProdukcjiPodst &amp; 16 &gt; 0 AND @ZaokragleniePozycjeRozklad &gt; 0
					 SET @IloscDoProdukcjiPozycjeRozklad = ROUND(@IloscDoProdukcjiPozycjeRozklad, -LOG10(@ZaokragleniePozycjeRozklad))
			END

			SET @ZapasPozycjeRozklad = @ZapasPrzedParam + @IloscDoProdukcjiPozycjeRozklad - @DoZamowieniaPrzedParam

			UPDATE #tmpProdZapas SET Zapas = @ZapasPozycjeRozklad
								WHERE TwrNr = @TwrNumerPozycjeRozklad AND MagNr = 1 AND Technologia = @TechnologiaIdPozycjeRozklad
			UPDATE cdn.ProdPlanyProdukty SET PPP_IloscDoProdukcji = @IloscDoProdukcjiPozycjeRozklad WHERE PPP_Id = @PPPIdPozycjeRozklad AND PPP_DokZrdTyp &lt;&gt; 14343
		END
		FETCH NEXT FROM PozycjeRozkladKursor
		INTO @PPPIdPozycjeRozklad, @TwrNumerPozycjeRozklad, @TerminPozycjeRozklad, @IloscMPSRozklad, @IloscDoWykorzystania, @IloscRezerwacjiRozklad, @IloscOgolnieDostepnaRozklad, @IloscDoProdukcjiPozycjeRozklad, @IloscMinProdukcjiPozycjeRozklad,
								@TechnologiaIdPozycjeRozklad, @EdytowanyPozycjeRozklad, @ZapasBezpieczenstwaPozycjeRozklad, @EOQPozycjeRozklad, @WielokrotnoscPozycjeRozklad,
								@ZaokragleniePozycjeRozklad, @IloscWygenerowanoPozycjeRozklad, @IloscBrakNaMPSPozycjeRozklad,@PPPDokZrdTypRozklad, @IloscNaZP, @ZapotrzebowanieDoAktMaterialu, 
								@ZapotrzebowanieDoAktDnia, @IloscZrealizowanaDoAktDnia
    END

    CLOSE PozycjeRozkladKursor
    DEALLOCATE PozycjeRozkladKursor
    GOTO PoOptymalizacjaIlosciDoProdukcjiDlaProduktow


WyliczeniePierwszegoPoziomuZapotrzebowanMaterialowych:
    BEGIN
		CREATE TABLE #ZaleznosciZP
		(
			PPPId INT,
			TwrNumer INT,
			ZPId INT,
			Technologia INT,
			IloscDoWyprodukowania DECIMAL(15, 4)
		)

		INSERT INTO #ZaleznosciZP
		SELECT PPP_Id, PPP_TwrNumer, ISNULL(PZEPLZ.PZE_Zlecenie, ISNULL(PZEZam.PZE_Zlecenie, ISNULL(PZEProd.PZE_Zlecenie, 0))) ZPId, 
			ISNULL(PZEPLZ.PZE_Technologia, ISNULL(PZEZam.PZE_Technologia, ISNULL(PZEProd.PZE_Technologia, 0))) Technologia, 
			CASE
				WHEN PPP_Edytowany &amp; @EdycjaIlosc &gt; 0
					THEN ISNULL(PZEPLZ.PZE_Ilosc, ISNULL(PZEZam.PZE_Ilosc, PPP_IloscMPS - PPP_IloscRez - PPP_IloscDoWykorzystania))
				ELSE ISNULL(PZEPLZ.PZE_Ilosc, ISNULL(PZEZam.PZE_Ilosc, ISNULL(PPP_IloscNaZp, 0)))
			END IloscDoWyprodukowania
		FROM CDN.ProdPlanyProdukty
			LEFT JOIN CDN.ProdPlanyZrdDok ON PPZ_PPPId = PPP_Id  -- rozszerza ilość do wyprodukowania dla przeliczeń innych niż wg. dok.
			LEFT JOIN CDN.ZamZamLinki ON ZZL_ZSGidNumer = PPZ_DokNumer
				AND ZZL_ZSGidTyp = PPZ_DokTyp
				AND ZZL_ZSGidLp = PPZ_DokLp
				AND ZZL_ZZGidTyp = 14343
			LEFT JOIN CDN.DokZwiazane ON DOZ_ZRDNumer = PPZ_DokLp
				AND DOZ_ZRDTyp = PPz_DokTyp
				AND DOZ_DOKNumer = 14343
			LEFT JOIN CDN.ProdZlecElem PZEPLZ ON PZEPLZ.PZE_Id = DOZ_DOKNumer
			LEFT JOIN CDN.ProdZlecElem PZEZam ON PZEZam.PZE_Id = ZZL_ZZGidNumer
			LEFT JOIN CDN.ProdZlecElem PZEProd ON PZEProd.PZE_Zlecenie = PPZ_DokNumer
				AND PZEProd.PZE_Id = PPZ_DokLp
				AND PZEProd.PZE_TwrNumer = PPP_TwrNumer
				AND PPZ_DokTyp = 14343
		WHERE PPP_PPLId = @PlanProdId AND (PZEPLZ.PZE_Id IS NOT NULL OR PZEZam.PZE_Id IS NOT NULL OR PZEProd.PZE_Zlecenie IS NOT NULL)

        IF @PrzeliczenieRodzaj &gt;= @PrzeliczenieWgOkresu
		BEGIN
			
			INSERT INTO #tabProdPlanyProduktyMaterialyBazowe
			SELECT PPP_Id,TwrNumer,ZPId,Termin,TerminProd,Technologia,SUM(IloscDoWyprodukowania),DokZrdNumer,DokZrdTyp,TechnologiaId
			FROM (
				SELECT PPP_Id,TwrNumer,ZPId,Termin,TerminProd,Technologia,IloscDoWyprodukowania,DokZrdNumer,DokZrdTyp,TechnologiaId 
				FROM (
					SELECT PPP_Id, PPP_TwrNumer TwrNumer, 0 ZPId, PPP_Termin Termin, PPP_Termin TerminProd,
						zp.Technologia, zp.IloscDoWyprodukowania, PPP_DokZrdNumer DokZrdNumer, PPP_DokZrdTyp DokZrdTyp, PPP_TechnologiaId TechnologiaId--, 
						--ROW_NUMBER() OVER (PARTITION BY PPP_Termin
						--	ORDER BY PPP_Termin, ISNULL(PZEPLZ.PZE_Zlecenie, ISNULL(PZEZam.PZE_Zlecenie, ISNULL(PZEProd.PZE_Zlecenie, 0)))) rwn
					FROM CDN.ProdPlanyProdukty
						LEFT JOIN #ZaleznosciZP zp ON zp.PPPId = PPP_Id AND zp.TwrNumer = PPP_TwrNumer
					WHERE PPP_PPLId = @PlanProdId AND zp.ZPId IS NOT NULL
				) AS a
				GROUP BY PPP_Id,TwrNumer,Termin,TerminProd,Technologia,DokZrdNumer,DokZrdTyp,TechnologiaId, IloscDoWyprodukowania, ZPId
				UNION ALL
				--ilosci dla towarow ktore pozostaly w kolumnie do produkcji
				SELECT PPP_Id, PPP_TwrNumer TwrNumer, 0 ZPId, PPP_Termin Termin, PPP_Termin TerminProd, PPP_TechnologiaId Technologia, CASE
						WHEN PPP_Edytowany &amp; @EdycjaIlosc &gt; 0
							THEN PPP_IloscDoProdukcji - PPP_IloscNaZp
						ELSE PPP_IloscDoProdukcji
					END IloscDoWyprodukowania, PPP_DokZrdNumer DokZrdNumer, PPP_DokZrdTyp DokZrdTyp, PPP_TechnologiaId TechnologiaId
				FROM CDN.ProdPlanyProdukty PPG
					INNER JOIN CDN.TwrKarty ON Twr_GIDNumer = PPP_TwrNumer
				WHERE PPP_PPLId = @PlanProdId
			) PPPom
			WHERE Technologia &gt; 0
				AND IloscDoWyprodukowania &gt; 0
			GROUP BY PPP_Id,TwrNumer,Termin,TerminProd,Technologia,DokZrdNumer,DokZrdTyp,TechnologiaId, ZPId

		END
		ELSE
		BEGIN

			INSERT INTO #tabProdPlanyProduktyMaterialyBazowe
			SELECT PPP_Id,TwrNumer,0,Termin,TerminProd,Technologia,SUM(IloscDoWyprodukowania),DokZrdNumer,DokZrdTyp,TechnologiaId
			FROM (
				SELECT PPP_Id,TwrNumer,0 ZPId,Termin,TerminProd,Technologia,SUM(IloscDoWyprodukowania)/*/count(*)*/ IloscDoWyprodukowania,DokZrdNumer,DokZrdTyp,TechnologiaId 
				FROM (
					SELECT PPP_Id, PPP_TwrNumer TwrNumer, 0 ZPId, PPP_Termin Termin, PPP_Termin TerminProd,
						zp.Technologia, zp.IloscDoWyprodukowania, PPP_DokZrdNumer DokZrdNumer, PPP_DokZrdTyp DokZrdTyp, PPP_TechnologiaId TechnologiaId
					FROM CDN.ProdPlanyProdukty
						LEFT JOIN #ZaleznosciZP zp ON zp.PPPId = PPP_Id AND zp.TwrNumer = PPP_TwrNumer
					WHERE PPP_PPLId = @PlanProdId AND zp.ZPId IS NOT NULL
				) AS a
				GROUP BY PPP_Id,TwrNumer,Termin,TerminProd,Technologia,DokZrdNumer,DokZrdTyp,TechnologiaId, ZPId
				UNION ALL
				--ilosci dla towarow ktore pozostaly w kolumnie do produkcji
				SELECT PPP_Id, PPP_TwrNumer TwrNumer, 0 ZPId, PPP_Termin Termin, PPP_Termin TerminProd, PPP_TechnologiaId Technologia, CASE
						WHEN PPP_Edytowany &amp; @EdycjaIlosc &gt; 0
							THEN PPP_IloscDoProdukcji - PPP_IloscNaZp
						ELSE PPP_IloscDoProdukcji
					END IloscDoWyprodukowania, PPP_DokZrdNumer DokZrdNumer, PPP_DokZrdTyp DokZrdTyp, PPP_TechnologiaId TechnologiaId
				FROM CDN.ProdPlanyProdukty PPG
					INNER JOIN CDN.TwrKarty ON Twr_GIDNumer = PPP_TwrNumer
				WHERE PPP_PPLId = @PlanProdId
			) PPPom
			WHERE Technologia &gt; 0
				AND IloscDoWyprodukowania &gt; 0
			GROUP BY PPP_Id,TwrNumer,Termin,TerminProd,Technologia,DokZrdNumer,DokZrdTyp,TechnologiaId

		END

        IF @PrzeliczenieRodzaj = @PrzeliczenieWgOkresu
        BEGIN --wg okresu, termin na ktory jest wyliczany material jest brany z poczatku okresu planistycznego
			INSERT INTO #tabProdPlanyMaterialyPelne (PPT_PPPId, PPT_Termin, PPT_TwrNumer, PPT_IloscPotrzeba, PPT_IloscOgolnieDostepna, PPT_IloscWDrodze, PPT_IloscWszystkiePotrzeby, PPT_IloscZrealizowana, PPT_CzynnoscId, PPT_MagNumer, PPT_DoZamowienia, PPT_ZapasBezpieczenstwa, PPT_EOQ, PPT_Wielokrotnosc, PPT_Zaokraglenie, PPT_CzasDostawy, PPT_OkresMRPOd, PPT_OkresMRPDo, PPT_RodzicId, PPT_ZamiennikTowaru, PTZ_Id, Poziom, IdZamiennikaSurowca, PoziomSurowca, IdSurowca)
            SELECT PPP_Id, Termin - @RezDataAkt Termin, MatNumer, ROUND(SUM(CASE
							WHEN IloscFormatPTZ = 5 AND IlPlan = 0 THEN PotrzebaSurowacaWyprodukuj
							WHEN IloscFormatPTZ = 5 AND IlPlan &lt;&gt; 0 THEN
								CASE WHEN OstatniPolproduktZeStalaIloscBezPlanowaniaIlosc &lt;&gt; 0 THEN PotrzebaSurowacaWyprodukuj * CEILING(MnoznikDoStalejIlosci)
									WHEN IlPlanowanaPierwszegoPoziomuZapotrzebowaniaZeStalaIlosc &lt;&gt; 0 THEN PotrzebaSurowacaWyprodukuj * CEILING(MnoznikDoStalejIlosci*IloscDoWyprodukowania/TechnologiaWyprodukuje)
									ELSE PotrzebaSurowacaWyprodukuj * CEILING(MnoznikDoStalejIlosci*IloscDoWyprodukowania/TechnologiaWyprodukuje)
								END
							ELSE 
								CASE WHEN OstatniPolproduktZeStalaIloscBezPlanowaniaIlosc &lt;&gt; 0 THEN PotrzebaSurowacaWyprodukuj * MnoznikDoStalejIlosci
									WHEN IlPlanowanaPierwszegoPoziomuZapotrzebowaniaZeStalaIlosc &lt;&gt; 0 THEN PotrzebaSurowacaWyprodukuj * CEILING(MnoznikDoStalejIlosci*IloscDoWyprodukowania/TechnologiaWyprodukuje)
									ELSE PotrzebaSurowacaWyprodukuj * IloscDoWyprodukowania / TechnologiaWyprodukuje 
								END 
                        END), 4) IloscPotrzebaSurowca,--sprawdzanie czy na PTZ nie jest zaznaczona stala ilosc
                CASE
					WHEN 0 &lt; 
					(
						ISNULL(
								CASE @ZrodloMagDlaKolOgolnieDostepna 
								WHEN @MagDlaKolOgolnieDostepna 
									THEN (
										SELECT SUM(CASE
												WHEN Rez_GIDTyp = 2576
													THEN - Ilosc 
												ELSE Ilosc
											END)
										FROM (
											SELECT DISTINCT Rez_GIDNumer, Rez_GIDTyp, Rez_Ilosc - Rez_Zrealizowano - Rez_IloscImp - Rez_IloscMag - Rez_IloscSAD - Rez_IloscSSC Ilosc
											FROM CDN.Rezerwacje
												INNER JOIN #tabMagaynyPP ON PPId = @PlanProdId AND MagDlaElem = @ZrodloMagDlaKolOgolnieDostepna
												INNER JOIN CDN.RezMagazyny ON ReM_RezNumer = Rez_GIDNumer
													AND ReM_RezTyp = Rez_GIDTyp
											WHERE (Rez_DataRealizacji &lt;= (Termin - @RezDataAkt) OR Rez_DataRealizacji = 93890)
												AND (
													(Rez_GIDTyp = 2576 AND Rez_ZrdTyp IN (1605, -1605) AND Rez_Typ = 1) OR (Rez_GIDTyp = 2576 AND Rez_ZrdTyp NOT IN (1605, -1605))
														OR Rez_DataRealizacji &gt; @PrzeliczenieData
												)
												AND (
													Rez_ZrdTyp NOT IN (14345, 14346)
														OR Rez_GIDTyp = 2592
												)
												AND Rez_TwrNumer = MatNumer
												AND MagNumer = ReM_MagNumer
										) OgolnieDostepna
									)
								ELSE (
									SELECT SUM(CASE
											WHEN Rez_GIDTyp = 2576
												THEN - Ilosc
											ELSE Ilosc
										END)
									FROM (
										SELECT DISTINCT Rez_GIDNumer, Rez_GIDTyp, Rez_Ilosc - Rez_Zrealizowano - Rez_IloscImp - Rez_IloscMag - Rez_IloscSAD - Rez_IloscSSC Ilosc
										FROM CDN.Rezerwacje
											INNER JOIN CDN.RezMagazyny ON ReM_RezNumer = Rez_GIDNumer
												AND ReM_RezTyp = Rez_GIDTyp
										WHERE (Rez_DataRealizacji &lt;= (Termin - @RezDataAkt) OR Rez_DataRealizacji = 93890)
											AND (
												(Rez_GIDTyp = 2576 AND Rez_ZrdTyp IN (1605, -1605) AND Rez_Typ = 1) OR (Rez_GIDTyp = 2576 AND Rez_ZrdTyp NOT IN (1605, -1605))
													OR Rez_DataRealizacji &gt; @PrzeliczenieData
											)
											AND (
												Rez_ZrdTyp NOT IN (14345, 14346)
													OR Rez_GIDTyp = 2592
											)
											AND Rez_TwrNumer = MatNumer
											AND (ReM_MagNumer = MagNumerCzynnosc
													OR MagNumerCzynnosc = 0
											)
									) OgolnieDostepna
								)
						END, 0) + CASE
							WHEN Twr_Typ IN (4, 6)
								THEN 0
                            ELSE 
								CASE @ZrodloMagDlaKolOgolnieDostepna WHEN @MagDlaKolOgolnieDostepna THEN (
										SELECT SUM(DISTINCT ISNULL(wewStanyTowarow.IloscSpr, 0))
										FROM (
											SELECT ProdTech.Termin, DS.TwrNumer MatNumer, ProdTech.TwrNumer, ProdTech.DokZrdNumer, ProdTech.TerminProd, ProdTech.DokZrdTyp, 
												ProdTech.TechnologiaId
											FROM #CTE_DrzewoSurowcow DS
												INNER JOIN (
													SELECT Termin, Technologia, TwrNumer, DokZrdNumer, TerminProd, DokZrdTyp, TechnologiaId, (
															SELECT TOP 1 PTZ_TechnologiaCzynnosc
															FROM CDN.ProdTechnologiaCzynnosci
																INNER JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
																	AND PTZ_TwrNumer = ProdTech.TwrNumer
																	AND PTZ_TypZasobu = 0
															WHERE PTC_Technologia = ProdTech.Technologia
														) Czynnosc
													FROM #tabProdPlanyProduktyMaterialyBazowe ProdTech
												) ProdTech ON ProdTech.Technologia = DS.TechOrg
													AND ProdTech.Czynnosc = DS.PTC_IDOrg
												INNER JOIN CDN.TwrKarty ON Twr_GIDNumer = DS.TwrNumer
											WHERE PTC_Technologia IS NULL
										) wewMatProdukcja
											INNER JOIN CDN.ProdPlanyProdukty wewPPP ON wewPPP.PPP_TwrNumer = wewMatProdukcja.TwrNumer
												AND wewPPP.PPP_Termin = wewMatProdukcja.TerminProd
												AND wewPPP.PPP_DokZrdNumer = wewMatProdukcja.DokZrdNumer
												AND wewPPP.PPP_DokZrdTyp = wewMatProdukcja.DokZrdTyp
												AND wewPPP.PPP_TechnologiaId = wewMatProdukcja.TechnologiaId
												AND wewPPP.PPP_PPLId = @PlanProdId
											INNER JOIN CDN.TwrKarty wewTwr ON wewTwr.Twr_GIDNumer = MatNumer
											INNER JOIN #tabMagaynyPP ON PPId = @PlanProdId AND MagDlaElem = @ZrodloMagDlaKolOgolnieDostepna
											OUTER APPLY CDN.ZwrocDaneZasobowDlaTowarow(wewTwr.Twr_GIDNumer, 2, 0, MagNumer, 0, @FrsId, 0, 0, 0, 0, 0, 0) wewStanyTowarow
										WHERE wewTwr.Twr_GIDNumer = Twr_GIDNumer AND wewTwr.Twr_GIDTyp = Twr_GIDTyp AND wewMatProdukcja.Termin = Termin 
																	AND wewMatProdukcja.MatNumer = MatProdukcja.MatNumer AND wewPPP.PPP_Id = zewPPP.PPP_Id
									)
									ELSE
										ISNULL(stanyTowarow.IloscSpr, 0)
								END
						END
					)
						THEN (
							ISNULL(CASE @ZrodloMagDlaKolOgolnieDostepna 
								WHEN @MagDlaKolOgolnieDostepna 
									THEN (
										SELECT SUM(CASE
												WHEN Rez_GIDTyp = 2576
													THEN - Ilosc
												ELSE Ilosc
											END)
										FROM (
											SELECT DISTINCT Rez_GIDNumer, Rez_GIDTyp, Rez_Ilosc - Rez_Zrealizowano - Rez_IloscImp - Rez_IloscMag - Rez_IloscSAD - Rez_IloscSSC Ilosc
											FROM CDN.Rezerwacje
												INNER JOIN #tabMagaynyPP ON PPId = @PlanProdId AND MagDlaElem = @ZrodloMagDlaKolOgolnieDostepna
												INNER JOIN CDN.RezMagazyny ON ReM_RezNumer = Rez_GIDNumer
													AND ReM_RezTyp = Rez_GIDTyp
											WHERE (Rez_DataRealizacji &lt;= (Termin - @RezDataAkt) OR Rez_DataRealizacji = 93890)
												AND (
													(Rez_GIDTyp = 2576 AND Rez_ZrdTyp IN (1605, -1605) AND Rez_Typ = 1) OR (Rez_GIDTyp = 2576 AND Rez_ZrdTyp NOT IN (1605, -1605))
														OR Rez_DataRealizacji &gt; @PrzeliczenieData
												)
												AND (
													Rez_ZrdTyp NOT IN (14345, 14346)
														OR Rez_GIDTyp = 2592
												)
												AND Rez_TwrNumer = MatNumer
												AND MagNumer = ReM_MagNumer
										) OgolnieDostepna
									)
								ELSE (
									SELECT SUM(CASE
											WHEN Rez_GIDTyp = 2576
												THEN - Ilosc
											ELSE Ilosc
										END)
									FROM (
										SELECT DISTINCT Rez_GIDNumer, Rez_GIDTyp, Rez_Ilosc - Rez_Zrealizowano - Rez_IloscImp - Rez_IloscMag - Rez_IloscSAD - Rez_IloscSSC Ilosc
										FROM CDN.Rezerwacje
											INNER JOIN CDN.RezMagazyny ON ReM_RezNumer = Rez_GIDNumer
												AND ReM_RezTyp = Rez_GIDTyp
										WHERE (Rez_DataRealizacji &lt;= (Termin - @RezDataAkt) OR Rez_DataRealizacji = 93890)
											AND (
												(Rez_GIDTyp = 2576 AND Rez_ZrdTyp IN (1605, -1605) AND Rez_Typ = 1) OR (Rez_GIDTyp = 2576 AND Rez_ZrdTyp NOT IN (1605, -1605))
													OR Rez_DataRealizacji &gt; @PrzeliczenieData
											)
											AND (
												Rez_ZrdTyp NOT IN (14345, 14346)
													OR Rez_GIDTyp = 2592
											)
											AND Rez_TwrNumer = MatNumer
											AND (ReM_MagNumer = MagNumerCzynnosc
													OR MagNumerCzynnosc = 0
											)
									) OgolnieDostepna
								)
						END, 0) + CASE
								WHEN Twr_Typ IN (4, 6)
									THEN 0
                                ELSE 
									CASE @ZrodloMagDlaKolOgolnieDostepna WHEN @MagDlaKolOgolnieDostepna THEN (
											SELECT SUM(DISTINCT ISNULL(wewStanyTowarow.IloscSpr, 0)) 
											FROM (
												SELECT ProdTech.Termin, DS.TwrNumer MatNumer, ProdTech.TwrNumer, ProdTech.DokZrdNumer, ProdTech.TerminProd, ProdTech.DokZrdTyp,
													ProdTech.TechnologiaId
												FROM #CTE_DrzewoSurowcow DS
													INNER JOIN (
														SELECT Termin, Technologia, TwrNumer, DokZrdNumer, TerminProd, DokZrdTyp, TechnologiaId, (
																SELECT TOP 1 PTZ_TechnologiaCzynnosc
																FROM CDN.ProdTechnologiaCzynnosci
																	INNER JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
																	AND PTZ_TwrNumer = ProdTech.TwrNumer
																	AND PTZ_TypZasobu = 0
																WHERE PTC_Technologia = ProdTech.Technologia
															) Czynnosc
														FROM #tabProdPlanyProduktyMaterialyBazowe ProdTech
													) ProdTech ON ProdTech.Technologia = DS.TechOrg
														AND ProdTech.Czynnosc = DS.PTC_IDOrg
													INNER JOIN CDN.TwrKarty ON Twr_GIDNumer = DS.TwrNumer
												WHERE PTC_Technologia IS NULL
											) wewMatProdukcja
												INNER JOIN CDN.ProdPlanyProdukty wewPPP ON wewPPP.PPP_TwrNumer = wewMatProdukcja.TwrNumer
													AND wewPPP.PPP_Termin = wewMatProdukcja.TerminProd
													AND wewPPP.PPP_DokZrdNumer = wewMatProdukcja.DokZrdNumer
													AND wewPPP.PPP_DokZrdTyp = wewMatProdukcja.DokZrdTyp
													AND wewPPP.PPP_TechnologiaId = wewMatProdukcja.TechnologiaId
													AND wewPPP.PPP_PPLId = @PlanProdId
												INNER JOIN CDN.TwrKarty wewTwr ON wewTwr.Twr_GIDNumer = MatNumer
												INNER JOIN #tabMagaynyPP ON PPId = @PlanProdId AND MagDlaElem = @ZrodloMagDlaKolOgolnieDostepna
												OUTER APPLY CDN.ZwrocDaneZasobowDlaTowarow(wewTwr.Twr_GIDNumer, 2, 0, MagNumer, 0, @FrsId, 0, 0, 0, 0, 0, 0) wewStanyTowarow
											WHERE wewTwr.Twr_GIDNumer = Twr_GIDNumer AND wewTwr.Twr_GIDTyp = Twr_GIDTyp AND wewMatProdukcja.Termin = Termin 
												AND wewMatProdukcja.MatNumer = MatProdukcja.MatNumer AND wewPPP.PPP_Id = zewPPP.PPP_Id
										)
										ELSE
											ISNULL(stanyTowarow.IloscSpr, 0)
									END
							END
						)
					ELSE 0
				END IloscOgolnieDostepna, 
				CASE @ZrodloMagDlaKolWDrodze WHEN @MagDlaKolWDrodze THEN (
							SELECT ISNULL(SUM(Ilosc), 0)
							FROM (
								SELECT DISTINCT Rez_GIDNumer, Rez_Ilosc - Rez_Zrealizowano - Rez_IloscImp - Rez_IloscMag - Rez_IloscSAD - Rez_IloscSSC Ilosc
								FROM CDN.Rezerwacje
									INNER JOIN #tabMagaynyPP ON PPId = @PlanProdId AND MagDlaElem = @ZrodloMagDlaKolWDrodze
									INNER JOIN CDN.RezMagazyny ON ReM_RezNumer = Rez_GIDNumer
										AND ReM_RezTyp = Rez_GIDTyp
								WHERE (
										Rez_DataRealizacji &gt; (Termin - @RezDataAkt)
											OR Rez_DataRealizacji &lt;= @PrzeliczenieData
									)
									AND Rez_GIDTyp = 2592
									AND Rez_TwrNumer = MatNumer
									AND MagNumer = ReM_MagNumer
							) WDrodze
						)
					ELSE
					(
						SELECT ISNULL(SUM(Ilosc), 0)
						FROM (
							SELECT DISTINCT Rez_GIDNumer, Rez_Ilosc - Rez_Zrealizowano - Rez_IloscImp - Rez_IloscMag - Rez_IloscSAD - Rez_IloscSSC Ilosc
							FROM CDN.Rezerwacje
								INNER JOIN CDN.RezMagazyny ON ReM_RezNumer = Rez_GIDNumer
									AND ReM_RezTyp = Rez_GIDTyp
							WHERE (
									Rez_DataRealizacji &gt; (Termin - @RezDataAkt)
										OR Rez_DataRealizacji &lt;= @PrzeliczenieData
								)
								AND Rez_GIDTyp = 2592
								AND Rez_TwrNumer = MatNumer
								AND (ReM_MagNumer = MagNumerCzynnosc
									OR MagNumerCzynnosc = 0
								)
						) WDrodze
					)
				END IloscWDrodze, 
				0 IloscWszystkiePotrzeby, SUM(Zrealizowano) IloscZrealizowana, CzynnoscId, MagNumerCzynnosc, 0 PPT_DoZamowienia,
                COALESCE((SELECT Tpm_IloscMin FROM cdn.TwrParMag WHERE Twr_GIDNumer=Tpm_TwrNumer AND Tpm_MagNumer=MagNumerCzynnosc ),Twr_IloscMin)
                ZapasBezpieczenstwa, Twr_MrpEoq PPT_EOQ,
				COALESCE((SELECT Tpm_IloscZam FROM cdn.TwrParMag WHERE Twr_GIDNumer=Tpm_TwrNumer AND Tpm_MagNumer=MagNumerCzynnosc ),Twr_IloscZam)
                Wielokrotnosc,
                CASE
					WHEN Twr_MrpZaok =0 THEN 0
                    WHEN Twr_MrpZaok %1000000=0 THEN 1000000
                    WHEN Twr_MrpZaok %100000=0 THEN 100000
                    WHEN Twr_MrpZaok %10000=0 THEN 10000
                    WHEN Twr_MrpZaok %1000=0 THEN 1000
                    WHEN Twr_MrpZaok %100=0 THEN 100
                    WHEN Twr_MrpZaok %10=0 THEN 10
                    WHEN Twr_MrpZaok %1=0 THEN 1
                    WHEN Twr_MrpZaok %0.1=0 THEN 0.1
                    WHEN Twr_MrpZaok %0.01=0 THEN 0.01
                    WHEN Twr_MrpZaok %0.001=0 THEN 0.001
                    WHEN Twr_MrpZaok %0.0001=0 THEN 0.0001
				END  PPT_Zaokraglenie, CzasDostawy PPT_CzasDostawy,
				CASE POK_CzasTrwaniaOkresuJedn
					WHEN 0 THEN /*dni*/ POK_DataOd+(cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int)-POK_DataOd)/POK_CzasTrwaniaOkresu*POK_CzasTrwaniaOkresu
                    WHEN 1 THEN /*tygodnie*/ POK_DataOd+(cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int)-POK_DataOd)/POK_CzasTrwaniaOkresu/7*7*POK_CzasTrwaniaOkresu
                    WHEN 2 THEN /*miesiace*/
					(
						DATEDIFF(d,convert(datetime,'1800-12-29',120),
							DATEADD(m, DATEDIFF(m, 0, dateadd(m,
                            ( (
									datepart(YEAR,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))*12
                                    +datepart(MONTH,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))
                                    -datepart(YEAR,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))*12
                                    -datepart(MONTH,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))
								) / POK_CzasTrwaniaOkresu
                                + CASE
									WHEN datepart(DAY,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int), convert(datetime,'1800-12-29',120))) - 
										datepart(DAY,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120))) &lt; 0
                                        AND (
											datepart(YEAR,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))*12
                                            +datepart(MONTH,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))
                                            -datepart(YEAR,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))*12
                                            -datepart(MONTH,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))
                                        ) % POK_CzasTrwaniaOkresu = 0 /*miesiac zmiany */ THEN -1
                                    ELSE 0
                                END
                            ) * POK_CzasTrwaniaOkresu, dateadd(d, POK_DataOd, convert(datetime,'1800-12-29',120))) ), 0)  ))+1
					WHEN 3 THEN /*lata - nieuzywane dla mrp*/ 0
                END OkresMRPOd,
                CASE POK_CzasTrwaniaOkresuJedn
					WHEN 0 THEN /*dni*/ POK_DataOd+((cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int)-POK_DataOd)/POK_CzasTrwaniaOkresu+1)*POK_CzasTrwaniaOkresu-1
                    WHEN 1 THEN /*tygodnie*/ POK_DataOd+((cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int)-POK_DataOd)/POK_CzasTrwaniaOkresu/7+1)*7*POK_CzasTrwaniaOkresu-1
                    WHEN 2 THEN /*miesiace*/ 
					(
						DATEDIFF(d,convert(datetime,'1800-12-29',120),
							DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0, dateadd(m,
                            ( (
									datepart(YEAR,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))*12
                                    +datepart(MONTH,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))
                                    -datepart(YEAR,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))*12
                                    -datepart(MONTH,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))
								) / POK_CzasTrwaniaOkresu
                                + CASE
									WHEN datepart(DAY,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120))) - 
										datepart(DAY,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120))) &lt; 0
                                        AND (
											datepart(YEAR,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))*12
                                            +datepart(MONTH,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))
                                            -datepart(YEAR,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))*12
                                            -datepart(MONTH,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))
                                        )%POK_CzasTrwaniaOkresu=0 /*miesiac zmiany */  THEN 0
                                    ELSE 1
                                END
                            ) * POK_CzasTrwaniaOkresu,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120))) ),0))  ))+1
                            WHEN 3 THEN /*lata - nieuzywane dla mrp*/ 0
                END  OkresMRPDo, 0 PPT_RodzicId, Zamiennik PPT_ZamiennikTowaru, IdZasobuTechnologii, 0 Poziom, IdZamiennikaSurowca, Poziom, IdSurowca
            FROM (
				SELECT DS.Zamiennik, ProdTech.TwrNumer, ProdTech.Termin, ProdTech.IloscDoWyprodukowania, ProdTech.IloscDoWyprodukowaniaSum, DS.TwrNumer MatNumer, 
					Ds.PTZ_Ilosc PotrzebaSurowacaWyprodukuj, Ds.PTZ_IloscFormat IloscFormatPTZ, TechnologiaId, DS.PTZ_Id IdZasobuTechnologii, DS.IdZamiennikaSurowca, DS.Poziom, DS.Id IdSurowca, 
					DS.PTC_IloscPlan IlPlan, DS.OstatniPolproduktZeStalaIloscBezPlanowaniaIlosc, DS.IlPlanowanaPierwszegoPoziomuZapotrzebowaniaZeStalaIlosc, DS.MnoznikDoStalejIlosci, (
						SELECT Sum(CASE 
										WHEN CDN.CzyKlasaAtrOkresowa(ProdZasoby.PTZ_IloscAtr) = 1 THEN ProdZasoby.PTZ_Ilosc
										ELSE CDN.ProdIloscAtr(1,ProdZasoby.PTZ_Ilosc,ProdZasoby.PTZ_IloscAtr,4,ProdZasoby.PTZ_TypZasobu,Cz.PTC_Ilosc,Cz.PTC_IloscAtr,14340,Cz.PTC_Technologia,0,0)
							END)
                        FROM CDN.ProdTechnologiaZasoby ProdZasoby
							JOIN CDN.ProdTechnologiaCzynnosci Cz ON Cz.PTC_Id = PTZ_TechnologiaCzynnosc
                        WHERE ProdZasoby.PTZ_TechnologiaCzynnosc = ProdTech.Czynnosc
							AND ProdZasoby.PTZ_TwrNumer = ProdTech.TwrNumer
							AND ProdZasoby.PTZ_TypZasobu = 0
                   ) --wyliczyc ile uda sie wyprodukowac produktu w danej czynnosci
                   TechnologiaWyprodukuje, (
						SELECT sum(cast((PTC_CzasPrzygotowawczy + CDN.Prod_WartoscAtr(PTC_CzasPlanowany, PTC_CzasPlanowanyAtr, 14340, PTC_Technologia, 0, 0) * 1  
							/* *IloscOperacjiDoWykonania *(IloscDoWyprodukowania / () */ + PTC_OdstepPo + PTC_OdstepPrzed) AS DECIMAL(12, 0)) / 24 / 3600)
						FROM CDN.ProdTechnologiaCzynnosci
						WHERE PTC_Id IN (
							SELECT PTC_IDOrg
							FROM #CTE_DrzewoSurowcow DSCzas
							WHERE DSCzas.CzynnoscTech = Ds.CzynnoscTech--zawsze zjoinuje jedną czynność
								AND DSCzas.PTC_Technologia IS NULL       --nie tworzy półproduktu nieposiadającego karty magazynowej
						)
                    ) CzasProdukcji, Ds.CzynnoscTech, (
						SELECT ISNULL(SUM(TrS_Ilosc), 0) Zrealizowano
                        FROM CDN.TraSElem
							INNER JOIN (
								SELECT TrS_GIDNumer Numer, TrS_GIDLp Lp, TrS_SubGIDLp SubLp
                                FROM CDN.ProdCzynnosci --dla elemntow zaplanowanych a nie zrealizowanych
									INNER JOIN CDN.TraSElem ON TrS_ZlcNumer = PCZ_Id
										AND TrS_ZlcTyp = 14345
                                    INNER JOIN CDN.TraElem ON TrE_GIDNumer = TrS_GIDNumer
										AND TrE_GIDLp = TrS_GIDLp
                                     INNER JOIN CDN.ProdProcesy ON PPC_Id = PCZ_Proces
									 JOIN #ZaleznosciZP zp ON zp.ZPId = PPC_Zlecenie AND zp.PPPId = ProdTech.PPPId
                                WHERE PCZ_TechnologiaCzynnosc = Ds.CzynnoscTech
									AND PPC_Technologia = DS.Technologia
                                    AND TrE_TwrNumer = DS.TwrNumer
                                    --AND PPC_Zlecenie IN (SELECT PPZ_DokNumer FROM CDN.ProdPlanyZrdDok WHERE PPZ_PPPId = ProdTech.PPPId AND PPZ_DokTyp = 14343)
                                    AND TrS_GIDTyp = 1616

								UNION ALL

								SELECT TrS_GIDNumer Numer, TrS_GIDLp Lp, TrS_SubGIDLp SubLp
                                FROM CDN.ProdZasoby -- dla elementow zrealizowanych
									INNER JOIN CDN.TraSElem ON TrS_ZlcNumer = PZA_Id
										AND TrS_ZlcTyp = 14346
                                    INNER JOIN CDN.ProdCzynnosci ON PCZ_Id = PZA_Czynnosc
                                    INNER JOIN CDN.ProdProcesy ON PPC_Id = PCZ_Proces
									JOIN #ZaleznosciZP zp ON zp.ZPId = PPC_Zlecenie AND zp.PPPId = ProdTech.PPPId
                                WHERE PZA_TwrNumer = DS.TwrNumer
									AND PZA_TypZasobu = 1
                                    AND PCZ_TechnologiaCzynnosc = Ds.CzynnoscTech
                                    AND PPC_Technologia = DS.Technologia
                                    --AND PPC_Zlecenie IN (SELECT PPZ_DokNumer FROM CDN.ProdPlanyZrdDok WHERE PPZ_PPPId = ProdTech.PPPId AND PPZ_DokTyp = 14343)
                                    AND TrS_GIDTyp = 1616
                            ) Rw ON Rw.Numer = TrS_ZwrNumer
								AND RW.Lp = TrS_ZwrLp
                                AND RW.SubLp = TrS_SubGIDLp
                    ) Zrealizowano, 
					0 CzynnoscId, DS.PTZ_MagNumer MagNumerCzynnosc, ISNULL(TWD_Czas, Twr_CzasDst) CzasDostawy
				FROM #CTE_DrzewoSurowcow DS
					INNER JOIN (
						SELECT TwrNumer, Termin, Technologia, IloscDoWyprodukowania, TechnologiaId, PPPId, (
								SELECT SUM(PPPM.IloscDoWyprodukowania)
                                FROM #tabProdPlanyProduktyMaterialyBazowe PPPM
                                WHERE PPPM.PPPId = ProdTech.PPPId
							) IloscDoWyprodukowaniaSum, (
								SELECT TOP 1 PTZ_TechnologiaCzynnosc
                                FROM CDN.ProdTechnologiaCzynnosci
									INNER JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
										AND PTZ_TwrNumer = ProdTech.TwrNumer
                                        AND PTZ_TypZasobu = 0
                                WHERE PTC_Technologia = ProdTech.Technologia
								ORDER BY PTZ_PodstawowaTechnologiaDlaProduktu DESC
							) Czynnosc --wybieram dowolna czynnosc z technoligii gdzie produktem jest skaldnik MPS
                        FROM #tabProdPlanyProduktyMaterialyBazowe ProdTech
					) ProdTech ON ProdTech.Technologia = DS.TechOrg
						AND ProdTech.Czynnosc = DS.PTC_IDOrg
					INNER JOIN CDN.TwrKarty ON Twr_GIDNumer = DS.TwrNumer
					INNER JOIN CDN.ProdTechnologiaCzynnosci ptc ON ptc.PTC_Id = DS.CzynnoscTech
					LEFT JOIN CDN.TwrDost on  Twr_GIDNumer=TWD_TwrNumer AND Twr_DstDomyslny =TWD_TwrLp
                        --      inner join CDN.ProdTechnologiaZasoby ProdZasoby on ProdZasoby.PTZ_TechnologiaCzynnosc = ProdTech.Czynnosc and ProdZasoby.PTZ_TwrNumer = ProdTech.TwrNumer and ProdZasoby.PTZ_TypZasobu = 0
                WHERE DS.PTC_Technologia IS NULL
            ) MatProdukcja
                INNER JOIN CDN.TwrKarty ON Twr_GIDNumer = MatNumer
				OUTER APPLY CDN.ZwrocDaneZasobowDlaTowarow(Twr_GIDNumer, 2, 0, MagNumerCzynnosc, 0, @FrsId, 0, 0, 0, 0, 0, 0) stanyTowarow
                INNER JOIN CDN.ProdPlanyProdukty zewPPP ON PPP_TwrNumer = MatProdukcja.TwrNumer
					AND PPP_Termin &lt;= Termin
                    AND PPP_TerminDo &gt;= Termin
                    AND PPP_TechnologiaId = TechnologiaId
                    AND PPP_PPLId = @PlanProdId
				LEFT JOIN CDN.ProdOkresy ON  POK_Id=Twr_MrpId AND POK_Przestoj = 0
			WHERE Twr_Typ NOT IN (3,4) AND MatProdukcja.TechnologiaWyprodukuje &gt; 0
            GROUP BY -- grupowanie w celu wyliczenia materialow na dany termin i dla danego towaru
				PPP_Id, Termin, MatNumer, Twr_GIDTyp, Twr_GIDFirma, Twr_GIDNumer, Twr_Typ, CzynnoscId, MagNumerCzynnosc,CzasDostawy, Zamiennik,Twr_MrpEoq,Twr_MrpZaok, Twr_IloscZam,Twr_IloscMin,POK_CzasTrwaniaOkresuJedn, POK_DataOd, POK_CzasTrwaniaOkresu,CzasProdukcji, IdZasobuTechnologii, IdZamiennikaSurowca, Poziom, IdSurowca, IloscSpr;;
        END
        ELSE
        BEGIN --wg dokumetu,, termin na ktory jest wyliczany material jest brany z rezerewacji

			INSERT INTO #tabProdPlanyMaterialyPelne (PPT_PPPId, PPT_Termin, PPT_TwrNumer, PPT_IloscPotrzeba, PPT_IloscOgolnieDostepna, PPT_IloscWDrodze, PPT_IloscWszystkiePotrzeby, PPT_IloscZrealizowana, PPT_CzynnoscId, PPT_MagNumer, PPT_DoZamowienia, PPT_ZapasBezpieczenstwa, PPT_EOQ, PPT_Wielokrotnosc, PPT_Zaokraglenie, PPT_CzasDostawy, PPT_OkresMRPOd, PPT_OkresMRPDo, PPT_RodzicId, PPT_ZamiennikTowaru, CzasProdukcji, PTZ_Id, Poziom, IdZamiennikaSurowca, PoziomSurowca, IdSurowca)
            SELECT PPP_Id, Termin - FLOOR(CzasProdukcji) - @RezDataAkt Termin, MatNumer, ROUND(SUM(CASE
							WHEN IloscFormatPTZ = 5 AND IlPlan = 0 THEN PotrzebaSurowacaWyprodukuj
							WHEN IloscFormatPTZ = 5 AND IlPlan &lt;&gt; 0 THEN
								CASE WHEN OstatniPolproduktZeStalaIloscBezPlanowaniaIlosc &lt;&gt; 0 THEN PotrzebaSurowacaWyprodukuj * CEILING(MnoznikDoStalejIlosci)
									WHEN IlPlanowanaPierwszegoPoziomuZapotrzebowaniaZeStalaIlosc &lt;&gt; 0 THEN PotrzebaSurowacaWyprodukuj * CEILING(MnoznikDoStalejIlosci*CEILING(IloscDoWyprodukowania/TechnologiaWyprodukuje))
									ELSE PotrzebaSurowacaWyprodukuj * CEILING(MnoznikDoStalejIlosci*IloscDoWyprodukowania/TechnologiaWyprodukuje)
								END
							ELSE 
								CASE WHEN OstatniPolproduktZeStalaIloscBezPlanowaniaIlosc &lt;&gt; 0 THEN PotrzebaSurowacaWyprodukuj * MnoznikDoStalejIlosci
									WHEN IlPlanowanaPierwszegoPoziomuZapotrzebowaniaZeStalaIlosc &lt;&gt; 0 THEN PotrzebaSurowacaWyprodukuj * CEILING(MnoznikDoStalejIlosci*CEILING(IloscDoWyprodukowania/TechnologiaWyprodukuje))
									ELSE PotrzebaSurowacaWyprodukuj * IloscDoWyprodukowania / TechnologiaWyprodukuje 
								END 
                        END), 4) IloscPotrzebaSurowca,--sprawdzanie czy na PTZ nie jest zaznaczona stala ilosc
				CASE
					WHEN 0 &lt; (
						ISNULL(
							CASE @ZrodloMagDlaKolOgolnieDostepna 
								WHEN @MagDlaKolOgolnieDostepna 
									THEN (
										SELECT SUM(CASE
												WHEN Rez_GIDTyp = 2576
													THEN - Ilosc
												ELSE Ilosc
											END)
										FROM (
											SELECT DISTINCT Rez_GIDNumer, Rez_GIDTyp, Rez_Ilosc - Rez_Zrealizowano - Rez_IloscImp - Rez_IloscMag - Rez_IloscSAD - Rez_IloscSSC Ilosc
											FROM CDN.Rezerwacje
												INNER JOIN #tabMagaynyPP ON PPId = @PlanProdId AND MagDlaElem = @ZrodloMagDlaKolOgolnieDostepna
												INNER JOIN CDN.RezMagazyny ON ReM_RezNumer = Rez_GIDNumer
													AND ReM_RezTyp = Rez_GIDTyp
											WHERE (Rez_DataRealizacji &lt;= (Termin - FLOOR(CzasProdukcji) - @RezDataAkt) OR Rez_DataRealizacji = 93890)
												AND (
													(Rez_GIDTyp = 2576 AND Rez_ZrdTyp IN (1605, -1605) AND Rez_Typ = 1) OR (Rez_GIDTyp = 2576 AND Rez_ZrdTyp NOT IN (1605, -1605))
														OR Rez_DataRealizacji &gt; @PrzeliczenieData
												)
												AND (
													Rez_ZrdTyp NOT IN (14345, 14346)
														OR Rez_GIDTyp = 2592
												)
												AND Rez_TwrNumer = MatNumer
												AND MagNumer = ReM_MagNumer
										) OgolnieDostepna
									)
								ELSE (
									SELECT SUM(CASE
											WHEN Rez_GIDTyp = 2576
												THEN - Ilosc
											ELSE Ilosc
										END)
									FROM (
										SELECT DISTINCT Rez_GIDNumer, Rez_GIDTyp, Rez_Ilosc - Rez_Zrealizowano - Rez_IloscImp - Rez_IloscMag - Rez_IloscSAD - Rez_IloscSSC Ilosc
										FROM CDN.Rezerwacje
											INNER JOIN CDN.RezMagazyny ON ReM_RezNumer = Rez_GIDNumer
												AND ReM_RezTyp = Rez_GIDTyp
										WHERE (Rez_DataRealizacji &lt;= (Termin - FLOOR(CzasProdukcji) - @RezDataAkt) OR Rez_DataRealizacji = 93890)
											AND (
												(Rez_GIDTyp = 2576 AND Rez_ZrdTyp IN (1605, -1605) AND Rez_Typ = 1) OR (Rez_GIDTyp = 2576 AND Rez_ZrdTyp NOT IN (1605, -1605))
													OR Rez_DataRealizacji &gt; @PrzeliczenieData
											)
											AND (
												Rez_ZrdTyp NOT IN (14345, 14346)
													OR Rez_GIDTyp = 2592
											)
											AND Rez_TwrNumer = MatNumer
											AND (ReM_MagNumer = MagNumerCzynnosc
													OR MagNumerCzynnosc = 0
											)
									) OgolnieDostepna
								)
						END, 0) + CASE
							WHEN Twr_Typ IN (4, 6)
								THEN 0
							ELSE 
								CASE @ZrodloMagDlaKolOgolnieDostepna WHEN @MagDlaKolOgolnieDostepna THEN(
											SELECT SUM(DISTINCT ISNULL(wewStanyTowarow.IloscSpr, 0)) 
											FROM (SELECT ProdTech.Termin, DS.TwrNumer MatNumer, ProdTech.TwrNumer, ProdTech.DokZrdNumer, ProdTech.TerminProd, ProdTech.DokZrdTyp,
													ProdTech.TechnologiaId
												FROM #CTE_DrzewoSurowcow DS
														INNER JOIN (
															SELECT Termin, Technologia, TwrNumer, DokZrdNumer, TerminProd, DokZrdTyp, TechnologiaId, (
																	SELECT TOP 1 PTZ_TechnologiaCzynnosc
																	FROM CDN.ProdTechnologiaCzynnosci
																		INNER JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
																			AND PTZ_TwrNumer = ProdTech.TwrNumer
																			AND PTZ_TypZasobu = 0
																	WHERE PTC_Technologia = ProdTech.Technologia
																) Czynnosc
															FROM #tabProdPlanyProduktyMaterialyBazowe ProdTech
														) ProdTech ON ProdTech.Technologia = DS.TechOrg
															AND ProdTech.Czynnosc = DS.PTC_IDOrg
														INNER JOIN CDN.TwrKarty ON Twr_GIDNumer = DS.TwrNumer
												WHERE PTC_Technologia IS NULL
											) wewMatProdukcja
												INNER JOIN CDN.ProdPlanyProdukty wewPPP ON wewPPP.PPP_TwrNumer = wewMatProdukcja.TwrNumer
													AND wewPPP.PPP_Termin = wewMatProdukcja.TerminProd
													AND wewPPP.PPP_DokZrdNumer = wewMatProdukcja.DokZrdNumer
													AND wewPPP.PPP_DokZrdTyp = wewMatProdukcja.DokZrdTyp
													AND wewPPP.PPP_TechnologiaId = wewMatProdukcja.TechnologiaId
													AND wewPPP.PPP_PPLId = @PlanProdId
												INNER JOIN CDN.TwrKarty wewTwr ON wewTwr.Twr_GIDNumer = MatNumer
												INNER JOIN #tabMagaynyPP ON PPId = @PlanProdId AND MagDlaElem = @ZrodloMagDlaKolOgolnieDostepna
												OUTER APPLY CDN.ZwrocDaneZasobowDlaTowarow(wewTwr.Twr_GIDNumer, 2, 0, MagNumer, 0, @FrsId, 0, 0, 0, 0, 0, 0) wewStanyTowarow
											WHERE wewTwr.Twr_GIDNumer = Twr_GIDNumer AND wewTwr.Twr_GIDTyp = Twr_GIDTyp AND wewMatProdukcja.Termin = Termin 
												AND wewMatProdukcja.MatNumer = MatProdukcja.MatNumer AND wewPPP.PPP_Id = zewPPP.PPP_Id
										)
									ELSE
										ISNULL(stanyTowarow.IloscSpr, 0)
								END
						END
                    )
						THEN (
							ISNULL(CASE @ZrodloMagDlaKolOgolnieDostepna WHEN @MagDlaKolOgolnieDostepna THEN (
											SELECT SUM(CASE
														WHEN Rez_GIDTyp = 2576
															THEN - Ilosc
														ELSE Ilosc
													END)
											FROM (
												SELECT DISTINCT Rez_GIDNumer, Rez_GIDTyp, Rez_Ilosc - Rez_Zrealizowano - Rez_IloscImp - Rez_IloscMag - Rez_IloscSAD - Rez_IloscSSC Ilosc
												FROM CDN.Rezerwacje
													INNER JOIN #tabMagaynyPP ON PPId = @PlanProdId AND MagDlaElem = @ZrodloMagDlaKolOgolnieDostepna
													INNER JOIN CDN.RezMagazyny ON ReM_RezNumer = Rez_GIDNumer
														AND ReM_RezTyp = Rez_GIDTyp
												WHERE (Rez_DataRealizacji &lt;= (Termin - FLOOR(CzasProdukcji) - @RezDataAkt) OR Rez_DataRealizacji = 93890)
													AND (
														(Rez_GIDTyp = 2576 AND Rez_ZrdTyp IN (1605, -1605) AND Rez_Typ = 1) OR (Rez_GIDTyp = 2576 AND Rez_ZrdTyp NOT IN (1605, -1605))
															OR Rez_DataRealizacji &gt; @PrzeliczenieData
													)
													AND (
														Rez_ZrdTyp NOT IN (14345, 14346)
															OR Rez_GIDTyp = 2592
													)
													AND Rez_TwrNumer = MatNumer
													AND MagNumer = ReM_MagNumer
											) OgolnieDostepna
										)
									ELSE (
										SELECT SUM(CASE
												WHEN Rez_GIDTyp = 2576
													THEN - Ilosc
												ELSE Ilosc
											END)
                                        FROM (
											SELECT DISTINCT Rez_GIDNumer, Rez_GIDTyp, Rez_Ilosc - Rez_Zrealizowano - Rez_IloscImp - Rez_IloscMag - Rez_IloscSAD - Rez_IloscSSC Ilosc
                                            FROM CDN.Rezerwacje
												INNER JOIN CDN.RezMagazyny ON ReM_RezNumer = Rez_GIDNumer
													AND ReM_RezTyp = Rez_GIDTyp
                                            WHERE (Rez_DataRealizacji &lt;= (Termin - FLOOR(CzasProdukcji) - @RezDataAkt) OR Rez_DataRealizacji = 93890)
												AND (
													(Rez_GIDTyp = 2576 AND Rez_ZrdTyp IN (1605, -1605) AND Rez_Typ = 1) OR (Rez_GIDTyp = 2576 AND Rez_ZrdTyp NOT IN (1605, -1605))
														OR Rez_DataRealizacji &gt; @PrzeliczenieData
                                                )
                                                AND (
                                                Rez_ZrdTyp NOT IN (14345, 14346)
													OR Rez_GIDTyp = 2592
                                                )
                                                AND Rez_TwrNumer = MatNumer
                                                AND (ReM_MagNumer = MagNumerCzynnosc
														OR MagNumerCzynnosc = 0
                                                )
                                        ) OgolnieDostepna
                                    )
							END, 0) + CASE
								WHEN Twr_Typ IN (4, 6)
									THEN 0
                                ELSE 
									CASE @ZrodloMagDlaKolOgolnieDostepna WHEN @MagDlaKolOgolnieDostepna THEN (
												SELECT SUM(DISTINCT ISNULL(wewStanyTowarow.IloscSpr, 0)) 
												FROM (
													SELECT ProdTech.Termin, DS.TwrNumer MatNumer, ProdTech.TwrNumer, ProdTech.DokZrdNumer, ProdTech.TerminProd, ProdTech.DokZrdTyp, 
														ProdTech.TechnologiaId
													FROM #CTE_DrzewoSurowcow DS
														INNER JOIN (
															SELECT Termin, Technologia, TwrNumer, DokZrdNumer, TerminProd, DokZrdTyp, TechnologiaId, (
																	SELECT TOP 1 PTZ_TechnologiaCzynnosc
																	FROM CDN.ProdTechnologiaCzynnosci
																		INNER JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
																			AND PTZ_TwrNumer = ProdTech.TwrNumer
																			AND PTZ_TypZasobu = 0
																	WHERE PTC_Technologia = ProdTech.Technologia
																) Czynnosc
															FROM #tabProdPlanyProduktyMaterialyBazowe ProdTech
														) ProdTech ON ProdTech.Technologia = DS.TechOrg
															AND ProdTech.Czynnosc = DS.PTC_IDOrg
														INNER JOIN CDN.TwrKarty ON Twr_GIDNumer = DS.TwrNumer
													WHERE PTC_Technologia IS NULL
												) wewMatProdukcja
													INNER JOIN CDN.ProdPlanyProdukty wewPPP ON wewPPP.PPP_TwrNumer = wewMatProdukcja.TwrNumer
														AND wewPPP.PPP_Termin = wewMatProdukcja.TerminProd
														AND wewPPP.PPP_DokZrdNumer = wewMatProdukcja.DokZrdNumer
														AND wewPPP.PPP_DokZrdTyp = wewMatProdukcja.DokZrdTyp
														AND wewPPP.PPP_TechnologiaId = wewMatProdukcja.TechnologiaId
														AND wewPPP.PPP_PPLId = @PlanProdId
													INNER JOIN CDN.TwrKarty wewTwr ON wewTwr.Twr_GIDNumer = MatNumer
													INNER JOIN #tabMagaynyPP ON PPId = @PlanProdId AND MagDlaElem = @ZrodloMagDlaKolOgolnieDostepna
													OUTER APPLY CDN.ZwrocDaneZasobowDlaTowarow(wewTwr.Twr_GIDNumer, 2, 0, MagNumer, 0, @FrsId, 0, 0, 0, 0, 0, 0) wewStanyTowarow
												WHERE wewTwr.Twr_GIDNumer = Twr_GIDNumer AND wewTwr.Twr_GIDTyp = Twr_GIDTyp AND wewMatProdukcja.Termin = Termin 
													AND wewMatProdukcja.MatNumer = MatProdukcja.MatNumer AND wewPPP.PPP_Id = zewPPP.PPP_Id
											)
										ELSE
											ISNULL(stanyTowarow.IloscSpr, 0)
									END
							END
						)
                    ELSE 0
                END IloscOgolnieDostepna, 
				CASE @ZrodloMagDlaKolWDrodze WHEN @MagDlaKolWDrodze THEN (
							SELECT ISNULL(SUM(Ilosc), 0)
							FROM (
								SELECT DISTINCT Rez_GIDNumer, Rez_Ilosc - Rez_Zrealizowano - Rez_IloscImp - Rez_IloscMag - Rez_IloscSAD - Rez_IloscSSC Ilosc
								FROM CDN.Rezerwacje
									INNER JOIN #tabMagaynyPP ON PPId = @PlanProdId AND MagDlaElem = @ZrodloMagDlaKolWDrodze
									INNER JOIN CDN.RezMagazyny ON ReM_RezNumer = Rez_GIDNumer
										AND ReM_RezTyp = Rez_GIDTyp
								WHERE (
										Rez_DataRealizacji &gt; (Termin - FLOOR(CzasProdukcji) - @RezDataAkt)
											OR Rez_DataRealizacji &lt;= @PrzeliczenieData
									)
									AND Rez_GIDTyp = 2592
									AND Rez_TwrNumer = MatNumer
									AND MagNumer = ReM_MagNumer
							) WDrodze
						)
					ELSE (
						SELECT ISNULL(SUM(Ilosc), 0)
						FROM (
							SELECT DISTINCT Rez_GIDNumer, Rez_Ilosc - Rez_Zrealizowano - Rez_IloscImp - Rez_IloscMag - Rez_IloscSAD - Rez_IloscSSC Ilosc
							FROM CDN.Rezerwacje
								INNER JOIN CDN.RezMagazyny ON ReM_RezNumer = Rez_GIDNumer
									AND ReM_RezTyp = Rez_GIDTyp
							WHERE (
									Rez_DataRealizacji &gt; (Termin - FLOOR(CzasProdukcji) - @RezDataAkt)
										OR Rez_DataRealizacji &lt;= @PrzeliczenieData
								)
								AND Rez_GIDTyp = 2592
								AND Rez_TwrNumer = MatNumer
								AND (ReM_MagNumer = MagNumerCzynnosc
									OR MagNumerCzynnosc = 0
								)
						) WDrodze
					)
				END IloscWDrodze, 
				0 IloscWszystkiePotrzeby, SUM(Zrealizowano) IloscZrealizowana, CzynnoscId, MagNumerCzynnosc, 0 PPT_DoZamowienia,
                COALESCE((SELECT Tpm_IloscMin FROM cdn.TwrParMag WHERE Twr_GIDNumer=Tpm_TwrNumer AND Tpm_MagNumer=MagNumerCzynnosc ),Twr_IloscMin) ZapasBezpieczenstwa,
                Twr_MrpEoq EOQ,
                COALESCE((SELECT Tpm_IloscZam FROM cdn.TwrParMag WHERE Twr_GIDNumer=Tpm_TwrNumer AND Tpm_MagNumer=MagNumerCzynnosc ),Twr_IloscZam) Wielokrotnosc,
                CASE
					WHEN Twr_MrpZaok =0 THEN 0
                    WHEN Twr_MrpZaok %1000000=0 THEN 1000000
                    WHEN Twr_MrpZaok %100000=0 THEN 100000
                    WHEN Twr_MrpZaok %10000=0 THEN 10000
                    WHEN Twr_MrpZaok %1000=0 THEN 1000
                    WHEN Twr_MrpZaok %100=0 THEN 100
                    WHEN Twr_MrpZaok %10=0 THEN 10
                    WHEN Twr_MrpZaok %1=0 THEN 1
                    WHEN Twr_MrpZaok %0.1=0 THEN 0.1
                    WHEN Twr_MrpZaok %0.01=0 THEN 0.01
                    WHEN Twr_MrpZaok %0.001=0 THEN 0.001
                    WHEN Twr_MrpZaok %0.0001=0 THEN 0.0001
                END  PPT_Zaokraglenie,
                CzasDostawy PPT_CzasDostawy,
                CASE POK_CzasTrwaniaOkresuJedn
					WHEN 0 THEN /*dni*/ POK_DataOd+(cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int)-POK_DataOd)/POK_CzasTrwaniaOkresu*POK_CzasTrwaniaOkresu
                    WHEN 1 THEN /*tygodnie*/ POK_DataOd+(cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int)-POK_DataOd)/POK_CzasTrwaniaOkresu/7*7*POK_CzasTrwaniaOkresu
                    WHEN 2 THEN /*miesiace*/ (
							DATEDIFF(d,convert(datetime,'1800-12-29',120),
								DATEADD(m, DATEDIFF(m, 0, dateadd(m,
											( (
													datepart(YEAR,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))*12
													+datepart(MONTH,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))
													-datepart(YEAR,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))*12
													-datepart(MONTH,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))
												) / POK_CzasTrwaniaOkresu
												+ CASE
													WHEN datepart(DAY,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))
														-datepart(DAY,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))&lt;0
														AND (
															datepart(YEAR,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))*12
															+datepart(MONTH,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))
															-datepart(YEAR,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))*12
															-datepart(MONTH,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))
														) % POK_CzasTrwaniaOkresu=0 /*miesiac zmiany */  THEN -1
													ELSE 0
												END
                                            )*POK_CzasTrwaniaOkresu,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120))) ), 0)  ))+1
                    WHEN 3 THEN /*lata - nieuzywane dla mrp*/ 0
                END OkresMRPOd,
                CASE POK_CzasTrwaniaOkresuJedn
					WHEN 0 THEN /*dni*/ POK_DataOd+((cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int)-POK_DataOd)/POK_CzasTrwaniaOkresu+1)*POK_CzasTrwaniaOkresu-1
                    WHEN 1 THEN /*tygodnie*/ POK_DataOd+((cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int)-POK_DataOd)/POK_CzasTrwaniaOkresu/7+1)*7*POK_CzasTrwaniaOkresu-1
                    WHEN 2 THEN /*miesiace*/ (DATEDIFF(d,convert(datetime,'1800-12-29',120),
								DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0, dateadd(m,
											( (
													datepart(YEAR,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))*12
													+datepart(MONTH,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))
                                                    -datepart(YEAR,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))*12
													-datepart(MONTH,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))
												) / POK_CzasTrwaniaOkresu
                                                + CASE
													WHEN datepart(DAY,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))
														-datepart(DAY,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))&lt;0
                                                         AND (
															 datepart(YEAR,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))*12
															 +datepart(MONTH,dateadd(d,cast(Termin- FLOOR(CzasProdukcji)-@RezDataAkt as int),convert(datetime,'1800-12-29',120)))
															 -datepart(YEAR,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))*12
															 -datepart(MONTH,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))
                                                         ) % POK_CzasTrwaniaOkresu=0 /*miesiac zmiany */  THEN 0
                                                  ELSE 1
												END
											)*POK_CzasTrwaniaOkresu,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120))) ),0))  ))+1
                     WHEN 3 THEN /*lata - nieuzywane dla mrp*/ 0
                END  OkresMRPDo, 0 PPT_RodzicId, Zamiennik PPT_ZamiennikTowaru, CzasProdukcji, IdZasobuTechnologii, 0 Poziom, IdZamiennikaSurowca, Poziom, IdSurowca
            FROM (
				SELECT DS.Zamiennik,ProdTech.TwrNumer, ProdTech.Termin, ProdTech.TerminProd, ProdTech.IloscDoWyprodukowania, ProdTech.IloscDoWyprodukowaniaSum, ProdTech.DokZrdNumer, ProdTech.DokZrdTyp, DS.TwrNumer MatNumer, Ds.PTZ_Ilosc PotrzebaSurowacaWyprodukuj, Ds.PTZ_IloscFormat IloscFormatPTZ, TechnologiaId, DS.PTZ_Id IdZasobuTechnologii, DS.IdZamiennikaSurowca, DS.Poziom, 
					DS.Id IdSurowca, DS.PTC_IloscPlan IlPlan, DS.OstatniPolproduktZeStalaIloscBezPlanowaniaIlosc, DS.IlPlanowanaPierwszegoPoziomuZapotrzebowaniaZeStalaIlosc,
					DS.MnoznikDoStalejIlosci, (
						SELECT Sum(CASE 
										WHEN CDN.CzyKlasaAtrOkresowa(ProdZasoby.PTZ_IloscAtr) = 1 THEN ProdZasoby.PTZ_Ilosc
										ELSE CDN.ProdIloscAtr(1,ProdZasoby.PTZ_Ilosc,ProdZasoby.PTZ_IloscAtr,4,ProdZasoby.PTZ_TypZasobu,Cz.PTC_Ilosc,Cz.PTC_IloscAtr,14340,Cz.PTC_Technologia,0,0) 
							END)
						FROM CDN.ProdTechnologiaZasoby ProdZasoby
							JOIN CDN.ProdTechnologiaCzynnosci Cz ON Cz.PTC_Id = PTZ_TechnologiaCzynnosc
                        WHERE ProdZasoby.PTZ_TechnologiaCzynnosc = ProdTech.Czynnosc
							AND ProdZasoby.PTZ_TwrNumer = ProdTech.TwrNumer
                            AND ProdZasoby.PTZ_TypZasobu = 0
                    ) --wyliczyc ile uda sie wyprodukowac produktu w danej czynnosci
                    TechnologiaWyprodukuje, (
						SELECT sum(cast((PTC_CzasPrzygotowawczy + CDN.Prod_WartoscAtr(PTC_CzasPlanowany, PTC_CzasPlanowanyAtr, 14340, PTC_Technologia, 0, 0) * 1  
							/* *IloscOperacjiDoWykonania *(IloscDoWyprodukowania / () */+ PTC_OdstepPo + PTC_OdstepPrzed) AS DECIMAL(12, 0)) / 24 / 3600)
                        FROM CDN.ProdTechnologiaCzynnosci
                        WHERE PTC_Id IN (
								SELECT PTC_IDOrg
								FROM #CTE_DrzewoSurowcow DSCzas
								WHERE DSCzas.CzynnoscTech = Ds.CzynnoscTech--zawsze zjoinuje jedną czynność
									AND DSCzas.PTC_Technologia IS NULL       --nie tworzy półproduktu nieposiadającego karty magazynowej
							)
                    ) CzasProdukcji, Ds.CzynnoscTech, (
						SELECT ISNULL(SUM(TrS_Ilosc), 0) Zrealizowano
                        FROM CDN.TraSElem
							INNER JOIN (
								SELECT TrS_GIDNumer Numer, TrS_GIDLp Lp, TrS_SubGIDLp SubLp
                                FROM CDN.ProdCzynnosci --dla elemntow zaplanowanych a nie zrealizowanych
									INNER JOIN CDN.TraSElem ON TrS_ZlcNumer = PCZ_Id
										AND TrS_ZlcTyp = 14345
                                    INNER JOIN CDN.TraElem ON TrE_GIDNumer = TrS_GIDNumer
										AND TrE_GIDLp = TrS_GIDLp
                                    INNER JOIN CDN.ProdProcesy ON PPC_Id = PCZ_Proces
									JOIN #ZaleznosciZP zp ON zp.ZPId = PPC_Zlecenie AND zp.PPPId = ProdTech.PPPId
                                WHERE PCZ_TechnologiaCzynnosc = Ds.CzynnoscTech
									AND PPC_Technologia = DS.Technologia
                                    AND TrE_TwrNumer = DS.TwrNumer
                                    AND TrS_GIDTyp = 1616
                                UNION ALL
                                SELECT TrS_GIDNumer Numer, TrS_GIDLp Lp, TrS_SubGIDLp SubLp
                                FROM CDN.ProdZasoby -- dla elementow zrealizowanych
									INNER JOIN CDN.TraSElem ON TrS_ZlcNumer = PZA_Id
										AND TrS_ZlcTyp = 14346
                                    INNER JOIN CDN.ProdCzynnosci ON PCZ_Id = PZA_Czynnosc
                                    INNER JOIN CDN.ProdProcesy ON PPC_Id = PCZ_Proces
									JOIN #ZaleznosciZP zp ON zp.ZPId = PPC_Zlecenie AND zp.PPPId = ProdTech.PPPId
								WHERE PZA_TwrNumer = DS.TwrNumer
									AND PZA_TypZasobu = 1
                                    AND PCZ_TechnologiaCzynnosc = Ds.CzynnoscTech
                                    AND PPC_Technologia = DS.Technologia
                                    AND TrS_GIDTyp = 1616
                            ) Rw ON Rw.Numer = TrS_ZwrNumer
								AND RW.Lp = TrS_ZwrLp
								AND RW.SubLp = TrS_SubGIDLp
					) Zrealizowano,
					0 CzynnoscId, DS.PTZ_MagNumer MagNumerCzynnosc, ISNULL(TWD_Czas, Twr_CzasDst) CzasDostawy
				FROM #CTE_DrzewoSurowcow DS
					INNER JOIN (
						SELECT TwrNumer, Termin, TerminProd, DokZrdNumer, DokZrdTyp, Technologia, IloscDoWyprodukowania, TechnologiaId, PPPId, (
								SELECT SUM(PPPM.IloscDoWyprodukowania)
                                FROM #tabProdPlanyProduktyMaterialyBazowe PPPM
                                WHERE PPPM.PPPId = ProdTech.PPPId
                            ) IloscDoWyprodukowaniaSum, (
								SELECT TOP 1 PTZ_TechnologiaCzynnosc
								FROM CDN.ProdTechnologiaCzynnosci
									INNER JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
										AND PTZ_TwrNumer = ProdTech.TwrNumer
                                        AND PTZ_TypZasobu = 0
                                WHERE PTC_Technologia = ProdTech.Technologia
								ORDER BY PTZ_PodstawowaTechnologiaDlaProduktu DESC
							) Czynnosc --wybieram dowolna czynnosc z technoligii gdzie produktem jest skaldnik MPS
                       FROM #tabProdPlanyProduktyMaterialyBazowe ProdTech
				) ProdTech ON ProdTech.Technologia = DS.TechOrg
						AND ProdTech.Czynnosc = DS.PTC_IDOrg
					INNER JOIN CDN.TwrKarty ON Twr_GIDNumer = DS.TwrNumer
					INNER JOIN CDN.ProdTechnologiaCzynnosci ptc ON ptc.PTC_Id = DS.CzynnoscTech
					LEFT JOIN CDN.TwrDost on  Twr_GIDNumer=TWD_TwrNumer AND Twr_DstDomyslny =TWD_TwrLp
				--      inner join CDN.ProdTechnologiaZasoby ProdZasoby on ProdZasoby.PTZ_TechnologiaCzynnosc = ProdTech.Czynnosc and ProdZasoby.PTZ_TwrNumer = ProdTech.TwrNumer and ProdZasoby.PTZ_TypZasobu = 0
				WHERE DS.PTC_Technologia IS NULL
			) MatProdukcja
				INNER JOIN CDN.TwrKarty ON Twr_GIDNumer = MatNumer
                OUTER APPLY CDN.ZwrocDaneZasobowDlaTowarow(Twr_GIDNumer, 2, 0, MagNumerCzynnosc, 0, @FrsId, 0, 0, 0, 0, 0, 0) stanyTowarow
                INNER JOIN CDN.ProdPlanyProdukty zewPPP ON PPP_TwrNumer = MatProdukcja.TwrNumer
					AND PPP_Termin = MatProdukcja.TerminProd
                    AND PPP_DokZrdNumer = MatProdukcja.DokZrdNumer
                    AND PPP_DokZrdTyp = MatProdukcja.DokZrdTyp
                    AND PPP_TechnologiaId = MatProdukcja.TechnologiaId
                    AND PPP_PPLId = @PlanProdId
				LEFT JOIN CDN.ProdOkresy ON  POK_Id=Twr_MrpId AND POK_Przestoj = 0
			WHERE Twr_Typ NOT IN (3,4) AND MatProdukcja.TechnologiaWyprodukuje &gt; 0
            GROUP BY -- grupowanie w celu wyliczenia materialow na dany termin i dla danego towaru
				PPP_Id, Termin - FLOOR(CzasProdukcji), MatNumer, CzasProdukcji, Twr_GIDTyp, Twr_GIDFirma, Twr_GIDNumer, Twr_Typ, CzynnoscId, MagNumerCzynnosc,CzasDostawy, Zamiennik, Twr_MrpEoq,Twr_MrpZaok, Twr_IloscZam,Twr_IloscMin,POK_CzasTrwaniaOkresuJedn, POK_DataOd, POK_CzasTrwaniaOkresu,Termin, IdZasobuTechnologii, IdZamiennikaSurowca, Poziom, IdSurowca, stanyTowarow.IloscSpr;
		END;

		UPDATE uzupelnienie 
		SET PPT_CzynnoscId=zwykle.PPT_CzynnoscId
		FROM #tabProdPlanyMaterialyPelne uzupelnienie
			JOIN #tabProdPlanyMaterialyPelne zwykle ON uzupelnienie.PPT_ZamiennikTowaru = zwykle.PPT_ZamiennikTowaru 
				AND uzupelnienie.PPT_Termin = zwykle.PPT_Termin 
				AND uzupelnienie.PPT_PPPId = zwykle.PPT_PPPId 
				AND zwykle.PPT_CzynnoscId &lt;&gt; 0
		WHERE uzupelnienie.PPT_CzynnoscId = 0; 
			
		WITH CTE(ZamiennikPPTId, MatTwr) AS (
			SELECT zamiennik.PPT_Id,bazowy.PPT_Id
			FROM #tabProdPlanyMaterialyPelne zamiennik
				JOIN cdn.ProdTechnologiaZasoby PTZ ON zamiennik.PPT_ZamiennikTowaru=PTZ.PTZ_Id
				JOIN #tabProdPlanyMaterialyPelne bazowy ON bazowy.PTZ_Id=PTZ.PTZ_Id AND zamiennik.PPT_PPPId=bazowy.PPT_PPPId
            WHERE zamiennik.PPT_ZamiennikTowaru&lt;&gt;0
        )
        UPDATE #tabProdPlanyMaterialyPelne SET PPT_RodzicId = MatTwr
        FROM CTE
		WHERE PPT_ID=ZamiennikPPTId

	END
	GOTO PoWyliczeniePierwszegoPoziomuZapotrzebowanMaterialowych


WyliczenieDalszychPoziomowZapotrzebowanMaterialowych:
BEGIN

	IF @PelneRozwiniecieMaterialowe=1
    BEGIN
		EXEC CDN.ProdPlanyWyliczDalszePoziomyZapotrzebowanMaterialowych @CzyNormatywyZMagazynu, @PrzeliczenieRodzaj, @ZrodloMagDlaKolOgolnieDostepna, @ZrodloMagDlaKolWDrodze, 
																			@PlanProdId, @RezDataAkt, @PrzeliczenieData, @FrsId	
    END

	IF EXISTS (SELECT * FROM sysobjects WHERE name = 'fnLogisticUnitQuantities' AND xtype = N'IF')
	BEGIN
		CREATE TABLE #JednostkiLogistyczneWgTowaruMat(wolne INT, zajete INT, Twr_GidNumer INT)

		IF @ZrodloMagDlaKolOgolnieDostepna = @MagDlaKolOgolnieDostepna 
		BEGIN
			IF (SELECT COUNT(PPM_PPLId) FROM CDN.ProdPlanyMag WHERE PPM_PPLId = @PlanProdId AND PPM_MagDlaElem = @MagDlaKolOgolnieDostepna) &lt;&gt; 0
			BEGIN
				INSERT INTO #JednostkiLogistyczneWgTowaruMat
				SELECT SUM(luq.FreeLogisticUnits) wolne, SUM(luq.OccupiedLogisticUnits) zajete, Twr_GidNumer
				FROM (SELECT DISTINCT PPT_TwrNumer FROM #tabProdPlanyMaterialyPelne) mp
					JOIN CDN.TwrKarty t ON t.Twr_GIDNumer = mp.PPT_TwrNumer AND t.Twr_GIDTyp = 16
					CROSS APPLY WMS.fnLogisticUnitQuantities(Twr_GIDNumer) luq
					JOIN CDN.ProdPlanyMag m ON m.PPM_PPLId = @PlanProdId AND luq.WarehouseId = m.PPM_MagNumer
				WHERE t.Twr_JLogWMS = 1 AND m.PPM_MagDlaElem = @MagDlaKolOgolnieDostepna
				GROUP BY Twr_GIDNumer

			END
			ELSE
			BEGIN
				INSERT INTO #JednostkiLogistyczneWgTowaruMat
				SELECT SUM(luq.FreeLogisticUnits) wolne, SUM(luq.OccupiedLogisticUnits) zajete, Twr_GidNumer
				FROM (SELECT DISTINCT PPT_TwrNumer FROM #tabProdPlanyMaterialyPelne) mp
					JOIN CDN.TwrKarty t ON t.Twr_GIDNumer = mp.PPT_TwrNumer AND t.Twr_GIDTyp = 16
					CROSS APPLY WMS.fnLogisticUnitQuantities(Twr_GIDNumer) luq
				WHERE t.Twr_JLogWMS = 1
				GROUP BY Twr_GIDNumer

			END
		END
		ELSE
		BEGIN
			INSERT INTO #JednostkiLogistyczneWgTowaruMat
			SELECT SUM(luq.FreeLogisticUnits) wolne, SUM(luq.OccupiedLogisticUnits) zajete, Twr_GidNumer
			FROM (SELECT DISTINCT PPT_TwrNumer, PTZ_Id FROM #tabProdPlanyMaterialyPelne) mp
				JOIN CDN.TwrKarty t ON t.Twr_GIDNumer = mp.PPT_TwrNumer AND t.Twr_GIDTyp = 16
				CROSS APPLY WMS.fnLogisticUnitQuantities(Twr_GIDNumer) luq
				JOIN CDN.ProdTechnologiaZasoby ptz ON mp.PTZ_Id = ptz.PTZ_Id
			WHERE t.Twr_JLogWMS = 1 AND luq.WarehouseId = CASE WHEN ptz.PTZ_MagNumer = 0 THEN luq.WarehouseId ELSE ptz.PTZ_MagNumer END
			GROUP BY Twr_GIDNumer

		END

		UPDATE mp
		SET IloscLogistycznaWolna = wolne, 
		    IloscLogistycznaZajeta = zajete
		FROM #tabProdPlanyMaterialyPelne mp
			JOIN #JednostkiLogistyczneWgTowaruMat ON mp.PPT_TwrNumer = Twr_GIDNumer
	
		IF @UwzgJedLogWMaterialach = 1
		BEGIN
			UPDATE mp
			SET PPT_IloscOgolnieDostepna = CASE WHEN PPT_IloscOgolnieDostepna - IloscLogistycznaZajeta &lt; 0 THEN 0 ELSE PPT_IloscOgolnieDostepna - IloscLogistycznaZajeta END
			FROM #tabProdPlanyMaterialyPelne mp
			WHERE IloscLogistycznaZajeta IS NOT NULL
		END
	
		DROP TABLE #JednostkiLogistyczneWgTowaruMat
	END
END
GOTO PoWyliczenieDalszychPoziomowZapotrzebowanMaterialowych


OptymalizacjaIlosciDoZamowieniaMaterialow:
	EXEC CDN.ProdPlanyOptymalizacjaIlosciDoZamowieniaMaterialow @DoZamowieniaPodst, @Dok_PPLOptymalizacjaDoZamowienia, @RezDataAkt, @PlanProdId, @ZrodloMagDlaKolOgolnieDostepna,
		@PrzeliczenieData, @FrsId
GOTO PoOptymalizacjaIlosciDoZamowieniaMaterialow


UstawSumePotrzebIBraki:
    BEGIN
		UPDATE CDN.ProdPlanyMaterialy
        SET PPT_IloscWszystkiePotrzeby = (
				SELECT SUM(PPMP.PPT_IloscPotrzeba)
                FROM CDN.ProdPlanyMaterialy PPMP
					INNER JOIN CDN.ProdPlanyProdukty ON PPP_Id = PPT_PPPId
						AND PPP_PPLId = @PlanProdId
                 WHERE PPMP.PPT_TwrNumer = PPM.PPT_TwrNumer
					AND PPMP.PPT_Termin &lt;= PPM.PPT_Termin
                    AND PPMP.PPT_MagNumer = PPM.PPT_MagNumer
			)
        FROM CDN.ProdPlanyMaterialy PPM
			INNER JOIN CDN.ProdPlanyProdukty ON PPP_Id = PPT_PPPId
				AND PPP_PPLId = @PlanProdId

		IF @PelneRozwiniecieMaterialowe = 1
		BEGIN
			SELECT rodzic.PPT_Id
			INTO #MaterialyDoAnalizy
			FROM #tabProdPlanyMaterialyPelne rodzic
				JOIN #tabProdPlanyMaterialyPelne dziecko ON rodzic.PPT_Id = dziecko.PPT_RodzicId AND dziecko.PPT_ZamiennikTowaru = 0
			WHERE rodzic.PPT_RodzicId = 0 AND rodzic.PPT_DoZamowienia &lt;&gt; 0

			UPDATE tppmp
			SET Poziom = 9999
			FROM #tabProdPlanyMaterialyPelne tppmp
				JOIN #MaterialyDoAnalizy mda ON mda.PPT_Id = tppmp.PPT_Id
		END

		IF EXISTS(SELECT TOP 1 1 FROM #tabProdPlanyMaterialyPelne
			WHERE PPT_RodzicId &lt;&gt; 0 AND PPT_ZamiennikTowaru &lt;&gt; 0)
		BEGIN
			SELECT PPT_Id, PPT_RodzicId, 0 Poziom
			INTO #WyznaczaniePoziomu
			FROM #tabProdPlanyMaterialyPelne
			--WHERE (PPT_ZamiennikTowaru &lt;&gt; 0 OR (PPT_RodzicId = 0 AND PPT_ZamiennikTowaru = 0) OR )

		    DECLARE @Poziom INT = 0

			WHILE @Poziom &lt; 100
			BEGIN
				SET @Poziom += 1

				UPDATE wp
				SET Poziom = @Poziom
				FROM #WyznaczaniePoziomu wp
					JOIN #WyznaczaniePoziomu rp ON rp.PPT_Id = wp.PPT_RodzicId
				WHERE wp.PPT_RodzicId &lt;&gt; 0 AND rp.Poziom = @Poziom - 1

				IF @@ROWCOUNT = 0
					BREAK

			END 

			DECLARE @MaxPoziom INT
			SELECT TOP 1 @MaxPoziom = MAX(Poziom) FROM #WyznaczaniePoziomu

			SELECT PPT_Id, PPT_DoZamowienia, PPP_Id, PPT_RodzicId, CASE WHEN PPT_DoZamowienia = 0 AND PPT_RodzicId &lt;&gt; 0 THEN 1 ELSE 0 END CzyJestZamiennik, 
				0 IstniejaInneBrakiGlownych, Poziom, CASE WHEN PPT_ZamiennikTowaru &lt;&gt; 0 THEN 0 ELSE 1 END CzyBracPodUwage, 0 CzyMaZamiennik
			INTO #BrakiMaterialowe
			FROM #tabProdPlanyMaterialyPelne
				JOIN CDN.ProdPlanyProdukty ON PPT_PPPId = PPP_Id
			WHERE PPP_PPLId = @PlanProdId --AND PPT_RodzicId &lt;&gt; 0 AND PPT_ZamiennikTowaru &lt;&gt; 0 --AND PPT_DoZamowienia = 0
			
			SET @Poziom = @MaxPoziom
			
			WHILE @Poziom &gt; 0
			BEGIN

				UPDATE ppm
				SET CzyJestZamiennik = CASE WHEN ppm.PPT_DoZamowienia = 0 AND ppm.PPT_RodzicId = 0 THEN 0
					WHEN ppm.CzyJestZamiennik = 1 THEN ppm.CzyJestZamiennik ELSE bm.CzyJestZamiennik END,
					CzyMaZamiennik = CASE WHEN ppm.PPT_DoZamowienia = 0 AND ppm.PPT_RodzicId = 0 THEN 0 ELSE 1 END
				FROM #BrakiMaterialowe ppm
					JOIN (SELECT bmwew.PPT_RodzicId, MIN(bmwew.CzyJestZamiennik) CzyJestZamiennik FROM #BrakiMaterialowe bmwew
						JOIN #WyznaczaniePoziomu wpwew ON bmwew.PPT_Id = wpwew.PPT_Id 
						WHERE wpwew.Poziom = @Poziom 
						GROUP BY bmwew.PPT_RodzicId, wpwew.Poziom) bm ON ppm.PPT_Id = bm.PPT_RodzicId
					--JOIN #WyznaczaniePoziomu wp ON bm.PPT_Id = wp.PPT_Id
				WHERE bm.PPT_RodzicId &lt;&gt; 0 --AND wp.Poziom = @Poziom


				IF @@ROWCOUNT = 0
					BREAK

				SET @Poziom -= 1

			END

			UPDATE bm
			SET IstniejaInneBrakiGlownych = 1
			FROM #BrakiMaterialowe bm
			WHERE EXISTS(SELECT wewbm.PPT_Id 
				FROM #BrakiMaterialowe wewbm 
				WHERE bm.PPT_Id &lt;&gt; wewbm.PPT_Id 
					AND wewbm.CzyJestZamiennik = 0 
					AND wewbm.PPT_DoZamowienia &lt;&gt; 0 
					AND wewbm.CzyBracPodUwage = 1 
					AND wewbm.Poziom &lt;&gt; 9999 
					AND wewbm.PPP_Id = bm.PPP_Id
				)

			UPDATE CDN.ProdPlanyProdukty
			SET PPP_BrakMaterialow = Sour.braki
			FROM (
				SELECT CASE
						WHEN (max(t.braki) is null)
							THEN 11
						WHEN (min(CzyMaZamiennik) = 0 AND MAX(t.braki) = 0)
							THEN 7
						WHEN ((SUM(CzyMaZamiennik) &lt;&gt; SUM(CzyJestZamiennik) OR SUM(CzyMaZamiennik) = 0) AND MAX(t.braki) &gt; 0)
							THEN 3
						WHEN (SUM(CzyMaZamiennik) = SUM(CzyJestZamiennik) AND MAX(bm.IstniejaInneBrakiGlownych) = 0 AND MAX(t.braki) &lt;&gt; 0)
							THEN 1
						WHEN (max(t.braki) = 0 AND min(bm.CzyJestZamiennik) = 0)
							THEN 2
						ELSE 0
					END AS braki, t.PPP_Id
				FROM ( 
					SELECT PPT_DoZamowienia braki, PPP_Id, PPT_Id
					FROM #tabProdPlanyMaterialyPelne
						RIGHT JOIN CDN.ProdPlanyProdukty ON PPT_PPPId = PPP_Id
					WHERE PPP_PPLId = @PlanProdId AND (PPT_ZamiennikTowaru = 0 OR PPT_ZamiennikTowaru IS NULL) AND (Poziom &lt;&gt; 9999 OR Poziom is NULL)
				) t
					LEFT JOIN #BrakiMaterialowe bm ON bm.PPT_Id = t.PPT_Id AND bm.CzyBracPodUwage = 1
				GROUP BY t.PPP_Id--, bm.PPP_Id
			) AS Sour
			WHERE CDN.ProdPlanyProdukty.PPP_Id = Sour.PPP_Id

		END
		ELSE
		BEGIN
			UPDATE CDN.ProdPlanyProdukty
			SET PPP_BrakMaterialow = Sour.braki
			FROM (
				SELECT CASE
						WHEN (max(t.braki) is null)
							THEN 11
						WHEN (max(t.braki) &gt; 0)
							THEN 3
						ELSE 7
					END AS braki, t.PPP_Id
				FROM ( 
					SELECT PPT_DoZamowienia braki, PPP_Id
					FROM #tabProdPlanyMaterialyPelne tppmp
						RIGHT JOIN CDN.ProdPlanyProdukty ON PPT_PPPId = PPP_Id
					WHERE PPP_PPLId = @PlanProdId
				) t
				GROUP BY t.PPP_Id
			) AS Sour
			WHERE CDN.ProdPlanyProdukty.PPP_Id = Sour.PPP_Id
		END
    END

	--termin rozpoczęcia produkcji
    UPDATE cdn.ProdPlanyProdukty
	SET PPP_TerminProdukcji = CASE WHEN @PrzeliczenieRodzaj IN (@PrzeliczenieWgDok,@PrzeliczenieWgTerminu,@PrzeliczenieWgOkresuMRP)
				THEN PPP_Termin
			ELSE PPP_TerminDo
		END - FLOOR(PTZ_CzasTrwaniaProdukcji * CASE PTZ_PrzeliczajWgIlosciProduktu
			WHEN 1 
				THEN PPP_IloscDoProdukcji/CASE WHEN CDN.Prod_WartoscAtr(PTZ_Ilosc,PTZ_IloscAtr,14340,PTC_Technologia,0,0) = 0 THEN CASE WHEN PTZ_Ilosc = 0 THEN 1 ELSE PTZ_Ilosc END
					ELSE CDN.ProdIloscAtr(1,PTZ_Ilosc,PTZ_IloscAtr,PTZ_IloscFormat,PTZ_TypZasobu,PTC_Ilosc,PTC_IloscAtr,14340,PTC_Technologia,0,0) END
			ELSE 1
		END /24/60/60)
	FROM cdn.ProdPlanyProdukty 
		CROSS APPLY (SELECT TOP 1 PTZ_Ilosc, PTZ_IloscAtr, PTZ_IloscFormat ,PTZ_TypZasobu, PTZ_CzasTrwaniaProdukcji, PTZ_PrzeliczajWgIlosciProduktu, PTC_Technologia, PTC_Ilosc, PTC_IloscAtr
						FROM CDN.ProdTechnologiaZasoby
							JOIN CDN.ProdTechnologiaCzynnosci ON PTZ_TechnologiaCzynnosc = PTC_Id
						WHERE PTC_Technologia = PPP_TechnologiaId AND PTZ_TypZasobu = 0
						ORDER BY PTZ_PodstawowaTechnologiaDlaProduktu DESC
					) Zasob
	WHERE  PPP_PPLId = @PlanProdId

	UPDATE cdn.ProdPlanyProdukty
	SET PPP_TerminProdukcji = CASE WHEN @PrzeliczenieRodzaj IN (@PrzeliczenieWgDok,@PrzeliczenieWgTerminu,@PrzeliczenieWgOkresuMRP)
				THEN PPP_Termin
			ELSE PPP_TerminDo
		END - COALESCE(TWD_Czas,0)
	FROM cdn.ProdPlanyProdukty  
		LEFT JOIN CDN.TwrKarty twrProd on Twr_GIDNumer=PPP_TwrNumer
        LEFT JOIN CDN.TwrDost on  Twr_GIDNumer=TWD_TwrNumer AND Twr_DstDomyslny =TWD_TwrLp
	WHERE  PPP_PPLId = @PlanProdId  AND PPP_TerminProdukcji IS NULL
	--termin złożenia zamówienia 

	UPDATE cdn.ProdPlanyMaterialy
	SET PPT_TerminZamowienia = PPT_Termin - FLOOR( PTZ_CzasTrwaniaProdukcji * CASE PTZ_PrzeliczajWgIlosciProduktu
			WHEN 1 
				THEN PPT_IloscPotrzeba/CASE WHEN CDN.CzyKlasaAtrOkresowa(PTZ_IloscAtr) = 1 THEN CASE WHEN PTZ_Ilosc = 0 THEN 1 ELSE PTZ_Ilosc END
					ELSE CDN.ProdIloscAtr(1,PTZ_Ilosc,PTZ_IloscAtr,4,PTZ_TypZasobu,PTC_Ilosc,PTC_IloscAtr,14340,PTC_Technologia,0,0) END
			ELSE 1
		END/24/60/60 ) 
	FROM cdn.ProdPlanyMaterialy 
		JOIN cdn.ProdPlanyProdukty on PPP_Id=PPT_PPPId
		JOIN cdn.TwrKarty on PPT_TwrNumer=PPT_TwrNumer
		JOIN cdn.ProdTechnologiaCzynnosci ON PTC_Technologia=Twr_ProdTechnologia 
		JOIN cdn.ProdTechnologiaZasoby ON	 PTC_Id = PTZ_TechnologiaCzynnosc AND PTZ_TwrNumer=PPT_TwrNumer AND PTZ_TypZasobu=0 
	WHERE  PPP_PPLId = @PlanProdId

	UPDATE cdn.ProdPlanyMaterialy
	SET PPT_TerminZamowienia = PPT_Termin - COALESCE(TWD_Czas,0)
	FROM cdn.ProdPlanyMaterialy  
		JOIN cdn.ProdPlanyProdukty on PPP_Id=PPT_PPPId
		LEFT JOIN CDN.TwrKarty on Twr_GIDNumer=PPT_TWRNumer
		LEFT JOIN CDN.TwrDost on Twr_GIDNumer=TWD_TwrNumer AND Twr_DstDomyslny =TWD_TwrLp
	  WHERE PPP_PPLId = @PlanProdId  AND PPT_TerminZamowienia IS NULL

    GOTO PoUstawSumePotrzebIBraki



SychronizacjaIdMaterialowZNiepelnegoPrzeliczenia:
	BEGIN
		INSERT INTO #ProdPlanyMaterialyZPonownegoPrzeliczeniaZmianaId(IdPPTZPP,IdPPT)
		SELECT ppt.PPT_Id,-ppt.PPT_Id FROM #tabProdPlanyMaterialyPelne ppt  -- zapisywane z minusem, aby w późniejszym while'u zawsze zmieniał id'ki jeśli trafi na wiersz
			JOIN cdn.ProdPlanyProdukty ppp ON ppt.PPT_PPPId=ppp.PPP_Id
		WHERE ppp.PPP_PPLId=@PlanProdId


		UPDATE #ProdPlanyMaterialyZPonownegoPrzeliczeniaZmianaId
		SET IdPPT=ppt.PPT_Id
		FROM #tabProdPlanyMaterialyPelne PPTZPP
			JOIN cdn.ProdPlanyMaterialy ppt ON PPTZPP.PPT_TwrNumer=ppt.PPT_TwrNumer 
				AND PPTZPP.PPT_CzynnoscId=ppt.PPT_CzynnoscId 
				AND PPTZPP.PPT_Termin=ppt.PPT_Termin 
				AND ppt.PPT_PPPId=pptzpp.PPT_PPPId
			JOIN cdn.ProdPlanyProdukty ppp ON ppt.PPT_PPPId=ppp.PPP_Id
			JOIN #ProdPlanyMaterialyZPonownegoPrzeliczeniaZmianaId pptzppi ON pptzppi.IdPPTZPP=PPTZPP.PPT_Id
		WHERE ppt.[PPT_RodzicId]=0 AND PPTZPP.PPT_RodzicId=0 AND ppp.PPP_PPLId=@PlanProdId



		WHILE 1=1
		BEGIN
			UPDATE zId
			SET IdPPT = ppt.PPT_Id
			FROM #tabProdPlanyMaterialyPelne pptp --syn
				JOIN #tabProdPlanyMaterialyPelne pptpRodzic on pptp.PPT_RodzicId=pptpRodzic.PPT_Id
				JOIN #ProdPlanyMaterialyZPonownegoPrzeliczeniaZmianaId zIdRodz on pptpRodzic.PPT_Id=zIdRodz.IdPPTZPP and zIdRodz.IdPPT&gt;0 --idRodzicJuzZmienione na nowe
				JOIN #ProdPlanyMaterialyZPonownegoPrzeliczeniaZmianaId zId on zId.IdPPTZPP=pptp.PPT_Id
				JOIN cdn.ProdPlanyMaterialy ppt on ppt.PPT_RodzicId=zIdRodz.IdPPT 
					AND pptp.PPT_ZamiennikTowaru=ppt.PPT_ZamiennikTowaru 
					AND pptp.PPT_TwrNumer=ppt.PPT_TwrNumer 
					AND ppt.PPT_PPPId=pptp.PPT_PPPId
					AND ppt.PPT_PTZId = pptp.PTZ_Id
           WHERE zId.IdPPT &lt;&gt; ppt.PPT_Id  AND zId.IdPPT &lt; 0

           IF @@ROWCOUNT=0 BREAK
		END

	END
    GOTO PoSychronizacjaIdMaterialowZNiepelnegoPrzeliczenia


AktualizacjaDanychNaMaterialachPrzyNiepelnymPrzeliczeniu:
    BEGIN
		UPDATE cdn.ProdPlanyMaterialy
		SET PPT_IloscPotrzeba=tpptzpp.PPT_IloscPotrzeba,
			PPT_IloscOgolnieDostepna=tpptzpp.PPT_IloscOgolnieDostepna,
			PPT_IloscWDrodze=tpptzpp.PPT_IloscWDrodze,
			PPT_IloscWszystkiePotrzeby=tpptzpp.PPT_IloscWszystkiePotrzeby,
			PPT_IloscZrealizowana=tpptzpp.PPT_IloscZrealizowana,
			PPT_EOQ=tpptzpp.PPT_EOQ,
			PPT_Wielokrotnosc=tpptzpp.PPT_Wielokrotnosc,
			PPT_ZapasBezpieczenstwa=tpptzpp.PPT_ZapasBezpieczenstwa,
			PPT_Zaokraglenie=tpptzpp.PPT_Zaokraglenie,
			PPT_CzasDostawy=tpptzpp.PPT_CzasDostawy,
			PPT_DoZamowienia= CASE tpptzpp.PPT_DoZamowieniaZmienioneRecznie WHEN 1 THEN ppt.PPT_DoZamowienia ELSE tpptzpp.PPT_DoZamowienia END,
			PPT_DoWykorzystania = tpptzpp.PPT_DoWykorzystania,
			PPT_IloscLogWolna = COALESCE(tpptzpp.IloscLogistycznaWolna, 0),
			PPT_IloscLogZajeta = COALESCE(tpptzpp.IloscLogistycznaZajeta, 0)
		FROM cdn.ProdPlanyMaterialy ppt
			JOIN #ProdPlanyMaterialyZPonownegoPrzeliczeniaZmianaId pptzi ON ppt.PPT_Id=pptzi.IdPPT
			JOIN #tabProdPlanyMaterialyPelne tpptzpp ON tpptzpp.PPT_Id=pptzi.IdPPTZPP
    END
    GOTO PoAktualizacjaDanychNaMaterialachPrzyNiepelnymPrzeliczeniu

ZapisanieWyliczonychMaterialowDoPPT:
    BEGIN
		--Wprowadzić dane do tabeli(z tabeli tymczasowej)
        SET IDENTITY_INSERT CDN.ProdPlanyMaterialy ON;

		WITH CTEPolprodukty AS (
			SELECT PPT.PPT_Id
			FROM #tabProdPlanyMaterialyPelne PPT
			WHERE (PPT.PPT_ZamiennikTowaru = 0
				AND EXISTS (
					SELECT *
					FROM #tabProdPlanyMaterialyPelne PPTe
					WHERE PPTe.PPT_RodzicId = PPT.PPT_Id
						AND PPTe.PPT_ZamiennikTowaru = 0
				)) OR CzyBomPolprodukt = 1
			UNION ALL
			SELECT PPT.PPT_Id
			FROM #tabProdPlanyMaterialyPelne PPT
				JOIN CTEPolprodukty ctep ON PPT.PPT_ZamiennikTowaru &lt;&gt; 0
					AND PPT.PPT_RodzicId = ctep.PPT_Id)
		INSERT INTO CDN.ProdPlanyMaterialy WITH(TABLOCK) (
			[PPT_Id]
			,[PPT_PPPId]
			,[PPT_TwrNumer]
			,[PPT_Termin]
			,[PPT_IloscPotrzeba]
			,[PPT_IloscOgolnieDostepna]
			,[PPT_IloscWDrodze]
			,[PPT_IloscWszystkiePotrzeby]
			,[PPT_IloscZrealizowana]
			,[PPT_CzynnoscId]
			,[PPT_MagNumer]
			,[PPT_DoZamowienia]
			,[PPT_ZapasBezpieczenstwa]
			,[PPT_EOQ]
			,[PPT_Wielokrotnosc]
			,[PPT_Zaokraglenie]
			,[PPT_CzasDostawy]
			,[PPT_OkresMRPOd]
			,[PPT_OkresMRPDo]
			,[PPT_RodzicId]
			,[PPT_ZamiennikTowaru]
			,PPT_TerminZamowienia
			,PPT_Rodzaj
			,PPT_DoWykorzystania
			,PPT_PTZId
			,PPT_IloscLogWolna
			,PPT_IloscLogZajeta
		)
		SELECT (
			select Coalesce(max(PPT_ID),0) from CDN.ProdPlanyMaterialy )+tab.PPT_Id,
				tab.PPT_PPPId,
				tab.PPT_TwrNumer,
				CAST( tab.PPT_Termin AS INT),
				tab.PPT_IloscPotrzeba,
				tab.PPT_IloscOgolnieDostepna,
				tab.PPT_IloscWDrodze,
				0 PPT_IloscWszystkiePotrzeby, -- uzupełniane niżej
				tab.PPT_IloscZrealizowana,
				tab.PPT_CzynnoscId PPPT_CzynnoscId,
				tab.PPT_MagNumer,
				tab.PPT_DoZamowienia,
				tab.PPT_ZapasBezpieczenstwa,
				tab.PPT_EOQ,
				tab.PPT_Wielokrotnosc,
				tab.PPT_Zaokraglenie,
				tab.PPT_CzasDostawy,
				COALESCE(tab.PPT_OkresMRPOd,0),
				COALESCE(tab.PPT_OkresMRPDo,0),
				CASE WHEN tab.PPT_RodzicId is null OR tab.PPT_RodzicId=0 then 0
					else (select Coalesce(max(PPT_ID),0) from CDN.ProdPlanyMaterialy )+tab.PPT_RodzicId end,
				tab.PPT_ZamiennikTowaru,
				NULL PPT_TerminZamowienia,
				CASE WHEN CTE.PPT_Id IS NULL THEN  1 ELSE 2 END,
				tab.PPT_DoWykorzystania,
				tab.PTZ_Id,
				COALESCE(tab.IloscLogistycznaWolna, 0),
				COALESCE(tab.IloscLogistycznaZajeta, 0)
		FROM #tabProdPlanyMaterialyPelne tab
			LEFT JOIN  CTEPolprodukty CTE ON tab.PPT_Id=CTE.PPT_Id
		WHERE tab.PPT_TWRNumer&lt;&gt;0

		SET IDENTITY_INSERT CDN.ProdPlanyMaterialy OFF;
	END
    GOTO PoZapisanieWyliczonychMaterialowDoPPT




KolejnoscKrokow:
	GOTO AktuzalizacjaTerminowDokZwiazanychEdytowanychDlaProduktow   --aktualizacjaTerminów, dokumentów związanych i wartości rekordów edytowanych dla produktów

PoAktuzalizacjaTerminowDokZwiazanychEdytowanychDlaProduktow:
    GOTO OptymalizacjaIlosciDoProdukcjiDlaProduktow

PoOptymalizacjaIlosciDoProdukcjiDlaProduktow:
    GOTO WyliczeniePierwszegoPoziomuZapotrzebowanMaterialowych

PoWyliczeniePierwszegoPoziomuZapotrzebowanMaterialowych:
    GOTO WyliczenieDalszychPoziomowZapotrzebowanMaterialowych

PoWyliczenieDalszychPoziomowZapotrzebowanMaterialowych:
If @Stan=@PotwierdzonyPlanProdukcji
        GOTO SychronizacjaIdMaterialowZNiepelnegoPrzeliczenia

PoSychronizacjaIdMaterialowZNiepelnegoPrzeliczenia:
	GOTO OptymalizacjaIlosciDoZamowieniaMaterialow


PoOptymalizacjaIlosciDoZamowieniaMaterialow:
If @Stan=@PotwierdzonyPlanProdukcji --Przeliczanie potwierdzonego planu - przeliczanie niepełne
    GOTO AktualizacjaDanychNaMaterialachPrzyNiepelnymPrzeliczeniu
ELSE
    GOTO ZapisanieWyliczonychMaterialowDoPPT

PoZapisanieWyliczonychMaterialowDoPPT:
PoAktualizacjaDanychNaMaterialachPrzyNiepelnymPrzeliczeniu:
    GOTO UstawSumePotrzebIBraki --ustawia na materialach IloscWszystkiePotrzeby i BrakMaterialow

PoUstawSumePotrzebIBraki:
    RETURN
END


</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XLPrzeliczPlanProdukcji]"></A><PRE>
          <FONT SIZE="2"><I>/* [XLPrzeliczPlanProdukcji] */</I><BR>
CREATE PROCEDURE [CDN].[XLPrzeliczPlanProdukcji]
(
        /* ==========================================================================================
        SQL API: Procedura serwerowa do przeliczania planu produkcji

        Parametry wejściowe:
   ========================================================================================== */
        @PlanProdId INT, -- identyfikator planu produkcji
        @SesjaID INT, -- ID bieżącej sesji
        @OpeNumer INT, -- identyfikator operata przeliczajacego
        @OpeKod NVARCHAR(8) = NULL, -- kod operatora przeliczajacego, gdy nie znajdzie po numerze
        @DataCzasPrz INT = NULL, -- data i czas przeliczenia dokumentu, ilość sekund po 01-01-1990
        @Komunikat TINYINT = 0, -- Czy wyswietlac komunikat o bledzie
        @TwrNumer INT = 0
        /* ==========================================================================================
        Błędy:
        1 : Wystąpił błąd podczas aktualizacji planu produkcji. Nie powiódł się zapis do tabeli CDN.ProdPlany.
        2 : Wystąpił błąd podczas przeliczania planu produkcji. Podany operator nie występuje w bazie.
        7 : Wystąpił błąd podczas przeliczania planu produkcji. Nie znalezionio planu produkcji.
        8 : Wystąpił błąd podczas przeliczania planu produkcji. Podany plan produkcji nie jest aktywny w obecnej sesji.
        16: Wystąpił błąd podczas usuwania produktów planu produkcji.Nie powiodło się usuwanie wpisu z tabeli CDN.ProdPlanyProdukty.
        17: Wystąpił błąd podczas aktualizacji planu produkcji. Nie powiódł się zapis to tabeli CDN.ProdPlanyProdukty.
        18: Wystąpił błąd podczas przeliczania planu produkcji.Nie powiódł się zapis do tabeli CDN.ProdPlanyMaterialy.
        22: Wystąpił błąd podczas przeliczania planu produkcji. Tylko niepotwierdzony plan produkcji można przeliczyć.
   ========================================================================================== */
        )
AS
BEGIN
        SET NOCOUNT ON

  GOTO  KolejnoscKrokow



Deklaracje:
    BEGIN
           DECLARE @PPLAktywny INT
        DECLARE @DataCzasM INT
        DECLARE @PrzeliczenieData INT
        DECLARE @FrsId INT
        DECLARE @Typ_ProdPlany INT
        DECLARE @Typ_ZP INT
        DECLARE @PPLProduktyZdefTechnologia INT
        DECLARE @RezDataAkt INT
        DECLARE @PrzeliczenieRodzaj INT
        DECLARE @PrzeliczenieWgOkresuMRP INT
        DECLARE @PrzeliczenieWgTerminu INT
        DECLARE @PrzeliczenieWgOkresu INT
        DECLARE @PrzeliczenieWgDok INT
        DECLARE @DoProdukcjiPodst INT
        DECLARE @DoZamowieniaPodst INT
        DECLARE @SkladnikiMPS TINYINT
        DECLARE @Stan TINYINT
        DECLARE @MPSZS TINYINT
        DECLARE @MPSPLZ TINYINT
        DECLARE @MPSZP TINYINT
        DECLARE @MPSZW TINYINT
        DECLARE @KolejnePrzeliczeniePlanu TINYINT
        DECLARE @RodzajPLZ SMALLINT
        DECLARE @RodzajZak SMALLINT
        DECLARE @RodzajSpr SMALLINT
        DECLARE @RodzajZS SMALLINT
        DECLARE @RodzajZWSpr SMALLINT
        DECLARE @RodzajZWZak SMALLINT
        DECLARE @RodzajZP SMALLINT
		DECLARE @PrzeliczenieOd INT
		DECLARE @PrzeliczenieDo INT
		DECLARE @ZakresRezerwacjiOd INT
		DECLARE @ZakresRezerwacjiDo INT

        DECLARE @EdycjaIlosc INT
        DECLARE @EdycjaDodanyRecznie INT
        DECLARE @EdycjaTermin INT
        DECLARE @EdycjaTerminDo INT
        DECLARE @PelneRozwiniecieMaterialowe INT
        DECLARE @PrzeliczaniePotwierdzonegoPlanu INT
        DECLARE @PotwierdzonyPlanProdukcji INT
        DECLARE @CzyNormatywyZMagazynu TINYINT
		DECLARE @MagNaNag TINYINT
		DECLARE @MagWgPotrzeb TINYINT
		DECLARE @MagDlaKolOgolnieDostepna TINYINT
		DECLARE @MagDlaKolWDrodze TINYINT
		DECLARE @ZrodloMagDlaKolOgolnieDostepna TINYINT
		DECLARE @ZrodloMagDlaKolWDrodze TINYINT
		DECLARE @WszystkieRezerwacje TINYINT
		DECLARE @RezerwacjeZOkresuMPS TINYINT
		DECLARE @ZakresRezerwacjiDlaProduktu TINYINT
		DECLARE @UwzgJedLogWProduktach TINYINT


    --przy zmianie/dodaniu stałych dodać w XLPrzeliczPlanProdukcji2
        SET @PotwierdzonyPlanProdukcji =2
        SET @PrzeliczenieWgOkresuMRP = 4
        SET @PrzeliczenieWgTerminu = 3
        SET @PrzeliczenieWgOkresu = 2
        SET @PrzeliczenieWgDok = 1
        SET @MPSZS = 1
        SET @MPSPLZ = 2
        SET @MPSZP = 4
        SET @MPSZW = 8
        SET @RodzajZak = 0
        SET @RodzajZWZak = 1
        SET @RodzajSpr = 2
        SET @RodzajZS = 3
        SET @RodzajZP = 4
        SET @RodzajZWSpr = 5
        SET @RodzajPLZ = 6
        SET @EdycjaIlosc = 1
        SET @EdycjaDodanyRecznie = 2
        SET @EdycjaTermin = 4
        SET @EdycjaTerminDo = 8
		SET @MagNaNag = 0
		SET @MagWgPotrzeb = 0
		SET @MagDlaKolOgolnieDostepna = 1
		SET @MagDlaKolWDrodze = 2
		SET @RezerwacjeZOkresuMPS = 0
		SET @WszystkieRezerwacje = 1

            SELECT @CzyNormatywyZMagazynu= CASE WHEN count(*)=1 THEN 1 ELSE 0 END
                  FROM cdn.ProdPlanyMag WHERE PPM_PPLId = @PlanProdId AND PPM_MagDlaElem = @MagNaNag

        --tabel z produktami ktore moga byc uwzglednione jako elemen
        CREATE TABLE #tabCDNProdukty (Id INT, TechnologiaId INT);

        CREATE TABLE #tabCDNMPS (Id INT, GIDNumer INT, GIDTyp SMALLINT, GIDLp INT, RezGIDTyp SMALLINT, TwrNumer INT, DataRealizacji INT, DataWystawienia INT, Rodzaj TINYINT, PriorytetRez INT, Ilosc DECIMAL(15, 4), IloscDst DECIMAL(15, 4), MPSTyp TINYINT, TechnologiaId INT, ProduktId INT)

        CREATE TABLE #tabCDNStanSprzedaz (TwrNumer INT, DataRealizacji INT, Ilosc DECIMAL(15, 4));

        CREATE TABLE #tabMagaynyPP (PPId INT, MagNumer INT, MagDlaElem INT)

        CREATE TABLE #tabOkresyPP (OkresOd INT, OkresDo INT)

        CREATE TABLE #tabProdPlanyProdukty (PPP_IdPom INT IDENTITY(1, 1), PPP_PPLId INT NULL, PPP_TwrNumer INT, PPP_Termin INT, PPP_TerminDo INT, PPP_DokZrdNumer INT NULL, PPP_DokZrdTyp SMALLINT NULL, 
		    PPP_DokZrdLp INT NULL,PPP_IloscMPS DECIMAL(15, 4) NULL, PPP_IloscRez DECIMAL(15, 4) NULL, PPP_IloscDoWykorzystania DECIMAL(15, 4) NULL, PPP_IloscOgolnieDostepna DECIMAL(15, 4) NULL, 
			PPP_IloscWDrodze DECIMAL(15, 4) NULL, PPP_IloscNaZp DECIMAL(15, 4) NULL, PPP_IloscZaplanowana DECIMAL(15, 4) NULL, PPP_IloscWToku DECIMAL(15, 4) NULL, PPP_IloscZrealizowana DECIMAL(15, 4) NULL, 
			PPP_IloscDoProdukcji DECIMAL(15, 4), PPP_IloscMinProdukcji DECIMAL(15, 4), PPP_IloscProduktPTZ DECIMAL(15, 4), PPP_IloscBrakNaMPS DECIMAL(15, 4), PPP_TerminNaZP INT, PPP_TechnologiaId INT, 
			PriorytetRez INT, PPP_ZapasBezpieczenstwa DECIMAL(15, 4), PPP_EOQ DECIMAL(15, 4), PPP_Wielokrotnosc DECIMAL(15, 4), PPP_Zaokraglanie DECIMAL(15, 4), PPP_OkresMRPOd INT, PPP_OkresMRPDo INT, 
			IloscLogistycznaWolna DECIMAL(15,4), IloscLogistycznaZajeta DECIMAL(15,4))

        CREATE TABLE #tabProdPlanyProduktyEdytowane (PPP_PPLId INT, PPP_TwrNumer INT, PPP_Termin INT, PPP_TerminDo INT, PPP_DokZrdNumer INT, PPP_DokZrdTyp SMALLINT, PPP_TechnologiaId INT, PPP_IloscDoProdukcji DECIMAL(15, 4), PPP_Edytowany SMALLINT, PPP_IloscOgolnieDostepna DECIMAL(15, 4), PPP_IloscWDrodze DECIMAL(15, 4), PPP_DodanyLp INT)

        CREATE TABLE #tabProdPlanyProduktyDokZwiazane (PPLId INT, TwrNumer INT, Termin INT, TerminDo INT, DokZrdNumer INT, DokZrdTyp SMALLINT, DokNumer INT, DokTyp SMALLINT, DokFirma INT, DokLp INT, TechnologiaId INT, DodanyLp INT, DataZwiazania INT)


        CREATE TABLE #tabProdPlanyProduktyMaterialyBazowe (PPPId INT, TwrNumer INT, ZPId INT, Termin INT, TerminProd INT, Technologia INT, IloscDoWyprodukowania DECIMAL(15, 4), DokZrdNumer INT, DokZrdTyp SMALLINT, TechnologiaId INT)

		CREATE TABLE #CTE_DrzewoSurowcow(
			Id int IDENTITY(1,1) NOT NULL,
			PTZ_TypZasobu INT,
			PTZ_ID INT,
			PTZ_Kod varchar(40),
			PTZ_Nazwa varchar(255),
			TwrNumer INT,
			Twr_Typ smallint, 
			PTZ_Ilosc DECIMAL(19,8),
			PTZ_IloscProduktu DECIMAL(19,8),
			PTZ_IloscFormat INT,
			PTZ_TechnologiaZasob INT, 
			PTZ_Magnumer INT,
			PTC_Technologia INT, 
			PTC_ID INT,
			PTC_IDOrg INT,
			TechOrg INT, 
			Technologia INT, 
			CzynnoscTech INT,
			PTC_Kod varchar(40), 
			PTC_Ilosc varchar(100), 
			PTC_IloscAtr INT,
			PTC_IloscPlan DECIMAL(19,8),
			Zamiennik INT, 
			Poziom INT, 
			IdZamiennikaSurowca INT,
			IdZamiennikaPomocnicze INT,
			ZamiennikProduktu INT,
			MnoznikDoStalejIlosci DECIMAL(19,8),
			OstatniPolproduktZeStalaIloscBezPlanowaniaIlosc DECIMAL(15,4),
			IlPlanowanaPierwszegoPoziomuZapotrzebowaniaZeStalaIlosc DECIMAL(15,4)
		);

		CREATE TABLE #tabProdPlanyMaterialyPelne(
			[PPT_Id] [int] IDENTITY(1,1) NOT NULL,
			[PPT_PPPId] [int] NULL,
			[PPT_TwrNumer] [int] NULL,
			[PPT_Termin] BIGINT NULL,
			[PPT_IloscPotrzeba] [decimal](15, 4) NULL,
			[PPT_IloscOgolnieDostepna] [decimal](15, 4) NULL,
			[PPT_IloscWDrodze] [decimal](15, 4) NULL,
			[PPT_IloscWszystkiePotrzeby] [decimal](15, 4) NULL,
			[PPT_IloscZrealizowana] [decimal](15, 4) NULL,
			[PPT_CzynnoscId] [int] NULL,
			[PPT_MagNumer] [int] NULL,
			[PPT_DoZamowienia] [decimal](15, 4) NULL,
			[PPT_ZapasBezpieczenstwa] [decimal](15, 4) NULL,
			[PPT_EOQ] [decimal](15, 4) NULL,
			[PPT_Wielokrotnosc] [decimal](15, 4) NULL,
			[PPT_Zaokraglenie] [decimal](15, 4) NULL,
			[PPT_CzasDostawy] [int] NULL,
			[PPT_OkresMRPOd] [int] NULL,
			[PPT_OkresMRPDo] [int] NULL,
			[PPT_RodzicId] [int] NULL,
			[PPT_ZamiennikTowaru] [int] NULL,
			PTZ_TechnologiaZasob INT,
			PPT_DoZamowieniaZmienioneRecznie TINYINT Default(0),
			Poziom INT,
			DoZamowieniaPrzedNormowaniem decimal(15,4),
			PTZ_Id INTEGER,
			CzasProdukcji			BIGINT DEFAULT(0),
			PPT_DoWykorzystania		DECIMAL(15,4),
			IdZamiennikaSurowca INT,
			PoziomSurowca INT,
			IdSurowca INT,
			CzyBOMPolprodukt TINYINT Default(0),
			IloscLogistycznaWolna DECIMAL(15,4),
			IloscLogistycznaZajeta DECIMAL(15,4),
			PodzielnikDlaStalejIlosciDlaBOM DECIMAL(20,4),
			KolejnoscPrzeliczania INT
			CONSTRAINT tabProdPlanyMaterialyPelnePrimary PRIMARY KEY CLUSTERED
			(
					[PPT_Id] ASC
			)

		);



        CREATE TABLE #ProdPlanyMaterialyZPonownegoPrzeliczeniaZmianaId(
        IdPPTZPP int,
        IdPPT int
        )

        CREATE TABLE #tmpTwrZapas(
                TwrNr int NOT null,
                Zapas decimal(15,4),
                         Magazyn int
          )

        CREATE TABLE #UzyteGrupId(
                grupId int
        )

		CREATE TABLE #JednostkiLogistyczneWgTowaruProd (IloscLogWolna INT, IloscLogZajeta INT, Twr_GidNumer INT)

        SET @Typ_ProdPlany = 14360
        SET @Typ_ZP = 14343

        SELECT @PlanProdId = PPL_Id, @PPLAktywny = PPL_Aktywny, @DataCzasM = PPL_DataCzasM, @FrsId = PPL_FrsId, @PrzeliczenieRodzaj = PPL_PrzeliczenieRodzaj, @SkladnikiMPS = PPL_SkladnikiMPS, 
		    @Stan = PPL_Stan, @DoProdukcjiPodst = PPL_DoProdukcjiPodst, @DoZamowieniaPodst = PPL_DoZamowieniaPodst, @PrzeliczenieOd = PPL_PrzeliczenieOd, @PrzeliczenieDo = PPL_PrzeliczenieDo, 
		    @UwzgJedLogWProduktach = PPL_UwzgJednLogProdukty
        FROM CDN.ProdPlany
        WHERE PPL_Id = @PlanProdId


        SET @PPLProduktyZdefTechnologia = (
                        SELECT Dok_PPLProduktyZdefTechnologia
                        FROM CDN.DokDefinicje
                        WHERE Dok_FrsId = @FrsId
                                AND Dok_GIDTyp = @Typ_ProdPlany
                        )
        SET @PelneRozwiniecieMaterialowe = (
                        SELECT Dok_PPLUwzglednijBOM
                        FROM CDN.DokDefinicje
                        WHERE Dok_FrsId = @FrsId
                                AND Dok_GIDTyp = @Typ_ProdPlany
                        )
        SET @RezDataAkt = (
                        SELECT Dok_RezDataAkt
                        FROM CDN.DokDefinicje
                        WHERE Dok_FrsId = @FrsId
                                AND Dok_GIDTyp = @Typ_ZP
                        )
        SET @PrzeliczaniePotwierdzonegoPlanu = (
                         SELECT Dok_PPLPrzeliczajPotwierdzony
                         FROM CDN.DokDefinicje
                         WHERE Dok_FrsId = @FrsId
                                AND Dok_GIDTyp = @Typ_ProdPlany
                         )

		IF (SELECT PPL_MagDlaOgolnieDostepna FROM CDN.ProdPlany WHERE PPL_Id = @PlanProdId) = 1
			SET	@ZrodloMagDlaKolOgolnieDostepna = @MagDlaKolOgolnieDostepna
		ELSE
			SET	@ZrodloMagDlaKolOgolnieDostepna = @MagWgPotrzeb
			
		IF (SELECT PPL_MagDlaWDrodze FROM CDN.ProdPlany WHERE PPL_Id = @PlanProdId) = 1
			SET	@ZrodloMagDlaKolWDrodze = @MagDlaKolWDrodze
		ELSE
			SET	@ZrodloMagDlaKolWDrodze = @MagWgPotrzeb

		IF (SELECT PPL_ZakresRezerwacjiDlaProduktu FROM CDN.ProdPlany WHERE PPL_Id = @PlanProdId) = 1 
			SET @ZakresRezerwacjiDlaProduktu = @WszystkieRezerwacje
		ELSE
			SET @ZakresRezerwacjiDlaProduktu = @RezerwacjeZOkresuMPS

    END
    GOTO PoDeklaracje

SprawdzeniePraw:
    BEGIN
           IF @PlanProdId IS NULL
        BEGIN
                IF @Komunikat &lt;&gt; 0
                        RAISERROR ('XLPrzeliczPlanProdukcji: Wystąpił błąd podczas przeliczania planu produkcji. Nie znalezionio planu produkcji.', 16, 1)

                SELECT 7 AS ERROR

                RETURN 7
        END

        IF @PPLAktywny != @SesjaID
        BEGIN
                IF @Komunikat &lt;&gt; 0
                        RAISERROR ('XLPrzeliczPlanProdukcji: Wystąpił błąd podczas przeliczania planu produkcji. Podany plan produkcji nie jest aktywny w obecnej sesji.', 16, 1)

                SELECT 8 AS ERROR

                RETURN 8
        END

        IF @Stan &gt; 1 AND NOT (@PrzeliczaniePotwierdzonegoPlanu = 1 AND @Stan=@PotwierdzonyPlanProdukcji)
        BEGIN
                IF @Komunikat &lt;&gt; 0
                        RAISERROR ('XLPrzeliczPlanProdukcji: Wystąpił błąd podczas przeliczania planu produkcji. Tylko niepotwierdzony plan produkcji można przeliczyć.', 16, 1)

                SELECT 22 AS ERROR

                RETURN 22
        END

        --Operator przeliczający
        SET @OpeNumer = COALESCE((
                                SELECT Ope_GIDNumer
                                FROM CDN.OpeKarty
                                WHERE Ope_GIDNumer = @OpeNumer
                                ), (
                                SELECT Ope_GIDNumer
                                FROM CDN.OpeKarty
                                WHERE Ope_Ident = @OpeKod
                                ), @OpeNumer)

        IF @OpeNumer IS NULL
        BEGIN
                IF @Komunikat &lt;&gt; 0
                        RAISERROR ('XLPrzeliczPlanProdukcji: Wystąpił błąd podczas przeliczania planu produkcji. Podany operator nie występuje w bazie.', 16, 1)

                SELECT 2 AS ERROR

                RETURN 2
        END

        IF @DataCzasPrz IS NULL
                OR @DataCzasPrz = 0
        BEGIN
                SET @DataCzasPrz = DATEDIFF(s, '19900101', GETDATE())
        END
        ELSE
        BEGIN
                IF @DataCzasPrz &lt; @DataCzasM
                        SET @DataCzasPrz = @DataCzasM
        END

        SET @PrzeliczenieData = @DataCzasPrz / 24 / 3600 + DATEDIFF(d, '18001228', GETDATE()) - DATEDIFF(d, '19900101', GETDATE())
    END
    GOTO PoSprawdzeniePraw

WypelnianieTabelPomocniczych:
    BEGIN
        INSERT INTO #tabMagaynyPP
        SELECT *
        FROM CDN.ProdPlanyPobierzMagazynyPP(@PlanProdId, DEFAULT)

		IF @ZrodloMagDlaKolOgolnieDostepna = @MagDlaKolOgolnieDostepna BEGIN
			INSERT INTO #tabMagaynyPP
			SELECT *
			FROM CDN.ProdPlanyPobierzMagazynyPP(@PlanProdId, @MagDlaKolOgolnieDostepna)
		END

		IF @ZrodloMagDlaKolWDrodze = @MagDlaKolWDrodze BEGIN
			INSERT INTO #tabMagaynyPP
			SELECT * 
			FROM CDN.ProdPlanyPobierzMagazynyPP(@PlanProdId, @MagDlaKolWDrodze)
		END

        INSERT INTO #tabCDNProdukty
        SELECT *
        FROM CDN.ProdPlanyPobierzProduktyPP(@PlanProdId)

        INSERT INTO #tabCDNMPS
        SELECT *
        FROM CDN.ProdPlanyPobierzElementyDoMPS(@PlanProdId, 0)

        IF @PrzeliczenieRodzaj = @PrzeliczenieWgOkresu
        BEGIN
            --tworzenie okresow planistycznych
            ;WITH CTE_Okresy
            AS (
                    SELECT PPLId, CASE
                                    WHEN CzasTrwaniaJedn &lt;&gt; 2
                                            THEN CASE
                                                            WHEN PPOkresPlanistycznyOd + CzasTrwania - 1 &lt; PPL_PrzeliczenieOd
                                                                    THEN PPOkresPlanistycznyOd + CzasTrwania - 1 + CAST((CEILING(CAST((PPL_PrzeliczenieOd - (PPOkresPlanistycznyOd + CzasTrwania - 1)) AS DECIMAL(12, 4)) / CzasTrwania)) AS INT) * CzasTrwania - CzasTrwania + 1
                                                            ELSE PPOkresPlanistycznyOd
                                                            END
                                    ELSE PPL_PrzeliczenieOd - DAY(DATEADD(dd, PPL_PrzeliczenieOd, CONVERT(DATETIME, '18001228', 11))) + 1
                                    END PrzeliczenieOd, CASE
                                    WHEN CzasTrwaniaJedn &lt;&gt; 2
                                            THEN CASE
                                                            WHEN PPOkresPlanistycznyOd + CzasTrwania - 1 &lt; PPL_PrzeliczenieOd
                                                                    THEN PPOkresPlanistycznyOd + CzasTrwania - 1 + CAST((CEILING(CAST((PPL_PrzeliczenieOd - (PPOkresPlanistycznyOd + CzasTrwania - 1)) AS DECIMAL(12, 4)) / CzasTrwania)) AS INT) * CzasTrwania
                                                            ELSE PPOkresPlanistycznyOd + CzasTrwania - 1
                                                            END
                                    ELSE PPL_PrzeliczenieOd - DAY(DATEADD(dd, PPL_PrzeliczenieOd, CONVERT(DATETIME, '18001228', 11))) + CzasTrwania
                                    END PrzeliczenieDo, CzasTrwania, CzasTrwaniaJedn
                    FROM (
                            SELECT PPL_Id PPLId, Dok_PlanProdukcjiOkresPlanistycznyOd / 86400 + 69035 PPOkresPlanistycznyOd, PPL_PrzeliczenieOd, PPL_PrzeliczenieDo, CASE
                                            WHEN Dok_PlanProdukcjiOkresPlanistycznyCzasTrwJedn &lt;&gt; 2
                                                    THEN Dok_PlanProdukcjiOkresPlanistycznyCzasTrwania
                                            ELSE DAY(DATEADD(dd, - DATEPART(dd, DATEADD(dd, PPL_PrzeliczenieOd, CONVERT(DATETIME, '18001228', 11))), DATEADD(mm, 1, DATEADD(dd, PPL_PrzeliczenieOd, CONVERT(DATETIME, '18001228', 11)))))
                                            END CzasTrwania, Dok_PlanProdukcjiOkresPlanistycznyCzasTrwJedn CzasTrwaniaJedn
                            FROM CDN.ProdPlany
                            INNER JOIN CDN.DokDefinicje ON Dok_FrsId = PPL_FrsId
                                    AND Dok_GIDTyp = 14360
                            WHERE PPL_Id = @PlanProdId
                            ) PPLPom
                    WHERE (
                                    CASE
                                            WHEN PPOkresPlanistycznyOd + CzasTrwania - 1 &lt; PPL_PrzeliczenieOd
                                                    THEN PPOkresPlanistycznyOd + CzasTrwania - 1 + CAST((CEILING(CAST((PPL_PrzeliczenieOd - (PPOkresPlanistycznyOd + CzasTrwania - 1)) AS DECIMAL(12, 4)) / CzasTrwania)) AS INT) * CzasTrwania - CzasTrwania + 1
                                            ELSE PPOkresPlanistycznyOd
                                            END - CzasTrwania + 1
                                    ) &lt;= PPL_PrzeliczenieDo

                    UNION ALL

                    SELECT PPLId, PrzeliczenieDo + 1 PrzeliczenieOd, (PrzeliczenieDo + CzasTrwania) PrzeliczenieDo, CzasTrwania, CzasTrwaniaJedn
                    FROM (
                            SELECT PPLId, PrzeliczenieOd, PrzeliczenieDo, CASE
                                            WHEN CzasTrwaniaJedn &lt;&gt; 2
                                                    THEN CzasTrwania
                                            ELSE DAY(DATEADD(dd, - DATEPART(dd, DATEADD(dd, PrzeliczenieDo + 1, CONVERT(DATETIME, '18001228', 11))), DATEADD(mm, 1, DATEADD(dd, PrzeliczenieDo + 1, CONVERT(DATETIME, '18001228', 11)))))
                                            END CzasTrwania, CzasTrwaniaJedn
                            FROM CTE_Okresy
                            ) PPLPom
                    INNER JOIN CDN.ProdPlany ON PPL_Id = PPLId
                    WHERE PrzeliczenieDo + 1 &lt;= PPL_PrzeliczenieDo
                            AND PPL_Id = @PlanProdId
                    )
            INSERT #tabOkresyPP (OkresOd, OkresDo)
            SELECT PrzeliczenieOd, PrzeliczenieDo
            FROM CTE_Okresy

           INSERT INTO #tabCDNStanSprzedaz
           SELECT TwrNumer, OkresDo, CASE
                           WHEN Twr_Typ IN (
                                           4
                                           ,6
                                           )
								THEN 0
                           ELSE ISNULL(SUM(Cast(CDN.SubstringEx(CDN.DokSumaStanowTowaru(Twr_GIDTyp, Twr_GIDFirma, Twr_GIDNumer, Twr_Typ, 32768, 1, 1, 0, PPM_MagNumer, 2, 0, 0, OkresDo, 0, 2, @FrsId, 0, 0, 0, 0, 0, 0, - 1), ':', 1) AS DECIMAL(15, 4))), 0)
                           END
           FROM (
                   SELECT DISTINCT TwrNumer, OkresDo, Twr_GIDFirma, Twr_GIDNumer, Twr_GIDTyp, Twr_Typ, MagNumer PPM_MagNumer
                   FROM #tabCDNMPS MPS
                   INNER JOIN #tabCDNProdukty Prod ON MPS.TwrNumer = Prod.Id
                   INNER JOIN CDN.TwrKarty ON MPS.TwrNumer = Twr_GIDNumer
                   INNER JOIN #tabOkresyPP ON MPS.DataRealizacji &gt;= OkresOd
                           AND MPS.DataRealizacji &lt;= OkresDo
                   CROSS JOIN #tabMagaynyPP
					WHERE MagDlaElem = @MagNaNag
                   ) tabPom
           GROUP BY TwrNumer, Twr_Typ, OkresDo
        END
        ELSE
        BEGIN
            INSERT INTO #tabCDNStanSprzedaz
            SELECT TwrNumer, DataRealizacji, ISNULL(SUM(CASE
                                            WHEN Twr_Typ IN (
                                                            4
                                                            ,6
                                                            )
                                                    THEN 0
                                            ELSE Cast(CDN.SubstringEx(CDN.DokSumaStanowTowaru(Twr_GIDTyp, Twr_GIDFirma, Twr_GIDNumer, Twr_Typ, 32768, 1, 1, 0, PPM_MagNumer, 2, 0, 0, DataRealizacji, 0, 2, @FrsId, 0, 0, 0, 0, 0, 0, - 1), ':', 1) AS DECIMAL(15, 4))
                                            END), 0)
            FROM (
                    SELECT DISTINCT TwrNumer, MPS.DataRealizacji, Twr_GIDFirma, Twr_GIDNumer, Twr_GIDTyp, Twr_Typ, MagNumer PPM_MagNumer
                    FROM #tabCDNMPS MPS
                    INNER JOIN #tabCDNProdukty Prod ON MPS.TwrNumer = Prod.Id
                    INNER JOIN CDN.TwrKarty ON MPS.TwrNumer = Twr_GIDNumer
                    CROSS JOIN #tabMagaynyPP
					WHERE MagDlaElem = @MagNaNag
                    ) tabPom
            GROUP BY TwrNumer, DataRealizacji
        END
    END

	IF @ZakresRezerwacjiDlaProduktu = @WszystkieRezerwacje 
	BEGIN
		SELECT @ZakresRezerwacjiOd = MIN(DataRealizacji), @ZakresRezerwacjiDo = MAX(DataRealizacji) FROM #tabCDNMPS
	END
	ELSE
	BEGIN
		SET @ZakresRezerwacjiOd = @PrzeliczenieOd
		SET @ZakresRezerwacjiDo = @PrzeliczenieDo
	END


    GOTO PoWypelnianieTabelPomocniczych

PrzenoszenieDanychZPoprzednioWygenerowanegoPlanu:
    BEGIN
           IF EXISTS (
                        SELECT *
                        FROM CDN.ProdPlanyProdukty
                        WHERE PPP_PPLId = @PlanProdId
                        )
        BEGIN
                INSERT INTO #tabProdPlanyProduktyEdytowane (PPP_PPLId, PPP_DokZrdNumer, PPP_DokZrdTyp, PPP_IloscDoProdukcji, PPP_TechnologiaId, PPP_Termin, PPP_TerminDo, PPP_TwrNumer, PPP_Edytowany, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, PPP_DodanyLp)
                SELECT PPP_PPLId, PPP_DokZrdNumer, PPP_DokZrdTyp, PPP_IloscDoProdukcji, PPP_TechnologiaId, PPP_Termin, PPP_TerminDo, PPP_TwrNumer, PPP_Edytowany, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, PPP_DodanyLp
                FROM CDN.ProdPlanyProdukty
                WHERE PPP_PPLId = @PlanProdId
                        AND PPP_Edytowany &amp; @EdycjaIlosc &gt; 0

                INSERT INTO #tabProdPlanyProduktyDokZwiazane (PPLId, TwrNumer, Termin, TerminDo, DokZrdNumer, DokZrdTyp, DokNumer, DokTyp, DokFirma, DokLp, TechnologiaId, DodanyLp, DataZwiazania)
                SELECT PPP_PPLId, PPP_TwrNumer, PPP_Termin, PPP_TerminDo, PPP_DokZrdNumer, PPP_DokZrdTyp, DOZ_DOKNumer, DOZ_DOKTyp, DOZ_DOKFirma, DOZ_DOKLp, PPP_TechnologiaId, PPP_DodanyLp, DOZ_DataZwiazania
                FROM CDN.ProdPlanyProdukty
                INNER JOIN CDN.DokZwiazane ON DOZ_ZRDNumer = PPP_Id
                        AND DOZ_ZRDTyp = 14361
                WHERE PPP_PPLId = @PlanProdId
                        AND PPP_Edytowany &amp; @EdycjaDodanyRecznie = 0

                SET @KolejnePrzeliczeniePlanu = 1
        END
    END
    GOTO PoPrzenoszenieDanychZPoprzednioWygenerowanegoPlanu


CzyszczenieStaregoPlanuProdukcji:
    BEGIN
              UPDATE CDN.ProdPlanyProdukty SET PPP_TerminProdukcji=NULL
                                WHERE PPP_PPLId = @PlanProdId
                                        AND PPP_Edytowany &amp; @EdycjaDodanyRecznie = @EdycjaDodanyRecznie
                IF EXISTS (
                                SELECT *
                                FROM CDN.ProdPlanyProdukty
                                WHERE PPP_PPLId = @PlanProdId
                                        AND PPP_Edytowany &amp; @EdycjaDodanyRecznie = 0
                                )
                BEGIN
                        
                        DELETE
                        FROM CDN.ProdPlanyProdukty
                        WHERE PPP_PPLId = @PlanProdId
                                AND PPP_Edytowany &amp; @EdycjaDodanyRecznie = 0 --jednoczesnie usuwane sa wpisy(relacja) z tabeli CDN.ProdPlanyMaterialy, CDN.ProdPlanyZrdDok, CDN.ProdPlanyMaterialyGrupy, CDN.ProdPlanyMaterialyDoZamowienia

                        IF @@ROWCOUNT = 0
                        BEGIN
                                ROLLBACK TRAN

                                IF @Komunikat &lt;&gt; 0
                                        RAISERROR ('XLPrzeliczPlanProdukcji: Wystąpił błąd podczas przeliczania planu produkcji.Nie powiodło się usuwanie z tabeli CDN.ProdPlanyProdukty.', 16, 1)

                                SELECT 16 AS ERROR

                                RETURN 16
                        END
                        
                END
                                -- czyszczenie powiązań dok. generowanych z materiałów z materiałami(które są czyszczone przy przeliczaniu)
                                ;WITH CTE AS (
									SELECT
										ROW_NUMBER() OVER (PARTITION BY PPD_PPLId, PPD_DokTyp, PPD_DokNumer ORDER BY PPD_PPLId, PPD_DokTyp, PPD_DokNumer) row_num
									FROM cdn.ProdPlanyDokumenty
									WHERE PPD_PPLId=@PlanProdId
								)
								DELETE FROM cte
								WHERE row_num &gt; 1;

								UPDATE cdn.ProdPlanyDokumenty SET PPD_PPTGId=0 WHERE PPD_PPLId=@PlanProdId

                                DELETE ZrdDok FROM cdn.ProdPlanyZrdDok ZrdDok   -- usuwanie dok. źródłowych dla pozycji na produktach zgrupowanych, gdzie conajmniej jeden zgrupowany jest dodany ręcznie(relacja zostawia, bo zostały wpisy z dodanego ręcznie)
                                        JOIN cdn.ProdPlanyProdukty ON PPZ_PPPId = PPP_Id
                                WHERE PPP_PPLId=@PlanProdId
                                DELETE PPT FROM cdn.ProdPlanyMaterialy PPT      -- usuwanie materiałów dla pozycji na produktach(relacja zostawia, jeśli zostały wpisy z dodanego ręcznie)
                                        JOIN cdn.ProdPlanyProdukty ON PPT_PPPId = PPP_Id
                                WHERE PPP_PPLId=@PlanProdId
    END



    GOTO PoCzyszczenieStaregoPlanuProdukcji


AktualizacjaInformacjiOOstatnimPrzeliczeniuPlanu:
    BEGIN
        UPDATE CDN.ProdPlany
        SET PPL_OpePrzNumer = @OpeNumer, PPL_DataCzasPrz = @DataCzasPrz, PPL_ZmianyPoPrzeliczeniu = 0
        WHERE PPL_Id = @PlanProdId
                AND PPL_Aktywny = @SesjaID

        IF @@ROWCOUNT = 0
                AND EXISTS (
                        SELECT *
                        FROM #tabCDNMPS
                        WHERE RezGIDTyp = 2576
                        )
        BEGIN
                ROLLBACK TRAN

                IF @Komunikat &lt;&gt; 0
                        RAISERROR ('XLPrzeliczPlanProdukcji: Wystąpił błąd podczas przeliczania planu produkcji. Nie powiódł się zapis do tabeli CDN.ProdPlany.', 16, 1)

                SELECT 1 AS ERROR

                RETURN 1
        END
    END
    GOTO PoAktualizacjaInformacjiOOstatnimPrzeliczeniuPlanu


WyliczenieProduktowPlanu:
    BEGIN
		IF EXISTS(SELECT * FROM sysobjects WHERE name = 'fnLogisticUnitQuantities' AND xtype = N'IF')
		BEGIN
			IF (SELECT COUNT(PPM_PPLId) FROM CDN.ProdPlanyMag WHERE PPM_PPLId = @PlanProdId AND PPM_MagDlaElem = @MagNaNag) &lt;&gt; 0 
			BEGIN
				INSERT INTO #JednostkiLogistyczneWgTowaruProd
				SELECT SUM(luq.FreeLogisticUnits) wolne, SUM(luq.OccupiedLogisticUnits) zajete, TwrNumer
				FROM (SELECT DISTINCT TwrNumer FROM #tabCDNMPS WHERE MPSTyp &gt; 0 AND DataRealizacji &gt;= @PrzeliczenieOd AND DataRealizacji &lt;= @PrzeliczenieDo) pp
					JOIN CDN.TwrKarty t ON t.Twr_GIDNumer = pp.TwrNumer AND t.Twr_GIDTyp = 16
					CROSS APPLY WMS.fnLogisticUnitQuantities(TwrNumer) luq
					JOIN CDN.ProdPlanyMag m ON m.PPM_PPLId = @PlanProdId AND luq.WarehouseId = m.PPM_MagNumer AND m.PPM_MagDlaElem = @MagNaNag
				WHERE t.Twr_JLogWMS = 1
				GROUP BY TwrNumer

			END
			ELSE
			BEGIN
				INSERT INTO #JednostkiLogistyczneWgTowaruProd
				SELECT SUM(luq.FreeLogisticUnits) wolne, SUM(luq.OccupiedLogisticUnits) zajete, TwrNumer
				FROM (SELECT DISTINCT TwrNumer FROM #tabCDNMPS WHERE MPSTyp &gt; 0 AND DataRealizacji &gt;= @PrzeliczenieOd AND DataRealizacji &lt;= @PrzeliczenieDo) pp
					JOIN CDN.TwrKarty t ON t.Twr_GIDNumer = pp.TwrNumer AND t.Twr_GIDTyp = 16
					CROSS APPLY WMS.fnLogisticUnitQuantities(TwrNumer) luq
				WHERE t.Twr_JLogWMS = 1
				GROUP BY TwrNumer
			END

		END

		IF @PrzeliczenieRodzaj = @PrzeliczenieWgOkresu
        BEGIN --wybrane wg okresu, tutaj termin brany jest z okresu planistycznego
                INSERT INTO #tabProdPlanyProdukty (PPP_PPLId, PPP_Termin, PPP_TerminDo, PPP_DokZrdTyp, PPP_DokZrdNumer, PPP_DokZrdLp, PPP_TwrNumer, PPP_IloscMPS, PPP_IloscRez, PPP_IloscDoWykorzystania, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, PPP_IloscNaZp, PPP_IloscZaplanowana, PPP_IloscWToku, PPP_IloscZrealizowana, PPP_TerminNaZP, PPP_TechnologiaId, PPP_IloscDoProdukcji, PPP_IloscMinProdukcji, PPP_IloscProduktPTZ, PPP_IloscBrakNaMPS, PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, PPP_OkresMRPOd, PPP_OkresMRPDo, IloscLogistycznaWolna, IloscLogistycznaZajeta)
                SELECT PlanProdId, MPSKoncowe.OkresOd, MPSKoncowe.OkresDo, GIDTyp, GIDNumer, GIDLp, MPSKoncowe.TwrNumer, MPS, REZ, CASE
                                WHEN DoWykorzystania &lt; 0
                                        THEN 0
                                WHEN DoWykorzystania &gt; MPS
                                        THEN MPS
                                ELSE DoWykorzystania
                                END, CASE
                                WHEN OgolnieDostepna &lt; 0
                                        THEN 0
                                ELSE OgolnieDostepna
                                END, WDrodze, NaZP, Zaplanowana, CASE
                                WHEN Wtoku &lt; 0
                                        THEN 0
                                ELSE Wtoku
                                END, Zrealizowana, 0, TechnologiaId, CASE
                                WHEN MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                ) &lt;= 0
                                        THEN 0
                                ELSE MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                )
                                END IloscDoProdukcji, IloscMinPTZ, IloscProduktPTZ, CASE
                                WHEN MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                ) &lt;= 0
                                        THEN 0
                                ELSE MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                )
                                END IloscBrakNaMPS,
                                                   CASE (@CzyNormatywyZMagazynu)
                                                   WHEN 1 THEN COALESCE((SELECT Tpm_IloscMin FROM cdn.TwrParMag WHERE Twr_GIDNumer=Tpm_TwrNumer AND Tpm_MagNumer=(SELECT MagNumer FROM #tabMagaynyPP WHERE MagDlaElem = @MagNaNag) ),Twr_IloscMin)
                                                   ELSE Twr_IloscMin
                                                   END  ZapasBezpieczenstwa,
                                                   Twr_MrpEoq EOQ,
                                                    CASE (@CzyNormatywyZMagazynu)
                                                   WHEN 1 THEN COALESCE((SELECT Tpm_IloscZam FROM cdn.TwrParMag WHERE Twr_GIDNumer=Tpm_TwrNumer AND Tpm_MagNumer=(SELECT MagNumer FROM #tabMagaynyPP WHERE MagDlaElem = @MagNaNag) ),Twr_IloscZam)
                                                   ELSE Twr_IloscZam
                                                   END Wielokrotnosc,
                                                                                                   CASE
                                                                                                   WHEN Twr_MrpZaok =0 THEN 0
                                                                                                   WHEN Twr_MrpZaok %1000000=0 THEN 1000000
                                                                                                   WHEN Twr_MrpZaok %100000=0 THEN 100000
                                                                                                   WHEN Twr_MrpZaok %10000=0 THEN 10000
                                                                                                   WHEN Twr_MrpZaok %1000=0 THEN 1000
                                                                                                   WHEN Twr_MrpZaok %100=0 THEN 100
                                                                                                   WHEN Twr_MrpZaok %10=0 THEN 10
                                                                                                   WHEN Twr_MrpZaok %1=0 THEN 1
                                                                                                   WHEN Twr_MrpZaok %0.1=0 THEN 0.1
                                                                                                   WHEN Twr_MrpZaok %0.01=0 THEN 0.01
                                                                                                   WHEN Twr_MrpZaok %0.001=0 THEN 0.001
                                                                                                   WHEN Twr_MrpZaok %0.0001=0 THEN 0.0001
                                                                                                   END Zaokraglanie,
                                                   0 OkresMRPOd, 0 OkresMRPDo, IloscLogWolna, IloscLogZajeta
                FROM (
                        SELECT @PlanProdId PlanProdId, MPS.OkresOd, MPS.OkresDo, MPS.GIDTyp, MPS.GIDNumer, MPS.GIDLp, MPS.TwrNumer, MPS, REZ, (
                                        SELECT ISNULL(SUM(CASE
                                                                        WHEN Rodzaj &lt;= @RodzajZWZak
                                                                                THEN Ilosc
                                                                        WHEN RezGIDTyp = 2576
                                                                                THEN - Ilosc
                                                                        END), 0)
                                        FROM #tabCDNMPS MPSPom
                                        WHERE (Id &lt; MPS.Id OR MPSPom.DataRealizacji = 93890) --rezerwacje online
                                                AND MPSPom.Rodzaj != @RodzajZP
                                                AND (
                                                        (
                                                                MPSPom.DataRealizacji &gt; @PrzeliczenieData
                                                                AND Rodzaj &lt;= @RodzajZWZak
                                                                )
                                                        OR Rodzaj &gt; @RodzajZWZak
                                                        )
                                                AND MPS.TwrNumer = MPSPom.TwrNumer
                                                AND (
                                                        MPS.GIDTyp != 14343
                                                        OR (
                                                                MPS.GIDTyp != MPSPom.GIDTyp
                                                                AND MPS.GIDNumer != MPSPom.GIDNumer
                                                                AND MPS.GIDLp != MPSPom.GIDLp
                                                                )
                                                        )
												AND ((MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo) OR MPSPom.DataRealizacji = 93890) --rezerwacje online
                                        ) - (
                                        SELECT MPSPom.IloscDst
                                        FROM #tabCDNMPS MPSPom
                                        WHERE MPSPom.Id = MPS.Id
                                        ) + StanS.Ilosc - CASE @UwzgJedLogWProduktach WHEN 1 THEN ISNULL(IloscLogZajeta, 0) ELSE 0 END DoWykorzystania, (
                                        SELECT ISNULL(SUM(CASE
                                                                        WHEN Rodzaj &lt;= @RodzajZWZak
                                                                                THEN Ilosc
                                                                        WHEN RezGIDTyp = 2576
                                                                                THEN - Ilosc
                                                                        END), 0)
                                        FROM #tabCDNMPS MPSPom
                                        WHERE (MPSPom.DataRealizacji &lt;= MPS.OkresDo OR MPSPom.DataRealizacji = 93890) --rezerwacje online
                                                AND MPSPom.Rodzaj != @RodzajZP
                                                AND (
                                                        (
                                                                MPSPom.DataRealizacji &gt; @PrzeliczenieData
                                                                AND Rodzaj &lt;= @RodzajZWZak
                                                                )
                                                        OR Rodzaj &gt; @RodzajZWZak
                                                        )
                                                AND MPS.TwrNumer = MPSPom.TwrNumer
                                                AND (
                                                        MPS.GIDTyp != 14343
                                                        OR (
                                                                MPS.GIDNumer != MPSPom.GIDNumer
                                                                AND MPS.GIDLp != MPSPom.GIDLp
                                                                )
                                                        )
												AND ((MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo) OR MPSPom.DataRealizacji = 93890) --rezerwacje online
                                        ) + (
                                        SELECT ISNULL(SUM(MPSPom.Ilosc - MPSPom.IloscDst), 0)
                                        FROM #tabCDNMPS MPSPom
                                        WHERE MPSPom.MPSTyp &gt; 0
                                                AND MPSPom.Rodzaj != @RodzajZP
                                                AND MPSPom.RezGIDTyp = 2576
                                                AND MPSPom.DataRealizacji = MPS.OkresDo
                                                AND MPS.TwrNumer = MPSPom.TwrNumer
                                                AND (
                                                        MPS.GIDTyp != 14343
                                                        OR (
                                                                MPS.GIDNumer != MPSPom.GIDNumer
                                                                AND MPS.GIDLp != MPSPom.GIDLp
                                                                )
                                                        )
                                        ) + ISNULL(StanS.Ilosc, 0) - CASE @UwzgJedLogWProduktach WHEN 1 THEN ISNULL(IloscLogZajeta, 0) ELSE 0 END OgolnieDostepna, (
                                        SELECT ISNULL(SUM(Ilosc), 0)
                                        FROM #tabCDNMPS MPSPom
                                        WHERE (
                                                        (
                                                                MPSPom.DataRealizacji &gt; MPS.OkresDo
                                                                OR MPSPom.DataRealizacji &lt;= @PrzeliczenieData
                                                                )
                                                        AND Rodzaj = @RodzajZak
                                                        )
                                                AND MPS.TwrNumer = MPSPom.TwrNumer
												AND MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo
                                        ) WDrodze, CASE
                                        WHEN GIDTyp = 960
                                                THEN ISNULL((
                                                                        SELECT SUM(PZE_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.ZamZamLinki ON ZZL_ZZGidNumer = PZE_Id
                                                                                AND ZZL_ZZGidTyp = 14343
                                                                        WHERE ZZL_ZSGidNumer = GIDNumer
                                                                                AND ZZL_ZSGidTyp = GIDTyp
                                                                                AND ZZL_ZSGidLp = GIDLp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                        ), 0)
                                        WHEN GIDTyp = 14347
                                                THEN ISNULL((
                                                                        SELECT SUM(PZE_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.DokZwiazane ON DOZ_DOKNumer = PZE_Id
                                                                                AND DOZ_DOKTyp = 14343
                                                                        WHERE DOZ_ZRDNumer = GIDLp
                                                                                AND DOZ_ZRDTyp = GIDTyp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                        ), 0)
                                        ELSE MPS
                                        END NaZP, CASE
                                        WHEN GIDTyp = 960
                                                THEN ISNULL((
                                                                        SELECT SUM(PLK_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.ZamZamLinki ON ZZL_ZZGidNumer = PZE_Id
                                                                                AND ZZL_ZZGidTyp = 14343
                                                                        INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                        WHERE ZZL_ZSGidNumer = GIDNumer
                                                                                AND ZZL_ZSGidTyp = GIDTyp
                                                                                AND ZZL_ZSGidLp = GIDLp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                                AND PLK_ObiTyp = 2592
                                                                        ), 0)
                                        WHEN GIDTyp = 14347
                                                THEN ISNULL((
                                                                        SELECT SUM(PLK_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.DokZwiazane ON DOZ_DOKNumer = PZE_Id
                                                                                AND DOZ_DOKTyp = 14343
                                                                        INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                        WHERE DOZ_ZRDNumer = GIDLp
                                                                                AND DOZ_ZRDTyp = GIDTyp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                                AND PLK_ObiTyp = 2592
                                                                        ), 0)
                                        ELSE ISNULL((
                                                                SELECT SUM(PLK_Ilosc)
                                                                FROM CDN.ProdZlecElem
                                                                INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                WHERE PZE_Id = GIDLp
                                                                        AND PZE_TwrNumer = MPS.TwrNumer
                                                                        AND PLK_ObiTyp = 2592
                                                                ), 0)
                                        END Zaplanowana, ISNULL(ZasobyMPS.IloscZasobPZA, 0) - ISNULL(ZasobyMPS.IloscPwPZA, 0) Wtoku, ISNULL(ZasobyMPS.IloscPwPZA, 0) Zrealizowana, ISNULL(PTE_Id, 0) TechnologiaId, ISNULL((
                                                SELECT CASE WHEN CDN.CzyKlasaAtrOkresowa(PTZ_IloscMinAtr) = 1 THEN PTZ_IloscMin
												ELSE CDN.ProdIloscAtr(1,PTZ_IloscMin,PTZ_IloscMinAtr,4,PTZ_TypZasobu,PTC_Ilosc,PTC_IloscAtr,14340,PTC_Technologia,0,0) END
                                                FROM CDN.ProdTechnologiaZasoby
												JOIN CDN.ProdTechnologiaCzynnosci ON PTC_Id = PTZ_TechnologiaCzynnosc
                                                WHERE PTZ_Id = (
                                                                SELECT MIN(PTZ_Id)
                                                                FROM CDN.ProdTechnologiaCzynnosci
                                                                INNER JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
                                                                        AND PTZ_TwrNumer = MPS.TwrNumer
                                                                        AND PTZ_TwrTyp = 16
                                                                        AND PTZ_TypZasobu = 0
                                                                WHERE PTC_Technologia = PTE_Id
                                                                )
                                                ), 0)
                                IloscMinPTZ, ISNULL((
                                                SELECT CASE WHEN CDN.CzyKlasaAtrOkresowa(PTZ_IloscAtr) = 1 THEN PTZ_Ilosc
													ELSE CDN.ProdIloscAtr(1,PTZ_Ilosc,PTZ_IloscAtr,4,PTZ_TypZasobu,PTC_Ilosc,PTC_IloscAtr,14340,PTC_Technologia,0,0) end
                                                FROM CDN.ProdTechnologiaZasoby
												JOIN CDN.ProdTechnologiaCzynnosci ON PTC_Id = PTZ_TechnologiaCzynnosc
                                                WHERE PTZ_Id = (
                                                                SELECT MIN(PTZ_Id)
                                                                FROM CDN.ProdTechnologiaCzynnosci
                                                                INNER JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
                                                                        AND PTZ_TwrNumer = MPS.TwrNumer
                                                                        AND PTZ_TwrTyp = 16
                                                                        AND PTZ_TypZasobu = 0
                                                                WHERE PTC_Technologia = MPS.TechnologiaId
                                                                )
                                                ), 0) IloscProduktPTZ, IloscLogWolna, IloscLogZajeta
                        FROM (
                                SELECT OkresOd, OkresDo, GIDTyp, GIDLp, GIDNumer, TwrNumer, Id, Ilosc MPS, IloscDst REZ, TechnologiaId
                                FROM #tabCDNMPS
                                INNER JOIN #tabOkresyPP ON DataRealizacji &gt;= OkresOd
                                        AND DataRealizacji &lt;= OkresDo
                                WHERE MPSTyp &gt; 0
									AND DataRealizacji &gt;= @PrzeliczenieOd AND DataRealizacji &lt;= @PrzeliczenieDo
                                        --group by DataRealizacji, GIDTyp, GIDNumer, TwrNumer, Id
                                ) MPS
                        OUTER APPLY CDN.ProdPlanyZasobyMPS(GIDNumer, GIDTyp, GIDLp, MPS.TwrNumer, 0) ZasobyMPS
                        LEFT JOIN #tabCDNStanSprzedaz StanS ON StanS.DataRealizacji = MPS.OkresDo
                                AND StanS.TwrNumer = MPS.TwrNumer
                        LEFT JOIN CDN.ProdTechnologia ON PTE_Id = TechnologiaId
						LEFT JOIN #JednostkiLogistyczneWgTowaruProd jg ON jg.Twr_GidNumer = MPS.TwrNumer
                        ) MPSKoncowe
                        JOIN cdn.TwrKarty on Twr_GIDNumer=MPSKoncowe.TwrNumer
						--WHERE DataRealizacji BETWEEN (

        END
        ELSE IF @PrzeliczenieRodzaj = @PrzeliczenieWgDok
        BEGIN --wybrane wg dokumentu, tutaj termin brany jest z elemntow MPS
                INSERT INTO #tabProdPlanyProdukty (PPP_PPLId, PPP_Termin, PPP_TerminDo, PPP_DokZrdTyp, PPP_DokZrdNumer, PPP_DokZrdLp, PPP_TwrNumer, PPP_IloscMPS, PPP_IloscRez, PPP_IloscDoWykorzystania, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, PPP_IloscNaZp, PPP_IloscZaplanowana, PPP_IloscWToku, PPP_IloscZrealizowana, PPP_TerminNaZP, PPP_TechnologiaId, PPP_IloscDoProdukcji, PPP_IloscMinProdukcji, PPP_IloscProduktPTZ, PPP_IloscBrakNaMPS, PriorytetRez, PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, PPP_OkresMRPOd, PPP_OkresMRPDo, IloscLogistycznaWolna, IloscLogistycznaZajeta)
                SELECT PlanProdId, MPSKoncowe.DataRealizacji, 0 TerminDo, GIDTyp, GIDNumer, GIDLp, MPSKoncowe.TwrNumer, MPS, REZ, CASE
                                WHEN DoWykorzystania &lt; 0
                                        THEN 0
                                WHEN DoWykorzystania &gt; MPS
                                        THEN MPS
                                ELSE DoWykorzystania
                                END, CASE
                                WHEN OgolnieDostepna &lt; 0
                                        THEN 0
                                ELSE OgolnieDostepna
                                END, WDrodze, NaZP, Zaplanowana, CASE
                                WHEN Wtoku &lt; 0
                                        THEN 0
                                ELSE Wtoku
                                END, Zrealizowana, TerminNaZp, TechnologiaId, CASE
                                WHEN MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                ) &lt;= 0
                                        THEN 0
                                ELSE MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                )
                                END IloscDoProdukcji
                                , IloscMinPTZ, IloscProduktPTZ, CASE
                                WHEN MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                ) &lt;= 0
                                        THEN 0
                                ELSE MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                )
                                END IloscBrakNaMPS, PriorytetRez,
                                                   CASE (@CzyNormatywyZMagazynu)
                                                   WHEN 1 THEN COALESCE((SELECT Tpm_IloscMin FROM cdn.TwrParMag WHERE Twr_GIDNumer=Tpm_TwrNumer AND Tpm_MagNumer=(SELECT MagNumer FROM #tabMagaynyPP WHERE MagDlaElem = @MagNaNag) ),Twr_IloscMin)
                                                   ELSE Twr_IloscMin
                                                   END  ZapasBezpieczenstwa,
                                                   Twr_MrpEoq EOQ,
                                                    CASE (@CzyNormatywyZMagazynu)
                                                   WHEN 1 THEN COALESCE((SELECT Tpm_IloscZam FROM cdn.TwrParMag WHERE Twr_GIDNumer=Tpm_TwrNumer AND Tpm_MagNumer=(SELECT MagNumer FROM #tabMagaynyPP WHERE MagDlaElem = @MagNaNag) ),Twr_IloscZam)
                                                   ELSE Twr_IloscZam
                                                   END Wielokrotnosc,
                                                    CASE
                                                                                                   WHEN Twr_MrpZaok =0 THEN 0
                                                                                                   WHEN Twr_MrpZaok %1000000=0 THEN 1000000
                                                                                                   WHEN Twr_MrpZaok %100000=0 THEN 100000
                                                                                                   WHEN Twr_MrpZaok %10000=0 THEN 10000
                                                                                                   WHEN Twr_MrpZaok %1000=0 THEN 1000
                                                                                                   WHEN Twr_MrpZaok %100=0 THEN 100
                                                                                                   WHEN Twr_MrpZaok %10=0 THEN 10
                                                                                                   WHEN Twr_MrpZaok %1=0 THEN 1
                                                                                                   WHEN Twr_MrpZaok %0.1=0 THEN 0.1
                                                                                                   WHEN Twr_MrpZaok %0.01=0 THEN 0.01
                                                                                                   WHEN Twr_MrpZaok %0.001=0 THEN 0.001
                                                                                                   WHEN Twr_MrpZaok %0.0001=0 THEN 0.0001
                                                                                                   END  Zaokraglanie,
                                                   0 OkresMRPOd, 0 OkresMRPDo, IloscLogWolna, IloscLogZajeta
                FROM (
                        SELECT @PlanProdId PlanProdId, MPS.DataRealizacji, MPS.GIDTyp, MPS.GIDNumer, MPS.GIDLp, MPS.TwrNumer, MPS, REZ, CASE
                                        WHEN GIDTyp = 14343
                                                THEN 0
                                        ELSE (
                                                        SELECT ISNULL(SUM(CASE
                                                                                        WHEN Rodzaj &lt;= @RodzajZWZak
                                                                                                THEN Ilosc
                                                                                        WHEN RezGIDTyp = 2576
                                                                                                THEN - Ilosc
                                                                                        END), 0)
                                                        FROM #tabCDNMPS MPSPom
                                                        WHERE (MPSPom.Id &lt; MPS.Id OR MPSPom.DataRealizacji = 93890) --rezerwacje online
                                                                AND MPSPom.Rodzaj != @RodzajZP
                                                                AND (
                                                                        (
                                                                                MPSPom.DataRealizacji &gt; @PrzeliczenieData
                                                                                AND Rodzaj &lt;= @RodzajZWZak
                                                                                )
                                                                        OR Rodzaj &gt; @RodzajZWZak
                                                                        )
                                                                AND MPS.TwrNumer = MPSPom.TwrNumer
                                                                AND (
                                                                        MPS.GIDTyp != 14343
                                                                        OR (
                                                                                MPS.GIDNumer != MPSPom.GIDNumer
                                                                                AND MPS.GIDLp != MPSPom.GIDLp
                                                                                )
                                                                        )
																AND ((MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo) OR MPSPom.DataRealizacji = 93890)
                                                        ) - (
                                                       SELECT SUM(MPSPom.IloscDst)
                                                        FROM #tabCDNMPS MPSPom
                                                        WHERE
                                                                                         MPSPom.DataRealizacji=MPS.DataRealizacji AND MPSPom.TwrNumer=MPS.TwrNumer
                                                                                         /* MPSPom.Id = MPS.Id*/
                                                        ) + StanS.Ilosc - CASE @UwzgJedLogWProduktach WHEN 1 THEN ISNULL(IloscLogZajeta, 0) ELSE 0 END
                                        END DoWykorzystania, (
                                        SELECT ISNULL(SUM(CASE
                                                                        WHEN Rodzaj &lt;= @RodzajZWZak
                                                                                THEN Ilosc
                                                                        WHEN RezGIDTyp = 2576
                                                                                THEN - Ilosc
                                                                        END), 0)
                                        FROM #tabCDNMPS MPSPom
                                        WHERE (MPSPom.DataRealizacji &lt;= MPS.DataRealizacji OR MPSPom.DataRealizacji = 93890) --rezerwacje online
                                                AND MPSPom.Rodzaj != @RodzajZP
                                                AND (
                                                        (
                                                                MPSPom.DataRealizacji &gt; @PrzeliczenieData
                                                                AND 
																Rodzaj &lt;= @RodzajZWZak
                                                                )
                                                        OR Rodzaj &gt; @RodzajZWZak
                                                        )
                                                AND MPS.TwrNumer = MPSPom.TwrNumer
                                                AND (
                                                        MPS.GIDTyp != 14343
                                                        OR (
                                                                MPS.GIDNumer != MPSPom.GIDNumer
                                                                AND MPS.GIDLp != MPSPom.GIDLp
                                                                )
                                                        )
												AND ((MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo) OR MPSPom.DataRealizacji = 93890)
                                        ) + (
                                        SELECT ISNULL(SUM(MPSPom.Ilosc - MPSPom.IloscDst), 0)
                                        FROM #tabCDNMPS MPSPom
                                        WHERE MPSPom.MPSTyp &gt; 0
                                                AND MPSPom.RezGIDTyp = 2576
                                                AND MPSPom.DataRealizacji = MPS.DataRealizacji
                                                AND MPSPom.Rodzaj != @RodzajZP
                                                AND MPS.TwrNumer = MPSPom.TwrNumer
                                                AND (
                                                        MPS.GIDTyp != 14343
                                                        OR (
                                                                MPS.GIDNumer != MPSPom.GIDNumer
                                                                AND MPS.GIDLp != MPSPom.GIDLp
                                                                )
                                                        )
                                        ) + ISNULL(StanS.Ilosc, 0) - CASE @UwzgJedLogWProduktach WHEN 1 THEN ISNULL(IloscLogZajeta, 0) ELSE 0 END OgolnieDostepna, (
                                        SELECT ISNULL(SUM(Ilosc), 0)
                                        FROM #tabCDNMPS MPSPom
                                        WHERE (
                                                        (
                                                                MPSPom.DataRealizacji &gt; MPS.DataRealizacji
                                                                OR MPSPom.DataRealizacji &lt;= @PrzeliczenieData
                                                                )
                                                        AND Rodzaj = @RodzajZak
                                                        )
                                                AND MPS.TwrNumer = MPSPom.TwrNumer
												AND MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo
                                        ) WDrodze, CASE
                                        WHEN GIDTyp = 960
                                                THEN ISNULL((
                                                                        SELECT SUM(PZE_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.ZamZamLinki ON ZZL_ZZGidNumer = PZE_Id
                                                                                AND ZZL_ZZGidTyp = 14343
                                                                        WHERE ZZL_ZSGidNumer = GIDNumer
                                                                                AND ZZL_ZSGidTyp = GIDTyp
                                                                                AND ZZL_ZSGidLp = GIDLp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                        ), 0)
                                        WHEN GIDTyp = 14347
                                                THEN ISNULL((
                                                                        SELECT SUM(PZE_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.DokZwiazane ON DOZ_DOKNumer = PZE_Id
                                                                                AND DOZ_DOKTyp = 14343
                                                                        WHERE DOZ_ZRDNumer = GIDLp
                                                                                AND DOZ_ZRDTyp = GIDTyp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                        ), 0)
                                        ELSE MPS
                                        END NaZP, CASE
                                        WHEN GIDTyp = 960
                                                THEN ISNULL((
                                                                        SELECT SUM(PLK_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.ZamZamLinki ON ZZL_ZZGidNumer = PZE_Id
                                                                                AND ZZL_ZZGidTyp = 14343
                                                                        INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                        -- inner join CDN.Rezerwacje on Rez_GIDNumer = PLK_ObiNumer and Rez_GIDTyp = PLK_ObiTyp
                                                                        WHERE ZZL_ZSGidNumer = GIDNumer
                                                                                AND ZZL_ZSGidLp = GIDLp
                                                                                AND ZZL_ZSGidTyp = GIDTyp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                                AND PLK_ObiTyp = 2592
                                                                        ), 0)
                                        WHEN GIDTyp = 14347
                                                THEN ISNULL((
                                                                        SELECT SUM(PLK_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.DokZwiazane ON DOZ_DOKNumer = PZE_Id
                                                                                AND DOZ_DOKTyp = 14343
                                                                        INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                        --inner join CDN.Rezerwacje on Rez_GIDNumer = PLK_ObiNumer and Rez_GIDTyp = PLK_ObiTyp
                                                                        WHERE DOZ_ZRDNumer = GIDLp
                                                                                AND DOZ_ZRDTyp = GIDTyp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                                AND PLK_ObiTyp = 2592
                                                                        ), 0)
                                        ELSE ISNULL((
                                                                SELECT SUM(PLK_Ilosc)
                                                                FROM CDN.ProdZlecElem
                                                                INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                WHERE PZE_Id = GIDLp
                                                                        AND PZE_TwrNumer = MPS.TwrNumer
                                                                        AND PLK_ObiTyp = 2592
                                                                ), 0)
                                        END Zaplanowana, ISNULL(ZasobyMPS.IloscZasobPZA, 0) - ISNULL(ZasobyMPS.IloscPwPZA, 0) Wtoku, ISNULL(ZasobyMPS.IloscPwPZA, 0) Zrealizowana,
                                --Termin na ZP
                                CASE
                                        WHEN GIDTyp = 960
                                                THEN ISNULL((
                                                                        SELECT MAX(Rez_DataRealizacji)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.ZamZamLinki ON ZZL_ZZGidNumer = PZE_Id
                                                                                AND ZZL_ZZGidTyp = 14343
                                                                        INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                        INNER JOIN CDN.Rezerwacje ON Rez_GIDNumer = PLK_ObiNumer
                                                                                AND Rez_GIDTyp = PLK_ObiTyp
                                                                        WHERE ZZL_ZSGidNumer = GIDNumer
                                                                                AND ZZL_ZSGidTyp = GIDTyp
                                                                                AND ZZL_ZSGidLp = GIDLp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                                AND PLK_ObiTyp = 2592
                                                                        ), 0)
                                        WHEN GIDTyp = 14347
                                                THEN ISNULL((
                                                                        SELECT MAX(Rez_DataRealizacji)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.DokZwiazane ON DOZ_DOKNumer = PZE_Id
                                                                                AND DOZ_DOKTyp = 14343
                                                                        INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                        INNER JOIN CDN.Rezerwacje ON Rez_GIDNumer = PLK_ObiNumer
                                                                                AND Rez_GIDTyp = PLK_ObiTyp
                                                                        WHERE DOZ_ZRDNumer = GIDLp
                                                                                AND DOZ_ZRDTyp = GIDTyp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                                AND PLK_ObiTyp = 2592
                                                                        ), 0)
                                        ELSE ISNULL((
                                                                SELECT MAX(Rez_DataRealizacji)
                                                                FROM CDN.ProdZlecElem
                                                                INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                INNER JOIN CDN.Rezerwacje ON Rez_GIDNumer = PLK_ObiNumer
                                                                        AND Rez_GIDTyp = PLK_ObiTyp
                                                                WHERE PZE_Id = GIDLp
                                                                        AND PZE_TwrNumer = MPS.TwrNumer
                                                                        AND PLK_ObiTyp = 2592
                                                                ), 0)
                                        END TerminNaZp, ISNULL(PTE_Id, 0) TechnologiaId, ISNULL((
                                                SELECT CASE WHEN CDN.CzyKlasaAtrOkresowa(PTZ_IloscMinAtr) = 1 THEN PTZ_IloscMin
													ELSE CDN.ProdIloscAtr(1,PTZ_IloscMin,PTZ_IloscMinAtr,4,PTZ_TypZasobu,PTC_Ilosc,PTC_IloscAtr,14340,PTC_Technologia,0,0) END
                                                FROM CDN.ProdTechnologiaZasoby
												JOIN CDN.ProdTechnologiaCzynnosci ON PTC_Id = PTZ_TechnologiaCzynnosc
                                                WHERE PTZ_Id = (
                                                                SELECT MIN(PTZ_Id)
                                                                FROM CDN.ProdTechnologiaCzynnosci
                                                                INNER JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
                                                                        AND PTZ_TwrNumer = MPS.TwrNumer
                                                                        AND PTZ_TwrTyp = 16
                                                                        AND PTZ_TypZasobu = 0
                                                                WHERE PTC_Technologia = MPS.TechnologiaId
                                                                )
                                                ), 0)
                                IloscMinPTZ, ISNULL((
                                                SELECT CASE WHEN CDN.CzyKlasaAtrOkresowa(PTZ_IloscAtr) = 1 THEN PTZ_Ilosc
													ELSE CDN.ProdIloscAtr(1,PTZ_Ilosc,PTZ_IloscAtr,4,PTZ_TypZasobu,PTC_Ilosc,PTC_IloscAtr,14340,PTC_Technologia,0,0) END
                                                FROM CDN.ProdTechnologiaZasoby
												JOIN CDN.ProdTechnologiaCzynnosci ON PTC_Id = PTZ_TechnologiaCzynnosc
                                                WHERE PTZ_Id = (
                                                                SELECT MIN(PTZ_Id)
                                                                FROM CDN.ProdTechnologiaCzynnosci
                                                                INNER JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
                                                                        AND PTZ_TwrNumer = MPS.TwrNumer
                                                                        AND PTZ_TwrTyp = 16
                                                                        AND PTZ_TypZasobu = 0
                                                                WHERE PTC_Technologia = MPS.TechnologiaId
                                                                )
                                                ), 0) IloscProduktPTZ, PriorytetRez, IloscLogWolna, IloscLogZajeta
                        FROM (
                                SELECT DataRealizacji, GIDTyp, GIDNumer, GIDLp, TwrNumer, Id, Ilosc MPS, IloscDst REZ, TechnologiaId, PriorytetRez
                                FROM #tabCDNMPS
                                WHERE MPSTyp &gt; 0 AND DataRealizacji &gt;= @PrzeliczenieOd AND DataRealizacji &lt;= @PrzeliczenieDo
                                        --group by DataRealizacji, GIDTyp, GIDNumer, TwrNumer, Id
                                ) MPS
                        OUTER APPLY CDN.ProdPlanyZasobyMPS(GIDNumer, GIDTyp, GIDLp, MPS.TwrNumer, MPS.DataRealizacji) ZasobyMPS
                        LEFT JOIN #tabCDNStanSprzedaz StanS ON StanS.DataRealizacji = MPS.DataRealizacji
                                AND StanS.TwrNumer = MPS.TwrNumer
                        LEFT JOIN CDN.ProdTechnologia ON PTE_Id = TechnologiaId
						LEFT JOIN #JednostkiLogistyczneWgTowaruProd jg ON jg.Twr_GidNumer = MPS.TwrNumer
                        ) MPSKoncowe
                        join cdn.TwrKarty on MPSKoncowe.TwrNumer=Twr_GIDNumer
        END
        ELSE IF @PrzeliczenieRodzaj = @PrzeliczenieWgTerminu
        BEGIN --wybrane wg termninu, tutaj termin brany jest z elemntow MPS
                INSERT INTO #tabProdPlanyProdukty (PPP_PPLId, PPP_Termin, PPP_TerminDo, PPP_DokZrdTyp, PPP_DokZrdNumer, PPP_DokZrdLp, PPP_TwrNumer, PPP_IloscMPS, PPP_IloscRez, PPP_IloscDoWykorzystania, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, PPP_IloscNaZp, PPP_IloscZaplanowana, PPP_IloscWToku, PPP_IloscZrealizowana, PPP_TerminNaZP, PPP_TechnologiaId, PPP_IloscDoProdukcji, PPP_IloscMinProdukcji, PPP_IloscProduktPTZ, PPP_IloscBrakNaMPS, PriorytetRez, PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, PPP_OkresMRPOd, PPP_OkresMRPDo, IloscLogistycznaWolna, IloscLogistycznaZajeta)
                SELECT PlanProdId, MPSKoncowe.DataRealizacji, 0 TerminDo, GIDTyp, GIDNumer, GIDLp, MPSKoncowe.TwrNumer, MPS, REZ, CASE
                                WHEN DoWykorzystania &lt; 0
                                        THEN 0
                                WHEN DoWykorzystania &gt; MPS
                                        THEN MPS
                                ELSE DoWykorzystania
                                END, CASE
                                WHEN OgolnieDostepna &lt; 0
                                        THEN 0
                                ELSE OgolnieDostepna
                                END, WDrodze, NaZP, Zaplanowana, CASE
                                WHEN Wtoku &lt; 0
                                        THEN 0
                                ELSE Wtoku
                                END, Zrealizowana, 0, TechnologiaId, CASE
                                WHEN MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                ) &lt;= 0
                                        THEN 0
                                ELSE MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                )
                                END IloscDoProdukcji, IloscMinPTZ, IloscProduktPTZ, CASE
                                WHEN MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                ) &lt;= 0
                                        THEN 0
                                ELSE MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                )
                                END IloscBrakNaMPS, PriorytetRez,
                                                   CASE (@CzyNormatywyZMagazynu)
                                                   WHEN 1 THEN COALESCE((SELECT Tpm_IloscMin FROM cdn.TwrParMag WHERE Twr_GIDNumer=Tpm_TwrNumer AND Tpm_MagNumer=(SELECT MagNumer FROM #tabMagaynyPP WHERE MagDlaElem = @MagNaNag) ),Twr_IloscMin)
                                                   ELSE Twr_IloscMin
                                                   END  ZapasBezpieczenstwa,
                                                   Twr_MrpEoq EOQ,
                                                    CASE (@CzyNormatywyZMagazynu)
                                                   WHEN 1 THEN COALESCE((SELECT Tpm_IloscZam FROM cdn.TwrParMag WHERE Twr_GIDNumer=Tpm_TwrNumer AND Tpm_MagNumer=(SELECT MagNumer FROM #tabMagaynyPP WHERE MagDlaElem = @MagNaNag) ),Twr_IloscZam)
                                                   ELSE Twr_IloscZam
                                                   END Wielokrotnosc,
                                                    CASE
                                                                                                   WHEN Twr_MrpZaok =0 THEN 0
                                                                                                   WHEN Twr_MrpZaok %1000000=0 THEN 1000000
                                                                                                   WHEN Twr_MrpZaok %100000=0 THEN 100000
                                                                                                   WHEN Twr_MrpZaok %10000=0 THEN 10000
                                                                                                   WHEN Twr_MrpZaok %1000=0 THEN 1000
                                                                                                   WHEN Twr_MrpZaok %100=0 THEN 100
                                                                                                   WHEN Twr_MrpZaok %10=0 THEN 10
                                                                                                   WHEN Twr_MrpZaok %1=0 THEN 1
                                                                                                   WHEN Twr_MrpZaok %0.1=0 THEN 0.1
                                                                                                   WHEN Twr_MrpZaok %0.01=0 THEN 0.01
                                                                                                   WHEN Twr_MrpZaok %0.001=0 THEN 0.001
                                                                                                   WHEN Twr_MrpZaok %0.0001=0 THEN 0.0001
                                                                                                   END  Zaokraglanie,
                                                   0 OkresMRPOd, 0 OkresMRPDo, IloscLogWolna, IloscLogZajeta
                FROM (
                        SELECT @PlanProdId PlanProdId, MPS.DataRealizacji, MPS.GIDTyp, MPS.GIDNumer, MPS.GIDLp, MPS.TwrNumer, MPS, REZ, CASE
                                        WHEN GIDTyp = 14343
                                                THEN 0
                                        ELSE (
                                                        SELECT ISNULL(SUM(CASE
                                                                                        WHEN Rodzaj &lt;= @RodzajZWZak
                                                                                                THEN Ilosc
                                                                                        WHEN RezGIDTyp = 2576
                                                                                                THEN - Ilosc
                                                                                        END), 0)
                                                        FROM #tabCDNMPS MPSPom
                                                        WHERE (MPSPom.Id &lt; MPS.Id OR MPSPom.DataRealizacji = 93890) --rezerwacje online
                                                                AND MPSPom.Rodzaj != @RodzajZP
                                                                AND (
                                                                        (
                                                                                MPSPom.DataRealizacji &gt; @PrzeliczenieData
                                                                                AND Rodzaj &lt;= @RodzajZWZak
                                                                                )
                                                                        OR Rodzaj &gt; @RodzajZWZak
                                                                        )
                                                                AND MPS.TwrNumer = MPSPom.TwrNumer
                                                                AND (
                                                                        MPS.GIDTyp != 14343
                                                                        OR (
                                                                                MPS.GIDNumer != MPSPom.GIDNumer
                                                                                AND MPS.GIDLp != MPSPom.GIDLp
                                                                                )
                                                                        )
																AND ((MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo) OR MPSPom.DataRealizacji = 93890) --rezerwacje online
                                                        ) - (
                                                        SELECT MPSPom.IloscDst
                                                        FROM #tabCDNMPS MPSPom
                                                        WHERE MPSPom.Id = MPS.Id
                                                        ) + StanS.Ilosc - CASE @UwzgJedLogWProduktach WHEN 1 THEN ISNULL(IloscLogZajeta, 0) ELSE 0 END
                                        END DoWykorzystania, (
                                        SELECT ISNULL(SUM(CASE
                                                                        WHEN Rodzaj &lt;= @RodzajZWZak
                                                                                THEN Ilosc
                                                                        WHEN RezGIDTyp = 2576
                                                                                THEN - Ilosc
                                                                        END), 0)
                                        FROM #tabCDNMPS MPSPom
                                        WHERE (MPSPom.DataRealizacji &lt;=  MPS.DataRealizacji OR MPSPom.DataRealizacji = 93890) --rezerwacje online
                                                AND MPSPom.Rodzaj != @RodzajZP
                                                AND (
                                                        (
                                                                MPSPom.DataRealizacji &gt; @PrzeliczenieData
                                                                AND Rodzaj &lt;= @RodzajZWZak
                                                                )
                                                        OR Rodzaj &gt; @RodzajZWZak
                                                        )
                                                AND MPS.TwrNumer = MPSPom.TwrNumer
                                                AND (
                                                        MPS.GIDTyp != 14343
                                                        OR (
                                                                MPS.GIDNumer != MPSPom.GIDNumer
                                                                AND MPS.GIDLp != MPSPom.GIDLp
                                                                )
                                                        )
												AND ((MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo) OR MPSPom.DataRealizacji = 93890) --rezerwacje online
                                        ) + (
                                        SELECT ISNULL(SUM(MPSPom.Ilosc - MPSPom.IloscDst), 0)
                                        FROM #tabCDNMPS MPSPom
                                        WHERE MPSPom.MPSTyp &gt; 0
                                                AND MPSPom.RezGIDTyp = 2576
                                                AND MPSPom.DataRealizacji = MPS.DataRealizacji
                                                AND MPSPom.Rodzaj != @RodzajZP
                                                AND MPS.TwrNumer = MPSPom.TwrNumer
                                                AND (
                                                        MPS.GIDTyp != 14343
                                                        OR (
                                                                MPS.GIDNumer != MPSPom.GIDNumer
                                                                AND MPS.GIDLp != MPSPom.GIDLp
                                                                )
                                                        )
                                        ) + ISNULL(StanS.Ilosc, 0) - CASE @UwzgJedLogWProduktach WHEN 1 THEN ISNULL(IloscLogZajeta, 0) ELSE 0 END OgolnieDostepna, (
                                        SELECT ISNULL(SUM(Ilosc), 0)
                                        FROM #tabCDNMPS MPSPom
                                        WHERE (
                                                        (
                                                                MPSPom.DataRealizacji &gt; MPS.DataRealizacji
                                                                OR MPSPom.DataRealizacji &lt;= @PrzeliczenieData
                                                                )
                                                        AND Rodzaj = @RodzajZak
                                                        )
                                                AND MPS.TwrNumer = MPSPom.TwrNumer
												AND MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo
                                        ) WDrodze, CASE
                                        WHEN GIDTyp = 960
                                                THEN ISNULL((
                                                                        SELECT SUM(PZE_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.ZamZamLinki ON ZZL_ZZGidNumer = PZE_Id
                                                                                AND ZZL_ZZGidTyp = 14343
                                                                        WHERE ZZL_ZSGidNumer = GIDNumer
                                                                                AND ZZL_ZSGidTyp = GIDTyp
                                                                                AND ZZL_ZSGidLp = GIDLp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                        ), 0)
                                        WHEN GIDTyp = 14347
                                                THEN ISNULL((
                                                                        SELECT SUM(PZE_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.DokZwiazane ON DOZ_DOKNumer = PZE_Id
                                                                                AND DOZ_DOKTyp = 14343
                                                                        WHERE DOZ_ZRDNumer = GIDLp
                                                                                AND DOZ_ZRDTyp = GIDTyp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                        ), 0)
                                        ELSE MPS
                                        END NaZP, CASE
                                        WHEN GIDTyp = 960
                                                THEN ISNULL((
                                                                        SELECT SUM(PLK_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.ZamZamLinki ON ZZL_ZZGidNumer = PZE_Id
                                                                                AND ZZL_ZZGidTyp = 14343
                                                                        INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                        -- inner join CDN.Rezerwacje on Rez_GIDNumer = PLK_ObiNumer and Rez_GIDTyp = PLK_ObiTyp
                                                                        WHERE ZZL_ZSGidNumer = GIDNumer
                                                                                AND ZZL_ZSGidLp = GIDLp
                                                                                AND ZZL_ZSGidTyp = GIDTyp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                                AND PLK_ObiTyp = 2592
                                                                        ), 0)
                                        WHEN GIDTyp = 14347
                                                THEN ISNULL((
                                                                        SELECT SUM(PLK_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.DokZwiazane ON DOZ_DOKNumer = PZE_Id
                                                                                AND DOZ_DOKTyp = 14343
                                                                        INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                        --inner join CDN.Rezerwacje on Rez_GIDNumer = PLK_ObiNumer and Rez_GIDTyp = PLK_ObiTyp
                                                                        WHERE DOZ_ZRDNumer = GIDLp
                                                                                AND DOZ_ZRDTyp = GIDTyp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                                AND PLK_ObiTyp = 2592
                                                                        ), 0)
                                        ELSE ISNULL((
                                                                SELECT SUM(PLK_Ilosc)
                                                                FROM CDN.ProdZlecElem
                                                                INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                WHERE PZE_Id = GIDLp
                                                                        AND PZE_TwrNumer = MPS.TwrNumer
                                                                        AND PLK_ObiTyp = 2592
                                                                ), 0)
                                        END Zaplanowana, ISNULL(ZasobyMPS.IloscZasobPZA, 0) - ISNULL(ZasobyMPS.IloscPwPZA, 0) Wtoku, ISNULL(ZasobyMPS.IloscPwPZA, 0) Zrealizowana, ISNULL(PTE_Id, 0) TechnologiaId, ISNULL((
                                                SELECT CASE WHEN CDN.CzyKlasaAtrOkresowa(PTZ_IloscMinAtr) = 1 THEN PTZ_IloscMin
													ELSE CDN.ProdIloscAtr(1,PTZ_IloscMin,PTZ_IloscMinAtr,4,PTZ_TypZasobu,PTC_Ilosc,PTC_IloscAtr,14340,PTC_Technologia,0,0) END
                                                FROM CDN.ProdTechnologiaZasoby
												JOIN CDN.ProdTechnologiaCzynnosci ON PTC_Id = PTZ_TechnologiaCzynnosc
                                                WHERE PTZ_Id = (
                                                                SELECT MIN(PTZ_Id)
                                                                FROM CDN.ProdTechnologiaCzynnosci
                                                                INNER JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
                                                                        AND PTZ_TwrNumer = MPS.TwrNumer
                                                                        AND PTZ_TwrTyp = 16
                                                                        AND PTZ_TypZasobu = 0
                                                                WHERE PTC_Technologia = MPS.TechnologiaId
                                                                )
                                                ), 0)
                                IloscMinPTZ, ISNULL((
                                                SELECT CASE WHEN CDN.CzyKlasaAtrOkresowa(PTZ_IloscAtr) = 1 THEN PTZ_Ilosc
													ELSE CDN.ProdIloscAtr(1,PTZ_Ilosc,PTZ_IloscAtr,4,PTZ_TypZasobu,PTC_Ilosc,PTC_IloscAtr,14340,PTC_Technologia,0,0) END
                                                FROM CDN.ProdTechnologiaZasoby
												JOIN CDN.ProdTechnologiaCzynnosci ON PTC_Id = PTZ_TechnologiaCzynnosc
                                                WHERE PTZ_Id = (
                                                                SELECT MIN(PTZ_Id)
                                                                FROM CDN.ProdTechnologiaCzynnosci
                                                                INNER JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
                                                                        AND PTZ_TwrNumer = MPS.TwrNumer
                                                                        AND PTZ_TwrTyp = 16
                                                                        AND PTZ_TypZasobu = 0
                                                                WHERE PTC_Technologia = MPS.TechnologiaId
                                                                )
                                                ), 0) IloscProduktPTZ, PriorytetRez, IloscLogWolna, IloscLogZajeta
                        FROM (
                                SELECT DataRealizacji, GIDTyp, GIDNumer, GIDLp, TwrNumer, Id, Ilosc MPS, IloscDst REZ, TechnologiaId, PriorytetRez
                                FROM #tabCDNMPS
                                WHERE MPSTyp &gt; 0 AND DataRealizacji &gt;= @PrzeliczenieOd AND DataRealizacji &lt;= @PrzeliczenieDo
                                        --group by DataRealizacji, GIDTyp, GIDNumer, TwrNumer, Id
                                ) MPS
                        OUTER APPLY CDN.ProdPlanyZasobyMPS(GIDNumer, GIDTyp, GIDLp, MPS.TwrNumer, MPS.DataRealizacji) ZasobyMPS
                        LEFT JOIN #tabCDNStanSprzedaz StanS ON StanS.DataRealizacji = MPS.DataRealizacji
                                AND StanS.TwrNumer = MPS.TwrNumer
                        LEFT JOIN CDN.ProdTechnologia ON PTE_Id = TechnologiaId
						LEFT JOIN #JednostkiLogistyczneWgTowaruProd jg ON jg.Twr_GidNumer = MPS.TwrNumer
                        ) MPSKoncowe
                        join cdn.TwrKarty on MPSKoncowe.TwrNumer=Twr_GIDNumer
        END
        ELSE
        BEGIN -- Przeliczenie wg Okresu MRP
                INSERT INTO #tabProdPlanyProdukty (PPP_PPLId, PPP_Termin, PPP_TerminDo, PPP_DokZrdTyp, PPP_DokZrdNumer, PPP_DokZrdLp, PPP_TwrNumer, PPP_IloscMPS, PPP_IloscRez, PPP_IloscDoWykorzystania, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, PPP_IloscNaZp, PPP_IloscZaplanowana, PPP_IloscWToku, PPP_IloscZrealizowana, PPP_TerminNaZP, PPP_TechnologiaId, PPP_IloscDoProdukcji, PPP_IloscMinProdukcji, PPP_IloscProduktPTZ, PPP_IloscBrakNaMPS, PriorytetRez, PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, PPP_OkresMRPOd, PPP_OkresMRPDo, IloscLogistycznaWolna, IloscLogistycznaZajeta)
                SELECT PlanProdId, MPSKoncowe.DataRealizacji, 0 TerminDo, GIDTyp, GIDNumer, GIDLp, MPSKoncowe.TwrNumer, MPS, REZ, CASE
                                WHEN DoWykorzystania &lt; 0
                                        THEN 0
                                WHEN DoWykorzystania &gt; MPS
                                        THEN MPS
                                ELSE DoWykorzystania
                                END, CASE
                                WHEN OgolnieDostepna &lt; 0
                                        THEN 0
                                ELSE OgolnieDostepna
                                END, WDrodze, NaZP, Zaplanowana, CASE
                                WHEN Wtoku &lt; 0
                                        THEN 0
                                ELSE Wtoku
                                END, Zrealizowana, 0, TechnologiaId, CASE
                                WHEN MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                ) &lt;= 0
                                        THEN 0
                                ELSE MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                )
                                END IloscDoProdukcji, IloscMinPTZ, IloscProduktPTZ, CASE
                                WHEN MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                ) &lt;= 0
                                        THEN 0
                                ELSE MPS - REZ - NaZP - (
                                                CASE
                                                        WHEN DoWykorzystania &lt; 0
                                                                THEN 0
                                                        WHEN DoWykorzystania &gt; MPS
                                                                THEN MPS
                                                        ELSE DoWykorzystania
                                                        END
                                                )
                                END IloscBrakNaMPS, PriorytetRez,
                                                    CASE (@CzyNormatywyZMagazynu)
                                                   WHEN 1 THEN COALESCE((SELECT Tpm_IloscMin FROM cdn.TwrParMag WHERE Twr_GIDNumer=Tpm_TwrNumer AND Tpm_MagNumer=(SELECT MagNumer FROM #tabMagaynyPP WHERE MagDlaElem = @MagNaNag) ),Twr_IloscMin)
                                                   ELSE Twr_IloscMin
                                                   END  ZapasBezpieczenstwa,
                                                    Twr_MrpEoq EOQ,
                                                     CASE (@CzyNormatywyZMagazynu)
                                                   WHEN 1 THEN COALESCE((SELECT Tpm_IloscZam FROM cdn.TwrParMag WHERE Twr_GIDNumer=Tpm_TwrNumer AND Tpm_MagNumer=(SELECT MagNumer FROM #tabMagaynyPP WHERE MagDlaElem = @MagNaNag) ),Twr_IloscZam)
                                                   ELSE Twr_IloscZam
                                                   END Wielokrotnosc,
                                                                                                     CASE
                                                                                                   WHEN Twr_MrpZaok =0 THEN 0
                                                                                                   WHEN Twr_MrpZaok %1000000=0 THEN 1000000
                                                                                                   WHEN Twr_MrpZaok %100000=0 THEN 100000
                                                                                                   WHEN Twr_MrpZaok %10000=0 THEN 10000
                                                                                                   WHEN Twr_MrpZaok %1000=0 THEN 1000
                                                                                                   WHEN Twr_MrpZaok %100=0 THEN 100
                                                                                                   WHEN Twr_MrpZaok %10=0 THEN 10
                                                                                                   WHEN Twr_MrpZaok %1=0 THEN 1
                                                                                                   WHEN Twr_MrpZaok %0.1=0 THEN 0.1
                                                                                                   WHEN Twr_MrpZaok %0.01=0 THEN 0.01
                                                                                                   WHEN Twr_MrpZaok %0.001=0 THEN 0.001
                                                                                                   WHEN Twr_MrpZaok %0.0001=0 THEN 0.0001
                                                                                                   END  Zaokraglanie,
                                CASE POK_CzasTrwaniaOkresuJedn
                            WHEN 0 THEN /*dni*/ POK_DataOd+(MPSKoncowe.DataRealizacji-POK_DataOd)/POK_CzasTrwaniaOkresu*POK_CzasTrwaniaOkresu
                            WHEN 1 THEN /*tygodnie*/ POK_DataOd+(MPSKoncowe.DataRealizacji-POK_DataOd)/POK_CzasTrwaniaOkresu/7*7*POK_CzasTrwaniaOkresu
                            WHEN 2 THEN /*miesiace*/
                                            (DATEDIFF(d,convert(datetime,'1800-12-29',120),
                                                  DATEADD(m, DATEDIFF(m, 0, dateadd(m,
                                                        ( (
                                                         datepart(YEAR,dateadd(d,MPSKoncowe.DataRealizacji,convert(datetime,'1800-12-29',120)))*12
                                                         +datepart(MONTH,dateadd(d,MPSKoncowe.DataRealizacji,convert(datetime,'1800-12-29',120)))
                                                         -datepart(YEAR,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))*12
                                                         -datepart(MONTH,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))
                                                         )
                                                /POK_CzasTrwaniaOkresu
                                                +CASE
                                                  WHEN datepart(DAY,dateadd(d,MPSKoncowe.DataRealizacji,convert(datetime,'1800-12-29',120)))-datepart(DAY,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))&lt;0
                                                         AND (
                                                         datepart(YEAR,dateadd(d,MPSKoncowe.DataRealizacji,convert(datetime,'1800-12-29',120)))*12
                                                         +datepart(MONTH,dateadd(d,MPSKoncowe.DataRealizacji,convert(datetime,'1800-12-29',120)))
                                                         -datepart(YEAR,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))*12
                                                         -datepart(MONTH,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))
                                                         )%POK_CzasTrwaniaOkresu=0 /*miesiac zmiany */  THEN -1
                                                  else 0
                                                end
                                                )*POK_CzasTrwaniaOkresu,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120))) ), 0)  ))+1
                            WHEN 3 THEN /*lata - nieuzywane dla mrp*/ 0
                        END OkresMRPOd,
                                CASE POK_CzasTrwaniaOkresuJedn
                            WHEN 0 THEN /*dni*/ POK_DataOd+((MPSKoncowe.DataRealizacji-POK_DataOd)/POK_CzasTrwaniaOkresu+1)*POK_CzasTrwaniaOkresu-1
                            WHEN 1 THEN /*tygodnie*/ POK_DataOd+((MPSKoncowe.DataRealizacji-POK_DataOd)/POK_CzasTrwaniaOkresu/7+1)*7*POK_CzasTrwaniaOkresu-1
                            WHEN 2 THEN /*miesiace*/ (DATEDIFF(d,convert(datetime,'1800-12-29',120),
                                                   DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0, dateadd(m,
                                                        ( (
                                                         datepart(YEAR,dateadd(d,MPSKoncowe.DataRealizacji,convert(datetime,'1800-12-29',120)))*12
                                                         +datepart(MONTH,dateadd(d,MPSKoncowe.DataRealizacji,convert(datetime,'1800-12-29',120)))
                                                         -datepart(YEAR,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))*12
                                                         -datepart(MONTH,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))
                                                         )
                                                /POK_CzasTrwaniaOkresu
                                                +CASE
                                                   WHEN datepart(DAY,dateadd(d,MPSKoncowe.DataRealizacji,convert(datetime,'1800-12-29',120)))-datepart(DAY,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))&lt;0
                                                         AND (
                                                         datepart(YEAR,dateadd(d,MPSKoncowe.DataRealizacji,convert(datetime,'1800-12-29',120)))*12
                                                         +datepart(MONTH,dateadd(d,MPSKoncowe.DataRealizacji,convert(datetime,'1800-12-29',120)))
                                                         -datepart(YEAR,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))*12
                                                         -datepart(MONTH,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120)))
                                                         )%POK_CzasTrwaniaOkresu=0 /*miesiac zmiany */  THEN 0
                                                  else 1
                                                end
                                                )*POK_CzasTrwaniaOkresu,dateadd(d,POK_DataOd,convert(datetime,'1800-12-29',120))) ),0))  ))+1
                            WHEN 3 THEN /*lata - nieuzywane dla mrp*/ 0
                        END  OkresMRPDo, IloscLogWolna, IloscLogZajeta
                FROM (
                        SELECT @PlanProdId PlanProdId, MPS.DataRealizacji, MPS.GIDTyp, MPS.GIDNumer, MPS.GIDLp, MPS.TwrNumer, MPS, REZ, CASE
                                        WHEN GIDTyp = 14343
                                                THEN 0
                                        ELSE (
                                                        SELECT ISNULL(SUM(CASE
                                                                                        WHEN Rodzaj &lt;= @RodzajZWZak
                                                                                                THEN Ilosc
                                                                                        WHEN RezGIDTyp = 2576
                                                                                                THEN - Ilosc
                                                                                        END), 0)
                                                        FROM #tabCDNMPS MPSPom
                                                        WHERE (MPSPom.Id &lt; MPS.Id OR MPSPom.DataRealizacji = 93890) --rezerwacje online
                                                                AND MPSPom.Rodzaj != @RodzajZP
                                                                AND (
                                                                        (
                                                                                MPSPom.DataRealizacji &gt; @PrzeliczenieData
                                                                                AND Rodzaj &lt;= @RodzajZWZak
                                                                                )
                                                                        OR Rodzaj &gt; @RodzajZWZak
                                                                        )
                                                                AND MPS.TwrNumer = MPSPom.TwrNumer
                                                                AND (
                                                                        MPS.GIDTyp != 14343
                                                                        OR (
                                                                                MPS.GIDNumer != MPSPom.GIDNumer
                                                                                AND MPS.GIDLp != MPSPom.GIDLp
                                                                                )
                                                                        )
																AND ((MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo) OR MPSPom.DataRealizacji = 93890) --rezerwacje online
                                                        ) - (
                                                        SELECT MPSPom.IloscDst
                                                        FROM #tabCDNMPS MPSPom
                                                        WHERE MPSPom.Id = MPS.Id
                                                        ) + StanS.Ilosc - CASE @UwzgJedLogWProduktach WHEN 1 THEN ISNULL(IloscLogZajeta, 0) ELSE 0 END
                                        END DoWykorzystania, (
                                        SELECT ISNULL(SUM(CASE
                                                                        WHEN Rodzaj &lt;= @RodzajZWZak
                                                                                THEN Ilosc
                                                                        WHEN RezGIDTyp = 2576
                                                                                THEN - Ilosc
                                                                        END), 0)
                                        FROM #tabCDNMPS MPSPom
                                        WHERE (MPSPom.DataRealizacji &lt;= MPS.DataRealizacji OR MPSPom.DataRealizacji = 93890) --rezerwacje online
                                                AND MPSPom.Rodzaj != @RodzajZP
                                                AND (
                                                        (
                                                                MPSPom.DataRealizacji &gt; @PrzeliczenieData
                                                                AND Rodzaj &lt;= @RodzajZWZak
                                                                )
                                                        OR Rodzaj &gt; @RodzajZWZak
                                                        )
                                                AND MPS.TwrNumer = MPSPom.TwrNumer
                                                AND (
                                                        MPS.GIDTyp != 14343
                                                        OR (
                                                                MPS.GIDNumer != MPSPom.GIDNumer
                                                                AND MPS.GIDLp != MPSPom.GIDLp
                                                                )
                                                        )
												AND ((MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo) OR MPSPom.DataRealizacji = 93890) --rezerwacje online
                                        ) + (
                                        SELECT ISNULL(SUM(MPSPom.Ilosc - MPSPom.IloscDst), 0)
                                        FROM #tabCDNMPS MPSPom
                                        WHERE MPSPom.MPSTyp &gt; 0
                                                AND MPSPom.RezGIDTyp = 2576
                                                AND MPSPom.DataRealizacji = MPS.DataRealizacji
                                                AND MPSPom.Rodzaj != @RodzajZP
                                                AND MPS.TwrNumer = MPSPom.TwrNumer
                                                AND (
                                                        MPS.GIDTyp != 14343
                                                        OR (
                                                                MPS.GIDNumer != MPSPom.GIDNumer
                                                                AND MPS.GIDLp != MPSPom.GIDLp
                                                                )
                                                        )
                                        ) + ISNULL(StanS.Ilosc, 0) - CASE @UwzgJedLogWProduktach WHEN 1 THEN ISNULL(IloscLogZajeta, 0) ELSE 0 END OgolnieDostepna, (
                                        SELECT ISNULL(SUM(Ilosc), 0)
                                        FROM #tabCDNMPS MPSPom
                                        WHERE (
                                                        (
                                                                MPSPom.DataRealizacji &gt; MPS.DataRealizacji
                                                                OR MPSPom.DataRealizacji &lt;= @PrzeliczenieData
                                                                )
                                                        AND Rodzaj = @RodzajZak
                                                        )
                                                AND MPS.TwrNumer = MPSPom.TwrNumer
												AND MPSPom.DataRealizacji &gt;= @ZakresRezerwacjiOd AND MPSPom.DataRealizacji &lt;= @ZakresRezerwacjiDo
                                        ) WDrodze, CASE
                                        WHEN GIDTyp = 960
                                                THEN ISNULL((
                                                                        SELECT SUM(PZE_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.ZamZamLinki ON ZZL_ZZGidNumer = PZE_Id
                                                                                AND ZZL_ZZGidTyp = 14343
                                                                        WHERE ZZL_ZSGidNumer = GIDNumer
                                                                                AND ZZL_ZSGidTyp = GIDTyp
                                                                                AND ZZL_ZSGidLp = GIDLp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                        ), 0)
                                        WHEN GIDTyp = 14347
                                                THEN ISNULL((
                                                                        SELECT SUM(PZE_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.DokZwiazane ON DOZ_DOKNumer = PZE_Id
                                                                                AND DOZ_DOKTyp = 14343
                                                                        WHERE DOZ_ZRDNumer = GIDLp
                                                                                AND DOZ_ZRDTyp = GIDTyp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                        ), 0)
                                        ELSE MPS
                                        END NaZP, CASE
                                        WHEN GIDTyp = 960
                                                THEN ISNULL((
                                                                        SELECT SUM(PLK_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.ZamZamLinki ON ZZL_ZZGidNumer = PZE_Id
                                                                                AND ZZL_ZZGidTyp = 14343
                                                                        INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                        -- inner join CDN.Rezerwacje on Rez_GIDNumer = PLK_ObiNumer and Rez_GIDTyp = PLK_ObiTyp
                                                                        WHERE ZZL_ZSGidNumer = GIDNumer
                                                                                AND ZZL_ZSGidLp = GIDLp
                                                                                AND ZZL_ZSGidTyp = GIDTyp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                                AND PLK_ObiTyp = 2592
                                                                        ), 0)
                                        WHEN GIDTyp = 14347
                                                THEN ISNULL((
                                                                        SELECT SUM(PLK_Ilosc)
                                                                        FROM CDN.ProdZlecElem
                                                                        INNER JOIN CDN.DokZwiazane ON DOZ_DOKNumer = PZE_Id
                                                                                AND DOZ_DOKTyp = 14343
                                                                        INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                        --inner join CDN.Rezerwacje on Rez_GIDNumer = PLK_ObiNumer and Rez_GIDTyp = PLK_ObiTyp
                                                                        WHERE DOZ_ZRDNumer = GIDLp
                                                                                AND DOZ_ZRDTyp = GIDTyp
                                                                                AND PZE_TwrNumer = MPS.TwrNumer
                                                                                AND PLK_ObiTyp = 2592
                                                                        ), 0)
                                        ELSE ISNULL((
                                                                SELECT SUM(PLK_Ilosc)
                                                                FROM CDN.ProdZlecElem
                                                                INNER JOIN CDN.ProdLinki ON PLK_PZEId = PZE_Id
                                                                WHERE PZE_Id = GIDLp
                                                                        AND PZE_TwrNumer = MPS.TwrNumer
                                                                        AND PLK_ObiTyp = 2592
                                                                ), 0)
                                        END Zaplanowana, ISNULL(ZasobyMPS.IloscZasobPZA, 0) - ISNULL(ZasobyMPS.IloscPwPZA, 0) Wtoku, ISNULL(ZasobyMPS.IloscPwPZA, 0) Zrealizowana, ISNULL(PTE_Id, 0) TechnologiaId, ISNULL((
                                                SELECT CASE WHEN CDN.CzyKlasaAtrOkresowa(PTZ_IloscMinAtr) = 1 THEN PTZ_IloscMin
													ELSE CDN.ProdIloscAtr(1,PTZ_IloscMin,PTZ_IloscMinAtr,4,PTZ_TypZasobu,PTC_Ilosc,PTC_IloscAtr,14340,PTC_Technologia,0,0) END
                                                FROM CDN.ProdTechnologiaZasoby
												JOIN CDN.ProdTechnologiaCzynnosci ON PTC_Id = PTZ_TechnologiaCzynnosc
                                                WHERE PTZ_Id = (
                                                                SELECT MIN(PTZ_Id)
                                                                FROM CDN.ProdTechnologiaCzynnosci
                                                                INNER JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
                                                                        AND PTZ_TwrNumer = MPS.TwrNumer
                                                                        AND PTZ_TwrTyp = 16
                                                                        AND PTZ_TypZasobu = 0
                                                                WHERE PTC_Technologia = MPS.TechnologiaId
                                                                )
                                                ), 0)
                                IloscMinPTZ, ISNULL((
                                               SELECT CASE WHEN CDN.CzyKlasaAtrOkresowa(PTZ_IloscAtr) = 1 THEN PTZ_Ilosc
													ELSE CDN.ProdIloscAtr(1,PTZ_Ilosc,PTZ_IloscAtr,4,PTZ_TypZasobu,PTC_Ilosc,PTC_IloscAtr,14340,PTC_Technologia,0,0) END
                                                FROM CDN.ProdTechnologiaZasoby
												JOIN CDN.ProdTechnologiaCzynnosci ON PTC_Id = PTZ_TechnologiaCzynnosc
                                                WHERE PTZ_Id = (
                                                                SELECT MIN(PTZ_Id)
                                                                FROM CDN.ProdTechnologiaCzynnosci
                                                                INNER JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
                                                                        AND PTZ_TwrNumer = MPS.TwrNumer
                                                                        AND PTZ_TwrTyp = 16
                                                                        AND PTZ_TypZasobu = 0
                                                                WHERE PTC_Technologia = MPS.TechnologiaId
                                                                )
                                                ), 0) IloscProduktPTZ, PriorytetRez, IloscLogWolna, IloscLogZajeta
                        FROM (
                                SELECT DataRealizacji, GIDTyp, GIDNumer, GIDLp, TwrNumer, Id, Ilosc MPS, IloscDst REZ, TechnologiaId, PriorytetRez
                                FROM #tabCDNMPS
                                WHERE MPSTyp &gt; 0 AND DataRealizacji &gt;= @PrzeliczenieOd AND DataRealizacji &lt;= @PrzeliczenieDo
                                        --group by DataRealizacji, GIDTyp, GIDNumer, TwrNumer, Id
                                ) MPS
                        OUTER APPLY CDN.ProdPlanyZasobyMPS(GIDNumer, GIDTyp, GIDLp, MPS.TwrNumer, MPS.DataRealizacji) ZasobyMPS
                        LEFT JOIN #tabCDNStanSprzedaz StanS ON StanS.DataRealizacji = MPS.DataRealizacji
                                AND StanS.TwrNumer = MPS.TwrNumer
                        LEFT JOIN CDN.ProdTechnologia ON PTE_Id = TechnologiaId
						LEFT JOIN #JednostkiLogistyczneWgTowaruProd jg ON jg.Twr_GidNumer = MPS.TwrNumer
                        ) MPSKoncowe
                        join TwrKarty on MPSKoncowe.TwrNumer=Twr_GIDNumer
                        left join cdn.ProdOkresy on POK_Id=Twr_MrpId
        END

    END
    GOTO PoWyliczenieProduktowPlanu


GrupowanieProduktow:
    BEGIN

        IF @PrzeliczenieRodzaj = @PrzeliczenieWgOkresuMrp
        BEGIN
                --zapis bez grupowania po dokumencie
                INSERT INTO CDN.ProdPlanyProdukty (PPP_PPLId, PPP_Termin, PPP_TerminDo, PPP_DokZrdTyp, PPP_DokZrdNumer, PPP_TwrNumer, PPP_IloscMPS, PPP_IloscRez, PPP_IloscDoWykorzystania, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, PPP_IloscNaZp, PPP_IloscZaplanowana, PPP_IloscWToku, PPP_IloscZrealizowana, PPP_TechnologiaId, PPP_IloscDoProdukcji, PPP_Edytowany, PPP_IloscMinProdukcji, PPP_IloscBrakNaMPS, PPP_DodanyLp, PPP_Lp, PPP_TerminNaZP, PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, PPP_BrakMaterialow, PPP_OkresMRPOd, PPP_OkresMRPDo,PPP_TerminProdukcji, PPP_IloscLogWolna, PPP_IloscLogZajeta)
                SELECT PPP_PPLId, MIN(PPP_Termin), MIN(PPP_TerminDo), 0 DokZrdTyp, 0 DokZrdNumer, PPP_TwrNumer, SUM(PPP_IloscMPS), SUM(PPP_IloscRez), SUM(PPP_IloscDoWykorzystania), MAX(PPP_IloscOgolnieDostepna), PPP_IloscWDrodze, SUM(PPP_IloscNaZp), SUM(PPP_IloscZaplanowana), SUM(PPP_IloscWToku), SUM(PPP_IloscZrealizowana), PPP_TechnologiaId, CASE
                                WHEN (
                                                CASE
                                                        WHEN PPP_IloscMinProdukcji = 0
                                                                OR (
                                                                        PPP_IloscProduktPTZ &gt; PPP_IloscMinProdukcji
                                                                        AND SUM(PPP_IloscBrakNaMPS) &gt; 0
                                                                        )
                                                                THEN PPP_IloscMinProdukcji
                                                        ELSE PPP_IloscMinProdukcji * CEILING(SUM(PPP_IloscBrakNaMPS) / PPP_IloscMinProdukcji)
                                                        END
                                                ) &lt; SUM(PPP_IloscDoProdukcji)
                                        THEN SUM(PPP_IloscBrakNaMPS)
                                ELSE SUM(PPP_IloscDoProdukcji)
                                END, 0 PPP_Edytowany, CASE
                                WHEN PPP_IloscMinProdukcji = 0
                                        OR (
                                                PPP_IloscProduktPTZ &gt; PPP_IloscMinProdukcji
                                                AND SUM(PPP_IloscBrakNaMPS) &gt; 0
                                                )
                                        THEN PPP_IloscMinProdukcji
                                ELSE PPP_IloscMinProdukcji * CEILING(SUM(PPP_IloscBrakNaMPS) / PPP_IloscMinProdukcji)
                                END
                        , SUM(PPP_IloscBrakNaMPS), 0 PPP_DodanyLp, ROW_NUMBER() OVER (
                                ORDER BY PPP_PPLId, PPP_TwrNumer, MIN(PPP_Termin), MIN(PPP_TerminDo), PPP_IloscWDrodze, PPP_TechnologiaId
                                ), PPP_TerminNaZP, PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, 0, PPP_OkresMRPOd, PPP_OkresMRPDo, NULL PPP_TerminProdukcji,
								IloscLogistycznaWolna, IloscLogistycznaZajeta
                FROM #tabProdPlanyProdukty
                GROUP BY PPP_PPLId, PPP_TwrNumer, PPP_OkresMRPOd, PPP_OkresMRPDo, PPP_IloscWDrodze, PPP_TechnologiaId, PPP_TerminNaZP, PPP_IloscMinProdukcji, PPP_IloscProduktPTZ, PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, IloscLogistycznaWolna, IloscLogistycznaZajeta

                IF @@ROWCOUNT = 0
                        AND EXISTS (
                                SELECT *
                                FROM #tabCDNMPS
                                WHERE MPSTyp &gt; 1
                                )
                BEGIN
                        ROLLBACK TRAN

                        IF @Komunikat &lt;&gt; 0
                                RAISERROR ('XLPrzeliczPlanProdukcji: Wystąpił błąd podczas przeliczania planu produkcji.Nie powiódł się zapis do tabeli CDN.ProdPlanyProdukty.', 16, 1)

                        SELECT 17 AS ERROR

                        RETURN 17
                END
                --zapis informacji o pozycjach dokumentów skąd pochodzą produkty
                INSERT INTO CDN.ProdPlanyZrdDok (PPZ_PPPId, PPZ_DokNumer, PPZ_DokTyp, PPZ_DokLp, PPZ_Ilosc)
                SELECT PPP.PPP_Id, PPPK.PPP_DokZrdNumer, PPPK.PPP_DokZrdTyp, PPPK.PPP_DokZrdLp, CASE
                                WHEN PPPK.PPP_DokZrdTyp = 14343
                                        THEN CASE
                                                        WHEN PPPK.PPP_IloscMPS - PPPK.PPP_IloscNaZp - PPPK.PPP_IloscDoWykorzystania &lt; 0
                                                                THEN 0
                                                        ELSE PPPK.PPP_IloscMPS - PPPK.PPP_IloscNaZp - PPPK.PPP_IloscDoWykorzystania
                                                        END
                                ELSE CASE
                                                WHEN PPPK.PPP_IloscMPS - PPPK.PPP_IloscRez - PPPK.PPP_IloscDoWykorzystania &lt; 0
                                                        THEN 0
                                                ELSE PPPK.PPP_IloscMPS - PPPK.PPP_IloscRez - PPPK.PPP_IloscDoWykorzystania
                                                END
                                END Ilosc
                FROM #tabProdPlanyProdukty PPPK
                INNER JOIN CDN.ProdPlanyProdukty PPP ON PPP.PPP_TwrNumer = PPPK.PPP_TwrNumer
                        AND PPP.PPP_Termin = PPPK.PPP_Termin
                        AND PPP.PPP_TerminDo = PPPK.PPP_TerminDo
                        AND PPP.PPP_TechnologiaId = PPPK.PPP_TechnologiaId
                        AND PPP.PPP_PPLId = @PlanProdId
                                                --AND PPP.PPP_Edytowany &amp; @EdycjaDodanyRecznie &lt;&gt; 0
        END
        ELSE   IF @PrzeliczenieRodzaj IN(@PrzeliczenieWgOkresu,@PrzeliczenieWgTerminu)
        BEGIN
                --zapis bez grupowania po dokumencie
                INSERT INTO CDN.ProdPlanyProdukty (PPP_PPLId, PPP_Termin, PPP_TerminDo, PPP_DokZrdTyp, PPP_DokZrdNumer, PPP_TwrNumer, PPP_IloscMPS, PPP_IloscRez, PPP_IloscDoWykorzystania, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, PPP_IloscNaZp, PPP_IloscZaplanowana, PPP_IloscWToku, PPP_IloscZrealizowana, PPP_TechnologiaId, PPP_IloscDoProdukcji, PPP_Edytowany, PPP_IloscMinProdukcji, PPP_IloscBrakNaMPS, PPP_DodanyLp, PPP_Lp, PPP_TerminNaZP, PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, PPP_BrakMaterialow, PPP_OkresMRPOd, PPP_OkresMRPDo,PPP_TerminProdukcji, PPP_IloscLogWolna, PPP_IloscLogZajeta)
                SELECT PPP_PPLId, PPP_Termin, PPP_TerminDo, 0 DokZrdTyp, 0 DokZrdNumer, PPP_TwrNumer, SUM(PPP_IloscMPS), SUM(PPP_IloscRez), SUM(PPP_IloscDoWykorzystania), MAX(PPP_IloscOgolnieDostepna), PPP_IloscWDrodze, SUM(PPP_IloscNaZp), SUM(PPP_IloscZaplanowana), SUM(PPP_IloscWToku), SUM(PPP_IloscZrealizowana), PPP_TechnologiaId, CASE
                                WHEN (
                                                CASE
                                                        WHEN PPP_IloscMinProdukcji = 0
                                                                OR (
                                                                        PPP_IloscProduktPTZ &gt; PPP_IloscMinProdukcji
                                                                        AND SUM(PPP_IloscBrakNaMPS) &gt; 0
                                                                        )
                                                                THEN PPP_IloscMinProdukcji
                                                        ELSE PPP_IloscMinProdukcji * CEILING(SUM(PPP_IloscBrakNaMPS) / PPP_IloscMinProdukcji)
                                                        END
                                                ) &lt; SUM(PPP_IloscDoProdukcji)
                                        THEN SUM(PPP_IloscBrakNaMPS)
                                ELSE SUM(PPP_IloscDoProdukcji)
                                END, 0 PPP_Edytowany, CASE
                                WHEN PPP_IloscMinProdukcji = 0
                                        OR (
                                                PPP_IloscProduktPTZ &gt; PPP_IloscMinProdukcji
                                                AND SUM(PPP_IloscBrakNaMPS) &gt; 0
                                                )
                                        THEN PPP_IloscMinProdukcji
                                ELSE PPP_IloscMinProdukcji * CEILING(SUM(PPP_IloscBrakNaMPS) / PPP_IloscMinProdukcji)
                                END
                        , SUM(PPP_IloscBrakNaMPS), 0 PPP_DodanyLp, ROW_NUMBER() OVER (
                                ORDER BY PPP_PPLId, PPP_TwrNumer, PPP_Termin, PPP_TerminDo, PPP_IloscWDrodze, PPP_TechnologiaId
                                ), PPP_TerminNaZP, PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, 0, MIN(PPP_OkresMRPOd), MIN(PPP_OkresMRPDo), NULL PPP_TerminProdukcji,
								IloscLogistycznaWolna, IloscLogistycznaZajeta
                FROM #tabProdPlanyProdukty
                GROUP BY PPP_PPLId, PPP_TwrNumer, PPP_Termin, PPP_TerminDo, PPP_IloscWDrodze, PPP_TechnologiaId, PPP_TerminNaZP, PPP_IloscMinProdukcji, PPP_IloscProduktPTZ, PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, IloscLogistycznaWolna, IloscLogistycznaZajeta

                IF @@ROWCOUNT = 0
                        AND EXISTS (
                                SELECT *
                                FROM #tabCDNMPS
                                WHERE MPSTyp &gt; 1
                                )
                BEGIN
                        ROLLBACK TRAN

                        IF @Komunikat &lt;&gt; 0
                                RAISERROR ('XLPrzeliczPlanProdukcji: Wystąpił błąd podczas przeliczania planu produkcji.Nie powiódł się zapis do tabeli CDN.ProdPlanyProdukty.', 16, 1)

                        SELECT 17 AS ERROR

                        RETURN 17
                END
                --zapis informacji o pozycjach dokumentów skąd pochodzą produkty
                INSERT INTO CDN.ProdPlanyZrdDok (PPZ_PPPId, PPZ_DokNumer, PPZ_DokTyp, PPZ_DokLp, PPZ_Ilosc)
                SELECT PPP.PPP_Id, PPPK.PPP_DokZrdNumer, PPPK.PPP_DokZrdTyp, PPPK.PPP_DokZrdLp, CASE
                                WHEN PPPK.PPP_DokZrdTyp = 14343
                                        THEN CASE
                                                        WHEN PPPK.PPP_IloscMPS - PPPK.PPP_IloscNaZp - PPPK.PPP_IloscDoWykorzystania &lt; 0
                                                                THEN 0
                                                        ELSE PPPK.PPP_IloscMPS - PPPK.PPP_IloscNaZp - PPPK.PPP_IloscDoWykorzystania
                                                        END
                                ELSE CASE
                                                WHEN PPPK.PPP_IloscMPS - PPPK.PPP_IloscRez - PPPK.PPP_IloscDoWykorzystania &lt; 0
                                                        THEN 0
                                                ELSE PPPK.PPP_IloscMPS - PPPK.PPP_IloscRez - PPPK.PPP_IloscDoWykorzystania
                                                END
                                END Ilosc
                FROM #tabProdPlanyProdukty PPPK
                INNER JOIN CDN.ProdPlanyProdukty PPP ON PPP.PPP_TwrNumer = PPPK.PPP_TwrNumer
                        AND PPP.PPP_Termin = PPPK.PPP_Termin
                        AND PPP.PPP_TerminDo = PPPK.PPP_TerminDo
                        AND PPP.PPP_TechnologiaId = PPPK.PPP_TechnologiaId
                        AND PPP.PPP_PPLId = @PlanProdId
                                                --AND PPP.PPP_Edytowany &amp; @EdycjaDodanyRecznie &lt;&gt; 0
        END
        ELSE
        BEGIN
                --zapis z grupowaniem po dokumencie
                INSERT INTO CDN.ProdPlanyProdukty (PPP_PPLId, PPP_Termin, PPP_TerminDo, PPP_DokZrdTyp, PPP_DokZrdNumer, PPP_TwrNumer, PPP_IloscMPS, PPP_IloscRez, PPP_IloscDoWykorzystania, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, PPP_IloscNaZp, PPP_IloscZaplanowana, PPP_IloscWToku, PPP_IloscZrealizowana, PPP_TerminNaZP, PPP_TechnologiaId, PPP_IloscDoProdukcji, PPP_Edytowany, PPP_IloscMinProdukcji, PPP_IloscBrakNaMPS, PPP_DodanyLp, PPP_Lp, PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, PPP_BrakMaterialow, PPP_OkresMRPOd, PPP_OkresMRPDo,PPP_TerminProdukcji, PPP_IloscLogWolna, PPP_IloscLogZajeta)
                SELECT PPP_PPLId, PPP_Termin, PPP_TerminDo, PPP_DokZrdTyp, PPP_DokZrdNumer, PPP_TwrNumer, SUM(PPP_IloscMPS), SUM(PPP_IloscRez), SUM(PPP_IloscDoWykorzystania), PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, SUM(PPP_IloscNaZp), SUM(PPP_IloscZaplanowana), SUM(PPP_IloscWToku), SUM(PPP_IloscZrealizowana), MAX(PPP_TerminNaZP), PPP_TechnologiaId, CASE
                                WHEN (
                                                CASE
                                                        WHEN PPP_IloscMinProdukcji = 0
                                                                OR (
                                                                        PPP_IloscProduktPTZ &gt; PPP_IloscMinProdukcji
                                                                        AND SUM(PPP_IloscBrakNaMPS) &gt; 0
                                                                        )
                                                                THEN PPP_IloscMinProdukcji
                                                        ELSE PPP_IloscMinProdukcji * CEILING(SUM(PPP_IloscBrakNaMPS) / PPP_IloscMinProdukcji)
                                                        END
                                                ) &lt; SUM(PPP_IloscDoProdukcji)
                                        THEN SUM(PPP_IloscBrakNaMPS)
                                ELSE SUM(PPP_IloscDoProdukcji)
                                END, 0 PPP_Edytowany, CASE
                                WHEN PPP_IloscMinProdukcji = 0
                                        OR (
                                                PPP_IloscProduktPTZ &gt; PPP_IloscMinProdukcji
                                                AND SUM(PPP_IloscBrakNaMPS) &gt; 0
                                                )
                                        THEN PPP_IloscMinProdukcji
                                ELSE PPP_IloscMinProdukcji * CEILING(SUM(PPP_IloscBrakNaMPS) / PPP_IloscMinProdukcji)
                                END
                        --PPP_IloscMinProdukcji
                        , SUM(PPP_IloscBrakNaMPS), 0 PPP_DodanyLp, ROW_NUMBER() OVER (
                                ORDER BY PPP_PPLId, PPP_TwrNumer, PPP_Termin, PPP_TerminDo, PPP_DokZrdTyp, PriorytetRez, PPP_DokZrdNumer, PPP_TechnologiaId, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze
                                ), MAX(PPP_ZapasBezpieczenstwa), MAX(PPP_EOQ), MAX(PPP_Wielokrotnosc), MAX(PPP_Zaokraglanie), 0, MIN(PPP_OkresMRPOd), MIN(PPP_OkresMRPDo),NULL PPP_TerminProdukcji, 
						IloscLogistycznaWolna, IloscLogistycznaZajeta
                FROM #tabProdPlanyProdukty
                GROUP BY PPP_PPLId, PPP_TwrNumer, PPP_Termin, PPP_TerminDo, PPP_DokZrdTyp, PriorytetRez, PPP_DokZrdNumer, PPP_TechnologiaId, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, PPP_IloscMinProdukcji, PPP_IloscProduktPTZ, IloscLogistycznaWolna, IloscLogistycznaZajeta

                IF @@ROWCOUNT = 0
                        AND EXISTS (
                                SELECT *
                                FROM #tabCDNMPS
                                WHERE MPSTyp &gt; 1
                                )
                BEGIN
                        ROLLBACK TRAN

                        IF @Komunikat &lt;&gt; 0
                                RAISERROR ('XLPrzeliczPlanProdukcji: Wystąpił błąd podczas przeliczania planu produkcji.Nie powiódł się zapis do tabeli CDN.ProdPlanyProdukty.', 16, 1)

                        SELECT 17 AS ERROR

                        RETURN 17
                END

                --zapis informacji o pozycjach dokumentów skąd pochodzą produkty
                INSERT INTO CDN.ProdPlanyZrdDok (PPZ_PPPId, PPZ_DokNumer, PPZ_DokTyp, PPZ_DokLp, PPZ_Ilosc)
                SELECT PPP.PPP_Id, PPPK.PPP_DokZrdNumer, PPPK.PPP_DokZrdTyp, PPPK.PPP_DokZrdLp, CASE
                                WHEN PPPK.PPP_DokZrdTyp = 14343
                                        THEN CASE
                                                        WHEN PPPK.PPP_IloscMPS - PPPK.PPP_IloscNaZp - PPPK.PPP_IloscDoWykorzystania &lt; 0
                                                                THEN 0
                                                        ELSE PPPK.PPP_IloscMPS - PPPK.PPP_IloscNaZp - PPPK.PPP_IloscDoWykorzystania
                                                        END
                                ELSE CASE
                                                WHEN PPPK.PPP_IloscMPS - PPPK.PPP_IloscRez - PPPK.PPP_IloscDoWykorzystania &lt; 0
                                                        THEN 0
                                                ELSE PPPK.PPP_IloscMPS - PPPK.PPP_IloscRez - PPPK.PPP_IloscDoWykorzystania
                                                END
                                END Ilosc
                FROM #tabProdPlanyProdukty PPPK
                INNER JOIN CDN.ProdPlanyProdukty PPP ON PPP.PPP_TwrNumer = PPPK.PPP_TwrNumer
                        AND PPP.PPP_Termin = PPPK.PPP_Termin
                        AND PPP.PPP_DokZrdNumer = PPPK.PPP_DokZrdNumer
                        AND PPP.PPP_DokZrdTyp = PPPK.PPP_DokZrdTyp
                        AND PPP.PPP_PPLId = @PlanProdId
        
        END
    END
    GOTO PoGrupowanieProduktow

AktualizacjaDanychNaProduktachPrzyNiepelnymPrzeliczeniu:
    BEGIN
    IF @PrzeliczenieRodzaj &gt;= @PrzeliczenieWgOkresuMRP
        BEGIN
         UPDATE cdn.ProdPlanyProdukty  SET
         PPP_IloscOgolnieDostepna  =tppp.PPP_IloscOgolnieDostepna,
                PPP_IloscWDrodze= tppp.PPP_IloscWDrodze,
                PPP_IloscNaZp=tppp.PPP_IloscNaZp,
                PPP_IloscMinProdukcji=tppp.PPP_IloscMinProdukcji,
                PPP_EOQ= tppp.PPP_EOQ ,
                PPP_ZapasBezpieczenstwa= tppp.PPP_ZapasBezpieczenstwa ,
                PPP_Wielokrotnosc= tppp.PPP_Wielokrotnosc ,
                PPP_Zaokraglanie  = tppp.PPP_Zaokraglanie ,
                PPP_TerminNaZP=   tppp.PPP_TerminNaZP,
                PPP_IloscWToku=  tppp.PPP_IloscWToku,
                PPP_IloscZaplanowana= tppp.PPP_IloscZaplanowana,
                PPP_IloscZrealizowana=tppp.PPP_IloscZrealizowana
         FROM (SELECT PPP_PPLId, MIN(PPP_Termin) PPP_Termin, MIN(PPP_TerminDo) PPP_TerminDo, 0 DokZrdTyp, 0 DokZrdNumer, PPP_TwrNumer, SUM(PPP_IloscMPS) PPP_IloscMPS, SUM(PPP_IloscRez) PPP_IloscRez, SUM(PPP_IloscDoWykorzystania) PPP_IloscDoWykorzystania, MAX(PPP_IloscOgolnieDostepna) PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, SUM(PPP_IloscNaZp) PPP_IloscNaZp, SUM(PPP_IloscZaplanowana) PPP_IloscZaplanowana, SUM(PPP_IloscWToku) PPP_IloscWToku, SUM(PPP_IloscZrealizowana) PPP_IloscZrealizowana, PPP_TechnologiaId, CASE
                                WHEN (
                                                CASE
                                                        WHEN PPP_IloscMinProdukcji = 0
                                                                OR (
                                                                        PPP_IloscProduktPTZ &gt; PPP_IloscMinProdukcji
                                                                        AND SUM(PPP_IloscBrakNaMPS) &gt; 0
                                                                        )
                                                                THEN PPP_IloscMinProdukcji
                                                        ELSE PPP_IloscMinProdukcji * CEILING(SUM(PPP_IloscBrakNaMPS) / PPP_IloscMinProdukcji)
                                                        END
                                                ) &lt; SUM(PPP_IloscDoProdukcji)
                                        THEN SUM(PPP_IloscBrakNaMPS)
                                ELSE SUM(PPP_IloscDoProdukcji)
                                END IloscDoProdukcji, 0 PPP_Edytowany, CASE
                                WHEN PPP_IloscMinProdukcji = 0
                                        OR (
                                                PPP_IloscProduktPTZ &gt; PPP_IloscMinProdukcji
                                                AND SUM(PPP_IloscBrakNaMPS) &gt; 0
                                                )
                                        THEN PPP_IloscMinProdukcji
                                ELSE PPP_IloscMinProdukcji * CEILING(SUM(PPP_IloscBrakNaMPS) / PPP_IloscMinProdukcji)
                                END PPP_IloscMinProdukcji
                        , SUM(PPP_IloscBrakNaMPS) PPP_IloscBrakNaMPS, 0 PPP_DodanyLp, ROW_NUMBER() OVER (
                                ORDER BY PPP_PPLId, PPP_TwrNumer, MIN(PPP_Termin), MIN(PPP_TerminDo), PPP_IloscWDrodze, PPP_TechnologiaId
                                ) rownumber, PPP_TerminNaZP, MAX(PPP_ZapasBezpieczenstwa) PPP_ZapasBezpieczenstwa, MAX(PPP_EOQ) PPP_EOQ, MAX(PPP_Wielokrotnosc) PPP_Wielokrotnosc, MAX(PPP_Zaokraglanie) PPP_Zaokraglanie, 0 BrakMaterialow, PPP_OkresMRPOd PPP_OkresMRPOd, PPP_OkresMRPDo PPP_OkresMRPDo
                FROM #tabProdPlanyProdukty
                GROUP BY PPP_PPLId, PPP_TwrNumer, PPP_OkresMRPOd, PPP_OkresMRPDo, PPP_IloscWDrodze, PPP_TechnologiaId, PPP_TerminNaZP, PPP_IloscMinProdukcji, PPP_IloscProduktPTZ
           ) tppp
         JOIN cdn.ProdPlanyProdukty ppp ON  ppp.PPP_TwrNumer=tppp.PPP_TwrNumer AND ppp.PPP_TechnologiaId=tppp.PPP_TechnologiaId AND ppp.PPP_Termin=tppp.PPP_Termin AND ppp.PPP_TerminDo=tppp.PPP_TerminDo
         AND ppp.PPP_TerminNaZP=tppp.PPP_TerminNaZp
END
         ELSE IF @PrzeliczenieRodzaj &gt;= @PrzeliczenieWgOkresu
        BEGIN
         UPDATE cdn.ProdPlanyProdukty  SET
         PPP_IloscOgolnieDostepna  =tppp.PPP_IloscOgolnieDostepna,
                PPP_IloscWDrodze= tppp.PPP_IloscWDrodze,
                PPP_IloscNaZp=tppp.PPP_IloscNaZp,
                PPP_IloscMinProdukcji=tppp.PPP_IloscMinProdukcji,
                PPP_EOQ= tppp.PPP_EOQ ,
                PPP_ZapasBezpieczenstwa= tppp.PPP_ZapasBezpieczenstwa ,
                PPP_Wielokrotnosc= tppp.PPP_Wielokrotnosc ,
                PPP_Zaokraglanie  = tppp.PPP_Zaokraglanie ,
                PPP_TerminNaZP=   tppp.PPP_TerminNaZP,
                PPP_IloscWToku=  tppp.PPP_IloscWToku,
                PPP_IloscZaplanowana= tppp.PPP_IloscZaplanowana,
                PPP_IloscZrealizowana=tppp.PPP_IloscZrealizowana
         FROM (SELECT PPP_PPLId, PPP_Termin, PPP_TerminDo, 0 DokZrdTyp, 0 DokZrdNumer, PPP_TwrNumer, SUM(PPP_IloscMPS) PPP_IloscMPS, SUM(PPP_IloscRez) PPP_IloscRez, SUM(PPP_IloscDoWykorzystania) PPP_IloscDoWykorzystania, MAX(PPP_IloscOgolnieDostepna) PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, SUM(PPP_IloscNaZp) PPP_IloscNaZp, SUM(PPP_IloscZaplanowana) PPP_IloscZaplanowana, SUM(PPP_IloscWToku) PPP_IloscWToku, SUM(PPP_IloscZrealizowana) PPP_IloscZrealizowana, PPP_TechnologiaId, CASE
                                WHEN (
                                                CASE
                                                        WHEN PPP_IloscMinProdukcji = 0
                                                                OR (
                                                                        PPP_IloscProduktPTZ &gt; PPP_IloscMinProdukcji
                                                                        AND SUM(PPP_IloscBrakNaMPS) &gt; 0
                                                                        )
                                                                THEN PPP_IloscMinProdukcji
                                                        ELSE PPP_IloscMinProdukcji * CEILING(SUM(PPP_IloscBrakNaMPS) / PPP_IloscMinProdukcji)
                                                        END
                                                ) &lt; SUM(PPP_IloscDoProdukcji)
                                        THEN SUM(PPP_IloscBrakNaMPS)
                                ELSE SUM(PPP_IloscDoProdukcji)
                                END IloscDoProdukcji, 0 PPP_Edytowany, CASE
                                WHEN PPP_IloscMinProdukcji = 0
                                        OR (
                                                PPP_IloscProduktPTZ &gt; PPP_IloscMinProdukcji
                                                AND SUM(PPP_IloscBrakNaMPS) &gt; 0
                                                )
                                        THEN PPP_IloscMinProdukcji
                                ELSE PPP_IloscMinProdukcji * CEILING(SUM(PPP_IloscBrakNaMPS) / PPP_IloscMinProdukcji)
                                END PPP_IloscMinProdukcji
                        , SUM(PPP_IloscBrakNaMPS) PPP_IloscBrakNaMPS, 0 PPP_DodanyLp, ROW_NUMBER() OVER (
                                ORDER BY PPP_PPLId, PPP_TwrNumer, PPP_Termin, PPP_TerminDo, PPP_IloscWDrodze, PPP_TechnologiaId
                                ) rownumber, PPP_TerminNaZP, MAX(PPP_ZapasBezpieczenstwa) PPP_ZapasBezpieczenstwa, MAX(PPP_EOQ) PPP_EOQ, MAX(PPP_Wielokrotnosc) PPP_Wielokrotnosc, MAX(PPP_Zaokraglanie) PPP_Zaokraglanie, 0 BrakMaterialow, MIN(PPP_OkresMRPOd) PPP_OkresMRPOd, MIN(PPP_OkresMRPDo) PPP_OkresMRPDo
                FROM #tabProdPlanyProdukty
                GROUP BY PPP_PPLId, PPP_TwrNumer, PPP_Termin, PPP_TerminDo, PPP_IloscWDrodze, PPP_TechnologiaId, PPP_TerminNaZP, PPP_IloscMinProdukcji, PPP_IloscProduktPTZ
           ) tppp
         JOIN cdn.ProdPlanyProdukty ppp ON  ppp.PPP_TwrNumer=tppp.PPP_TwrNumer AND ppp.PPP_TechnologiaId=tppp.PPP_TechnologiaId AND ppp.PPP_Termin=tppp.PPP_Termin AND ppp.PPP_TerminDo=tppp.PPP_TerminDo
         AND ppp.PPP_TerminNaZP=tppp.PPP_TerminNaZp
END
        ELSE
        BEGIN
                --zapis z grupowaniem po dokumencie
                 UPDATE cdn.ProdPlanyProdukty  SET
         PPP_IloscOgolnieDostepna  =tppp.PPP_IloscOgolnieDostepna,
                PPP_IloscWDrodze= tppp.PPP_IloscWDrodze,
                PPP_IloscNaZp=tppp.PPP_IloscNaZp,
                PPP_IloscMinProdukcji=tppp.PPP_IloscMinProdukcji,
                PPP_EOQ= tppp.PPP_EOQ ,
                PPP_ZapasBezpieczenstwa= tppp.PPP_ZapasBezpieczenstwa ,
                PPP_Wielokrotnosc= tppp.PPP_Wielokrotnosc ,
                PPP_Zaokraglanie  = tppp.PPP_Zaokraglanie ,
                PPP_TerminNaZP=   tppp.PPP_TerminNaZP,
                PPP_IloscWToku=  tppp.PPP_IloscWToku,
                PPP_IloscZaplanowana= tppp.PPP_IloscZaplanowana,
                PPP_IloscZrealizowana=tppp.PPP_IloscZrealizowana
         FROM (
SELECT PPP_PPLId, PPP_Termin, PPP_TerminDo, PPP_DokZrdTyp, PPP_DokZrdNumer, PPP_TwrNumer, SUM(PPP_IloscMPS) PPP_IloscMPS, SUM(PPP_IloscRez) PPP_IloscRez, SUM(PPP_IloscDoWykorzystania) PPP_IloscDoWykorzystania, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, SUM(PPP_IloscNaZp) PPP_IloscNaZp, SUM(PPP_IloscZaplanowana) PPP_IloscZaplanowana, SUM(PPP_IloscWToku) PPP_IloscWToku, SUM(PPP_IloscZrealizowana) PPP_IloscZrealizowana, MAX(PPP_TerminNaZP) PPP_TerminNaZP, PPP_TechnologiaId, CASE
                                WHEN (
                                                CASE
                                                        WHEN PPP_IloscMinProdukcji = 0
                                                                OR (
                                                                        PPP_IloscProduktPTZ &gt; PPP_IloscMinProdukcji
                                                                        AND SUM(PPP_IloscBrakNaMPS) &gt; 0
                                                                        )
                                                                THEN PPP_IloscMinProdukcji
                                                        ELSE PPP_IloscMinProdukcji * CEILING(SUM(PPP_IloscBrakNaMPS) / PPP_IloscMinProdukcji)
                                                        END
                                                ) &lt; SUM(PPP_IloscDoProdukcji)
                                        THEN SUM(PPP_IloscBrakNaMPS)
                                ELSE SUM(PPP_IloscDoProdukcji)
                                END IloscDoProdukcji, 0 PPP_Edytowany, CASE
                                WHEN PPP_IloscMinProdukcji = 0
                                        OR (
                                                PPP_IloscProduktPTZ &gt; PPP_IloscMinProdukcji
                                                AND SUM(PPP_IloscBrakNaMPS) &gt; 0
                                                )
                                        THEN PPP_IloscMinProdukcji
                                ELSE PPP_IloscMinProdukcji * CEILING(SUM(PPP_IloscBrakNaMPS) / PPP_IloscMinProdukcji)
                                END PPP_IloscMinProdukcji
                        --PPP_IloscMinProdukcji
                        , SUM(PPP_IloscBrakNaMPS) PPP_IloscBrakNaMPS, 0 PPP_DodanyLp, ROW_NUMBER() OVER (
                                ORDER BY PPP_PPLId, PPP_TwrNumer, PPP_Termin, PPP_TerminDo, PPP_DokZrdTyp, PriorytetRez, PPP_DokZrdNumer, PPP_TechnologiaId, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze
                                ) rownumber, MAX(PPP_ZapasBezpieczenstwa) PPP_ZapasBezpieczenstwa, MAX(PPP_EOQ) PPP_EOQ, MAX(PPP_Wielokrotnosc) PPP_Wielokrotnosc, MAX(PPP_Zaokraglanie) PPP_Zaokraglanie, 0 BrakMaterialow, MIN(PPP_OkresMRPOd) PPP_OkresMRPOd, MIN(PPP_OkresMRPDo) PPP_OkresMRPDo
                FROM #tabProdPlanyProdukty
                GROUP BY PPP_PPLId, PPP_TwrNumer, PPP_Termin, PPP_TerminDo, PPP_DokZrdTyp, PriorytetRez, PPP_DokZrdNumer, PPP_TechnologiaId, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze, PPP_IloscMinProdukcji, PPP_IloscProduktPTZ
                 ) tppp
         JOIN cdn.ProdPlanyProdukty ppp ON  ppp.PPP_TwrNumer=tppp.PPP_TwrNumer AND ppp.PPP_TechnologiaId=tppp.PPP_TechnologiaId AND ppp.PPP_Termin=tppp.PPP_Termin AND ppp.PPP_TerminDo=tppp.PPP_TerminDo
         --AND ppp.PPP_TerminNaZP=tppp.PPP_TerminNaZp
                AND ppp.PPP_DokZrdTyp=tppp.PPP_DokZrdTyp AND ppp.PPP_DokZrdNumer=tppp.PPP_DokZrdNumer



END
    END
    GOTO PoAktualizacjaDanychNaProduktachPrzyNiepelnymPrzeliczeniu

WypelnijTabeleSurowcowDoTechnologii:
BEGIN
	SELECT DISTINCT PTC_Id INTO #tabTechnologieProduktow FROM CDN.ProdPlanyProdukty
		JOIN CDN.ProdTechnologiaCzynnosci ON PPP_TechnologiaId = PTC_Technologia
		JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PTC_Id
	WHERE PTZ_TwrNumer = PPP_TwrNumer AND PTZ_TwrTyp = 16 AND PTZ_TypZasobu = 0 AND PPP_PPLId = @PlanProdId;

	INSERT INTO #CTE_DrzewoSurowcow
	SELECT Surowiec.PTZ_TypZasobu, Surowiec.PTZ_ID, Surowiec.PTZ_Kod, Surowiec.PTZ_Nazwa, Surowiec.PTZ_TwrNumer TwrNumer, Surowiec.PTZ_TwrTyp Twr_Typ, 
		CASE WHEN Surowiec.PTZ_IloscFormat = 5 THEN
				CDN.Prod_WartoscAtr(Surowiec.PTZ_Ilosc, Surowiec.PTZ_IloscAtr, 14340, CzynnoscSurowca.PTC_Technologia,0,0)
			ELSE 
			CASE WHEN Surowiec.PTZ_IloscAtr = 0 AND CzynnoscSurowca.PTC_IloscAtr = 0  THEN CAST(Surowiec.PTZ_Ilosc AS float) / CzynnoscSurowca.PTC_Ilosc ELSE 
				CDN.ProdIloscAtr(1, Surowiec.PTZ_Ilosc, Surowiec.PTZ_IloscAtr, 4, Surowiec.PTZ_TypZasobu, CzynnoscSurowca.PTC_Ilosc, CzynnoscSurowca.PTC_IloscAtr, 14340, CzynnoscSurowca.PTC_Technologia, 0, 0) END
		END PTZ_Ilosc,
		CASE WHEN Produkt.PTZ_IloscAtr = 0 AND CzynnoscProduktu.PTC_IloscAtr = 0 THEN CAST(Produkt.PTZ_Ilosc AS float) / CzynnoscProduktu.PTC_Ilosc ELSE
		CDN.ProdIloscAtr(1, Produkt.PTZ_Ilosc, Produkt.PTZ_IloscAtr, 4, Produkt.PTZ_TypZasobu, CzynnoscProduktu.PTC_Ilosc, CzynnoscProduktu.PTC_IloscAtr, 14340, CzynnoscProduktu.PTC_Technologia, 0, 0) END PTZ_IloscProduktu,
		Surowiec.PTZ_IloscFormat, Surowiec.PTZ_TechnologiaZasob, Surowiec.PTZ_Magnumer,
		CzynnoscProduktu.PTC_Technologia, Produkt.PTZ_TechnologiaCzynnosc, 
		CzynnoscSurowca.PTC_ID, CzynnoscSurowca.PTC_Technologia TechnologiaSurowca, CzynnoscSurowca.PTC_Technologia, CzynnoscSurowca.PTC_ID, 
		CzynnoscSurowca.PTC_Kod, CzynnoscSurowca.PTC_Ilosc, CzynnoscSurowca.PTC_IloscAtr, 
		CDN.Prod_WartoscAtr(CzynnoscSurowca.PTC_IloscPlan, CzynnoscSurowca.PTC_IloscPlanAtr, 14340, CzynnoscSurowca.PTC_Technologia,0,0),
		Surowiec.PTZ_Zamiennik Zamiennik, 0 Poziom, 0 IdZamiennikaSurowca, Surowiec.PTZ_Id IdZamiennikaPomocnicze, 0 ZamiennikProduktu,
		CASE WHEN Surowiec.PTZ_IloscFormat = 5 AND CzynnoscSurowca.PTC_IloscPlan &lt;&gt; 0 
			  	THEN 1.00/CDN.Prod_WartoscAtr(CzynnoscSurowca.PTC_IloscPlan, CzynnoscSurowca.PTC_IloscPlanAtr, 14340, CzynnoscSurowca.PTC_Technologia,0,0) 
			ELSE 0 
		END,
		CASE WHEN Surowiec.PTZ_IloscFormat = 5 AND CzynnoscSurowca.PTC_IloscPlan = 0 THEN 1 ELSE 0 END,
		CASE 
			WHEN Surowiec.PTZ_IloscFormat = 5 AND CzynnoscSurowca.PTC_IloscPlan &lt;&gt; 0 THEN 1 
			ELSE 0
		END IlPlanowanaPierwszegoPoziomuZapotrzebowaniaZeStalaIlosc
	FROM CDN.ProdTechnologiaZasoby Surowiec
		LEFT JOIN CDN.ProdTechnologiaZasoby Produkt ON Surowiec.PTZ_TechnologiaZasob = Produkt.PTZ_Id 
			--OR (Surowiec.PTZ_TwrNumer = Produkt.PTZ_TwrNumer AND Surowiec.PTZ_TwrTyp = Produkt.PTZ_TwrTyp AND Produkt.PTZ_TypZasobu = 0 AND Surowiec.PTZ_TechnologiaCzynnosc &lt;&gt; Produkt.PTZ_TechnologiaCzynnosc)
		LEFT JOIN CDN.ProdTechnologiaCzynnosci CzynnoscProduktu ON CzynnoscProduktu.PTC_Id = Produkt.PTZ_TechnologiaCzynnosc
		JOIN CDN.ProdTechnologiaCzynnosci CzynnoscSurowca ON Surowiec.PTZ_TechnologiaCzynnosc = CzynnoscSurowca.PTC_Id
		JOIN #tabTechnologieProduktow tTP ON tTP.PTC_Id = CzynnoscSurowca.PTC_Id
	WHERE Surowiec.PTZ_TypZasobu = 1

	CREATE CLUSTERED INDEX SC ON #CTE_DrzewoSurowcow (PTC_ID)

	DECLARE @Poziom INT = 0
	WHILE @Poziom &lt; 100
	BEGIN 
		INSERT INTO #CTE_DrzewoSurowcow
		SELECT DISTINCT Surowiec.PTZ_TypZasobu, Surowiec.PTZ_ID, Surowiec.PTZ_Kod, Surowiec.PTZ_Nazwa, Surowiec.PTZ_TwrNumer TwrNumer, Surowiec.PTZ_TwrTyp, 
			CASE WHEN Surowiec.PTZ_IloscFormat = 5 THEN
						CDN.Prod_WartoscAtr(Surowiec.PTZ_Ilosc, Surowiec.PTZ_IloscAtr, 14340, CzynnoscSurowca.PTC_Technologia, 0, 0)
				ELSE
					CASE WHEN Surowiec.PTZ_IloscAtr = 0 AND CzynnoscSurowca.PTC_IloscAtr = 0 THEN CAST(Surowiec.PTZ_Ilosc AS float) / CzynnoscSurowca.PTC_Ilosc ELSE 
						CDN.ProdIloscAtr(1, Surowiec.PTZ_Ilosc, Surowiec.PTZ_IloscAtr, 4, Surowiec.PTZ_TypZasobu, CzynnoscSurowca.PTC_Ilosc, CzynnoscSurowca.PTC_IloscAtr, 14340, CzynnoscSurowca.PTC_Technologia, 0, 0) END * 
					Zrodlo.PTZ_Ilosc / CASE WHEN Zrodlo.PTZ_IloscProduktu = 0 THEN 1 ELSE Zrodlo.PTZ_IloscProduktu END 
			END PTZ_Ilosc, 
			CASE WHEN Produkt.PTZ_IloscAtr = 0 AND CzynnoscProduktu.PTC_IloscAtr = 0 THEN CAST(Produkt.PTZ_Ilosc AS float) / CzynnoscProduktu.PTC_Ilosc ELSE
			CDN.ProdIloscAtr(1, Produkt.PTZ_Ilosc, Produkt.PTZ_IloscAtr, 4, Produkt.PTZ_TypZasobu, CzynnoscProduktu.PTC_Ilosc, CzynnoscProduktu.PTC_IloscAtr, 14340, CzynnoscProduktu.PTC_Technologia, 0, 0) END PTZ_IloscProduktu,
			Surowiec.PTZ_IloscFormat, Surowiec.PTZ_TechnologiaZasob, Surowiec.PTZ_Magnumer,
			CzynnoscProduktu.PTC_Technologia TechnologiaProduktu, Produkt.PTZ_TechnologiaCzynnosc CzynnoscProduktu, Zrodlo.PTC_IDOrg,
			Zrodlo.TechOrg, CzynnoscSurowca.PTC_Technologia, CzynnoscSurowca.PTC_ID, 
			CzynnoscSurowca.PTC_Kod, CzynnoscSurowca.PTC_Ilosc, CzynnoscSurowca.PTC_IloscAtr,
			CDN.Prod_WartoscAtr(CzynnoscSurowca.PTC_IloscPlan, CzynnoscSurowca.PTC_IloscPlanAtr, 14340, CzynnoscSurowca.PTC_Technologia,0,0),
			Surowiec.PTZ_Zamiennik, Zrodlo.Poziom + 1, Zrodlo.IdZamiennikaPomocnicze, Zrodlo.IdZamiennikaPomocnicze, Zrodlo.Zamiennik,
			CASE WHEN Surowiec.PTZ_IloscFormat &lt;&gt; 5 THEN CASE Zrodlo.MnoznikDoStalejIlosci WHEN 0 THEN 1 ELSE Zrodlo.MnoznikDoStalejIlosci END
				ELSE
					CASE
						WHEN Zrodlo.PTZ_IloscFormat = 5 AND Zrodlo.PTC_IloscPlan &lt;&gt; 0 THEN Zrodlo.PTZ_Ilosc * CASE Zrodlo.MnoznikDoStalejIlosci WHEN 0 THEN 1 ELSE Zrodlo.MnoznikDoStalejIlosci END
						ELSE Zrodlo.PTZ_Ilosc			
					END / (CASE 
						WHEN CDN.Prod_WartoscAtr(CzynnoscSurowca.PTC_IloscPlan, CzynnoscSurowca.PTC_IloscPlanAtr, 14340, CzynnoscSurowca.PTC_Technologia,0,0) * Zrodlo.PTZ_IloscProduktu = 0 THEN 1
						ELSE CDN.Prod_WartoscAtr(CzynnoscSurowca.PTC_IloscPlan, CzynnoscSurowca.PTC_IloscPlanAtr, 14340, CzynnoscSurowca.PTC_Technologia,0,0) * Zrodlo.PTZ_IloscProduktu
					END)
			END,
			CASE WHEN CzynnoscZrodla.PTC_IloscPlan = 0 AND Zrodlo.PTZ_IloscFormat = 5 THEN Zrodlo.PTZ_Ilosc
				ELSE Zrodlo.OstatniPolproduktZeStalaIloscBezPlanowaniaIlosc
			END,
			CASE WHEN CzynnoscZrodla.PTC_IloscPlan &lt;&gt; 0 AND Zrodlo.PTZ_IloscFormat = 5 THEN 1 
				ELSE Zrodlo.IlPlanowanaPierwszegoPoziomuZapotrzebowaniaZeStalaIlosc
			END
		FROM #CTE_DrzewoSurowcow Zrodlo
			JOIN CDN.ProdTechnologiaCzynnosci CzynnoscZrodla ON Zrodlo.CzynnoscTech = CzynnoscZrodla.PTC_Id
			JOIN CDN.ProdTechnologiaZasoby Surowiec ON Zrodlo.PTC_ID = Surowiec.PTZ_TechnologiaCzynnosc AND Surowiec.PTZ_TypZasobu = 1
			LEFT JOIN CDN.ProdTechnologiaZasoby Produkt ON Surowiec.PTZ_TechnologiaZasob = Produkt.PTZ_Id 
			LEFT JOIN CDN.ProdTechnologiaCzynnosci CzynnoscProduktu ON CzynnoscProduktu.PTC_Id = Produkt.PTZ_TechnologiaCzynnosc
			JOIN CDN.ProdTechnologiaCzynnosci CzynnoscSurowca ON Surowiec.PTZ_TechnologiaCzynnosc = CzynnoscSurowca.PTC_Id
		WHERE Zrodlo.Poziom = @Poziom AND Zrodlo.PTC_ID IS NOT NULL

		IF @@ROWCOUNT = 0
			BREAK

		SET @Poziom = @Poziom + 1
	END

	DELETE FROM #CTE_DrzewoSurowcow WHERE PTZ_TechnologiaZasob &lt;&gt; 0 OR PTZ_Ilosc = 0
	DROP INDEX SC ON #CTE_DrzewoSurowcow
	CREATE CLUSTERED INDEX SC ON #CTE_DrzewoSurowcow (Id)

	;WITH cte
	AS (SELECT a1.Id, ROW_NUMBER() OVER (PARTITION BY a1.PTZ_Id, a1.PTC_IDOrg, a1.TwrNumer, a1.PTZ_Magnumer, a1.ZamiennikProduktu
											   ORDER BY a1.PTZ_Ilosc DESC) RN
		FROM #CTE_DrzewoSurowcow a1
			)
	DELETE del FROM #CTE_DrzewoSurowcow del 
		JOIN cte ON del.Id = cte.Id
		WHERE  RN &gt; 1;

END
GOTO PoWypelnijTabeleSurowcowDoTechnologii



KolejnoscKrokow:
    GOTO Deklaracje -- Deklaracja stałych, zmiennych, tabel

PoDeklaracje:
    GOTO SprawdzeniePraw -- Sprawdzenie praw do przeliczania planu produkcji

PoSprawdzeniePraw:
    GOTO WypelnianieTabelPomocniczych

PoWypelnianieTabelPomocniczych:
    BEGIN TRAN
    GOTO PrzenoszenieDanychZPoprzednioWygenerowanegoPlanu

PoPrzenoszenieDanychZPoprzednioWygenerowanegoPlanu:
If @Stan=@PotwierdzonyPlanProdukcji --Przeliczanie potwierdzonego planu - przeliczanie niepełne
    GOTO AktualizacjaInformacjiOOstatnimPrzeliczeniuPlanu
else--Dokument w buforze, pełne przeliczanie planu produkcji
    GOTO CzyszczenieStaregoPlanuProdukcji

PoCzyszczenieStaregoPlanuProdukcji:
    GOTO AktualizacjaInformacjiOOstatnimPrzeliczeniuPlanu

PoAktualizacjaInformacjiOOstatnimPrzeliczeniuPlanu:
    GOTO WyliczenieProduktowPlanu

PoWyliczenieProduktowPlanu:
If @Stan=@PotwierdzonyPlanProdukcji --Przeliczanie potwierdzonego planu - przeliczanie niepełne
    GOTO AktualizacjaDanychNaProduktachPrzyNiepelnymPrzeliczeniu
else
    GOTO GrupowanieProduktow

PoGrupowanieProduktow:
PoAktualizacjaDanychNaProduktachPrzyNiepelnymPrzeliczeniu:
	GOTO WypelnijTabeleSurowcowDoTechnologii

PoWypelnijTabeleSurowcowDoTechnologii:
	-- todo exec storepdorcedure2
    EXEC CDN.XLPrzeliczPlanProdukcji2 @PlanProdId, @PrzeliczenieRodzaj ,
		@PrzeliczenieData ,
		@DoProdukcjiPodst ,
         @FrsId ,
         @KolejnePrzeliczeniePlanu ,
         @RezDataAkt ,
         @PelneRozwiniecieMaterialowe ,
         @TwrNumer ,
         @DoZamowieniaPodst ,
         @Stan,
        @CzyNormatywyZMagazynu,
		@ZakresRezerwacjiOd,
		@ZakresRezerwacjiDo


Koniec:
        SET NOCOUNT OFF

        COMMIT TRAN

        SELECT @PlanProdId PPLID, @OpeNumer OpeNumer, (
                        SELECT Ope_Ident
                        FROM CDN.OpeKarty
                        WHERE Ope_GIDNumer = @OpeNumer
                        ) OpeKod, @DataCzasPrz DataCzasPrz
END


</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XLDodajProduktPlanProdukcji]"></A><PRE>
          <FONT SIZE="2"><I>/* [XLDodajProduktPlanProdukcji] */</I><BR>
CREATE PROCEDURE [CDN].[XLDodajProduktPlanProdukcji]
(
/* ==========================================================================================
        SQL API: Procedura serwerowa do dodawania produktów

        Parametry wejściowe:
   ========================================================================================== */
		@PlanProdId INT,			    -- identyfikator planu produkcji
        @SesjaID	int,				-- ID bieżącej sesji
        @TwrNumer INT = NULL,			-- identyfikator towaru
        @TwrKod NVARCHAR(40) = NULL,	-- kod towaru
        @Termin INT = NULL,					-- termin
        @IloscDoProdukcji DECIMAL(15,4) = 0,	-- ilość do produkcji
        @Komunikat	TINYINT = 0		-- Czy wyswietlac komunikat o bledzie	
/* ==========================================================================================
        Błędy:
        7 : Wystąpił błąd podczas dodawania produktu do planu produkcji. Nie znalezionio planu produkcji.
        8 : Wystąpił błąd podczas dodawania produktu do planu produkcji. Podany plan produkcji nie jest aktywny w obecnej sesji.
        17 : Wystąpił błąd podczas dodawania produktu do planu produkcji. Nie powiodło się dodawanie wpisu do tabeli CDN.ProdPlanyProdukty.
        24 : Wystąpił błąd podczas dodawania produktu do planu produkcji. Nie znaleziono towaru.
        25 : Wystąpił błąd podczas dodawania produktu do planu produkcji. Niepoprawny typ towaru.
        26 : Wystąpił błąd podczas dodawania produktu do planu produkcji. Podany towar nie należy do grupy towarowej wybranej na planie produkcji.
        27 : Wystąpił błąd podczas dodawania produktu do planu produkcji. Podany towar nie ma wskazanej technologii domyślnej.
   ========================================================================================== */
)
AS
BEGIN
DECLARE @PPLAktywny INT
DECLARE @Typ_ProdPlany INT	
DECLARE @FrsId		INT
DECLARE @TwrProdTechnologia INT
DECLARE @DokPPLProduktyZdefTechnologia INT
DECLARE @TwrNumerGrupa INT
DECLARE @IloscOgolnieDostepna		DECIMAL(15,4)
DECLARE @IloscOgolnieDostepnaStan	DECIMAL(15,4)
DECLARE @IloscWDrodze			DECIMAL(15,4)
DECLARE @DodanyLp INT
DECLARE @Lp			SMALLINT
DECLARE @TerminPP  INT
DECLARE @TerminIlosc  INT
DECLARE @PrzeliczenieData INT

DECLARE @TwrGIDTyp SMALLINT, @TwrGIDFirma INT, @TwrTyp TINYINT	

DECLARE @RodzajZak SMALLINT
DECLARE @RodzajZWZak SMALLINT

DECLARE @CzyNormatywyZMagazynu TINYINT
SELECT @CzyNormatywyZMagazynu= CASE WHEN count(*)=1 THEN 1 ELSE 0 END
                  FROM cdn.ProdPlanyMag WHERE PPM_PPLId = @PlanProdId AND PPM_MagDlaElem = 0

CREATE TABLE #tabMagaynyPP (PPId INT, MagNumer INT, MagDlaElem INT)

SET @Typ_ProdPlany = 14360 

SET @RodzajZak		= 0
SET @RodzajZWZak	= 1

SET NOCOUNT ON	



	SELECT @PPLAktywny = PPL_Aktywny, @FrsId = PPL_FrsId,
	@TerminPP = (CASE WHEN PPL_PrzeliczenieRodzaj = 1 THEN PPL_PrzeliczenieDo ELSE PPL_PrzeliczenieOd END),
	@TerminIlosc = PPL_PrzeliczenieDo,
	@PrzeliczenieData = PPL_DataCzasPrz / 24 /3600 +  DATEDIFF(d,'18001228',GETDATE()) - DATEDIFF(d,'19900101',GETDATE()) 
	FROM CDN.ProdPlany WHERE PPL_Id = @PlanProdId 
	
	IF @Termin IS NULL OR @Termin &lt; 1	
		SET @Termin = @TerminPP
		
	IF @IloscDoProdukcji IS NULL OR @IloscDoProdukcji &lt; 0	
		SET @IloscDoProdukcji = 0
	
	SET @TwrNumer = COALESCE((SELECT Twr_GIDNumer FROM CDN.TwrKarty WHERE Twr_GIDNumer = @TwrNumer AND Twr_GIDNumer &gt; 0),
						     (SELECT Twr_GIDNumer FROM CDN.TwrKarty WHERE Twr_Kod = @TwrKod))

	SELECT @TwrGIDTyp = Twr_GIDTyp, @TwrGIDFirma = Twr_GIDFirma, @TwrTyp = Twr_Typ, @TwrKod = Twr_Kod FROM CDN.TwrKarty WHERE Twr_GIDNumer = @TwrNumer

	IF @PPLAktywny IS NULL
	BEGIN			
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajProduktPlanProdukcji: Wystąpił błąd podczas dodawania produktu do planu produkcji. Nie znalezionio planu produkcji.', 16, 1)
		SELECT 7 AS ERROR
		RETURN 7
	END	
	
	IF @PPLAktywny != @SesjaID 	
	BEGIN		
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajProduktPlanProdukcji: Wystąpił błąd podczas dodawania produktu do planu produkcji. Podany plan produkcji nie jest aktywny w obecnej sesji.', 16, 1)
		SELECT 8 AS ERROR
		RETURN 8
	END

	IF @TwrNumer IS NULL
	BEGIN			
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajProduktPlanProdukcji: Wystąpił błąd podczas dodawania produktu do planu produkcji. Nie znaleziono towaru.', 16, 1)
		SELECT 24 AS ERROR
		RETURN 24
	END	
	
	IF NOT EXISTS(SELECT * FROM CDN.TwrKarty WHERE Twr_GIDNumer = @TwrNumer AND Twr_Typ IN(1,2))
	BEGIN			
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajProduktPlanProdukcji: Wystąpił błąd podczas dodawania produktu do planu produkcji. Niepoprawny typ towaru.', 16, 1)
		SELECT 25 AS ERROR
		RETURN 25
	END	
	
	select @DokPPLProduktyZdefTechnologia = Dok_PPLProduktyZdefTechnologia FROM CDN.DokDefinicje WHERE Dok_FrsId = @FrsId AND Dok_GIDTyp = @Typ_ProdPlany

	select top 1 @TwrNumerGrupa = Twr_GIDNumer, @TwrProdTechnologia = Twr_ProdTechnologia	
	from CDN.TwrKarty	
	inner join CDN.TwrGrupy on TwG_GIDNumer = Twr_GIDNumer AND TwG_GIDTyp = Twr_GIDTyp
	inner join CDN.DokDefinicje on Dok_FrsId = @FrsId AND Dok_GIDTyp = @Typ_ProdPlany
	Where  TwG_GrONumer IN(
							SELECT GIDNumer FROM CDN.ProdPlanyTwG 
							CROSS APPLY CDN.PobierzDrzewoGrupTowarowychKuLisciom(PPG_TwGNumer,default,null,null,null) 
							WHERE PPG_PPLId = @PlanProdId
							)
		AND Twr_GIDNumer = @TwrNumer
		
	IF @TwrNumerGrupa IS NULL
	BEGIN			
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajProduktPlanProdukcji: Wystąpił błąd podczas dodawania produktu do planu produkcji. Podany towar nie należy do grupy towarowej wybranej na planie produkcji.', 16, 1)
		SELECT 26 AS ERROR
		RETURN 26
	END	
	
	IF @DokPPLProduktyZdefTechnologia &gt; 0 AND (@TwrProdTechnologia = 0 OR @TwrProdTechnologia IS NULL)
	BEGIN			
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajProduktPlanProdukcji: Wystąpił błąd podczas dodawania produktu do planu produkcji. Podany towar nie ma wskazanej technologii domyślnej.', 16, 1)
		SELECT 27 AS ERROR
		RETURN 27
	END	
        
        INSERT INTO #tabMagaynyPP
        SELECT *
        FROM CDN.ProdPlanyPobierzMagazynyPP(@PlanProdId, DEFAULT)

	--obliczanie stanow magazynowych
	SELECT @IloscOgolnieDostepnaStan = ISNULL(SUM(CASE WHEN @TwrTyp IN(4,6) THEN 0 ELSE  ISNULL(Cast(CDN.SubstringEx(CDN.DokSumaStanowTowaru(@TwrGIDTyp,@TwrGIDFirma,@TwrNumer,@TwrTyp,32768,0,0,0,PPM_MagNumer,2,0,0,PPL_PrzeliczenieDo,0,2,@FrsId,0,0,0,0,0,0,-1),':',1) as decimal(15,4)),0) END),0) 		
	FROM
	(
	SELECT PPL_PrzeliczenieDo, ISNULL(PPM_MagNumer,0) PPM_MagNumer
	FROM CDN.ProdPlany
	LEFT JOIN CDN.ProdPlanyMag on PPM_PPLId = PPL_Id AND PPM_MagDlaElem = 0
	where PPL_Id = @PlanProdId 
	) TabMag

		
	SELECT
	@IloscOgolnieDostepna =	(select ISNULL(SUM(case when Rodzaj &lt;= @RodzajZWZak THEN Ilosc WHEN RezGIDTyp = 2576 THEN -Ilosc END),0) from CDN.ProdPlanyPobierzElementyDoMPS(@PlanProdId, @TwrNumer) MPSPom  where MPSPom.DataRealizacji &lt;= @TerminIlosc and ((MPSPom.DataRealizacji &gt; @PrzeliczenieData and Rodzaj &lt;= @RodzajZWZak) or Rodzaj &gt; @RodzajZWZak)) + 
			(SELECT ISNULL(SUM(MPSPom.Ilosc-MPSPom.IloscDst),0) FROM CDN.ProdPlanyPobierzElementyDoMPS(@PlanProdId, @TwrNumer) MPSPom  WHERE MPSPom.MPSTyp &gt; 0 AND MPSPom.RezGIDTyp = 2576 AND MPSPom.DataRealizacji = @TerminIlosc),
	@IloscWDrodze = (select ISNULL(SUM(Ilosc),0) from CDN.ProdPlanyPobierzElementyDoMPS(@PlanProdId, @TwrNumer) MPSPom where ((MPSPom.DataRealizacji &gt; @TerminIlosc or MPSPom.DataRealizacji &lt;= @PrzeliczenieData) and Rodzaj = @RodzajZak))

	SET @IloscOgolnieDostepna = CASE WHEN @IloscOgolnieDostepna + @IloscOgolnieDostepnaStan &lt; 0 THEN 0 ELSE @IloscOgolnieDostepna + @IloscOgolnieDostepnaStan END
	
	SET @DodanyLp = (SELECT ISNULL(MAX(PPP_DodanyLp),0) + 1 FROM CDN.ProdPlanyProdukty where PPP_PPLId = @PlanProdId)
	SET @Lp = (SELECT ISNULL(MAX(PPP_Lp),0) + 1 FROM CDN.ProdPlanyProdukty where PPP_PPLId = @PlanProdId)

	INSERT INTO CDN.ProdPlanyProdukty(PPP_PPLId, 
									PPP_Termin, 
									PPP_TerminDo,
									PPP_DokZrdTyp,PPP_DokZrdNumer,PPP_TwrNumer,PPP_IloscMPS,PPP_IloscRez,PPP_IloscDoWykorzystania,
									PPP_IloscOgolnieDostepna,
									PPP_IloscWDrodze,PPP_IloscNaZp,PPP_IloscZaplanowana,
									PPP_IloscWToku, PPP_IloscZrealizowana, PPP_TerminNaZP, 
									PPP_TechnologiaId, PPP_IloscDoProdukcji, PPP_Edytowany, 
									PPP_IloscMinProdukcji, PPP_IloscBrakNaMPS, PPP_DodanyLp,
									PPP_Lp,PPP_ZapasBezpieczenstwa,PPP_EOQ,PPP_Wielokrotnosc,PPP_Zaokraglanie,
                                                                        PPP_TerminProdukcji)
	SELECT
		@PlanProdId, 
		@Termin,
		CASE WHEN PPL_PrzeliczenieRodzaj = 1 THEN 0 ELSE PPL_PrzeliczenieDo END,
		0,0, @TwrNumer, 0, 0, 0,
		@IloscOgolnieDostepna,
		@IloscWDrodze,0,0,
		0,0,0,
		(Select Top 1 CDN.ProdTechnologiaDomyslna(@TwrNumer,0,'',0,0,@Termin,@Termin)),
		@IloscDoProdukcji,3,
		0,0,@DodanyLp,
		@Lp, CASE (@CzyNormatywyZMagazynu)
                                                   WHEN 1 THEN COALESCE((SELECT Tpm_IloscMin FROM cdn.TwrParMag WHERE Twr_GIDNumer=Tpm_TwrNumer AND Tpm_MagNumer=(SELECT MagNumer FROM #tabMagaynyPP) ),Twr_IloscMin)
                                                   ELSE Twr_IloscMin
                                                   END  ZapasBezpieczenstwa,
                                                   Twr_MrpEoq EOQ,
                                                    CASE (@CzyNormatywyZMagazynu)
                                                   WHEN 1 THEN COALESCE((SELECT Tpm_IloscZam FROM cdn.TwrParMag WHERE Twr_GIDNumer=Tpm_TwrNumer AND Tpm_MagNumer=(SELECT MagNumer FROM #tabMagaynyPP) ),Twr_IloscZam)
                                                   ELSE Twr_IloscZam
                                                   END Wielokrotnosc,
                                                                                                   CASE
                                                                                                   WHEN Twr_MrpZaok =0 THEN 0
                                                                                                   WHEN Twr_MrpZaok %1000000=0 THEN 1000000
                                                                                                   WHEN Twr_MrpZaok %100000=0 THEN 100000
                                                                                                   WHEN Twr_MrpZaok %10000=0 THEN 10000
                                                                                                   WHEN Twr_MrpZaok %1000=0 THEN 1000
                                                                                                   WHEN Twr_MrpZaok %100=0 THEN 100
                                                                                                   WHEN Twr_MrpZaok %10=0 THEN 10
                                                                                                   WHEN Twr_MrpZaok %1=0 THEN 1
                                                                                                   WHEN Twr_MrpZaok %0.1=0 THEN 0.1
                                                                                                   WHEN Twr_MrpZaok %0.01=0 THEN 0.01
                                                                                                   WHEN Twr_MrpZaok %0.001=0 THEN 0.001
                                                                                                   WHEN Twr_MrpZaok %0.0001=0 THEN 0.0001
                                                                                                   END Zaokraglanie,
                                                                                                   NULL TerminProdukcji
	FROM CDN.ProdPlany
        join cdn.TwrKarty ON Twr_GIDNumer=@TwrNumer
         WHERE PPL_Id = @PlanProdId
	
	IF @@ROWCOUNT=0 BEGIN					
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLDodajProduktPlanProdukcji: Wystąpił błąd podczas dodawania produktu do planu produkcji. Nie powiódł się zapis to tabeli CDN.ProdPlanyProdukty.', 16, 1)
		RETURN 17
	END	
	
	SELECT @TwrNumer TwrNumer, @TwrKod TwrKod, @Termin Termin, @IloscDoProdukcji IloscDoProdukcji 	
	RETURN 0
	
	SET NOCOUNT OFF
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XLUsunProduktPlanProdukcji]"></A><PRE>
          <FONT SIZE="2"><I>/* [XLUsunProduktPlanProdukcji] */</I><BR>
CREATE PROCEDURE [CDN].[XLUsunProduktPlanProdukcji]
(
/* ==========================================================================================
        SQL API: Procedura serwerowa do usuwania produktów

        Parametry wejściowe:
   ========================================================================================== */
		@PlanProdId INT,			    -- identyfikator planu produkcji
        @SesjaID	INT,				-- ID bieżącej sesji
		@PlanProdProduktId INT = 0,			    -- identyfikator produktu planu produkcji
        @Komunikat	TINYINT = 0		-- Czy wyswietlac komunikat o bledzie		
/* ==========================================================================================
        Błędy:
        7: Wystąpił błąd podczas usuwania produktu z planu produkcji. Nie znalezionio planu produkcji.
        8 : Wystąpił błąd podczas usuwania produktu z planu produkcji. Podany plan produkcji nie jest aktywny w obecnej sesji.
        16: Wystąpił błąd podczas usuwania produktu z planu produkcji. Nie powiodło się usuwanie wpisu z tabeli CDN.ProdPlanyProdukty.
        28: Wystąpił błąd podczas usuwania produktu z planu produkcji. Nie znalezionio produktu planu produkcji na podstawie identyfikatora.	
        29: Wystąpił błąd podczas usuwania produktu z planu produkcji. Produkto podanym identyfikatorze nie należy do podanego planu produkcji.
        30: Wystąpił błąd podczas usuwania produktu z planu produkcji. Nie znalezionio produktu planu produkcji na podstawie terminu, technologii, towaru, lp. dodania.
        31: Wystąpił błąd podczas usuwania produktu z planu produkcji. Tylko z niepotwierdzonego planu produkcji można usunąć produkt.
        32: Wystąpił błąd podczas usuwania produktu z planu produkcji. Nie mozna usunąć produktu do którego zostały wygenerowane dokumenty.
   ========================================================================================== */
)
AS
BEGIN
DECLARE @PPLAktywny INT
DECLARE	@PlanProdPPId INT
DECLARE @PPLStan	SMALLINT
DECLARE @tabPlanyProdukcjiId TABLE(
	PPId		int
)
SET NOCOUNT ON	

	SELECT @PPLAktywny = PPL_Aktywny, @PPLStan = PPL_Stan FROM CDN.ProdPlany WHERE PPL_Id = @PlanProdId
	
	IF @PPLAktywny IS NULL
	BEGIN			
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLUsunProduktPlanProdukcji: Wystąpił błąd podczas usuwania produktu z planu produkcji. Nie znalezionio planu produkcji.', 16, 1)
		SELECT 7 AS ERROR
		RETURN 7
	END	
	
	IF @PPLAktywny != @SesjaID 	
	BEGIN		
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLUsunProduktPlanProdukcji: Wystąpił błąd podczas usuwania produktu z planu produkcji. Podany plan produkcji nie jest aktywny w obecnej sesji.', 16, 1)
		SELECT 8 AS ERROR
		RETURN 8
	END
	
	IF @PPLStan != 1 BEGIN	
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLUsunProduktPlanProdukcji: Wystąpił błąd podczas usuwania produktu z planu produkcji. Tylko z niepotwierdzonego planu produkcji można usunąć produkt.', 16, 1)
		SELECT 31 AS ERROR
		RETURN 31
	END

	IF @PlanProdProduktId IS NOT NULL AND @PlanProdProduktId &gt; 0 BEGIN
		Select @PlanProdPPId = PPP_PPLId  FROM CDN.ProdPlanyProdukty WHERE PPP_Id = @PlanProdProduktId
		IF @PlanProdPPId IS NULL BEGIN		
			IF @Komunikat &lt;&gt; 0 RAISERROR ('XLUsunProduktPlanProdukcji: Wystąpił błąd podczas usuwania produktu z planu produkcji. Nie znalezionio produktu planu produkcji na podstawie identyfikatora.', 16, 1)
			SELECT 28 AS ERROR
			RETURN 28
		END
		IF @PlanProdId != @PlanProdPPId BEGIN
			IF @Komunikat &lt;&gt; 0 RAISERROR ('XLUsunProduktPlanProdukcji: Wystąpił błąd podczas usuwania produktu z planu produkcji. Produkto podanym identyfikatorze nie należy do podanego planu produkcji.', 16, 1)
			SELECT 29 AS ERROR
			RETURN 29
		END
		
		IF EXISTS(SELECT * FROM CDN.ProdPlanyProdWygenerowaneDok(@PlanProdProduktId,NULL)) BEGIN
			IF @Komunikat &lt;&gt; 0 RAISERROR ('XLUsunProduktPlanProdukcji: Wystąpił błąd podczas usuwania produktu z planu produkcji. Nie mozna usunąć produktu do którego zostały wygenerowane dokumenty.', 16, 1)
			SELECT 32 AS ERROR
			RETURN 32			
		END
		
		INSERT INTO @tabPlanyProdukcjiId
		Select @PlanProdProduktId 
	END	 
        	
	DELETE FROM CDN.ProdPlanyProdukty WHERE PPP_Id IN (Select PPId FROM @tabPlanyProdukcjiId)

	IF @@ROWCOUNT=0 BEGIN					
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLUsunProduktPlanProdukcji: Wystąpił błąd podczas usuwania produktu z planu produkcji. Nie powiodło się usuwanie wpisu z tabeli CDN.ProdPlanyProdukty.', 16, 1)
		SELECT 16 AS ERROR
		RETURN 16
	END	

	SELECT 		
		@PlanProdProduktId PPP_Id         
	RETURN 0
	
	SET NOCOUNT OFF
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[PlanProdukcjiZmienIloscDoProdukcji]"></A><PRE>
          <FONT SIZE="2"><I>/* [PlanProdukcjiZmienIloscDoProdukcji] */</I><BR>
CREATE PROCEDURE [CDN].[PlanProdukcjiZmienIloscDoProdukcji]
(
/* ==========================================================================================
        SQL API: Procedura serwerowa do aktualizacji ilości produktów

        Parametry wejściowe:
   ========================================================================================== */
		@PlanProdId INT,			    -- identyfikator planu produkcji
        @TwrNumer INT = 0,			-- identyfikator towaru
        @Termin	INT = 0,			--termin
        @TechnologiaId INT = 0,
        @DodanyLp INT = 0,
        @IloscDoProdukcjiRoznica DECIMAL(15,4) = 0,
        @KierunekModyfikacji SMALLINT = 0 --czy zmieniamy na wieksza czy na mniejsza wartosc 0 - na wieksza, 1 na mniejsza
/* ==========================================================================================

   ========================================================================================== */
)
AS
BEGIN
	SET NOCOUNT ON
	DECLARE @EdycjaIlosc INT
	DECLARE @PPPId		INT
	DECLARE @IloscDoProdukcji	DECIMAL(15,4)
	DECLARE @IloscWygenerowana	DECIMAL(15,4)
	DECLARE @IloscDoProdukcjiNowa	DECIMAL(15,4)
	   
	SET @EdycjaIlosc = 1
	   
	IF @KierunekModyfikacji = 0 BEGIN
		DECLARE ModyfikowanePozycjeKursor CURSOR LOCAL FOR 
		SELECT PPP_Id, PPP_IloscDoProdukcji, (SELECT ISNULL(Sum(Ilosc),0) FROM CDN.ProdPlanyProdWygenerowaneDok(PPP_Id,NULL)) FROM CDN.ProdPlanyProdukty
        WHERE PPP_PPLId = @PlanProdId AND PPP_TwrNumer = @TwrNumer AND PPP_Termin = @Termin AND PPP_TechnologiaId = @TechnologiaId 
        AND PPP_DodanyLp = @DodanyLp  AND PPP_DokZrdTyp != 14343
        ORDER BY PPP_Lp ASC
        
        OPEN ModyfikowanePozycjeKursor
		FETCH NEXT FROM ModyfikowanePozycjeKursor INTO @PPPId, @IloscDoProdukcji, @IloscWygenerowana	
		
		WHILE @@FETCH_STATUS = 0
		BEGIN
			UPDATE CDN.ProdPlanyProdukty SET PPP_IloscDoProdukcji = PPP_IloscDoProdukcji + @IloscDoProdukcjiRoznica,
											 PPP_Edytowany = PPP_Edytowany | @EdycjaIlosc WHERE PPP_Id = @PPPId
											 
			SET @IloscDoProdukcjiRoznica = 0
			
			FETCH NEXT FROM ModyfikowanePozycjeKursor INTO @PPPId, @IloscDoProdukcji, @IloscWygenerowana	
		END
		
		CLOSE ModyfikowanePozycjeKursor
		DEALLOCATE ModyfikowanePozycjeKursor
	END ELSE BEGIN
		DECLARE ModyfikowanePozycjeKursor CURSOR LOCAL FOR 
		SELECT PPP_Id, PPP_IloscDoProdukcji, (SELECT ISNULL(Sum(Ilosc),0) FROM CDN.ProdPlanyProdWygenerowaneDok(PPP_Id,NULL)) FROM CDN.ProdPlanyProdukty
        WHERE PPP_PPLId = @PlanProdId AND PPP_TwrNumer = @TwrNumer AND PPP_Termin = @Termin AND PPP_TechnologiaId = @TechnologiaId
        AND PPP_DodanyLp = @DodanyLp  AND PPP_DokZrdTyp != 14343
        ORDER BY PPP_Lp DESC
        
        OPEN ModyfikowanePozycjeKursor
		FETCH NEXT FROM ModyfikowanePozycjeKursor INTO @PPPId, @IloscDoProdukcji, @IloscWygenerowana	
		
		WHILE @@FETCH_STATUS = 0
		BEGIN
		
			IF @IloscDoProdukcji - @IloscWygenerowana &lt; @IloscDoProdukcjiRoznica BEGIN
				SET @IloscDoProdukcjiNowa = @IloscWygenerowana
                SET @IloscDoProdukcjiRoznica = @IloscDoProdukcjiRoznica - @IloscDoProdukcji + @IloscWygenerowana
			END ELSE BEGIN
				IF @IloscDoProdukcjiRoznica &gt; 0 BEGIN    
					SET @IloscDoProdukcjiNowa = @IloscDoProdukcji - @IloscDoProdukcjiRoznica
					SET @IloscDoProdukcjiRoznica = 0
                END ELSE
					SET @IloscDoProdukcjiNowa = @IloscDoProdukcji 
            END
             
            UPDATE CDN.ProdPlanyProdukty SET PPP_IloscDoProdukcji = @IloscDoProdukcjiNowa,
											 PPP_Edytowany = PPP_Edytowany | @EdycjaIlosc WHERE PPP_Id = @PPPId
                    		
			FETCH NEXT FROM ModyfikowanePozycjeKursor INTO @PPPId, @IloscDoProdukcji, @IloscWygenerowana	
			
		END
		
		CLOSE ModyfikowanePozycjeKursor
		DEALLOCATE ModyfikowanePozycjeKursor
	END
SET NOCOUNT OFF	
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>