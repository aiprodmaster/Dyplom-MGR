<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="CUKOplataAnalityczna"></A><PRE>
          <FONT SIZE="2"><I>/* CUKOplataAnalityczna */</I><BR>
CREATE FUNCTION CDN.CUKOplataAnalityczna (
@trnGIDTyp		SMALLINT, 
@trnGIDNumer    INT,
@stawkaMax		SMALLINT			--NadwyĹĽka cukru liczona wg stawki max
)
RETURNS @Wynik TABLE (
		DokGIDTyp   SMALLINT,
		DokGIDNumer INT,
		P_11		BIGINT,
		P_12		decimal(25,2),
		P_13		decimal(25,2),
		P_14		BIGINT,
		P_15		BIGINT,
		P_16		decimal(25,2),
		P_17		decimal(25,2),
		P_18		decimal(25,2),
		P_19		BIGINT,
		P_20		decimal(25,2),
		P_21		decimal(25,2),
		P_22		BIGINT,
		P_23		BIGINT,
		P_24		decimal(25,2),
		P_25		decimal(25,2),
		P_26		BIGINT,
		P_27		BIGINT,
		P_28		decimal(25,2),
		P_29		decimal(25,2)
)

BEGIN
	DECLARE @Towary Table (
		DokGIDTyp				SMALLINT,
		DokGIDNumer				INT,
		TwrGIDTyp				SMALLINT,
		TwrGIDNumer				INT,
		TwrOplataSpozFlaga		INT,
		TwrZawartoscCukru		DECIMAL(7,2),
		TrEIlosc				DECIMAL(11,4),
		TwrOplataSpozPrzeliczL	DECIMAL(15),
		TwrOplataSpozPrzeliczM	DECIMAL(15),
		TwrStawkaCukierZmienna	DECIMAL(7,2),
		TrsGIDLp				SMALLINT,
		TrsSubGIDLp				SMALLINT
	)

	DECLARE		@DokGIDTyp				SMALLINT,
				@DokGIDNumer				INT,
				@TwrGIDTyp				SMALLINT,
				@TwrGIDNumer				INT,
				@TwrOplataSpozFlaga		INT,
				@TwrZawartoscCukru		DECIMAL(7,2),
				@TrEIlosc				DECIMAL(11,4),
				@TwrOplataSpozPrzeliczL	DECIMAL(15),
				@TwrOplataSpozPrzeliczM	DECIMAL(15),
				@TwrStawkaCukierZmienna	DECIMAL(7,2),
				@TrsGIDLp				SMALLINT,
				@TrsSubIDLp				SMALLINT,
				@P_11					BIGINT = 0,
				@P_11tmp				decimal(25,2) = 0.00,
				@P_12					decimal(25,2) = 0.00,
				@P_13					decimal(25,2) = 0.00,
				@P_14					BIGINT = 0,
				@P_14tmp				decimal(25,2) = 0.00,
				@P_15					BIGINT = 0,
				@P_15tmp				BIGINT = 0,
				@P_16					decimal(25,2) = 0.00,
				@P_17					decimal(25,2) = 0.00,
				@P_18					decimal(25,2) = 0.00,
				@P_18tmp				decimal(25,2) = 0.00,
				@P_19					BIGINT = 0,
				@P_19tmp				decimal(25,2) = 0.00,
				@P_20					decimal(25,2) = 0.00,
				@P_21					decimal(25,2) = 0.00,
				@P_22					BIGINT = 0,
				@P_22tmp				decimal(25,2) = 0.00,
				@P_23					BIGINT = 0,
				@P_23tmp				BIGINT = 0,
				@P_24					decimal(25,2) = 0.00,
				@P_25					decimal(25,2) = 0.00,
				@P_25tmp				decimal(25,2) = 0.00,
				@P_26					BIGINT = 0,
				@P_26tmp				decimal(25,2) = 0.00,
				@P_27					BIGINT = 0,
				@P_27tmp				BIGINT = 0,
				@P_28					decimal(25,2) = 0.00,
				@P_29					decimal(25,2) = 0.00

	DECLARE kursorTowary CURSOR FOR 
			SELECT * FROM @Towary

	IF (@trnGIDTyp in (1489,2000,2001,2005,2008,2009,2013))
	BEGIN
	INSERT INTO @Towary 
		SELECT A.TrN_SpiTyp, A.TrN_SpiNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna, Trs_GidLp,Trs_SubGIDLp
		FROM cdn.TraElem 
		 JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
		 JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
		 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
		 join cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer		 
		 WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND A.TrN_GIDNumer = @trnGIDNumer AND A.TrN_GIDTyp = @trnGIDTyp;
	END
	ELSE IF (@trnGIDTyp in (2035,2043))
	BEGIN
	INSERT INTO @Towary 
		SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna, Trs_GidLp,Trs_SubGIDLp
		FROM cdn.TraElem 
		 JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
		 JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
		 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
		 join cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer		 
		 WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND B.TrN_GIDNumer = @trnGIDNumer AND B.TrN_GIDTyp = @trnGIDTyp;
	END
	ELSE 
	BEGIN
	INSERT INTO @Towary 
		select TrE_GIDTyp, TrE_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrE_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna, 0,0
		 from cdn.TraElem JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND TrE_GIDNumer = @trnGIDNumer AND TrE_GIDTyp = @trnGIDTyp;
	END
	OPEN kursorTowary
	FETCH NEXT FROM kursorTowary INTO @DokGIDTyp,@DokGIDNumer,@TwrGIDTyp,@TwrGIDNumer,@TwrOplataSpozFlaga,@TwrZawartoscCukru,@TrEIlosc,@TwrOplataSpozPrzeliczL,@TwrOplataSpozPrzeliczM,@TwrStawkaCukierZmienna,@TrsGIDLp,@TrsSubIDLp

	WHILE @@FETCH_STATUS = 0
	BEGIN
		IF ((@TwrOplataSpozFlaga = 3 OR @TwrOplataSpozFlaga = 7) AND @TwrZawartoscCukru BETWEEN 0 AND 5) OR 
		((@TwrOplataSpozFlaga = 1 OR @TwrOplataSpozFlaga = 5) AND @TwrZawartoscCukru &gt; 0 AND @TwrZawartoscCukru &lt;= 5)		--Grupa I
		BEGIN
			SET @P_11tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
		END
		IF (@TwrOplataSpozFlaga in (1,3,5,7) AND @TwrZawartoscCukru &gt; 5)		--Grupa II
		BEGIN
			SET @P_14tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			IF (@stawkaMax = 0)
			BEGIN
				SET @P_15 += (CEILING(@TwrZawartoscCukru) -5) * ( (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM));	
			END
			ELSE
			BEGIN
				SET @P_15 += (@TwrStawkaCukierZmienna /0.05) * ((@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM));	-- ĹÄ…czna liczba mg cukrĂłw bÄ™dÄ…cych nadwyĹĽkÄ… powyĹĽej 5g/100ml	
			END

			--SET @P_18tmp += @TwrStawkaCukierZmienna * @P_14 / 1000;	--v1
		END
		IF (@TwrOplataSpozFlaga in (5, 7, 13, 15, 21, 23))		--Grupa III
		BEGIN
			SET @P_19tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
		END
		IF (@TwrOplataSpozFlaga in (9, 11, 13, 15) AND @TwrZawartoscCukru &gt; 5)		--Grupa IV
		BEGIN
			SET @P_22tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			IF (@stawkaMax = 0)
			BEGIN
				SET @P_23 += (CEILING(@TwrZawartoscCukru) -5) * ( (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM));	
			END
			ELSE
			BEGIN
				SET @P_23 += (@TwrStawkaCukierZmienna /0.05) * ((@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM));	-- ĹÄ…czna liczba mg cukrĂłw bÄ™dÄ…cych nadwyĹĽkÄ… powyĹĽej 5g/100ml
			END
			
			--SET @P_25 += @TwrStawkaCukierZmienna * @P_22 / 1000;		--v1
		END
		IF (@TwrOplataSpozFlaga in (17, 19, 21, 23) AND @TwrZawartoscCukru &gt; 5)		--Grupa V
		BEGIN
			SET @P_26tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			IF (@stawkaMax = 0)
			BEGIN
				SET @P_27 += (CEILING(@TwrZawartoscCukru) -5) * ( (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM));	
			END
			ELSE
			BEGIN
				SET @P_27 += (@TwrStawkaCukierZmienna /0.05) * ((@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM));	-- ĹÄ…czna liczba mg cukrĂłw bÄ™dÄ…cych nadwyĹĽkÄ… powyĹĽej 5g/100ml	
			END
			
			--SET @P_29 += @TwrStawkaCukierZmienna * @P_26 / 1000;	--v1
		END
	FETCH NEXT FROM kursorTowary INTO @DokGIDTyp,@DokGIDNumer,@TwrGIDTyp,@TwrGIDNumer,@TwrOplataSpozFlaga,@TwrZawartoscCukru,@TrEIlosc,@TwrOplataSpozPrzeliczL,@TwrOplataSpozPrzeliczM,@TwrStawkaCukierZmienna,@TrsGIDLp,@TrsSubIDLp
	END
	
	CLOSE kursorTowary
	DEALLOCATE kursorTowary
	-- Grupa I
	SET @P_11 = ROUND(@P_11tmp,0);
	SET @P_12 = CAST(@P_11 AS decimal(25,2)) / 1000*0.50;			-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 1
	SET @P_13 = @P_12;												-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6

	-- Grupa II
	SET @P_14 = ROUND(@P_14tmp,0);	
	SET @P_16 =  CAST(@P_14 AS decimal(25,2)) / 1000 * 0.50;		-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 1
	SET @P_17 =  CAST(@P_15 AS decimal(25,2)) / 1000 * 0.05;			-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 2
	SET @P_18 = @P_16 + @P_17;									-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6

	-- Grupa III
	SET @P_19 = ROUND(@P_19tmp,0);
	SET @P_20 =  CAST(@P_19 AS decimal(25,2)) / 1000 * 0.10;		-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.3
	SET @P_21 = @P_20;												-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6

	-- Grupa IV
	SET @P_22 = ROUND(@P_22tmp,0);	
	SET @P_24 =  CAST(@P_23 AS decimal(25,2)) / 1000 * 0.05;		-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 2
	SET @P_25 = @P_24		--v2

	-- Grupa V
	SET @P_26 = ROUND(@P_26tmp,0);	
	SET @P_28 =  CAST(@P_27 AS decimal(25,2)) / 1000 * 0.05;		-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 2
	SET @P_29 = @P_28		--v2


	INSERT INTO @Wynik 
		VALUES (@DokGIDTyp,@DokGIDNumer,@P_11,@P_12,@P_13,@P_14,@P_15,@P_16,@P_17,@P_18,@P_19,@P_20,@P_21,@P_22,@P_23,@P_24,@P_25,@P_26,@P_27,@P_28,@P_29);
	
	RETURN; 

END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="CUKOplataAnalityczna2"></A><PRE>
          <FONT SIZE="2"><I>/* CUKOplataAnalityczna2 */</I><BR>
CREATE FUNCTION CDN.CUKOplataAnalityczna2 (
@trnGIDTyp		SMALLINT, 
@trnGIDNumer    INT,
@stawkaMax		SMALLINT			--NadwyĹĽka cukru liczona wg stawki max
)
RETURNS @Wynik TABLE (
		DokGIDTyp   SMALLINT,
		DokGIDNumer INT,
		P_11		BIGINT,
		P_12		decimal(25,2),
		P_13		decimal(25,2),
		P_14		decimal(25,2),
		P_15		decimal(25,2),
		P_16		BIGINT,
		P_17		BIGINT,
		P_18		decimal(25,2),
		P_19		decimal(25,2),
		P_20		decimal(25,2),
		P_21		decimal(25,2),
		P_22		decimal(25,2),
		P_23		BIGINT,
		P_24		decimal(25,2),
		P_25		decimal(25,2),
		P_26		decimal(25,2),
		P_27		decimal(25,2),
		P_28		BIGINT,
		P_29		BIGINT,
		P_30		decimal(25,2),
		P_31		decimal(25,2),
		P_32		decimal(25,2),
		P_33		decimal(25,2),
		P_34		BIGINT,
		P_35		BIGINT,
		P_36		decimal(25,2),
		P_37		decimal(25,2),
		P_38		decimal(25,2),
		P_39		decimal(25,2) 
)

BEGIN
	DECLARE @Towary Table (
		DokGIDTyp				SMALLINT,
		DokGIDNumer				INT,
		TwrGIDTyp				SMALLINT,
		TwrGIDNumer				INT,
		TwrOplataSpozFlaga		INT,
		TwrZawartoscCukru		DECIMAL(7,2),
		TrEIlosc				DECIMAL(11,4),
		TwrOplataSpozPrzeliczL	DECIMAL(15),
		TwrOplataSpozPrzeliczM	DECIMAL(15),
		TwrStawkaCukierZmienna	DECIMAL(7,2),
		TrsGIDLp				SMALLINT,
		TrsSubGIDLp				SMALLINT
	)

	DECLARE		@DokGIDTyp				SMALLINT,
				@DokGIDNumer				INT,
				@TwrGIDTyp				SMALLINT,
				@TwrGIDNumer				INT,
				@TwrOplataSpozFlaga		INT,
				@TwrZawartoscCukru		DECIMAL(7,2),
				@TrEIlosc				DECIMAL(11,4),
				@TwrOplataSpozPrzeliczL	DECIMAL(15),
				@TwrOplataSpozPrzeliczM	DECIMAL(15),
				@TwrStawkaCukierZmienna	DECIMAL(7,2),
				@TrsGIDLp				SMALLINT,
				@TrsSubIDLp				SMALLINT,
				@P_11					BIGINT = 0,
				@P_11tmp				decimal(25,2) = 0.00,
				@P_12					decimal(25,2) = 0.00,
				@P_13					decimal(25,2) = 0.00,
				@P_14					decimal(25,2) = 0.00,
				@P_14Z					decimal(25,2) = 0.00,
				@P_14tmp2				BIGINT = 0,
				@P_15					decimal(25,2) = 0.00,
				@P_15tmp				BIGINT = 0,
				@P_16					decimal(25,2) = 0.00,
				@P_16tmp				decimal(25,2) = 0.00,
				@P_17					BIGINT = 0,
				@P_17tmp				decimal(25,2) = 0.00,
				@P_18					decimal(25,2) = 0.00,
				@P_18tmp				decimal(25,2) = 0.00,
				@P_19					decimal(25,2) = 0.00,
				@P_19tmp				decimal(25,2) = 0.00,
				@P_20					decimal(25,2) = 0.00,
				@P_21					decimal(25,2) = 0.00,
				@P_21X1					decimal(25,2) = 0.00,
				@P_21X2					decimal(25,2) = 0.00,
				@P_21OS					decimal(25,2) = 0.00,
				@P_21OZ					decimal(25,2) = 0.00,
				@P_22					decimal(25,2) = 0.00,
				@P_22tmp				decimal(25,2) = 0.00,
				@P_23					BIGINT = 0,
				@P_23tmp				decimal(25,2) = 0.00,
				@P_24					decimal(25,2) = 0.00,
				@P_25					decimal(25,2) = 0.00,
				@P_25tmp				decimal(25,2) = 0.00,
				@P_26					decimal(25,2) = 0.00,
				@P_26Z					decimal(25,2) = 0.00,
				@P_27					decimal(25,2) = 0.00,
				@P_27tmp				BIGINT = 0,
				@P_28					BIGINT = 0,
				@P_28tmp				decimal(25,2) = 0.00,
				@P_29					decimal(25,2) = 0.00,
				@P_29tmp				decimal(25,2) = 0.00,
				@P_30					decimal(25,2) = 0.00,	
				@P_31					decimal(25,2) = 0.00,
				@P_32					decimal(25,2) = 0.00,
				@P_32X1					decimal(25,2) = 0.00,
				@P_32X2					decimal(25,2) = 0.00,
				@P_33					decimal(25,2) = 0.00,
				@P_34					decimal(25,2) = 0.00,
				@P_34tmp				decimal(25,2) = 0.00,
				@P_35					BIGINT = 0,
				@P_35tmp				decimal(25,2) = 0.00,
				@P_36					decimal(25,2) = 0.00,
				@P_37					decimal(25,2) = 0.00,
				@P_38					decimal(25,2) = 0.00,
				@P_38X2					decimal(25,2) = 0.00,
				@P_39					decimal(25,2) = 0.00

	DECLARE kursorTowary CURSOR FOR 
			SELECT * FROM @Towary

	IF (@trnGIDTyp in (1489,2000,2001,2005,2008,2009,2013))
	BEGIN
	INSERT INTO @Towary 
		SELECT A.TrN_SpiTyp, A.TrN_SpiNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna, Trs_GidLp,Trs_SubGIDLp
		FROM cdn.TraElem 
		 JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
		 JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
		 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
		 join cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer		 
		 WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND A.TrN_GIDNumer = @trnGIDNumer AND A.TrN_GIDTyp = @trnGIDTyp;
	END
	ELSE IF (@trnGIDTyp in (2035,2043))
	BEGIN
	INSERT INTO @Towary 
		SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna, Trs_GidLp,Trs_SubGIDLp
		FROM cdn.TraElem 
		 JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
		 JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
		 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
		 join cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer		 
		 WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND B.TrN_GIDNumer = @trnGIDNumer AND B.TrN_GIDTyp = @trnGIDTyp;
	END
	ELSE 
	BEGIN
	INSERT INTO @Towary 
		select TrE_GIDTyp, TrE_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrE_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna, 0,0
		 from cdn.TraElem JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND TrE_GIDNumer = @trnGIDNumer AND TrE_GIDTyp = @trnGIDTyp;
	END
	OPEN kursorTowary
	FETCH NEXT FROM kursorTowary INTO @DokGIDTyp,@DokGIDNumer,@TwrGIDTyp,@TwrGIDNumer,@TwrOplataSpozFlaga,@TwrZawartoscCukru,@TrEIlosc,@TwrOplataSpozPrzeliczL,@TwrOplataSpozPrzeliczM,@TwrStawkaCukierZmienna,@TrsGIDLp,@TrsSubIDLp

	WHILE @@FETCH_STATUS = 0
	BEGIN
		IF ((@TwrOplataSpozFlaga = 3 OR @TwrOplataSpozFlaga = 7) AND @TwrZawartoscCukru BETWEEN 0 AND 5) OR 
		((@TwrOplataSpozFlaga = 1 OR @TwrOplataSpozFlaga = 5) AND @TwrZawartoscCukru &gt; 0 AND @TwrZawartoscCukru &lt;= 5)		--Grupa I
		BEGIN
			IF (@TrEIlosc &gt; 0)
			BEGIN
				SET @P_11tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			END;
			IF (@TrEIlosc &lt; 0)
			BEGIN
				SET @P_14Z += (ABS(@TrEIlosc)) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			END;
		END

		IF (@TwrOplataSpozFlaga in (1,3,5,7) AND @TwrZawartoscCukru &gt; 5)		--Grupa II
		BEGIN
			IF (@TrEIlosc &gt; 0)
			BEGIN
				SET @P_16tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
				IF (@stawkaMax in (0,2))
				BEGIN
					SET @P_17tmp += (CEILING(@TwrZawartoscCukru) -5) * ( (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM)/1000);	
				END
				ELSE
				BEGIN
					SET @P_17tmp += (@TwrStawkaCukierZmienna /0.05) * ((@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM)/1000);		
				END
			END;
			IF (@TrEIlosc &lt; 0)
			BEGIN
				SET @P_21X1 += ABS(@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
				IF (@stawkaMax in (1,2))
				BEGIN
					SET @P_21X2 += (@TwrStawkaCukierZmienna /0.05) * ((ABS(@TrEIlosc)) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM) /1000);		
				END
				ELSE
				BEGIN
					SET @P_21X2 += (CEILING(@TwrZawartoscCukru) -5) *((ABS(@TrEIlosc)) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM) /1000);	
				END
			END
		END

		IF (@TwrOplataSpozFlaga in (5, 7, 13, 15, 21, 23))		--Grupa III
		BEGIN
			IF (@TrEIlosc &gt; 0)
			BEGIN
				SET @P_23tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			END;
			IF (@TrEIlosc &lt; 0)
			BEGIN
				SET @P_26Z += (ABS(@TrEIlosc)) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			END;
		END

		IF (@TwrOplataSpozFlaga in (9, 11, 13, 15) AND @TwrZawartoscCukru &gt; 5)		--Grupa IV
		BEGIN
			IF (@TrEIlosc &gt; 0)
			BEGIN
				SET @P_28tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);

				IF (@stawkaMax in (0,2))
				BEGIN
					SET @P_29tmp += (CEILING(@TwrZawartoscCukru) -5) * ( (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM)/1000);	
				END
				ELSE
				BEGIN
					SET @P_29tmp += (@TwrStawkaCukierZmienna /0.05) * ((@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM)/1000);		
				END
			END;

			IF (@TrEIlosc &lt; 0)
			BEGIN
				IF (@stawkaMax in (1,2))
				BEGIN
					SET @P_32X2 += (@TwrStawkaCukierZmienna /0.05) * ((ABS(@TrEIlosc)) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM) /1000);		
				END
				ELSE
				BEGIN
					SET @P_32X2 += (CEILING(@TwrZawartoscCukru) -5) *((ABS(@TrEIlosc)) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM) /1000);	
				END
			END
		END

		IF (@TwrOplataSpozFlaga in (17, 19, 21, 23) AND @TwrZawartoscCukru &gt; 5)		--Grupa V
		BEGIN
			IF (@TrEIlosc &gt; 0)
			BEGIN
				SET @P_34tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
				IF (@stawkaMax in (0,2))
				BEGIN
					SET @P_35tmp += (CEILING(@TwrZawartoscCukru) -5) * ( (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM)/1000);	
				END
				ELSE
				BEGIN
					SET @P_35tmp += (@TwrStawkaCukierZmienna /0.05) * ((@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM)/1000);		
				END
			END;

			IF (@TrEIlosc &lt; 0)
			BEGIN
				IF (@stawkaMax in (1,2))
				BEGIN
					SET @P_38X2 += (@TwrStawkaCukierZmienna /0.05) * ((ABS(@TrEIlosc)) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM) /1000);		
				END
				ELSE
				BEGIN
					SET @P_38X2 += (CEILING(@TwrZawartoscCukru) -5) *((ABS(@TrEIlosc)) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM) /1000);	
				END
			END
		END
	FETCH NEXT FROM kursorTowary INTO @DokGIDTyp,@DokGIDNumer,@TwrGIDTyp,@TwrGIDNumer,@TwrOplataSpozFlaga,@TwrZawartoscCukru,@TrEIlosc,@TwrOplataSpozPrzeliczL,@TwrOplataSpozPrzeliczM,@TwrStawkaCukierZmienna,@TrsGIDLp,@TrsSubIDLp
	END
	
	CLOSE kursorTowary
	DEALLOCATE kursorTowary
	-- Grupa I
	SET @P_11 = ROUND(@P_11tmp,0);									-- Liczba mililitrĂłw napojĂłw grupy I
	SET @P_12 = CAST(@P_11 AS decimal(25,2)) / 1000*0.50;			-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 1
	SET @P_13 = @P_12;												-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6
	SET @P_14tmp2 = ROUND(@P_14Z,0);
	SET @P_14 = CAST(@P_14tmp2 AS decimal(25,2)) / 1000 * 0.50;		-- Kwota opĹ‚aty naliczonej od napojĂłw zwrĂłconych
	SET @P_15 = @P_13 - @P_14;										-- Kwota opĹ‚aty po pomniejszeniu

	-- Grupa II
	SET @P_16 = ROUND(@P_16tmp,0);									-- Liczba mililitrĂłw napojĂłw grupy II
	SET @P_17 = ROUND(@P_17tmp,0);									-- ĹÄ…czna liczba mg cukrĂłw bÄ™dÄ…cych nadwyĹĽkÄ… powyĹĽej 5g/100ml
	SET @P_18 =  CAST(@P_16 AS decimal(25,2)) / 1000 * 0.50;		-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 1
	SET @P_19 =  CAST(@P_17 AS decimal(25,2)) * 0.05;				-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 2
	SET @P_20 = @P_18 + @P_19;										-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6
	SET @P_21OS = ROUND(@P_21X1,0) / 1000 * 0.50;
	SET @P_21OZ = ROUND(@P_21X2,0) * 0.05;
	SET @P_21 = @P_21OS + @P_21OZ									-- Kwota opĹ‚aty naliczonej od napojĂłw zwrĂłconych
	SET @P_22 = @P_20 - @P_21;										-- Kwota opĹ‚aty po pomniejszeniu
	-- Grupa III
	SET @P_23 = ROUND(@P_23tmp,0);									-- Liczba mililitrĂłw napojĂłw grupy III
	SET @P_24 =  CAST(@P_23 AS decimal(25,2)) / 1000 * 0.10;		-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.3
	SET @P_25 = @P_24;												-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6
	SET @P_26 = @P_26Z / 1000 * 0.10;								-- Kwota opĹ‚aty naliczonej od napojĂłw zwrĂłconych
	SET @P_27 = @P_25 - @P_26;										-- Kwota opĹ‚aty po pomniejszeniu

	-- Grupa IV
	SET @P_28 = ROUND(@P_28tmp,0);									-- Liczba mililitrĂłw napojĂłw grupy IV
	SET @P_29 = ROUND(@P_29tmp,0);									-- ĹÄ…czna liczba mg cukrĂłw bÄ™dÄ…cych nadwyĹĽkÄ… powyĹĽej 5g/100ml
	SET @P_30 = CAST(@P_29 AS decimal(25,2)) * 0.05					-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 1
	SET @P_31 = @P_30;												-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6
	SET @P_32 = ROUND(@P_32X2,0) * 0.05;							-- Kwota opĹ‚aty naliczonej od napojĂłw zwrĂłconych
	SET @P_33 = @P_31 - @P_32;										-- Kwota opĹ‚aty po pomniejszeniu

	-- Grupa V
	SET @P_34 = ROUND(@P_34tmp,0);									-- Liczba mililitrĂłw napojĂłw grupy V
	SET @P_35 = ROUND(@P_35tmp,0);									-- ĹÄ…czna liczba mg cukrĂłw bÄ™dÄ…cych nadwyĹĽkÄ… powyĹĽej 5g/100ml
	SET @P_36 = CAST(@P_35 AS decimal(25,2)) * 0.05;				-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 1
	SET @P_37 = @P_36;												-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6
	SET @P_38 =  ROUND(@P_38X2,0) * 0.05;							-- Kwota opĹ‚aty naliczonej od napojĂłw zwrĂłconych
	SET @P_39 = @P_37 - @P_38;										-- Kwota opĹ‚aty po pomniejszeniu

	INSERT INTO @Wynik 
		VALUES (@DokGIDTyp,@DokGIDNumer,@P_11,@P_12,@P_13,@P_14,@P_15,@P_16,@P_17,@P_18,@P_19,@P_20,@P_21,@P_22,@P_23,@P_24,@P_25,@P_26,@P_27,@P_28,@P_29,
		@P_30,@P_31,@P_32,@P_33,@P_34,@P_35,@P_36,@P_37,@P_38,@P_39);
	
	RETURN; 

END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="CUKOplataDeklaracja"></A><PRE>
          <FONT SIZE="2"><I>/* CUKOplataDeklaracja */</I><BR>
CREATE FUNCTION CDN.CUKOplataDeklaracja (
@typDaty    SMALLINT,			--typ daty (0- data sprzedaĹĽy, 1- data wystawienia)
@dataOd    	INT,				--Data od ktĂłrej obowiÄ…zuje okres sporzÄ…dzenia CUK
@dataDo		INT,				--Data do ktĂłrej obowiÄ…zuje okres sporzÄ…dzenia CUK
@stawkaMax	SMALLINT,			--NadwyĹĽka cukru liczona wg stawki max
@dataOryginalu SMALLINT			--0- ujÄ™cie dokumentĂłw wg daty wĹ‚asnej, 1- ujÄ™cie dokumentĂłw wg daty oryginaĹ‚u
)
RETURNS @Wynik TABLE (
		P_11		BIGINT,
		P_12		decimal(25,2),
		P_13		decimal(25,2),
		P_14		BIGINT,
		P_15		BIGINT,
		P_16		decimal(25,2),
		P_17		decimal(25,2),
		P_18		decimal(25,2),
		P_19		BIGINT,
		P_20		decimal(25,2),
		P_21		decimal(25,2),
		P_22		BIGINT,
		P_23		BIGINT,
		P_24		decimal(25,2),
		P_25		decimal(25,2),
		P_26		BIGINT,
		P_27		BIGINT,
		P_28		decimal(25,2),
		P_29		decimal(25,2),
		P_90		decimal(25,2),
		P_91 		decimal(25,2)
)

BEGIN
	DECLARE @Towary Table (
		DokGIDTyp				SMALLINT,
		DokGIDNumer				INT,
		TwrGIDTyp				SMALLINT,
		TwrGIDNumer				INT,
		TwrOplataSpozFlaga		INT,
		TwrZawartoscCukru		DECIMAL(7,2),
		TrEIlosc				DECIMAL(11,4),
		TwrOplataSpozPrzeliczL	DECIMAL(15),
		TwrOplataSpozPrzeliczM	DECIMAL(15),
		TwrStawkaCukierZmienna	DECIMAL(7,2),
		TrsGIDLp				SMALLINT,
		TrsSubGIDLp				SMALLINT
	)

	DECLARE		@DokGIDTyp				SMALLINT,
				@DokGIDNumer				INT,
				@TwrGIDTyp				SMALLINT,
				@TwrGIDNumer				INT,
				@TwrOplataSpozFlaga		INT,
				@TwrZawartoscCukru		DECIMAL(7,2),
				@TrEIlosc				DECIMAL(11,4),
				@TwrOplataSpozPrzeliczL	DECIMAL(15),
				@TwrOplataSpozPrzeliczM	DECIMAL(15),
				@TwrStawkaCukierZmienna	DECIMAL(7,2),
				@TrsGIDLp				SMALLINT,
				@TrsSubIDLp				SMALLINT,
				@P_11					BIGINT = 0,
				@P_11tmp				decimal(25,2) = 0.00,
				@P_12					decimal(25,2) = 0.00,
				@P_13					decimal(25,2) = 0.00,
				@P_14					BIGINT = 0,
				@P_14tmp				decimal(25,2) = 0.00,
				@P_15					BIGINT = 0,
				@P_15tmp				decimal(25,2) = 0.00,
				@P_16					decimal(25,2) = 0.00,
				@P_17					decimal(25,2) = 0.00,
				@P_18					decimal(25,2) = 0.00,
				@P_18tmp				decimal(25,2) = 0.00,
				@P_19					BIGINT = 0,
				@P_19tmp				decimal(25,2) = 0.00,
				@P_20					decimal(25,2) = 0.00,
				@P_21					decimal(25,2) = 0.00,
				@P_22					BIGINT = 0,
				@P_22tmp				decimal(25,2) = 0.00,
				@P_23					BIGINT = 0,
				@P_23tmp				decimal(25,2) = 0.00,
				@P_24					decimal(25,2) = 0.00,
				@P_25					decimal(25,2) = 0.00,
				@P_25tmp				decimal(25,2) = 0.00,
				@P_26					BIGINT = 0,
				@P_26tmp				decimal(25,2) = 0.00,
				@P_27					BIGINT = 0,
				@P_27tmp				decimal(25,2) = 0.00,
				@P_28					decimal(25,2) = 0.00,
				@P_29					decimal(25,2) = 0.00,
				@P_90					decimal(25,2) = 0.00,
				@P_90tmp				decimal(25,2) = 0.00,
				@P_91					decimal(25,2) = 0.00

	DECLARE kursorTowary CURSOR FOR 
			SELECT * FROM @Towary
	
	IF (@dataOryginalu = 0)
	BEGIN
		IF  (@typDaty = 0) 
		BEGIN
			INSERT INTO @Towary 
			select TrE_GIDTyp, TrE_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrE_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,0,0
				 from cdn.TraElem JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer 
				 LEFT JOIN cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 
				 AND ((A.TrN_GIDTyp in (2033,2035,2037,2036,2041,2043,2045,2044) AND A.Trn_Data3 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5) 
				 OR (A.TrN_SpiTyp = 0 AND A.TrN_GIDTyp in (2034,2042) AND A.Trn_Data3 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5)
				 OR (A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (1489,2000,2001,2005,2008,2009,2013) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND B.Trn_Data3 BETWEEN @dataOd AND @dataDo))
				 UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,Trs_GidLp,Trs_SubGIDLp
				FROM cdn.TraElem 
				 JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
				 join cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer		 
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5 AND B.TrN_GIDTyp in (2035,2043) 
				AND B.Trn_Data3 BETWEEN @dataOd AND @dataDo;
		END
		ELSE 
		BEGIN
			INSERT INTO @Towary 
			select TrE_GIDTyp, TrE_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrE_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,0,0
				 from cdn.TraElem JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer 
				 LEFT JOIN cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
				 WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 
				 AND ((A.TrN_GIDTyp in (2033,2035,2037,2036,2041,2043,2045,2044) AND A.Trn_Data2 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5) 
				 OR (A.TrN_SpiTyp = 0 AND A.TrN_GIDTyp in (2034,2042) AND A.Trn_Data2 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5) 
				 OR (A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (1489,2000,2001,2005,2008,2009,2013) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND B.Trn_Data2 BETWEEN @dataOd AND @dataDo))
				 UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,Trs_GidLp,Trs_SubGIDLp
				FROM cdn.TraElem 
				 JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
				 join cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer		 
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5 AND B.TrN_GIDTyp in (2035,2043) 
				AND B.Trn_Data2 BETWEEN @dataOd AND @dataDo;
		END
	END
	ELSE 
	BEGIN
		IF  (@typDaty = 0) 
		BEGIN
			INSERT INTO @Towary 
			select TrE_GIDTyp, TrE_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,Trs_GidLp,Trs_SubGIDLp
				 from cdn.TraElem JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer 
				 LEFT JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 LEFT JOIN cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
				 LEFT JOIN cdn.TraNag D ON D.TrN_GIDNumer = B.TrN_ZwrNumer AND D.TrN_GIDTyp = B.TrN_ZwrTyp
				 WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 
				 AND ((A.TrN_GIDTyp in (2033,2035,2037,2036,2043) AND A.Trn_Data3 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5) 
				  OR (A.TrN_SpiTyp = 0 AND A.TrN_GIDTyp in (2034) AND A.Trn_Data3 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5) 
				 OR (A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (1489,2000,2001,2005,2008) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND B.Trn_Data3 BETWEEN @dataOd AND @dataDo)
				 OR (A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (2009,2013) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND B.Trn_Data3 BETWEEN @dataOd AND @dataDo AND d.TrN_GIDTyp IS NULL))
			UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,Trs_GidLp,Trs_SubGIDLp
				FROM cdn.TraElem 
				JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
				 join cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
				 LEFT Join cdn.TraNag D on B.TrN_ZwrTyp = D.TrN_GIDTyp and B.TrN_ZwrNumer = D.TrN_GIDNumer
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5 AND 
				((B.TrN_GIDTyp = 2035 AND B.Trn_Data3 BETWEEN @dataOd AND @dataDo) OR (B.TrN_GIDTyp = 2043 AND D.Trn_Data3 BETWEEN @dataOd AND @dataDo)) 
			UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, C.TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,C.Trs_GidLp,C.Trs_SubGIDLp
				FROM cdn.TraElem 
				 JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraSElem C ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
				 join cdn.tranag B on B.TrN_ZwrNumer = A.TrN_GIDNumer		 
				 Join cdn.TraNag D on D.TrN_GIDTyp= C.TrS_OrgTyp and D.TrN_GIDNumer = C.TrS_OrgNumer
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND ((B.TrN_SpiTyp = 0 AND B.TrN_GIDTyp in (2041,2043,2045,2044) AND A.Trn_Data3 BETWEEN @dataOd AND @dataDo AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5)
				OR (A.TrN_SpiTyp = 0 AND A.TrN_GIDTyp in (2034,2042) AND C.TrS_GIDNumer &lt;&gt; C.TrS_OrgNumer  AND D.Trn_Data3 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5))--spinacze nagĹ‚Ăłwkowe korekt i PAK
			UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, C.TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,C.Trs_GidLp,C.Trs_SubGIDLp
				FROM cdn.TraElem 
					JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
					JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer	
					JOIN cdn.TraSElem C ON TrE_GIDTyp=C.TrS_GIDTyp AND TrE_GIDNumer=C.TrS_GIDNumer AND TrE_GIDLp=C.TrS_GIDLp
					join cdn.tranag B on C.TrS_GIDNumer = B.TrN_GIDNumer
					LEFT JOIN cdn.TraNag D ON D.TrN_GIDTyp= C.TrS_OrgTyp and D.TrN_GIDNumer = C.TrS_OrgNumer
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND (B.TrN_SpiTyp &lt;&gt; 0 AND B.TrN_GIDTyp in (2041,2043,2045,2044) AND D.Trn_Data3 BETWEEN @dataOd AND @dataDo AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5) --spinacze elementĂłw korekt i korekty z datÄ… oryginaĹ‚u
			UNION ALL
			SELECT DISTINCT TrE_GIDTyp, TrE_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, C.TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,C.TrS_GIDLp,C.Trs_SubGIDLp
					FROM cdn.TraNag A 
					JOIN cdn.TraElem ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer 
					JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
					LEFT JOIN cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
					JOIN cdn.TraSElem C ON C.TrS_GIDNumer = TrE_GIDNumer AND C.TrS_GIDTyp = TrE_GIDTyp AND C.TrS_GIDLp = TrE_GIDLp
					LEFT JOIN cdn.TraNag D ON D.TrN_GIDNumer = B.TrN_ZwrNumer AND D.TrN_GIDTyp = B.TrN_ZwrTyp
					WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND
					(A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (1489,2000,2001,2005,2008,2009,2013) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND D.Trn_Data3 BETWEEN @dataOd AND @dataDo
					AND C.TrS_GIDNumer &lt;&gt; C.TrS_OrgNumer)
		END
		ELSE 
		BEGIN
			INSERT INTO @Towary 
			select TrE_GIDTyp, TrE_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,Trs_GidLp,Trs_SubGIDLp
				 from cdn.TraElem JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer 
				 LEFT JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 LEFT JOIN cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
				 LEFT JOIN cdn.TraNag D ON D.TrN_GIDNumer = B.TrN_ZwrNumer AND D.TrN_GIDTyp = B.TrN_ZwrTyp
				 WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 
				 AND ((A.TrN_GIDTyp in (2033,2035,2037,2036,2043) AND A.Trn_Data2 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5) 
				  OR (A.TrN_SpiTyp = 0 AND A.TrN_GIDTyp in (2034) AND A.Trn_Data2 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5) 
				 OR (A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (1489,2000,2001,2005,2008) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND B.Trn_Data2 BETWEEN @dataOd AND @dataDo)
				 OR (A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (2009,2013) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND B.Trn_Data2 BETWEEN @dataOd AND @dataDo AND d.TrN_GIDTyp IS NULL))
			UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,Trs_GidLp,Trs_SubGIDLp
				FROM cdn.TraElem 
				JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
				 join cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
				 LEFT Join cdn.TraNag D on B.TrN_ZwrTyp = D.TrN_GIDTyp and B.TrN_ZwrNumer = D.TrN_GIDNumer
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5 AND 
				((B.TrN_GIDTyp = 2035 AND B.Trn_Data2 BETWEEN @dataOd AND @dataDo) OR (B.TrN_GIDTyp = 2043 AND D.Trn_Data2 BETWEEN @dataOd AND @dataDo)) 
			UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, C.TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,C.Trs_GidLp,C.Trs_SubGIDLp
				FROM cdn.TraElem 
				 JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraSElem C ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
				 join cdn.tranag B on B.TrN_ZwrNumer = A.TrN_GIDNumer		 
				 Join cdn.TraNag D on D.TrN_GIDTyp= C.TrS_OrgTyp and D.TrN_GIDNumer = C.TrS_OrgNumer
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND ((B.TrN_SpiTyp = 0 AND B.TrN_GIDTyp in (2041,2043,2045,2044) AND A.Trn_Data2 BETWEEN @dataOd AND @dataDo AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5)
				OR (A.TrN_SpiTyp = 0 AND A.TrN_GIDTyp in (2034,2042) AND C.TrS_GIDNumer &lt;&gt; C.TrS_OrgNumer  AND D.Trn_Data2 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5))--spinacze nagĹ‚Ăłwkowe korekt i PAK
			UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, C.TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,C.Trs_GidLp,C.Trs_SubGIDLp
				FROM cdn.TraElem 
					JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
					JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer	
					JOIN cdn.TraSElem C ON TrE_GIDTyp=C.TrS_GIDTyp AND TrE_GIDNumer=C.TrS_GIDNumer AND TrE_GIDLp=C.TrS_GIDLp
					join cdn.tranag B on C.TrS_GIDNumer = B.TrN_GIDNumer
					LEFT JOIN cdn.TraNag D ON D.TrN_GIDTyp= C.TrS_OrgTyp and D.TrN_GIDNumer = C.TrS_OrgNumer
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND (B.TrN_SpiTyp &lt;&gt; 0 AND B.TrN_GIDTyp in (2041,2043,2045,2044) AND D.Trn_Data2 BETWEEN @dataOd AND @dataDo AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5) --spinacze elementĂłw korekt i korekty z datÄ… oryginaĹ‚u
			UNION ALL
			SELECT DISTINCT TrE_GIDTyp, TrE_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, C.TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,C.TrS_GIDLp,C.Trs_SubGIDLp
					FROM cdn.TraNag A 
					JOIN cdn.TraElem ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer 
					JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
					LEFT JOIN cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
					JOIN cdn.TraSElem C ON C.TrS_GIDNumer = TrE_GIDNumer AND C.TrS_GIDTyp = TrE_GIDTyp AND C.TrS_GIDLp = TrE_GIDLp
					LEFT JOIN cdn.TraNag D ON D.TrN_GIDNumer = B.TrN_ZwrNumer AND D.TrN_GIDTyp = B.TrN_ZwrTyp
					WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND
					(A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (1489,2000,2001,2005,2008,2009,2013) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND D.Trn_Data2 BETWEEN @dataOd AND @dataDo
					AND C.TrS_GIDNumer &lt;&gt; C.TrS_OrgNumer)
		END
	END

	OPEN kursorTowary
	FETCH NEXT FROM kursorTowary INTO @DokGIDTyp,@DokGIDNumer,@TwrGIDTyp,@TwrGIDNumer,@TwrOplataSpozFlaga,@TwrZawartoscCukru,@TrEIlosc,@TwrOplataSpozPrzeliczL,@TwrOplataSpozPrzeliczM,@TwrStawkaCukierZmienna,@TrsGIDLp,@TrsSubIDLp

	WHILE @@FETCH_STATUS = 0
	BEGIN
		IF ((@TwrOplataSpozFlaga = 3 OR @TwrOplataSpozFlaga = 7) AND @TwrZawartoscCukru BETWEEN 0 AND 5) OR 
		((@TwrOplataSpozFlaga = 1 OR @TwrOplataSpozFlaga = 5) AND @TwrZawartoscCukru &gt; 0 AND @TwrZawartoscCukru &lt;= 5)		--Grupa I
		BEGIN
			SET @P_11tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
		END
		IF (@TwrOplataSpozFlaga in (1,3,5,7) AND @TwrZawartoscCukru &gt; 5)		--Grupa II
		BEGIN
			SET @P_14tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			IF (@stawkaMax = 0)
			BEGIN
				SET @P_15tmp += (CEILING(@TwrZawartoscCukru) -5) * ( (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM));	
			END
			ELSE
			BEGIN
				SET @P_15tmp += (@TwrStawkaCukierZmienna /0.05) * ((@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM));	-- ĹÄ…czna liczba mg cukrĂłw bÄ™dÄ…cych nadwyĹĽkÄ… powyĹĽej 5g/100ml	
			END	

			--SET @P_18tmp += @TwrStawkaCukierZmienna * @P_14 / 1000;	--v1
		END
		IF (@TwrOplataSpozFlaga in (5, 7, 13, 15, 21, 23))		--Grupa III
		BEGIN
			SET @P_19tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			IF ((@TwrOplataSpozFlaga = 5 AND @TwrZawartoscCukru = 0) OR (@TwrOplataSpozFlaga in (13,21) AND @TwrZawartoscCukru &lt;= 5))
			BEGIN
				SET @P_90tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			END
		END
		IF (@TwrOplataSpozFlaga in (9, 11, 13, 15) AND @TwrZawartoscCukru &gt; 5)		--Grupa IV
		BEGIN
			SET @P_22tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			IF (@stawkaMax = 0)
			BEGIN
				SET @P_23tmp += (CEILING(@TwrZawartoscCukru) -5) * ( (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM));	
			END
			ELSE
			BEGIN
				SET @P_23tmp += (@TwrStawkaCukierZmienna /0.05) * ((@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM));	-- ĹÄ…czna liczba mg cukrĂłw bÄ™dÄ…cych nadwyĹĽkÄ… powyĹĽej 5g/100ml
			END
			--SET @P_25 += @TwrStawkaCukierZmienna * @P_22 / 1000;		--v1
		END
		IF (@TwrOplataSpozFlaga in (17, 19, 21, 23) AND @TwrZawartoscCukru &gt; 5)		--Grupa V
		BEGIN
			SET @P_26tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			IF (@stawkaMax = 0)
			BEGIN
				SET @P_27tmp += (CEILING(@TwrZawartoscCukru) -5) * ( (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM));	
			END
			ELSE
			BEGIN
				SET @P_27tmp += (@TwrStawkaCukierZmienna /0.05) * ((@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM));	-- ĹÄ…czna liczba mg cukrĂłw bÄ™dÄ…cych nadwyĹĽkÄ… powyĹĽej 5g/100ml	
			END	
			--SET @P_29 += @TwrStawkaCukierZmienna * @P_26 / 1000;	--v1
		END
	FETCH NEXT FROM kursorTowary INTO @DokGIDTyp,@DokGIDNumer,@TwrGIDTyp,@TwrGIDNumer,@TwrOplataSpozFlaga,@TwrZawartoscCukru,@TrEIlosc,@TwrOplataSpozPrzeliczL,@TwrOplataSpozPrzeliczM,@TwrStawkaCukierZmienna,@TrsGIDLp,@TrsSubIDLp
	END
	
	CLOSE kursorTowary
	DEALLOCATE kursorTowary
	-- Grupa I
	SET @P_11 = ROUND(@P_11tmp,0);
	SET @P_12 = CAST(@P_11 AS decimal(25,2)) / 1000*0.50;			-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 1
	SET @P_13 = @P_12;												-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6

	-- Grupa II				
	SET @P_14 = ROUND(@P_14tmp,0);	
	SET @P_15 = ROUND(@P_15tmp,0);		
	SET @P_16 =  CAST(@P_14 AS decimal(25,2)) / 1000 * 0.50;		-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 1
	SET @P_17 =  CAST(@P_15 AS decimal(25,2)) / 1000 * 0.05;			-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 2
	SET @P_18 = @P_16 + @P_17;									-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6

	-- Grupa III
	SET @P_19 = ROUND(@P_19tmp,0);
	SET @P_20 =  CAST(@P_19 AS decimal(25,2)) / 1000 * 0.10;		-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.3
	SET @P_21 = @P_20;												-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6

	-- Grupa IV	
	SET @P_22 = ROUND(@P_22tmp,0);
	SET @P_23 = ROUND(@P_23tmp,0);
	SET @P_24 =  CAST(@P_23 AS decimal(25,2)) / 1000 * 0.05;		-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 2
	SET @P_25 = @P_24		--v2

	-- Grupa V	
	SET @P_26 = ROUND(@P_26tmp,0);
	SET @P_27 = ROUND(@P_27tmp,0);
	SET @P_28 =  CAST(@P_27 AS decimal(25,2)) / 1000 * 0.05;		-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 2
	SET @P_29 = @P_28		--v2
	
	SET @P_90 = (@P_11 + @P_14 + @P_22 + @P_26 + @P_90tmp)/1000;
	SET @P_91 = @P_90 * 1.20;

	INSERT INTO @Wynik 
		VALUES (@P_11,@P_12,@P_13,@P_14,@P_15,@P_16,@P_17,@P_18,@P_19,@P_20,@P_21,@P_22,@P_23,@P_24,@P_25,@P_26,@P_27,@P_28,@P_29,@P_90,@P_91);
	
	RETURN; 

END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="CUKOplataDeklaracja2"></A><PRE>
          <FONT SIZE="2"><I>/* CUKOplataDeklaracja2 */</I><BR>
CREATE FUNCTION CDN.CUKOplataDeklaracja2 (
@typDaty    SMALLINT,			--typ daty (0- data sprzedaĹĽy, 1- data wystawienia)
@dataOd    	INT,				--Data od ktĂłrej obowiÄ…zuje okres sporzÄ…dzenia CUK
@dataDo		INT,				--Data do ktĂłrej obowiÄ…zuje okres sporzÄ…dzenia CUK
@stawkaMax	SMALLINT,			--NadwyĹĽka cukru liczona wg stawki max
@dataOryginalu SMALLINT			--0- ujÄ™cie dokumentĂłw wg daty wĹ‚asnej, 1- ujÄ™cie dokumentĂłw wg daty oryginaĹ‚u
)
RETURNS @Wynik TABLE (
		P_11		BIGINT,
		P_12		decimal(25,2),
		P_13		decimal(25,2),
		P_14		decimal(25,2),
		P_15		decimal(25,2),
		P_16		BIGINT,
		P_17		BIGINT,
		P_18		decimal(25,2),
		P_19		decimal(25,2),
		P_20		decimal(25,2),
		P_21		decimal(25,2),
		P_22		decimal(25,2),
		P_23		BIGINT,
		P_24		decimal(25,2),
		P_25		decimal(25,2),
		P_26		decimal(25,2),
		P_27		decimal(25,2),
		P_28		BIGINT,
		P_29		BIGINT,
		P_30		decimal(25,2),
		P_31		decimal(25,2),
		P_32		decimal(25,2),
		P_33		decimal(25,2),
		P_34		BIGINT,
		P_35		BIGINT,
		P_36		decimal(25,2),
		P_37		decimal(25,2),
		P_38		decimal(25,2),
		P_39		decimal(25,2),
		P_90		decimal(25,2),
		P_91 		decimal(25,2)
)

BEGIN
	DECLARE @Towary Table (
		DokGIDTyp				SMALLINT,
		DokGIDNumer				INT,
		TwrGIDTyp				SMALLINT,
		TwrGIDNumer				INT,
		TwrOplataSpozFlaga		INT,
		TwrZawartoscCukru		DECIMAL(7,2),
		TrEIlosc				DECIMAL(11,4),
		TwrOplataSpozPrzeliczL	DECIMAL(15),
		TwrOplataSpozPrzeliczM	DECIMAL(15),
		TwrStawkaCukierZmienna	DECIMAL(7,2),
		TrsGIDLp				SMALLINT,
		TrsSubGIDLp				SMALLINT
	)

	DECLARE		@DokGIDTyp				SMALLINT,
				@DokGIDNumer				INT,
				@TwrGIDTyp				SMALLINT,
				@TwrGIDNumer				INT,
				@TwrOplataSpozFlaga		INT,
				@TwrZawartoscCukru		DECIMAL(7,2),
				@TrEIlosc				DECIMAL(11,4),
				@TwrOplataSpozPrzeliczL	DECIMAL(15),
				@TwrOplataSpozPrzeliczM	DECIMAL(15),
				@TwrStawkaCukierZmienna	DECIMAL(7,2),
				@TrsGIDLp				SMALLINT,
				@TrsSubIDLp				SMALLINT,
				@P_11					BIGINT = 0,
				@P_11tmp				decimal(25,2) = 0.00,
				@P_12					decimal(25,2) = 0.00,
				@P_13					decimal(25,2) = 0.00,
				@P_14					decimal(25,2) = 0.00,
				@P_14Z					decimal(25,2) = 0.00,
				@P_14tmp2				BIGINT = 0,
				@P_15					decimal(25,2) = 0.00,
				@P_15tmp				BIGINT = 0,
				@P_16					BIGINT = 0,
				@P_16tmp				decimal(25,2) = 0.00,
				@P_17					BIGINT = 0,
				@P_17tmp				decimal(25,2) = 0.00,
				@P_18					decimal(25,2) = 0.00,
				@P_18tmp				decimal(25,2) = 0.00,
				@P_19					decimal(25,2) = 0.00,
				@P_19tmp				decimal(25,2) = 0.00,
				@P_20					decimal(25,2) = 0.00,
				@P_21					decimal(25,2) = 0.00,
				@P_21X1					decimal(25,2) = 0.00,
				@P_21X2					decimal(25,2) = 0.00,
				@P_21OS					decimal(25,2) = 0.00,
				@P_21OZ					decimal(25,2) = 0.00,
				@P_22					decimal(25,2) = 0.00,
				@P_22tmp				decimal(25,2) = 0.00,
				@P_23					BIGINT = 0,
				@P_23tmp				decimal(25,2) = 0.00,
				@P_24					decimal(25,2) = 0.00,
				@P_25					decimal(25,2) = 0.00,
				@P_25tmp				decimal(25,2) = 0.00,
				@P_26					decimal(25,2) = 0.00,
				@P_26Z					decimal(25,2) = 0.00,
				@P_27					decimal(25,2) = 0.00,
				@P_27tmp				BIGINT = 0,
				@P_28					BIGINT = 0,
				@P_28tmp				decimal(25,2) = 0.00,
				@P_29					decimal(25,2) = 0.00,
				@P_29tmp				decimal(25,2) = 0.00,
				@P_30					decimal(25,2) = 0.00,
				@P_31					decimal(25,2) = 0.00,
				@P_32					decimal(25,2) = 0.00,
				@P_32X1					decimal(25,2) = 0.00,
				@P_32X2					decimal(25,2) = 0.00,
				@P_33					decimal(25,2) = 0.00,
				@P_34					decimal(25,2) = 0.00,
				@P_34tmp				decimal(25,2) = 0.00,
				@P_35					BIGINT = 0,
				@P_35tmp				decimal(25,2) = 0.00,
				@P_36					decimal(25,2) = 0.00,
				@P_37					decimal(25,2) = 0.00,
				@P_38					decimal(25,2) = 0.00,
				@P_38X2					decimal(25,2) = 0.00,
				@P_39					decimal(25,2) = 0.00,
				@P_40					decimal(25,2) = 0.00,
				@N2						decimal(25,2) = 0.00,
				@N3						decimal(25,2) = 0.00,
				@N4						decimal(25,2) = 0.00,
				@N5						decimal(25,2) = 0.00,
				@P_90					decimal(25,2) = 0.00,
				@P_90tmp				decimal(25,2) = 0.00,
				@P_91					decimal(25,2) = 0.00,
				@R1						decimal(25,2) = 0.00,
				@R2						decimal(25,2) = 0.00,
				@R3						decimal(25,2) = 0.00,
				@R4						decimal(25,2) = 0.00,
				@Redukcja				decimal(25,2) = 0.00

	DECLARE kursorTowary CURSOR FOR 
			SELECT * FROM @Towary
	
	IF (@dataOryginalu = 0)
	BEGIN
		IF  (@typDaty = 0) 
		BEGIN
			INSERT INTO @Towary 
			select TrE_GIDTyp, TrE_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrE_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,0,0
				 from cdn.TraElem JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer 
				 LEFT JOIN cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 
				 AND ((A.TrN_GIDTyp in (2033,2035,2037,2036,2041,2043,2045,2044) AND A.Trn_Data3 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5) 
				 OR (A.TrN_SpiTyp = 0 AND A.TrN_GIDTyp in (2034,2042) AND A.Trn_Data3 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5)
				 OR (A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (1489,2000,2001,2005,2008,2009,2013) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND B.Trn_Data3 BETWEEN @dataOd AND @dataDo))
				 UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,Trs_GidLp,Trs_SubGIDLp
				FROM cdn.TraElem 
				 JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
				 join cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer		 
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5 AND B.TrN_GIDTyp in (2035,2043) 
				AND B.Trn_Data3 BETWEEN @dataOd AND @dataDo;
		END
		ELSE 
		BEGIN
			INSERT INTO @Towary 
			select TrE_GIDTyp, TrE_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrE_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,0,0
				 from cdn.TraElem JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer 
				 LEFT JOIN cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
				 WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 
				 AND ((A.TrN_GIDTyp in (2033,2035,2037,2036,2041,2043,2045,2044) AND A.Trn_Data2 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5) 
				 OR (A.TrN_SpiTyp = 0 AND A.TrN_GIDTyp in (2034,2042) AND A.Trn_Data2 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5) 
				 OR (A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (1489,2000,2001,2005,2008,2009,2013) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND B.Trn_Data2 BETWEEN @dataOd AND @dataDo))
				 UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,Trs_GidLp,Trs_SubGIDLp
				FROM cdn.TraElem 
				 JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
				 join cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer		 
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5 AND B.TrN_GIDTyp in (2035,2043) 
				AND B.Trn_Data2 BETWEEN @dataOd AND @dataDo;
		END
	END
	ELSE 
	BEGIN
		IF  (@typDaty = 0) 
		BEGIN
			INSERT INTO @Towary 
			select TrE_GIDTyp, TrE_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,Trs_GidLp,Trs_SubGIDLp
				 from cdn.TraElem JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer 
				 LEFT JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 LEFT JOIN cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
				 LEFT JOIN cdn.TraNag D ON D.TrN_GIDNumer = B.TrN_ZwrNumer AND D.TrN_GIDTyp = B.TrN_ZwrTyp
				 WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 
				 AND ((A.TrN_GIDTyp in (2033,2035,2037,2036,2043) AND A.Trn_Data3 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5) 
				  OR (A.TrN_SpiTyp = 0 AND A.TrN_GIDTyp in (2034) AND A.Trn_Data3 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5) 
				 OR (A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (1489,2000,2001,2005,2008) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND B.Trn_Data3 BETWEEN @dataOd AND @dataDo)
				 OR (A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (2009,2013) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND B.Trn_Data3 BETWEEN @dataOd AND @dataDo AND d.TrN_GIDTyp IS NULL))
			UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,Trs_GidLp,Trs_SubGIDLp
				FROM cdn.TraElem 
				JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
				 join cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
				 LEFT Join cdn.TraNag D on B.TrN_ZwrTyp = D.TrN_GIDTyp and B.TrN_ZwrNumer = D.TrN_GIDNumer
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5 AND 
				((B.TrN_GIDTyp = 2035 AND B.Trn_Data3 BETWEEN @dataOd AND @dataDo) OR (B.TrN_GIDTyp = 2043 AND D.Trn_Data3 BETWEEN @dataOd AND @dataDo)) 
			UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, C.TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,C.Trs_GidLp,C.Trs_SubGIDLp
				FROM cdn.TraElem 
				 JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraSElem C ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
				 join cdn.tranag B on B.TrN_ZwrNumer = A.TrN_GIDNumer		 
				 Join cdn.TraNag D on D.TrN_GIDTyp= C.TrS_OrgTyp and D.TrN_GIDNumer = C.TrS_OrgNumer
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND ((B.TrN_SpiTyp = 0 AND B.TrN_GIDTyp in (2041,2043,2045,2044) AND A.Trn_Data3 BETWEEN @dataOd AND @dataDo AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5)
				OR (A.TrN_SpiTyp = 0 AND A.TrN_GIDTyp in (2034,2042) AND C.TrS_GIDNumer &lt;&gt; C.TrS_OrgNumer  AND D.Trn_Data3 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5))--spinacze nagĹ‚Ăłwkowe korekt i PAK
			UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, C.TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,C.Trs_GidLp,C.Trs_SubGIDLp
				FROM cdn.TraElem 
					JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
					JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer	
					JOIN cdn.TraSElem C ON TrE_GIDTyp=C.TrS_GIDTyp AND TrE_GIDNumer=C.TrS_GIDNumer AND TrE_GIDLp=C.TrS_GIDLp
					join cdn.tranag B on C.TrS_GIDNumer = B.TrN_GIDNumer
					LEFT JOIN cdn.TraNag D ON D.TrN_GIDTyp= C.TrS_OrgTyp and D.TrN_GIDNumer = C.TrS_OrgNumer
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND (B.TrN_SpiTyp &lt;&gt; 0 AND B.TrN_GIDTyp in (2041,2043,2045,2044) AND D.Trn_Data3 BETWEEN @dataOd AND @dataDo AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5) --spinacze elementĂłw korekt i korekty z datÄ… oryginaĹ‚u
			UNION ALL
			SELECT DISTINCT TrE_GIDTyp, TrE_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, C.TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,C.TrS_GIDLp,C.Trs_SubGIDLp
					FROM cdn.TraNag A 
					JOIN cdn.TraElem ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer 
					JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
					LEFT JOIN cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
					JOIN cdn.TraSElem C ON C.TrS_GIDNumer = TrE_GIDNumer AND C.TrS_GIDTyp = TrE_GIDTyp AND C.TrS_GIDLp = TrE_GIDLp
					LEFT JOIN cdn.TraNag D ON D.TrN_GIDNumer = B.TrN_ZwrNumer AND D.TrN_GIDTyp = B.TrN_ZwrTyp
					WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND
					(A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (1489,2000,2001,2005,2008,2009,2013) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND D.Trn_Data3 BETWEEN @dataOd AND @dataDo
					AND C.TrS_GIDNumer &lt;&gt; C.TrS_OrgNumer)
		END
		ELSE 
		BEGIN
			INSERT INTO @Towary 
			select TrE_GIDTyp, TrE_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,Trs_GidLp,Trs_SubGIDLp
				 from cdn.TraElem JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer 
				 LEFT JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 LEFT JOIN cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
				 LEFT JOIN cdn.TraNag D ON D.TrN_GIDNumer = B.TrN_ZwrNumer AND D.TrN_GIDTyp = B.TrN_ZwrTyp
				 WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 
				 AND ((A.TrN_GIDTyp in (2033,2035,2037,2036,2043) AND A.Trn_Data2 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5) 
				  OR (A.TrN_SpiTyp = 0 AND A.TrN_GIDTyp in (2034) AND A.Trn_Data2 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5) 
				 OR (A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (1489,2000,2001,2005,2008) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND B.Trn_Data2 BETWEEN @dataOd AND @dataDo)
				 OR (A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (2009,2013) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND B.Trn_Data2 BETWEEN @dataOd AND @dataDo AND d.TrN_GIDTyp IS NULL))
			UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,Trs_GidLp,Trs_SubGIDLp
				FROM cdn.TraElem 
				JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraSElem ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
				 join cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
				 LEFT Join cdn.TraNag D on B.TrN_ZwrTyp = D.TrN_GIDTyp and B.TrN_ZwrNumer = D.TrN_GIDNumer
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5 AND 
				((B.TrN_GIDTyp = 2035 AND B.Trn_Data2 BETWEEN @dataOd AND @dataDo) OR (B.TrN_GIDTyp = 2043 AND D.Trn_Data2 BETWEEN @dataOd AND @dataDo)) 
			UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, C.TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,C.Trs_GidLp,C.Trs_SubGIDLp
				FROM cdn.TraElem 
				 JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
				 JOIN cdn.TraSElem C ON TrE_GIDTyp=TrS_GIDTyp AND TrE_GIDNumer=TrS_GIDNumer AND TrE_GIDLp=TrS_GIDLp
				 JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer
				 join cdn.tranag B on B.TrN_ZwrNumer = A.TrN_GIDNumer	
				 Join cdn.TraNag D on D.TrN_GIDTyp= C.TrS_OrgTyp and D.TrN_GIDNumer = C.TrS_OrgNumer
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND ((B.TrN_SpiTyp = 0 AND B.TrN_GIDTyp in (2041,2043,2045,2044) AND A.Trn_Data2 BETWEEN @dataOd AND @dataDo AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5)
				OR (A.TrN_SpiTyp = 0 AND A.TrN_GIDTyp in (2034,2042) AND C.TrS_GIDNumer &lt;&gt; C.TrS_OrgNumer  AND D.Trn_Data2 BETWEEN @dataOd AND @dataDo AND A.Trn_OplataSpozFlaga = 1 AND A.TrN_Stan BETWEEN 3 AND 5))--spinacze nagĹ‚Ăłwkowe korekt i PAK
			UNION ALL
			SELECT B.TrN_GIDTyp, B.TrN_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, C.TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,C.Trs_GidLp,C.Trs_SubGIDLp
				FROM cdn.TraElem 
					JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
					JOIN cdn.TraNag A ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer	
					JOIN cdn.TraSElem C ON TrE_GIDTyp=C.TrS_GIDTyp AND TrE_GIDNumer=C.TrS_GIDNumer AND TrE_GIDLp=C.TrS_GIDLp
					join cdn.tranag B on C.TrS_GIDNumer = B.TrN_GIDNumer
					LEFT JOIN cdn.TraNag D ON D.TrN_GIDTyp= C.TrS_OrgTyp and D.TrN_GIDNumer = C.TrS_OrgNumer
				WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND (B.TrN_SpiTyp &lt;&gt; 0 AND B.TrN_GIDTyp in (2041,2043,2045,2044) AND D.Trn_Data2 BETWEEN @dataOd AND @dataDo AND B.Trn_OplataSpozFlaga = 1 AND B.TrN_Stan BETWEEN 3 AND 5) --spinacze elementĂłw korekt i korekty z datÄ… oryginaĹ‚u
			UNION ALL
			SELECT DISTINCT TrE_GIDTyp, TrE_GIDNumer, Twr_GIDTyp, Twr_GIDNumer, Twr_OplataSpozFlaga, Twr_ZawartoscCukru, C.TrS_Ilosc, Twr_OplataSpozPrzeliczL, Twr_OplataSpozPrzeliczM, Twr_StawkaCukierZmienna,C.TrS_GIDLp,C.Trs_SubGIDLp
					FROM cdn.TraNag A 
					JOIN cdn.TraElem ON A.TrN_GIDTyp=TrE_GIDTyp AND A.TrN_GIDNumer=TrE_GIDNumer 
					JOIN cdn.TwrKarty ON Twr_GIDNumer=TrE_TwrNumer 
					LEFT JOIN cdn.tranag B on A.TrN_SpiTyp=B.TrN_GIDTyp and A.TrN_SpiNumer=B.TrN_GIDNumer	
					JOIN cdn.TraSElem C ON C.TrS_GIDNumer = TrE_GIDNumer AND C.TrS_GIDTyp = TrE_GIDTyp AND C.TrS_GIDLp = TrE_GIDLp
					LEFT JOIN cdn.TraNag D ON D.TrN_GIDNumer = B.TrN_ZwrNumer AND D.TrN_GIDTyp = B.TrN_ZwrTyp
					WHERE Twr_OplataSpozFlaga &gt; 0 AND TrE_Ilosc &lt;&gt; 0 AND
					(A.TrN_SpiTyp &gt; 0 AND A.TrN_GIDTyp in (1489,2000,2001,2005,2008,2009,2013) AND B.TrN_Stan BETWEEN 3 AND 5 AND B.Trn_OplataSpozFlaga = 1  AND D.Trn_Data2 BETWEEN @dataOd AND @dataDo
					AND C.TrS_GIDNumer &lt;&gt; C.TrS_OrgNumer)
		END
	END

	OPEN kursorTowary
	FETCH NEXT FROM kursorTowary INTO @DokGIDTyp,@DokGIDNumer,@TwrGIDTyp,@TwrGIDNumer,@TwrOplataSpozFlaga,@TwrZawartoscCukru,@TrEIlosc,@TwrOplataSpozPrzeliczL,@TwrOplataSpozPrzeliczM,@TwrStawkaCukierZmienna,@TrsGIDLp,@TrsSubIDLp

	WHILE @@FETCH_STATUS = 0
	BEGIN
		IF ((@TwrOplataSpozFlaga = 3 OR @TwrOplataSpozFlaga = 7) AND @TwrZawartoscCukru BETWEEN 0 AND 5) OR 
		((@TwrOplataSpozFlaga = 1 OR @TwrOplataSpozFlaga = 5) AND @TwrZawartoscCukru &gt; 0 AND @TwrZawartoscCukru &lt;= 5)		--Grupa I
		BEGIN
			IF (@TrEIlosc &gt; 0)
			BEGIN
				SET @P_11tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			END;
			IF (@TrEIlosc &lt; 0)
			BEGIN
				SET @P_14Z += (ABS(@TrEIlosc)) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			END;
		END

		IF (@TwrOplataSpozFlaga in (1,3,5,7) AND @TwrZawartoscCukru &gt; 5)		--Grupa II
		BEGIN
			IF (@TrEIlosc &gt; 0)
			BEGIN
				SET @P_16tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
				IF (@stawkaMax = 0 OR @stawkaMax = 2)
				BEGIN
					SET @P_17tmp += (CEILING(@TwrZawartoscCukru) -5) * ( (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM)/1000);	
				END
				ELSE
				BEGIN
					SET @P_17tmp += (@TwrStawkaCukierZmienna /0.05) * ((@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM)/1000);		
				END
			END;
			IF (@TrEIlosc &lt; 0)
			BEGIN
				SET @P_21X1 += (ABS(@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM));
				IF (@stawkaMax = 1 OR @stawkaMax = 2)
				BEGIN
					SET @P_21X2 += ((ABS(@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM)) /1000)* (@TwrStawkaCukierZmienna /0.05);		
				END
				ELSE
				BEGIN
					SET @P_21X2 += ((ABS(@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM)) /1000) * (CEILING(@TwrZawartoscCukru) -5);	
				END
			END
		END

		IF (@TwrOplataSpozFlaga in (5, 7, 13, 15, 21, 23))		--Grupa III
		BEGIN
			IF (@TrEIlosc &gt; 0)
			BEGIN
				SET @P_23tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			END;
			IF (@TrEIlosc &lt; 0)
			BEGIN
				SET @P_26Z += (ABS(@TrEIlosc)) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			END;
			IF ((@TwrOplataSpozFlaga = 5 AND @TwrZawartoscCukru = 0) OR (@TwrOplataSpozFlaga in (13,21) AND @TwrZawartoscCukru &lt;= 5))
			BEGIN
				SET @P_90tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
			END
		END

		IF (@TwrOplataSpozFlaga in (9, 11, 13, 15) AND @TwrZawartoscCukru &gt; 5)		--Grupa IV
		BEGIN
			IF (@TrEIlosc &gt; 0)
			BEGIN
				SET @P_28tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);

				IF (@stawkaMax = 0 OR @stawkaMax = 2)
				BEGIN
					SET @P_29tmp += (CEILING(@TwrZawartoscCukru) -5) * ( (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM)/1000);	
				END
				ELSE
				BEGIN
					SET @P_29tmp += (@TwrStawkaCukierZmienna /0.05) * ((@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM)/1000);		
				END
			END;

			IF (@TrEIlosc &lt; 0)
			BEGIN
				IF (@stawkaMax = 1 OR @stawkaMax = 2)
				BEGIN
					SET @P_32X2 += (@TwrStawkaCukierZmienna /0.05) * ((ABS(@TrEIlosc)) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM) /1000);		
				END
				ELSE
				BEGIN
					SET @P_32X2 += (CEILING(@TwrZawartoscCukru) -5) *((ABS(@TrEIlosc)) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM) /1000);	
				END
			END
		END

		IF (@TwrOplataSpozFlaga in (17, 19, 21, 23) AND @TwrZawartoscCukru &gt; 5)		--Grupa V
		BEGIN
			IF (@TrEIlosc &gt; 0)
			BEGIN
				SET @P_34tmp += (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM);
				IF (@stawkaMax = 0 OR @stawkaMax = 2)
				BEGIN
					SET @P_35tmp += (CEILING(@TwrZawartoscCukru) -5) * ( (@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM)/1000);	
				END
				ELSE
				BEGIN
					SET @P_35tmp += (@TwrStawkaCukierZmienna /0.05) * ((@TrEIlosc) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM)/1000);		
				END
			END;

			IF (@TrEIlosc &lt; 0)
			BEGIN
				IF (@stawkaMax = 1 OR @stawkaMax = 2)
				BEGIN
					SET @P_38X2 += (@TwrStawkaCukierZmienna /0.05) * ((ABS(@TrEIlosc)) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM) /1000);		
				END
				ELSE
				BEGIN
					SET @P_38X2 += (CEILING(@TwrZawartoscCukru) -5) *((ABS(@TrEIlosc)) * (@TwrOplataSpozPrzeliczL/@TwrOplataSpozPrzeliczM) /1000);	
				END
			END
		END
	FETCH NEXT FROM kursorTowary INTO @DokGIDTyp,@DokGIDNumer,@TwrGIDTyp,@TwrGIDNumer,@TwrOplataSpozFlaga,@TwrZawartoscCukru,@TrEIlosc,@TwrOplataSpozPrzeliczL,@TwrOplataSpozPrzeliczM,@TwrStawkaCukierZmienna,@TrsGIDLp,@TrsSubIDLp
	END
	
	CLOSE kursorTowary
	DEALLOCATE kursorTowary
	-- Grupa I
	SET @P_11 = ROUND(@P_11tmp,0);									-- Liczba mililitrĂłw napojĂłw grupy I
	SET @P_12 = CAST(@P_11 AS decimal(25,2)) / 1000*0.50;			-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 1
	SET @P_13 = @P_12;												-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6
	SET @P_14tmp2 = ROUND(@P_14Z,0);
	SET @P_14 = CAST(@P_14tmp2 AS decimal(25,2)) / 1000 * 0.50;		-- Kwota opĹ‚aty naliczonej od napojĂłw zwrĂłconych
	SET @P_15 = @P_13 - @P_14;										-- Kwota opĹ‚aty po pomniejszeniu

	-- Grupa II
	SET @P_16 = ROUND(@P_16tmp,0);									-- Liczba mililitrĂłw napojĂłw grupy II
	SET @P_17 = ROUND(@P_17tmp,0);									-- ĹÄ…czna liczba mg cukrĂłw bÄ™dÄ…cych nadwyĹĽkÄ… powyĹĽej 5g/100ml
	SET @P_18 =  CAST(@P_16 AS decimal(25,2)) / 1000 * 0.50;		-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 1
	SET @P_19 =  CAST(@P_17 AS decimal(25,2)) * 0.05;				-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 2
	SET @P_20 = @P_18 + @P_19;										-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6
	SET @P_21OS = ROUND(@P_21X1,0) / 1000 * 0.50;
	SET @P_21OZ = ROUND(@P_21X2,0) * 0.05;
	SET @P_21 = @P_21OS + @P_21OZ									-- Kwota opĹ‚aty naliczonej od napojĂłw zwrĂłconych
	SET @P_22 = @P_20 - @P_21;										-- Kwota opĹ‚aty po pomniejszeniu

	-- Grupa III
	SET @P_23 = ROUND(@P_23tmp,0);									-- Liczba mililitrĂłw napojĂłw grupy III
	SET @P_24 =  CAST(@P_23 AS decimal(25,2)) / 1000 * 0.10;		-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.3
	SET @P_25 = @P_24;												-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6
	SET @P_26 = @P_26Z / 1000 * 0.10;								-- Kwota opĹ‚aty naliczonej od napojĂłw zwrĂłconych
	SET @P_27 = @P_25 - @P_26;										-- Kwota opĹ‚aty po pomniejszeniu

	-- Grupa IV
	SET @P_28 = ROUND(@P_28tmp,0);									-- Liczba mililitrĂłw napojĂłw grupy IV
	SET @P_29 = ROUND(@P_29tmp,0);									-- ĹÄ…czna liczba mg cukrĂłw bÄ™dÄ…cych nadwyĹĽkÄ… powyĹĽej 5g/100ml
	SET @P_30 = CAST(@P_29 AS decimal(25,2)) * 0.05					-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 1
	SET @P_31 = @P_30;												-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6
	SET @P_32 = ROUND(@P_32X2,0) * 0.05;							-- Kwota opĹ‚aty naliczonej od napojĂłw zwrĂłconych
	SET @P_33 = @P_31 - @P_32;										-- Kwota opĹ‚aty po pomniejszeniu

	-- Grupa V
	SET @P_34 = ROUND(@P_34tmp,0);									-- Liczba mililitrĂłw napojĂłw grupy V
	SET @P_35 = ROUND(@P_35tmp,0);									-- ĹÄ…czna liczba mg cukrĂłw bÄ™dÄ…cych nadwyĹĽkÄ… powyĹĽej 5g/100ml
	SET @P_36 = CAST(@P_35 AS decimal(25,2)) * 0.05;				-- WysokoĹ›Ä‡ opĹ‚aty obliczona wg stawki 12f ust.1 pkt 1
	SET @P_37 = @P_36;												-- Suma opĹ‚at z zastrzeĹĽeniem 12f ust.6
	SET @P_38 =  ROUND(@P_38X2,0) * 0.05;							-- Kwota opĹ‚aty naliczonej od napojĂłw zwrĂłconych
	SET @P_39 = @P_37 - @P_38;										-- Kwota opĹ‚aty po pomniejszeniu
	
	SET @P_90 = (@P_11 + @P_16 + @P_28 + @P_34 + @P_90tmp)/1000;	-- ĹÄ…czna iloĹ›Ä‡ sprzedanych napojĂłw (w litrach)
	SET @P_91 = @P_90 * 1.20;										-- Maksymalna opĹ‚ata spoĹĽywcza

	IF (@stawkaMax = 2)
	BEGIN
		SET @P_40 = @P_15 + @P_22 + @P_27 + @P_33 + @P_39;			-- ĹÄ…czna wartoĹ›Ä‡ opĹ‚aty
		SET @R1 = @P_40 - @P_91;
		IF (@R1 &gt; 0.00)				-- Redukcja nadwyĹĽki w grupach
		BEGIN
			SET @N2 = @P_20 - (@P_16 / 1000 * 1.20);
			SET @N4 = @P_31 - (@P_28 / 1000 * 1.20);
			SET @N5 = @P_37 - (@P_34 / 1000 * 1.20);
			IF (@N2 &gt; 0.00)		
			BEGIN			-- Redukcja grupy II
				SELECT @Redukcja = MIN(x)FROM (VALUES (@N2), (@R1), (@P_22)) AS v (x);
				SET @P_20 = @P_20 - @Redukcja;
				SET @P_22 = @P_20 - @P_21;
				SET @P_40 = @P_15 + @P_22 + @P_27 + @P_33 + @P_39;
			END
			SET @R2 = @P_40 - @P_91;
			IF (@R2 &gt; 0.00) OR (@N2 &lt;= 0.00)
			BEGIN
				IF (@N4 &gt; 0.00)		
				BEGIN			-- Redukcja grupy IV
					SELECT @Redukcja = MIN(x)FROM (VALUES (@N4), (@R2), (@P_33)) AS v (x);
					SET @P_31 = @P_31 - @Redukcja;
					SET @P_33 = @P_31- @P_32;
					SET @P_40 = @P_15 + @P_22 + @P_27 + @P_33 + @P_39;
				END
			END
			SET @R3 = @P_40 - @P_91;
			IF (@R3 &gt; 0.00) OR (@N4 &lt;= 0.00)
			BEGIN
				IF (@N5 &gt; 0.00)
				BEGIN			-- Redukcja grupy V
					SELECT @Redukcja = MIN(x)FROM (VALUES (@N5), (@R3), (@P_39)) AS v (x);	
					SET @P_37 = @P_37 - @Redukcja;
					SET @P_39 = @P_37 - @P_38;
					SET @P_40 = @P_15 + @P_22 + @P_27 + @P_33 + @P_39;
				END
			END
			SET @R4 = @P_40 - @P_91;
			IF (@R4 &gt; 0.00) OR (@N5 &lt;= 0.00)
			BEGIN			-- Redukcja grupy III	
				SELECT @Redukcja = MIN(x)FROM (VALUES (@P_25), (@R4), (@P_27)) AS v (x);	
				SET @P_25 = @P_25 - @Redukcja;
				SET @P_27 = @P_25 - @P_26;
			END

		END
	END


	INSERT INTO @Wynik 
		VALUES (@P_11,@P_12,@P_13,@P_14,@P_15,@P_16,@P_17,@P_18,@P_19,@P_20,@P_21,@P_22,@P_23,@P_24,@P_25,@P_26,@P_27,@P_28,@P_29,
		@P_30,@P_31,@P_32,@P_33,@P_34,@P_35,@P_36,@P_37,@P_38,@P_39,@P_90,@P_91);
	
	RETURN; 

END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>