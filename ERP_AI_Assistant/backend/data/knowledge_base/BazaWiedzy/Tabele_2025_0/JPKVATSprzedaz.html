<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="[FakturySprzedazyWgDeklaracjiVatJPK_Zapytanie]"></A><PRE>
          <FONT SIZE="2"><I>/* [FakturySprzedazyWgDeklaracjiVatJPK_Zapytanie] */</I><BR>
create procedure [CDN].[FakturySprzedazyWgDeklaracjiVatJPK_Zapytanie] (@miesiacKwartal tinyint, @kwartal tinyint, @miesiac tinyint, @rok smallint, @wersjaDeklaracji smallint = 12, @uzgodnijVAT7 tinyint=0, @JPKPONNumer int=0, @PONNumer int =0) as
begin	
	declare @sSQL nvarchar(max) 
	declare @rv int		
	

	IF @wersjaDeklaracji &gt;= 21
	begin
		set @sSQL = N'		
		select ROW_NUMBER() over (order by GIDTyp, GIDNumer) LpSprzedazy, tmpWyn.*
		,isnull(GTU_01,0) GTU_01,isnull(GTU_02,0) GTU_02,isnull(GTU_03,0) GTU_03,isnull(GTU_04,0) GTU_04,isnull(GTU_05,0) GTU_05,isnull(GTU_06,0) GTU_06,isnull(GTU_07,0) GTU_07,isnull(GTU_08,0) GTU_08,isnull(GTU_09,0) GTU_09,isnull(GTU_10,0) GTU_10,isnull(GTU_11,0) GTU_11,isnull(GTU_12,0) GTU_12,isnull(GTU_13,0) GTU_13'+
		case when @wersjaDeklaracji &gt;= 22 then N',isnull(WSTO_EE,0) WSTO_EE,isnull(IED,0) IED' else N',isnull(SW,0) SW,isnull(EE,0) EE' end +N',isnull(TP,0) TP,isnull(TT_WNT,0) TT_WNT,isnull(TT_D,0) TT_D,isnull(MR_T,0) MR_T,isnull(MR_UZ,0) MR_UZ,isnull(I_42,0) I_42,isnull(I_63,0) I_63,isnull(B_SPV,0) B_SPV,isnull(B_SPV_DOSTAWA,0) B_SPV_DOSTAWA,isnull(B_MPV_PROWIZJA,0) B_MPV_PROWIZJA,' + case when @rok=2021 and @miesiac&gt;=7 or @rok&gt;2021 then N'0' else N'isnull(MPP,0)' end + N'MPP
			, case when TRN_GIDTyp in (2033,2041) and TRN_TRNTyp=35 then 1 else 0 end KorektaPodstawyOpodt
			, case when TRN_GIDTyp in (2033) and TRN_TRNTyp=35 then (select top 1 PED_TerminPlat from cdn.PodElemDok where PED_PONNumer=TrN_VatZDPeDNumer and PED_Lp=TrN_VatZDPeDLp ) else 0 end TerminPlatnosci
			, case when TRN_GIDTyp in (2041) and TRN_TRNTyp=35 then TRN_Data2 else 0 end DataZaplaty
			, case when isnull(MR_T,0)=1 or isnull(MR_UZ,0)=1 then Brutto else 0 end SprzedazVATMarza
			, CDN.KodKrajuIntrastatNaISO(_KodKrajuNadaniaTIN) KodKrajuNadaniaTIN
		into ##tmpJPKVatS_' + convert(nvarchar,@JPKPONNumer) +
		N'
	    from ( 
			select 				
				GIDTyp, GIDNumer, KodKrajuNadaniaTIN _KodKrajuNadaniaTIN, NrKontrahenta, NazwaKontrahenta,AdresKontrahenta, DowodSprzedazy, DataWystawienia, DataSprzedazy, TypDokumentu, GIDLp1, WchodziDoDeklaracji, KodyGIDTyp, KodyGIDNumer,

				sum(case when PoleNaDekl=10 then Netto else 0.00 end) as K_10,
				sum(case when PoleNaDekl=11 then Netto else 0.00 end) as K_11,
				sum(case when PoleNaDekl=12 then Netto else 0.00 end) as K_12,
				sum(case when PoleNaDekl=13 then Netto else 0.00 end) as K_13,
				sum(case when PoleNaDekl=14 then Netto else 0.00 end) as K_14,
				sum(case when PoleNaDekl=15 then Netto else 0.00 end) as K_15, SUM(case when PoleNaDekl=15 then Vat else 0.00 end) as K_16,		-- netto trafia do pola 15, vat trafia do pola 16
				sum(case when PoleNaDekl=17 then Netto else 0.00 end) as K_17, SUM(case when PoleNaDekl=17 then Vat else 0.00 end) as K_18,		
				sum(case when PoleNaDekl=19 then Netto else 0.00 end) as K_19, SUM(case when PoleNaDekl=19 then Vat else 0.00 end) as K_20,				
				sum(case when PoleNaDekl=21 then Netto else 0.00 end) as K_21,
				sum(case when PoleNaDekl=22 then Netto else 0.00 end) as K_22,
				sum(case when PoleNaDekl=23 then Netto else 0.00 end) as K_23, SUM(case when PoleNaDekl=23 then Vat else 0.00 end) as K_24,		
				sum(case when PoleNaDekl=25 then Netto else 0.00 end) as K_25, SUM(case when PoleNaDekl=25 then Vat else 0.00 end) as K_26,				
				sum(case when PoleNaDekl=27 then Netto else 0.00 end) as K_27, SUM(case when PoleNaDekl=27 then Vat else 0.00 end) as K_28,		
				sum(case when PoleNaDekl=29 then Netto else 0.00 end) as K_29, SUM(case when PoleNaDekl=29 then Vat else 0.00 end) as K_30,		
				sum(case when PoleNaDekl=32 then Netto else 0.00 end) as K_31, SUM(case when PoleNaDekl=32 then Vat else 0.00 end) as K_32,
																				 SUM(case when PoleNaDekl=36 then Vat else 0.00 end) as K_33,		
																				 sum(case when PoleNaDekl=37 then Vat else 0.00 end) as K_34, 
																				 SUM(case when PoleNaDekl=38 then Vat else 0.00 end) as K_35,
																				 sum(case when PoleNaDekl=39 then Vat else 0.00 end) as K_36,

				sum(case when PoleNaDekl=1000 then Netto else 0.00 end) as K_1000,						
				sum(case when PoleNaDekl=12 then 0 else Netto+Vat end) as Brutto
			from (
				select GIDTyp, GIDNumer, PoleNaDekl, case when KodKrajuNadaniaTIN=''GR'' then ''EL'' when @Rok&lt;2022 AND KodKrajuNadaniaTIN=''XI'' then ''GB''
				 else KodKrajuNadaniaTIN end KodKrajuNadaniaTIN, NrKontrahenta, NazwaKontrahenta,AdresKontrahenta, DowodSprzedazy, DataWystawienia, DataSprzedazy, TypDokumentu, GIDLp1, case when TypDokumentu='''' then WchodziDoDeklaracji_Przed else WchodziDoDeklaracji_Przed end WchodziDoDeklaracji, KodyGIDTyp, KodyGIDNumer
				, Sum(Netto) Netto, Sum(Vat) Vat
				from 
					(select 
						GIDTyp, GIDNumer, PoleNaDekl, case when NIP=''BRAK'' and (ISNULL(TRN_ExpoNorm,SAN_ExpoNorm) in (2,3,4,5,14,15,23,25) and KNTExpoKraj=3) then KNAKodKraju when NIP=''BRAK'' then '''' when KNANIPPrefiks&lt;&gt;'''' then KNANIPPrefiks else case when KNAKodKraju='''' or KNAKodKraju&lt;&gt;''PL'' then KNAKodKraju else '''' end end KodKrajuNadaniaTIN, NIP NrKontrahenta, case when isnull(Nazwa,'''')='''' then ''BRAK'' else Nazwa end NazwaKontrahenta, case when isnull(AdresNabywcy,'''')='''' then ''BRAK'' else AdresNabywcy end AdresKontrahenta
						,  NrDok DowodSprzedazy, DataWystaw DataWystawienia, case when DataSprzed=DataWystaw then 0 else DataSprzed end DataSprzedazy
						,case 
							when not TRN_GIDTyp is null then TRN_DokTypJPK
							when not SAN_GIDTyp is null then SAN_DokTypJPK
							else '''' end TypDokumentu							
						, case when KorektaDanych=1 and TRV_KorektaDanych=0 then 1 else 0 end GIDLp1
						, TSV_Rozliczac WchodziDoDeklaracji_Przed, KodyGIDTyp, KodyGIDNumer
						, Netto, VAT
					from #tmpWyn 
						left join cdn.TRaNag on GIDTyp=Trn_GidTyp and GIDNumer=TrN_GidNumer
						left join cdn.SadNag on GIDTyp=SAN_GIDTyp and GIDNumer=SAN_GIDNumer
					) Wyn0
				group by GIDTyp, GIDNumer, PoleNaDekl, KodKrajuNadaniaTIN, NrKontrahenta, NazwaKontrahenta, AdresKontrahenta, DowodSprzedazy, DataWystawienia, DataSprzedazy, TypDokumentu, GIDLp1, case when TypDokumentu='''' then WchodziDoDeklaracji_Przed else WchodziDoDeklaracji_Przed end, KodyGIDTyp, KodyGIDNumer
				) Wyn1																	
			group by GIDTyp, GIDNumer, KodKrajuNadaniaTIN, NrKontrahenta, NazwaKontrahenta, AdresKontrahenta, DowodSprzedazy, DataWystawienia, DataSprzedazy, TypDokumentu, GIDLp1, WchodziDoDeklaracji, KodyGIDTyp, KodyGIDNumer
			) tmpwyn 
			left join cdn.TRaNag on GIDTyp=Trn_GidTyp and GIDNumer=TrN_GidNumer
			left join (
				select TrJ_TrNTyp, TrJ_TrNNumer
				,MAX(case when TrJ_Wartosc=''GTU_01'' then 1 else 0 end) GTU_01
				,MAX(case when TrJ_Wartosc=''GTU_02'' then 1 else 0 end) GTU_02
				,MAX(case when TrJ_Wartosc=''GTU_03'' then 1 else 0 end) GTU_03
				,MAX(case when TrJ_Wartosc=''GTU_04'' then 1 else 0 end) GTU_04
				,MAX(case when TrJ_Wartosc=''GTU_05'' then 1 else 0 end) GTU_05
				,MAX(case when TrJ_Wartosc=''GTU_06'' then 1 else 0 end) GTU_06
				,MAX(case when TrJ_Wartosc=''GTU_07'' then 1 else 0 end) GTU_07
				,MAX(case when TrJ_Wartosc=''GTU_08'' then 1 else 0 end) GTU_08
				,MAX(case when TrJ_Wartosc=''GTU_09'' then 1 else 0 end) GTU_09
				,MAX(case when TrJ_Wartosc=''GTU_10'' then 1 else 0 end) GTU_10
				,MAX(case when TrJ_Wartosc=''GTU_11'' then 1 else 0 end) GTU_11
				,MAX(case when TrJ_Wartosc=''GTU_12'' then 1 else 0 end) GTU_12
				,MAX(case when TrJ_Wartosc=''GTU_13'' then 1 else 0 end) GTU_13' +
				case when @wersjaDeklaracji &gt;= 22 then 
				N',MAX(case when TrJ_Wartosc=''WSTO_EE'' then 1 else 0 end) WSTO_EE
				,MAX(case when TrJ_Wartosc=''IED'' then 1 else 0 end) IED'
				else N',MAX(case when TrJ_Wartosc=''SW'' then 1 else 0 end) SW
				,MAX(case when TrJ_Wartosc=''EE'' then 1 else 0 end) EE' end +
				N',MAX(case when TrJ_Wartosc=''TP'' then 1 else 0 end) TP
				,MAX(case when TrJ_Wartosc=''TT_WNT'' then 1 else 0 end) TT_WNT
				,MAX(case when TrJ_Wartosc=''TT_D'' then 1 else 0 end) TT_D
				,MAX(case when TrJ_Wartosc=''MR_T'' then 1 else 0 end) MR_T
				,MAX(case when TrJ_Wartosc=''MR_UZ'' then 1 else 0 end) MR_UZ
				,MAX(case when TrJ_Wartosc=''I_42'' then 1 else 0 end) I_42
				,MAX(case when TrJ_Wartosc=''I_63'' then 1 else 0 end) I_63
				,MAX(case when TrJ_Wartosc=''B_SPV'' then 1 else 0 end) B_SPV
				,MAX(case when TrJ_Wartosc=''B_SPV_DOSTAWA'' then 1 else 0 end) B_SPV_DOSTAWA		
				,MAX(case when TrJ_Wartosc=''B_MPV_PROWIZJA'' then 1 else 0 end) B_MPV_PROWIZJA
				,MAX(case when TrJ_Wartosc=''MPP'' then 1 else 0 end) MPP	
			from cdn.TraJPK
			group by TrJ_TrNTyp, TrJ_TrNNumer
			) GTU on KodyGIDTyp=TrJ_TrNTyp and KodyGIDNumer=TrJ_TrNNumer
			where K_1000=0 or (K_1000&lt;&gt;0 and (isnull(MR_T,0)=1 or isnull(MR_UZ,0)=1))'	
			
			--select @sSQL
			--return							
	end
	else IF @wersjaDeklaracji &gt;= 17
	begin
		set @sSQL=N'
		select ROW_NUMBER() over (order by GIDTyp, GIDNumer) LpSprzedazy,
			GIDTyp, GIDNumer, NIP NrKontrahenta, case when isnull(Nazwa,'''')='''' then ''BRAK'' else Nazwa end NazwaKontrahenta, case when isnull(AdresNabywcy,'''')='''' then ''BRAK'' else AdresNabywcy end AdresKontrahenta
			,  NrDok DowodSprzedazy, DataWystaw DataWystawienia, case when DataSprzed=DataWystaw then 0 else DataSprzed end DataSprzedazy,
		
			sum(case when PoleNaDekl=10 then Netto else 0.00 end) as K_10,
			sum(case when PoleNaDekl=11 then Netto else 0.00 end) as K_11,
			sum(case when PoleNaDekl=12 then Netto else 0.00 end) as K_12,
			sum(case when PoleNaDekl=13 then Netto else 0.00 end) as K_13,
			sum(case when PoleNaDekl=14 then Netto else 0.00 end) as K_14,
			sum(case when PoleNaDekl=15 then Netto else 0.00 end) as K_15, SUM(case when PoleNaDekl=15 then Vat else 0.00 end) as K_16,		-- netto trafia do pola 15, vat trafia do pola 16
			sum(case when PoleNaDekl=17 then Netto else 0.00 end) as K_17, SUM(case when PoleNaDekl=17 then Vat else 0.00 end) as K_18,		
			sum(case when PoleNaDekl=19 then Netto else 0.00 end) as K_19, SUM(case when PoleNaDekl=19 then Vat else 0.00 end) as K_20,				
			sum(case when PoleNaDekl=21 then Netto else 0.00 end) as K_21,
			sum(case when PoleNaDekl=22 then Netto else 0.00 end) as K_22,
			sum(case when PoleNaDekl=23 then Netto else 0.00 end) as K_23, SUM(case when PoleNaDekl=23 then Vat else 0.00 end) as K_24,		
			sum(case when PoleNaDekl=25 then Netto else 0.00 end) as K_25, SUM(case when PoleNaDekl=25 then Vat else 0.00 end) as K_26,				
			sum(case when PoleNaDekl=27 then Netto else 0.00 end) as K_27, SUM(case when PoleNaDekl=27 then Vat else 0.00 end) as K_28,		
			sum(case when PoleNaDekl=29 then Netto else 0.00 end) as K_29, SUM(case when PoleNaDekl=29 then Vat else 0.00 end) as K_30,		
			sum(case when PoleNaDekl=31 then Netto else 0.00 end) as K_31,
			sum(case when PoleNaDekl=32 then Netto else 0.00 end) as K_32, SUM(case when PoleNaDekl=32 then Vat else 0.00 end) as K_33,		
			sum(case when PoleNaDekl=34 then Netto else 0.00 end) as K_34, SUM(case when PoleNaDekl=34 then Vat else 0.00 end) as K_35,
			sum(case when PoleNaDekl=36 then Vat else 0.00 end) as K_36,		
			sum(case when PoleNaDekl=37 then Vat else 0.00 end) as K_37,
			sum(case when PoleNaDekl=38 then Vat else 0.00 end) as K_38,
			sum(case when PoleNaDekl=39 then Vat else 0.00 end) as K_39
						
			, case when KorektaDanych=1 and TRV_KorektaDanych=0 then 1 else 0 end GIDLp1
		into ##tmpJPKVatS_' + convert(nvarchar,@JPKPONNumer) +		
		N' from #tmpWyn
		group by GIDTyp, GIDNumer, TRV_KorektaDanych, case when KorektaDanych=1 and TRV_KorektaDanych=0 then 1 else 0 end, DataSprzed, DataWystaw,  NrDok, Nazwa, AdresNabywcy, NIP'
	end
	else
	begin
		set @sSQL=N'
		select ROW_NUMBER() over (order by GIDTyp, GIDNumer) LpSprzedazy,
			GIDTyp, GIDNumer, case when DataSprzed=DataWystaw then 0 else DataSprzed end DataSprzedazy, DataWystaw DataWystawienia, NrDok NrDokumentu, Nazwa NazwaNabywcy, AdresNabywcy AdresNabywcy,
		
			sum(case when PoleNaDekl=10 then Netto else 0.00 end) as K_10,
			sum(case when PoleNaDekl=11 then Netto else 0.00 end) as K_11,
			sum(case when PoleNaDekl=12 then Netto else 0.00 end) as K_12,
			sum(case when PoleNaDekl=13 then Netto else 0.00 end) as K_13,
			sum(case when PoleNaDekl=14 then Netto else 0.00 end) as K_14,
			sum(case when PoleNaDekl=15 then Netto else 0.00 end) as K_15, SUM(case when PoleNaDekl=15 then Vat else 0.00 end) as K_16,		-- netto trafia do pola 15, vat trafia do pola 16
			sum(case when PoleNaDekl=17 then Netto else 0.00 end) as K_17, SUM(case when PoleNaDekl=17 then Vat else 0.00 end) as K_18,		
			sum(case when PoleNaDekl=19 then Netto else 0.00 end) as K_19, SUM(case when PoleNaDekl=19 then Vat else 0.00 end) as K_20,				
			sum(case when PoleNaDekl=21 then Netto else 0.00 end) as K_21,
			sum(case when PoleNaDekl=22 then Netto else 0.00 end) as K_22,
			sum(case when PoleNaDekl=23 then Netto else 0.00 end) as K_23, SUM(case when PoleNaDekl=23 then Vat else 0.00 end) as K_24,		
			sum(case when PoleNaDekl=25 then Netto else 0.00 end) as K_25, SUM(case when PoleNaDekl=25 then Vat else 0.00 end) as K_26,				
			sum(case when PoleNaDekl=27 then Netto else 0.00 end) as K_27, SUM(case when PoleNaDekl=27 then Vat else 0.00 end) as K_28,		
			sum(case when PoleNaDekl=29 then Netto else 0.00 end) as K_29, SUM(case when PoleNaDekl=29 then Vat else 0.00 end) as K_30,		
			sum(case when PoleNaDekl=31 then Netto else 0.00 end) as K_31,
			sum(case when PoleNaDekl=32 then Netto else 0.00 end) as K_32, SUM(case when PoleNaDekl=32 then Vat else 0.00 end) as K_33,		
			sum(case when PoleNaDekl=34 then Netto else 0.00 end) as K_34, SUM(case when PoleNaDekl=34 then Vat else 0.00 end) as K_35,
			sum(case when PoleNaDekl=36 then Netto else 0.00 end) as K_36,		
			convert(decimal(15,2), 0) as K_37,	-- 37 nie jest wyliczane
			sum(case when PoleNaDekl=37 then Vat else 0.00 end) as K_38
			, case when KorektaDanych=1 and TRV_KorektaDanych=0 then 1 else 0 end GIDLp1
		into ##tmpJPKVatS_' + convert(nvarchar,@JPKPONNumer) +		
		N' from #tmpWyn
		group by GIDTyp, GIDNumer, TRV_KorektaDanych, case when KorektaDanych=1 and TRV_KorektaDanych=0 then 1 else 0 end, DataSprzed, DataWystaw,  NrDok, Nazwa, AdresNabywcy'
	
	
		if not (@uzgodnijVAT7=0 or @PONNumer=0)
		begin									
			declare @deklP10 decimal(15,2)=0.00,@deklP11 decimal(15,2)=0.00,@deklP12 decimal(15,2)=0.00,@deklP13 decimal(15,2)=0.00,@deklP14 decimal(15,2)=0.00,
			@deklP15 decimal(15,2)=0.00,@deklP16 decimal(15,2)=0.00,@deklP17 decimal(15,2)=0.00,@deklP18 decimal(15,2)=0.00,@deklP19 decimal(15,2)=0.00,
			@deklP20 decimal(15,2)=0.00,@deklP21 decimal(15,2)=0.00,@deklP22 decimal(15,2)=0.00,@deklP23 decimal(15,2)=0.00,@deklP24 decimal(15,2)=0.00,
			@deklP25 decimal(15,2)=0.00,@deklP26 decimal(15,2)=0.00,@deklP27 decimal(15,2)=0.00,@deklP28 decimal(15,2)=0.00,@deklP29 decimal(15,2)=0.00,
			@deklP30 decimal(15,2)=0.00,@deklP31 decimal(15,2)=0.00,@deklP32 decimal(15,2)=0.00,@deklP33 decimal(15,2)=0.00,@deklP34 decimal(15,2)=0.00,
			@deklP35 decimal(15,2)=0.00,@deklP36 decimal(15,2)=0.00,@deklP37 decimal(15,2)=0.00,@deklP38 decimal(15,2)=0.00,@deklP39 decimal(15,2)=0.00
			,@deklP73 int=0	-- data przeliczenia deklaracji

			select @deklP10=sum(case when POE_Pozycja=10 then POE_KwotaL else 0.00 end) --P10
				, @deklP11=sum(case when POE_Pozycja=11 then POE_KwotaL else 0.00 end) 
				, @deklP12=sum(case when POE_Pozycja=12 then POE_KwotaL else 0.00 end) 
				, @deklP13=sum(case when POE_Pozycja=13 then POE_KwotaL else 0.00 end) 
				, @deklP14=sum(case when POE_Pozycja=14 then POE_KwotaL else 0.00 end) 
				, @deklP15=sum(case when POE_Pozycja=15 then POE_KwotaL else 0.00 end) 
				, @deklP16=sum(case when POE_Pozycja=16 then POE_KwotaL else 0.00 end) 
				, @deklP17=sum(case when POE_Pozycja=17 then POE_KwotaL else 0.00 end) 
				, @deklP18=sum(case when POE_Pozycja=18 then POE_KwotaL else 0.00 end) 
				, @deklP19=sum(case when POE_Pozycja=19 then POE_KwotaL else 0.00 end) 
				, @deklP20=sum(case when POE_Pozycja=20 then POE_KwotaL else 0.00 end) 
				, @deklP21=sum(case when POE_Pozycja=21 then POE_KwotaL else 0.00 end) 
				, @deklP22=sum(case when POE_Pozycja=22 then POE_KwotaL else 0.00 end) 
				, @deklP23=sum(case when POE_Pozycja=23 then POE_KwotaL else 0.00 end) 
				, @deklP24=sum(case when POE_Pozycja=24 then POE_KwotaL else 0.00 end) 
				, @deklP25=sum(case when POE_Pozycja=25 then POE_KwotaL else 0.00 end) 
				, @deklP26=sum(case when POE_Pozycja=26 then POE_KwotaL else 0.00 end) 
				, @deklP27=sum(case when POE_Pozycja=27 then POE_KwotaL else 0.00 end) 
				, @deklP28=sum(case when POE_Pozycja=28 then POE_KwotaL else 0.00 end) 
				, @deklP29=sum(case when POE_Pozycja=29 then POE_KwotaL else 0.00 end) 
				, @deklP30=sum(case when POE_Pozycja=30 then POE_KwotaL else 0.00 end) 
				, @deklP31=sum(case when POE_Pozycja=31 then POE_KwotaL else 0.00 end) 
				, @deklP32=sum(case when POE_Pozycja=32 then POE_KwotaL else 0.00 end) 
				, @deklP33=sum(case when POE_Pozycja=33 then POE_KwotaL else 0.00 end) 
				, @deklP34=sum(case when POE_Pozycja=34 then POE_KwotaL else 0.00 end) 
				, @deklP35=sum(case when POE_Pozycja=35 then POE_KwotaL else 0.00 end) 
				, @deklP36=sum(case when POE_Pozycja=36 then POE_KwotaL else 0.00 end) 
				, @deklP37=sum(case when POE_Pozycja=37 then POE_KwotaL else 0.00 end) 
				, @deklP38=sum(case when POE_Pozycja=38 then POE_KwotaL else 0.00 end) 	
				, @deklP73=SUM(case when POE_Pozycja=73 then POE_KwotaL else 0.00 end) 
			from cdn.PodElem
			where POE_GIDNumer=@PONNumer

			
			set @sSQL=@sSQL + N';
			if (select count(*) from ##tmpJPKVatS_' + convert(nvarchar,@JPKPONNumer) + ') &gt; 0
			insert into ##tmpJPKVatS_' + convert(nvarchar,@JPKPONNumer) +
			N' select isnull(MAX(LpSprzedazy),0) + 1 LpSprzedazy,0 GIDTyp, 0 GIDNumer, 0 DataSprzedazy, @deklP73 DataWystawienia, ''Zaokrąglenia'' NrDokumentu, '''' NazwaNabywcy, '''' AdresNabywcy,		
				isnull(@deklP10,0) - sum(K_10),
				isnull(@deklP11,0) - sum(K_11),
				isnull(@deklP12,0) - sum(K_12),
				isnull(@deklP13,0) - sum(K_13),
				isnull(@deklP14,0) - sum(K_14),
				isnull(@deklP15,0) - sum(K_15), isnull(@deklP16,0) - SUM(K_16),		-- netto trafia do pola 15, vat trafia do pola 16
				isnull(@deklP17,0) - sum(K_17), isnull(@deklP18,0) - SUM(K_18),
				isnull(@deklP19,0) - sum(K_19), isnull(@deklP20,0) - SUM(K_20),
				isnull(@deklP21,0) - sum(K_21),
				isnull(@deklP22,0) - sum(K_22),
				isnull(@deklP23,0) - sum(K_23), isnull(@deklP24,0) - SUM(K_24),
				isnull(@deklP25,0) - sum(K_25), isnull(@deklP26,0) - SUM(K_26),
				isnull(@deklP27,0) - sum(K_27), isnull(@deklP28,0) - SUM(K_28),
				isnull(@deklP29,0) - sum(K_29), isnull(@deklP30,0) - SUM(K_30),
				isnull(@deklP31,0) - sum(K_31),
				isnull(@deklP32,0) - sum(K_32), isnull(@deklP33,0) - SUM(K_33),
				isnull(@deklP34,0) - sum(K_34), isnull(@deklP35,0) - SUM(K_35),
				isnull(@deklP36,0), isnull(@deklP37,0),
				isnull(@deklP38,0) - sum(K_38)
				,0 GIDLp1
			from ##tmpJPKVatS_' + convert(nvarchar,@JPKPONNumer)
		end
	end
		
	if @wersjaDeklaracji &lt; 17
		EXECUTE @rv=sp_executesql @sSQL, 
			N'@deklP10 decimal(15,2),@deklP11 decimal(15,2),@deklP12 decimal(15,2),@deklP13 decimal(15,2),@deklP14 decimal(15,2),@deklP15 decimal(15,2),@deklP16 decimal(15,2),@deklP17 decimal(15,2),@deklP18 decimal(15,2),@deklP19 decimal(15,2),
			@deklP20 decimal(15,2),@deklP21 decimal(15,2),@deklP22 decimal(15,2),@deklP23 decimal(15,2),@deklP24 decimal(15,2),@deklP25 decimal(15,2),@deklP26 decimal(15,2),@deklP27 decimal(15,2),@deklP28 decimal(15,2),@deklP29 decimal(15,2),
			@deklP30 decimal(15,2),@deklP31 decimal(15,2),@deklP32 decimal(15,2),@deklP33 decimal(15,2),@deklP34 decimal(15,2),@deklP35 decimal(15,2),@deklP36 decimal(15,2),@deklP37 decimal(15,2),@deklP38 decimal(15,2),@deklP73 int'
			,@deklP10=@deklP10,@deklP11=@deklP11,@deklP12=@deklP12,@deklP13=@deklP13,@deklP14=@deklP14,@deklP15=@deklP15,@deklP16=@deklP16,@deklP17=@deklP17,@deklP18=@deklP18,@deklP19=@deklP19,@deklP20=@deklP20,@deklP21=@deklP21,@deklP22=@deklP22,@deklP23=@deklP23,@deklP24=@deklP24,
			@deklP25=@deklP25,@deklP26=@deklP26,@deklP27=@deklP27,@deklP28=@deklP28,@deklP29=@deklP29,@deklP30=@deklP30,@deklP31=@deklP31,@deklP32=@deklP32,@deklP33=@deklP33,@deklP34=@deklP34,@deklP35=@deklP35,@deklP36=@deklP36,@deklP37=@deklP37,@deklP38=@deklP38,@deklP73=@deklP73
	else
		EXECUTE @rv=sp_executesql @sSQL, 
			N'@Rok SMALLINT,@Miesiac TINYINT,
			@deklP10 decimal(15,2),@deklP11 decimal(15,2),@deklP12 decimal(15,2),@deklP13 decimal(15,2),@deklP14 decimal(15,2),@deklP15 decimal(15,2),@deklP16 decimal(15,2),@deklP17 decimal(15,2),@deklP18 decimal(15,2),@deklP19 decimal(15,2),
			@deklP20 decimal(15,2),@deklP21 decimal(15,2),@deklP22 decimal(15,2),@deklP23 decimal(15,2),@deklP24 decimal(15,2),@deklP25 decimal(15,2),@deklP26 decimal(15,2),@deklP27 decimal(15,2),@deklP28 decimal(15,2),@deklP29 decimal(15,2),
			@deklP30 decimal(15,2),@deklP31 decimal(15,2),@deklP32 decimal(15,2),@deklP33 decimal(15,2),@deklP34 decimal(15,2),@deklP35 decimal(15,2),@deklP36 decimal(15,2),@deklP37 decimal(15,2),@deklP38 decimal(15,2),@deklP39 decimal(15,2),@deklP73 int'
			,@Rok, @Miesiac
			,@deklP10=@deklP10,@deklP11=@deklP11,@deklP12=@deklP12,@deklP13=@deklP13,@deklP14=@deklP14,@deklP15=@deklP15,@deklP16=@deklP16,@deklP17=@deklP17,@deklP18=@deklP18,@deklP19=@deklP19,@deklP20=@deklP20,@deklP21=@deklP21,@deklP22=@deklP22,@deklP23=@deklP23,@deklP24=@deklP24,
			@deklP25=@deklP25,@deklP26=@deklP26,@deklP27=@deklP27,@deklP28=@deklP28,@deklP29=@deklP29,@deklP30=@deklP30,@deklP31=@deklP31,@deklP32=@deklP32,@deklP33=@deklP33,@deklP34=@deklP34,@deklP35=@deklP35,@deklP36=@deklP36,@deklP37=@deklP37,@deklP38=@deklP38,@deklP39=@deklP39,@deklP73=@deklP73


set nocount off	
END	
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[FakturySprzedazyWgDeklaracjiVatJPK]"></A><PRE>
          <FONT SIZE="2"><I>/* [FakturySprzedazyWgDeklaracjiVatJPK] */</I><BR>
create procedure [CDN].[FakturySprzedazyWgDeklaracjiVatJPK] (@miesiacKwartal tinyint, @kwartal tinyint, @miesiac tinyint, @rok smallint, @wersjaDeklaracji smallint = 12, @uzgodnijVAT7 tinyint=0, @JPKPONNumer int=0, @DokZaksiegowane tinyint=0) as
begin
	--
	declare @konKwart tinyint = 0
	declare @poczKwart tinyint = 0
	declare @sSQL nvarchar(max) 
	declare @rv int	
	
	if @miesiacKwartal &gt; 0
	begin
		set @poczKwart = ((@kwartal - 1) * 3) + 1
		set @konKwart = @poczKwart + 2
	end
	
	declare @e_ksi_lPodatek_VAT7 tinyint = 1, @TYP_Deklaracja_VAT7 smallint = 2768	
	declare @PONNumer int = 0	
	
	if @uzgodnijVAT7 &gt; 0 and @wersjaDeklaracji &lt; 17
	begin
		-- wczytaj dane z zaakceptowanej/zatwierdzonej deklaracji VAT-7(16)
		select @PONNumer = PON_GIDNumer
		from cdn.PodNag 
		join cdn.PodElem on PON_GIDNumer = POE_GIDNumer
		where PON_GIDTyp = @TYP_Deklaracja_VAT7 and PON_TypPodatku = @e_ksi_lPodatek_VAT7
			and PON_Rok = @rok and PON_Miesiac = @miesiac and PON_Status in (1,2)			
	end	

	declare @GIDFirma int = 0
	select top 1 @GIDFirma = Ope_GIDFirma from cdn.OpeKarty

	declare 
		@Typ_FW		int
		, @Typ_FWK  int
		, @Typ_FWS	int
		, @Typ_FKS	int
		, @Typ_RA   smallint
		, @Typ_FS   smallint
		, @Typ_FSE	smallint
		, @Typ_FSL  smallint
		, @Typ_FEL  smallint
		
		, @g_ksi_lUwzgledniajNieopodatkowane tinyint
		, @g_ksi_lUwzgledniajZakup0zw tinyint
		, @g_ksi_InterpretujTransDostOpodatkPozaTerytKrajWSt0JakoKrajowa tinyint
		
	set @Typ_FW		= 2036
	set @Typ_FWK    = 2044	
	set @Typ_FWS	= 3379
	set @Typ_FKS	= 3387
	set @Typ_RA 	= 2035
	set @Typ_FS		= 2033
	set @Typ_FSE	= 2037
	set @Typ_FSL	= 1824
	set @Typ_FEL	= 1828
		
	set @g_ksi_lUwzgledniajNieopodatkowane = 0
	set @g_ksi_lUwzgledniajZakup0zw = 0

	declare @e_SPR_nNieEksportowy                     tinyint       -- nie eksportowy
	, @e_SPR_nEksportowyVat0                          tinyint       -- eksportowy VAT0%
	, @e_SPR_nEksportowyVatDowolny                    tinyint       -- eksportowy VAT dowolny
	, @e_SPR_nEksportowyVatDowolnyKorekta             tinyint       -- korekta vat dowolny  -&gt; vat eksportowy
	, @e_SPR_nEksportowyVat0Korekta                   tinyint       -- korekta vat eksportowy -&gt; vat dowolny
	, @e_SPR_nWewnatrzwspolnotowyVat0D                tinyint       -- Wewnątrzwspólnotowy dostawa Vat 0
	, @e_SPR_nWewnatrzwspolnotowyVatDowolnyD          tinyint       -- Wewnątrzwspólnotowy dostawa Vat dowolny
	, @e_SPR_nWewnatrzwspolnotowyVat0DT               tinyint       -- Wewnątrzwspólnotowa dostawa, trójstronna Vat 0,
	, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDT         tinyint       -- Wewnątrzwspólnotowa dostawa, trójstronna Vat dowolny,
	, @e_SPR_nWewnatrzwspolnotowyVat0N                tinyint      -- Wewnątrzwspólnotowe nabycie Vat 0
	, @e_SPR_nWewnatrzwspolnotowyVatDowolnyN          tinyint      -- Wewnątrzwspólnotowe nabycie Vat dowolny
	, @e_SPR_nWewnatrzwspolnotowyVat0NT               tinyint      -- Wewnątrzwspólnotowe nabycie, trójstronne Vat 0
	, @e_SPR_nWewnatrzwspolnotowyVatDowolnyNT         tinyint      -- Wewnątrzwspólnotowe nabycie, trójstronne Vat dowolny
	, @e_SPR_nImportowyVat0FW                         tinyint      -- eksportowy VAT0% dla FWS
	, @e_SPR_nImportowyVatDowolnyFW                   tinyint      -- eksportowy VAT dowolny dla FWS
	, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDKorekta   tinyint      -- korekta wewnątrzwspólnotowy dostawa Vat dowolny
	, @e_SPR_nWewnatrzwspolnotowyVat0DKorekta         tinyint      -- korekta wewnątrzwspólnotowy dostawa Vat 0
	, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDTKorekta  tinyint      -- korekta wewnątrzwspólnotowa dostawa trójstronna Vat dowolny
	, @e_SPR_nWewnatrzwspolnotowyVat0DTKorekta        tinyint      -- korekta wewnątrzwspólnotowa dostawa trójstronna Vat 0
	, @e_SPR_nEksportowyNabywca                       tinyint      -- podatnikiem jest nabywca
	, @e_SPR_nDostawaOpodatkowanaWWsp                 tinyint      -- dostawa opodatkowana poza terytorium kraju
	, @e_SPR_nTaxFree                                 tinyint      -- tax free
	, @e_SPR_nDostawaOpodatkowanaInne                 tinyint      -- dostawa opodatkowana poza terytorium kraju
	, @e_SPR_nEksportowyNabywcaWsp					  tinyint      --podatnikiem jest Nabywca (transakcja Wewnątrzwspólnotowa)
	, @e_SPR_nEksportowyNabywcaInne					  tinyint	   --podatnikime jest Nabywca (transakcja Inna zagranicznia)
	, @e_SPR_nWSTO_EE								  tinyint		--WSTO_EE

	declare @e_ksi_lRodzajZakupu_Towary			tinyint
	declare @e_ksi_lRodzajZakupu_Koszty			tinyint
	declare @e_ksi_lRodzajZakupu_SrTrwale		tinyint
	declare @e_ksi_lRodzajZakupu_Inwestycje		tinyint
	declare @e_ksi_lRodzajZakupu_Nieruchomosci	tinyint
	declare @e_ksi_lRodzajZakupu_ImportUslug	tinyint
	declare @e_ksi_lRodzajZakupu_SrTransportu	tinyint
	declare @e_ksi_lRodzajZakupu_Paliwo			tinyint
	declare @e_ksi_lRodzajZakupu_UslugiRO		tinyint

	set @e_SPR_nNieEksportowy                     = 1       -- nie eksportowy
	set @e_SPR_nEksportowyVat0                    = 2       -- eksportowy VAT0%
	set @e_SPR_nEksportowyVatDowolny              = 3       -- eksportowy VAT dowolny
	set @e_SPR_nEksportowyVatDowolnyKorekta       = 4       -- korekta vat dowolny  -&gt; vat eksportowy
	set @e_SPR_nEksportowyVat0Korekta             = 5       -- korekta vat eksportowy -&gt; vat dowolny
	set @e_SPR_nWewnatrzwspolnotowyVat0D          = 6       -- Wewnątrzwspólnotowy dostawa Vat 0
	set @e_SPR_nWewnatrzwspolnotowyVatDowolnyD    = 7       -- Wewnątrzwspólnotowy dostawa Vat dowolny
	set @e_SPR_nWewnatrzwspolnotowyVat0DT         = 8       -- Wewnątrzwspólnotowa dostawa, trójstronna Vat 0,
	set @e_SPR_nWewnatrzwspolnotowyVatDowolnyDT   = 9       -- Wewnątrzwspólnotowa dostawa, trójstronna Vat dowolny,
	set @e_SPR_nWewnatrzwspolnotowyVat0N          = 10      -- Wewnątrzwspólnotowe nabycie Vat 0
	set @e_SPR_nWewnatrzwspolnotowyVatDowolnyN    = 11      -- Wewnątrzwspólnotowe nabycie Vat dowolny
	set @e_SPR_nWewnatrzwspolnotowyVat0NT         = 12      -- Wewnątrzwspólnotowe nabycie, trójstronne Vat 0
	set @e_SPR_nWewnatrzwspolnotowyVatDowolnyNT   = 13      -- Wewnątrzwspólnotowe nabycie, trójstronne Vat dowolny
	set @e_SPR_nImportowyVat0FW                   = 14      -- eksportowy VAT0% dla FWS
	set @e_SPR_nImportowyVatDowolnyFW             = 15      -- eksportowy VAT dowolny dla FWS
	set @e_SPR_nWewnatrzwspolnotowyVatDowolnyDKorekta   = 16      -- korekta wewnątrzwspólnotowy dostawa Vat dowolny
	set @e_SPR_nWewnatrzwspolnotowyVat0DKorekta         = 17      -- korekta wewnątrzwspólnotowy dostawa Vat 0
	set @e_SPR_nWewnatrzwspolnotowyVatDowolnyDTKorekta  = 18      -- korekta wewnątrzwspólnotowa dostawa trójstronna Vat dowolny
	set @e_SPR_nWewnatrzwspolnotowyVat0DTKorekta        = 19      -- korekta wewnątrzwspólnotowa dostawa trójstronna Vat 0
	set @e_SPR_nEksportowyNabywca                       = 20      -- podatnikiem jest nabywca
	set @e_SPR_nDostawaOpodatkowanaWWsp                 = 21      -- dostawa opodatkowana poza terytorium kraju
	set @e_SPR_nTaxFree                                 = 22      -- tax free
	set @e_SPR_nDostawaOpodatkowanaInne                 = 23      -- dostawa opodatkowana poza terytorium kraju
	set @e_SPR_nEksportowyNabywcaWsp	= 24      --podatnikiem jest Nabywca (transakcja Wewnątrzwspólnotowa)
	set @e_SPR_nEksportowyNabywcaInne	= 25      --podatnikime jest Nabywca (transakcja Inna zagranicznia)
	set @e_SPR_nWSTO_EE = 26						--WSTO_EE
	
	set @e_ksi_lRodzajZakupu_Towary			= 1
	set @e_ksi_lRodzajZakupu_Koszty			= 2
	set @e_ksi_lRodzajZakupu_SrTrwale		= 3
	set @e_ksi_lRodzajZakupu_Inwestycje		= @e_ksi_lRodzajZakupu_SrTrwale
	set @e_ksi_lRodzajZakupu_Nieruchomosci	= 4
	set @e_ksi_lRodzajZakupu_ImportUslug	= 5
	set @e_ksi_lRodzajZakupu_SrTransportu	= 6
	set @e_ksi_lRodzajZakupu_Paliwo			= 7  
	set @e_ksi_lRodzajZakupu_UslugiRO		= 8	

	declare @e_ksi_lOdliczeniaVAT_Tak	tinyint, @e_ksi_lOdliczeniaVAT_Nie		tinyint, @e_ksi_lOdliczeniaVAT_Warunkowo	tinyint
		
	set @e_ksi_lOdliczeniaVAT_Tak	 = 1
	set @e_ksi_lOdliczeniaVAT_Nie		= 2
	set @e_ksi_lOdliczeniaVAT_Warunkowo	= 3

	select @g_ksi_lUwzgledniajNieopodatkowane = CAST(KON_Wartosc as int) from cdn.Konfig where Kon_Numer = 2056
	select @g_ksi_lUwzgledniajZakup0zw = CAST(KON_Wartosc as int) from cdn.Konfig where Kon_Numer = 2071
	select @g_ksi_InterpretujTransDostOpodatkPozaTerytKrajWSt0JakoKrajowa = cast(KON_Wartosc as int) from cdn.Konfig where Kon_Numer = 20143

	create table #tmpWyn
	(	
		GIDTyp smallint, 
		GIDNumer int, 
		GIDLp smallint, 		
		NrWRej int,
		Rejestr varchar(5),
		PoleNaDekl smallint,
		Odliczenie tinyint,		-- pełne, warunkowe (tak, nie, warunkowe)
		DataWystaw int,
		DataSprzed int,
		NrDok varchar(60),
		Akronim varchar(50),
		Nazwa varchar(400),		-- NazwaNabywcy
		Netto decimal(15,2),
		Vat decimal(15,2),
				
		AdresNabywcy varchar(512),
		NIP varchar(25),
		VatNalOd tinyint,
		KorektaDanych tinyint,
		TrV_KorektaDanych tinyint,
		KNANipPrefiks varchar(2),
		KNAKodKraju varchar(2),
		KNTExpoKraj tinyint,
		TSV_Rozliczac tinyint,
		KodyGIDTyp smallint,
		KodyGIDNumer int		
	)	

	create table #tmpDokumenty		-- tfs 318633
	(
		TRV_GIDTyp smallint, 
		TRV_GIDNumer int, 
		TRV_GIDLp smallint, 
		TRN_VatRejestr varchar(5), 
		TrN_VatNumer int, 
		DataWyst int, 
		DataZak int,
		Netto decimal(15,2),
		Vat decimal(15,2),
		TRV_StawkaPod decimal(7,2), 
		TRV_FlagaVat tinyint, 
		TRV_RodzajZakupu tinyint, 
		TRV_Struktura tinyint, 
		TRN_VatKorekta tinyint, 
		TRV_ExpoNorm tinyint, 
		TRV_Zrodlowa tinyint,
		TRN_VatRok smallint, 
		TRN_VatMiesiac tinyint, 
		TRN_RolnikRyczalt tinyint, 
		TRN_KorektaOdlicz tinyint, 
		CzySad tinyint,			
		NumerDok varchar(60),
		KnA_Akronim varchar(50), 
		KNTNazwa varchar(400), 
		KnAAdres varchar(500), 
		NIP varchar(25), 
		TrV_VATNalOd tinyint, 
		TrN_ZwrNumer int,
		KorektaDanych tinyint,
		TRV_KorektaDanych tinyint,
		KNANipPrefiks varchar(2),
		KNAKodKraju varchar(2),
		KNTExpoKraj tinyint,
		TSV_Rozliczac tinyint,
		TRN_Fiskalny tinyint,
		TRN_TRNTyp smallint,
		KodyGIDTyp smallint,
		KodyGIDNumer int,
		TRN_DokTypJPK varchar(50),
		VatMarza smallint
	)		
	

	if @GIDFirma in (736001, 570625)		-- tfs 318633
		insert into #tmpDokumenty
		select * from
		(     
			SELECT TRV_GIDTyp, TRV_GIDNumer, TRV_GIDLp, TRN_VatRejestr, TrN_VatNumer
				, case when TrN_KorektaDanych &gt; 0 and TrN_DataWystOrg &gt; 0 then TrN_DataWystOrg else TrN_Data2 end DataWyst
				
				, case when TrN_KorektaDanych &gt; 0 and TrN_DataSprOrg &gt; 0 then TrN_DataSprOrg else TrN_Data3 end DataZak,
				CASE WHEN (TSV_NettoP+TSV_VatP) &lt;&gt; 0 THEN TSV_NettoP ELSE TSV_NettoR END as Netto,
				CASE WHEN (TSV_NettoP+TSV_VatP) &lt;&gt; 0 THEN TSV_VatP ELSE TSV_VatR END as Vat,
				TRV_StawkaPod, TRV_FlagaVat, TSV_RodzajZakupu, TRV_Struktura, 
				TRN_VatKorekta, TRV_ExpoNorm, TRV_Zrodlowa,
			    
				TRN_VatRok, TRN_VatMiesiac, TRN_RolnikRyczalt, TRN_KorektaOdlicz, 0 as CzySad,

				case when TrN_KorektaDanych &gt; 0 and TrN_NrKorekty &lt;&gt; '' and TrV_KorektaDanych=1 and @wersjaDeklaracji&lt;21 then TrN_NrKorekty 
				else case when TrN_DokumentObcy &lt;&gt; '' then TrN_DokumentObcy 
					when @wersjaDeklaracji&gt;=21 then CDN.NumerDokumentuZ(TrN_GidTyp, TrN_SpiTyp, TrN_TrNTyp, TrN_TrNNumer, TrN_TrNRok, TrN_TrNSeria, TrN_TrNMiesiac, TrN_ZwrTyp, TrN_ZwrNumer, TrN_WMS) 
					else 'brak' end 
				end as NumerDok		--CDN.NumerDokumentu(TrN_GIDTyp, TrN_SpiTyp,TrN_TrnTyp,TrN_TrnNumer,TrN_TrNRok,Trn_TrnSeria,TrN_TrnMiesiac) end as NumerDok

				, isnull(trvk.KnA_Akronim, trnk.KnA_Akronim) KnA_Akronim
				, case when @wersjaDeklaracji&gt;=21 then 
					case when TrV_KnANumer &lt;&gt; 0 then trvk.KnA_Nazwa1+' '+trvk.KnA_Nazwa2+' '+trvk.KnA_Nazwa3 else trnk.KnA_Nazwa1 + ' ' + trnk.KnA_Nazwa2 + ' ' + trnk.KnA_Nazwa3 end
				else
					case when TrV_KnANumer &lt;&gt; 0 then trvk.KnA_Nazwa1+' '+trvk.KnA_Nazwa2 else case when isnull(trnk.KnA_Nazwa1,'')='' and isnull(trnk.KnA_Nazwa2,'')='' and @wersjaDeklaracji = 2 then 'BRAK' else trnk.KnA_Nazwa1 + ' ' + trnk.KnA_Nazwa2 end end
				end KNTNazwa
				, case when TrV_KnANumer &lt;&gt; 0 then trvk.KnA_Ulica + ' ' + trvk.KnA_Adres + ' ' + trvk.KnA_KodP + ' ' + trvk.KnA_Miasto else LTRIM(RTRIM(case when isnull(trnk.KnA_Ulica,'')='' and isnull(trnk.KnA_Adres,'')='' and isnull(trnk.KnA_KodP,'')='' and isnull(trnk.KnA_Miasto,'')='' and @wersjaDeklaracji = 2 then 'BRAK' else trnk.KnA_Ulica + ' ' + trnk.KnA_Adres + ' ' + trnk.KnA_KodP + ' ' + trnk.KnA_Miasto end)) end as KnAAdres
				
				, case when isnull(trnk.KnA_Nip,'')='' and isnull(trvk.KnA_Nip,'')='' then 'BRAK' else 
					case when TRV_ExpoNorm in (@e_SPR_nWewnatrzwspolnotowyVat0D, @e_SPR_nWewnatrzwspolnotowyVatDowolnyD, @e_SPR_nWewnatrzwspolnotowyVat0DT, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDT
					, @e_SPR_nWewnatrzwspolnotowyVat0N, @e_SPR_nWewnatrzwspolnotowyVatDowolnyN, @e_SPR_nWewnatrzwspolnotowyVat0NT, @e_SPR_nWewnatrzwspolnotowyVatDowolnyNT
					, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDKorekta, @e_SPR_nWewnatrzwspolnotowyVat0DKorekta, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDTKorekta, @e_SPR_nWewnatrzwspolnotowyVat0DTKorekta
					, @e_SPR_nDostawaOpodatkowanaWWsp) then case when @wersjaDeklaracji&gt;=21 then '' else case when TrV_KnANumer = 0 then trnk.KnA_NipPrefiks else trvk.KnA_NipPrefiks end end else '' end + case when TrV_KnANumer = 0 then trnk.KnA_Nip else case when isnull(trvk.KnA_Nip,'')='' then 'BRAK' else trvk.KnA_Nip end end end NIP
				, TrV_VATNalOd
				, TrN_ZwrNumer
				, TrN_KorektaDanych
				, TrV_KorektaDanych
				, case when TrV_KnANumer &lt;&gt; 0 then case when isnull(trvk.KnA_NipPrefiks,'') &lt;&gt; '' then trvk.KnA_NipPrefiks else '' end else case when isnull(trnk.KnA_NipPrefiks,'') &lt;&gt; '' then trnk.KnA_NipPrefiks else '' end end KnA_NipPrefiks
				, case when TrV_KnANumer &lt;&gt; 0 then case when isnull(trvk.KnA_Kraj,'') &lt;&gt; '' then trvk.KnA_Kraj else '' end else case when isnull(trnk.KnA_Kraj,'') &lt;&gt; '' then trnk.KnA_Kraj else '' end end KnA_Kraj
				, case when TrV_KnANumer &lt;&gt; 0 then trvknt.Knt_ExpoKraj else trnknt.Knt_ExpoKraj end KNTExpoKraj
				, TSV_Rozliczac
				, TRN_Fiskalny
				, TrN_TrNTyp	
				, case when TRN_KorektaDanych=0 then TRN_GIDTyp else case when TrN_KnANumer&lt;&gt;TrV_KnANumer then TrN_ZwrTyp else TRN_GIDTyp end end KodyGIDTyp
				, case when TRN_KorektaDanych=0 then TRN_GIDNumer else case when TrN_KnANumer&lt;&gt;TrV_KnANumer then TrN_ZwrNumer else TRN_GIDNumer end end KodyGIDNumer
				,TRN_DokTypJPK,0 VatMarza
			FROM CDN.TraVat 
				JOIN CDN.TraNag ON TRV_GIDTyp = TRN_GIDTyp AND TRV_GIDNumer = TRN_GIDNumer 
				JOIN CDN.TraSVat ON TRV_GIDTyp = TSV_GIDTyp AND TRV_GIDNumer = TSV_GIDNumer AND TrV_GIDLp = TSV_GIDLp
				
				LEFT JOIN CDN.KntAdresy trnk ON TrN_AdPNumer = trnk.KnA_GIDNumer
				LEFT JOIN CDN.KntKarty trnKnt on trnk.KNA_KNtNumer=trnKnt.KNT_GIDNumer
				LEFT JOIN cdn.KntAdresy trvk ON TrV_KnANumer = trvk.KnA_GIDNumer
				LEFT JOIN CDN.KntKarty trvKnt on trvk.KNA_KNtNumer=trvKnt.KNT_GIDNumer
			WHERE TRN_VatTyp=2 AND TSV_DeklRok = @rok
				AND ( (@miesiacKwartal = 0 AND TSV_DeklMiesiac = @miesiac) OR (@miesiacKwartal = 1 AND TSV_DeklMiesiac BETWEEN @poczKwart AND @konKwart) )
				AND TRN_VatRejestr &lt;&gt; ''
				AND TrN_ProceduraOSS=0
				AND (@DokZaksiegowane=0 OR (@DokZaksiegowane=1 AND TrN_Zaksiegowano=1) OR (@DokZaksiegowane=2 AND TrN_Zaksiegowano=0))

			UNION ALL
				
			SELECT TRV_GIDTyp, TRV_GIDNumer, TRV_GIDLp, SaN_VatRejestr, SaN_VatNumer
				, SaN_DataWplywu DataWyst				
				, case when @WersjaDeklaracji&gt;=21 and TRV_GIDTyp=@Typ_FKS then 0 else SaN_DataZgloszenia end DataZak,
				CASE WHEN (TSV_NettoP + TSV_VatP) &lt;&gt; 0 THEN TSV_NettoP ELSE TSV_NettoR END as Netto, 
				CASE WHEN (TSV_NettoP + TSV_VatP) &lt;&gt; 0 THEN TSV_VatP ELSE TSV_VatR END as Vat, 
				TRV_StawkaPod, TRV_FlagaVat, TSV_RodzajZakupu, TRV_Struktura, 0, TRV_ExpoNorm, TRV_Zrodlowa ,
			    
				SAN_VatRok, SAN_VatMiesiac, 0, 0, 1,
				case when SaN_NumerSAD &lt;&gt; '' then SaN_NumerSAD else 'brak' end	--CDN.NumerDokumentu(SaN_GIDTyp,0,SaN_SaNTyp,SaN_SaNNumer,SaN_SaNRok,SaN_SaNSeria,SaN_SaNMiesiac) end
				, isnull(trvk.KnA_Akronim, trnk.KnA_Akronim) KnA_Akronim
				, case when @wersjaDeklaracji&gt;=21 then 
					case when TrV_KnANumer &lt;&gt; 0 then trvk.KnA_Nazwa1+' '+trvk.KnA_Nazwa2+' '+trvk.KnA_Nazwa3 else trnk.KnA_Nazwa1 + ' ' + trnk.KnA_Nazwa2 + ' ' + trnk.KnA_Nazwa3 end
				else
					case when TrV_KnANumer &lt;&gt; 0 then trvk.KnA_Nazwa1+' '+trvk.KnA_Nazwa2 else case when isnull(trnk.KnA_Nazwa1,'')='' and isnull(trnk.KnA_Nazwa2,'')='' and @wersjaDeklaracji = 2 then 'BRAK' else trnk.KnA_Nazwa1 + ' ' + trnk.KnA_Nazwa2 end end
				end KNTNazwa
				, LTRIM(RTRIM(case when TrV_KnANumer &lt;&gt; 0 then trvk.KnA_Ulica + ' ' + trvk.KnA_Adres + ' ' + trvk.KnA_KodP + ' ' + trvk.KnA_Miasto 
				else case when isnull(trnk.KnA_Ulica,'')='' and isnull(trnk.KnA_Adres,'')='' and isnull(trnk.KnA_KodP,'')='' and isnull(trnk.KnA_Miasto,'')='' and @wersjaDeklaracji = 2 then 'BRAK' else trnk.KnA_Ulica + ' ' + trnk.KnA_Adres + ' ' + trnk.KnA_KodP + ' ' + trnk.KnA_Miasto end
				end)) 
				
				, case when isnull(trnk.KnA_Nip,'')='' and isnull(trvk.KnA_Nip,'')='' then 'BRAK' else
					case when TRV_ExpoNorm in (@e_SPR_nWewnatrzwspolnotowyVat0D, @e_SPR_nWewnatrzwspolnotowyVatDowolnyD, @e_SPR_nWewnatrzwspolnotowyVat0DT, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDT
					, @e_SPR_nWewnatrzwspolnotowyVat0N, @e_SPR_nWewnatrzwspolnotowyVatDowolnyN, @e_SPR_nWewnatrzwspolnotowyVat0NT, @e_SPR_nWewnatrzwspolnotowyVatDowolnyNT
					, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDKorekta, @e_SPR_nWewnatrzwspolnotowyVat0DKorekta, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDTKorekta, @e_SPR_nWewnatrzwspolnotowyVat0DTKorekta
					, @e_SPR_nDostawaOpodatkowanaWWsp) then case when @wersjaDeklaracji&gt;=21 then '' else case when TrV_KnANumer = 0 then trnk.KnA_NipPrefiks else trvk.KnA_NipPrefiks end end else '' end + case when TrV_KnANumer = 0 then trnk.KnA_Nip else case when isnull(trvk.KnA_Nip,'')='' then 'BRAK' else trvk.KnA_Nip end end end NIP
				, TrV_VATNalOd
				, SaN_ZwrNumer
				, 0
				, 0
				, trnk.KnA_NipPrefiks
				, trnk.KnA_Kraj
				, case when TrV_KnANumer &lt;&gt; 0 then trvknt.Knt_ExpoKraj else trnknt.Knt_ExpoKraj end KNTExpoKraj
				, TSV_Rozliczac
				,0
				,SAN_SANTyp
				,SAN_GIDTyp
				,SAN_GIDNumer
				,'',0
			FROM CDN.TraVAT 
				JOIN CDN.SadNag ON TRV_GIDTyp = SAN_GIDTyp AND TRV_GIDNumer = SAN_GIDNumer
				JOIN CDN.TraSVat ON TRV_GIDTyp = TSV_GIDTyp AND TRV_GIDNumer = TSV_GIDNumer AND TrV_GIDLp = TSV_GIDLp
				
				LEFT JOIN CDN.KntAdresy trnk ON (SaN_AdPNumer = KnA_GIDNumer AND SaN_GIDTyp not in (@Typ_FWS, @Typ_FKS) ) OR (SaN_KNANumer = KnA_GIDNumer AND SaN_GIDTyp in (@Typ_FWS, @Typ_FKS))	-- docelowo obsłużyć w sposób bardziej wydajny
				LEFT JOIN CDN.KntKarty trnKnt on trnk.KNA_KNtNumer=trnKnt.KNT_GIDNumer
				LEFT JOIN cdn.KntAdresy trvk ON TrV_KnANumer = trvk.KnA_GIDNumer
				LEFT JOIN CDN.KntKarty trvKnt on trvk.KNA_KNtNumer=trvKnt.KNT_GIDNumer
				
			WHERE SAN_VatTyp = 2 AND TSV_Rozliczac = 1 AND TSV_DeklRok = @rok 
				AND ( (@miesiacKwartal = 0 AND TSV_DeklMiesiac = @miesiac) OR (@miesiacKwartal = 1 AND TSV_DeklMiesiac BETWEEN @poczKwart AND @konKwart) )
				AND SAN_VatRejestr &lt;&gt; '' AND SAN_GIDTyp in (@Typ_FWS, @Typ_FKS ) 
				AND (@DokZaksiegowane=0 OR (@DokZaksiegowane=1 AND SAN_Zaksiegowano=1) OR (@DokZaksiegowane=2 AND SAN_Zaksiegowano=0))
		)    as aa 
	else
		insert into #tmpDokumenty
		select * from
		(
			SELECT TRV_GIDTyp, TRV_GIDNumer, TRV_GIDLp, TRN_VatRejestr, TrN_VatNumer
				, case when TrN_KorektaDanych &gt; 0 and TrN_DataWystOrg &gt; 0 then TrN_DataWystOrg else TrN_Data2 end DataWyst
				
				, case when TrN_KorektaDanych &gt; 0 and TrN_DataSprOrg &gt; 0 then TrN_DataSprOrg else TrN_Data3 end DataZak,
				CASE WHEN (TSV_NettoP+TSV_VatP) &lt;&gt; 0 THEN TSV_NettoP ELSE TSV_NettoR END as Netto,
				CASE WHEN (TSV_NettoP+TSV_VatP) &lt;&gt; 0 THEN TSV_VatP ELSE TSV_VatR END as Vat,
				TRV_StawkaPod, TRV_FlagaVat, TSV_RodzajZakupu, TRV_Struktura, 
				TRN_VatKorekta, TRV_ExpoNorm, TRV_Zrodlowa,
			    
				TRN_VatRok, TRN_VatMiesiac, TRN_RolnikRyczalt, TRN_KorektaOdlicz, 0 as CzySad,

				case when TrN_KorektaDanych &gt; 0 and TrN_NrKorekty &lt;&gt; '' and	 TrV_KorektaDanych=1 and @wersjaDeklaracji&lt;21 then TrN_NrKorekty 
				else case when TrN_KorektaDanych = 0 then
						case when TrN_DokumentObcy &lt;&gt; '' then TrN_DokumentObcy 
						when @wersjaDeklaracji&gt;=21 then CDN.NumerDokumentuZ(TrN_GidTyp, TrN_SpiTyp, TrN_TrNTyp, TrN_TrNNumer, TrN_TrNRok, TrN_TrNSeria, TrN_TrNMiesiac, TrN_ZwrTyp, TrN_ZwrNumer, TrN_WMS) 
						else 'brak' end 
					else
						case when TrN_NrKorekty &lt;&gt; '' and TrV_KorektaDanych=1 then TrN_NrKorekty 
						when TrN_DokumentObcy &lt;&gt; '' then TrN_DokumentObcy 
						when @wersjaDeklaracji&gt;=21 then CDN.NumerDokumentuZ(TrN_GidTyp, TrN_SpiTyp, TrN_TrNTyp, TrN_TrNNumer, TrN_TrNRok, TrN_TrNSeria, TrN_TrNMiesiac, TrN_ZwrTyp, TrN_ZwrNumer, TrN_WMS) 
						else 'brak' end 
					end
				end as NumerDok		--CDN.NumerDokumentu(TrN_GIDTyp, TrN_SpiTyp,TrN_TrnTyp,TrN_TrnNumer,TrN_TrNRok,Trn_TrnSeria,TrN_TrnMiesiac) end as NumerDok

				, isnull(trvk.KnA_Akronim, trnk.KnA_Akronim) KnA_Akronim
				, case when @wersjaDeklaracji&gt;=21 then 
					case when TrV_KnANumer &lt;&gt; 0 then trvk.KnA_Nazwa1+' '+trvk.KnA_Nazwa2+' '+trvk.KnA_Nazwa3 else trnk.KnA_Nazwa1 + ' ' + trnk.KnA_Nazwa2 + ' ' + trnk.KnA_Nazwa3 end
				else
					case when TrV_KnANumer &lt;&gt; 0 then trvk.KnA_Nazwa1+' '+trvk.KnA_Nazwa2 else case when isnull(trnk.KnA_Nazwa1,'')='' and isnull(trnk.KnA_Nazwa2,'')='' and @wersjaDeklaracji = 2 then 'BRAK' else trnk.KnA_Nazwa1 + ' ' + trnk.KnA_Nazwa2 end end
				end KNTNazwa
				, LTRIM(RTRIM(case when TrV_KnANumer &lt;&gt; 0 then trvk.KnA_Ulica + ' ' + trvk.KnA_Adres + ' ' + trvk.KnA_KodP + ' ' + trvk.KnA_Miasto 
					else case when isnull(trnk.KnA_Ulica,'')='' and isnull(trnk.KnA_Adres,'')='' and isnull(trnk.KnA_KodP,'')='' and isnull(trnk.KnA_Miasto,'')='' and @wersjaDeklaracji = 2 then 'BRAK' else trnk.KnA_Ulica + ' ' + trnk.KnA_Adres + ' ' + trnk.KnA_KodP + ' ' + trnk.KnA_Miasto end
					end)) as KnAAdres
				
				, case when isnull(trnk.KnA_Nip,'')='' and isnull(trvk.KnA_Nip,'')='' then 'BRAK' else 
					case when TRV_ExpoNorm in (@e_SPR_nWewnatrzwspolnotowyVat0D, @e_SPR_nWewnatrzwspolnotowyVatDowolnyD, @e_SPR_nWewnatrzwspolnotowyVat0DT, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDT
					, @e_SPR_nWewnatrzwspolnotowyVat0N, @e_SPR_nWewnatrzwspolnotowyVatDowolnyN, @e_SPR_nWewnatrzwspolnotowyVat0NT, @e_SPR_nWewnatrzwspolnotowyVatDowolnyNT
					, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDKorekta, @e_SPR_nWewnatrzwspolnotowyVat0DKorekta, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDTKorekta, @e_SPR_nWewnatrzwspolnotowyVat0DTKorekta
					, @e_SPR_nDostawaOpodatkowanaWWsp) then case when @wersjaDeklaracji&gt;=21 then '' else case when TrV_KnANumer = 0 then trnk.KnA_NipPrefiks else trvk.KnA_NipPrefiks end end else '' end +  case when TrV_KnANumer = 0 then trnk.KnA_Nip else case when isnull(trvk.KnA_Nip,'')='' then 'BRAK' else trvk.KnA_Nip end end end NIP
				, TrV_VATNalOd
				, TrN_ZwrNumer
				, TrN_KorektaDanych
				, TrV_KorektaDanych
				, case when TrV_KnANumer &lt;&gt; 0 then case when isnull(trvk.KnA_NipPrefiks,'') &lt;&gt; '' then trvk.KnA_NipPrefiks else '' end else case when isnull(trnk.KnA_NipPrefiks,'') &lt;&gt; '' then trnk.KnA_NipPrefiks else '' end end KnA_NipPrefiks
				, case when TrV_KnANumer &lt;&gt; 0 then case when isnull(trvk.KnA_Kraj,'') &lt;&gt; '' then trvk.KnA_Kraj else '' end else case when isnull(trnk.KnA_Kraj,'') &lt;&gt; '' then trnk.KnA_Kraj else '' end end KnA_Kraj
				, case when TrV_KnANumer &lt;&gt; 0 then trvknt.Knt_ExpoKraj else trnknt.Knt_ExpoKraj end KNTExpoKraj
				, TSV_Rozliczac
				, TRN_Fiskalny
				, TrN_TrNTyp
				, case when TRN_KorektaDanych=0 then TRN_GIDTyp else case when TrN_KnANumer&lt;&gt;TrV_KnANumer then TrN_ZwrTyp else TRN_GIDTyp end end KodyGIDTyp
				, case when TRN_KorektaDanych=0 then TRN_GIDNumer else case when TrN_KnANumer&lt;&gt;TrV_KnANumer then TrN_ZwrNumer else TRN_GIDNumer end end KodyGIDNumer
				, TRN_DokTypJPK,0 VatMarza
			FROM CDN.TraVat 
				JOIN CDN.TraNag ON TRV_GIDTyp = TRN_GIDTyp AND TRV_GIDNumer = TRN_GIDNumer 
				JOIN CDN.TraSVat ON TRV_GIDTyp = TSV_GIDTyp AND TRV_GIDNumer = TSV_GIDNumer AND TrV_GIDLp = TSV_GIDLp
				
				LEFT JOIN CDN.KntAdresy trnk ON TrN_AdPNumer = trnk.KnA_GIDNumer
				LEFT JOIN CDN.KntKarty trnKnt on trnk.KNA_KNtNumer=trnKnt.KNT_GIDNumer
				LEFT JOIN cdn.KntAdresy trvk ON TrV_KnANumer = trvk.KnA_GIDNumer
				LEFT JOIN CDN.KntKarty trvKnt on trvk.KNA_KNtNumer=trvKnt.KNT_GIDNumer
			WHERE TRN_VatTyp=2 AND TSV_DeklRok = @rok
				AND ( (@miesiacKwartal = 0 AND TSV_DeklMiesiac = @miesiac) OR (@miesiacKwartal = 1 AND TSV_DeklMiesiac BETWEEN @poczKwart AND @konKwart) )
				AND TRN_VatRejestr &lt;&gt; ''
				AND TrN_ProceduraOSS=0
				AND (@DokZaksiegowane=0 OR (@DokZaksiegowane=1 AND TrN_Zaksiegowano=1) OR (@DokZaksiegowane=2 AND TrN_Zaksiegowano=0))

			UNION ALL
				
			SELECT TRV_GIDTyp, TRV_GIDNumer, TRV_GIDLp, SaN_VatRejestr, SaN_VatNumer
				, SaN_DataWplywu DataWyst
				, case when @WersjaDeklaracji&gt;=21 and TRV_GIDTyp=@Typ_FKS then 0 else SaN_DataZgloszenia end DataZak,
				CASE WHEN (TSV_NettoP + TSV_VatP) &lt;&gt; 0 THEN TSV_NettoP ELSE TSV_NettoR END as Netto, 
				CASE WHEN (TSV_NettoP + TSV_VatP) &lt;&gt; 0 THEN TSV_VatP ELSE TSV_VatR END as Vat, 
				TRV_StawkaPod, TRV_FlagaVat, TSV_RodzajZakupu, TRV_Struktura, 0, TRV_ExpoNorm, TRV_Zrodlowa ,
			    
				SAN_VatRok, SAN_VatMiesiac, 0, 0, 1,
				case when SaN_NumerSAD &lt;&gt; '' then SaN_NumerSAD else 'brak' end	--CDN.NumerDokumentu(SaN_GIDTyp,0,SaN_SaNTyp,SaN_SaNNumer,SaN_SaNRok,SaN_SaNSeria,SaN_SaNMiesiac) end
				, isnull(trvk.KnA_Akronim, trnk.KnA_Akronim) KnA_Akronim
				, case when @wersjaDeklaracji&gt;=21 then 
					case when TrV_KnANumer &lt;&gt; 0 then trvk.KnA_Nazwa1+' '+trvk.KnA_Nazwa2+' '+trvk.KnA_Nazwa3 else trnk.KnA_Nazwa1 + ' ' + trnk.KnA_Nazwa2 + ' ' + trnk.KnA_Nazwa3 end
				else
					case when TrV_KnANumer &lt;&gt; 0 then trvk.KnA_Nazwa1+' '+trvk.KnA_Nazwa2 else case when isnull(trnk.KnA_Nazwa1,'')='' and isnull(trnk.KnA_Nazwa2,'')='' and @wersjaDeklaracji = 2 then 'BRAK' else trnk.KnA_Nazwa1 + ' ' + trnk.KnA_Nazwa2 end end
				end KNTNazwa
				, case when TrV_KnANumer &lt;&gt; 0 then trvk.KnA_Ulica + ' ' + trvk.KnA_Adres + ' ' + trvk.KnA_KodP + ' ' + trvk.KnA_Miasto else LTRIM(RTRIM(case when isnull(trnk.KnA_Ulica,'')='' and isnull(trnk.KnA_Adres,'')='' and isnull(trnk.KnA_KodP,'')='' and isnull(trnk.KnA_Miasto,'')='' and @wersjaDeklaracji = 2 then 'BRAK' else trnk.KnA_Ulica + ' ' + trnk.KnA_Adres + ' ' + trnk.KnA_KodP + ' ' + trnk.KnA_Miasto end)) end
				
				, case when isnull(trnk.KnA_Nip,'')='' and isnull(trvk.KnA_Nip,'')='' then 'BRAK' else	
					case when TRV_ExpoNorm in (@e_SPR_nWewnatrzwspolnotowyVat0D, @e_SPR_nWewnatrzwspolnotowyVatDowolnyD, @e_SPR_nWewnatrzwspolnotowyVat0DT, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDT
					, @e_SPR_nWewnatrzwspolnotowyVat0N, @e_SPR_nWewnatrzwspolnotowyVatDowolnyN, @e_SPR_nWewnatrzwspolnotowyVat0NT, @e_SPR_nWewnatrzwspolnotowyVatDowolnyNT
					, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDKorekta, @e_SPR_nWewnatrzwspolnotowyVat0DKorekta, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDTKorekta, @e_SPR_nWewnatrzwspolnotowyVat0DTKorekta
					, @e_SPR_nDostawaOpodatkowanaWWsp) then case when @wersjaDeklaracji&gt;=21 then '' else case when TrV_KnANumer = 0 then trnk.KnA_NipPrefiks else trvk.KnA_NipPrefiks end end else '' end +  case when TrV_KnANumer = 0 then trnk.KnA_Nip else case when isnull(trvk.KnA_Nip,'')='' then 'BRAK' else trvk.KnA_Nip end end end NIP
				, TrV_VATNalOd
				, SaN_ZwrNumer, 0, 0
				, trnk.KnA_NipPrefiks
				, trnk.KnA_Kraj
				, case when TrV_KnANumer &lt;&gt; 0 then trvknt.Knt_ExpoKraj else trnknt.Knt_ExpoKraj end KNTExpoKraj
				, TSV_Rozliczac
				,0
				,SAN_SANTyp
				,SAN_GIDTyp
				,SAN_GIDNumer
				,'',0
			FROM CDN.TraVAT 
				JOIN CDN.SadNag ON TRV_GIDTyp = SAN_GIDTyp AND TRV_GIDNumer = SAN_GIDNumer
				JOIN CDN.TraSVat ON TRV_GIDTyp = TSV_GIDTyp AND TRV_GIDNumer = TSV_GIDNumer AND TrV_GIDLp = TSV_GIDLp
				
				LEFT JOIN CDN.KntAdresy trnk ON SaN_KNANumer = KnA_GIDNumer
				LEFT JOIN CDN.KntKarty trnKnt on trnk.KNA_KNtNumer=trnKnt.KNT_GIDNumer
				LEFT JOIN cdn.KntAdresy trvk ON TrV_KnANumer = trvk.KnA_GIDNumer
				LEFT JOIN CDN.KntKarty trvKnt on trvk.KNA_KNtNumer=trvKnt.KNT_GIDNumer

			WHERE SAN_VatTyp = 2 AND TSV_Rozliczac = 1 AND TSV_DeklRok = @rok 
				AND ( (@miesiacKwartal = 0 AND TSV_DeklMiesiac = @miesiac) OR (@miesiacKwartal = 1 AND TSV_DeklMiesiac BETWEEN @poczKwart AND @konKwart) )
				AND SAN_VatRejestr &lt;&gt; '' AND SAN_GIDTyp in (@Typ_FWS, @Typ_FKS ) 
				AND (@DokZaksiegowane=0 OR (@DokZaksiegowane=1 AND SAN_Zaksiegowano=1) OR (@DokZaksiegowane=2 AND SAN_Zaksiegowano=0))

		)    as aa 

		UPDATE #tmpDokumenty set 
			VatMarza = case when exists(select 1 from cdn.TraJPK where KodyGIDTyp=TrJ_TrNTyp and KodyGIDNumer=TrJ_TrNNumer and TrJ_Wartosc in ('MR_T','MR_UZ')) 
					then 1 else 0 end;

	
	declare @TRV_GIDTyp smallint,
		@OldTRVGIDTyp smallint,
		@TRV_GIDNumer int, 
		@OldTRVGIDNumer int,
		@TRV_GIDLp int,
		@TRN_VatRejestr varchar(5), 
		@TrN_VatNumer int,
		@CzySad tinyint,
		@TypSad smallint,
		@DataWyst int,
		@DataZak int,
		@OldDataWyst int,
		@OldDataZak int,
		@NumerDok varchar(40),
		@Akronim varchar(20),
		@Nazwa varchar(400),
		@Netto decimal(15,2),
		@Vat decimal(15,2),
		@AdresNabywcy varchar(512),
		@NIP varchar(25),
		
		@TRV_StawkaPod tinyint,
		@TRV_FlagaVAT tinyint, 
		@TRV_DeklRok smallint, 
		@TRV_DeklMiesiac tinyint,
		@TRV_RodzajZakupu tinyint, 
		@TRV_OdliczeniaVat tinyint,
		@TRN_VatRok smallint, 
		@TRN_VatMiesiac tinyint, 
		@TRN_VatKorekta tinyint, 
		@TRV_ExpoNorm tinyint, 
		@Zero tinyint, 
		@TRN_RolnikRyczalt tinyint, 
		@TRN_KorektaOdlicz tinyint,
		@TRV_Struktura tinyint, 
		@TRV_Zrodlowa tinyint,
		@TRV_VatNalOd tinyint,
		
		@KorektaDanych tinyint,
		@TRV_KorektaDanych tinyint,
		@KNANipPrefiks varchar(2),
		@KNAKodKraju varchar(2),
		@KNTExpoKraj tinyint,
		@TSV_Rozliczac tinyint,
		@TRN_Fiskalny tinyint,
		@TRN_TRNTyp smallint,
		@KodyGIDTyp smallint,
		@KodyGIDNumer int,
		@TRN_DokTypJPK varchar(50),
		@VATMarza smallint,
		@ZwrNumer int,
	    @ZrodlZDGIDTyp smallint,
		@ZrodlZDGIDNumer int,
		@TypKorekty smallint

	declare @poleNaDekl			smallint
	declare @pole_DTSUZW		smallint		
	declare @pole_DTSUPK		smallint		
	declare @pole_DTSUPKa		smallint		
	declare @pole_DTSU0			smallint		
	declare @pole_DTSU0a		smallint		
	declare @pole_DTSU3i5		smallint		
	declare @pole_DTSU7i8		smallint		
	declare @pole_DTSU22i23		smallint		
	declare @pole_WWDT			smallint		
	declare @pole_ET			smallint		
	declare @pole_WWNT			smallint		
	declare @pole_ITPR			smallint		
	declare @pole_IU			smallint		
	declare @pole_IUa			smallint		
	declare @pole_IURO			smallint		
	declare @pole_WWNST			smallint		
	
	set @poleNaDekl			= 0
	set @pole_DTSUZW		= 20		
	set @pole_DTSUPK		= 21		
	set @pole_DTSUPKa		= 22		
	set @pole_DTSU0			= 23		
	set @pole_DTSU0a		= 24		
	set @pole_DTSU3i5		= 25		
	set @pole_DTSU7i8		= 27		
	set @pole_DTSU22i23		= 29		
	set @pole_WWDT			= 31		
	set @pole_ET			= 32		
	set @pole_WWNT			= 33		
	set @pole_ITPR			= 35		
	set @pole_IU			= 37		
	set @pole_IUa			= 39		
	set @pole_IURO			= 41		
	set @pole_WWNST			= 44		
	
	declare @TrnGIDNumerLancuch int = 0, @ZwrNumerLancuch int = 0, @VatKorekta tinyint = 0, @recLevel smallint = 0

	declare curDok cursor for select * from #tmpDokumenty for read only
	open curDok

	fetch curDok into @TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatRejestr, @TrN_VatNumer, @DataWyst, @DataZak,
		@Netto, @Vat, @TRV_StawkaPod, @TRV_FlagaVAT, @TRV_RodzajZakupu, @TRV_Struktura, @TRN_VatKorekta,
		@TRV_ExpoNorm, @TRV_Zrodlowa, @TRN_VatRok, @TRN_VatMiesiac, @TRN_RolnikRyczalt, @TRN_KorektaOdlicz, @CzySad,
		@NumerDok, @Akronim, @Nazwa, @AdresNabywcy, @NIP, @TRV_VatNalOd
		,@ZwrNumer, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @TRN_Fiskalny, @TRN_TRNTyp, @KodyGIDTyp, @KodyGIDNumer
		,@TRN_DokTypJPK, @VatMarza

	while @@FETCH_STATUS = 0
	begin
		set @Nazwa = LEFT(@Nazwa, 256);
		if @wersjaDeklaracji &gt;= 21
		begin
			IF @TRN_TRNTyp = 35 --ZDS
			BEGIN
				IF (@TRV_GIDTyp = @OldTRVGIDTyp and @TRV_GIDNumer = @OldTRVGIDNumer)
				BEGIN
					set @DataWyst = @OldDataWyst
					set @DataZak = @OldDataZak
				END
				ELSE
				BEGIN									
					select top 1
						@DataWyst = case when trn.TRN_GIDTyp &amp; 8 &gt; 0 and trn.TrN_KorektaDanych&lt;&gt;0 then trn.TrN_DataWystOrg
									else trn.TRN_Data2 end
						,@DataZak = case when trn.TRN_GIDTyp &amp; 8 &gt; 0 and trn.TRN_ZwrNumer=trn.TRN_GIDNumer then trn.TRN_DataSprOrg --reczne
										when trn.TRN_GIDTyp &amp; 8 &gt; 0 and trn.TRN_ZwrNumer=0 then 0 --zbiorcze
										when trn.TRN_GIDTyp &amp; 8 &gt; 0 and trn.TrN_KorektaDanych&lt;&gt;0 then trn.TRN_DataSprOrg --koretka danych
									else trn.TRN_Data3 end
						,@TypKorekty = case when trn.TRN_GIDTyp &amp; 8 &gt; 0 and trn.TRN_ZwrNumer=trn.TRN_GIDNumer then 1 --reczne
													when trn.TRN_GIDTyp &amp; 8 &gt; 0 and trn.TRN_ZwrNumer=0 then 2 --zbiorcze
													when trn.TRN_GIDTyp &amp; 8 &gt; 0 and trn.TrN_KorektaDanych&lt;&gt;0 then 3 --koretka danych
												else 0 end
						,@ZrodlZDGIDTyp = trn.TRN_GIDTyp
						,@ZrodlZDGIDNumer = trn.TRN_GIDNumer
					from cdn.TraNag zd
						join cdn.PodElemDok on PED_PONNumer=zd.TrN_VatZDPeDNumer and PED_Lp=zd.TrN_VatZDPeDLp and zd.TrN_VatZDPeDNumer&lt;&gt;0
						join cdn.TraPLat prol on prol.TRP_GIDTyp=PED_TRPTyp and prol.TRP_GIDNumer=PED_TRPNumer and prol.TRP_GIDLp=PED_TRPLp
						join cdn.TraPLat trp on prol.TrP_ProlZrdTyp=trp.TrP_GIDTyp and prol.TrP_ProlZrdNumer=trp.TrP_GIDNumer and prol.TrP_ProlZrdLp=trp.TrP_GIDLp
						left join cdn.TraNag trn on trp.TRP_SpiNumer = trn.TRN_GIDNumer						
					where zd.TRN_GIDTyp=@TRV_GIDTyp and zd.TRN_GIDNumer=@TRV_GIDNumer										
					
					IF @ZrodlZDGIDTyp &amp; 8 &gt; 0 AND @TypKorekty = 0
					BEGIN
						with Korekty as (
						select TRN_GIDNumer GIDNumer, TRN_ZwrTyp ZwrTyp, TRN_ZwrNumer ZwrNumer
						from cdn.TraNag
						where TRN_GIDNumer = @ZrodlZDGIDNumer
						union all
						select  TRN_GIDNumer GIDNumer, TRN_ZwrTyp ZwrTyp, TRN_ZwrNumer ZwrNumer
						from cdn.TraNag join Korekty on TRN_GIDNumer=ZwrNumer	
						where trn_zwrnumer &lt;&gt; @ZrodlZDGIDNumer	and (Trn_GIDTyp &amp; 8 &gt; 0 AND Trn_ZwrNumer &lt;&gt; Trn_GIDNumer)
						)
						select 
							@DataZak = TRN_Data3
						from cdn.TraNag join Korekty on ZwrNumer=TRN_GIDNumer
						where ZwrTyp &amp; 8 =0
						OPTION(MAXRECURSION 0)
					END


					set @OldDataWyst = @DataWyst
					set @OldDataZak = @DataZak
				END
			END
			ELSE IF @TRV_GIDTyp &amp; 8 &gt; 0 
			BEGIN
				IF (@TRV_GIDTyp = @OldTRVGIDTyp and @TRV_GIDNumer = @OldTRVGIDNumer)
				BEGIN
					set @DataWyst = @OldDataWyst
					set @DataZak = @OldDataZak
				END
				ELSE
				BEGIN
					IF @TRV_KorektaDanych &lt;&gt; 0
					BEGIN
						set @DataWyst = @DataWyst
						set @DataZak = @DataZak
					END
					ELSE IF @TRV_GIDTyp in (1832,1836,2041,2043,2045) and @TRV_GIDNumer&lt;&gt;@ZwrNumer and @ZwrNumer&lt;&gt;0					
					BEGIN --ze wskazanego
						with Korekty as (
						select TRN_GIDNumer GIDNumer, TRN_ZwrTyp ZwrTyp, TRN_ZwrNumer ZwrNumer
						from cdn.TraNag
						where TRN_GIDNumer = @TRV_GIDNumer
						union all
						select  TRN_GIDNumer GIDNumer, TRN_ZwrTyp ZwrTyp, TRN_ZwrNumer ZwrNumer
						from cdn.TraNag join Korekty on TRN_GIDNumer=ZwrNumer	
						where trn_zwrnumer &lt;&gt; @TRV_GIDNumer	and (Trn_GIDTyp &amp; 8 &gt; 0 AND Trn_ZwrNumer &lt;&gt; Trn_GIDNumer)
						)
						select 
							@DataZak = TRN_Data3
						from cdn.TraNag join Korekty on ZwrNumer=TRN_GIDNumer
						where ZwrTyp &amp; 8 =0
						OPTION(MAXRECURSION 0)
						IF @@ROWCOUNT = 0 --jesli pierwotny jest korektą np WZ-&gt;(S)FSK-&gt;WZK-&gt;(S)FSK2
							set @DataZak = 0
					END
					ELSE IF @TRV_GIDTyp in (1832,1836,2041,2043,2045) and @ZwrNumer=0
					BEGIN --zbiorcze
						set @DataZak = 0
					END
					ELSE IF @TRV_GIDTyp in (1832,1836,2041,2043,2045) and @TRV_GIDNumer=@ZwrNumer AND EXISTS(select 1 from cdn.TraNag where TRN_GIDNumer = @TRV_GIDNumer AND TRN_SpiNumer=0)
					BEGIN --korekta bez zrodlowego np spiecie bezposrednio do korekty WZ-&gt;(S)FSK
						set @DataZak = 0												
					END
					ELSE IF @TRV_GIDTyp in (1832,1836,2041,2043,2045) and @TRV_GIDNumer=@ZwrNumer
					BEGIN --reczne
						set @DataZak = (select TRN_DataSprOrg from cdn.TraNag where TRN_GIDNumer = @TRV_GIDNumer)
					END					
					
					set @OldDataWyst = @DataWyst
					set @OldDataZak = @DataZak
				END
			END
			set @OldTRVGIDTyp = @TRV_GIDTyp
			set @OldTRVGIDNumer = @TRV_GIDNumer
		end

		IF @wersjaDeklaracji &lt; 21 AND @TSV_Rozliczac = 0					
			set @TSV_Rozliczac = @TSV_Rozliczac --pomijaj
		ELSE IF @wersjaDeklaracji &gt;= 21 AND @TSV_Rozliczac = 0 and isnull(@TRN_DokTypJPK,'') &lt;&gt; 'FP'								
			set @TSV_Rozliczac = @TSV_Rozliczac --pomijaj
		ELSE IF @wersjaDeklaracji &gt;= 21 AND @TRV_ExpoNorm = @e_SPR_nEksportowyNabywca and not @TRV_GIDTyp in (@Typ_FWS, @Typ_FKS, @Typ_FW, @Typ_FWK ) 
			and ((@miesiacKwartal=0 and (@Rok&lt;2023 or @Rok=2023 and @miesiac&lt;4)) OR (@miesiacKwartal=1 and (@Rok&lt;2023 or @Rok=2023 and @kwartal&lt;2)))
			set @TSV_Rozliczac = @TSV_Rozliczac --pomijaj
		ELSE				
		IF @wersjaDeklaracji &gt; 16 AND @TRV_VatNalOd &gt; 0 and @TRV_GIDTyp IN (@Typ_FW, @Typ_FWK)
		BEGIN
			IF @TRV_VatNalOd = 1			
				set @poleNaDekl = 36
			ELSE IF @TRV_VatNalOd = 2
				set @poleNaDekl = 37
			ELSE IF @TRV_VatNalOd = 3
				set @poleNaDekl = 38
			ELSE 
				set @poleNaDekl = 39
				
			insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok, Akronim, Nazwa, Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
			values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, @NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
		END
		ELSE
		IF NOT (@TRV_StawkaPod = 3 and @wersjaDeklaracji &gt; 15)		
		BEGIN
			IF ( ( ( @TRV_ExpoNorm IN (@e_SPR_nImportowyVat0FW, @e_SPR_nImportowyVatDowolnyFW) AND @TRV_GIDTyp IN (@Typ_FW, @Typ_FWK) ) 
			   or ( @TRV_GIDTyp IN (@Typ_FWS, @Typ_FKS) and @TRV_ExpoNorm = @e_SPR_nEksportowyVat0) ) 
				   AND @TRV_RodzajZakupu &lt;&gt; @e_ksi_lRodzajZakupu_ImportUslug )
			begin				
				IF NOT ((@TRV_ExpoNorm IN (@e_SPR_nImportowyVatDowolnyFW,@e_SPR_nImportowyVat0FW) AND @TRV_GIDTyp IN (@Typ_FW, @Typ_FWK) OR ( @TRV_GIDTyp IN (@Typ_FWS, @Typ_FKS) and @TRV_ExpoNorm = @e_SPR_nEksportowyVat0)) AND @TRV_FlagaVAT = 2)
					IF (@g_ksi_lUwzgledniajNieopodatkowane = 0 AND @TRV_FlagaVAT &lt;&gt; 2) OR @g_ksi_lUwzgledniajNieopodatkowane = 1
					BEGIN
						set @poleNaDekl = 35
						
						if @wersjaDeklaracji &gt;= 14
							set @poleNaDekl = @poleNaDekl - 10
					
						insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)				
						values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
							@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
					END
					
			end
			else
			begin						
				IF @TRV_ExpoNorm = @e_SPR_nEksportowyNabywca 
				begin
				
					set @poleNaDekl = -1	
				
					IF @wersjaDeklaracji &lt; 14
					begin			
						--wart_DTPN_Netto = wart_DTPN_Netto + @Netto;       -- pole 41
						--wart_DTPN_Vat = wart_DTPN_Vat + @Vat;             -- pole 42
						set @poleNaDekl = 41
					end
					else if  @wersjaDeklaracji &lt; 15
					begin
						if @TRV_GIDTyp in (@Typ_FWS, @Typ_FKS, @Typ_FW, @Typ_FWK )
						begin
							set @poleNaDekl = 31
							set @TRV_StawkaPod = 0
							set @TRV_FlagaVAT = 2
						end
						else
						begin
							if @TRV_FlagaVAT = 0
								set @poleNaDekl = 10
							else if @TRV_FlagaVAT = 2 and @TRV_StawkaPod = 0
								set @poleNaDekl = 31
							else if @TRV_FlagaVAT = 1
								begin
									if @TRV_StawkaPod = 0
										set @poleNaDekl = 13
									else if @TRV_StawkaPod in (3, 5)
										set @poleNaDekl = 15
									else if @TRV_StawkaPod in (7, 8)
										set @poleNaDekl = 17								
									else if @TRV_StawkaPod in (22, 23)
										set @poleNaDekl = 19								
								end	
						  
						end	
					end
					else if @wersjaDeklaracji &lt; 21
					begin
						if @TRV_GIDTyp in (@Typ_FWS, @Typ_FKS, @Typ_FW, @Typ_FWK )
						begin						
							if @TRV_FlagaVAT &lt;&gt; 2 								
									set @poleNaDekl = 34
						end
						else
						begin
							if @TRV_RodzajZakupu IN (1, 5) 
								if @TRV_FlagaVAT = 0
									set @poleNaDekl = 10
								else if @TRV_FlagaVAT = 2 and @TRV_StawkaPod = 0
									set @poleNaDekl = 31		-- nowe 31
								else if @TRV_FlagaVAT = 1
								begin
									if @TRV_StawkaPod = 0
										set @poleNaDekl = 13
									else if @TRV_StawkaPod in (3, 5)
										set @poleNaDekl = 15
									else if @TRV_StawkaPod in (7, 8)
										set @poleNaDekl = 17
									else if @TRV_StawkaPod in (22, 23)
										set @poleNaDekl = 19
								end	
						  
						end	
					  
					end	
					else 
					begin
						if (@TRV_GIDTyp in (@Typ_FWS, @Typ_FKS, @Typ_FW, @Typ_FWK ))
							OR ((@miesiacKwartal=0 and (@Rok&gt;2023 or @Rok=2023 and @miesiac&gt;=4)) OR (@miesiacKwartal=1 and (@Rok&gt;2023 or @Rok=2023 and @kwartal&gt;=2)))							
							set @poleNaDekl = 32						
					end

					if @poleNaDekl &gt; -1				
						insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
	        				Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
						values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
							@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
					
				end
				
				ELSE IF @TRV_ExpoNorm in (@e_SPR_nEksportowyNabywcaWsp,	@e_SPR_nEksportowyNabywcaInne) 					
				begin
					if @wersjaDeklaracji &lt; 15
					begin
						set @poleNaDekl = -1
						
						if @TRV_GIDTyp in (@Typ_FWS, @Typ_FKS, @Typ_FW, @Typ_FWK )

							if @TRV_FlagaVAT &lt;&gt; 2 
								if @TRV_RodzajZakupu = 1
									set @poleNaDekl = 41
								else if @TRV_RodzajZakupu = 5
									set @poleNaDekl = 37

								else if @TRV_RodzajZakupu = 8 and @TRV_ExpoNorm = @e_SPR_nEksportowyNabywcaWsp
								begin							
									set @poleNaDekl = 39
									
									if @wersjaDeklaracji &gt;= 14								
										set @poleNaDekl = @poleNaDekl - 10
							
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
	        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
										
									set @poleNaDekl = 37								
								end
									
						if @wersjaDeklaracji &gt;= 14
							set @poleNaDekl = @poleNaDekl - 10
				
				
						if @poleNaDekl &gt; -1
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
	        					Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
					end
					else	-- if @wersjaDeklaracji = 15
					begin
						set @poleNaDekl = -1
						if @TRV_GIDTyp in (@Typ_FWS, @Typ_FKS, @Typ_FW, @Typ_FWK )						
							if @TRV_RodzajZakupu = 1
								set @poleNaDekl = 32
							else if @TRV_FlagaVAT &lt;&gt; 2 
								if @TRV_RodzajZakupu = 1
									set @poleNaDekl = 32
								else if @TRV_RodzajZakupu = 5
									set @poleNaDekl = 27
								else if @TRV_RodzajZakupu = 8 and @TRV_ExpoNorm in (@e_SPR_nEksportowyNabywcaWsp, @e_SPR_nEksportowyNabywcaInne)
									set @poleNaDekl = 29
				
						if @poleNaDekl &gt; -1
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
	        					Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
					end
				end
				
				ELSE IF @TRV_ExpoNorm = @e_SPR_nDostawaOpodatkowanaWWsp
				begin
					if ( @TRV_StawkaPod = 0 and @TRV_FlagaVat = 2 and @TRV_RodzajZakupu IN (1, 5) ) 
					begin
						--wart_DTSU = wart_DTSU + @Netto;                  -- pole 21
			        
						set @poleNaDekl = 21
						
						if @wersjaDeklaracji &gt;= 14
							set @poleNaDekl = @poleNaDekl - 10
						
						insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        					Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
						values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
							@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
			            				
					end       
					else if @TRV_RodzajZakupu = 8 
					begin
						--wart_DTSU = wart_DTSU + @Netto;                  -- pole 21
						--wart_DTSU_a = wart_DTSU_a + @Netto;              -- pole 22
			            
						set @poleNaDekl = 21
						
						if @wersjaDeklaracji &gt;= 14
							set @poleNaDekl = @poleNaDekl - 10
						
						insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        					Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
						values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
							@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
							
						set @poleNaDekl = 22
						
						if @wersjaDeklaracji &gt;= 14
							set @poleNaDekl = @poleNaDekl - 10
						
						insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        					Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
						values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
							@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

					end;

					IF @TRV_RodzajZakupu IN (1, 5) 
					begin
						if @TRV_StawkaPod = 0 and @TRV_FlagaVat = 0 
						begin
							--wart_DTSU_Zw = wart_DTSU_Zw + @Netto;             -- pole 20            
			                		                
							set @poleNaDekl = 20
						
							if @wersjaDeklaracji = 14
								set @poleNaDekl = @poleNaDekl - 10
							else if @wersjaDeklaracji &gt;= 15
								set @poleNaDekl = 11
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        						Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end
						else if @TRV_StawkaPod = 0 and @TRV_FlagaVat = 1  
						begin
							--wart_DTSU_0 = wart_DTSU_0 + @Netto;              -- pole 23
							set @poleNaDekl = 23
						
							if @wersjaDeklaracji = 14
								set @poleNaDekl = @poleNaDekl - 10
							else if @wersjaDeklaracji &gt;= 15
								set @poleNaDekl = 11
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        						Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end
						else if (@TRV_StawkaPod = 3 and @wersjaDeklaracji &lt; 16 or @TRV_StawkaPod = 5 ) and @TRV_FlagaVat = 1 
						begin
							--wart_DTSU_3_5_Netto = wart_DTSU_3_5_Netto + @Netto;       -- pole 25
							--wart_DTSU_3_5_Vat = wart_DTSU_3_5_Vat + @Vat;             -- pole 26
							set @poleNaDekl = 25
						
							if @wersjaDeklaracji &gt;= 14
								set @poleNaDekl = @poleNaDekl - 10
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        						Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end
						else if (@TRV_StawkaPod = 7 or @TRV_StawkaPod = 8) and @TRV_FlagaVat = 1 
						begin
							--wart_DTSU_7_8_Netto = wart_DTSU_7_8_Netto + @Netto;      -- pole 27
							--wart_DTSU_7_8_Vat = wart_DTSU_7_8_Vat + @Vat;            -- pole 28
							set @poleNaDekl = 27
						
							if @wersjaDeklaracji &gt;= 14
								set @poleNaDekl = @poleNaDekl - 10
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        						Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end
						else if (@TRV_StawkaPod = 22 or @TRV_StawkaPod = 23) and @TRV_FlagaVat = 1 
						begin
							--wart_DTSU_22_23_Netto = wart_DTSU_22_23_Netto + @Netto;    -- pole 29
							--wart_DTSU_22_23_Vat = wart_DTSU_22_23_Vat + @Vat;          -- pole 30
							set @poleNaDekl = 29
						
							if @wersjaDeklaracji &gt;= 14
								set @poleNaDekl = @poleNaDekl - 10
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        						Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end
					end
				end
				ELSE IF @TRV_ExpoNorm = @e_SPR_nDostawaOpodatkowanaInne 
				begin

					if NOT (@TRV_FlagaVAT = 2 and @TRV_RodzajZakupu NOT IN (@e_ksi_lRodzajZakupu_UslugiRO, @e_ksi_lRodzajZakupu_ImportUslug, @e_ksi_lRodzajZakupu_Towary))
					--or (@TRV_FlagaVAT = 2 and @TRV_RodzajZakupu = 1)
					begin
						if @TRV_FlagaVAT = 1 and @TRV_StawkaPod = 0	and @g_ksi_InterpretujTransDostOpodatkPozaTerytKrajWSt0JakoKrajowa &gt; 0
							set @poleNaDekl = 23	-- pole 23
						else
							set @poleNaDekl = 21	--wart_DTSU = wart_DTSU + @Netto;                  -- pole 21
							
						if @wersjaDeklaracji &gt;= 14
							set @poleNaDekl = @poleNaDekl - 10
						
						insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
    						Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
						values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
							@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
					end

				end
				ELSE IF @TRV_ExpoNorm = @e_SPR_nTaxFree 
				begin
					IF @TRV_FlagaVat = 1  
					begin    
						  --_VATQ:FlagaVat = qSumy.FlagaVat
						  --_VATQ:Stawka = qSumy.StawkaPod
						IF @TRV_StawkaPod = 0 
						begin
							--wart_DTSU_0 = wart_DTSU_0 + @Netto;              -- pole 23
							set @poleNaDekl = 23
						
							if @wersjaDeklaracji &gt;= 14
								set @poleNaDekl = @poleNaDekl - 10
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        						Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
								
							--wart_DTTF = @Netto     -- pole 24
							set @poleNaDekl = 24
						
							if @wersjaDeklaracji &gt;= 14
								set @poleNaDekl = @poleNaDekl - 10
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        						Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end
						ELSE IF (@TRV_StawkaPod = 3 or @TRV_StawkaPod = 5 )
						begin
							--wart_DTSU_3_5_Netto = wart_DTSU_3_5_Netto + @Netto;       -- pole 25
							--wart_DTSU_3_5_Vat = wart_DTSU_3_5_Vat + @Vat;             -- pole 26
							set @poleNaDekl = 25
						
							if @wersjaDeklaracji &gt;= 14
								set @poleNaDekl = @poleNaDekl - 10
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
    							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end
						ELSE IF (@TRV_StawkaPod = 7 or @TRV_StawkaPod = 8)
						begin
							--wart_DTSU_7_8_Netto = wart_DTSU_7_8_Netto + @Netto;      -- pole 27
							--wart_DTSU_7_8_Vat = wart_DTSU_7_8_Vat + @Vat;            -- pole 28
							set @poleNaDekl = 27
						
							if @wersjaDeklaracji &gt;= 14
								set @poleNaDekl = @poleNaDekl - 10
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
    							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end
						ELSE IF (@TRV_StawkaPod = 22 or @TRV_StawkaPod = 23)
						begin
							--wart_DTSU_22_23_Netto = wart_DTSU_22_23_Netto + @Netto;    -- pole 29
							--wart_DTSU_22_23_Vat = wart_DTSU_22_23_Vat + @Vat;          -- pole 30
							set @poleNaDekl = 29
						
							if @wersjaDeklaracji &gt;= 14
								set @poleNaDekl = @poleNaDekl - 10
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
    							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end					
					end
				end
				ELSE IF @TRV_ExpoNorm IN (@e_SPR_nWewnatrzwspolnotowyVat0N, @e_SPR_nWewnatrzwspolnotowyVatDowolnyN,
						 @e_SPR_nWewnatrzwspolnotowyVat0NT, @e_SPR_nWewnatrzwspolnotowyVatDowolnyNT,
						 @e_SPR_nImportowyVat0FW, @e_SPR_nImportowyVatDowolnyFW) 
				begin    
					IF @TRV_GIDTyp in(@Typ_FWS, @Typ_FKS, @Typ_FW, @Typ_FWK) 
					BEGIN
						IF @TRV_FlagaVAT &lt;&gt; 2
						BEGIN
							IF @TRV_RodzajZakupu = @e_ksi_lRodzajZakupu_ImportUslug
							begin
								if @TRV_GIDTyp in (@Typ_FWS, @Typ_FKS, @Typ_FW, @Typ_FWK) 
								begin
									--wart_IU_Netto = wart_IU_Netto + @Netto;            -- pole 37
									--wart_IU_Vat = wart_IU_Vat + @Vat;              -- pole 38
									set @poleNaDekl = 37
							
									if @wersjaDeklaracji &gt;= 14
										set @poleNaDekl = @poleNaDekl - 10
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

								end
								else
								begin
									--wart_DTSU_Zw = wart_DTSU_Zw + @Netto;             -- pole 20
									set @poleNaDekl = 20
							
									if @wersjaDeklaracji &gt;= 14
										set @poleNaDekl = @poleNaDekl - 10
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
								end
							end
							ELSE IF @TRV_RodzajZakupu = @e_ksi_lRodzajZakupu_UslugiRO  
							begin
								if @TRV_GIDTyp in (@Typ_FWS, @Typ_FKS, @Typ_FW, @Typ_FWK) 
								begin
									--wart_IU_Netto = wart_IU_Netto + @Netto;           -- pole 37
									--wart_IU_Vat = wart_IU_Vat + @Vat;                 -- pole 38
									if @wersjaDeklaracji &lt; 15
									begin
										set @poleNaDekl = 37
								
										if @wersjaDeklaracji &gt;= 14
											set @poleNaDekl = @poleNaDekl - 10
										
										insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        									Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
										values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
											@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
									end
										
									--wart_IU_RO_Netto = wart_IU_RO_Netto + @Netto;     -- pole 39
									--wart_IU_RO_Vat = wart_IU_RO_Vat + @Vat;           -- pole 40
									set @poleNaDekl = 39
							
									if @wersjaDeklaracji &gt;= 14
										set @poleNaDekl = @poleNaDekl - 10
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

								end
								else
								begin
									--wart_DTSU_Zw = wart_DTSU_Zw + @Netto;             -- pole 20
									set @poleNaDekl = 20
							
									if @wersjaDeklaracji &gt;= 14
										set @poleNaDekl = @poleNaDekl - 10
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
								end
							end
							ELSE IF @TRV_RodzajZakupu = @e_ksi_lRodzajZakupu_SrTransportu
							begin
								--wart_WWNT_Netto = wart_WWNT_Netto + @Netto;       -- pole 33
								--wart_WWNT_Vat = wart_WWNT_Vat + @Vat;             -- pole 34
								set @poleNaDekl = 33
							
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
									
								set @poleNaDekl = 44
							
								if @wersjaDeklaracji &gt;= 14 and @wersjaDeklaracji &lt; 15
									set @poleNaDekl = @poleNaDekl - 10
								else if @wersjaDeklaracji &gt;= 17
									set @poleNaDekl = 38
								else if @wersjaDeklaracji &gt;= 15
									set @poleNaDekl = 37					
								
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

							end
							ELSE
							begin
								--wart_WWNT_Netto = wart_WWNT_Netto + @Netto;       -- pole 33
								--wart_WWNT_Vat = wart_WWNT_Vat + @Vat;             -- pole 34
								set @poleNaDekl = 33
							
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

								IF @wersjaDeklaracji &gt;= 17 AND @TRV_RodzajZakupu = @e_ksi_lRodzajZakupu_Paliwo
								begin
									set @poleNaDekl = 39			-- nowe na VAT-7 (17)
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
								end

							end
						END						
						ELSE IF @wersjaDeklaracji &gt;= 17 AND @TRV_RodzajZakupu = 1 AND
							 ( (@TRV_ExpoNorm = @e_SPR_nWewnatrzwspolnotowyVatDowolnyNT AND @TRV_GIDTyp in(@Typ_FW, @Typ_FWK) ) OR 
							   (@TRV_ExpoNorm = @e_SPR_nWewnatrzwspolnotowyVat0NT AND @TRV_GIDTyp in(@Typ_FWS, @Typ_FKS) ) )
						BEGIN
							set @poleNaDekl = 23
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
    							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
						END
					END
				end
				ELSE IF @TRV_ExpoNorm IN (@e_SPR_nWSTO_EE)
				BEGIN
					set @poleNaDekl = 11

					insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        				Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
					values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
						@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
				END		
				ELSE IF @TRV_ExpoNorm IN (@e_SPR_nWewnatrzwspolnotowyVat0D, @e_SPR_nWewnatrzwspolnotowyVat0DT,
					  @e_SPR_nWewnatrzwspolnotowyVatDowolnyD, @e_SPR_nWewnatrzwspolnotowyVatDowolnyDT,
					  @e_SPR_nWewnatrzwspolnotowyVatDowolnyDKorekta, @e_SPR_nWewnatrzwspolnotowyVat0DKorekta)
				begin
					IF @TRV_RodzajZakupu = 8   
					begin
						--wart_DTSU = wart_DTSU + @Netto;              -- pole 21
						--wart_DTSU_a = wart_DTSU_a + @Netto;              -- pole 22
						set @poleNaDekl = 21
						
						if @wersjaDeklaracji &gt;= 14
							set @poleNaDekl = @poleNaDekl - 10
						
						insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        					Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
						values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
							@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
						
						set @poleNaDekl = 22
						
						if @wersjaDeklaracji &gt;= 14
							set @poleNaDekl = @poleNaDekl - 10
						
						insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        					Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
						values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
							@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
				
					end;

					IF @TRV_StawkaPod &lt;&gt; 0 AND @TRV_FlagaVat = 1  
					begin
						IF @TRV_RodzajZakupu IN (1, 5) 
						begin
							if (@TRV_StawkaPod = 3 or @TRV_StawkaPod = 5 ) and @TRV_FlagaVat = 1 
							begin
								--wart_DTSU_3_5_Netto = wart_DTSU_3_5_Netto + @Netto;      -- pole 25
								--wart_DTSU_3_5_Vat = wart_DTSU_3_5_Vat + @Vat;        -- pole 26
								set @poleNaDekl = 25
						
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
							
							end
							else if (@TRV_StawkaPod = 7 or @TRV_StawkaPod = 8 ) and @TRV_FlagaVat = 1 
							begin
								--wart_DTSU_7_8_Netto = wart_DTSU_7_8_Netto + @Netto;      -- pole 27
								--wart_DTSU_7_8_Vat = wart_DTSU_7_8_Vat + @Vat;        -- pole 28
								set @poleNaDekl = 27
						
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
			                    
							end
							else if (@TRV_StawkaPod = 22 or @TRV_StawkaPod = 23 ) and @TRV_FlagaVat = 1 
							begin
								--wart_DTSU_22_23_Netto = wart_DTSU_22_23_Netto + @Netto;    -- pole 29
								--wart_DTSU_22_23_Vat = wart_DTSU_22_23_Vat + @Vat;      -- pole 30
								set @poleNaDekl = 29
						
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
							
							end            
						end
					end
					ELSE IF @TRV_StawkaPod = 0 AND @TRV_FlagaVat = 2 
					begin         
						IF @TRV_RodzajZakupu IN (1, 5) 
						begin
							--wart_DTSU = wart_DTSU + @Netto;                -- pole 21
							set @poleNaDekl = 21
						
							if @wersjaDeklaracji &gt;= 14
								set @poleNaDekl = @poleNaDekl - 10
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        						Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end           
					end
					ELSE
					begin
						IF @TRV_RodzajZakupu = 1 AND @TRV_StawkaPod = 0 AND @TRV_FlagaVat = 1 
						begin
							--wart_WWDT = wart_WWDT + @Netto;                -- pole 31
							set @poleNaDekl = 31
						
							if @wersjaDeklaracji &gt;= 14
								set @poleNaDekl = @poleNaDekl - 10
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        						Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end;        
			        
						IF @TRV_RodzajZakupu in (1, 5) AND @TRV_FlagaVat = 0 
						begin
							--wart_DTSU_Zw = wart_DTSU_Zw + @Netto;             -- pole 20
							set @poleNaDekl = 20
						
							if @wersjaDeklaracji &gt;= 14
								set @poleNaDekl = @poleNaDekl - 10
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        						Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end;

						IF @TRV_RodzajZakupu = 5 AND @TRV_FlagaVat = 1 
						begin
							--wart_DTSU_0 = wart_DTSU_0 + @Netto;              -- pole 23
							set @poleNaDekl = 23
						
							if @wersjaDeklaracji &gt;= 14
								set @poleNaDekl = @poleNaDekl - 10
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        						Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end            
					end
				end
				ELSE
				begin
					IF (@TRV_ExpoNorm IN (@e_SPR_nImportowyVat0FW, @e_SPR_nImportowyVatDowolnyFW) AND
						@TRV_GIDTyp IN (@Typ_FW, @Typ_FWK)) OR
					   (@TRV_GIDTyp IN (@Typ_FWS, @Typ_FKS) and @TRV_ExpoNorm = @e_SPR_nEksportowyVat0)
			        
					begin

						IF @TRV_StawkaPod = 0 AND @TRV_FlagaVat = 2 
						begin
							IF @g_ksi_lUwzgledniajNieopodatkowane = 1 
								if @TRV_RodzajZakupu = 5     --@e_ksi_lRodzajZakupu_ImportUslug
								begin                    
									--wart_IU_Netto = wart_IU_Netto + @Netto;    -- pole 37
									--wart_IU_Vat   = wart_IU_Vat + @Vat;        -- pole 38
									if not ( @TRV_GIDTyp IN (@Typ_FWS, @Typ_FKS) and @TRV_ExpoNorm = @e_SPR_nEksportowyVat0  )	--and @wersjaDeklaracji = 15 )
									begin
										set @poleNaDekl = 37
						
										if @wersjaDeklaracji &gt;= 14
											set @poleNaDekl = @poleNaDekl - 10
									
										insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        									Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
										values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
											@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
									end

								end  
								else if @TRV_RodzajZakupu = 8    --@e_ksi_lRodzajZakupu_UslugiRO
								begin
			                    
									if not ( @TRV_GIDTyp IN (@Typ_FWS, @Typ_FKS) and @TRV_ExpoNorm = @e_SPR_nEksportowyVat0 )	--and @wersjaDeklaracji = 15 )
									begin
										--wart_IU_Netto       = wart_IU_Netto + @Netto;    -- pole 37
										--wart_IU_Vat         = wart_IU_Vat + @Vat;        -- pole 38
										set @poleNaDekl = 37
						
										if @wersjaDeklaracji &gt;= 14
											set @poleNaDekl = @poleNaDekl - 10
									
										insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
	        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
										values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
											@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
							
										--wart_IU_RO_Netto    = wart_IU_RO_Netto + @Netto;    -- pole 39
										--wart_IU_RO_Vat      = wart_IU_RO_Vat + @Vat;        -- pole 40
										set @poleNaDekl = 39
						
										if @wersjaDeklaracji &gt;= 14
											set @poleNaDekl = @poleNaDekl - 10
									
										insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        									Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
										values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
											@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
									end

								end
						end   
						ELSE
						begin
							if @TRV_RodzajZakupu = 5       --@e_ksi_lRodzajZakupu_ImportUslug
							begin
								--wart_IU_Netto       = wart_IU_Netto + @Netto;    -- pole 37
								--wart_IU_Vat         = wart_IU_Vat + @Vat;        -- pole 38
								set @poleNaDekl = 37
						
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

							end    
							else if @TRV_RodzajZakupu = 8       --@e_ksi_lRodzajZakupu_UslugiRO
							begin
								--wart_IU_Netto       = wart_IU_Netto + @Netto;    -- pole 37
								--wart_IU_Vat         = wart_IU_Vat + @Vat;        -- pole 38
								set @poleNaDekl = 37
						
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
									
								--wart_IU_RO_Netto    = wart_IU_RO_Netto + @Netto;    -- pole 39
								--wart_IU_RO_Vat      = wart_IU_RO_Vat + @Vat;        -- pole 40
								set @poleNaDekl = 39
						
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

							end
						end
					end
					ELSE IF @TRN_VatKorekta = 1 
					begin
						IF @TRV_FlagaVat = 1     -- normalny podatek
						begin
							IF @TRV_StawkaPod = 0 AND (@TRV_ExpoNorm = 2 OR @TRV_ExpoNorm = 4) 
							begin
								--wart_ExT = wart_ExT + @Netto;     -- pole 32
								set @poleNaDekl = 32
						
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

							end
							ELSE IF (@TRV_RodzajZakupu &lt;&gt; 8 AND
								NOT (@TRV_RodzajZakupu = 1 AND @TRV_StawkaPod = 0 AND
								 @TRV_ExpoNorm IN (@e_SPR_nWewnatrzwspolnotowyVatDowolnyDTKorekta, @e_SPR_nWewnatrzwspolnotowyVat0DTKorekta))) 
							begin
								IF @TRV_StawkaPod = 0
								BEGIN
									--wart_DTSU_0 = wart_DTSU_0 + @Netto;              -- pole 23
									set @poleNaDekl = 23
						
									if @wersjaDeklaracji &gt;= 14
										set @poleNaDekl = @poleNaDekl - 10
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
								END
								ELSE IF @TRV_StawkaPod IN (3,5)
								BEGIN								
									set @poleNaDekl = 25
						
									if @wersjaDeklaracji &gt;= 14
										set @poleNaDekl = @poleNaDekl - 10
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
								END
								ELSE IF @TRV_StawkaPod IN (7,8)
								BEGIN								
									set @poleNaDekl = 27
						
									if @wersjaDeklaracji &gt;= 14
										set @poleNaDekl = @poleNaDekl - 10
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
								END
								ELSE IF @TRV_StawkaPod IN (22,23)
								BEGIN								
									set @poleNaDekl = 29
						
									if @wersjaDeklaracji &gt;= 14
										set @poleNaDekl = @poleNaDekl - 10
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
								END
							end;
			          
							IF @TRV_ExpoNorm IN (@e_SPR_nWewnatrzwspolnotowyVatDowolnyDTKorekta, @e_SPR_nWewnatrzwspolnotowyVat0DTKorekta) 
							begin
								IF (@TRV_RodzajZakupu = 8) 
								begin								
									--wart_DTSU = wart_DTSU + @Netto;              -- pole 21
									--wart_DTSU_a = wart_DTSU_a + @Netto;              -- pole 22
									set @poleNaDekl = 21
						
									if @wersjaDeklaracji &gt;= 14
										set @poleNaDekl = @poleNaDekl - 10
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
										
									set @poleNaDekl = 22
						
									if @wersjaDeklaracji &gt;= 14
										set @poleNaDekl = @poleNaDekl - 10
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

								end;

								IF @TRV_RodzajZakupu = 1 AND @TRV_StawkaPod = 0 
								begin
									--wart_WWDT = wart_WWDT + @Netto;                -- pole 31
									set @poleNaDekl = 31								
						
									if @wersjaDeklaracji &gt;= 14
										set @poleNaDekl = @poleNaDekl - 10
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

								end
							end
			            
						end            
						ELSE IF @TRV_FlagaVat IN (0,2)  
						begin
							IF @TRV_FlagaVat = 2 AND @g_ksi_lUwzgledniajNieopodatkowane = 1
							BEGIN
								IF @TRV_Struktura = 0
								begin
									IF @TRV_RodzajZakupu IN ( 1, 5)         
									BEGIN
										set @poleNaDekl = 23
						
										if @wersjaDeklaracji &gt;= 14
											set @poleNaDekl = @poleNaDekl - 10
										
										insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        									Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
										values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
											@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
									END
								end
								ELSE IF @TRV_Struktura = 2
								begin															
									IF @TRV_RodzajZakupu in (1,5)
									BEGIN                        
										set @poleNaDekl = 20
						
										if @wersjaDeklaracji &gt;= 14
											set @poleNaDekl = @poleNaDekl - 10
										
										insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
	        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
										values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
											@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
									END
								end
								ELSE IF @TRV_Struktura = 1 and @wersjaDeklaracji&gt;=21 and @VatMarza=1
								begin															
									IF @TRV_RodzajZakupu in (1,5)
									BEGIN                        
										set @poleNaDekl = 1000 --liczenie tylko VatMarza
										set @TSV_Rozliczac = 0 --nie wchodzi na deklaracje
										
										insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
	        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
										values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
											@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
									END
								end
							END			
							ELSE if (@TRV_FlagaVat = 2 AND @g_ksi_lUwzgledniajNieopodatkowane = 0 and @wersjaDeklaracji&gt;=21 and @VatMarza=1)
							begin																
								set @poleNaDekl = 1000 --liczenie tylko VatMarza
								set @TSV_Rozliczac = 0 --nie wchodzi na deklaracje
																			
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
										
							end						  
							ELSE IF @TRV_FlagaVat &lt;&gt; 2 AND @TRV_RodzajZakupu in (1,5) 
							begin
								--wart_DTSU_Zw = wart_DTSU_Zw + @Netto;             -- pole 20
								set @poleNaDekl = 20
						
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

								--_VATQ:id = VAT7:const:KSZM
							end;              
			          
							IF @TRV_ExpoNorm IN (@e_SPR_nWewnatrzwspolnotowyVatDowolnyDTKorekta, @e_SPR_nWewnatrzwspolnotowyVat0DTKorekta) 
							begin
								IF (@TRV_RodzajZakupu IN (1, 5) AND @TRV_FlagaVat = 2) 
								begin
									--wart_DTSU = wart_DTSU + @Netto;                -- pole 21
									set @poleNaDekl = 21
						
									if @wersjaDeklaracji &gt;= 14
										set @poleNaDekl = @poleNaDekl - 10
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
								end
								ELSE IF @TRV_RodzajZakupu = 8 
								begin
									--wart_DTSU = wart_DTSU + @Netto;              -- pole 21
									--wart_DTSU_a = wart_DTSU_a + @Netto;              -- pole 22
									set @poleNaDekl = 21
						
									if @wersjaDeklaracji &gt;= 14
										set @poleNaDekl = @poleNaDekl - 10
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
									
									set @poleNaDekl = 22
						
									if @wersjaDeklaracji &gt;= 14
										set @poleNaDekl = @poleNaDekl - 10
									
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
								end                  
							end                
						end
					end
					ELSE    
					begin      
						IF @TRV_FlagaVat = 1 AND @TRV_StawkaPod = 0 AND (@TRV_ExpoNorm = 2 OR @TRV_ExpoNorm = 4) 
						begin
							--wart_ExT = wart_ExT + @Netto;                 -- pole 32
							set @poleNaDekl = 32
						
							if @wersjaDeklaracji &gt;= 14
								set @poleNaDekl = @poleNaDekl - 10
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        						Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end
						ELSE IF @TRV_FlagaVat = 0 AND @TRV_StawkaPod = 0 AND (@TRV_ExpoNorm = 2 OR @TRV_ExpoNorm = 4) 
						begin
							--wart_DTSU_Zw = wart_DTSU_Zw + @Netto;             -- pole 20
							set @poleNaDekl = 20
						
							if @wersjaDeklaracji &gt;= 14
								set @poleNaDekl = @poleNaDekl - 10
							
							insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        						Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
							values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
								@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

						end					
						ELSE IF NOT (@TRV_FlagaVat = 1 AND @TRV_Zrodlowa &lt;&gt; 0)		-- ttt
						begin
							if @TRV_StawkaPod = 0 and @TRV_FlagaVAT = 2
							begin							
								if @g_ksi_lUwzgledniajNieopodatkowane = 1									
								begin								
									if @TRV_Struktura = 0 
									begin
										set @poleNaDekl = 23
						
										if @wersjaDeklaracji &gt;= 14
											set @poleNaDekl = @poleNaDekl - 10
										
										insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        									Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
										values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
											@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
									end
									else if @TRV_Struktura = 2
									begin
										set @poleNaDekl = 20
						
										if @wersjaDeklaracji &gt;= 14
											set @poleNaDekl = @poleNaDekl - 10
										
										insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        									Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
										values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
											@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
									end
									else if @TRV_Struktura = 1 and @wersjaDeklaracji&gt;=21 and @VatMarza=1
									begin																
										set @poleNaDekl = 1000 --liczenie tylko VatMarza
										set @TSV_Rozliczac = 0 --nie wchodzi na deklaracje
																			
										insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        									Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
										values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
											@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)										
									end
								end								
								else if (@g_ksi_lUwzgledniajNieopodatkowane = 0 and @wersjaDeklaracji&gt;=21 and @VatMarza=1)
								begin																
									set @poleNaDekl = 1000 --liczenie tylko VatMarza
									set @TSV_Rozliczac = 0 --nie wchodzi na deklaracje
																			
									insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        								Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
									values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
										@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)
										
								end
							end
							else 
							if @TRV_StawkaPod = 0 and @TRV_FlagaVat = 0
							begin
								--wart_DTSU_Zw = wart_DTSU_Zw + @Netto;             -- pole 20            
								set @poleNaDekl = 20
						
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

							end						
							else if @TRV_StawkaPod = 0 and @TRV_FlagaVat = 1  
							begin
								--wart_DTSU_0 = wart_DTSU_0 + @Netto;              -- pole 23
								set @poleNaDekl = 23
						
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, 0, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

							end
							else if (@TRV_StawkaPod = 3 or @TRV_StawkaPod = 5 ) and @TRV_FlagaVat = 1 
							begin
								--wart_DTSU_3_5_Netto = wart_DTSU_3_5_Netto + @Netto;       -- pole 25
								--wart_DTSU_3_5_Vat = wart_DTSU_3_5_Vat + @Vat;             -- pole 26
								set @poleNaDekl = 25
						
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

							end
							else if (@TRV_StawkaPod = 7 or @TRV_StawkaPod = 8) and @TRV_FlagaVat = 1 
							begin
								--wart_DTSU_7_8_Netto = wart_DTSU_7_8_Netto + @Netto;      -- pole 27
								--wart_DTSU_7_8_Vat = wart_DTSU_7_8_Vat + @Vat;            -- pole 28
								set @poleNaDekl = 27
						
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

							end
							else if (@TRV_StawkaPod = 22 or @TRV_StawkaPod = 23) and @TRV_FlagaVat = 1 
							begin
								--wart_DTSU_22_23_Netto = wart_DTSU_22_23_Netto + @Netto;    -- pole 29
								--wart_DTSU_22_23_Vat = wart_DTSU_22_23_Vat + @Vat;          -- pole 30
								set @poleNaDekl = 29
						
								if @wersjaDeklaracji &gt;= 14
									set @poleNaDekl = @poleNaDekl - 10
								
								insert #tmpWyn (GIDTyp, GIDNumer, GIDLp, NrWRej, Rejestr, PoleNaDekl, Odliczenie, DataWystaw, DataSprzed, NrDok,
        							Akronim, Nazwa,	Netto, Vat, AdresNabywcy, NIP, VatNalOd, KorektaDanych, TRV_KorektaDanych, KNANipPrefiks, KNAKodKraju, KNTExpoKraj, TSV_Rozliczac, KodyGIDTyp, KodyGIDNumer)
								values (@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatNumer, @TRN_VatRejestr, @poleNaDekl, 1, @DataWyst, @DataZak, 	
									@NumerDok, @Akronim, @Nazwa, @Netto, @Vat, @AdresNabywcy, @NIP, @TRV_VatNalOd, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @KodyGIDTyp, @KodyGIDNumer)

							end	
						end;
					end
				end    
		  end
		END
 		fetch next from curDok into
			@TRV_GIDTyp, @TRV_GIDNumer, @TRV_GIDLp, @TRN_VatRejestr, @TrN_VatNumer, @DataWyst, @DataZak,
			@Netto, @Vat, @TRV_StawkaPod, @TRV_FlagaVAT, @TRV_RodzajZakupu, @TRV_Struktura, @TRN_VatKorekta,
			@TRV_ExpoNorm, @TRV_Zrodlowa, @TRN_VatRok, @TRN_VatMiesiac, @TRN_RolnikRyczalt, @TRN_KorektaOdlicz, @CzySad,
			@NumerDok, @Akronim, @Nazwa, @AdresNabywcy, @NIP, @TRV_VatNalOd, @ZwrNumer, @KorektaDanych, @TRV_KorektaDanych, @KNANipPrefiks, @KNAKodKraju, @KNTExpoKraj, @TSV_Rozliczac, @TRN_Fiskalny, @TRN_TRNTyp, @KodyGIDTyp, @KodyGIDNumer
			,@TRN_DokTypJPK,@VatMarza
	end
	close curDok
	deallocate curDok
	--drop table cdn.tmpWyn 
	--select * into cdn.tmpWyn 
	--from #tmpWyn
	--return
	EXECUTE @rv = CDN.FakturySprzedazyWgDeklaracjiVatJPK_Zapytanie @miesiacKwartal , @kwartal , @miesiac , @rok , @wersjaDeklaracji , @uzgodnijVAT7 , @JPKPONNumer , @PONNumer

	drop table #tmpDokumenty
	drop table #tmpWyn
	if @rv &lt;&gt; 0
	begin 				
		raiserror('Błąd odczytu  JPKVatSprzedaz ', 16, 1)	
		return 1
	end
set nocount off	
END	
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>