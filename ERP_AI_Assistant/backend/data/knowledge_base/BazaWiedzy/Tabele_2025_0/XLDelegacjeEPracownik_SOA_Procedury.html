<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="[CDN].[XL_Delegacje] ("></A><PRE>
          <FONT SIZE="2"><I>/* [CDN].[XL_Delegacje] ( */</I><BR>
CREATE TABLE [CDN].[XL_Delegacje] (
    [Sync_ID] INT     IDENTITY (1, 1) NOT NULL,
    [Id]      INT     CONSTRAINT [DF_XL_Delegacje_Id] DEFAULT (0) NOT NULL,
    [TS]      INT     CONSTRAINT [DF_XL_Delegacje_TS] DEFAULT (datediff(second, CONVERT (DATETIME, '2011-01-01', 120), getdate())) NOT NULL,
    [Akcja]   TINYINT CONSTRAINT [DF_XL_Delegacje_Akcja] DEFAULT (1) NOT NULL,
    CONSTRAINT [DF_XL_DelegacjePrimary] PRIMARY KEY CLUSTERED ([Sync_ID] ASC)
) ON [PRIMARY];
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[CDN].[XL_Samochody] ("></A><PRE>
          <FONT SIZE="2"><I>/* [CDN].[XL_Samochody] ( */</I><BR>
CREATE TABLE [CDN].[XL_Samochody] (
    [Sync_ID] INT     IDENTITY (1, 1) NOT NULL,
    [Id]      INT     CONSTRAINT [DF_XL_Samochody_Id] DEFAULT (0) NOT NULL,
    [TS]      INT     CONSTRAINT [DF_XL_Samochody_TS] DEFAULT (datediff(second, CONVERT (DATETIME, '2011-01-01', 120), getdate())) NOT NULL,
    [Akcja]   TINYINT CONSTRAINT [DF_XL_Samochody_Akcja] DEFAULT (1) NOT NULL,
    CONSTRAINT [DF_XL_SamochodyPrimary] PRIMARY KEY CLUSTERED ([Sync_ID] ASC)
) ON [PRIMARY];
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[CDN].[XL_Slowniki] ("></A><PRE>
          <FONT SIZE="2"><I>/* [CDN].[XL_Slowniki] ( */</I><BR>
CREATE TABLE [CDN].[XL_Slowniki] (
    [Sync_ID] INT     IDENTITY (1, 1) NOT NULL,
    [Id]      INT     CONSTRAINT [DF_XL_Slowniki_Id] DEFAULT (0) NOT NULL,
    [TS]      INT     CONSTRAINT [DF_XL_Slowniki_TS] DEFAULT (datediff(second, CONVERT (DATETIME, '2011-01-01', 120), getdate())) NOT NULL,
    [Akcja]   TINYINT CONSTRAINT [DF_XL_Slowniki_Akcja] DEFAULT (1) NOT NULL,
    CONSTRAINT [DF_XL_SlownikiPrimary] PRIMARY KEY CLUSTERED ([Sync_ID] ASC)
) ON [PRIMARY];
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[CDN].[XL_SlownikiStruktura] ("></A><PRE>
          <FONT SIZE="2"><I>/* [CDN].[XL_SlownikiStruktura] ( */</I><BR>
CREATE TABLE [CDN].[XL_SlownikiStruktura] (
    [Sync_ID] INT     IDENTITY (1, 1) NOT NULL,
    [Id]      INT     CONSTRAINT [DF_XL_SlownikiStruktura_Id] DEFAULT (0) NOT NULL,
    [TS]      INT     CONSTRAINT [DF_XL_SlownikiStruktura_TS] DEFAULT (datediff(second, CONVERT (DATETIME, '2011-01-01', 120), getdate())) NOT NULL,
    [Akcja]   TINYINT CONSTRAINT [DF_XL_SlownikiStruktura_Akcja] DEFAULT (1) NOT NULL,
    CONSTRAINT [DF_XL_SlownikiStrukturaPrimary] PRIMARY KEY CLUSTERED ([Sync_ID] ASC)
) ON [PRIMARY];
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[CDN].[XL_Delegacje_SyncMap] ("></A><PRE>
          <FONT SIZE="2"><I>/* [CDN].[XL_Delegacje_SyncMap] ( */</I><BR>
CREATE TABLE [CDN].[XL_Delegacje_SyncMap] (
    [XLId]     INT NOT NULL,
    [EPracownikId] INT NOT NULL
) ON [PRIMARY];
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[CDN].[XL_Samochody_SyncMap] ("></A><PRE>
          <FONT SIZE="2"><I>/* [CDN].[XL_Samochody_SyncMap] ( */</I><BR>
CREATE TABLE [CDN].[XL_Samochody_SyncMap] (
    [XLId]     INT NOT NULL,
    [EPracownikId] INT NOT NULL
) ON [PRIMARY];
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[CDN].[XL_Slowniki_SyncMap] ("></A><PRE>
          <FONT SIZE="2"><I>/* [CDN].[XL_Slowniki_SyncMap] ( */</I><BR>
CREATE TABLE [CDN].[XL_Slowniki_SyncMap] (
    [XLId]     INT NOT NULL,
    [EPracownikId] INT NOT NULL
) ON [PRIMARY];
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[CDN].[XL_SlownikiStruktura_SyncMap] ("></A><PRE>
          <FONT SIZE="2"><I>/* [CDN].[XL_SlownikiStruktura_SyncMap] ( */</I><BR>
CREATE TABLE [CDN].[XL_SlownikiStruktura_SyncMap] (
    [XLId]     INT NOT NULL,
    [EPracownikId] INT NOT NULL
) ON [PRIMARY];
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[CDN].[XL_Delegacje_SyncMapDiff] ("></A><PRE>
          <FONT SIZE="2"><I>/* [CDN].[XL_Delegacje_SyncMapDiff] ( */</I><BR>
CREATE TABLE [CDN].[XL_Delegacje_SyncMapDiff] (
    [Sync_ID]      INT IDENTITY (1, 1) NOT NULL,
    [XLId]     INT NOT NULL,
    [EPracownikId] INT NOT NULL,
    CONSTRAINT [DF_XL_Delegacje_SyncMapDiffPrimary] PRIMARY KEY CLUSTERED ([Sync_ID] ASC)
) ON [PRIMARY];
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[CDN].[XL_Samochody_SyncMapDiff] ("></A><PRE>
          <FONT SIZE="2"><I>/* [CDN].[XL_Samochody_SyncMapDiff] ( */</I><BR>
CREATE TABLE [CDN].[XL_Samochody_SyncMapDiff] (
    [Sync_ID]      INT IDENTITY (1, 1) NOT NULL,
    [XLId]     INT NOT NULL,
    [EPracownikId] INT NOT NULL,
    CONSTRAINT [DF_XL_Samochody_SyncMapDiffPrimary] PRIMARY KEY CLUSTERED ([Sync_ID] ASC)
) ON [PRIMARY];
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[CDN].XL_Slowniki_SyncMapDiff ("></A><PRE>
          <FONT SIZE="2"><I>/* [CDN].XL_Slowniki_SyncMapDiff ( */</I><BR>
CREATE TABLE [CDN].XL_Slowniki_SyncMapDiff (
    [Sync_ID]      INT IDENTITY (1, 1) NOT NULL,
    [XLId]     INT NOT NULL,
    [EPracownikId] INT NOT NULL,
    CONSTRAINT [DF_XL_Slowniki_SyncMapDiffPrimary] PRIMARY KEY CLUSTERED ([Sync_ID] ASC)
) ON [PRIMARY];
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[CDN].XL_SlownikiStruktura_SyncMapDiff ("></A><PRE>
          <FONT SIZE="2"><I>/* [CDN].XL_SlownikiStruktura_SyncMapDiff ( */</I><BR>
CREATE TABLE [CDN].XL_SlownikiStruktura_SyncMapDiff (
    [Sync_ID]      INT IDENTITY (1, 1) NOT NULL,
    [XLId]     INT NOT NULL,
    [EPracownikId] INT NOT NULL,
    CONSTRAINT [DF_XL_SlownikiStruktura_SyncMapDiffPrimary] PRIMARY KEY CLUSTERED ([Sync_ID] ASC)
) ON [PRIMARY];
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[CDN].[XL_SyncStatus] ("></A><PRE>
          <FONT SIZE="2"><I>/* [CDN].[XL_SyncStatus] ( */</I><BR>
CREATE TABLE [CDN].[XL_SyncStatus] (
    [NazwaTabeli]      NVARCHAR (MAX) CONSTRAINT [DF_XL_NazwaTabeli] DEFAULT ('') NOT NULL,
    [XL_MaxSyncedId]   INT            CONSTRAINT [DF_XL_MaxSyncedXLId] DEFAULT (0) NOT NULL,
    [EP_MaxSyncedId]   INT            CONSTRAINT [DF_XL_MaxSyncedEPId] DEFAULT (0) NOT NULL,
    [XL_MaxMapaId]     INT            CONSTRAINT [DF_XL_MaxMapaXLId] DEFAULT (0) NOT NULL,
    [EP_MaxMapaId]     INT            CONSTRAINT [DF_XL_MaxMapaEPId] DEFAULT (0) NOT NULL,
    [EP_MaxFullSyncId] INT            CONSTRAINT [DF_XL_MaxFullSyncEPId] DEFAULT (0) NOT NULL
) ON [PRIMARY];
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="EP_SyncFramework_XL_Delegacje"></A><PRE>
          <FONT SIZE="2"><I>/* EP_SyncFramework_XL_Delegacje */</I><BR>
CREATE TRIGGER CDN.EP_SyncFramework_XL_Delegacje
    ON CDN.Delegacje
    FOR INSERT, UPDATE, DELETE
    AS BEGIN
           DECLARE @epChmura AS BIT, 
                   @epOperator AS VARCHAR;
          SET @epChmura = (select isnull(Kon_Wartosc,0) from cdn.Konfig where Kon_Numer = 7029)
          SET @epOperator = (SELECT TOP 1 [Kon_Wartosc]                                            
                              FROM   [CDN].[Konfig]                              
                              WHERE  [Kon_Numer] = 20129);
           IF (@epChmura = 1
               AND @epOperator IS NOT NULL)
               BEGIN
                   IF EXISTS (SELECT 1
                              FROM   [inserted] where [inserted].DLG_Stan &gt; 0)
                      AND NOT EXISTS (SELECT 1
                                      FROM   [deleted])
                       BEGIN
                           INSERT INTO [CDN].[XL_Delegacje] (Id)
                           SELECT [inserted].[DLG_Gidnumer]
                           FROM   [inserted];
                       END
                   ELSE
                       IF EXISTS (SELECT 1
                                  FROM   [deleted] where [deleted].DLG_Stan &gt; 0 )
                          AND EXISTS (SELECT 1
                                      FROM   [inserted])
                           BEGIN
                               INSERT INTO [CDN].[XL_Delegacje] (Id, Akcja)
								SELECT 									       
									    [inserted].[DLG_Gidnumer],
										2                                            
								FROM   [inserted] join [deleted] d
									    on inserted.DLG_GIDNumer = d.DLG_GIDNumer
								where 									        
										inserted.DLG_Aktywny = 0
										and inserted.DLG_TStampMod &lt;&gt; d.DLG_TStampMod
								;
                           END
                       ELSE IF EXISTS(SELECT 1
                                  FROM   [deleted] where [deleted].DLG_Stan = 0) 
                              AND EXISTS (SELECT 1
                                      FROM   [inserted])       
                           BEGIN 
                               INSERT INTO [CDN].[XL_Delegacje] (Id)
                               SELECT [inserted].[DLG_Gidnumer]
                               FROM   [inserted];
                            END                           
                       ELSE
                           IF EXISTS (SELECT *
                                      FROM   [deleted] where [deleted].DLG_Stan &gt; 0)
                               BEGIN
                                   INSERT INTO [CDN].[XL_Delegacje] (Id, Akcja)
                                   SELECT [deleted].[DLG_Gidnumer],
                                          3
                                   FROM   [deleted];
                               END
               END
       END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="EP_SyncFramework_XL_Delegacje_SyncMap"></A><PRE>
          <FONT SIZE="2"><I>/* EP_SyncFramework_XL_Delegacje_SyncMap */</I><BR>
CREATE TRIGGER CDN.EP_SyncFramework_XL_Delegacje_SyncMap
    ON [CDN].[XL_Delegacje_SyncMap]
    FOR INSERT, UPDATE, DELETE
    AS BEGIN
           DECLARE @epChmura AS BIT,
                   @epOperator AS VARCHAR;
           SET @epChmura = (select isnull(Kon_Wartosc,0) from cdn.Konfig where Kon_Numer = 7029)
           SET @epOperator = (SELECT TOP 1 [Kon_Wartosc]
                              FROM   [CDN].[Konfig]
                              WHERE  [Kon_Numer] = 20129);
           IF (@epChmura = 1
               AND @epOperator IS NOT NULL)
               BEGIN
                   IF EXISTS (SELECT 1
                              FROM   [inserted])
                      AND NOT EXISTS (SELECT 1
                                      FROM   [deleted])
                       BEGIN
                           INSERT INTO [CDN].[XL_Delegacje_SyncMapDiff] ([XLId], [EPracownikId])
                           SELECT [inserted].[XLId],
                                  [inserted].[EPracownikId]
                           FROM   [inserted];
                       END
                   ELSE
                       IF EXISTS (SELECT 1
                                  FROM   [deleted])
                          AND EXISTS (SELECT 1
                                      FROM   [inserted])
                           BEGIN
                               UPDATE [CDN].[XL_Delegacje_SyncMapDiff]
                               SET    [XLId] = (SELECT [inserted].[XLId]
                                                    FROM   [inserted])
                               WHERE  [EPracownikId] = (SELECT [inserted].[EPracownikId]
                                                        FROM   [inserted]);
                           END
                       ELSE
                           IF EXISTS (SELECT *
                                      FROM   [deleted])
                               BEGIN
                                   DELETE [CDN].[XL_Delegacje_SyncMapDiff]
                                   WHERE  [XLID] IN (SELECT [deleted].[XLId]
                                                        FROM   [deleted]);
                               END
               END
       END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="EP_SyncFramework_XL_Samochody"></A><PRE>
          <FONT SIZE="2"><I>/* EP_SyncFramework_XL_Samochody */</I><BR>
CREATE TRIGGER CDN.EP_SyncFramework_XL_Samochody
    ON CDN.Samochody
    FOR INSERT, UPDATE, DELETE
    AS BEGIN
           DECLARE @epChmura AS BIT, 
                   @epOperator AS VARCHAR;
          SET @epChmura = (select isnull(Kon_Wartosc,0) from cdn.Konfig where Kon_Numer = 7029)
          SET @epOperator = (SELECT TOP 1 [Kon_Wartosc]                                            
                              FROM   [CDN].[Konfig]                              
                              WHERE  [Kon_Numer] = 20129);
           IF (@epChmura = 1
               AND @epOperator IS NOT NULL)
               BEGIN
                   IF EXISTS (SELECT 1
                              FROM   [inserted] where [inserted].SaM_CzasModyfikacji &gt; 0)
                      AND NOT EXISTS (SELECT 1
                                      FROM   [deleted])
                       BEGIN
                           INSERT INTO [CDN].[XL_Samochody] (Id)
                           SELECT [inserted].[SAM_ID]
                           FROM   [inserted];
                       END
                   ELSE
                       IF EXISTS (SELECT 1
                                  FROM   [deleted] where [deleted].SaM_CzasModyfikacji &gt; 0 )
                          AND EXISTS (SELECT 1
                                      FROM   [inserted])
                           BEGIN
                               INSERT INTO [CDN].[XL_Samochody] (Id, Akcja)
                               SELECT [inserted].[SAM_ID],
                                      2
                               FROM   [inserted];
                           END
                       ELSE IF EXISTS(SELECT 1
                                  FROM   [deleted] where [deleted].SaM_CzasModyfikacji = 0) 
                              AND EXISTS (SELECT 1
                                      FROM   [inserted])       
                           BEGIN 
                               INSERT INTO [CDN].[XL_Samochody] (Id)
                               SELECT [inserted].[SAM_ID]
                               FROM   [inserted];
                            END                           
                       ELSE
                           IF EXISTS (SELECT *
                                      FROM   [deleted] where [deleted].SaM_CzasModyfikacji &gt; 0)
                               BEGIN
                                   INSERT INTO [CDN].[XL_Samochody] (Id, Akcja)
                                   SELECT [deleted].[SAM_ID],
                                          3
                                   FROM   [deleted];
                               END
               END
       END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="EP_SyncFramework_XL_Samochody_SyncMap"></A><PRE>
          <FONT SIZE="2"><I>/* EP_SyncFramework_XL_Samochody_SyncMap */</I><BR>
CREATE TRIGGER CDN.EP_SyncFramework_XL_Samochody_SyncMap
    ON [CDN].[XL_Samochody_SyncMap]
    FOR INSERT, UPDATE, DELETE
    AS BEGIN
           DECLARE @epChmura AS BIT, 
                   @epOperator AS VARCHAR;
           SET @epChmura = (select isnull(Kon_Wartosc,0) from cdn.Konfig where Kon_Numer = 7029)
           SET @epOperator = (SELECT TOP 1 [Kon_Wartosc]                                            
                              FROM   [CDN].[Konfig]                              
                              WHERE  [Kon_Numer] = 20129);
           IF (@epChmura = 1
               AND @epOperator IS NOT NULL)
               BEGIN
                   IF EXISTS (SELECT 1
                              FROM   [inserted])
                      AND NOT EXISTS (SELECT 1
                                      FROM   [deleted])
                       BEGIN
                           INSERT INTO [CDN].[XL_Samochody_SyncMapDiff] ([XLId], [EPracownikId])
                           SELECT [inserted].[XLId],
                                  [inserted].[EPracownikId]
                           FROM   [inserted];
                       END
                   ELSE
                       IF EXISTS (SELECT 1
                                  FROM   [deleted])
                          AND EXISTS (SELECT 1
                                      FROM   [inserted])
                           BEGIN
                               UPDATE [CDN].[XL_Samochody_SyncMapDiff]
                               SET    [XLId] = (SELECT [inserted].[XLId]
                                                    FROM   [inserted])
                               WHERE  [EPracownikId] = (SELECT [inserted].[EPracownikId]
                                                        FROM   [inserted]);
                           END
                       ELSE
                           IF EXISTS (SELECT *
                                      FROM   [deleted])
                               BEGIN
                                   DELETE [CDN].[XL_Samochody_SyncMapDiff]
                                   WHERE  [XLID] = (SELECT [deleted].[XLId]
                                                        FROM   [deleted]);
                               END
               END
       END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="EP_SyncFramework_XL_Slowniki"></A><PRE>
          <FONT SIZE="2"><I>/* EP_SyncFramework_XL_Slowniki */</I><BR>
CREATE TRIGGER CDN.EP_SyncFramework_XL_Slowniki
    ON [CDN].[Slowniki]
    FOR INSERT, UPDATE, DELETE
    AS BEGIN
           DECLARE @epChmura AS BIT, 
                   @epOperator AS VARCHAR;
           SET @epChmura = (SELECT isnull(Kon_Wartosc, 0)
                            FROM   cdn.Konfig
                            WHERE  Kon_Numer = 7029);
           SET @epOperator = (SELECT TOP 1 [Kon_Wartosc]
                              FROM   [CDN].[Konfig]
                              WHERE  [Kon_Numer] = 20129);
           IF (@epChmura = 1
               AND @epOperator IS NOT NULL)
               BEGIN
                   IF EXISTS (SELECT 1
                              FROM   [inserted]
                                     INNER JOIN
                                     cdn.SlownikiStruktura
                                     ON SLW_SLSId = SLS_Id
                                        AND [inserted].SLW_CzasModyfikacji &gt; 0)
                      AND NOT EXISTS (SELECT 1
                                      FROM   [deleted]
                                             INNER JOIN
                                             cdn.SlownikiStruktura
                                             ON SLW_SLSId = SLS_Id)
                       BEGIN
                           INSERT INTO [CDN].[XL_Slowniki] (Id)
                           SELECT [inserted].[SLW_ID]
                           FROM   [inserted];
                       END
                   ELSE
                       IF EXISTS (SELECT 1
                                  FROM   [deleted]
                                         INNER JOIN
                                         cdn.SlownikiStruktura
                                         ON SLW_SLSId = SLS_Id
                                            AND [deleted].SLW_CzasModyfikacji &gt; 0)
                          AND EXISTS (SELECT 1
                                      FROM   [inserted]
                                             INNER JOIN
                                             cdn.SlownikiStruktura
                                             ON SLW_SLSId = SLS_Id)
                           BEGIN
                               INSERT INTO [CDN].[XL_Slowniki] (Id, Akcja)
                               SELECT [inserted].[SLW_ID],
                                      2
                               FROM   [inserted];
                           END
                       ELSE
                           IF EXISTS (SELECT 1
                                      FROM   [deleted]
                                             INNER JOIN
                                             cdn.SlownikiStruktura
                                             ON SLW_SLSId = SLS_Id
                                                AND [deleted].SLW_CzasModyfikacji = 0)
                              AND EXISTS (SELECT 1
                                          FROM   [inserted]
                                                 INNER JOIN
                                                 cdn.SlownikiStruktura
                                                 ON SLW_SLSId = SLS_Id)
                               BEGIN
                                   INSERT INTO [CDN].[XL_Slowniki] (Id)
                                   SELECT [inserted].[SLW_ID]
                                   FROM   [inserted];
                               END
                           ELSE
                               IF EXISTS (SELECT *
                                          FROM   [deleted]
                                                 INNER JOIN
                                                 cdn.SlownikiStruktura
                                                 ON SLW_SLSId = SLS_Id
                                                    AND [deleted].SLW_CzasModyfikacji &gt; 0)
                                   BEGIN
                                       INSERT INTO [CDN].[XL_Slowniki] (Id, Akcja)
                                       SELECT [deleted].[SLW_ID],
                                              3
                                       FROM   [deleted];
                                   END
               END
       END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="EP_SyncFramework_XL_Slowniki_SyncMap"></A><PRE>
          <FONT SIZE="2"><I>/* EP_SyncFramework_XL_Slowniki_SyncMap */</I><BR>
CREATE TRIGGER CDN.EP_SyncFramework_XL_Slowniki_SyncMap
    ON [CDN].[XL_Slowniki_SyncMap]
    FOR INSERT, UPDATE, DELETE
    AS BEGIN
           DECLARE @epChmura AS BIT, 
                   @epOperator AS VARCHAR;
           SET @epChmura = (select isnull(Kon_Wartosc,0) from cdn.Konfig where Kon_Numer = 7029)
           SET @epOperator = (SELECT TOP 1 [Kon_Wartosc]                                            
                              FROM   [CDN].[Konfig]                              
                              WHERE  [Kon_Numer] = 20129);
           IF (@epChmura = 1
               AND @epOperator IS NOT NULL)
               BEGIN
                   IF EXISTS (SELECT 1
                              FROM   [inserted])
                      AND NOT EXISTS (SELECT 1
                                      FROM   [deleted])
                       BEGIN
                           INSERT INTO [CDN].[XL_Slowniki_SyncMapDiff] ([XLId], [EPracownikId])
                           SELECT [inserted].[XLId],
                                  [inserted].[EPracownikId]
                           FROM   [inserted];
                       END
                   ELSE
                       IF EXISTS (SELECT 1
                                  FROM   [deleted])
                          AND EXISTS (SELECT 1
                                      FROM   [inserted])
                           BEGIN
                               UPDATE [CDN].[XL_Slowniki_SyncMapDiff]
                               SET    [XLId] = (SELECT [inserted].[XLId]
                                                    FROM   [inserted])
                               WHERE  [EPracownikId] = (SELECT [inserted].[EPracownikId]
                                                        FROM   [inserted]);
                           END
                       ELSE
                           IF EXISTS (SELECT *
                                      FROM   [deleted])
                               BEGIN
                                   DELETE [CDN].[XL_Slowniki_SyncMapDiff]
                                   WHERE  [XLID] = (SELECT [deleted].[XLId]
                                                        FROM   [deleted]);
                               END
               END
       END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="EP_SyncFramework_XL_SlownikiStruktura"></A><PRE>
          <FONT SIZE="2"><I>/* EP_SyncFramework_XL_SlownikiStruktura */</I><BR>
CREATE TRIGGER CDN.EP_SyncFramework_XL_SlownikiStruktura
    ON [CDN].[SlownikiStruktura]
    FOR INSERT, UPDATE, DELETE
    AS BEGIN
           DECLARE @epChmura AS BIT, 
                   @epOperator AS VARCHAR;
           SET @epChmura = (SELECT isnull(Kon_Wartosc, 0)
                            FROM   cdn.Konfig
                            WHERE  Kon_Numer = 7029);
           SET @epOperator = (SELECT TOP 1 [Kon_Wartosc]
                              FROM   [CDN].[Konfig]
                              WHERE  [Kon_Numer] = 20129);
           IF (@epChmura = 1
               AND @epOperator IS NOT NULL)
               BEGIN
                   IF EXISTS (SELECT 1
                              FROM   [inserted])
                      AND NOT EXISTS (SELECT 1
                                      FROM   [deleted])
                       BEGIN
                           INSERT INTO [CDN].[XL_SlownikiStruktura] (Id)
                           SELECT [inserted].[SLS_ID]
                           FROM   [inserted];
                       END
                   ELSE
                       IF EXISTS (SELECT 1
                                  FROM   [deleted])
                          AND EXISTS (SELECT 1
                                      FROM   [inserted])
                           BEGIN
                               INSERT INTO [CDN].[XL_SlownikiStruktura] (Id, Akcja)
                               SELECT [inserted].[SLS_ID],
                                      2
                               FROM   [inserted];
                           END
                       ELSE
                           IF EXISTS (SELECT 1
                                      FROM   [deleted])
                              AND EXISTS (SELECT 1
                                          FROM   [inserted])
                               BEGIN
                                   INSERT INTO [CDN].[XL_SlownikiStruktura] (Id)
                                   SELECT [inserted].[SLS_ID]
                                   FROM   [inserted];
                               END
                           ELSE
                               IF EXISTS (SELECT *
                                          FROM   [deleted])
                                   BEGIN
                                       INSERT INTO [CDN].[XL_SlownikiStruktura] (Id, Akcja)
                                       SELECT [deleted].[SLS_ID],
                                              3
                                       FROM   [deleted];
                                   END
               END
       END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="EP_SyncFramework_XL_SlownikiStruktura_SyncMap"></A><PRE>
          <FONT SIZE="2"><I>/* EP_SyncFramework_XL_SlownikiStruktura_SyncMap */</I><BR>
CREATE TRIGGER CDN.EP_SyncFramework_XL_SlownikiStruktura_SyncMap
    ON [CDN].[XL_SlownikiStruktura_SyncMap]
    FOR INSERT, UPDATE, DELETE
    AS BEGIN
           DECLARE @epChmura AS BIT, 
                   @epOperator AS VARCHAR;
           SET @epChmura = (select isnull(Kon_Wartosc,0) from cdn.Konfig where Kon_Numer = 7029)
           SET @epOperator = (SELECT TOP 1 [Kon_Wartosc]                                            
                              FROM   [CDN].[Konfig]                              
                              WHERE  [Kon_Numer] = 20129);
           IF (@epChmura = 1
               AND @epOperator IS NOT NULL)
               BEGIN
                   IF EXISTS (SELECT 1
                              FROM   [inserted])
                      AND NOT EXISTS (SELECT 1
                                      FROM   [deleted])
                       BEGIN
                           INSERT INTO [CDN].[XL_SlownikiStruktura_SyncMapDiff] ([XLId], [EPracownikId])
                           SELECT [inserted].[XLId],
                                  [inserted].[EPracownikId]
                           FROM   [inserted];
                       END
                   ELSE
                       IF EXISTS (SELECT 1
                                  FROM   [deleted])
                          AND EXISTS (SELECT 1
                                      FROM   [inserted])
                           BEGIN
                               UPDATE [CDN].[XL_SlownikiStruktura_SyncMapDiff]
                               SET    [XLId] = (SELECT [inserted].[XLId]
                                                    FROM   [inserted])
                               WHERE  [EPracownikId] = (SELECT [inserted].[EPracownikId]
                                                        FROM   [inserted]);
                           END
                       ELSE
                           IF EXISTS (SELECT *
                                      FROM   [deleted])
                               BEGIN
                                   DELETE [CDN].[XL_SlownikiStruktura_SyncMapDiff]
                                   WHERE  [XLID] = (SELECT [deleted].[XLId]
                                                        FROM   [deleted]);
                               END
               END
       END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XL_EksportujMape]"></A><PRE>
          <FONT SIZE="2"><I>/* [XL_EksportujMape] */</I><BR>
CREATE PROCEDURE [CDN].[XL_EksportujMape]
AS
BEGIN
    DECLARE @xml AS XML;
    DECLARE @DelegacjeId AS INT,
            @SamochodyId AS INT,
            @SlownikiId AS INT,
            @SlownikiStrukturaId AS INT;
    SELECT @DelegacjeId = (SELECT TOP 1 [EP_MaxMapaId]
                           FROM   [CDN].[XL_SyncStatus]
                           WHERE  [NazwaTabeli] = 'Delegacje'),
           @SamochodyId = (SELECT TOP 1 [EP_MaxMapaId]
                           FROM   [CDN].[XL_SyncStatus]
                           WHERE  [NazwaTabeli] = 'Samochody'),
           @SlownikiId = (SELECT TOP 1 [EP_MaxMapaId]
                          FROM   [CDN].[XL_SyncStatus]
                          WHERE  [NazwaTabeli] = 'Slowniki'),
           @SlownikiStrukturaId = (SELECT TOP 1 [EP_MaxMapaId]
                                   FROM   [CDN].[XL_SyncStatus]
                                   WHERE  [NazwaTabeli] = 'SlownikiStruktura');
    SET @xml = (SELECT (SELECT (SELECT   [Sync_ID] AS [@Sync_ID],
                                         [XLId] AS [@XLId],
                                         [EPracownikId] AS [@EPracownikId]
                                FROM     [CDN].[XL_Delegacje_SyncMapDiff]
                                WHERE    [Sync_ID] &gt; @DelegacjeId
                                ORDER BY [Sync_ID] ASC
                                FOR      XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                        FOR    XML PATH ('DelegacjeMapa'), ELEMENTS, TYPE),
                       (SELECT (SELECT   [Sync_ID] AS [@Sync_ID],
                                         [XLId] AS [@XLId],
                                         [EPracownikId] AS [@EPracownikId]
                                FROM     [CDN].[XL_Samochody_SyncMapDiff]
                                WHERE    [Sync_ID] &gt; @SamochodyId
                                ORDER BY [Sync_ID] ASC
                                FOR      XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                        FOR    XML PATH ('SamochodyMapa'), ELEMENTS, TYPE),
                       (SELECT (SELECT   [Sync_ID] AS [@Sync_ID],
                                         [XLId] AS [@XLId],
                                         [EPracownikId] AS [@EPracownikId]
                                FROM     [CDN].[XL_Slowniki_SyncMapDiff]
                                WHERE    [Sync_ID] &gt; @SlownikiId
                                ORDER BY [Sync_ID] ASC
                                FOR      XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                        FOR    XML PATH ('SlownikiMapa'), ELEMENTS, TYPE),
                       (SELECT (SELECT   [Sync_ID] AS [@Sync_ID],
                                         [XLId] AS [@XLId],
                                         [EPracownikId] AS [@EPracownikId]
                                FROM     [CDN].[XL_SlownikiStruktura_SyncMapDiff]
                                WHERE    [Sync_ID] &gt; @SlownikiStrukturaId
                                ORDER BY [Sync_ID] ASC
                                FOR      XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                        FOR    XML PATH ('SlownikiStrukturaMapa'), ELEMENTS, TYPE)
                FOR    XML PATH (''), TYPE);
    SELECT CAST(@xml AS NVARCHAR(MAX));
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XL_EksportujDelegacje]"></A><PRE>
          <FONT SIZE="2"><I>/* [XL_EksportujDelegacje] */</I><BR>
CREATE PROCEDURE [CDN].[XL_EksportujDelegacje]
@pelnaSynchronizacja BIT
AS
BEGIN
    DECLARE @xml AS XML;
    DECLARE @DelegacjeId AS INT;
    SET @DelegacjeId = (SELECT TOP 1 CASE @pelnaSynchronizacja
                                     WHEN 0 THEN [EP_MaxSyncedId] ELSE [EP_MaxFullSyncId]
                                     END
                        FROM   [CDN].[XL_SyncStatus]
                        WHERE  [NazwaTabeli] = 'Delegacje');
    SET @xml = (SELECT (SELECT (SELECT   [SDLN].[Sync_ID] AS [@Sync_ID],
                                         ISNULL([SDLN].[Akcja], 1) AS [@Akcja],
                                         ISNULL([SDLN].[Id], DLG_Gidnumer) AS [@DlnId_XL],
                                         [DM].[EPracownikId] AS [@DLG_GidNumer],
                                         DLG_GidTyp AS [@DLG_GidTyp],
                                         DLG_GidFirma AS [@DLG_GidFirma],
                                         DLG_GidLp AS [@DLG_GidLp],
                                         DLG_Stan AS [@DLG_Stan],
                                         DLG_Rodzaj AS [@DLG_Rodzaj],
                                         PP.Prc_OptimaId AS [@DLG_PRCNumer],
                                         DLG_FrsWlascicielNumer AS [@DLG_FrsWlascicielNumer],
                                         isnull((SELECT CASE
                                                        WHEN isnull(DLG_FRSCentrumNumer, 0) = 2 THEN 3 ELSE isnull(FRS_OptimaId, 0)
                                                        END
                                                 FROM   cdn.FrmStruktura
                                                 WHERE  FRS_ID = DLG_FRSCentrumNumer
                                                        AND FRS_Warstwa = 2
                                                        AND FRS_GIDTyp = -4272), 0) AS [@DLG_FRSCentrumNumer],
                                         DLG_PrjTyp AS [@DLG_PrjTyp],
                                         (SELECT isnull(PRJ_OptimaId, 0)
                                          FROM   cdn.PrjStruktura
                                          WHERE  PRJ_GIDNumer = DLG_PRJNumer) AS [@DLG_PrjNumer],
                                         DLG_TStampWpr AS [@DLG_TStampWpr],
                                         DLG_OpeNumerWpr AS [@DLG_OpeNumerWpr],
                                         PW.Prc_OptimaId AS [@DLG_PrcNumerWpr],
                                         DLG_TStampAkcept AS [@DLG_TStampAkcept],
                                         DLG_Zaakceptowana AS [@DLG_Zaakceptowana],
                                         DLG_OpeNumerAkcept AS [@DLG_OpeNumerAkcept],
                                         PAk.Prc_OptimaId AS [@DLG_PrcNumerAkcept],
                                         DLG_TStampAnul AS [@DLG_TStampAnul],
                                         DLG_OpeNumerAnul AS [@DLG_OpeNumerAnul],
                                         PA.Prc_OptimaId AS [@DLG_PrcNumerAnul],
                                         DLG_TStampRozp AS [@DLG_TStampRozp],
                                         DLG_TStampZak AS [@DLG_TStampZak],
                                         DLG_Zatwierdzona AS [@DLG_Zatwierdzona],
                                         DLG_Kwota AS [@DLG_Kwota],
                                         DLG_DoWyplaty AS [@DLG_DoWyplaty],
                                         DLG_Waluta AS [@DLG_Waluta],
                                         DLG_Rok AS [@DLG_Rok],
                                         DLG_Miesiac AS [@DLG_Miesiac],
                                         DLG_Seria AS [@DLG_Seria],
                                         DLG_Numer AS [@DLG_Numer],
                                         DLG_Miejsce AS [@DLG_Miejsce],
                                         DLG_Cel AS [@DLG_Cel],
                                         DLG_WyjazdZMiejscaZam AS [@DLG_WyjazdZMiejscaZam],
                                         DLG_TStampRozl AS [@DLG_TStampRozl],
                                         DLG_TStampMod AS [@DLG_TStampMod],
                                         DLG_OPENumerMod AS [@DLG_OPENumerMod],
                                         DLG_PrcNumerMod AS [@DLG_PrcNumerMod],
                                                                                 DLG_Komentarz AS [@DLG_Komentarz],
                                         DLG_PokazKomentarz AS [@DLG_PokazKomentarz],
                                         DLG_TStampAkceptWPR AS [@DLG_TStampAkceptWPR],
                                         DLG_OPENumerAkceptWPR AS [@DLG_OPENumerAkceptWPR],
                                         DLG_PrcNumerAkceptWPR AS [@DLG_PrcNumerAkceptWPR],
                                         DLG_TStampZatw AS [@DLG_TStampZatw],
                                         DLG_OPENumerZatw AS [@DLG_OPENumerZatw],
                                         PZ.Prc_OptimaId AS [@DLG_PrcNumerZatw],
                                         DLG_Zaksiegowano AS [@DLG_Zaksiegowano],
                                         DLG_SposobGenPlatnosci AS [@DLG_SposobGenPlatnosci],
                                         DLG_Aktywny AS [@DLG_Aktywny],
                                         DLG_TrybWstawiania AS [@DLG_TrybWstawiania],
                                         DLG_Imie AS [@DLG_Imie],
                                         DLG_Nazwisko AS [@DLG_Nazwisko]
                                FROM     cdn.[Delegacje]
                                         FULL OUTER JOIN
                                         [CDN].[XL_Delegacje] AS SDLN
                                         ON [Dlg_GidNumer] = [SDLN].[Id]
                                         LEFT OUTER JOIN
                                         [CDN].[XL_Delegacje_SyncMap] AS DM
                                         ON [SDLN].[Id] = [DM].[XLId]
                                         LEFT OUTER JOIN
                                         CDN.PrcKarty AS PP
                                         ON PP.Prc_GIDNumer = DLG_PRCNumer
                                         LEFT OUTER JOIN
                                         CDN.PrcKarty AS PW
                                         ON PW.Prc_GIDNumer = DLG_PrcNumerWpr
                                         LEFT OUTER JOIN
                                         CDN.PrcKarty AS PZ
                                         ON PZ.Prc_GIDNumer = DLG_PrcNumerZatw
                                         LEFT OUTER JOIN
                                         CDN.PrcKarty AS PAk
                                         ON PAk.Prc_GIDNumer = DLG_PrcNumerAkcept
                                         LEFT OUTER JOIN
                                         CDN.PrcKarty AS PA
                                         ON PA.Prc_GIDNumer = DLG_PrcNumerAnul
                                WHERE    (@pelnaSynchronizacja = 1
                                          AND DLG_Gidnumer &gt; @DelegacjeId)
                                         OR (@pelnaSynchronizacja = 0
                                             AND [SDLN].[Sync_ID] &gt; @DelegacjeId)
                                ORDER BY [Sync_ID] ASC
                                FOR      XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                        FOR    XML PATH ('Delegacje'), ELEMENTS, TYPE),
                       (SELECT (SELECT DISTINCT 1 AS [@Akcja],
                                                DGE_Gidtyp AS [@DGE_Gidtyp],
                                                DGE_GidFirma AS [@DGE_GidFirma],
                                                DGE_GidNumer AS [@DGE_GidNumer_XL],
                                                DM.EPracownikId AS [@DGE_GidNumer],
                                                DGE_GidLp AS [@DGE_GidLp],
                                                DGE_Rodzaj AS [@DGE_Rodzaj],
                                                DGE_Waluta AS [@DGE_Waluta],
                                                DGE_Kraj AS [@DGE_Kraj],
                                                DGE_StawkaNumer AS [@DGE_StawkaNumer],
                                                DGE_LiczbaSniadan AS [@DGE_LiczbaSniadan],
                                                DGE_LiczbaObiadow AS [@DGE_LiczbaObiadow],
                                                DGE_Liczbakolacji AS [@DGE_Liczbakolacji],
                                                DGE_KwotaDiety AS [@DGE_KwotaDiety],
                                                DGE_TStampRozp AS [@DGE_TStampRozp],
                                                DGE_TStampZak AS [@DGE_TStampZak],
                                                DGE_Pokazkomentarz AS [@DGE_Pokazkomentarz],
                                                DGE_Komentarz AS [@DGE_Komentarz]
                                FROM   cdn.[DelegacjeElem]
                                       FULL OUTER JOIN
                                       [CDN].[XL_Delegacje] AS SDLN
                                       ON [DGE_GidNumer] = [SDLN].[Id]
                                       LEFT OUTER JOIN
                                       [CDN].[XL_Delegacje_SyncMap] AS DM
                                       ON [SDLN].[Id] = [DM].[XLId]
                                WHERE  (@pelnaSynchronizacja = 1
                                        AND DGE_Gidnumer &gt; @DelegacjeId)
                                       OR (@pelnaSynchronizacja = 0
                                           AND [SDLN].[Sync_ID] &gt; @DelegacjeId)
                                FOR    XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                        FOR    XML PATH ('DelegacjeElem'), ELEMENTS, TYPE),
                       (SELECT (SELECT DISTINCT 1 AS [@Akcja],
                                                SAP_ID AS [@SaP_Id],
                                                SAP_DataWyjazdu AS [@SaP_DataWyjazdu],
                                                SAP_DataPrzyjazdu AS [@SaP_DataPrzyjazdu],
                                                SAP_Odleglosc AS [@SaP_Odleglosc],
                                                SAP_SAMID AS [@SaP_SamId_XL],
                                                SSM.EPracownikId AS [@SaP_SamId],
                                                SAP_NrRej AS [@SaP_NrRej],
                                                SaP_RodzajPrzejazdu AS [@SaP_RodzajPrzejazdu],
                                                SAP_SrodekTransportu AS [@SaP_SrodekTransportu_XL],
                                                SPM.EPracownikId AS [@SaP_SrodekTransportu],
                                                SAP_TypWydatku AS [@SaP_TypWydatku],
                                                SAP_Kwota AS [@SaP_Kwota],
                                                SAP_OpeNumer AS [@SaP_OpeNumer],
                                                SAP_DataZapisu AS [@SaP_DataZapisu],
                                                SAP_Potwierdzony AS [@SaP_Potwierdzony],
                                                SaP_WyjazdZ AS [@SaP_WyjazdZ],
                                                SaP_PrzyjazdDo AS [@SaP_PrzyjazdDo],
                                                SaP_LicznikPocz AS [@SaP_LicznikPocz],
                                                SaP_LicznikKon AS [@SaP_LicznikKon],
                                                SaP_Opis AS [@SaP_Opis],
                                                SaP_DGENumer AS [@SaP_DGENumer_XL],
                                                Elem.DGE_GidNumer AS [@SaP_DGENumer],
                                                SaP_DGELp AS [@SaP_DGELp]
                                FROM   cdn.[SamPrzejazdy] AS T
                                       INNER JOIN
                                       (SELECT   [DGE_Gidnumer] AS DGE_GidNumer_XL,
                                                 DSM.EPracownikId AS DGE_GidNumer,
                                                 [DGE_GidLp]
                                        FROM     cdn.[DelegacjeElem]
                                                 FULL OUTER JOIN
                                                 [CDN].[XL_Delegacje] AS SDLN
                                                 ON [DGE_Gidnumer] = [SDLN].[Id]
                                                 LEFT OUTER JOIN
                                                 CDN.XL_Delegacje_SyncMap AS DSM
                                                 ON DGE_GidNumer = DSM.XLId
                                        WHERE    (@pelnaSynchronizacja = 1
                                                  AND DGE_Gidnumer &gt; @DelegacjeId)
                                                 OR (@pelnaSynchronizacja = 0
                                                     AND [SDLN].[Sync_ID] &gt; @DelegacjeId)
                                        GROUP BY [SDLN].[Id], [DGE_Gidnumer], [DGE_GidLp], DSM.EPracownikId) AS Elem
                                       ON T.[SAP_DGENumer] = [Elem].DGE_GidNumer_XL
                                          AND T.[SaP_DGELp] = [Elem].DGE_GIDLp
                                       LEFT OUTER JOIN
                                       cdn.XL_Samochody_SyncMap AS SSM
                                       ON SaP_SamId = ssm.XLId
                                       LEFT OUTER JOIN
                                       [CDN].[XL_Slowniki_SyncMap] AS SPM
                                       ON SPM.[XLId] = SAP_SrodekTransportu
                                FOR    XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                        FOR    XML PATH ('SamPrzejazdy'), ELEMENTS, TYPE),
                       (SELECT (SELECT DISTINCT 1 AS [@Akcja],
                                                WNO_Gidtyp AS [@WNO_Gidtyp],
                                                WNO_GidFirma AS [@WNO_GidFirma],
                                                WNO_GidNumer AS [@WNO_GidNumer],
                                                WNO_GidLp AS [@WNO_GidLp],
                                                WNO_Typ AS [@WNO_Typ],
                                                WNO_Stan AS [@WNO_Stan],
                                                PP.Prc_OptimaId AS [@WNO_PrcNumer],
                                                WNO_OpeNumerWpr AS [@WNO_OpeNumerWpr],
                                                PW.Prc_OptimaId AS [@WNO_PrcNumerWpr],
                                                WNO_TStampWpr AS [@WNO_TStampWpr],
                                                WNO_Zatwierdzono AS [@WNO_Zatwierdzono],
                                                WNO_OpeNumerZatw AS [@WNO_OpeNumerZatw],
                                                WNO_TStampZatw AS [@WNO_TStampZatw],
                                                WNO_Odrzucono AS [@WNO_Odrzucono],
                                                WNO_OpeNumerAnul AS [@WNO_OpeNumerAnul],
                                                WNO_TStampAnul AS [@WNO_TStampAnul],
                                                WNO_PowodAnul AS [@WNO_PowodAnul],
                                                WNO_Opis AS [@WNO_Opis],
                                                WNO_Kwota AS [@WNO_Kwota],
                                                WNO_Waluta AS [@WNO_Waluta],
                                                WNO_FrsNumer AS [@WNO_FrsNumer],
                                                WNO_Rok AS [@WNO_Rok],
                                                WNO_Miesiac AS [@WNO_Miesiac],
                                                WNO_Seria AS [@WNO_Seria],
                                                WNO_Numer AS [@WNO_Numer],
                                                DLG_GidNumer_XL AS [@WNO_DlgNumer_XL],
                                                DLG_GidNumer AS [@WNO_DlgNumer],
                                                WNO_DlgLp AS [@WNO_DlgLp],
                                                WNO_KazNumer AS [@WNO_KazNumer],
                                                WNO_TStampPow AS [@WNO_TStampPow],
                                                WNO_OpeNumerMod AS [@WNO_OpeNumerMod],
                                                WNO_PrcNumerMod AS [@WNO_PrcNumerMod],
                                                WNO_TStampMod AS [@WNO_TStampMod],
                                                PZ.Prc_OptimaId AS [@WNO_EprcNumerZatw],
                                                PA.Prc_OptimaId AS [@WNO_EprcNumerAnul],
                                                WNO_Aktywny AS [@WNO_Aktywny],
                                                WNO_TrybWstawiania AS [@WNO_TrybWstawiania]
                                FROM   cdn.[Wnioski] AS Z
                                       INNER JOIN
                                       (SELECT   [DLG_GidNumer] AS [DLG_GidNumer_XL],
                                                 DSM.EPracownikId AS [DLG_GidNumer]
                                        FROM     cdn.[Delegacje]
                                                 FULL OUTER JOIN
                                                 [CDN].[XL_Delegacje] AS SDLN
                                                 ON [DLG_GidNumer] = [SDLN].[Id]
                                                 LEFT OUTER JOIN
                                                 CDN.XL_Delegacje_SyncMap AS DSM
                                                 ON DLG_GIDNumer = DSM.XLId
                                        WHERE    (@pelnaSynchronizacja = 1
                                                  AND DLG_Gidnumer &gt; @DelegacjeId)
                                                 OR (@pelnaSynchronizacja = 0
                                                     AND [SDLN].[Sync_ID] &gt; @DelegacjeId)
                                        GROUP BY [SDLN].[Id], [DLG_GidNumer], DSM.EPracownikId) AS DlgNag
                                       ON Z.[WNO_DlgNumer] = [DlgNag].[DLG_GidNumer_XL]
                                       LEFT OUTER JOIN
                                       CDN.PrcKarty AS PP
                                       ON PP.Prc_GIDNumer = WNO_PrcNumer
                                       LEFT OUTER JOIN
                                       CDN.PrcKarty AS PW
                                       ON PW.Prc_GIDNumer = WNO_PrcNumerWpr
                                       LEFT OUTER JOIN
                                       CDN.PrcKarty AS PZ
                                       ON PZ.Prc_GIDNumer = WNO_EprcNumerZatw
                                       LEFT OUTER JOIN
                                       CDN.PrcKarty AS PA
                                       ON PA.Prc_GIDNumer = WNO_EprcNumerAnul
                                FOR    XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                        FOR    XML PATH ('Wnioski'), ELEMENTS, TYPE),
                       (SELECT (SELECT DISTINCT 1 AS [@Akcja],
                                                DGT_ID AS [@DGT_ID],
                                                SlSM.EPracownikId AS [@DGT_SrodekTransID],
                                                DGT_SrodekTransID AS [@DGT_SrodekTransID_XL],
                                                SSM.EPracownikId AS [@DGT_SamID],
                                                DGT_SamID AS [@DGT_SamID_XL],
                                                DGT_NrRejOpis AS [@DGT_NrRejOpis],
                                                DlgNag.DLG_GidNumer AS [@DGT_DLGNumer],
                                                DGT_DLGNumer AS [@DGT_DLGNumer_XL]
                                FROM   cdn.[DelegacjeTransport] AS Z
                                       INNER JOIN
                                       (SELECT   [DLG_GidNumer] AS DLG_GidNumer_XL,
                                                 DSM.EPracownikId AS DLG_GidNumer
                                        FROM     cdn.[Delegacje]
                                                 FULL OUTER JOIN
                                                 [CDN].[XL_Delegacje] AS SDLN
                                                 ON [DLG_GidNumer] = [SDLN].[Id]
                                                 LEFT OUTER JOIN
                                                 CDN.XL_Delegacje_SyncMap AS DSM
                                                 ON DLG_GIDNumer = DSM.XLId
                                        WHERE    (@pelnaSynchronizacja = 1
                                                  AND DLG_Gidnumer &gt; @DelegacjeId)
                                                 OR (@pelnaSynchronizacja = 0
                                                     AND [SDLN].[Sync_ID] &gt; @DelegacjeId)
                                        GROUP BY [SDLN].[Id], [DLG_GidNumer], DSM.EPracownikId) AS DlgNag
                                       ON Z.[DGT_DLGNumer] = [DlgNag].[DLG_GidNumer_XL]
                                       LEFT OUTER JOIN
                                       CDN.XL_Samochody_SyncMap AS SSM
                                       ON DGT_SamID = SSM.XLId
                                       LEFT OUTER JOIN
                                       CDN.XL_Slowniki_SyncMap AS SlSM
                                       ON DGT_SrodekTransID = SlSM.XLId
                                FOR    XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                        FOR    XML PATH ('DelegacjeTransport'), ELEMENTS, TYPE),
                       (SELECT (SELECT DISTINCT 1 AS [@Akcja],
                                                [WPR_Id] AS [@WPR_Id],
                                                [PP].[Prc_OptimaId] AS [@WPR_PrcNumer],
                                                [WPR_Data] AS [@WPR_Data],
                                                [WPR_OpeNumer] AS [@WPR_OpeNumer],
                                                [WPR_RodzajWydatku] AS [@WPR_RodzajWydatku_XL],
                                                [RWM].[EPracownikId] AS [@WPR_RodzajWydatku],
                                                [WPR_TypWydatku] AS [@WPR_TypWydatku_XL],
                                                [TWM].[EPracownikId] AS [@WPR_TypWydatku],
                                                [WPR_Wartosc] AS [@WPR_Wartosc],
                                                [WPR_SamId] AS [@WPR_SamId_XL],
                                                [SSM].EPracownikId AS [@WPR_SamId],
                                                [WPR_DokTyp] AS [@WPR_DokTyp],
                                                [WPR_DokFirma] AS [@WPR_DokFirma],
                                                [WPR_DokNumer] AS [@WPR_DokNumer],
                                                [WPR_DokLp] AS [@WPR_DokLp],
                                                [WPR_Procent] AS [@WPR_Procent],
                                                [WPR_Kwota] AS [@WPR_Kwota],
                                                [WPR_KntTyp] AS [@WPR_KntTyp],
                                                [WPR_KntNumer] AS [@WPR_KntNumer],
                                                [WPR_CWNId] AS [@WPR_CWNId],
                                                [WPR_Opis] AS [@WPR_Opis],
                                                [WPR_RokMiesiac] AS [@WPR_RokMiesiac],
                                                [WPR_ZewnetrznyId] AS [@WPR_ZewnetrznyId],
                                                [WPR_ZewnetrznySys] AS [@WPR_ZewnetrznySys],
                                                [WPR_Waluta] AS [@WPR_Waluta],
                                                [WPR_Zaakceptowano] AS [@WPR_Zaakceptowano],
                                                DlgNag.DLG_GidNumer AS [@WPR_DGENumer],
                                                [WPR_DGENumer] AS [@WPR_DGENumer_XL],
                                                [WPR_DGELp] AS [@WPR_DGELp],
                                                [WPR_DokZmianaPoAkcept] AS [@WPR_DokZmianaPoAkcept],
                                                [WPR_SaPId] AS [@WPR_SaPId_XL],
                                                [WPR_Predefiniowany] AS [@WPR_Predefiniowany],
                                                [WPR_Pozycja] AS [@WPR_Pozycja]
                                FROM   [CDN].[WydatkiPracownikow] AS W
                                       INNER JOIN
                                       (SELECT   [DLG_GidNumer] AS [DLG_GidNumer_XL],
                                                 DSM.EPracownikId AS [DLG_GidNumer]
                                        FROM     cdn.[Delegacje]
                                                 FULL OUTER JOIN
                                                 [CDN].[XL_Delegacje] AS SDLN
                                                 ON [DLG_GidNumer] = [SDLN].[Id]
                                                 LEFT OUTER JOIN
                                                 CDN.XL_Delegacje_SyncMap AS DSM
                                                 ON DLG_GIDNumer = DSM.XLId
                                        WHERE    (@pelnaSynchronizacja = 1
                                                  AND DLG_Gidnumer &gt; @DelegacjeId)
                                                 OR (@pelnaSynchronizacja = 0
                                                     AND [SDLN].[Sync_ID] &gt; @DelegacjeId)
                                        GROUP BY [SDLN].[Id], [DLG_GidNumer], DSM.EPracownikId) AS DlgNag
                                       ON W.WPR_DGENumer = [DlgNag].[DLG_GidNumer_XL]
                                       LEFT OUTER JOIN
                                       CDN.XL_Samochody_SyncMap AS SSM
                                       ON WPR_SamId = SSM.XLId
                                       LEFT OUTER JOIN
                                       CDN.PrcKarty AS PP
                                       ON PP.Prc_GIDNumer = WPR_PrcNumer
                                       LEFT OUTER JOIN
                                       [CDN].[XL_Slowniki_SyncMap] AS RWM
                                       ON RWM.[XLId] = [W].[WPR_RodzajWydatku]
                                       LEFT OUTER JOIN
                                       [CDN].[XL_Slowniki_SyncMap] AS TWM
                                       ON TWM.[XLId] = [W].[WPR_TypWydatku]
                                FOR    XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                        FOR    XML PATH ('WydatkiPracownikow'), ELEMENTS, TYPE)
                FOR    XML PATH (''), TYPE);
    SELECT CAST(@xml AS NVARCHAR(MAX));
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XL_ImportujMape]"></A><PRE>
          <FONT SIZE="2"><I>/* [XL_ImportujMape] */</I><BR>
CREATE PROCEDURE [CDN].[XL_ImportujMape]
@xml XML
AS
BEGIN
    DECLARE @syncId AS INT, 
            @xlId AS INT, 
            @epracownikId AS INT;
    DECLARE @DelegacjeID AS INT, 
            @SamochodyId AS INT, 
            @SlownikiId AS INT, 
            @SlownikiStrukturaId AS INT;
    SELECT @DelegacjeID = (SELECT TOP 1 [XL_MaxMapaId]
                           FROM   [CDN].[XL_SyncStatus]
                           WHERE  [NazwaTabeli] = 'Delegacje'),
           @SamochodyId = (SELECT TOP 1 [EP_MaxMapaId]
                           FROM   [CDN].[XL_SyncStatus]
                           WHERE  [NazwaTabeli] = 'Samochody'),
           @SlownikiId = (SELECT TOP 1 [EP_MaxMapaId]
                          FROM   [CDN].[XL_SyncStatus]
                          WHERE  [NazwaTabeli] = 'Slowniki'),
           @SlownikiStrukturaId = (SELECT TOP 1 [EP_MaxMapaId]
                                   FROM   [CDN].[XL_SyncStatus]
                                   WHERE  [NazwaTabeli] = 'SlownikiStruktura');
    DISABLE TRIGGER [CDN].EP_SyncFramework_XL_Delegacje_SyncMap
        ON [CDN].[XL_Delegacje_SyncMap];
    DISABLE TRIGGER [CDN].EP_SyncFramework_XL_Samochody_SyncMap
        ON [CDN].[XL_Samochody_SyncMap];
    DISABLE TRIGGER [CDN].EP_SyncFramework_XL_Slowniki_SyncMap
        ON [CDN].[XL_Slowniki_SyncMap];
    DISABLE TRIGGER [CDN].EP_SyncFramework_XL_SlownikiStruktura_SyncMap
        ON [CDN].[XL_SlownikiStruktura_SyncMap];
    -- Delegacje
    DECLARE DLN_records CURSOR LOCAL FAST_FORWARD READ_ONLY
        FOR SELECT x.value('(@Sync_ID)[1]', 'int'),
                   x.value('(@XLId)[1]', 'int'),
                   x.value('(@EPracownikId)[1]', 'int')
            FROM   @xml.nodes('/DelegacjeMapa/Itms/Itm') AS e(x);
    OPEN DLN_records;
    FETCH NEXT FROM DLN_records INTO @syncId, @xlId, @epracownikId;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @syncId &gt; @DelegacjeID
                BEGIN
                    IF EXISTS (SELECT TOP 1 EPracownikId
                               FROM   [CDN].[XL_Delegacje_SyncMap]
                               WHERE  [XLId] = @xlId)
                        BEGIN
                            DELETE [CDN].[XL_Delegacje_SyncMap]
                            WHERE  [XLId] = @xlId;
                        END
                    INSERT  INTO [CDN].[XL_Delegacje_SyncMap] ([XLId], [EPracownikId])
                    VALUES                                   (@xlId, @epracownikId);
                    UPDATE [CDN].[XL_SyncStatus]
                    SET    [XL_MaxMapaId] = @syncId
                    WHERE  [NazwaTabeli] = 'Delegacje';
                END
            FETCH NEXT FROM DLN_records INTO @syncId, @xlId, @epracownikId;
        END
    CLOSE DLN_records;
    DEALLOCATE DLN_records;
    -- Samochody
    DECLARE SAM_records CURSOR LOCAL FAST_FORWARD READ_ONLY
        FOR SELECT x.value('(@Sync_ID)[1]', 'int'),
                   x.value('(@XLId)[1]', 'int'),
                   x.value('(@EPracownikId)[1]', 'int')
            FROM   @xml.nodes('/SamochodyMapa/Itms/Itm') AS e(x);
    OPEN SAM_records;
    FETCH NEXT FROM SAM_records INTO @syncId, @xlId, @epracownikId;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @syncId &gt; @SamochodyId
                BEGIN
                    IF EXISTS (SELECT TOP 1 EPracownikId
                               FROM   [CDN].[XL_Samochody_SyncMap]
                               WHERE  [XLId] = @xlId)
                        BEGIN
                            DELETE [CDN].[XL_Samochody_SyncMap]
                            WHERE  [XLId] = @xlId;
                        END
                    INSERT  INTO [CDN].[XL_Samochody_SyncMap] ([XLId], [EPracownikId])
                    VALUES                                   (@xlId, @epracownikId);
                    UPDATE [CDN].[XL_SyncStatus]
                    SET    [XL_MaxMapaId] = @syncId
                    WHERE  [NazwaTabeli] = 'Samochody';
                END
            FETCH NEXT FROM SAM_records INTO @syncId, @xlId, @epracownikId;
        END
    CLOSE SAM_records;
    DEALLOCATE SAM_records;
    -- Slowniki
    DECLARE SLW_records CURSOR LOCAL FAST_FORWARD READ_ONLY
        FOR SELECT x.value('(@Sync_ID)[1]', 'int'),
                   x.value('(@XLId)[1]', 'int'),
                   x.value('(@EPracownikId)[1]', 'int')
            FROM   @xml.nodes('/SlownikiMapa/Itms/Itm') AS e(x);
    OPEN SLW_records;
    FETCH NEXT FROM SLW_records INTO @syncId, @xlId, @epracownikId;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @syncId &gt; @SlownikiId
                BEGIN
                    IF EXISTS (SELECT TOP 1 EPracownikId
                               FROM   [CDN].[XL_Slowniki_SyncMap]
                               WHERE  [XLId] = @xlId)
                        BEGIN
                            DELETE [CDN].[XL_Slowniki_SyncMap]
                            WHERE  [XLId] = @xlId;
                        END
                    INSERT  INTO [CDN].[XL_Slowniki_SyncMap] ([XLId], [EPracownikId])
                    VALUES                                  (@xlId, @epracownikId);
                    UPDATE [CDN].[XL_SyncStatus]
                    SET    [XL_MaxMapaId] = @syncId
                    WHERE  [NazwaTabeli] = 'Slowniki';
                END
            FETCH NEXT FROM SLW_records INTO @syncId, @xlId, @epracownikId;
        END
    CLOSE SLW_records;
    DEALLOCATE SLW_records;
    -- SlownikiStruktura
    DECLARE SLS_records CURSOR LOCAL FAST_FORWARD READ_ONLY
        FOR SELECT x.value('(@Sync_ID)[1]', 'int'),
                   x.value('(@XLId)[1]', 'int'),
                   x.value('(@EPracownikId)[1]', 'int')
            FROM   @xml.nodes('/SlownikiStrukturaMapa/Itms/Itm') AS e(x);
    OPEN SLS_records;
    FETCH NEXT FROM SLS_records INTO @syncId, @xlId, @epracownikId;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @syncId &gt; @SlownikiStrukturaId
                BEGIN
                    IF EXISTS (SELECT TOP 1 EPracownikId
                               FROM   [CDN].[XL_SlownikiStruktura_SyncMap]
                               WHERE  [XLId] = @xlId)
                        BEGIN
                            DELETE [CDN].[XL_SlownikiStruktura_SyncMap]
                            WHERE  [XLId] = @xlId;
                        END
                    INSERT  INTO [CDN].[XL_SlownikiStruktura_SyncMap] ([XLId], [EPracownikId])
                    VALUES                                           (@xlId, @epracownikId);
                    UPDATE [CDN].[XL_SyncStatus]
                    SET    [XL_MaxMapaId] = @syncId
                    WHERE  [NazwaTabeli] = 'SlownikiStruktura';
                END
            FETCH NEXT FROM SLS_records INTO @syncId, @xlId, @epracownikId;
        END
    CLOSE SLS_records;
    DEALLOCATE SLS_records;
    ENABLE TRIGGER [CDN].EP_SyncFramework_XL_Delegacje_SyncMap
        ON [CDN].[XL_Delegacje_SyncMap];
    ENABLE TRIGGER [CDN].EP_SyncFramework_XL_Samochody_SyncMap
        ON [CDN].[XL_Samochody_SyncMap];
    ENABLE TRIGGER [CDN].EP_SyncFramework_XL_Slowniki_SyncMap
        ON [CDN].[XL_Slowniki_SyncMap];
    ENABLE TRIGGER [CDN].EP_SyncFramework_XL_SlownikiStruktura_SyncMap
        ON [CDN].[XL_SlownikiStruktura_SyncMap];
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XL_ImportujDelegacje]"></A><PRE>
          <FONT SIZE="2"><I>/* [XL_ImportujDelegacje] */</I><BR>
CREATE PROCEDURE [CDN].[XL_ImportujDelegacje]
@xml XML
AS
BEGIN
    EXECUTE ('DISABLE TRIGGER CDN.EP_SyncFramework_XL_Delegacje ON CDN.Delegacje');
    DECLARE @pomin TABLE (
        Id INT);
    DECLARE @sapTmp TABLE (
        Xl_Id        INT,
        EPracownikId INT);
    -- Delegacje
    DECLARE @akcja AS INT, 
            @syncId AS INT, 
            @syncedId AS INT, 
            @DlnId_EP AS INT, 
            @DLG_GidNumer AS INT, 
            @DLG_Stan AS SMALLINT, 
            @DLG_PRCNumer AS INT, 
            @DLG_FRSCentrumNumer AS INT, 
            @DLG_PrjNumer AS INT, 
            @DLG_PrcNumerWpr AS INT, 
            @DLG_PrcNumerAnul AS INT, 
            @DLG_TStampRozp AS INT, 
            @DLG_TStampZak AS INT, 
            @DLG_Miejsce AS VARCHAR (4000), 
            @DLG_Cel AS VARCHAR (4000), 
            @DLG_WyjazdZMiejscaZam AS SMALLINT, 
            @DLG_Komentarz AS VARCHAR (4000);
    DECLARE @DataOd AS DATETIME, 
            @DataDo AS DATETIME;
    DECLARE DLN_records CURSOR LOCAL FAST_FORWARD READ_ONLY
        FOR SELECT x.value('(@Sync_ID)[1]', 'int'),
                   x.value('(@Akcja)[1]', 'int'), -- akcja
                   x.value('(@DlnId_EP)[1]', 'int'),
                   x.value('(@DLG_GidNumer)[1]', 'int'),
                   x.value('(@DLG_Stan)[1]', 'smallint'),
                   x.value('(@DLG_PRCNumer)[1]', 'int'),
                   x.value('(@DLG_FRSCentrumNumer)[1]', 'int'),
                   x.value('(@DLG_PrjNumer)[1]', 'int'),
                   x.value('(@DLG_PrcNumerWpr)[1]', 'int'),
                   x.value('(@DLG_TStampRozp)[1]', 'int'),
                   x.value('(@DLG_TStampZak)[1]', 'int'),
                   x.value('(@DLG_Miejsce)[1]', 'varchar(4000)'),
                   x.value('(@DLG_Cel)[1]', 'varchar(4000)'),
                   x.value('(@DLG_WyjazdZMiejscaZam)[1]', 'smallint'),
                   x.value('(@DLG_Komentarz)[1]', 'varchar(4000)')
            FROM   @xml.nodes('/Delegacje/Itms/Itm') AS e(x);
    SET @syncedId = 0;
    OPEN DLN_records;
    FETCH NEXT FROM DLN_records INTO @syncId, @akcja, @DlnId_EP, @DLG_GidNumer, @DLG_Stan, @DLG_PRCNumer, @DLG_FRSCentrumNumer, @DLG_PrjNumer, @DLG_PrcNumerWpr, @DLG_TStampRozp, @DLG_TStampZak, @DLG_Miejsce, @DLG_Cel, @DLG_WyjazdZMiejscaZam, @DLG_Komentarz;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @syncId &gt; @syncedId
                BEGIN
                    -- jezeli to update/delete to musze id pobrac z sync mapy
                    IF @DLG_GidNumer IS NULL
                       AND (@akcja = 2
                            OR @akcja = 3)
                        BEGIN
                            SET @DLG_GidNumer = (SELECT TOP 1 [XLId]
                                                 FROM   [CDN].[XL_Delegacje_SyncMap]
                                                 WHERE  [EPracownikId] = @DlnId_EP);
                        END
                    IF @akcja = 1
                       OR @akcja = 2
                        BEGIN
                            SET @DataOd = DATEADD(d, @DLG_TStampRozp, CONVERT (DATETIME, '28-12-1800', 105));
                            SET @DataDo = DATEADD(d, @DLG_TStampZak, CONVERT (DATETIME, '28-12-1800', 105));
                            -- usuwam wszystkie skladowe starej delegacji bo przesylamy naglowek+elementy
                            IF @DLG_GidNumer IS NOT NULL
                                BEGIN
                                    EXECUTE [CDN].[EP_DelegacjeZaliczki_Delete] 2984, @DLG_GidNumer;
                                    EXECUTE [CDN].[EP_DelegacjeElemPrzejazd_Delete] 2984, @DLG_GidNumer;
                                    EXECUTE [CDN].[EP_DelegacjeElemWydatek_Delete] 2984, @DLG_GidNumer;
                                END
                        END
                    IF @akcja = 1
                       AND @DLG_GidNumer IS NOT NULL
                        EXECUTE [CDN].[EP_DelegacjeElem_Delete] 2984, @DLG_GidNumer, 1;
                    IF @akcja = 1
                       AND @DLG_PRCNumer IS NOT NULL
                        BEGIN
                            EXECUTE [CDN].[EP_Delegacje_Add] @DataOd, @DataDo, @DLG_Miejsce, @DLG_Cel, @DLG_WyjazdZMiejscaZam, @DLG_Komentarz, @DLG_PRCNumer, @DLG_FRSCentrumNumer, @DLG_PrjNumer, @DLG_PrcNumerWpr;
                            SET @DLG_GidNumer = IDENT_CURRENT('CDN.Delegacje');
                            --uzupelnij mape
                            INSERT  INTO [CDN].[XL_Delegacje_SyncMap] ([EPracownikId], [XLId])
                            VALUES                                   (@DlnId_EP, @DLG_GidNumer);
                            IF @DLG_Stan = 2
                                BEGIN
                                    EXECUTE [CDN].[EP_Delegacje_Zaakceptuj] 2984, @DLG_GidNumer, @DLG_PrcNumerWpr;
                                END
                            IF @DLG_Stan = 3
                                BEGIN
                                    EXECUTE [CDN].[EP_Delegacje_Zaakceptuj] 2984, @DLG_GidNumer, @DLG_PrcNumerWpr;
                                    EXECUTE [CDN].[EP_Delegacje_AkceptujWprDoAkceptacji] 2984, @DLG_GidNumer, @DLG_PrcNumerWpr;
                                END
                        END
                    ELSE
                        IF @akcja = 2
                           AND @DLG_PRCNumer IS NOT NULL
                           AND @DLG_GidNumer IS NOT NULL
                            BEGIN
                                IF @DLG_Stan = 2
                                   AND EXISTS (SELECT TOP 1 *
                                               FROM   [CDN].[Delegacje]
                                               WHERE  [DLG_GIDNumer] = @DLG_GidNumer
                                                      AND [DLG_Stan] = 1)
                                    BEGIN
                                        EXECUTE [CDN].[EP_Delegacje_Zaakceptuj] 2984, @DLG_GidNumer, @DLG_PrcNumerWpr;
                                    END
                                IF @DLG_Stan = 3
                                   AND EXISTS (SELECT TOP 1 *
                                               FROM   [CDN].[Delegacje]
                                               WHERE  [DLG_GIDNumer] = @DLG_GidNumer
                                                      AND [DLG_Stan] IN (1, 2))
                                    BEGIN
                                        IF (SELECT TOP 1 DLG_Stan
                                            FROM   [CDN].[Delegacje]
                                            WHERE  [DLG_GIDNumer] = @DLG_GidNumer) = 1
                                            BEGIN
                                                EXECUTE [CDN].[EP_Delegacje_Zaakceptuj] 2984, @DLG_GidNumer, @DLG_PrcNumerWpr;
                                            END
                                        ELSE
                                            BEGIN
                                                EXECUTE [CDN].[EP_Delegacje_AkceptujWprDoAkceptacji] 2984, @DLG_GidNumer, @DLG_PrcNumerWpr;
                                            END
                                        EXECUTE [CDN].[EP_Delegacje_AkceptujWprDoAkceptacji] 2984, @DLG_GidNumer, @DLG_PrcNumerWpr;
                                    END
                                EXECUTE [CDN].[EP_Delegacje_Edit] 2984, @DLG_GidNumer, @DataOd, @DataDo, @DLG_Miejsce, @DLG_Cel, @DLG_WyjazdZMiejscaZam, @DLG_Komentarz, @DLG_PRCNumer, @DLG_FRSCentrumNumer, @DLG_PrjNumer, @DLG_PrcNumerWpr;
                            END
                    IF @akcja = 3
                       AND @DLG_GidNumer IS NOT NULL
                        BEGIN
                            EXECUTE [CDN].[EP_DelegacjeZaliczki_Delete] 2984, @DLG_GidNumer;
                            EXECUTE [CDN].[EP_DelegacjeElemPrzejazd_Delete] 2984, @DLG_GidNumer;
                            EXECUTE [CDN].[EP_DelegacjeElemWydatek_Delete] 2984, @DLG_GidNumer;
                            EXECUTE [CDN].[EP_DelegacjeElem_Delete] 2984, @DLG_GidNumer, 1;
                            EXECUTE [CDN].[EP_Delegacje_Delete] 2984, @DLG_GidNumer;
                            -- usun wpis z mapy
                            DELETE [CDN].[XL_Delegacje_SyncMap]
                            WHERE  [XLId] = @DLG_GidNumer;
                        END
                    UPDATE [CDN].[XL_SyncStatus]
                    SET    [XL_MaxSyncedId] = @syncId
                    WHERE  [NazwaTabeli] = 'Delegacje';
                END
            ELSE
                BEGIN
                    INSERT  INTO @pomin ([Id])
                    VALUES             (@DlnId_EP);
                END
            FETCH NEXT FROM DLN_records INTO @syncId, @akcja, @DlnId_EP, @DLG_GidNumer, @DLG_Stan, @DLG_PRCNumer, @DLG_FRSCentrumNumer, @DLG_PrjNumer, @DLG_PrcNumerWpr, @DLG_TStampRozp, @DLG_TStampZak, @DLG_Miejsce, @DLG_Cel, @DLG_WyjazdZMiejscaZam, @DLG_Komentarz;
        END
    CLOSE DLN_records;
    DEALLOCATE DLN_records;
    -- DlgElementy
    DECLARE @DGE_GIDNumer AS INT, 
            @DGE_LiczbaSniadan AS INT, 
            @DGE_LiczbaObiadow AS INT, 
            @DGE_LiczbaKolacji AS INT, 
            @DGE_Komentarz AS VARCHAR (4000), 
            @DGE_GidNumer_EP AS INT;
    DECLARE DLE_records CURSOR LOCAL FAST_FORWARD READ_ONLY
        FOR SELECT x.value('(@DGE_GidNumer)[1]', 'int'),
                   x.value('(@DGE_GidNumer_EP)[1]', 'int'),
                   x.value('(@DGE_LiczbaSniadan)[1]', 'int'),
                   x.value('(@DGE_LiczbaObiadow)[1]', 'int'),
                   x.value('(@DGE_LiczbaKolacji)[1]', 'int'),
                   x.value('(@DGE_Komentarz)[1]', 'varchar(4000)')
            FROM   @xml.nodes('/DelegacjeElem/Itms/Itm') AS e(x);
    OPEN DLE_records;
    FETCH NEXT FROM DLE_records INTO @DGE_GidNumer, @DGE_GidNumer_EP, @DGE_LiczbaSniadan, @DGE_LiczbaObiadow, @DGE_LiczbaKolacji, @DGE_Komentarz;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @DGE_GidNumer_EP IS NOT NULL
               AND NOT EXISTS (SELECT TOP 1 Id
                               FROM   @pomin
                               WHERE  [Id] = @DGE_GidNumer_EP)
                BEGIN
                    -- sprawdzam czy w mapie nie ma rekordu o takim ID. Je?eli jest to pobieram to id
                    IF @DGE_GidNumer IS NULL
                        BEGIN
                            SET @DGE_GidNumer = (SELECT TOP 1 XLId
                                                 FROM   [CDN].[XL_Delegacje_SyncMap]
                                                 WHERE  [EPracownikId] = @DGE_GidNumer_EP);
                        END
                    IF @DGE_GidNumer IS NOT NULL
                        BEGIN
                            EXECUTE [CDN].[EP_DelegacjeElem_Edit] 2984, @DGE_GidNumer, 1, @DGE_LiczbaSniadan, @DGE_LiczbaObiadow, @DGE_LiczbaKolacji, @DGE_Komentarz;
                        END
                END
            FETCH NEXT FROM DLE_records INTO @DGE_GidNumer, @DGE_GidNumer_EP, @DGE_LiczbaSniadan, @DGE_LiczbaObiadow, @DGE_LiczbaKolacji, @DGE_Komentarz;
        END
    CLOSE DLE_records;
    DEALLOCATE DLE_records;
    -- SamPrzejazdy
    DECLARE @SAP_ID AS INT, 
            @SAP_DGENumer AS INT, 
            @SAP_DGENumer_EP AS INT, 
            @SaP_DataWyjazdu AS INT, 
            @SaP_DataPrzyjazdu AS INT, 
            @SaP_SamId AS INT, 
            @SaP_SamId_EP AS INT, 
            @SaP_NrRej AS VARCHAR (10), 
            @SaP_SrodekTransportu AS INT, 
            @SaP_SrodekTransportu_EP AS INT, 
            @SaP_Kwota AS DECIMAL (15, 2), 
            @SaP_WyjazdZ AS VARCHAR (100), 
            @SaP_PrzyjazdDo AS VARCHAR (100), 
            @SaP_LicznikPocz AS DECIMAL (9, 2), 
            @SaP_LicznikKon AS DECIMAL (9, 2), 
            @SaP_Opis AS VARCHAR (1025);
    DECLARE @DataOdjazdu AS DATETIME, 
            @GodzinaOdjazdu AS DATETIME, 
            @DataPrzyjazdu AS DATETIME, 
            @GodzinaPrzyjazdu AS DATETIME, 
            @SrodekLokomocji AS NVARCHAR (50);
    DECLARE DLT_records CURSOR LOCAL FAST_FORWARD READ_ONLY
        FOR SELECT x.value('(@SaP_Id)[1]', 'int'),
                   x.value('(@SaP_DGENumer)[1]', 'int'),
                   x.value('(@SaP_DGENumer_EP)[1]', 'int'),
                   x.value('(@SaP_DataWyjazdu)[1]', 'int'),
                   x.value('(@SaP_DataPrzyjazdu)[1]', 'int'),
                   x.value('(@SaP_NrRej)[1]', 'nvarchar(10)'),
                   x.value('(@SaP_SrodekTransportu)[1]', 'int'),
                   x.value('(@SaP_SrodekTransportu_EP)[1]', 'int'),
                   x.value('(@SaP_Kwota)[1]', 'decimal(15,2)'),
                   x.value('(@SaP_WyjazdZ)[1]', 'nvarchar(100)'),
                   x.value('(@SaP_PrzyjazdDo)[1]', 'nvarchar(100)'),
                   x.value('(@SaP_LicznikPocz)[1]', 'decimal(9,2)'),
                   x.value('(@SaP_LicznikKon)[1]', 'decimal(9,2)'),
                   x.value('(@SaP_Opis)[1]', 'nvarchar(1025)')
            FROM   @xml.nodes('/SamPrzejazdy/Itms/Itm') AS e(x);
    OPEN DLT_records;
    FETCH NEXT FROM DLT_records INTO @SAP_ID, @SAP_DGENumer, @SAP_DGENumer_EP, @SaP_DataWyjazdu, @SaP_DataPrzyjazdu, @SaP_NrRej, @SaP_SrodekTransportu, @SaP_SrodekTransportu_EP, @SaP_Kwota, @SaP_WyjazdZ, @SaP_PrzyjazdDo, @SaP_LicznikPocz, @SaP_LicznikKon, @SaP_Opis;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            -- musze pobrac id z sync mapy
            IF @SAP_DGENumer_EP IS NOT NULL
               AND NOT EXISTS (SELECT TOP 1 Id
                               FROM   @pomin
                               WHERE  [Id] = @DGE_GidNumer_EP)
                BEGIN
                    SET @SAP_DGENumer = (SELECT TOP 1 [XLId]
                                         FROM   CDN.XL_Delegacje_SyncMap
                                         WHERE  [EPracownikId] = @SAP_DGENumer_EP);
                    IF @SAP_DGENumer IS NOT NULL
                        BEGIN
                            IF @SaP_SrodekTransportu IS NULL
                                BEGIN
                                    SET @SaP_SrodekTransportu = (SELECT TOP 1 [XLId]
                                                                 FROM   CDN.XL_Slowniki_SyncMap
                                                                 WHERE  [EPracownikId] = @SaP_SrodekTransportu_EP);
                                END
                            SET @SrodekLokomocji = (SELECT TOP 1 [SLW_WartoscS]
                                                    FROM   [CDN].[Slowniki]
                                                    WHERE  [SLW_ID] = @SaP_SrodekTransportu);
                            SET @DataOdjazdu = isnull(CONVERT (VARCHAR (10), (SELECT DATEADD(second, @SaP_DataWyjazdu, CONVERT (DATETIME, '01-01-1990', 105))), 120), 0);
                            SET @GodzinaOdjazdu = isnull(CONVERT (VARCHAR (5), (SELECT DATEADD(second, @SaP_DataWyjazdu, CONVERT (DATETIME, '01-01-1990', 105))), 108), 0);
                            SET @DataPrzyjazdu = isnull(CONVERT (VARCHAR (10), (SELECT DATEADD(second, @SaP_DataPrzyjazdu, CONVERT (DATETIME, '01-01-1990', 105))), 120), 0);
                            SET @GodzinaPrzyjazdu = isnull(CONVERT (VARCHAR (5), (SELECT DATEADD(second, @SaP_DataPrzyjazdu, CONVERT (DATETIME, '01-01-1990', 105))), 108), 0);
                            EXECUTE [CDN].[EP_DelegacjeElemPrzejazd_Add] 2984, @SAP_DGENumer, 1, @SaP_WyjazdZ, @DataOdjazdu, @GodzinaOdjazdu, @SaP_PrzyjazdDo, @DataPrzyjazdu, @GodzinaPrzyjazdu, @SrodekLokomocji, 'Przejazdy', @SaP_Kwota, @SaP_Opis, @SaP_LicznikPocz, @SaP_LicznikKon, @SaP_NrRej;
                            INSERT  @sapTmp (EPracownikId, [Xl_Id])
                            VALUES         (@SAP_ID, IDENT_CURRENT('CDN.SamPrzejazdy'));
                        END
                END
            FETCH NEXT FROM DLT_records INTO @SAP_ID, @SAP_DGENumer, @SAP_DGENumer_EP, @SaP_DataWyjazdu, @SaP_DataPrzyjazdu, @SaP_NrRej, @SaP_SrodekTransportu, @SaP_SrodekTransportu_EP, @SaP_Kwota, @SaP_WyjazdZ, @SaP_PrzyjazdDo, @SaP_LicznikPocz, @SaP_LicznikKon, @SaP_Opis;
        END
    CLOSE DLT_records;
    DEALLOCATE DLT_records;
    -- Wnioski
    DECLARE @WNO_DLGNumer AS INT, 
            @WNO_DLGNumer_EP AS INT, 
            @WNO_Stan AS SMALLINT, 
            @WNO_PrcNumerWpr AS INT, 
            @WNO_Kwota AS DECIMAL (15, 2);
    DECLARE DLZ_records CURSOR LOCAL FAST_FORWARD READ_ONLY
        FOR SELECT x.value('(@WNO_DlgNumer)[1]', 'int'),
                   x.value('(@WNO_DlgNumer_EP)[1]', 'int'),
                   x.value('(@WNO_Stan)[1]', 'int'),
                   x.value('(@WNO_PrcNumerWpr)[1]', 'int'),
                   x.value('(@WNO_Kwota)[1]', 'decimal(15, 2)')
            FROM   @xml.nodes('/Wnioski/Itms/Itm') AS e(x);
    OPEN DLZ_records;
    FETCH NEXT FROM DLZ_records INTO @WNO_DLGNumer, @WNO_DLGNumer_EP, @WNO_Stan, @WNO_PrcNumerWpr, @WNO_Kwota;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @WNO_DLGNumer_EP IS NOT NULL
               AND NOT EXISTS (SELECT TOP 1 Id
                               FROM   @pomin
                               WHERE  [Id] = @WNO_DLGNumer_EP)
                BEGIN
                    -- musze pobrac id z sync mapy
                    IF (@WNO_DlgNumer IS NULL)
                        BEGIN
                            SET @WNO_DlgNumer = (SELECT TOP 1 [XLId]
                                                 FROM   CDN.XL_Delegacje_SyncMap
                                                 WHERE  [EPracownikId] = @WNO_DlgNumer_EP);
                        END
                    IF @WNO_DlgNumer IS NOT NULL
                        BEGIN
                            EXECUTE [CDN].[EP_DelegacjeZaliczki_Add] 2984, @WNO_DlgNumer, 0, @WNO_Kwota, @WNO_PrcNumerWpr;
                            IF @WNO_Stan = 2
                                EXECUTE [CDN].[EP_DelegacjeZaliczki_Zatwierdz] 2984, @WNO_DlgNumer, @WNO_PrcNumerWpr;
                        END
                END
            FETCH NEXT FROM DLZ_records INTO @WNO_DLGNumer, @WNO_DLGNumer_EP, @WNO_Stan, @WNO_PrcNumerWpr, @WNO_Kwota;
        END
    CLOSE DLZ_records;
    DEALLOCATE DLZ_records;
    -- wydatki pracownikow
    DECLARE @WPR_Data AS INT, 
            @WPR_TypWydatku_EP AS INT, 
            @WPR_TypWydatku AS INT, 
            @WPR_Wartosc AS DECIMAL (15, 2), 
            @WPR_Opis AS NVARCHAR (1024), 
            @WPR_DGENumer AS INT, 
            @WPR_DGENumer_EP AS INT, 
            @WPR_SaPId_EP AS INT;
    DECLARE @TypWydatku AS NVARCHAR (50);
    DECLARE WPR_records CURSOR LOCAL FAST_FORWARD READ_ONLY
        FOR SELECT x.value('(@WPR_Data)[1]', 'int'),
                   x.value('(@WPR_TypWydatku_EP)[1]', 'int'),
                   x.value('(@WPR_TypWydatku)[1]', 'int'),
                   x.value('(@WPR_Wartosc)[1]', 'decimal(15, 2)'),
                   x.value('(@WPR_Opis)[1]', 'nvarchar(1024)'),
                   x.value('(@WPR_DGENumer)[1]', 'int'),
                   x.value('(@WPR_DGENumer_EP)[1]', 'int'),
                   x.value('(@WPR_SaPId_EP)[1]', 'int')
            FROM   @xml.nodes('/WydatkiPracownikow/Itms/Itm') AS e(x);
    OPEN WPR_records;
    FETCH NEXT FROM WPR_records INTO @WPR_Data, @WPR_TypWydatku_EP, @WPR_TypWydatku, @WPR_Wartosc, @WPR_Opis, @WPR_DGENumer, @WPR_DGENumer_EP, @WPR_SaPId_EP;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @WPR_DGENumer_EP IS NOT NULL
               AND NOT EXISTS (SELECT TOP 1 Id
                               FROM   @pomin
                               WHERE  [Id] = @WPR_DGENumer_EP)
                BEGIN
                    -- musze pobrac id z sync mapy
                    IF (@WPR_DGENumer IS NULL)
                        SET @WPR_DGENumer = (SELECT TOP 1 [XLId]
                                             FROM   CDN.XL_Delegacje_SyncMap
                                             WHERE  [EPracownikId] = @WPR_DGENumer_EP);
                    IF @WPR_DGENumer IS NOT NULL
                        BEGIN
                            IF @WPR_TypWydatku IS NULL
                                BEGIN
                                    SET @WPR_TypWydatku = (SELECT TOP 1 [XLId]
                                                           FROM   CDN.XL_Slowniki_SyncMap
                                                           WHERE  [EPracownikId] = @WPR_TypWydatku_EP);
                                END
                            SET @TypWydatku = (SELECT TOP 1 slw_wartoscs
                                               FROM   [CDN].[Slowniki]
                                               WHERE  [SLW_ID] = @WPR_TypWydatku);
                            SET @WPR_SaPId_EP = (SELECT TOP 1 [Xl_Id]
                                                 FROM   @sapTmp
                                                 WHERE  [EPracownikId] = @WPR_SaPId_EP);
                            SET @DataOd = DATEADD(d, @WPR_Data, CONVERT (DATETIME, '28-12-1800', 105));
                            EXECUTE [CDN].[EP_DelegacjeElemWydatek_Add] 2984, @WPR_DGENumer, 1, @WPR_Wartosc, @TypWydatku, @WPR_Opis, @DataOd, @WPR_SaPId_EP;
                        END
                END
            FETCH NEXT FROM WPR_records INTO @WPR_Data, @WPR_TypWydatku_EP, @WPR_TypWydatku, @WPR_Wartosc, @WPR_Opis, @WPR_DGENumer, @WPR_DGENumer_EP, @WPR_SaPId_EP;
        END
    CLOSE WPR_records;
    DEALLOCATE WPR_records;
    ENABLE TRIGGER CDN.EP_SyncFramework_XL_Delegacje
        ON CDN.Delegacje;
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XL_EksportujSlowniki]"></A><PRE>
          <FONT SIZE="2"><I>/* [XL_EksportujSlowniki] */</I><BR>
CREATE PROCEDURE [CDN].[XL_EksportujSlowniki]
@pelnaSynchronizacja BIT
AS
BEGIN
    DECLARE @xml AS XML;
    DECLARE @samochodyID AS INT,
            @slownikiID AS INT,
            @slownikiStrukturaID AS INT;
    SET @samochodyID = (SELECT TOP 1 CASE @pelnaSynchronizacja
                                     WHEN 0 THEN [EP_MaxSyncedId] ELSE [EP_MaxFullSyncId]
                                     END
                        FROM   [CDN].[XL_SyncStatus]
                        WHERE  [NazwaTabeli] = 'Samochody');
    SET @slownikiID = (SELECT TOP 1 CASE @pelnaSynchronizacja
                                    WHEN 0 THEN [EP_MaxSyncedId] ELSE [EP_MaxFullSyncId]
                                    END
                       FROM   [CDN].[XL_SyncStatus]
                       WHERE  [NazwaTabeli] = 'Slowniki');
    SET @slownikiStrukturaID = (SELECT TOP 1 CASE @pelnaSynchronizacja
                                             WHEN 0 THEN [EP_MaxSyncedId] ELSE [EP_MaxFullSyncId]
                                             END
                                FROM   [CDN].[XL_SyncStatus]
                                WHERE  [NazwaTabeli] = 'SlownikiStruktura');
    SET @xml = (SELECT (SELECT (SELECT   [SU].[Sync_ID] AS [@Sync_ID], --      SAMOCHODY      --
                                         ISNULL([SU].[Akcja], 1) AS [@Akcja],
                                         isnull([SU].[Id], [Sam_id]) AS [@SamID_XL],
                                         [UM].[EPracownikId] AS [@Sam_Id],
                                         SaM_NrRej AS [@SaM_NrRej],
                                         SaM_Marka AS [@SaM_Marka_XL],
                                                                                 MM.EPracownikId AS [@SaM_Marka],
                                         SaM_Model AS [@SaM_Model],
                                         SaM_Kolor AS [@SaM_Kolor],
                                         SaM_Opis AS [@SaM_Opis],
                                         SaM_Ladownosc AS [@SaM_Ladownosc],
                                         SaM_KntTyp AS [@SaM_KntTyp],
                                         SaM_KntNumer AS [@SaM_KntNumer],
                                         SaM_KierTyp AS [@SaM_KierTyp],
                                         SaM_KierNumer AS [@SaM_KierNumer],
                                         SaM_KierLp AS [@SaM_KierLp],
                                         SaM_Domyslny AS [@SaM_Domyslny],
                                         SaM_RokProd AS [@SaM_RokProd],
                                         SaM_DataWazBadTech AS [@SaM_DataWazBadTech],
                                         SaM_NrPolisy AS [@SaM_NrPolisy],
                                         SaM_DataWazPolisy AS [@SaM_DataWazPolisy],
                                         SaM_Objetosc AS [@SaM_Objetosc],
                                         SaM_CzasModyfikacji AS [@SaM_CzasModyfikacji],
                                         SaM_Oddzialowy AS [@SaM_Oddzialowy]
                                FROM     cdn.[Samochody]
                                         FULL OUTER JOIN
                                         [CDN].[XL_Samochody] AS SU
                                         ON [Sam_Id] = [SU].[Id]
                                         LEFT OUTER JOIN
                                         [CDN].[XL_Samochody_SyncMap] AS UM
                                         ON [SU].[Id] = [UM].[XLId]
                                                                                 LEFT OUTER JOIN
                                                                                 CDN.XL_Slowniki_SyncMap AS MM
                                                                                 ON MM.XLId = SaM_Marka
                                WHERE    (@pelnaSynchronizacja = 1
                                          AND SAM_Id &gt; @samochodyID)
                                         OR ([SU].[Sync_ID] &gt; @samochodyID
                                             AND @pelnaSynchronizacja = 0)
                                ORDER BY [Sync_ID] ASC
                                FOR      XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                        FOR    XML PATH ('Samochody'), ELEMENTS, TYPE),
                       (SELECT (SELECT   [SU].[Sync_ID] AS [@Sync_ID], --      SLOWNIKI      --
                                         ISNULL([SU].[Akcja], 1) AS [@Akcja],
                                         isnull([SU].[Id], [Slw_id]) AS [@SLWID_XL],
                                         [UM].[EPracownikId] AS [@SLW_Id],
                                         SLW_Predefiniowany AS [@SLW_Predefiniowany],
                                         SLW_Kategoria AS [@SLW_Kategoria],
                                         SLW_WartoscS AS [@SLW_WartoscS],
                                         SLW_WartoscS1 AS [@SLW_WartoscS1],
                                         SLW_WartoscS2 AS [@SLW_WartoscS2],
                                         SLW_Nazwa AS [@SLW_Nazwa],
                                         SLW_WartoscN1 AS [@SLW_WartoscN1],
                                         SLW_WartoscN2 AS [@SLW_WartoscN2],
                                         SLW_WartoscN3 AS [@SLW_WartoscN3],
                                         SLW_WartoscN4 AS [@SLW_WartoscN4],
                                         SLW_WartoscL1 AS [@SLW_WartoscL1],
                                         SLW_WartoscL2 AS [@SLW_WartoscL2],
                                         SLW_Konto AS [@SLW_Konto],
                                         SLW_Aktywny AS [@SLW_Aktywny],
                                         SLW_Domyslny AS [@SLW_Domyslny],
                                         SLW_OptimaId AS [@SLW_OptimaId],
                                         SLW_WartoscL3 AS [@SLW_WartoscL3],
                                         SLW_SLSId AS [@SLW_SLSId_XL],
                                         [SSM].[EPracownikId] AS [@SLW_SLSId],
                                         SLW_CzasModyfikacji AS [@SLW_CzasModyfikacji],
                                         SLW_Archiwalny AS [@SLW_Archiwalny]
                                FROM     cdn.[Slowniki] AS S
                                         INNER JOIN
                                         cdn.SlownikiStruktura
                                         ON SLW_SLSId = SLS_Id
                                         FULL OUTER JOIN
                                         [CDN].[XL_Slowniki] AS SU
                                         ON [Slw_Id] = [SU].[Id]
                                         LEFT OUTER JOIN
                                         [CDN].[XL_Slowniki_SyncMap] AS UM
                                         ON [SU].[Id] = [UM].[XLId]
                                         LEFT OUTER JOIN
                                         [CDN].[XL_SlownikiStruktura_SyncMap] AS SSM
                                         ON [S].[SLW_SLSId] = [SSM].[XLId]
                                WHERE    ((@pelnaSynchronizacja = 1
                                           AND SLW_Id &gt; @slownikiID)
                                          OR ([SU].[Sync_ID] &gt; @slownikiID
                                              AND @pelnaSynchronizacja = 0))
                                ORDER BY [Sync_ID] ASC
                                FOR      XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                        FOR    XML PATH ('Slowniki'), ELEMENTS, TYPE),
                       (SELECT (SELECT   [SU].[Sync_ID] AS [@Sync_ID], --      SLOWNIKISTRUKTURA      --
                                         ISNULL([SU].[Akcja], 1) AS [@Akcja],
                                         isnull([SU].[Id], [Sls_id]) AS [@SLSID_XL],
                                         [UM].[EPracownikId] AS [@SLS_Id],
                                         [SLS_Predefiniowany] AS [@SLS_Predefiniowany],
                                         [SLS_OId] AS [@SLS_OId],
                                         [SLS_Lp] AS [@SLS_Lp],
                                         [SLS_Nazwa] AS [@SLS_Nazwa],
                                         [SLS_WartoscL1] AS [@SLS_WartoscL]
                                FROM     cdn.[SlownikiStruktura]
                                         FULL OUTER JOIN
                                         [CDN].[XL_SlownikiStruktura] AS SU
                                         ON [Sls_Id] = [SU].[Id]
                                         LEFT OUTER JOIN
                                         [CDN].[XL_SlownikiStruktura_SyncMap] AS UM
                                         ON [SU].[Id] = [UM].[XLId]
                                WHERE    ((@pelnaSynchronizacja = 1
                                           AND SLS_Id &gt; @slownikiStrukturaID)
                                          OR ([SU].[Sync_ID] &gt; @slownikiStrukturaID
                                              AND @pelnaSynchronizacja = 0))
                                ORDER BY [Sync_ID] ASC
                                FOR      XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                        FOR    XML PATH ('SlownikiStruktura'), ELEMENTS, TYPE)
                FOR    XML PATH (''), TYPE);
    SELECT CAST(@xml AS NVARCHAR(MAX));
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="XL_ImportujSlowniki"></A><PRE>
          <FONT SIZE="2"><I>/* XL_ImportujSlowniki */</I><BR>
CREATE PROCEDURE [CDN].XL_ImportujSlowniki
@xml XML
AS
BEGIN
    DECLARE @syncId AS INT, 
            @syncedId AS INT, 
            @akcja AS INT;
    -- Samochody
    DECLARE             
              @SamId_EP AS INT,
			  @SaM_Id  AS INT,
			  @SaM_NrRej  AS VARCHAR (10)   , 
		      @SaM_Marka  AS INTEGER        , 
			  @SaM_Model  AS VARCHAR (   20)   ,
			  @SaM_Kolor  AS VARCHAR (   40)   ,
			  @SaM_Opis   AS VARCHAR (  255)   ,
			  @SaM_Ladownosc AS DECIMAL ( 5,2) ,
			  @SaM_KntTyp   AS SMALLINT       ,
			  @SaM_KntNumer AS INTEGER        ,
			  @SaM_KierTyp  AS SMALLINT       ,
			  @SaM_KierNumer AS INTEGER        ,
			  @SaM_KierLp    AS SMALLINT       ,
			  @SaM_Domyslny  AS TINYINT        ,
			  @SaM_RokProd   AS SMALLINT       ,
			  @SaM_DataWazBadTech AS INTEGER        ,
			  @SaM_NrPolisy  AS VARCHAR (   20)   ,
			  @SaM_DataWazPolisy AS INTEGER        , 
			  @SaM_Objetosc  AS DECIMAL ( 5,2) , 
			  @SaM_CzasModyfikacji AS INTEGER        , 
			  @SaM_Oddzialowy AS SMALLINT;                          
            
    DECLARE SAM_records CURSOR LOCAL FAST_FORWARD READ_ONLY
        FOR SELECT x.value('(@Sync_ID)[1]', 'int'),
                   x.value('(@Akcja)[1]', 'int'), -- akcja
                   -- EPId
                   x.value('(@SamId_EP)[1]', 'int'),
                   -- @SAM_ID
                   x.value('(@SAM_ID)[1]', 'int'),
                   -- @SaM_NrRej
                   x.value('(@SaM_NrRej)[1]', 'VARCHAR (10)'),
                   -- @SaM_Marka
                   x.value('(@SaM_Marka)[1]', 'INT'),
                   -- @SaM_Model
                   x.value('(@SaM_Model)[1]', 'VARCHAR (20)'),
                   -- @SaM_Kolor
                   x.value('(@SaM_Kolor)[1]', 'VARCHAR (40)'),
                   -- @SaM_Opis
                   x.value('(@SaM_Opis)[1]', 'VARCHAR (255)'),
                   -- @SaM_Ladownosc
                   x.value('(@SaM_Ladownosc)[1]', 'Decimal(5,2)'),
                   -- @SaM_KntTyp
                   x.value('(@SaM_KntTyp)[1]', 'SMALLINT'),
                   -- @SaM_KntNumer
                   x.value('(@SaM_KntNumer)[1]', 'INT'),
                   -- @SaM_KierTyp
                   x.value('(@SaM_KierTyp)[1]', 'SMALLINT'),
                   -- @SaM_KierNumer
                   x.value('(@SaM_KierNumer)[1]', 'INT'),
                   -- @SaM_KierLp
                   x.value('(@SaM_KierLp)[1]', 'SMALLINT'),
                   -- @SaM_Domyslny
                   x.value('(@SaM_Domyslny)[1]', 'TINYINT'),
                   -- @SaM_RokProd
                   x.value('(@SaM_RokProd)[1]', 'SMALLINT'),
                   -- @SaM_DataWazBadTech
                   x.value('(@SaM_DataWazBadTech)[1]', 'INT'),
                   -- @SaM_NrPolisy
                   x.value('(@SaM_NrPolisy)[1]', 'VARCHAR(20)'),
                   -- @SaM_DataWazPolisy
                   x.value('(@SaM_DataWazPolisy)[1]', 'INT'),
                   -- @SaM_Objetosc
                   x.value('(@SaM_Objetosc)[1]', 'DECIMAL(5,2)'),
                   -- @SaM_CzasModyfikacji
                   x.value('(@SaM_CzasModyfikacji)[1]', 'INT'),
                   -- @SaM_Oddzialowy
                   x.value('(@SaM_Oddzialowy)[1]', 'SMALLINT')
                                                                           
            FROM   @xml.nodes('/Samochody/Itms/Itm') AS e(x);
    SET @syncedId = (SELECT TOP 1 [XL_MaxSyncedId]
                     FROM   [CDN].[XL_SyncStatus]
                     WHERE  [NazwaTabeli] = 'Samochody');
    OPEN SAM_records;
    FETCH NEXT FROM SAM_records INTO @syncId, @akcja, @SamId_EP,@SAM_ID,@SaM_NrRej,@SaM_Marka,@SaM_Model, @SaM_Kolor, @SaM_Opis,@SaM_Ladownosc, @SaM_KntTyp,@SaM_KntNumer, @SaM_KierTyp, @SaM_KierNumer, 
	@SaM_KierLp, @SaM_Domyslny, @SaM_RokProd, @SaM_DataWazBadTech, @SaM_NrPolisy, @SaM_DataWazPolisy, @SaM_Objetosc, @SaM_CzasModyfikacji, @SaM_Oddzialowy  
    ;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @syncId &gt; @syncedId
                BEGIN
                   
                    IF @akcja = 1
                       AND @SAM_ID IS NOT NULL
                        BEGIN                           
                                   INSERT INTO [CDN].[Samochody] (
                                            [SaM_NrRej]
										   ,[SaM_Marka]
										   ,[SaM_Model]
										   ,[SaM_Kolor]
										   ,[SaM_Opis]
										   ,[SaM_Ladownosc]
										   ,[SaM_KntTyp]
										   ,[SaM_KntNumer]
										   ,[SaM_KierTyp]
										   ,[SaM_KierNumer]
										   ,[SaM_KierLp]
										   ,[SaM_Domyslny]
										   ,[SaM_RokProd]
										   ,[SaM_DataWazBadTech]
										   ,[SaM_NrPolisy]
										   ,[SaM_DataWazPolisy]
										   ,[SaM_Objetosc]
										   ,[SaM_CzasModyfikacji]
										   ,[SaM_Oddzialowy])
                                    SELECT @SaM_NrRej,
                                           @SaM_Marka,
                                           @SaM_Model,
                                           @SaM_Kolor,
                                           @SaM_Opis,
                                           @SaM_Ladownosc,
                                           @SaM_KntTyp,
                                           @SaM_KntNumer,
                                           @SaM_KierTyp,
                                           @SaM_KierNumer,
                                           @SaM_KierLp,
                                           @SaM_Domyslny,
                                           @SaM_RokProd,
                                           @SaM_DataWazBadTech,
                                           @SaM_NrPolisy,
                                           @SaM_DataWazPolisy,
                                           @SaM_Objetosc,
                                           @SaM_CzasModyfikacji,
                                           @SaM_Oddzialowy
                                           ;
                                    --uzupelnij mape
                                    INSERT  INTO [CDN].[XL_Samochody_SyncMap] ([XLId], [EPracownikId])
                                    VALUES                                              (@SAM_ID, @SamId_EP);
                                END
                        END
                    ELSE
                        IF @akcja = 2
                           IF @SaM_Id IS NOT NULL
                            BEGIN
                                UPDATE cdn.[Samochody]
                                SET    [SaM_NrRej]        = @SaM_NrRej,
                                       [SaM_Marka]        = @SaM_Marka,
                                       [SaM_Model]        = @SaM_Model,
                                       [SaM_Kolor]        = @SaM_Kolor,
                                       [SaM_Opis]         = @SaM_Opis,
                                       [SaM_Ladownosc]    = @SaM_Ladownosc,
                                       [SaM_KntTyp]       = @SaM_KntTyp, 
                                       [SaM_KntNumer]     = @SaM_KntNumer,
                                       [SaM_KierTyp]      = @SaM_KierTyp,
                                       [SaM_KierNumer]    = @SaM_KierNumer,
                                       [SaM_KierLp]       = @SaM_KierLp,
                                       [SaM_Domyslny]     = @SaM_Domyslny,
                                       [SaM_RokProd]        = @SaM_RokProd,
                                       [SaM_DataWazBadTech]        = @SaM_DataWazBadTech,
                                       [SaM_NrPolisy] = @SaM_NrPolisy,
                                       [SaM_DataWazPolisy]     = @SaM_DataWazPolisy,
                                       [SaM_Objetosc]     = @SaM_Objetosc,
                                       [SaM_CzasModyfikacji] = @SaM_CzasModyfikacji,
                                       [SaM_Oddzialowy] = @SaM_Oddzialowy
                                       
                                WHERE  [SAM_Id] = @SaM_Id;
                            END
                        ELSE
                            IF @akcja = 3
                               AND @SAM_Id IS NOT NULL
                                BEGIN
                                    DELETE cdn.[Samochody]
                                    WHERE  [SAM_Id] = @SaM_Id;
                                    -- usun wpis z mapy
                                    DELETE [CDN].[XL_Samochody_SyncMap]
                                    WHERE  [XLId] = @SaM_Id;
                                END
                    UPDATE [CDN].[XL_SyncStatus]
                    SET    [XL_MaxSyncedId] = @syncId
                    WHERE  [NazwaTabeli] = 'Samochody';
                END
            FETCH NEXT FROM SAM_records INTO @syncId, @akcja, @SamId_EP,@SAM_ID,@SaM_NrRej,@SaM_Marka,@SaM_Model, @SaM_Kolor, @SaM_Opis,@SaM_Ladownosc, @SaM_KntTyp,@SaM_KntNumer, @SaM_KierTyp, 
			@SaM_KierNumer, @SaM_KierLp, @SaM_Domyslny, @SaM_RokProd, @SaM_DataWazBadTech, @SaM_NrPolisy, @SaM_DataWazPolisy, @SaM_Objetosc, @SaM_CzasModyfikacji, @SaM_Oddzialowy;
        END
    CLOSE SAM_records;
    DEALLOCATE SAM_records;
    
    ----Slowniki    
    DECLARE             
              @SLWId_EP AS INT,
			  @SLW_Id  AS INT,
			  @SLW_Predefiniowany AS INT,
			  @SLW_Kategoria AS VARCHAR(40),
			  @SLW_WartoscS AS VARCHAR(400),
			  @SLW_WartoscS1 AS VARCHAR(512),
			  @SLW_WartoscS2 AS VARCHAR(512),
			  @SLW_Nazwa AS VARCHAR(512),
			  @SLW_WartoscN1 AS DECIMAL(15,4),
			  @SLW_WartoscN2 AS DECIMAL(15,4),
			  @SLW_WartoscN3 AS DECIMAL(15,4),
			  @SLW_WartoscN4 AS DECIMAL(15,4),
			  @SLW_WartoscL1 AS INT,
			  @SLW_WartoscL2 AS INT,
			  @SLW_Konto  AS VARCHAR(40),
			  @SLW_Aktywny AS SMALLINT,	
			  @SLW_Domyslny	AS TINYINT,	  
			  @SLW_OptimaId AS INT,
			  @SLW_WartoscL3 AS INT,
			  @SLW_SLSId AS INT,
			  @SLW_CzasModyfikacji AS INT,
			  @SLW_Archiwalny AS TINYINT;			  
			  			                                    
    DECLARE SLW_records CURSOR LOCAL FAST_FORWARD READ_ONLY
        FOR SELECT x.value('(@Sync_ID)[1]', 'int'),
                   x.value('(@Akcja)[1]', 'int'), -- akcja
                   -- EPId
                   x.value('(@SLWId_EP)[1]', 'int'),
                   -- @SLW_ID
                   x.value('(@SLW_ID)[1]', 'int'),
                   -- @SLW_Predefiniowany
                   x.value('(@SLW_Predefiniowany)[1]', 'int'),
                   -- @SLW_Kategoria
                   x.value('(@SLW_Kategoria)[1]', 'varchar(40)'),
                   -- @SLW_WartoscS
                   x.value('(@SLW_WartoscS)[1]', 'varchar(400)'),
                   -- @SLW_WartoscS1
                   x.value('(@SLW_WartoscS1)[1]', 'varchar(512)'),
                   -- @SLW_WartoscS2
                   x.value('(@SLW_WartoscS2)[1]', 'varchar(512)'),
                   -- @SLW_Nazwa
                   x.value('(@SLW_Nazwa)[1]', 'varchar(512)'),
                   -- @SLW_WartoscN1
                   x.value('(@SLW_WartoscN1)[1]', 'decimal(15,4)'),
                   -- @SLW_WartoscN2
                   x.value('(@SLW_WartoscN2)[1]', 'decimal(15,4)'),
                   -- @SLW_WartoscN3
                   x.value('(@SLW_WartoscN3)[1]', 'decimal(15,4)'),
                   -- @SLW_WartoscN4
                   x.value('(@SLW_WartoscN4)[1]', 'decimal(15,4)'),
                   -- @SLW_WartoscL1
                   x.value('(@SLW_WartoscL1)[1]', 'int'),
                   -- @SLW_WartoscL2
                   x.value('(@SLW_WartoscL2)[1]', 'int'),
                   -- @SLW_Konto
                   x.value('(@SLW_Konto)[1]', 'varchar(40)'),
                   -- @SLW_Aktywny
                   x.value('(@SLW_Aktywny)[1]', 'smallint'),
                   -- @SLW_Domyslny
                   x.value('(@SLW_Domyslny)[1]', 'tinyint'),
                   -- @SLW_OptimaId
                   x.value('(@SLW_OptimaId)[1]', 'int'),
                   -- @SLW_WartoscL3
                   x.value('(@SLW_WartoscL3)[1]', 'int'),
                   -- @SLW_SLSId
                   x.value('(@SLW_SLSId)[1]', 'int'),
                   -- @SLW_CzasModyfikacji
                   x.value('(@SLW_CzasModyfikacji)[1]', 'int'),
                   -- @SLW_Archiwalny
                   x.value('(@SLW_Archiwalny)[1]', 'tinyint')                                                                                                                                                                                       
            FROM   @xml.nodes('/Slowniki/Itms/Itm') AS e(x);
    SET @syncedId = (SELECT TOP 1 [XL_MaxSyncedId]
                     FROM   [CDN].[XL_SyncStatus]
                     WHERE  [NazwaTabeli] = 'Slowniki');
    OPEN SLW_records;
    FETCH NEXT FROM SLW_records INTO @syncId, @akcja, @SLWId_EP,@SLW_ID,@SLW_Predefiniowany,@SLW_Kategoria,@SLW_WartoscS,@SLW_WartoscS1,@SLW_WartoscS2,@SLW_Nazwa,@SLW_WartoscN1, @SLW_WartoscN2,
	@SLW_WartoscN3, @SLW_WartoscN4, @SLW_WartoscL1, @SLW_WartoscL2, @SLW_Konto, @SLW_Aktywny,@SLW_OptimaId, @SLW_WartoscL3,@SLW_SLSId,@SLW_CzasModyfikacji, @SLW_Archiwalny  
    ;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @syncId &gt; @syncedId
                BEGIN
                   
                    IF @akcja = 1
                       AND @SLW_Id IS NOT NULL
                        BEGIN                           
                                   INSERT INTO [CDN].[Slowniki] (
                                            [SLW_Predefiniowany]
										   ,[SLW_Kategoria]
										   ,[SLW_WartoscS]
										   ,[SLW_WartoscS1]
										   ,[SLW_WartoscS2]
										   ,[SLW_Nazwa]
										   ,[SLW_WartoscN1]
										   ,[SLW_WartoscN2]
										   ,[SLW_WartoscN3]
										   ,[SLW_WartoscN4]
										   ,[SLW_WartoscL1]
										   ,[SLW_WartoscL2]
										   ,[SLW_Konto]
										   ,[SLW_Aktywny]
										   ,[SLW_Domyslny]
										   ,[SLW_OptimaId]
										   ,[SLW_WartoscL3]
										   ,[SLW_SLSId]
										   ,[SLW_CzasModyfikacji]
										   ,[SLW_Archiwalny]
										   )										   
                                    SELECT 
                                           @SLW_Predefiniowany,
                                           @SLW_Kategoria,
                                           @SLW_WartoscS,
                                           @SLW_WartoscS1,
                                           @SLW_WartoscS2,
                                           @SLW_Nazwa,
                                           @SLW_WartoscN1,
                                           @SLW_WartoscN2,
                                           @SLW_WartoscN3,
                                           @SLW_WartoscN4,
                                           @SLW_WartoscL1,
                                           @SLW_WartoscL2,
                                           @SLW_Konto,
                                           @SLW_Aktywny,
                                           @SLW_Domyslny,
                                           @SLW_OptimaId,
                                           @SLW_WartoscL3,
                                           @SLW_SLSId,
                                           @SLW_CzasModyfikacji,
                                           @SLW_Archiwalny                                                                                                                                                    ;                                                                 
                                    --uzupelnij mape
                                    INSERT  INTO [CDN].[XL_Slowniki_SyncMap] ([XLId], [EPracownikId])
                                    VALUES                                              (@SLW_Id, @SLWId_EP);
                                --END
                        END
                    ELSE
                        IF @akcja = 2
                           IF @SLW_Id IS NOT NULL
                            BEGIN
                                UPDATE cdn.[Slowniki]
                                SET    [SLW_Predefiniowany]        = @SLW_Predefiniowany,
                                       [SLW_Kategoria]        = @SLW_Kategoria,
                                       [SLW_WartoscS]        = @SLW_WartoscS,
                                       [SLW_WartoscS1]        = @SLW_WartoscS1,
                                       [SLW_WartoscS2]         = @SLW_WartoscS2,
                                       [SLW_Nazwa]    = @SLW_Nazwa,
                                       [SLW_WartoscN1]       = @SLW_WartoscN1, 
                                       [SLW_WartoscN2]     = @SLW_WartoscN2,
                                       [SLW_WartoscN3]      = @SLW_WartoscN3,
                                       [SLW_WartoscN4]    = @SLW_WartoscN4,
                                       [SLW_WartoscL1]       = @SLW_WartoscL1,
                                       [SLW_WartoscL2]     = @SLW_WartoscL2,
                                       [SLW_Konto]        = @SLW_Konto,
                                       [SLW_Aktywny]        = @SLW_Aktywny,
                                       [SLW_Domyslny] = @SLW_Domyslny,
                                       [SLW_OptimaId]     = @SLW_OptimaId,
                                       [SLW_WartoscL3]     = @SLW_WartoscL3,
                                       [SLW_SLSId] = @SLW_SLSId,
                                       [SLW_CzasModyfikacji] = @SLW_CzasModyfikacji,
                                       [SLW_Archiwalny] = @SLW_Archiwalny                                       
                                WHERE  [Slw_Id] = @Slw_Id;
                            END
                        ELSE
                            IF @akcja = 3
                               AND @Slw_Id IS NOT NULL
                                BEGIN
                                    DELETE cdn.[Slowniki]
                                    WHERE  [Slw_Id] = @Slw_Id;
                                    -- usun wpis z mapy
                                    DELETE [CDN].[XL_Slowniki_SyncMap]
                                    WHERE  [XLId] = @Slw_Id;
                                END
                    UPDATE [CDN].[XL_SyncStatus]
                    SET    [XL_MaxSyncedId] = @syncId
                    WHERE  [NazwaTabeli] = 'Slowniki';
                END
            FETCH NEXT FROM SLW_records INTO @syncId, @akcja, @SLWId_EP,@SLW_ID,@SLW_Predefiniowany,@SLW_Kategoria,@SLW_WartoscS,@SLW_WartoscS1,@SLW_WartoscS2,@SLW_Nazwa,@SLW_WartoscN1, @SLW_WartoscN2,
			@SLW_WartoscN3, @SLW_WartoscN4, @SLW_WartoscL1, @SLW_WartoscL2, @SLW_Konto, @SLW_Aktywny,@SLW_OptimaId, @SLW_WartoscL3,@SLW_SLSId,@SLW_CzasModyfikacji, @SLW_Archiwalny;
        END
    CLOSE SLW_records;
    DEALLOCATE SLW_records;
    
    
    ----SlownikiStruktura    
    DECLARE             
              @SLSId_EP AS INT,
			  @SLS_Id  AS INT,
			  @SLS_Predefiniowany AS INT,
			  @SLS_OId AS INT,
			  @SLS_Lp AS INT,
			  @SLS_Nazwa AS VARCHAR(40),
			  @SLS_WartoscL1 AS INT;			  			  
			  			                                    
    DECLARE SLS_records CURSOR LOCAL FAST_FORWARD READ_ONLY
        FOR SELECT x.value('(@Sync_ID)[1]', 'int'),
                   x.value('(@Akcja)[1]', 'int'), -- akcja
                   -- EPId
                   x.value('(@SLSId_EP)[1]', 'int'),
                   -- @SLS_ID
                   x.value('(@SLS_ID)[1]', 'int'),
                   -- @SLS_Predefiniowany
                   x.value('(@SLS_Predefiniowany)[1]', 'int'),
                   -- @SLS_OId
                   x.value('(@SLS_OId)[1]', 'int'),
                   -- @SLS_Lp
                   x.value('(@SLS_Lp)[1]', 'int'),
                   -- @SLS_Nazwa
                   x.value('(@SLS_Nazwa)[1]', 'varchar(40)'),
                   -- @SLS_WartoscL1
                   x.value('(@SLS_WartoscL1)[1]', 'int')                                                                                                                                                                                                                                                          
            FROM   @xml.nodes('/SlownikiStruktura/Itms/Itm') AS e(x);
    SET @syncedId = (SELECT TOP 1 [XL_MaxSyncedId]
                     FROM   [CDN].[XL_SyncStatus]
                     WHERE  [NazwaTabeli] = 'SlownikiStruktura');
    OPEN SLS_records;
    FETCH NEXT FROM SLS_records INTO @syncId, @akcja, @SLSId_EP,@SLS_ID,@SLS_Predefiniowany,@SLS_OId,@SLS_Lp,@SLS_Nazwa,@SLS_WartoscL1
    ;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @syncId &gt; @syncedId
                BEGIN
                   
                    IF @akcja = 1
                       AND @SLS_Id IS NOT NULL
                        BEGIN                           
                                   INSERT INTO [CDN].[SlownikiStruktura] (
                                            [SLS_Predefiniowany]
                                            ,[SLS_OId]
                                            ,[SLS_Lp]
                                            ,[SLS_Nazwa]
                                            ,[SLS_WartoscL1]										   
										   )										   
                                    SELECT 
                                           @SLS_Predefiniowany,
                                           @SLS_OId,
                                           @SLS_Lp,
                                           @SLS_Nazwa,
                                           @SLS_WartoscL1
                                           ;                                           
                                    --uzupelnij mape
                                    INSERT  INTO [CDN].[XL_SlownikiStruktura_SyncMap] ([XLId], [EPracownikId])
                                    VALUES                                              (@SLS_Id, @SLSId_EP);
                                --END
                        END
                    ELSE
                        IF @akcja = 2
                           IF @SLS_Id IS NOT NULL
                            BEGIN
                                UPDATE cdn.[SlownikiStruktura]
                                SET    [SLS_Predefiniowany]        = @SLS_Predefiniowany,
                                       [SLS_OId] = @SLS_OId,
                                       [SLS_Lp] = @SLS_Lp,
                                       [SLS_Nazwa] = @SLS_Nazwa,
                                       [SLS_WartoscL1] = @SLS_WartoscL1
                                                                                                   
                                WHERE  [Sls_Id] = @Sls_Id;
                            END
                        ELSE
                            IF @akcja = 3
                               AND @Sls_Id IS NOT NULL
                                BEGIN
                                    DELETE cdn.[SlownikiStruktura]
                                    WHERE  [Sls_Id] = @Sls_Id;
                                    -- usun wpis z mapy
                                    DELETE [CDN].[XL_SlownikiStruktura_SyncMap]
                                    WHERE  [XLId] = @Sls_Id;
                                END
                    UPDATE [CDN].[XL_SyncStatus]
                    SET    [XL_MaxSyncedId] = @syncId
                    WHERE  [NazwaTabeli] = 'SlownikiStruktura';
                END
            FETCH NEXT FROM SLS_records INTO @syncId, @akcja, @SLSId_EP,@SLS_ID,@SLS_Predefiniowany,@SLS_OId,@SLS_Lp,@SLS_Nazwa,@SLS_WartoscL1;
        END
    CLOSE SLS_records;
    DEALLOCATE SLS_records;
    
        
                     
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="XL_EksportujKonfiguracje"></A><PRE>
          <FONT SIZE="2"><I>/* XL_EksportujKonfiguracje */</I><BR>
CREATE PROCEDURE CDN.XL_EksportujKonfiguracje

AS
BEGIN
    DECLARE @xml AS XML;
    SET @xml = (SELECT (SELECT [Kon_Numer] AS [@Kon_Numer],
                               [Kon_Lp] AS [@Kon_Lp],
                               [Kon_System] AS [@Kon_System],
                               [Kon_Status] AS [@Kon_Status],
                               [Kon_Wartosc] AS [@Kon_Wartosc],
                               [Kon_Komentarz] AS [@Kon_Komentarz],
                               [Kon_Archiwalny] AS [@Kon_Archiwalny],
                               [Kon_CzasModyfikacji] AS [@Kon_CzasModyfikacji],
                               [Kon_Pozycja] AS [@Kon_Pozycja]
                        FROM   cdn.[Konfig]
                        WHERE  [Kon_Numer] IN (992, 7201, 20129, 7029)
                        FOR    XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                FOR    XML PATH ('Konfig'));
    SELECT CAST(@xml AS NVARCHAR(MAX));
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XL_ImportujSyncStatus]"></A><PRE>
          <FONT SIZE="2"><I>/* [XL_ImportujSyncStatus] */</I><BR>
CREATE PROCEDURE [CDN].[XL_ImportujSyncStatus]
@xml XML
AS
BEGIN
    UPDATE [CDN].[XL_SyncStatus]
    SET    [EP_MaxMapaId]     = [SS].[EP_MaxMapaId],
           [EP_MaxSyncedId]   = [SS].[EP_MaxSyncedId],
           [EP_MaxFullSyncId] = [SS].[EP_MaxFullSyncId]
    FROM   [CDN].[XL_SyncStatus] AS S
           INNER JOIN
           (SELECT x.value('(@NazwaTabeli)[1]', 'nvarchar(max)') AS NazwaTabeli,
                   x.value('(@EP_MaxMapaId)[1]', 'int') AS EP_MaxMapaId,
                   x.value('(@EP_MaxSyncedId)[1]', 'int') AS EP_MaxSyncedId,
                   x.value('(@EP_MaxFullSyncId)[1]', 'int') AS EP_MaxFullSyncId
            FROM   @xml.nodes('/XL_SyncStatus/Itms/Itm') AS e(x)) AS SS
           ON [S].[NazwaTabeli] = [SS].[NazwaTabeli];
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XL_EksportujSyncStatus]"></A><PRE>
          <FONT SIZE="2"><I>/* [XL_EksportujSyncStatus] */</I><BR>
CREATE PROCEDURE [CDN].[XL_EksportujSyncStatus]

AS
BEGIN
    DECLARE @xml AS XML;
    SET @xml = (SELECT (SELECT [NazwaTabeli] AS [@NazwaTabeli],
                               [XL_MaxMapaId] AS [@XL_MaxMapaId],
                               [XL_MaxSyncedId] AS [@XL_MaxSyncedId]
                        FROM   [CDN].[XL_SyncStatus]
                        FOR    XML PATH ('Itm'), ROOT ('Itms'), TYPE)
                FOR    XML PATH ('XL_SyncStatus'));
    SELECT CAST(@xml AS NVARCHAR(MAX));
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XL_ImportujFragmentMapy]"></A><PRE>
          <FONT SIZE="2"><I>/* [XL_ImportujFragmentMapy] */</I><BR>
CREATE PROCEDURE [CDN].[XL_ImportujFragmentMapy]
@xml XML
AS
BEGIN
    DECLARE @syncId AS INT, 
            @xlId AS INT, 
            @epracownikId AS INT;
    DISABLE TRIGGER CDN.[EP_SyncFramework_XL_Delegacje_SyncMap]
        ON [CDN].[XL_Delegacje_SyncMap];
    DISABLE TRIGGER CDN.[EP_SyncFramework_XL_Samochody_SyncMap]
        ON [CDN].[XL_Samochody_SyncMap];
    DISABLE TRIGGER CDN.[EP_SyncFramework_XL_Slowniki_SyncMap]
        ON CDN.[XL_Slowniki_SyncMap];
    DISABLE TRIGGER CDN.[EP_SyncFramework_XL_SlownikiStruktura_SyncMap]
        ON [CDN].[XL_SlownikiStruktura_SyncMap];
    -- slowniki  
    IF (SELECT @xml.exist('(/SlownikiMapa/Itms)')) = 1
        BEGIN
            INSERT INTO [CDN].[XL_Slowniki_SyncMap] ([XlId], [EPracownikId])
            SELECT x.value('(@XLId)[1]', 'int'),
                   x.value('(@EPracownikId)[1]', 'int')
            FROM   @xml.nodes('/SlownikiMapa/Itms/Itm') AS e(x);
            UPDATE [CDN].[XL_SyncStatus]
            SET    [XL_MaxMapaId] = (SELECT MAX(x.value('(@Sync_ID)[1]', 'int')) AS id
                                     FROM   @xml.nodes('/SlownikiMapa/Itms/Itm') AS e(x))
            WHERE  [NazwaTabeli] = 'Slowniki';
        END
    -- slowniki struktura
    IF (SELECT @xml.exist('(/SlownikiStrukturaMapa/Itms)')) = 1
        BEGIN
            INSERT INTO [CDN].[XL_SlownikiStruktura_SyncMap] ([XLId], [EPracownikId])
            SELECT x.value('(@XLId)[1]', 'int'),
                   x.value('(@EPracownikId)[1]', 'int')
            FROM   @xml.nodes('/SlownikiStrukturaMapa/Itms/Itm') AS e(x);
            UPDATE [CDN].[XL_SyncStatus]
            SET    [XL_MaxMapaId] = (SELECT MAX(x.value('(@Sync_ID)[1]', 'int')) AS id
                                     FROM   @xml.nodes('/SlownikiStrukturaMapa/Itms/Itm') AS e(x))
            WHERE  [NazwaTabeli] = 'SlownikiStruktura';
        END
    -- Samochody
    IF (SELECT @xml.exist('(/SamochodyMapa/Itms)')) = 1
        BEGIN
            INSERT INTO [CDN].[XL_Samochody_SyncMap] ([XLId], [EPracownikId])
            SELECT x.value('(@XLId)[1]', 'int'),
                   x.value('(@EPracownikId)[1]', 'int')
            FROM   @xml.nodes('/SamochodyMapa/Itms/Itm') AS e(x);
            UPDATE [CDN].[XL_SyncStatus]
            SET    [XL_MaxMapaId] = (SELECT MAX(x.value('(@Sync_ID)[1]', 'int')) AS id
                                     FROM   @xml.nodes('/SamochodyMapa/Itms/Itm') AS e(x))
            WHERE  [NazwaTabeli] = 'Samochody';
        END
    -- delegacje
    IF (SELECT @xml.exist('(/DelegacjeMapa/Itms)')) = 1
        BEGIN
            INSERT INTO [CDN].[XL_Delegacje_SyncMap] ([XLId], [EPracownikId])
            SELECT x.value('(@XLId)[1]', 'int'),
                   x.value('(@EPracownikId)[1]', 'int')
            FROM   @xml.nodes('/DelegacjeMapa/Itms/Itm') AS e(x);
            UPDATE [CDN].[XL_SyncStatus]
            SET    [XL_MaxMapaId] = (SELECT MAX(x.value('(@Sync_ID)[1]', 'int')) AS id
                                     FROM   @xml.nodes('/DelegacjeMapa/Itms/Itm') AS e(x))
            WHERE  [NazwaTabeli] = 'Delegacje';
        END
    EXECUTE ('
    ENABLE TRIGGER CDN.[EP_SyncFramework_XL_Delegacje_SyncMap]
        ON [CDN].[XL_Delegacje_SyncMap];
    ENABLE TRIGGER CDN.[EP_SyncFramework_XL_Samochody_SyncMap]
        ON [CDN].[XL_Samochody_SyncMap];
    ENABLE TRIGGER CDN.[EP_SyncFramework_XL_Slowniki_SyncMap]
        ON CDN.[XL_Slowniki_SyncMap];
    ENABLE TRIGGER CDN.[EP_SyncFramework_XL_SlownikiStruktura_SyncMap]
        ON [CDN].[XL_SlownikiStruktura_SyncMap];
   ');
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XL_ResetujSynchronizacje]"></A><PRE>
          <FONT SIZE="2"><I>/* [XL_ResetujSynchronizacje] */</I><BR>
CREATE PROCEDURE CDN.[XL_ResetujSynchronizacje]

AS
BEGIN
    -- resetuj syncstatus
    UPDATE CDN.[XL_SyncStatus]
    SET    [EP_MaxFullSyncId] = 0,
           [EP_MaxMapaId]     = 0,
           [EP_MaxSyncedId]   = 0,
           [XL_MaxMapaId]     = 0,
           [XL_MaxSyncedId]   = 0;
    -- resetuj mapy
    DISABLE TRIGGER CDN.EP_SyncFramework_XL_Delegacje_SyncMap
        ON CDN.XL_Delegacje_SyncMap;
    DISABLE TRIGGER CDN.EP_SyncFramework_XL_Slowniki_SyncMap
        ON CDN.XL_Slowniki_SyncMap;
    DISABLE TRIGGER CDN.EP_SyncFramework_XL_SlownikiStruktura_SyncMap
        ON CDN.XL_SlownikiStruktura_SyncMap;
    DISABLE TRIGGER CDN.EP_SyncFramework_XL_Samochody_SyncMap
        ON CDN.XL_Samochody_SyncMap;
    DELETE CDN.XL_Delegacje_SyncMap;
    DELETE CDN.XL_Delegacje_SyncMapDiff;
    DELETE CDN.XL_Delegacje;
    DELETE CDN.XL_Samochody_SyncMap;
    DELETE CDN.XL_Samochody_SyncMapDiff;
    DELETE CDN.XL_Samochody;
    DELETE CDN.XL_Slowniki_SyncMap;
    DELETE CDN.XL_Slowniki_SyncMapDiff;
    DELETE CDN.XL_Slowniki;
    DELETE CDN.XL_SlownikiStruktura_SyncMap;
    DELETE CDN.XL_SlownikiStruktura_SyncMapDiff;
    DELETE CDN.XL_SlownikiStruktura;
    ENABLE TRIGGER CDN.EP_SyncFramework_XL_Delegacje_SyncMap
        ON CDN.XL_Delegacje_SyncMap;
    ENABLE TRIGGER CDN.EP_SyncFramework_XL_Slowniki_SyncMap
        ON CDN.XL_Slowniki_SyncMap;
    ENABLE TRIGGER CDN.EP_SyncFramework_XL_SlownikiStruktura_SyncMap
        ON CDN.XL_SlownikiStruktura_SyncMap;
    ENABLE TRIGGER CDN.EP_SyncFramework_XL_Samochody_SyncMap
        ON CDN.XL_Samochody_SyncMap;
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>