<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="[ProdPlanyMaterialyListaDlaRekomendacji]"></A><PRE>
          <FONT SIZE="2"><I>/* [ProdPlanyMaterialyListaDlaRekomendacji] */</I><BR>
CREATE PROCEDURE [CDN].[ProdPlanyMaterialyListaDlaRekomendacji] (
        @p_PPPIds CDN.NumerTableType READONLY,
        @p_FiltrWewnetrzny VARCHAR(2000),
        @p_Jezyk VARCHAR(2)='PL',
        @p_PrzeliczenieRodzaj INT,
        @p_RodzajMat INT = 0,
        @p_TylkoBraki int = 0
) AS
BEGIN
	CREATE TABLE #ProdPlanyMaterialyListaRek (
		PPT_Id int,
		IloscBrak decimal(17,4),
		Zwiazane  decimal(17,4),
	)

    DECLARE @PrzeliczenieRodzajFiltr VARCHAR(200)
    SELECT @PrzeliczenieRodzajFiltr =
        CASE
        WHEN @p_PrzeliczenieRodzaj=4 THEN
        'BETWEEN PPT_OkresMRPOd AND PPT_OkresMRPDo'
        ELSE '= PPT.PPT_Termin'
        END
    DECLARE @SlowoWszystkie VARCHAR(200)
    SELECT @SlowoWszystkie =
        CASE
        WHEN @p_Jezyk='PL' THEN
        '&lt;Wszystkie&gt;'
        ELSE '&lt;ALL&gt;'
        END
    DECLARE @RodzajMatFiltr VARCHAR(200)
    SELECT @RodzajMatFiltr =
        CASE
        WHEN @p_RodzajMat=0 THEN
        '1=1 OR '
        ELSE ''
        END +  ' Id '+
        CASE
        WHEN @p_RodzajMat=2 THEN
        ' '
        ELSE 'NOT'
		END
    DECLARE @GrupowaniePoTerminieFiltr VARCHAR(200)
    SELECT @GrupowaniePoTerminieFiltr =
        CASE
        WHEN @p_PrzeliczenieRodzaj=4 THEN
        ''
        ELSE 'PPT_Termin,'
        END
    DECLARE @BrakiHaving VARCHAR(200)
    SELECT @BrakiHaving =
        CASE
        WHEN @p_TylkoBraki&lt;&gt;0 THEN
            ' HAVING SUM(PPT_IloscPotrzeba)-SUM(PPT_DoWykorzystania)-SUM(PPT_IloscZrealizowana)&gt;0 '
        ELSE ' '
        END
    DECLARE @BrakiZamienniki VARCHAR(200)
    SELECT @BrakiZamienniki =
        CASE WHEN @p_TylkoBraki &lt;&gt; 0 THEN
            ' AND PPT_IloscPotrzeba-PPT_DoWykorzystania-PPT_IloscZrealizowana&gt;0'
        ELSE ''
        END

    DECLARE @ZapytanieSQL VARCHAR(max)

   CREATE TABLE #MaterialyPPRek(
        PPT_Id int NOT NULL,
        PPT_PPPId int,
        PPT_TwrNumer int,
        PPT_Termin int,
        PPT_IloscPotrzeba decimal(15, 4) ,
        PPT_IloscOgolnieDostepna decimal(15, 4) ,
        PPT_IloscWDrodze decimal(15, 4) ,
        PPT_IloscWszystkiePotrzeby decimal(15, 4) ,
        PPT_IloscZrealizowana decimal(15, 4) ,
        PPT_CzynnoscId int ,
        PPT_MagNumer int ,
        PPT_DoZamowienia decimal(15, 4) ,
        PPT_ZapasBezpieczenstwa decimal(15, 4) ,
        PPT_EOQ decimal(15, 4) ,
        PPT_Wielokrotnosc decimal(15, 4) ,
        PPT_Zaokraglenie decimal(15, 4) ,
        PPT_CzasDostawy int ,
        PPT_OkresMRPOd int ,
        PPT_OkresMRPDo int ,
        PPT_RodzicId int ,
        PPT_ZamiennikTowaru int ,
        PPT_TerminZamowienia int ,
        PPT_Rodzaj tinyint ,
        PPT_DoWykorzystania decimal(15, 4),
                PPT_IloscLogWolna DECIMAL(20,4),
                PPT_IloscLogZajeta DECIMAL(20,4)
         CONSTRAINT PPT_Primary PRIMARY KEY CLUSTERED
        (
            PPT_Id ASC
        )
        )

     INSERT INTO #MaterialyPPRek (PPT_Id, PPT_PPPId, PPT_TwrNumer, PPT_Termin, PPT_IloscPotrzeba, PPT_IloscOgolnieDostepna, PPT_IloscWDrodze, PPT_IloscWszystkiePotrzeby,
             PPT_IloscZrealizowana, PPT_CzynnoscId, PPT_MagNumer, PPT_DoZamowienia, PPT_ZapasBezpieczenstwa, PPT_EOQ, PPT_Wielokrotnosc, PPT_Zaokraglenie,
             PPT_CzasDostawy, PPT_OkresMRPOd, PPT_OkresMRPDo, PPT_RodzicId, PPT_ZamiennikTowaru, PPT_TerminZamowienia, PPT_Rodzaj, PPT_DoWykorzystania,
                                             PPT_IloscLogWolna, PPT_IloscLogZajeta)
         SELECT PPT_Id, PPT_PPPId, PPT_TwrNumer, PPT_Termin, PPT_IloscPotrzeba, PPT_IloscOgolnieDostepna, PPT_IloscWDrodze, PPT_IloscWszystkiePotrzeby, PPT_IloscZrealizowana,
             PPT_CzynnoscId, PPT_MagNumer, PPT_DoZamowienia, PPT_ZapasBezpieczenstwa, PPT_EOQ, PPT_Wielokrotnosc, PPT_Zaokraglenie, PPT_CzasDostawy, PPT_OkresMRPOd,
             PPT_OkresMRPDo, PPT_RodzicId, PPT_ZamiennikTowaru, PPT_TerminZamowienia, PPT_Rodzaj, PPT_DoWykorzystania, PPT_IloscLogWolna, PPT_IloscLogZajeta
         FROM CDN.ProdPlanyMaterialy 
			JOIN @p_PPPIds ON PPT_PPPId = Numer

    SELECT @ZapytanieSQL = '
        WITH Org(PPTId,
            CzyZamiennik,
            RodzicId,
            Poziom,
            PoziomDlaZamiennika,
            Sort)
        AS (
            SELECT PPT_Id,
                PPT_ZamiennikTowaru,
                PPT_RodzicId,
                0 Poziom,
                CASE
                    WHEN isnull(PPT_ZamiennikTowaru, 0) = 0 THEN 0
                    ELSE 1
                END PoziomDlaZamiennika,
                CAST(PPT_Id AS VARCHAR(8000)) Sort
            FROM #MaterialyPPRek PPT
            WHERE PPT_RodzicId = 0' + @BrakiZamienniki + '
            UNION ALL
            SELECT PPT.PPT_Id,
                PPT.PPT_ZamiennikTowaru,
                PPT.PPT_RodzicId,
                Org.Poziom + 1 Poziom,
                Org.PoziomDlaZamiennika + CASE
                    WHEN isnull(PPT_ZamiennikTowaru, 0) = 0 THEN 0
                    ELSE 1
                END PoziomDlaZamiennika,
                CAST(Sort+CASE
                    WHEN isnull(PPT_ZamiennikTowaru, 0) = 0 THEN '' :''
                    ELSE '' : ''
                END + CAST(PPT.PPT_Id AS VARCHAR(8000)) AS VARCHAR(8000)) Sort
            FROM #MaterialyPPRek PPT
                JOIN Org ON PPT_RodzicId IN(Org.PPTId)
            WHERE 1 = 1 ' + @BrakiZamienniki + '),
        CTEPolprodukty
        AS (
            SELECT PPT.PPT_Id
            FROM #MaterialyPPRek PPT
            WHERE PPT.PPT_ZamiennikTowaru = 0
                AND EXISTS
                (
                    SELECT *
                    FROM #MaterialyPPRek PPTe
                    WHERE PPTe.PPT_RodzicId = PPT.PPT_Id
                    AND PPTe.PPT_ZamiennikTowaru = 0
                )
            UNION ALL
            SELECT PPT.PPT_Id
            FROM #MaterialyPPRek PPT
                JOIN CTEPolprodukty ctep ON PPT.PPT_ZamiennikTowaru &lt;&gt; 0
                    AND PPT.PPT_RodzicId = ctep.PPT_Id),
        CTEFiltr(Id)
        AS (
            SELECT PPT_Id
            FROM #MaterialyPPRek
                INNER JOIN CDN.TwrKarty ON PPT_TwrNumer = Twr_GIDNumer
                LEFT JOIN CDN.Magazyny ON MAG_GIDNumer = PPT_MAGNumer
                LEFT JOIN CDN.ProdCzynnosci ON PPT_CzynnoscId = PCZ_Id
                LEFT JOIN CDN.ProdTechnologiaZasoby ON PTZ_TechnologiaCzynnosc = PCZ_TechnologiaCzynnosc
                    AND Twr_Kod = PTZ_Kod
             WHERE 1=1 '+@p_FiltrWewnetrzny+'
            UNION ALL
            SELECT PPT_Id
            FROM #MaterialyPPRek
                JOIN CTEFiltr ON Id = PPT_RodzicId
            WHERE PPT_ZamiennikTowaru &lt;&gt; 0)
     INSERT INTO #ProdPlanyMaterialyListaRek
     SELECT
        PPT_Id,
        SUM(PPT_IloscPotrzeba) over(partition by Twr_Kod,
			Twr_Nazwa,
			'+@GrupowaniePoTerminieFiltr+'
			PPT_IloscOgolnieDostepna,
			PPT_IloscWDrodze,
			PPT_TwrNumer,
			CASE
				WHEN MAG_Kod IS NULL THEN '''+@SlowoWszystkie+'''
				ELSE MAG_Kod
			END,
			PPT_ZamiennikTowaru,
			Org.PoziomDlaZamiennika,
			PPT_CzasDostawy,
			PPT_Zaokraglenie,
			PPT_EOQ,
			PPT_Wielokrotnosc,
			PPT_ZapasBezpieczenstwa,
			PPT_OkresMRPOd,
			PPT_OkresMRPDo,
			PPT_MagNumer,
			PPT_TerminZamowienia,
			PPT_Rodzaj,
			Twr_Jm,
			PPT_IloscLogWolna,
			PPT_IloscLogZajeta
			'+@BrakiHaving+')- SUM(PPT_DoWykorzystania) over(partition by Twr_Kod,
			Twr_Nazwa,
			'+@GrupowaniePoTerminieFiltr+'
			PPT_IloscOgolnieDostepna,
			PPT_IloscWDrodze,
			PPT_TwrNumer,
			CASE
				WHEN MAG_Kod IS NULL THEN '''+@SlowoWszystkie+'''
				ELSE MAG_Kod
			END,
			PPT_ZamiennikTowaru,
			Org.PoziomDlaZamiennika,
			PPT_CzasDostawy,
			PPT_Zaokraglenie,
			PPT_EOQ,
			PPT_Wielokrotnosc,
			PPT_ZapasBezpieczenstwa,
			PPT_OkresMRPOd,
			PPT_OkresMRPDo,
			PPT_MagNumer,
			PPT_TerminZamowienia,
			PPT_Rodzaj,
			Twr_Jm,
			PPT_IloscLogWolna,
			PPT_IloscLogZajeta
			'+@BrakiHaving+') - SUM(PPT_IloscZrealizowana) over(partition by Twr_Kod,
			Twr_Nazwa,
			'+@GrupowaniePoTerminieFiltr+'
			PPT_IloscOgolnieDostepna,
			PPT_IloscWDrodze,
			PPT_TwrNumer,
			CASE
				WHEN MAG_Kod IS NULL THEN '''+@SlowoWszystkie+'''
				ELSE MAG_Kod
			END,
			PPT_ZamiennikTowaru,
			Org.PoziomDlaZamiennika,
			PPT_CzasDostawy,
			PPT_Zaokraglenie,
			PPT_EOQ,
			PPT_Wielokrotnosc,
			PPT_ZapasBezpieczenstwa,
			PPT_OkresMRPOd,
			PPT_OkresMRPDo,
			PPT_MagNumer,
			PPT_TerminZamowienia,
			PPT_Rodzaj,
			Twr_Jm,
			PPT_IloscLogWolna,
			PPT_IloscLogZajeta
			'+@BrakiHaving+')  IloscBrak,
		SUM(PPTZ_IloscZwiazana) over(partition by Twr_Kod,PPT_Id,
			Twr_Nazwa,
			'+@GrupowaniePoTerminieFiltr+'
			PPT_IloscOgolnieDostepna,
			PPT_IloscWDrodze,
			PPT_TwrNumer,
			CASE
				WHEN MAG_Kod IS NULL THEN '''+@SlowoWszystkie+'''
				ELSE MAG_Kod
			END,
			PPT_ZamiennikTowaru,
			Org.PoziomDlaZamiennika,
			PPT_CzasDostawy,
			PPT_Zaokraglenie,
			PPT_EOQ,
			PPT_Wielokrotnosc,
			PPT_ZapasBezpieczenstwa,
			PPT_OkresMRPOd,
			PPT_OkresMRPDo,
			PPT_MagNumer,
			PPT_TerminZamowienia,
			PPT_Rodzaj,
			Twr_Jm,
			PPT_IloscLogWolna,
			PPT_IloscLogZajeta
			'+@BrakiHaving+') Zwiazane
    FROM Org
        JOIN
        (
            SELECT DISTINCT
                   *
            FROM CTEFiltr
        ) CTEFiltr ON CTEFiltr.Id = Org.PPTId
        JOIN #MaterialyPPRek PPT ON Org.PPTId = PPT.PPT_Id
        INNER JOIN CDN.TwrKarty ON PPT_TwrNumer = Twr_GIDNumer
        LEFT JOIN CDN.Magazyny ON MAG_GIDNumer = PPT_MAGNumer
		LEFT JOIN cdn.ProdPlanyMaterialyGrupy ON PPTG_PPTId = PPT.PPT_Id
		LEFT JOIN cdn.ProdPlanyMaterialyDoZamowienia ON PPTZ_PPTGId = PPTG_Id
    WHERE '+@RodzajMatFiltr+' IN
    (
        SELECT ctep.PPT_Id
        FROM CTEPolprodukty ctep
    );'
      EXEC(@ZapytanieSQL);

    Select * from #ProdPlanyMaterialyListaRek

    DROP TABLE #ProdPlanyMaterialyListaRek
    DROP TABLE #MaterialyPPRek

   RETURN

END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XLNowaRekomendacjaMRP]"></A><PRE>
          <FONT SIZE="2"><I>/* [XLNowaRekomendacjaMRP] */</I><BR>
CREATE PROCEDURE [CDN].[XLNowaRekomendacjaMRP]
(  
/* ==========================================================================================
        SQL API: Procedura serwerowa do dodawania rekomendacji MRP 

        Dla uproszczenia założono, że jeżeli w systemie zewnętrznym zostanie wystawiona rekomendacja MRP,
        to w trakcie wystawiania jej przez API nie ma potrzeby kontrolowania uprawnień do obiektów, z których ona korzysta

        Parametry wejściowe:
   ========================================================================================== */
		@OpeWystNumer INT, --numer operatora wystawiającego	
        @FrsId INT,                             -- Identyfikator centrum struktury praw (właściciela dokumentu)
        @SesjaID	int, --ID bieżącej sesji
		
		@OpeWystKod NVARCHAR(8)=null, --kod operatora wystawiającego, gdy nie znajdzie po numerze
		@DataCzasWyst INT=NULL, --data i czas wystawienia dokumentu, ilość sekund po 01-01-1990
		
		@OpeModNumer INT=null, --numer operatora modyfikującego
		@OpeModKod NVARCHAR(8)=null, --kod operatora modyfikującego, gdy nie znajdzie po numerze
		@DataCzasMod INT=NULL, --data i czas modyfikacji dokumentu, ilość sekund po 01-01-1990
		
        @IdWzorca INT=NULL,
        @IdPP   INT=NULL,
        @TypDokumentu INT,

        @Numer INT = NULL,                      -- Numer dokumentu
        @Seria NVARCHAR(5)=NULL,					-- Seria dokumentu
        @Rok INT = NULL,                      -- Rok dokumentu
        @Miesiac INT = NULL,                      -- Miesiac dokumentu
        @Opis NVARCHAR(1024)=NULL,				-- Opis
        @URL NVARCHAR(255)=NULL,					-- URL
       
        @Tryb	TINYINT = 0,
        @Komunikat	TINYINT = 0				-- Czy wyswietlac komunikat o bledzie	
/* ==========================================================================================
        Błędy:
        1 : Wystąpił błąd podczas dodawania rekomendacji MRP. Nie powiódł się zapis do tabeli CDN.ProdRekomendacje
        2 : Wystąpił błąd podczas dodawania rekomendacji MRP. Podany operator nie występuje w bazie.
        3 : Wystąpił błąd podczas dodawania rekomendacji MRP. Podane centrum nie występuje w bazie.
        4 : Wystąpił błąd podczas dodawania rekomendacji MRP. Podany plan produkcji nie występuje w bazie.
        5 : Wystąpił błąd podczas dodawania rekomendacji MRP. Dokument o takim numerze już istnieje w bazie.
        6 : Wystąpił błąd podczas dodawania rekomendacji MRP. Nie powiodło się dodawanie wpisu do tabeli CDN.ObiektyObce. 
        7 : Wystąpił błąd podczas dodawania rekomendacji MRP. Typ generowanego dokumentu niezgodny z rodzajem wzorca. 
        8 : Wystąpił błąd podczas dodawania rekomendacji MRP. Brak prawa do wystawienia dokumentu. 
        9 : Wystąpił błąd podczas dodawania rekomendacji MRP. Nie można dodać rekomendacji do zamkniętego planu produkcji.
   ========================================================================================== */
)
AS
BEGIN

    DECLARE @PREId INT
    DECLARE @Wynik INT
    DECLARE @TimeStamp INT
    DECLARE @IDObiektu int
    DECLARE @RekomendacjaOd int
    DECLARE @RekomendacjaDo int
    DECLARE @PPLStan int

    SET @TimeStamp = DATEDIFF(s,'19900101',GETDATE())
    IF @DataCzasWyst IS NULL OR @DataCzasWyst = 0 SET @DataCzasWyst = @TimeStamp
    IF @DataCzasMod IS NULL OR @DataCzasWyst &gt; @DataCzasMod SET @DataCzasMod = @DataCzasWyst
    IF @Miesiac IS NULL SET @Miesiac = 0
	SET NOCOUNT ON	
	--Operator wystawiający 
	SET @OpeWystNumer = COALESCE((SELECT Ope_GIDNumer FROM CDN.OpeKarty WHERE Ope_GIDNumer=@OpeWystNumer),(SELECT Ope_GIDNumer FROM CDN.OpeKarty WHERE Ope_Ident=@OpeWystKod))
	
	IF @OpeWystNumer IS NULL
	BEGIN
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowaRekomendacjaMRP: Wystąpił błąd podczas dodawania rekomendacji MRP. Podany operator nie występuje w bazie.', 16, 1)
		SELECT 2 AS ERROR
		RETURN 2
	END	
	
	--Operator modyfikujący
	SET @OpeModNumer = COALESCE((SELECT Ope_GIDNumer FROM CDN.OpeKarty WHERE Ope_GIDNumer=@OpeModNumer),(SELECT Ope_GIDNumer FROM CDN.OpeKarty WHERE Ope_Ident=@OpeModKod),@OpeWystNumer)	
	IF @OpeModNumer IS NULL
	BEGIN
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowaRekomendacjaMRP: Wystąpił błąd podczas dodawania rekomendacji MRP. Podany operator nie występuje w bazie.', 16, 1)
		SELECT 2 AS ERROR
		RETURN 2
	END
				
	--Właściciel		
	SET @FrsId = COALESCE((SELECT Frs_Id FROM CDN.FrmStruktura WHERE FRS_Id=@FrsId),(SELECT Ope_FrSId FROM CDN.OpeKarty WHERE Ope_GIDNumer=@OpeWystNumer))
 
	IF @FrsId IS NULL 
	BEGIN 
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowaRekomendacjaMRP: Wystąpił błąd podczas dodawania rekomendacji MRP. Podane centrum dla właściciela nie istnieje w bazie.', 16, 1)
		SELECT 3 AS ERROR
		RETURN 3
	END	

    --Wzorzec i Typ	
	IF  @TypDokumentu&lt;&gt;(select CASE PREW_Rodzaj WHEN 1 THEN 14363 ELSE 14364 END from cdn.ProdRekomendacjeWzorce where PREW_Id= @IdWzorca) 
	BEGIN 
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowaRekomendacjaMRP: Wystąpił błąd podczas dodawania rekomendacji MRP. Typ generowanego dokumentu niezgodny z rodzajem wzorca.', 16, 1)
		SELECT 7 AS ERROR
		RETURN 7
	END	
    --Prawa z DokDef
	IF  1&lt;&gt;(select ISNULL(Dok_WystPrawo,0) from cdn.DokDefinicje where Dok_GIDTyp=@TypDokumentu AND Dok_FrsId=@FRSId)
	BEGIN 
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowaRekomendacjaMRP: Wystąpił błąd podczas dodawania rekomendacji MRP. Brak prawa do wystawienia dokumentu.', 16, 1)
		SELECT 8 AS ERROR
		RETURN 8
	END	
	
	
	--Numerator dokumentu					
	IF EXISTS(SELECT * FROM CDN.Konfig WHERE kon_numer=992 AND (CHARINDEX('6',Kon_wartosc)&gt;0 OR CHARINDEX('7',Kon_wartosc)&gt;0)) -- czy numeracja z miesiącem
		IF @Miesiac IS NULL OR @Miesiac = 0 SET @Miesiac = MONTH(DATEADD(s,@DataCzasWyst,CONVERT(DATETIME,'19900101',11)))
	ELSE
		SET @Miesiac = 0
		
	IF @Rok IS NULL OR @Rok = 0 SET @Rok = YEAR(DATEADD(s,@DataCzasWyst,CONVERT(DATETIME,'19900101',11)))
	
	--pobieranie serii
	set @Seria=COALESCE(( Select SER_Nazwa FROM CDN.DokDefinicje 
						INNER JOIN CDN.Serie ON SER_GIDTyp = Dok_SerTyp AND SER_GIDNumer = Dok_SerNumer
						WHERE Dok_FrsId = @FrsId AND Dok_GIDTyp = @TypDokumentu AND SER_Nazwa=@Seria),
						(Select SER_Nazwa FROM CDN.DokDefinicje 
						INNER JOIN CDN.Serie ON SER_GIDTyp = Dok_SerTyp AND SER_GIDNumer = Dok_SerNumer
						WHERE Dok_FrsId = @FrsId AND Dok_GIDTyp = @TypDokumentu))
	
	IF ISNULL(@Numer,0)&lt;&gt;0 AND EXISTS(SELECT * FROM CDN.ProdRekomendacje WHERE PRE_Rok=@Rok AND PRE_Miesiac=@Miesiac AND PRE_Seria=@Seria AND PRE_Numer=@Numer AND PRE_Typ=@TypDokumentu)
    BEGIN 
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowaRekomendacjaMRP: Wystąpił błąd podczas dodawania rekomendacji MRP. Dokument o takim numerze już istnieje w bazie.', 16, 1)
		SELECT 5 AS ERROR
		RETURN 5
	END
 

	--Pobranie numeru dokumentu przed samym insertem
	if isnull(@Numer,0)=0
	 select @Numer=isnull(max(PRE_Numer),0)+1 from CDN.ProdRekomendacje with(nolock) WHERE PRE_Seria=@Seria AND PRE_Typ=@TypDokumentu AND PRE_Rok=@Rok AND PRE_Miesiac=@Miesiac


    IF (@IdPP=0 OR @IdPP IS NULL)
    BEGIN
        SET @RekomendacjaOd=0
        SET @RekomendacjaDo=0
        END
    ELSE
    BEGIN
        IF NOT EXISTS(SELECT * FROM CDN.ProdPlany WHERE PPL_Id=@IdPP)
        BEGIN 
    		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowaRekomendacjaMRP: Wystąpił błąd podczas dodawania rekomendacji MRP. Podany plan produkcji nie występuje w bazie.', 16, 1)
    		SELECT 4 AS ERROR
    		RETURN 4
    	END
        SELECT @RekomendacjaOd=PPL_PrzeliczenieOd, @RekomendacjaDo=PPL_PrzeliczenieDo, @PPLStan=PPL_Stan from cdn.ProdPlany WHERE PPL_Id=@IdPP
        IF @PPLStan=3
        BEGIN 
    		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowaRekomendacjaMRP: Wystąpił błąd podczas dodawania rekomendacji MRP. Nie można dodać rekomendacji do zamkniętego planu produkcji.', 16, 1)
    		SELECT 9 AS ERROR
    		RETURN 9
    	END
        
    END


	BEGIN TRAN

	INSERT INTO [CDN].[ProdRekomendacje]
           ([PRE_RekomendacjaOd]
           ,[PRE_RekomendacjaDo]
           ,[PRE_WzorzecId]
           ,[PRE_PPId]
           ,[PRE_TerminRozpoczeciaOd]
           ,[PRE_TerminRozpoczeciaDo]
           ,[PRE_TerminZakonczeniaOd]
           ,[PRE_TerminZakonczeniaDo]
           ,[PRE_TypTowaru]
           ,[PRE_Stan]
           ,[PRE_Numer]
           ,[PRE_Seria]
           ,[PRE_Miesiac]
           ,[PRE_Rok]
           ,[PRE_Typ]
           ,[PRE_OpeWNumer]
           ,[PRE_OpePNumer]
           ,[PRE_OpeMNumer]
           ,[PRE_DataCzasW]
           ,[PRE_DataCzasP]
           ,[PRE_DataCzasM]
           ,[PRE_Url]
           ,[PRE_Opis]
           ,[PRE_Aktywny]
           ,[PRE_FrsId]
           ,[PRE_Archiwalny])
     VALUES
           (@RekomendacjaOd
           ,@RekomendacjaDo
           ,COALESCE(@IdWzorca,(SELECT TOP 1 PREW_Id FROM cdn.ProdRekomendacjeWzorce WHERE PREW_Rodzaj=CASE WHEN @TypDokumentu=14363 THEN 1 ELSE 2 END AND PREW_Domyslny=1 AND PREW_Archiwalny=0),0)
           ,COALESCE(@IdPP,0)
           ,0
           ,0
           ,0
           ,0
           ,0
           ,1
           ,@Numer
           ,@Seria
           ,@Miesiac
           ,@Rok
           ,@TypDokumentu
           ,@OpeWystNumer
           ,0
           ,@OpeModNumer
           ,@DataCzasWyst
           ,0
           ,@DataCzasMod
           ,COALESCE(@Url,'')
           ,COALESCE(@Opis,'')
           ,0
           ,@FrsId
           ,0)


	IF @@ROWCOUNT=0 BEGIN		
		ROLLBACK TRAN					
		IF @Komunikat &lt;&gt; 0 RAISERROR ('XLNowaRekomendacjaMRP: Wystąpił błąd podczas dodawania rekomendacji MRP. Nie powiódł się zapis do tabeli CDN.ProdRekomendacje.', 16, 1)	
		SELECT 1 AS ERROR
		RETURN 1
	END	
	--OK:
	SET @PREId = scope_identity()
				
	IF @Tryb = 1--tylko w trybie wewnetrznym
	BEGIN	
		SELECT @IDObiektu = ISNULL(MAX(OBO_IDObiektu),0)+1 FROM CDN.OBiektyObce WITH (NOLOCK)
		INSERT INTO CDN.ObiektyObce (OBO_IDSesji,OBO_GIDTyp,OBO_GIDFirma,OBO_GIDNumer,OBO_GIDLp,OBO_TSOtwarty,OBO_IdObiektu,OBO_IdAPI) VALUES(@SesjaID,@TypDokumentu,0,@PREId,0,@TimeStamp,@IDObiektu,0)
		IF @@ERROR &lt;&gt; 0
		BEGIN
			ROLLBACK TRAN
			RAISERROR('XLNowaRekomendacjaMRP: Wystąpił błąd podczas dodawania rekomendacji MRP. Nie powiodło się dodawanie wpisu do tabeli CDN.ObiektyObce.',16,1)
			SELECT @Wynik AS ERROR
			RETURN 6
		END
	END
	COMMIT TRAN
        SELECT 0 as Blad, @PREId as PREID

	SET NOCOUNT OFF
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="[XLPrzeliczRekomendacjeMRP]"></A><PRE>
          <FONT SIZE="2"><I>/* [XLPrzeliczRekomendacjeMRP] */</I><BR>
CREATE PROCEDURE [CDN].[XLPrzeliczRekomendacjeMRP]
(
/* ==========================================================================================
        SQL API: Procedura serwerowa do przeliczania rekomendacji MRP 

        Parametry wejściowe:
   ========================================================================================== */
        @PreId INT, -- identyfikator dokumentu rekomendacji
        @SesjaID INT, -- ID bieżącej sesji
        @OpeNumer INT, -- identyfikator operata przeliczajacego
        @OpeKod NVARCHAR(8) = NULL, -- kod operatora przeliczajacego, gdy nie znajdzie po numerze
        @Komunikat TINYINT = 0 -- Czy wyswietlac komunikat o bledzie
/* ==========================================================================================
        Błędy:
        1 : XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Nie znalezionio rekomendacji MRP.
        2 : XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Nie można przeliczyć dokumentu archiwalnego.
        3 : XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Nie znaleziono planu produkcji.
        4 : XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Nie znaleziono wzorca rekomendacji.
        5 : XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Podany operator nie występuje w bazie.
        6 : XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Można przeliczyć tylko rekomendację, z której nie wygenerowano jeszcze dokumentów.
        7 : XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Nie powiodło się usuwanie z tabeli CDN.ProdRekomendacjeProdukty.
        8 : XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Nie można przeliczyć rekomendacji na zamknięty plan produkcji.
   ========================================================================================== */
)
AS
BEGIN
    DECLARE @RekomendacjaId INT
    DECLARE @PREAktywny SMALLINT
    DECLARE @PREArchiwalny SMALLINT
    DECLARE @PPId INT
    DECLARE @WzorzecId INT

	SET NOCOUNT ON	
/* Tworzenie tabel tymczasowych*/
CREATE TABLE #tabProdukty (
    [PPP_Id] [INT] NOT NULL,
    [PPP_TwrNumer] [int] NULL,
	[PPP_Termin] [int] NULL,
	[PPP_TerminDo] [int] NULL,
	[PPP_IloscMPS] [decimal](15, 4) NULL,
	[PPP_IloscRez] [decimal](15, 4) NULL,
	[PPP_IloscDoWykorzystania] [decimal](15, 4) NULL,
	[PPP_IloscOgolnieDostepna] [decimal](15, 4) NULL,
	[PPP_IloscWDrodze] [decimal](15, 4) NULL,
	[PPP_IloscNaZp] [decimal](15, 4) NULL,
	[PPP_IloscZaplanowana] [decimal](15, 4) NULL,
	[PPP_IloscWToku] [decimal](15, 4) NULL,
	[PPP_IloscZrealizowana] [decimal](15, 4) NULL,
	[PPP_IloscDoProdukcji] [decimal](15, 4) NULL,
	[PPP_IloscMinProdukcji] [decimal](15, 4) NULL,
	[PPP_IloscBrakNaMPS] [decimal](15, 4) NULL,
	[PPP_TerminNaZp] [int] NULL,
	[PPP_ZapasBezpieczenstwa] [decimal](15, 4) NULL,
	[PPP_EOQ] [decimal](15, 4) NULL,
	[PPP_Wielokrotnosc] [decimal](15, 4) NULL,
	[PPP_Zaokraglanie] [decimal](15, 4) NULL,
	[PPP_OkresMRPOd] [int] NULL,
	[PPP_OkresMRPDo] [int] NULL,
	[PPP_TerminProdukcji] [int] NULL,
    [PPL_Rok] [smallint] NULL,
	[PPL_Miesiac] [tinyint] NULL,
	[PPL_Seria] [varchar](5) NULL,
	[PPL_Numer] [int] NULL,
    [PPP_DokZrdNumer] [int] NULL,
	[PPP_DokZrdTyp] [smallint] NULL,
    )
CREATE TABLE #tabMaterialy (
    [PPT_Id] [int],
    [PPT_TwrNumer] [int] NULL,
	[PPT_Termin] [int] NULL,
    [PPT_MagNumer] [int] NULL,
	[PPT_IloscPotrzeba] [decimal](15, 4) NULL,
	[PPT_IloscOgolnieDostepna] [decimal](15, 4) NULL,
	[PPT_IloscWDrodze] [decimal](15, 4) NULL,
	[PPT_IloscWszystkiePotrzeby] [decimal](15, 4) NULL,
	[PPT_IloscZrealizowana] [decimal](15, 4) NULL,
	[PPT_DoZamowienia] [decimal](15, 4) NULL,
	[PPT_ZapasBezpieczenstwa] [decimal](15, 4) NULL,
	[PPT_EOQ] [decimal](15, 4) NULL,
	[PPT_Wielokrotnosc] [decimal](15, 4) NULL,
	[PPT_Zaokraglenie] [decimal](15, 4) NULL,
	[PPT_CzasDostawy] [int] NULL,
	[PPT_TerminZamowienia] [int] NULL,
	[PPT_OkresMRPOd] [int] NULL,
	[PPT_OkresMRPDo] [int] NULL
    )


CREATE TABLE #tabWarTwr (
    PREWT_Id INT,
    Typ SMALLINT,
    TwrNumer INT
)    
CREATE TABLE #tabProduktyZWarunkami (
    PREWT_Id INT,
     [PPP_TwrNumer] [int] NULL,
     KntAkronim [varchar](20) NULL,
	KntNazwa [varchar](50) NULL,
    NumerDok VARCHAR(20),
    ProduktNazwa varchar(255),
    ProduktKod varchar(40),
    PPP_Termin int,
	[PPP_TerminDo] [int] NULL,
    PPP_IloscBrakNaMPS  [decimal](15, 4) NULL,
    PPP_IloscRez  [decimal](15, 4) NULL,
    PPP_IloscOgolnieDostepna [decimal](15, 4) NULL,
    PPP_IloscDoWykorzystania [decimal](15, 4) NULL,
    PPP_IloscWDrodze [decimal](15, 4) NULL,
    PPP_IloscNaZp [decimal](15, 4) NULL,
    PPP_TerminNaZp int,
    PPP_IloscDoProdukcji [decimal](15, 4) NULL,
    PPP_IloscMinProdukcji [decimal](15, 4) NULL,
    PPP_ZapasBezpieczenstwa [decimal](15, 4) NULL,
    PPP_EOQ [decimal](15, 4) NULL,
    PPP_Wielokrotnosc [decimal](15, 4) NULL,
    PPP_Zaokraglanie [decimal](15, 4) NULL,
    PPP_IloscZaplanowana [decimal](15, 4) NULL,
    DoZaplanowania [decimal](15, 4) NULL,
    PPP_IloscWToku [decimal](15, 4) NULL,
    PPP_IloscZrealizowana [decimal](15, 4) NULL,
    IloscDoRealizacji [decimal](15, 4) NULL,
    PPP_TerminProdukcji int,
	PPP_Zwiazane [decimal](15, 4) NULL
    )
CREATE TABLE #tabMaterialyZWarunkami (
    PREWT_Id INT,
    [PPT_Id] [int],
    [PPT_TwrNumer] [int] NULL,
	[PPT_Termin] [int] NULL,
    MaterialNazwa varchar(255),
    MaterialKod varchar(40),
    [PPT_MagNumer] [int] NULL,
    MagazynKod [varchar](10) NULL,
	MagazynNazwa [varchar](30) NULL,
    [PPT_IloscPotrzeba] [decimal](15, 4) NULL,
	[PPT_IloscOgolnieDostepna] [decimal](15, 4) NULL,
	[PPT_IloscWDrodze] [decimal](15, 4) NULL,
	[PPT_IloscWszystkiePotrzeby] [decimal](15, 4) NULL,
	[PPT_IloscZrealizowana] [decimal](15, 4) NULL,
	[PPT_DoZamowienia] [decimal](15, 4) NULL,
	[PPT_ZapasBezpieczenstwa] [decimal](15, 4) NULL,
	[PPT_EOQ] [decimal](15, 4) NULL,
	[PPT_Wielokrotnosc] [decimal](15, 4) NULL,
	[PPT_Zaokraglenie] [decimal](15, 4) NULL,
	[PPT_CzasDostawy] [int] NULL,
	[PPT_TerminZamowienia] [int] NULL,
	[PPT_OkresMRPOd] [int] NULL,
	[PPT_OkresMRPDo] [int] NULL
    
    )
CREATE TABLE #tabProdRekomendacjeWzorceWarunki(
	[PREWW_PREWTId] [int] NULL,
	[PREWW_KolumnaPP] [smallint] NULL,
	[PREWW_Operator] [smallint] NULL,
	[PREWW_Wartosc] [varchar](30) NULL
)

/* Sprawdzenie przygotowania dokumentu Rekomendacji do przeliczenia(wskazane PP, wzorzec, prawa etc.)*/
 SELECT @RekomendacjaId = PRE_Id, @PREAktywny = PRE_Aktywny, @PREArchiwalny = PRE_Archiwalny, @PPId=PRE_PPId, @WzorzecId=PRE_WzorzecId
        FROM CDN.ProdRekomendacje
        WHERE PRE_Id = @PreId

    IF @RekomendacjaId IS NULL
        BEGIN
                IF @Komunikat &lt;&gt; 0
                        RAISERROR ('XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Nie znalezionio rekomendacji MRP.', 16, 1)

                SELECT 1 AS ERROR

                RETURN 1
        END
        IF @PREArchiwalny =1
        BEGIN
                IF @Komunikat &lt;&gt; 0
                        RAISERROR ('XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Nie można przeliczyć dokumentu archiwalnego.', 16, 1)

                SELECT 2 AS ERROR

                RETURN 2
        END

        -- IF @PREAktywny != @SesjaID
        -- BEGIN
        --         IF @Komunikat &lt;&gt; 0
        --                 RAISERROR ('XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Podany dokument rekomendacji nie jest aktywny w obecnej sesji.', 16, 1)

        --         SELECT 8 AS ERROR

        --         RETURN 8
        -- END
        IF NOT EXISTS( select * from cdn.ProdPlany where PPL_Id=@PPId )
        BEGIN
                IF @Komunikat &lt;&gt; 0
                        RAISERROR ('XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Nie znaleziono planu produkcji.', 16, 1)

                SELECT 3 AS ERROR

                RETURN 3
        END
        IF NOT EXISTS( select * from cdn.ProdRekomendacjeWzorce where PREW_Id=@WzorzecId )
        BEGIN
                IF @Komunikat &lt;&gt; 0
                        RAISERROR ('XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Nie znaleziono wzorca rekomendacji.', 16, 1)

                SELECT 4 AS ERROR

                RETURN 4
        END
        --Operator przeliczający
        SET @OpeNumer = COALESCE((
                                SELECT Ope_GIDNumer
                                FROM CDN.OpeKarty
                                WHERE Ope_GIDNumer = @OpeNumer
                                ), (
                                SELECT Ope_GIDNumer
                                FROM CDN.OpeKarty
                                WHERE Ope_Ident = @OpeKod
                                ), @OpeNumer)

        IF @OpeNumer IS NULL
        BEGIN
                IF @Komunikat &lt;&gt; 0
                        RAISERROR ('XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Podany operator nie występuje w bazie.', 16, 1)

                SELECT 5 AS ERROR

                RETURN 5
        END

        IF EXISTS(select * from cdn.ProdRekomendacjeDokumenty JOIN cdn.ProdRekomendacjeProdukty ON	PRED_PREPId = PREP_Id where PREP_PREId=@RekomendacjaId)
        BEGIN
                IF @Komunikat &lt;&gt; 0
                        RAISERROR ('XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Można przeliczyć tylko rekomendację, z której nie wygenerowano jeszcze dokumentów.', 16, 1)

                SELECT 6 AS ERROR

                RETURN 6
        END
        IF EXISTS(select * from cdn.ProdPlany JOIN cdn.ProdRekomendacje ON PRE_PPId=PPL_Id	WHERE PRE_Id=@RekomendacjaId AND PPL_Stan=3)
        BEGIN
                IF @Komunikat &lt;&gt; 0
                        RAISERROR ('XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Nie można przeliczyć rekomendacji na zamknięty plan produkcji.', 16, 1)

                SELECT 8 AS ERROR

                RETURN 8
        END
        IF EXISTS (
                    SELECT *
                    FROM CDN.ProdRekomendacjeProdukty
                    WHERE PREP_PREId = @RekomendacjaId
                    )
                BEGIN
                    DELETE
                        FROM CDN.ProdRekomendacjeProdukty
                        WHERE PREP_PREId = @RekomendacjaId
                               

                        IF @@ROWCOUNT = 0
                        BEGIN
                                ROLLBACK TRAN

                                IF @Komunikat &lt;&gt; 0
                                        RAISERROR ('XLPrzeliczRekomendacjeMRP: Wystąpił błąd podczas przeliczania rekomendacji MRP. Nie powiodło się usuwanie z tabeli CDN.ProdRekomendacjeProdukty.', 16, 1)

                                SELECT 7 AS ERROR

                                RETURN 7
                        END
        END
/* Wypełnianie tabel tymczasowych na podstawie PP(z listy produktów,materiałów) - osobne tabele, na podstawie wzorca(rozpisanie grup towarowych) */ 
INSERT INTO #tabProdukty(PPP_TwrNumer,PPP_Termin,PPP_TerminDo,
PPP_IloscMPS,PPP_IloscRez, PPP_IloscDoWykorzystania, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze,
PPP_IloscNaZp, PPP_IloscZaplanowana, PPP_IloscWToku, PPP_IloscZrealizowana, PPP_IloscDoProdukcji,
PPP_IloscMinProdukcji, PPP_IloscBrakNaMPS, PPP_TerminNaZp, PPP_ZapasBezpieczenstwa, PPP_EOQ,
PPP_Wielokrotnosc, PPP_Zaokraglanie, PPP_OkresMRPOd, PPP_OkresMRPDo, PPP_TerminProdukcji,
PPL_Rok, PPL_Miesiac, PPL_Seria, PPL_Numer, PPP_DokZrdTyp,PPP_DokZrdNumer,PPP_ID
)
select PPP_TwrNumer, PPP_Termin, PPP_TerminDo,
PPP_IloscMPS,PPP_IloscRez, PPP_IloscDoWykorzystania, PPP_IloscOgolnieDostepna, PPP_IloscWDrodze,
PPP_IloscNaZp, PPP_IloscZaplanowana, PPP_IloscWToku, PPP_IloscZrealizowana, PPP_IloscDoProdukcji,
PPP_IloscMinProdukcji, PPP_IloscBrakNaMPS, PPP_TerminNaZp, PPP_ZapasBezpieczenstwa, PPP_EOQ,
PPP_Wielokrotnosc, PPP_Zaokraglanie, PPP_OkresMRPOd, PPP_OkresMRPDo, PPP_TerminProdukcji,
PPL_Rok, PPL_Miesiac, PPL_Seria, PPL_Numer, PPP_DokZrdTyp,PPP_DokZrdNumer, PPP_ID
from cdn.ProdPlanyProdukty
join cdn.ProdPlany on PPP_PPLId=PPL_Id
where PPP_PPLId=@PPId

INSERT INTO #tabMaterialy(
    PPT_TwrNumer, PPT_Termin, PPT_MagNumer, PPT_Id,
    PPT_IloscPotrzeba, PPT_IloscOgolnieDostepna, PPT_IloscWDrodze, PPT_IloscWszystkiePotrzeby,
    PPT_IloscZrealizowana, PPT_DoZamowienia, PPT_ZapasBezpieczenstwa, PPT_EOQ,
    PPT_Wielokrotnosc, PPT_Zaokraglenie, PPT_CzasDostawy, PPT_TerminZamowienia,
    PPT_OkresMRPOd,PPT_OkresMRPDo
)
select PPT_TwrNumer, PPT_Termin, PPT_MagNumer, PPT_Id,
    PPT_IloscPotrzeba, PPT_IloscOgolnieDostepna, PPT_IloscWDrodze, PPT_IloscWszystkiePotrzeby,
    PPT_IloscZrealizowana, PPT_DoZamowienia, PPT_ZapasBezpieczenstwa, PPT_EOQ,
    PPT_Wielokrotnosc, PPT_Zaokraglenie, PPT_CzasDostawy, PPT_TerminZamowienia,
    PPT_OkresMRPOd,PPT_OkresMRPDo
 from cdn.ProdPlanyMaterialy
join cdn.ProdPlanyProdukty on PPT_PPPId=PPP_Id
where PPP_PPLId=@PPId


INSERT INTO #tabWarTwr 
select PREWT_Id, PREWT_Typ,PREWT_TWRNumer from cdn.ProdRekomendacjeWzorceWarunkiTwr 
where PREWT_PREWId=@WzorzecId AND PREWT_TWRTyp=16

INSERT INTO #tabWarTwr (PREWT_Id,Typ,TwrNumer)
  select distinct PREWT_Id,PREWT_Typ,Twr_GIDNumer from CDN.TwrKarty
        inner join CDN.TwrGrupy on TwG_GIDNumer = Twr_GIDNumer AND TwG_GIDTyp = Twr_GIDTyp
        join cdn.ProdRekomendacjeWzorceWarunkiTwr on PREWT_PREWId=@WzorzecId AND PREWT_TWRTyp=-16
        Where 
                 TwG_GrONumer IN(
                                                        SELECT GIDNumer FROM CDN.PobierzDrzewoGrupTowarowychKuLisciom(PREWT_TWRNumer,default,null,null,null)
                                                        )
                AND Twr_Typ NOT IN(3,4,6)--wykluczamy a-viste, uslugi i koszty


/* Odfiltrowanie niepasujących towarów(dla każdego towaru przypisanie numeru PREWT:Id - może rozdwoić wiersze - towary(celowe) - jeli towar wchodzi osobno i z grupy/z 2 różnych grup)*/

INSERT INTO #tabProduktyZWarunkami(PREWT_Id,NumerDok, PPP_TwrNumer,
KntAkronim, KntNazwa, ProduktNazwa, ProduktKod, PPP_Termin, PPP_TerminDo,
PPP_IloscBrakNaMPS, PPP_IloscRez, PPP_IloscOgolnieDostepna, PPP_IloscDoWykorzystania,
PPP_IloscWDrodze, PPP_IloscNaZp, PPP_TerminNaZp, PPP_IloscDoProdukcji, PPP_IloscMinProdukcji,
PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, PPP_IloscZaplanowana,
DoZaplanowania,
 PPP_IloscWToku, PPP_IloscZrealizowana,
  IloscDoRealizacji,
   PPP_TerminProdukcji,
PPP_Zwiazane 
)
SELECT twt.PREWT_Id,ISNULL(cdn.NumerDokumentu(CDN.DokMapTypDokumentu(ISNULL(ZaN_GIDTyp,PPP_DokZrdTyp),ISNULL(ZaN_ZamTyp,0),ISNULL(ZaN_Rodzaj,0)),0,0,ISNULL(ZaN_ZamNumer,PZL_Numer),ISNULL(ZaN_ZamRok,PZL_Rok),ISNULL(ZaN_ZamSeria,PZL_Seria), ISNULL(ZaN_ZamMiesiac,PZL_Miesiac)),''), PPP_TwrNumer,
COALESCE(KNA_Akronim,''), COALESCE(KNA_Nazwa1,''), Twr_Nazwa, Twr_Kod, PPP_Termin, PPP_TerminDo,
PPP_IloscBrakNaMPS, PPP_IloscRez, PPP_IloscOgolnieDostepna, PPP_IloscDoWykorzystania,
PPP_IloscWDrodze, PPP_IloscNaZp, PPP_TerminNaZp, PPP_IloscDoProdukcji, PPP_IloscMinProdukcji,
PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, PPP_IloscZaplanowana,
CASE WHEN PPP_IloscNaZp-PPP_IloscZaplanowana-PPP_IloscWToku-PPP_IloscZrealizowana&gt;0 THEN PPP_IloscNaZp-PPP_IloscZaplanowana-PPP_IloscWToku-PPP_IloscZrealizowana ELSE 0 END,
PPP_IloscWToku,PPP_IloscZrealizowana,
 CASE WHEN PPP_IloscNaZp-PPP_IloscWToku-PPP_IloscZrealizowana &gt;0 THEN PPP_IloscNaZp-PPP_IloscWToku-PPP_IloscZrealizowana  ELSE 0 END,
  PPP_TerminProdukcji,
  ISNULL((Select SUM(Ilosc) FROM CDN.ProdPlanyProdWygenerowaneDok(PPP_Id,NULL)),0)
 from #tabProdukty tp
join #tabWarTwr twt on twt.TwrNumer=tp.PPP_TwrNumer
left join cdn.ZamNag on ZaN_GIDNumer=PPP_DokZrdNumer AND PPP_DokZrdTyp = 960
left join cdn.ProdZlecenia on PZL_ID=PPP_DokZrdNumer and PPP_DokZrdTyp = 14343
left join cdn.KntAdresy on KnA_GIDTyp=ZaN_KnATyp AND KnA_GIDNumer=ZaN_KnANumer
left join cdn.TwrKarty on tp.PPP_TwrNumer=Twr_GIDNumer
where twt.Typ=1




INSERT INTO #tabMaterialyZWarunkami(PREWT_Id,PPT_TwrNumer, PPT_Id, 
    MaterialKod, MaterialNazwa, PPT_Termin, MagazynKod, MagazynNazwa,PPT_MAGNumer,
    PPT_IloscPotrzeba, PPT_IloscOgolnieDostepna, PPT_IloscWDrodze, PPT_IloscWszystkiePotrzeby,
    PPT_IloscZrealizowana, PPT_DoZamowienia, PPT_ZapasBezpieczenstwa, PPT_EOQ,
    PPT_Wielokrotnosc, PPT_Zaokraglenie, PPT_CzasDostawy, PPT_TerminZamowienia,
    PPT_OkresMRPOd,PPT_OkresMRPDo
)
SELECT twt.PREWT_Id, tm.PPT_TwrNumer, PPT_Id,
 Twr_Kod, Twr_Nazwa, PPT_Termin, COALESCE(Mag_Kod,''), COALESCE(Mag_Nazwa,'&lt;Wszystkie&gt;'), PPT_MagNumer,
    PPT_IloscPotrzeba, PPT_IloscOgolnieDostepna, PPT_IloscWDrodze, PPT_IloscWszystkiePotrzeby,
    PPT_IloscZrealizowana, PPT_DoZamowienia, PPT_ZapasBezpieczenstwa, PPT_EOQ,
    PPT_Wielokrotnosc, PPT_Zaokraglenie, PPT_CzasDostawy, PPT_TerminZamowienia,
    PPT_OkresMRPOd,PPT_OkresMRPDo
 from #tabMaterialy tm
join #tabWarTwr twt on twt.TwrNumer=tm.PPT_TwrNumer
left join cdn.TwrKarty on tm.PPT_TwrNumer=Twr_GIDNumer
left join cdn.Magazyny on MAG_GIDNumer=tm.PPT_MagNumer
where twt.Typ=2


INSERT INTO #tabProdRekomendacjeWzorceWarunki (PREWW_PREWTId,PREWW_KolumnaPP,PREWW_Operator,PREWW_Wartosc)
SELECT distinct PREWW_PREWTId,PREWW_KolumnaPP,PREWW_Operator,PREWW_Wartosc from cdn.ProdRekomendacjeWzorceWarunki
join #tabWarTwr on PREWW_PREWTId=PREWT_Id

/* odfiltrowywanie względem PREWW -  po warunach(kolumnach PP)*/



DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=1
AND (
     (tw.PREWW_Operator=5 AND NOT tp.NumerDok=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.NumerDok&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=2
AND (
     (tw.PREWW_Operator=5 AND NOT tw.PREWW_Wartosc IN (tp.KntAkronim,tp.KntNazwa)) OR
     (tw.PREWW_Operator=6 AND NOT tw.PREWW_Wartosc IN (tp.KntAkronim,tp.KntNazwa)) 
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP IN (3,5,29)
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_Termin&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_Termin&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_Termin&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_Termin&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_Termin=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_Termin&lt;&gt;tw.PREWW_Wartosc)
)
DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP IN (4,30)
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_TerminDo&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_TerminDo&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_TerminDo&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_TerminDo&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_TerminDo=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_TerminDo&lt;&gt;tw.PREWW_Wartosc)
)


DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=6
AND (
     (tw.PREWW_Operator=5 AND NOT tp.ProduktKod=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.ProduktKod&lt;&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.ProduktNazwa=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.ProduktNazwa&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=7
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_IloscBrakNaMPS&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_IloscBrakNaMPS&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_IloscBrakNaMPS&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_IloscBrakNaMPS&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_IloscBrakNaMPS=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_IloscBrakNaMPS&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=8
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_IloscRez&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_IloscRez&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_IloscRez&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_IloscRez&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_IloscRez=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_IloscRez&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=9
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_IloscOgolnieDostepna&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_IloscOgolnieDostepna&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_IloscOgolnieDostepna&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_IloscOgolnieDostepna&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_IloscOgolnieDostepna=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_IloscOgolnieDostepna&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=10
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_IloscDoWykorzystania&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_IloscDoWykorzystania&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_IloscDoWykorzystania&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_IloscDoWykorzystania&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_IloscDoWykorzystania=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_IloscDoWykorzystania&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=11
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_IloscBrakNaMPS&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_IloscBrakNaMPS&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_IloscBrakNaMPS&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_IloscBrakNaMPS&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_IloscBrakNaMPS=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_IloscBrakNaMPS&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=12
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_IloscWDrodze&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_IloscWDrodze&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_IloscWDrodze&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_IloscWDrodze&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_IloscWDrodze=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_IloscWDrodze&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=13
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_IloscNaZp&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_IloscNaZp&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_IloscNaZp&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_IloscNaZp&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_IloscNaZp=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_IloscNaZp&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=14
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_TerminNaZp&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_TerminNaZp&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_TerminNaZp&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_TerminNaZp&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_TerminNaZp=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_TerminNaZp&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=15
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_IloscBrakNaMPS&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_IloscBrakNaMPS&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_IloscBrakNaMPS&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_IloscBrakNaMPS&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_IloscBrakNaMPS=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_IloscBrakNaMPS&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=16
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_IloscDoProdukcji&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_IloscDoProdukcji&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_IloscDoProdukcji&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_IloscDoProdukcji&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_IloscDoProdukcji=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_IloscDoProdukcji&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=17
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_IloscMinProdukcji&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_IloscMinProdukcji&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_IloscMinProdukcji&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_IloscMinProdukcji&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_IloscMinProdukcji=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_IloscMinProdukcji&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=18
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_ZapasBezpieczenstwa&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_ZapasBezpieczenstwa&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_ZapasBezpieczenstwa&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_ZapasBezpieczenstwa&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_ZapasBezpieczenstwa=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_ZapasBezpieczenstwa&lt;&gt;tw.PREWW_Wartosc)
)


DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=19
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_EOQ&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_EOQ&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_EOQ&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_EOQ&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_EOQ=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_EOQ&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=20
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_Wielokrotnosc&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_Wielokrotnosc&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_Wielokrotnosc&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_Wielokrotnosc&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_Wielokrotnosc=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_Wielokrotnosc&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=21
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_Zaokraglanie&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_Zaokraglanie&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_Zaokraglanie&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_Zaokraglanie&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_Zaokraglanie=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_Zaokraglanie&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=22
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_Zwiazane&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_Zwiazane&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_Zwiazane&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_Zwiazane&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_Zwiazane=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_Zwiazane&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=23
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_IloscZaplanowana&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_IloscZaplanowana&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_IloscZaplanowana&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_IloscZaplanowana&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_IloscZaplanowana=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_IloscZaplanowana&lt;&gt;tw.PREWW_Wartosc)
)
DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=24
AND (
     (tw.PREWW_Operator=1 AND NOT tp.DoZaplanowania&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.DoZaplanowania&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.DoZaplanowania&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.DoZaplanowania&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.DoZaplanowania=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.DoZaplanowania&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=25
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_IloscWToku&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_IloscWToku&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_IloscWToku&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_IloscWToku&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_IloscWToku=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_IloscWToku&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=26
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_IloscZrealizowana&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_IloscZrealizowana&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_IloscZrealizowana&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_IloscZrealizowana&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_IloscZrealizowana=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_IloscZrealizowana&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=27
AND (
     (tw.PREWW_Operator=1 AND NOT tp.IloscDoRealizacji&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.IloscDoRealizacji&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.IloscDoRealizacji&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.IloscDoRealizacji&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.IloscDoRealizacji=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.IloscDoRealizacji&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabProduktyZWarunkami  FROM #tabProduktyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=28
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPP_TerminProdukcji&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPP_TerminProdukcji&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPP_TerminProdukcji&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPP_TerminProdukcji&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPP_TerminProdukcji=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPP_TerminProdukcji&lt;&gt;tw.PREWW_Wartosc)
)


DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=100
AND (
     (tw.PREWW_Operator=5 AND NOT tw.PREWW_Wartosc IN (tp.MaterialKod,tp.MaterialNazwa)) OR
     (tw.PREWW_Operator=6 AND NOT tw.PREWW_Wartosc IN (tp.MaterialKod,tp.MaterialNazwa)) 
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=102
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_Termin&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_Termin&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_Termin&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_Termin&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_Termin=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_Termin&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=103
AND (
     (tw.PREWW_Operator=5 AND NOT tw.PREWW_Wartosc IN (tp.MagazynKod,tp.MagazynNazwa)) OR
     (tw.PREWW_Operator=6 AND tw.PREWW_Wartosc IN (tp.MagazynKod,tp.MagazynNazwa))
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=104
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_IloscPotrzeba&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_IloscPotrzeba&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_IloscPotrzeba&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_IloscPotrzeba&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_IloscPotrzeba=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_IloscPotrzeba&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=102
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_Termin&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_Termin&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_Termin&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_Termin&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_Termin=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_Termin&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=105
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_IloscOgolnieDostepna&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_IloscOgolnieDostepna&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_IloscOgolnieDostepna&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_IloscOgolnieDostepna&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_IloscOgolnieDostepna=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_IloscOgolnieDostepna&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=106
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_IloscWDrodze&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_IloscWDrodze&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_IloscWDrodze&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_IloscWDrodze&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_IloscWDrodze=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_IloscWDrodze&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=107
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_IloscWszystkiePotrzeby&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_IloscWszystkiePotrzeby&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_IloscWszystkiePotrzeby&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_IloscWszystkiePotrzeby&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_IloscWszystkiePotrzeby=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_IloscWszystkiePotrzeby&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=108
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_IloscZrealizowana&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_IloscZrealizowana&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_IloscZrealizowana&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_IloscZrealizowana&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_IloscZrealizowana=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_IloscZrealizowana&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=110
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_DoZamowienia&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_DoZamowienia&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_DoZamowienia&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_DoZamowienia&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_DoZamowienia=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_DoZamowienia&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=111
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_ZapasBezpieczenstwa&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_ZapasBezpieczenstwa&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_ZapasBezpieczenstwa&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_ZapasBezpieczenstwa&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_ZapasBezpieczenstwa=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_ZapasBezpieczenstwa&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=112
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_EOQ&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_EOQ&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_EOQ&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_EOQ&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_EOQ=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_EOQ&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=113
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_Wielokrotnosc&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_Wielokrotnosc&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_Wielokrotnosc&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_Wielokrotnosc&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_Wielokrotnosc=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_Wielokrotnosc&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=114
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_Zaokraglenie&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_Zaokraglenie&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_Zaokraglenie&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_Zaokraglenie&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_Zaokraglenie=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_Zaokraglenie&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=115
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_CzasDostawy&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_CzasDostawy&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_CzasDostawy&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_CzasDostawy&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_CzasDostawy=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_CzasDostawy&lt;&gt;tw.PREWW_Wartosc)
)

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=117
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_TerminZamowienia&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_TerminZamowienia&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_TerminZamowienia&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_TerminZamowienia&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_TerminZamowienia=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_TerminZamowienia&lt;&gt;tw.PREWW_Wartosc)
)
DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=118
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_OkresMRPOd&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_OkresMRPOd&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_OkresMRPOd&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_OkresMRPOd&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_OkresMRPOd=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_OkresMRPOd&lt;&gt;tw.PREWW_Wartosc)
)
DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
WHERE PREWW_KolumnaPP=119
AND (
     (tw.PREWW_Operator=1 AND NOT tp.PPT_OkresMRPDo&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT tp.PPT_OkresMRPOd&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT tp.PPT_OkresMRPOd&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT tp.PPT_OkresMRPOd&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT tp.PPT_OkresMRPOd=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT tp.PPT_OkresMRPOd&lt;&gt;tw.PREWW_Wartosc)
)


CREATE TABLE #ProdPlanyMatListaRek (
	PPT_Id int,
	IloscBrak decimal(17,4),
	Zwiazane  decimal(17,4),
)

DECLARE @PPPIds AS CDN.NumerTableType
INSERT INTO @PPPIds
SELECT PPP_Id FROM CDN.ProdPlanyProdukty WHERE PPP_PPLId = @PPId


DECLARE @PPL_PrzeliczenieRodzaj SMALLINT;
SELECT @PPL_PrzeliczenieRodzaj=PPL_PrzeliczenieRodzaj from cdn.ProdPlany where PPL_Id=@PPId

INSERT INTO #ProdPlanyMatListaRek EXEC CDN.ProdPlanyMaterialyListaDlaRekomendacji @PPPIds, '', 'PL',@PPL_PrzeliczenieRodzaj,0,0

DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
join #ProdPlanyMatListaRek ml on ml.PPT_Id = tp.PPT_Id--ml.ZgrupowaneID like '%'+Cast(tp.PPT_Id AS VARCHAR(8000))+'%'
WHERE PREWW_KolumnaPP=109
AND (
     (tw.PREWW_Operator=1 AND NOT ml.IloscBrak&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT ml.IloscBrak&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT ml.IloscBrak&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT ml.IloscBrak&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT ml.IloscBrak=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT ml.IloscBrak&lt;&gt;tw.PREWW_Wartosc)
)
DELETE  #tabMaterialyZWarunkami  FROM #tabMaterialyZWarunkami tp
join #tabProdRekomendacjeWzorceWarunki tw on PREWT_Id=PREWW_PREWTId
join #ProdPlanyMatListaRek ml on ml.PPT_Id = tp.PPT_Id --ml.ZgrupowaneID like '%'+CAST(tp.PPT_Id AS VARCHAR(8000))+'%'
WHERE PREWW_KolumnaPP=116
AND (
     (tw.PREWW_Operator=1 AND NOT ml.Zwiazane&gt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=2 AND NOT ml.Zwiazane&lt;tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=3 AND NOT ml.Zwiazane&gt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=4 AND NOT ml.Zwiazane&lt;=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=5 AND NOT ml.Zwiazane=tw.PREWW_Wartosc) OR
     (tw.PREWW_Operator=6 AND NOT ml.Zwiazane&lt;&gt;tw.PREWW_Wartosc)
)
DROP TABLE #ProdPlanyMatListaRek





/* przepisanie danych z tabel tymczasowych do ProdRekomendacjeProdukty*/
INSERT INTO CDN.ProdRekomendacjeProdukty
                           (
                    [PREP_PREId]
                    ,[PREP_TwrNumer]
                    ,[PREP_IloscWgPP]
                    ,[PREP_Ilosc]
                    ,[PREP_IloscZrealizowano]
                    ,[PREP_MagNumer]
                    ,[PREP_TerminRozpoczecia]
                    ,[PREP_TerminZakonczenia]
                    ,[PREP_TwrTyp]   
                           )
                 SELECT
                    @PreId,
                    tab.PPP_TwrNumer,
                    tab.PPP_IloscDoProdukcji,
                    tab.PPP_IloscDoProdukcji,
                    0,
                    (select 
                    CASE count(*) WHEN 1
                            THEN MIN(PPM_MagNumer)
				    WHEN 0
                            THEN 0
                    else   -1
                    END FROM 
				cdn.ProdPlany
				JOIN cdn.prodplanymag  ON PPL_ID=PPM_PPLId
				WHERE PPM_PPLId=@PPId  ),--Produkty nie mają definiowanych magazynów
                    tab.PPP_Termin,
                    CASE WHEN tab.PPP_TerminDo=0 THEN tab.PPP_Termin else tab.PPP_TerminDo END,
                    1 
                -- FROM #tabProduktyZWarunkami tab --usuwanie duplikatów(ten sam towar wchodzi z kilku grup towarowych )
                FROM (
                    select  *, ROW_NUMBER() OVER(PARTITION BY /*PREWT_Id,*/NumerDok, PPP_TwrNumer,
KntAkronim, KntNazwa, ProduktNazwa, ProduktKod, PPP_Termin, PPP_TerminDo,
PPP_IloscBrakNaMPS, PPP_IloscRez, PPP_IloscOgolnieDostepna, PPP_IloscDoWykorzystania,
PPP_IloscWDrodze, PPP_IloscNaZp, PPP_TerminNaZp, PPP_IloscDoProdukcji, PPP_IloscMinProdukcji,
PPP_ZapasBezpieczenstwa, PPP_EOQ, PPP_Wielokrotnosc, PPP_Zaokraglanie, PPP_IloscZaplanowana,
DoZaplanowania,
 PPP_IloscWToku, PPP_IloscZrealizowana,
  IloscDoRealizacji,
   PPP_TerminProdukcji, PPP_Zwiazane ORDER BY (select NULL)) as rwNum
   
    from
                    #tabProduktyZWarunkami
                 )tab
                 where rwNum=1


;with CTEPolprodukty
     AS (
     SELECT PPT.PPT_Id
     FROM cdn.ProdPlanyMaterialy PPT
     JOIN cdn.ProdPlanyProdukty PPP on PPP.PPP_Id=PPT.PPT_PPPId
     WHERE PPP.PPP_PPLId IN(@PPId)
     AND PPT.PPT_ZamiennikTowaru = 0
     AND EXISTS
     (
         SELECT *
         FROM cdn.ProdPlanyMaterialy PPTe
         JOIN cdn.ProdPlanyProdukty PPPe on PPPe.PPP_Id=PPTe.PPT_PPPId
         WHERE PPPe.PPP_PPLId IN(@PPId)
         AND PPTe.PPT_RodzicId = PPT.PPT_Id
         AND PPTe.PPT_ZamiennikTowaru = 0
     )
     UNION ALL
     SELECT PPT.PPT_Id
     FROM cdn.ProdPlanyMaterialy PPT
          JOIN CTEPolprodukty ctep ON PPT.PPT_ZamiennikTowaru &lt;&gt; 0
                                      AND PPT.PPT_RodzicId = ctep.PPT_Id)
INSERT INTO CDN.ProdRekomendacjeProdukty
                           (
                    [PREP_PREId]
                    ,[PREP_TwrNumer]
                    ,[PREP_IloscWgPP]
                    ,[PREP_Ilosc]
                    ,[PREP_IloscZrealizowano]
                    ,[PREP_MagNumer]
                    ,[PREP_TerminRozpoczecia]
                    ,[PREP_TerminZakonczenia]
                    ,[PREP_TwrTyp]   
                           )
                 SELECT
                    @PreId,
                    tab.PPT_TwrNumer,
                    tab.PPT_DoZamowienia,
                    tab.PPT_DoZamowienia,
                    0,
                    tab.PPT_MagNumer,
                    tab.PPT_Termin,
                    tab.PPT_Termin,
                    CASE WHEN cte.PPT_Id IS NULL THEN 3 ELSE 2 END
                -- FROM #tabMaterialyZWarunkami tab  --usuwanie duplikatów(ten sam towar wchodzi z kilku grup towarowych )
                FROM (
                    select  *, ROW_NUMBER() OVER(PARTITION BY  /*PREWT_Id,*/PPT_TwrNumer, PPT_Id, 
    MaterialKod, MaterialNazwa, PPT_Termin, MagazynKod, MagazynNazwa,PPT_MAGNumer,
    PPT_IloscPotrzeba, PPT_IloscOgolnieDostepna, PPT_IloscWDrodze, PPT_IloscWszystkiePotrzeby,
    PPT_IloscZrealizowana, PPT_DoZamowienia, PPT_ZapasBezpieczenstwa, PPT_EOQ,
    PPT_Wielokrotnosc, PPT_Zaokraglenie, PPT_CzasDostawy, PPT_TerminZamowienia,
    PPT_OkresMRPOd,PPT_OkresMRPDo
    ORDER BY (select NULL)) as rwNum
                FROM #tabMaterialyZWarunkami )tab
              
                LEFT join CTEPolprodukty cte on tab.PPT_Id=cte.PPT_Id
                 where rwNum=1

         SELECT 0 as Blad, @PREId as PREID
	SET NOCOUNT OFF
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="ProdPlanyRekomendacjeWygenerowaneDok"></A><PRE>
          <FONT SIZE="2"><I>/* ProdPlanyRekomendacjeWygenerowaneDok */</I><BR>
CREATE FUNCTION CDN.ProdPlanyRekomendacjeWygenerowaneDok(		
		@i_ProdRekomendacjeProduktId INT = 0,
        @v_ProdProdRekomendacjeProdId VARCHAR(2000)
        )
RETURNS @tabDokMPS TABLE(
	PREPId			INT,
	DOKNumer		INT, 
	DOKTyp			SMALLINT, 
	DOKLp			INT, 
    Ilosc			decimal(15,4),
	DataZwiazania	INT 
)
AS
BEGIN
	DECLARE @tabProdRekomendacjeId TABLE(
	PREIdPom		int
	)

	IF @i_ProdRekomendacjeProduktId IS NOT NULL AND @i_ProdRekomendacjeProduktId &gt; 0 BEGIN
		INSERT INTO @tabProdRekomendacjeId
		Select @i_ProdRekomendacjeProduktId		
	END
	ELSE IF @v_ProdProdRekomendacjeProdId IS NOT NULL AND LEN(@v_ProdProdRekomendacjeProdId) &gt; 0 BEGIN
		DECLARE @str VARCHAR(20)  
		DECLARE @ind Int 

		SET @ind = CharIndex(',',@v_ProdProdRekomendacjeProdId)  
        WHILE @ind &gt; 0 BEGIN  
			SET @str = SUBSTRING(@v_ProdProdRekomendacjeProdId,1,@ind-1)  
			SET @v_ProdProdRekomendacjeProdId = SUBSTRING(@v_ProdProdRekomendacjeProdId,@ind+1,LEN(@v_ProdProdRekomendacjeProdId)-@ind)  
            INSERT INTO @tabProdRekomendacjeId values (@str)  
            SET @ind = CharIndex(',',@v_ProdProdRekomendacjeProdId)  
        END  
		SET @str = @v_ProdProdRekomendacjeProdId  
		INSERT INTO @tabProdRekomendacjeId values (@str) 
	END

	INSERT INTO @tabDokMPS
	SELECT
	PREP_Id PREPId, DOKNumer, DOKTyp, DokLp, Ilosc, PRED_DataZwiazania DataZwiazania FROM
	(
	SELECT 
	PREP_Id PREPId , ISNULL(ZaN_GIDNumer,ISNULL(PZL_Id,0)) DOKNumer, PRED_DokTyp DOKTyp, PRED_DokLp DOKLp, ISNULL(PZE_Ilosc,ISNULL(ZaE_Ilosc,0)) Ilosc
	FROM cdn.ProdRekomendacjeDokumenty
	INNER JOIN CDN.ProdRekomendacjeProdukty ON PREP_Id = PRED_PREPId
	LEFT JOIN CDN.ZamElem ON ZaE_GIDNumer = PRED_DokNumer AND ZaE_GIDTyp = PRED_DokTyp AND ZaE_GidLp=PRED_DokLp
	LEFT JOIN CDN.ZamNag ON ZaN_GIDNumer = ZaE_GIDNumer
	LEFT JOIN CDN.ProdZlecElem ON PZE_Id = PRED_DokLp AND PRED_DokTyp = 14343
	LEFT JOIN CDN.ProdZlecenia ON PZL_Id = PZE_Zlecenie
	WHERE
	(PRED_DokTyp = 14343
	OR (PRED_DokTyp = 960 AND ZaN_Stan NOT IN(35,37,51)))
	AND PREP_Id IN(SELECT PREIdPom FROM @tabProdRekomendacjeId)
	) Powiazania2
	INNER JOIN CDN.ProdRekomendacjeDokumenty ON PRED_DokNumer = DOKNumer AND PRED_DokTyp = DOKTyp  AND PRED_DokLp = DOKLp
    INNER JOIN cdn.ProdRekomendacjeProdukty on PRED_PREPId=PREP_Id 
	RETURN
END
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>