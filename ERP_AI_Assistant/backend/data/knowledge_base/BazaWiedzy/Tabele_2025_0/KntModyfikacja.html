<HTML>
  <HEAD>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1250">
    <META NAME="Author" CONTENT="Comarch S.A.">
    <LINK rel="stylesheet" type="text/css" href="Style/doc.css">
    <TITLE>Skrypt SQL</TITLE>
  </HEAD>
  <BODY>
<DIV CLASS="TextInfo">
      <P><A name="Usuwanie procedury KntModyfikacja"></A><PRE>
          <FONT SIZE="2" DISABLED="True"><I>/* Usuwanie procedury KntModyfikacja */</I><BR>
IF EXISTS (
		SELECT *
		FROM sysobjects
		WHERE NAME = 'KntModyfikacja'
			AND xtype = 'P'
		)
	DROP PROCEDURE CDN.KntModyfikacja
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="Tworzenie procedury KntModyfikacja"></A><PRE>
          <FONT SIZE="2"><I>/* Tworzenie procedury KntModyfikacja */</I><BR>
CREATE PROCEDURE CDN.KntModyfikacja
	--parametry wymagalne
	@KntGIDTyp SMALLINT
	, @KntGIDFirma INT
	, @KntGIDNumer INT
	, @OpeGIDTyp SMALLINT
	, @OpeGIDFirma INT
	, @OpeGIDNumer INT
	,
	--pola opcjonalne
	@Typ SMALLINT = NULL
	, @Akwizytor SMALLINT = NULL
	, @Akronim VARCHAR(20) = NULL
	, @AkronimFormat VARCHAR(30) = NULL
	, @Nazwa1 VARCHAR(50) = NULL
	, @Nazwa2 VARCHAR(50) = NULL
	, @Nazwa3 VARCHAR(250) = NULL
	, @KodP VARCHAR(10) = NULL
	, @Miasto VARCHAR(30) = NULL
	, @Ulica VARCHAR(30) = NULL
	, @Adres VARCHAR(30) = NULL
	, @NipPrefiks VARCHAR(2) = NULL
	, @NipE VARCHAR(20) = NULL
	, @Regon VARCHAR(20) = NULL
	, @Pesel VARCHAR(11) = NULL
	,
	--@KontoDostawcy varchar (30) = NULL,
	--@KontoOdbiorcy varchar (30) = NULL,
	@Telefon1 VARCHAR(30) = NULL
	, @Telefon2 VARCHAR(30) = NULL
	, @Fax VARCHAR(30) = NULL
	, @Modem VARCHAR(30) = NULL
	, @Telex VARCHAR(30) = NULL
	, @EMail VARCHAR(40) = NULL
	, @URL VARCHAR(255) = NULL
	, @BnkTyp SMALLINT = NULL
	, @BnkFirma INT = NULL
	, @BnkNumer INT = NULL
	, @NrRachunku VARCHAR(50) = NULL
	, @Rabat DECIMAL(5, 2) = NULL
	, @MaxLimitWart DECIMAL(15, 2) = NULL
	, @LimitPoTerminie DECIMAL(15, 2) = NULL
	, @LimitOkres SMALLINT = NULL
	, @Dewizowe SMALLINT = NULL
	, @Symbol VARCHAR(3) = NULL
	, @Cena SMALLINT = NULL
	, @FormaPl SMALLINT = NULL
	, @Marza DECIMAL(5, 2) = NULL
	, @TypKarty SMALLINT = NULL
	, @NumerKarty VARCHAR(16) = NULL
	, @DataKarty INT = NULL
	, @Ean VARCHAR(16) = NULL
	, @ObcaKarta SMALLINT = NULL
	, @ExpoKraj SMALLINT = NULL
	, @SeriaFa VARCHAR(5) = NULL
	, @PlatnikVat SMALLINT = NULL
	, @Status SMALLINT = NULL
	,
	--@Koncesja int = NULL,
	--@DataKoncesji int = NULL,
	@SposobDostawy VARCHAR(20) = NULL
	, @Dzialalnosc SMALLINT = NULL
	, @AkwTyp SMALLINT = NULL
	, @AkwFirma INT = NULL
	, @AkwNumer INT = NULL
	, @AkwProwizja DECIMAL(7, 4) = NULL
	, @Umowa VARCHAR(30) = NULL
	, @DataW INT = NULL
	, @FaVATOsw VARCHAR(30) = NULL
	, @FaVATData INT = NULL
	, @CechaOpis VARCHAR(250) = NULL
	, @Wsk SMALLINT = NULL
	, --pole 'nie publikuj' możliwe tylko 0 lub 4
	@PrcTyp SMALLINT = NULL
	, @PrcFirma INT = NULL
	, @PrcNumer INT = NULL
	, @AutoPotwierdzenie SMALLINT = NULL
	, @MagTyp SMALLINT = NULL
	, @MagFirma INT = NULL
	, @MagNumer INT = NULL
	, @OutlookUrl VARCHAR(255) = NULL
	, @Zrodlo INT = NULL
	, @Branza INT = NULL
	, @Rodzaj INT = NULL
	, @RolaPartnera INT = NULL
	, @Kraj VARCHAR(2) = NULL
	, @Odleglosc DECIMAL(10, 2) = NULL
	, @KarTyp SMALLINT = NULL
	, @KarFirma INT = NULL
	, @KarNumer INT = NULL
	, @Powiat VARCHAR(30) = NULL
	, @Gmina VARCHAR(30) = NULL
	, @Wojewodztwo VARCHAR(30) = NULL
	, @NRB SMALLINT = NULL
	, @Archiwalny SMALLINT = NULL
	, @AdresNieAktualny SMALLINT = NULL
	, @BlokadaTransakcji SMALLINT = NULL
	, @RegionCRM INT = NULL
	, @GLN VARCHAR(12) = NULL
	, @Spedytor SMALLINT = NULL
	, @TerminPlZak INT = NULL
	, @FormaPlZak INT = NULL
	, @SpTerminPlSpr INT = NULL
	, @SpTerminPlZak INT = NULL
	, @LimitTerminowy SMALLINT = NULL
	, @DataWygasniecia INT = NULL
	, @MaxDniPoTerminie INT = NULL
	, @PIN VARCHAR(4) = NULL
	, @Priorytet INT = NULL
	, @PriorytetRez INT = NULL
	, @TerminRozliczeniaKaucji INT = NULL
	, @PlatnoscKaucji SMALLINT = NULL
	, @KnPTyp SMALLINT = NULL
	, @KnPNumer INT = NULL
	, @KnPParam SMALLINT = NULL
	, @Oddzialowy SMALLINT = NULL
	, @Powiazany SMALLINT = NULL
	, @KnGTyp SMALLINT = NULL
	, @KnGNumer INT = NULL
	, @Opis VARCHAR(1999) = NULL
	, @OpeNumerW INT = NULL
	, --KAp:OpeNumer - Operator wystawiający
	@OpeHaslo VARCHAR(100) = NULL
	, --KAp:OpeHaslo - Hasło operatora wystawiającego  
	@OpeNumerO INT = NULL
	, --KAp:OpeONumer - Operator odpowiedzialny za realizację
	@TwrGrupaNumer INT = NULL
	, --KAp:TwrGrupaNumer - Grupa towarów udostępniona kontrahentowi
	@SeriaKaP VARCHAR(5) = NULL
	, --KAp:Seria - Seria, z którą będą wystawiane dokumenty
	@ESklep TINYINT = NULL
	, @MagMSTyp SMALLINT = NULL
	, @MagMSFirma INT = NULL
	, @MagMSNumer INT = NULL
	, @MSTwrGrupaNumer INT = NULL
	--2017.1
	, @RolnikRyczaltowy TINYINT = NULL
	, @DokumentTozsamosci VARCHAR(50) = NULL
	, @DataWydania INT = NULL
	, @OrganWydajacy VARCHAR(50) = NULL
	--2018.2
	, @SplitPayment TINYINT = NULL
	--Procedura modyfikuje kartę kontrahenta, ale tylko te pola, które mają wartość inną niż null.
	--Wersja 1.00 4.02.2004
	--Parametry wymagalne:
	-- @KntGIDTyp		GIDTyp modyfikowanego kontrahenta
	-- @KntGIDFirma		GIDFirma modyfikowanego kontrahenta
	-- @KntGIDNumer		GIDNumer modyfikowanego kontrahenta
	-- @OpeGIDTyp		GIDTyp operatora modyfikującego
	-- @OpeGIDFirma		GIDFirma operatora modyfikującego
	-- @OpeGIDNumer		GIDNumer operatora modyfikującego
	--Pozostałe parametry mają defaultowo ustawianą wartość null, jeśli pole ma taką wartość to nie zostanie ono zmienione.
	--2019.2.1
	, @GUID nvarchar(40) = NULL
	, @GUIDdane nvarchar(40) = NULL
	--2021.0
	, @GUIDTelefon nvarchar(40) = NULL
	, @GUIDEmail nvarchar(40) = NULL
	--2025.0
	, @CharsetANSI TINYINT = NULL
AS
-----------------------------------------------------------------------------------------------------
DECLARE @knaTyp SMALLINT
DECLARE @knaFirma INT
DECLARE @knaNumer INT
DECLARE @modType INT
DECLARE @KnaGuid nvarchar(40)
DECLARE @KnaGuidDane nvarchar(40)
DECLARE @KnaGuidEmail nvarchar(40)
DECLARE @KnaGuidTelefon nvarchar(40)

SET @modType = 0

DECLARE @NowaKarta INT

SET @NowaKarta = 0

DECLARE @i INT
DECLARE @err INT
DECLARE @ModyfAdr INT
DECLARE @CyfraKontrolnaGLN INT
DECLARE @OpeLimitKredytu DECIMAL(15, 2)
DECLARE @OpeLimitPoTerminie DECIMAL(5, 2)
DECLARE @LimitBezOgraniczenia SMALLINT
DECLARE @BnkNrRachunku VARCHAR(10)
DECLARE @NrRachunku_new VARCHAR(50)
DECLARE @Nip VARCHAR(20)
DECLARE @Opis_old VARCHAR(1999)
DECLARE @PlatnikIstnieje SMALLINT
DECLARE @SQLString NVARCHAR(4000)
DECLARE @SQLStringAdr NVARCHAR(4000)
DECLARE @SQLStringKAp NVARCHAR(4000)

DECLARE @WalutaSystemowa	VARCHAR(3)

SET NOCOUNT ON
SET @SQLStringAdr = ''
SET @SQLStringKAp = ''
SET @ModyfAdr = 0
SET @NrRachunku_new = ''


SELECT @WalutaSystemowa = RTRIM(LTRIM(Kon_Wartosc)) FROM CDN.Konfig WHERE Kon_Numer = 211

--------------------------------------------- Program
-----------------------------------------------------------------------------------------------------
-- Sprawdzenie czy kontrahent istnieje
-----------------------------------------------------------------------------------------------------
IF NOT EXISTS (
		SELECT *
		FROM cdn.kntkarty
		WHERE knt_gidtyp = @KntGIDTyp
			AND knt_gidfirma = @KntGIDFirma
			AND knt_gidnumer = @KntGIDNumer
		)
BEGIN
	RAISERROR (
			'Nie znaleziono kontrahenta [%d,%d,%d] - (1)'
			, 16
			, 1
			, @KntGIDTyp
			, @KntGIDNumer
			, @KntGIDFirma
			)

	RETURN 1
END

-----------------------------------------------------------------------------------------------------
-- Sprawdzenie operatora modyfikującego
-----------------------------------------------------------------------------------------------------
IF NOT EXISTS (
		SELECT *
		FROM cdn.opekarty
		WHERE ope_gidtyp = @OpeGIDTyp
			AND ope_gidfirma = @OpeGIDFirma
			AND ope_gidnumer = @OpeGIDNumer
		)
BEGIN
	RAISERROR (
			'Nie znaleziono operatora [%d,%d,%d] - (2)'
			, 16
			, 1
			, @OpeGIDTyp
			, @OpeGIDFirma
			, @OpeGIDNumer
			)

	RETURN 2
END

-----------------------------------------------------------------------------------------------------
-- Gid rekordu z tabeli kntAdresy
-----------------------------------------------------------------------------------------------------
SELECT TOP 1 @knaTyp = knt_knatyp
	, @knaFirma = knt_knafirma
	, @knaNumer = knt_knanumer
FROM cdn.kntkarty
WHERE knt_gidtyp = @KntGIDTyp
	AND knt_gidfirma = @KntGIDfirma
	AND knt_gidnumer = @KntGIDnumer

-----------------------------------------------------------------------------------------------------
-- Gid tabeli musi istnieć
-----------------------------------------------------------------------------------------------------
IF @knaTyp IS NULL
	OR @knaFirma IS NULL
	OR @knaNumer IS NULL
	OR (
		@knaTyp = 0
		AND @knaFirma = 0
		AND @knaNumer = 0
		)
BEGIN
	SET @NowaKarta = 1
END

-----------------------------------------------------------------------------------------------------
-- Modyfikacja dokumentu TraNag
-----------------------------------------------------------------------------------------------------
IF @NowaKarta = 0
BEGIN
	SELECT TOP 1 @modType = isnull(Trn_gidtyp, 0)
	FROM cdn.tranag
	WHERE (
			trn_knatyp = @knaTyp
			AND trn_knanumer = @knaNumer
			)
		OR (
			trn_adwtyp = @knaTyp
			AND trn_adwnumer = @knaNumer
			)
END

-----------------------------------------------------------------------------------------------------
-- Modyfikacja dokumentu MagNag
-----------------------------------------------------------------------------------------------------
IF @modType = 0
	AND @NowaKarta = 0
BEGIN
	SELECT TOP 1 @modType = isnull(man_gidtyp, 0)
	FROM cdn.magnag
	WHERE man_knatyp = @knaTyp
		AND man_knanumer = @knaNumer
END

-----------------------------------------------------------------------------------------------------
-- Ostatnia modyfikacja ZamNag
-----------------------------------------------------------------------------------------------------
IF @modType = 0
	AND @NowaKarta = 0
BEGIN
	SELECT TOP 1 @modType = isnull(zan_gidtyp, 0)
	FROM cdn.zamnag
	WHERE (
			zan_knatyp = @knaTyp
			AND zan_knanumer = @knaNumer
			)
		OR (
			zan_adwtyp = @knaTyp
			AND zan_adwnumer = @knaNumer
			)
END

-----------------------------------------------------------------------------------------------------
-- Ostatnia modyfikacja ZlcRemNag
-----------------------------------------------------------------------------------------------------
IF @modType = 0
	AND @NowaKarta = 0
BEGIN
	SELECT TOP 1 @modType = isnull(ZRN_GIDTyp, 0)
	FROM cdn.ZlcRemNag
	WHERE (
			ZRN_KNATyp = @knaTyp
			AND ZRN_KNANumer = @knaNumer
			)
		OR (
			ZRN_KNATypO = @knaTyp
			AND ZRN_KNANumerO = @knaNumer
			)
END

-----------------------------------------------------------------------------------------------------
-- Ostatnia modyfikacja ImpNag
-----------------------------------------------------------------------------------------------------
IF @modType = 0
	AND @NowaKarta = 0
BEGIN
	SELECT TOP 1 @modType = isnull(imn_gidtyp, 0)
	FROM cdn.impnag
	WHERE (
			imn_knatyp = @knaTyp
			AND imn_knanumer = @knaNumer
			)
		OR (
			imn_adwtyp = @knaTyp
			AND imn_adwnumer = @knaNumer
			)
END

-----------------------------------------------------------------------------------------------------
-- Ostatnia modyfikacja SadNag
-----------------------------------------------------------------------------------------------------
IF @modType = 0
	AND @NowaKarta = 0
BEGIN
	SELECT TOP 1 @modType = isnull(san_gidtyp, 0)
	FROM cdn.sadnag
	WHERE (
			san_knatyp = @knaTyp
			AND san_knanumer = @knaNumer
			)
		OR (
			san_knaztyp = @knaTyp
			AND san_knaznumer = @knaNumer
			)
END

IF @modType = 0
	AND @NowaKarta = 0
	SET @SQLStringAdr = N'Update Cdn.KntAdresy set '
SET @SQLString = N'Update Cdn.KntKarty set '

-----------------------------------------------------------------------------------------------------
-- Sprawdzenie pol
-----------------------------------------------------------------------------------------------------
IF @Akronim IS NOT NULL
	AND @Akronim &lt;&gt; ''
BEGIN
	-----------------------------------------------------------------------------------------------------
	-- Akronim test
	-----------------------------------------------------------------------------------------------------
	IF EXISTS (
			SELECT knt_akronim
			FROM cdn.kntkarty
			WHERE knt_gidtyp = @KntGIDTyp
				AND knt_gidfirma = @KntGIDFirma
				AND knt_gidnumer &lt;&gt; @KntGIDNumer
				AND knt_akronim = @Akronim
			)
	BEGIN
		RAISERROR (
				'Podany akronim już istnieje! [%s] - (3)'
				, 16
				, 1
				, @Akronim
				)

		RETURN 3
	END

	SET @SQLString = @SQLString + 'Knt_Akronim=' + '''' + UPPER(@Akronim) + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + 'KnA_Akronim=' + '''' + UPPER(@Akronim) + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Typ
-----------------------------------------------------------------------------------------------------
IF @Typ IS NOT NULL
BEGIN
	IF @Typ IN (0, 8, 16, 24)
		SET @SQLString = @SQLString + ',Knt_Typ=' + CAST(@Typ AS VARCHAR)
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartosć pola Knt_Typ [%d] - (4)'
				, 16
				, 1
				, @Typ
				)

		RETURN 4
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_Akwizytor
-----------------------------------------------------------------------------------------------------
IF @Akwizytor IS NOT NULL
BEGIN
	IF @Akwizytor IN (0, 1)
		SET @SQLString = @SQLString + ',Knt_Akwizytor=' + CAST(@Akwizytor AS VARCHAR)
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartosć pola Knt_Akwizytor [%d] - (5)'
				, 16
				, 1
				, @Akwizytor
				)

		RETURN 5
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_AkronimFormat
-----------------------------------------------------------------------------------------------------
IF @AkronimFormat IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_AkronimFormat=' + '''' + @AkronimFormat + ''''

-----------------------------------------------------------------------------------------------------
-- Knt_Nazwa1
-----------------------------------------------------------------------------------------------------
IF @Nazwa1 IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Nazwa1=' + '''' + @Nazwa1 + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Nazwa1=' + '''' + @Nazwa1 + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Nazwa2
-----------------------------------------------------------------------------------------------------
IF @Nazwa2 IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Nazwa2=' + '''' + @Nazwa2 + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Nazwa2=' + '''' + @Nazwa2 + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Nazwa3
-----------------------------------------------------------------------------------------------------
IF @Nazwa3 IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Nazwa3=' + '''' + @Nazwa3 + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Nazwa3=' + '''' + @Nazwa3 + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_KodP
-----------------------------------------------------------------------------------------------------
IF @KodP IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_KodP=' + '''' + @KodP + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_KodP=' + '''' + @KodP + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Miasto
-----------------------------------------------------------------------------------------------------
IF @Miasto IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Miasto=' + '''' + @Miasto + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Miasto=' + '''' + @Miasto + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Ulica
-----------------------------------------------------------------------------------------------------
IF @Ulica IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Ulica=' + '''' + @Ulica + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Ulica=' + '''' + @Ulica + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Adres
-----------------------------------------------------------------------------------------------------
IF @Adres IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Adres=' + '''' + @Adres + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Adres=' + '''' + @Adres + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_PlatnikVat
--------------------------------------------------------------------------------------------------
IF @PlatnikVat IS NOT NULL
BEGIN
	IF @PlatnikVat IN (0, 1)
		SET @SQLString = @SQLString + ',Knt_PlatnikVat=' + CAST(@PlatnikVat AS VARCHAR)
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartość pola Knt_PlatnikVat [%d] - (13)'
				, 16
				, 1
				, @PlatnikVat
				)

		RETURN 13
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_Kraj
-----------------------------------------------------------------------------------------------------
IF @Kraj IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Kraj=' + '''' + @Kraj + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Kraj=' + '''' + @Kraj + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_NipPrefiks
-----------------------------------------------------------------------------------------------------
IF @NipPrefiks IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_NipPrefiks=' + '''' + @NipPrefiks + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_NipPrefiks=' + '''' + @NipPrefiks + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_ExpoKraj
--------------------------------------------------------------------------------------------------
IF @ExpoKraj IS NOT NULL
BEGIN
	IF @ExpoKraj IN (0, 1, 2, 3)
		SET @SQLString = @SQLString + ',Knt_ExpoKraj=' + CAST(@ExpoKraj AS VARCHAR)
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartość pola Knt_ExpoKraj [%d] - (12)'
				, 16
				, 1
				, @ExpoKraj
				)

		RETURN 12
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_NipE + obsługa pola Knt_Nip
-----------------------------------------------------------------------------------------------------
IF @NipE IS NOT NULL
BEGIN
	--IF @NipPrefiks IS NULL
	--	SELECT @NipPrefiks = Knt_NipPrefiks
	--	FROM cdn.kntkarty
	--	WHERE knt_gidtyp = @KntGIDTyp
	--		AND knt_gidnumer = @KntGIDNumer
	--IF @Kraj IS NULL
	--	SELECT @Kraj = Knt_Kraj
	--	FROM cdn.kntkarty
	--	WHERE knt_gidtyp = @KntGIDTyp
	--		AND knt_gidnumer = @KntGIDNumer
	IF @ExpoKraj IS NULL
		SELECT @ExpoKraj = Knt_ExpoKraj
		FROM cdn.kntkarty
		WHERE knt_gidtyp = @KntGIDTyp
			AND knt_gidnumer = @KntGIDNumer

	--sprawdzenie poprawności NIP'u
	IF @ExpoKraj = 1
		--IF (
		--		upper(@NipPrefiks) = ''
		--		OR upper(@NipPrefiks) = 'PL'
		--		)
		--	AND UPPER(@Kraj) = 'PL'
	BEGIN
		SET @i = 1

		WHILE @i &lt;= LEN(@NipE)
		BEGIN
			IF NOT (
					ASCII(SUBSTRING(@NipE, @i, 1)) &gt;= 48
					AND ASCII(SUBSTRING(@NipE, @i, 1)) &lt;= 57
					OR ASCII(SUBSTRING(@NipE, @i, 1)) = 45
					OR ASCII(SUBSTRING(@NipE, @i, 1)) = 32
					)
			BEGIN
				RAISERROR (
						'Niepoprawny numer NIP [%s] - (44)'
						, 16
						, 1
						, @NipE
						)

				RETURN 44
			END

			SET @i = @i + 1
		END

		SET @Nip = REPLACE(@NipE, '-', '')

		IF @Nip &lt;&gt; ''
			AND LEN(@Nip) &lt;&gt; 10
		BEGIN
			RAISERROR (
					'Niepoprawny numer NIP [%s] - (44)'
					, 16
					, 1
					, @Nip
					)

			RETURN 44
		END
	END
	ELSE
		SET @Nip = REPLACE(@NipE, '-', '')

	--Set @SQLString = @SQLString + ',Knt_NipE=' +''''+@NipE+''''+',Knt_Nip='+''''+REPLACE(@NipE,'-','')+''''
	SET @SQLString = @SQLString + ',Knt_NipE=' + '''' + @NipE + '''' + ',Knt_Nip=' + '''' + @Nip + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		--Set @SQLStringAdr = @SQLStringAdr+',KnA_NipE='+''''+@NipE+''''+',KnA_Nip='+''''+REPLACE(@NipE,'-','')+''''
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_NipE=' + '''' + @NipE + '''' + ',KnA_Nip=' + '''' + @Nip + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Regon
-----------------------------------------------------------------------------------------------------
IF @Regon IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Regon=' + '''' + @Regon + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Regon=' + '''' + @Regon + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Pesel
-----------------------------------------------------------------------------------------------------
IF @Pesel IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Pesel=' + '''' + @Pesel + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Pesel=' + '''' + @Pesel + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_KontoDostawcy
-----------------------------------------------------------------------------------------------------
/*IF @KontoDostawcy is not null
BEGIN
    IF @KontoDostawcy &lt;&gt; ''
    BEGIN 
		IF not exists (select * from cdn.konta where kks_konto=@KontoDostawcy)	--spradzenie istnienia konta
		BEGIN
			RAISERROR('Podane konto dostawcy %s nie istnieje - (39)',16,1,@KontoDostawcy)
			RETURN 39
		END
	END
	
	Set @SQLString = @SQLString + ',Knt_KontoDostawcy=' +''''+@KontoDostawcy+''''
	IF @modType = 0 and @NowaKarta = 0   --tworzymy update na kntadresy
		Set @SQLStringAdr = @SQLStringAdr+',KnA_KontoDostawcy='+''''+@KontoDostawcy+''''
	ELSE								 --tworzymy insert
	BEGIN
		Set @SQLColumns = @SQLColumns + ',KnA_KontoDostawcy'
		Set @SQLValues = @SQLValues + ',' +''''+@KontoDostawcy+''''
	END
	Set @ModyfAdr = 1
END*/
-----------------------------------------------------------------------------------------------------
-- Knt_KontoOdbiorcy
-----------------------------------------------------------------------------------------------------
/*IF @KontoOdbiorcy is not null
BEGIN
	IF @KontoOdbiorcy &lt;&gt; ''
	BEGIN
		IF not exists (select * from cdn.konta where kks_konto=@KontoOdbiorcy)	--sprawdzenie istnienia konta
		BEGIN
			RAISERROR('Podane konto odbiorcy %s nie istnieje - (40)',16,1,@KontoOdbiorcy)
			RETURN 40
		END
	END	

	Set @SQLString = @SQLString + ',Knt_KontoOdbiorcy=' +''''+@KontoOdbiorcy+''''
	IF @modType = 0 and @NowaKarta = 0   --tworzymy update na kntadresy
		Set @SQLStringAdr = @SQLStringAdr+',KnA_KontoOdbiorcy='+''''+@KontoOdbiorcy+''''
	ELSE								 --tworzymy insert
	BEGIN
		Set @SQLColumns = @SQLColumns + ',KnA_KontoOdbiorcy'
		Set @SQLValues = @SQLValues + ',' +''''+@KontoOdbiorcy+''''	
	END
	Set @ModyfAdr = 1
END*/
-----------------------------------------------------------------------------------------------------
-- Knt_Telefon1
-----------------------------------------------------------------------------------------------------
IF @Telefon1 IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Telefon1=' + '''' + @Telefon1 + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Telefon1=' + '''' + @Telefon1 + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Telefon2
-----------------------------------------------------------------------------------------------------
IF @Telefon2 IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Telefon2=' + '''' + @Telefon2 + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Telefon2=' + '''' + @Telefon2 + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Fax
-----------------------------------------------------------------------------------------------------
IF @Fax IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Fax=' + '''' + @Fax + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Fax=' + '''' + @Fax + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Modem
-----------------------------------------------------------------------------------------------------
IF @Modem IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Modem=' + '''' + @Modem + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Modem=' + '''' + @Modem + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Telex
-----------------------------------------------------------------------------------------------------
IF @Telex IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Telex=' + '''' + @Telex + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Telex=' + '''' + @Telex + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_EMail
-----------------------------------------------------------------------------------------------------
IF @EMail IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_EMail=' + '''' + @EMail + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_EMail=' + '''' + @EMail + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Powiat
-----------------------------------------------------------------------------------------------------
IF @Powiat IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Powiat=' + '''' + @Powiat + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Powiat=' + '''' + @Powiat + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Gmina
-----------------------------------------------------------------------------------------------------
IF @Gmina IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Gmina=' + '''' + @Gmina + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Gmina=' + '''' + @Gmina + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_Wojewodztwo
-----------------------------------------------------------------------------------------------------
IF @Wojewodztwo IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_Wojewodztwo=' + '''' + @Wojewodztwo + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_Wojewodztwo=' + '''' + @Wojewodztwo + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_RegionCRM
-----------------------------------------------------------------------------------------------------
IF @RegionCRM IS NOT NULL
BEGIN
	IF @RegionCRM &lt;&gt; 0
	BEGIN
		IF NOT EXISTS (
				SELECT *
				FROM CDN.Rejony
				WHERE REJ_Id = @RegionCRM
				)
		BEGIN
			RAISERROR (
					'Nie znaleziono rejonu CRM [%d] - (6)'
					, 16
					, 1
					, @RegionCRM
					)

			RETURN 6
		END
	END

	SET @SQLString = @SQLString + ',Knt_RegionCRM=' + CAST(@RegionCRM AS VARCHAR)

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_RegionCRM=' + CAST(@RegionCRM AS VARCHAR)
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_GLN
-----------------------------------------------------------------------------------------------------
IF @GLN IS NOT NULL
BEGIN
	IF @GLN &lt;&gt; ''
	BEGIN
		EXECUTE @err = Cdn.PoliczCyfreKontrolnaGLN @GLN
			, @CyfraKontrolnaGLN OUTPUT

		IF @err &lt;&gt; 0
		BEGIN
			RAISERROR (
					'Nieprawidłowy numer GLN [%s]- (7)'
					, 16
					, 1
					, @GLN
					)

			RETURN 7
		END

		SET @SQLString = @SQLString + ',Knt_GLN=' + '''' + @GLN + CAST(@CyfraKontrolnaGLN AS VARCHAR) + ''''

		IF @modType = 0
			AND @NowaKarta = 0 --tworzymy update na kntadresy
			SET @SQLStringAdr = @SQLStringAdr + ',KnA_GLN=' + '''' + @GLN + CAST(@CyfraKontrolnaGLN AS VARCHAR) + ''''
		SET @ModyfAdr = 1
	END
	ELSE
	BEGIN
		SET @SQLString = @SQLString + ',Knt_GLN=' + '''' + @GLN + ''''

		IF @modType = 0
			AND @NowaKarta = 0 --tworzymy update na kntadresy
			SET @SQLStringAdr = @SQLStringAdr + ',KnA_GLN=' + '''' + @GLN + ''''
		SET @ModyfAdr = 1
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_NRB + Knt_NrRachunku
-----------------------------------------------------------------------------------------------------
IF @NRB IS NOT NULL
BEGIN
	IF @BnkTyp IS NOT NULL
		AND @BnkFirma IS NOT NULL
		AND @BnkNumer IS NOT NULL --podano bank
	BEGIN
		SELECT @BnkNrRachunku = bnk_numer
		FROM cdn.banki
		WHERE bnk_gidtyp = @BnkTyp
			AND bnk_gidfirma = @BnkFirma
			AND bnk_gidnumer = @BnkNumer
			AND bnk_nrb = 1
	END
	ELSE --nie podano banku
		--SELECT @BnkNrRachunku = bnk_numer
		--FROM cdn.kntkarty
		--INNER JOIN cdn.banki
		--	ON knt_bnktyp = bnk_gidtyp
		--		AND knt_bnkfirma = bnk_gidfirma
		--		AND knt_bnknumer = bnk_gidnumer
		--WHERE knt_gidtyp = @KntGIDTyp
		--	AND knt_gidfirma = @KntGIDFirma
		--	AND knt_gidnumer = @KntGIDnumer
		--	AND bnk_nrb = 1
		set @BnkNrRachunku = null

	IF @NRB IN (1, 0)
	BEGIN
		--sprawdzanie czy można zaznaczyć ten check
		IF @NRB = 1
		BEGIN
			IF @NrRachunku IS NULL --nie podano nowego numeru rachunku, trzeba pobrać z bazy
			BEGIN
				SELECT @NrRachunku = Knt_NrRachunku
				FROM cdn.kntkarty
				WHERE knt_gidtyp = @KntGIDTyp
					AND knt_gidfirma = @KntGIDFirma
					AND knt_gidnumer = @KntGIDNumer

				EXECUTE @err = Cdn.SprawdzPoprawnoscNRB @NrRachunku

				IF @err &lt;&gt; 0
					SET @NRB = 0
			END
			ELSE
			BEGIN
				IF @BnkNrRachunku IS NOT NULL
					AND len(@NRRachunku) &lt; 24
					AND charindex(@BnkNrRachunku, @NrRachunku) = 0
					SET @NrRachunku = @BnkNrRachunku + '-' + @NrRachunku

				EXECUTE @err = Cdn.SprawdzPoprawnoscNRB @NrRachunku OUTPUT --zwracany numer z cyframi kontrolnymi

				IF @err &lt;&gt; 0
					SET @NRB = 0
				--ELSE
				--BEGIN --numer poprawny
				--	SET @SQLString = @SQLString + ',Knt_NrRachunku=' + '''' + @NrRachunku + ''''

				--	IF @modType = 0
				--		AND @NowaKarta = 0 --tworzymy update na kntadresy
				--		SET @SQLStringAdr = @SQLStringAdr + ',KnA_NrRachunku=' + '''' + @NrRachunku + ''''
				--END
			END
		END
		ELSE IF @NRB = 0
			AND @NrRachunku IS NOT NULL
		BEGIN
			IF @BnkNrRachunku IS NOT NULL
				AND len(@NRRachunku) &lt; 24
				AND charindex(@BnkNrRachunku, @NrRachunku) = 0
				SET @NrRachunku = @BnkNrRachunku + '-' + @NrRachunku
			--SET @SQLString = @SQLString + ',Knt_NrRachunku=' + '''' + @NrRachunku + ''''

			--IF @modType = 0
			--	AND @NowaKarta = 0 --tworzymy update na kntadresy
			--	SET @SQLStringAdr = @SQLStringAdr + ',Kna_NrRachunku=' + '''' + @NrRachunku + ''''
		END

		--SET @SQLString = @SQLString + ',Knt_NRB=' + CAST(@NRB AS VARCHAR)

		--IF @modType = 0
		--	AND @NowaKarta = 0 --tworzymy update na kntadresy
		--	SET @SQLStringAdr = @SQLStringAdr + ',KnA_NRB=' + CAST(@NRB AS VARCHAR)
	END
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartość pola Knt_NRB [%d] - (8)'
				, 16
				, 1
				, @NRB
				)

		RETURN 8
	END

	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Knt_BnkGID + Knt_NrRachunku
-----------------------------------------------------------------------------------------------------
IF @BnkTyp IS NOT NULL
	AND @BnkFirma IS NOT NULL
	AND @BnkNumer IS NOT NULL
	AND @NrRachunku IS NOT NULL
	AND @BnkTyp &lt;&gt; 0
BEGIN
	--sprawdzenie czy bank istnieje
	IF NOT EXISTS (
			SELECT *
			FROM cdn.banki
			WHERE Bnk_GIDTyp = @BnkTyp
				AND Bnk_GIDFirma = @BnkFirma
				AND Bnk_GIDNumer = @BnkNumer
			) OR ( select COUNT(*) from CDN.RachunkiBankowe where RkB_ObiNumer = @KntGIDNumer and RkB_ObiTyp = @KntGIDTyp and RkB_BnkNumer = @BnkNumer and RkB_BnkTyp = @BnkTyp) &gt; 1
	BEGIN
		RAISERROR (
				'Podany bank nie istnieje [%d,%d,%d] lub kontrahent ma więcej niż jeden rachunek dla tego banku - (9)'
				, 16
				, 1
				, @BnkTyp
				, @BnkNumer
				, @BnkFirma
				)

		RETURN 9
	END
	ELSE
	BEGIN
		SELECT @BnkNrRachunku = Bnk_Numer
		FROM cdn.banki
		WHERE Bnk_GIDTyp = @BnkTyp
			AND Bnk_GIDFirma = @BnkFirma
			AND Bnk_GIDNumer = @BnkNumer

		--tutaj trzeba sprawdzać check nrb i poprawnosc numeru rachunku
		IF @NRB NOT IN (0, 1) --numer rachunku już jest
		--BEGIN
		--	SET @SQLString = @SQLString + ',Knt_BnkTyp=' + CAST(@BnkTyp AS VARCHAR) + ',Knt_BnkFirma=' + CAST(@BnkFirma AS VARCHAR) + ',Knt_BnkNumer=' + CAST(@BnkNumer AS VARCHAR)

			--IF @modType = 0
			--	AND @NowaKarta = 0 --tworzymy update na kntadresy
			--	SET @SQLStringAdr = @SQLStringAdr + ',KnA_BnkTyp=' + CAST(@BnkTyp AS VARCHAR) + ',KnA_BnkFirma=' + CAST(@BnkFirma AS VARCHAR) + ',KnA_BnkNumer=' + CAST(@BnkNumer AS VARCHAR) + ',KnA_BnkLp=0'
		--END
		--ELSE
		BEGIN
			-- trzeba sprawdzić jaki NRB jest ustawiony w bazie i ewentualnie policzyć numer rachunku z NRB
			SELECT @NRB = Knt_NRB
			FROM cdn.kntkarty
			WHERE knt_gidtyp = @KntGIDTyp
				AND knt_gidfirma = @KntGIDFirma
				AND knt_gidnumer = @KntGIDNumer

			IF len(@NRRachunku) &lt; 24
				AND charindex(@BnkNrRachunku, @NrRachunku) = 0
				SET @NrRachunku = @BnkNrRachunku + '-' + @NrRachunku

			IF (
					@NRB = 1
					AND @NrRachunku IS NOT NULL
					AND @BnkNrRachunku IS NOT NULL
					) --trzeba wyliczyć cyfry kontrolne a jak się nie da to przestawić NRB na 0
			BEGIN
				EXECUTE @err = Cdn.SprawdzPoprawnoscNRB @NrRachunku OUTPUT --zwracany numer z cyframi kontrolnymi

				IF @err &lt;&gt; 0
					SET @NRB = 0
			END

			--SET @SQLString = @SQLString + ',Knt_BnkTyp=' + CAST(@BnkTyp AS VARCHAR) + ',Knt_BnkFirma=' + CAST(@BnkFirma AS VARCHAR) + ',Knt_BnkNumer=' + CAST(@BnkNumer AS VARCHAR) + ',Knt_NRB= ' + CAST(@NRB AS VARCHAR) + ',Knt_NrRachunku=' + '''' + @NrRachunku + '''' --+@BnkNrRachunku+'-'

			--IF @modType = 0
			--	AND @NowaKarta = 0 --tworzymy update na kntadresy
			--	SET @SQLStringAdr = @SQLStringAdr + ',KnA_BnkTyp=' + CAST(@BnkTyp AS VARCHAR) + ',KnA_BnkFirma=' + CAST(@BnkFirma AS VARCHAR) + ',KnA_BnkNumer=' + CAST(@BnkNumer AS VARCHAR) + ',KnA_NRB= ' + CAST(@NRB AS VARCHAR) + ',KnA_BnkLp=0' + ',KnA_NrRachunku=' + '''' + @NrRachunku + ''''
		END
	END

	SET @ModyfAdr = 1
END
ELSE IF @BnkTyp = 0
	AND @BnkFirma = 0
	AND @BnkNumer = 0 --jeśli gid banku jest zerowy
BEGIN
	SET @NrRachunku = ''

	--IF PATINDEX('%Knt_NrRachunku%', @SQLString) = 0
	--	SET @SQLString = @SQLString + ',Knt_BnkTyp=' + CAST(@BnkTyp AS VARCHAR) + ',Knt_BnkFirma=' + CAST(@BnkFirma AS VARCHAR) + ',Knt_BnkNumer=' + CAST(@BnkNumer AS VARCHAR) + ',Knt_NrRachunku=' + '''' + @NrRachunku + ''''
	--ELSE
	--	SET @SQLString = @SQLString + ',Knt_BnkTyp=' + CAST(@BnkTyp AS VARCHAR) + ',Knt_BnkFirma=' + CAST(@BnkFirma AS VARCHAR) + ',Knt_BnkNumer=' + CAST(@BnkNumer AS VARCHAR)

	--IF @modType = 0
	--	AND @NowaKarta = 0 --tworzymy update na kntadresy
	--	IF PATINDEX('%KnA_NrRachunku%', @SQLStringAdr) = 0
	--		SET @SQLStringAdr = @SQLStringAdr + ',KnA_BnkTyp=' + CAST(@BnkTyp AS VARCHAR) + ',KnA_BnkFirma=' + CAST(@BnkFirma AS VARCHAR) + ',KnA_BnkNumer=' + CAST(@BnkNumer AS VARCHAR) + ',KnA_BnkLp=0' + ',KnA_NrRachunku=' + '''' + @NrRachunku + ''''
	--	ELSE
	--		SET @SQLStringAdr = @SQLStringAdr + ',KnA_BnkTyp=' + CAST(@BnkTyp AS VARCHAR) + ',KnA_BnkFirma=' + CAST(@BnkFirma AS VARCHAR) + ',KnA_BnkNumer=' + CAST(@BnkNumer AS VARCHAR) + ',KnA_BnkLp=0'

	--SET @ModyfAdr = 1
END
--ELSE IF @NrRachunku IS NOT NULL
--	AND EXISTS (
--		SELECT *
--		FROM cdn.kntkarty
--		INNER JOIN cdn.banki
--			ON knt_bnktyp = bnk_gidtyp
--				AND knt_bnknumer = bnk_gidnumer
--				AND knt_bnklp = bnk_gidlp
--		WHERE knt_gidtyp = @KntGIDTyp
--			AND knt_gidnumer = @KntGIDNumer
--		)
--BEGIN
--	SELECT @BnkNrRachunku = Bnk_Numer
--	FROM cdn.kntkarty
--	INNER JOIN cdn.banki
--		ON knt_bnktyp = bnk_gidtyp
--			AND knt_bnknumer = bnk_gidnumer
--			AND knt_bnklp = bnk_gidlp
--	WHERE knt_gidtyp = @KntGIDTyp
--		AND knt_gidnumer = @KntGIDNumer

--	SELECT @NRB = Knt_NRB
--	FROM cdn.kntkarty
--	WHERE knt_gidtyp = @KntGIDTyp
--		AND knt_gidfirma = @KntGIDFirma
--		AND knt_gidnumer = @KntGIDNumer

--	IF len(@NRRachunku) &lt; 24
--		AND charindex(@BnkNrRachunku, @NrRachunku) = 0
--		SET @NrRachunku = @BnkNrRachunku + '-' + @NrRachunku

--	IF (
--			@NRB = 1
--			AND @NrRachunku IS NOT NULL
--			) --trzeba wyliczyć cyfry kontrolne a jak się nie da to przestawić NRB na 0
--	BEGIN
--		EXECUTE @err = Cdn.SprawdzPoprawnoscNRB @NrRachunku OUTPUT --zwracany numer z cyframi kontrolnymi

--		IF @err &lt;&gt; 0
--			SET @NRB = 0
--	END

--	--SET @SQLString = @SQLString + ',Knt_NRB= ' + CAST(@NRB AS VARCHAR) + ',Knt_NrRachunku=' + '''' + @NrRachunku + ''''

--	--IF @modType = 0
--	--	AND @NowaKarta = 0 --tworzymy update na kntadresy
--	--	SET @SQLStringAdr = @SQLStringAdr + ',KnA_NRB= ' + CAST(@NRB AS VARCHAR) + ',KnA_NrRachunku=' + '''' + @NrRachunku + ''''
--	--SET @ModyfAdr = 1
--END

-----------------------------------------------------------------------------------------------------
-- Knt_URL
-----------------------------------------------------------------------------------------------------
IF @URL IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_URL=' + '''' + @URL + ''''

-----------------------------------------------------------------------------------------------------
-- Knt_Rabat
-----------------------------------------------------------------------------------------------------
IF @Rabat IS NOT NULL
BEGIN
	IF @Rabat &lt;= 99.99
		AND @Rabat &gt;= 0.00
		SET @SQLString = @SQLString + ',Knt_Rabat=' + CAST(@Rabat AS VARCHAR)
	ELSE
	BEGIN
		DECLARE @RabatStr VARCHAR(10)

		SET @RabatStr = @Rabat

		RAISERROR (
				'Rabat przekracza wartość dopuszczalną [%s] - (10)'
				, 16
				, 1
				, @RabatStr
				)

		RETURN 10
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_LimitTerminowy
-----------------------------------------------------------------------------------------------------
IF @LimitTerminowy IS NOT NULL
BEGIN
	IF @LimitTerminowy IN (0, 1)
		SET @SQLString = @SQLString + ',Knt_LimitTerminowy=' + CAST(@LimitTerminowy AS VARCHAR)
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartość pola Knt_LimitTerminowy [%d] - (31)'
				, 16
				, 1
				, @LimitTerminowy
				)

		RETURN 31
	END
END

IF @LimitTerminowy = 0
BEGIN
	SET @MaxLimitWart = 0
	SET @LimitPoTerminie = 0
END

-----------------------------------------------------------------------------------------------------
-- Knt_MaxLimitWart
-----------------------------------------------------------------------------------------------------
IF @MaxLimitWart IS NOT NULL
BEGIN
	SELECT @OpeLimitKredytu = Ope_LimitKredytu
		, @LimitBezOgraniczenia = Ope_LimitBezOgraniczenia
	FROM cdn.opekarty
	WHERE ope_gidtyp = @OpeGIDTyp
		AND ope_gidfirma = @OpeGIDFirma
		AND ope_gidnumer = @OpeGIDNumer

	IF @MaxLimitWart &gt; @OpeLimitKredytu
		AND @LimitBezOgraniczenia = 0
		SET @MaxLimitWart = @OpeLimitKredytu
	SET @SQLString = @SQLString + ',Knt_MaxLimitWart=' + CAST(@MaxLimitWart AS VARCHAR)
END

-----------------------------------------------------------------------------------------------------
-- Knt_LimitPoTerminie
-----------------------------------------------------------------------------------------------------
IF @LimitPoTerminie IS NOT NULL
BEGIN
	SELECT @OpeLimitPoTerminie = Ope_LimitPoTerminie
		, @LimitBezOgraniczenia = Ope_LimitBezOgraniczenia
	FROM cdn.opekarty
	WHERE ope_gidtyp = @OpeGIDTyp
		AND ope_gidfirma = @OpeGIDFirma
		AND ope_gidnumer = @OpeGIDNumer

	IF @LimitPoTerminie &gt; @OpeLimitPoTerminie
		AND @LimitBezOgraniczenia = 0
		SET @LimitPoTerminie = @OpeLimitPoTerminie
	SET @SQLString = @SQLString + ',Knt_LimitPoTerminie=' + CAST(@LimitPoTerminie AS VARCHAR)
END

-----------------------------------------------------------------------------------------------------
-- Knt_LimitOkres
-----------------------------------------------------------------------------------------------------
IF @LimitOkres IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_LimitOkres=' + CAST(@LimitOkres AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_Dewizowe
-----------------------------------------------------------------------------------------------------
IF @Dewizowe IS NOT NULL
BEGIN
	IF @Dewizowe IN (0, 1)
		SET @SQLString = @SQLString + ',Knt_Dewizowe=' + CAST(@Dewizowe AS VARCHAR)
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartość pola Knt_Dewizowe [%d] - (11)'
				, 16
				, 1
				, @Dewizowe
				)

		RETURN 11
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_Symbol
-----------------------------------------------------------------------------------------------------
IF @Symbol IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_Symbol=' + '''' + @Symbol + ''''

-----------------------------------------------------------------------------------------------------
-- Knt_Cena
-----------------------------------------------------------------------------------------------------
IF @Cena IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_Cena=' + CAST(@Cena AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_FormaPl
-----------------------------------------------------------------------------------------------------
IF @FormaPl IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_FormaPl=' + CAST(@FormaPl AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_Marza
-----------------------------------------------------------------------------------------------------
IF @Marza IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_Marza=' + CAST(@Marza AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_TypKarty
-----------------------------------------------------------------------------------------------------
IF @TypKarty IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_TypKarty=' + CAST(@TypKarty AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_NumerKarty
-----------------------------------------------------------------------------------------------------
IF @NumerKarty IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_NumerKarty=' + '''' + @NumerKarty + ''''

-----------------------------------------------------------------------------------------------------
-- Knt_DataKarty
-----------------------------------------------------------------------------------------------------
IF @DataKarty IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_DataKarty=' + CAST(@DataKarty AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_Ean + obsługa pól i EanGID
-----------------------------------------------------------------------------------------------------
IF @Ean IS NOT NULL
BEGIN
	IF @Ean &lt;&gt; ''
		SET @SQLString = @SQLString + ',Knt_Ean=' + '''' + @Ean + '''' --+',Knt_EanTyp=0,Knt_EanFirma=0,Knt_EanNumer=0'
	ELSE
		SET @SQLString = @SQLString + ',Knt_Ean=' + '''' + '''' --+',Knt_EanTyp='+CAST(@KntGIDTyp as varchar)+
			--',Knt_EanFirma='+CAST(@KntGIDFirma as varchar)+',Knt_EanNumer='+CAST(@KntGIDNumer as varchar)
END

-----------------------------------------------------------------------------------------------------
-- Knt_ObcaKarta
-----------------------------------------------------------------------------------------------------
IF @ObcaKarta IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_ObcaKarta=' + CAST(@ObcaKarta AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_SeriaFa
--------------------------------------------------------------------------------------------------
IF @SeriaFa IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_SeriaFa=' + '''' + @SeriaFa + ''''

-----------------------------------------------------------------------------------------------------
-- Knt_Status
--------------------------------------------------------------------------------------------------
IF @Status IS NOT NULL
BEGIN
	IF @Status = 1
		OR (
			@Status = 2
			AND isnull(@PlatnikVat, (
					SELECT Knt_PlatnikVat
					FROM cdn.KntKarty
					WHERE Knt_GidNumer = @KntGIDNumer
					)) = 0
			)
		SET @SQLString = @SQLString + ',Knt_Status=' + CAST(@Status AS VARCHAR)
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartość pola Knt_Status [%d] - (14)'
				, 16
				, 1
				, @Status
				)

		RETURN 14
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_SposobDostawy
--------------------------------------------------------------------------------------------------
IF @SposobDostawy IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_SposobDostawy=' + '''' + @SposobDostawy + ''''

-----------------------------------------------------------------------------------------------------
-- Knt_Dzialalnosc
--------------------------------------------------------------------------------------------------
IF @Dzialalnosc IS NOT NULL
BEGIN
	IF @Dzialalnosc IN (0, 1, 2, 3, 4, 5, 6, 7, 8, 9)
		SET @SQLString = @SQLString + ',Knt_Dzialalnosc=' + CAST(@Dzialalnosc AS VARCHAR)
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartość pola Knt_Dzialalnosc [%d] - (16)'
				, 16
				, 1
				, @Dzialalnosc
				)

		RETURN 16
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_AkwGID + obsługa
--------------------------------------------------------------------------------------------------
IF @AkwTyp IS NOT NULL
	AND @AkwFirma IS NOT NULL
	AND @AkwNumer IS NOT NULL
BEGIN
	IF @AkwTyp &lt;&gt; 0
		AND @AkwFirma &lt;&gt; 0
		AND @AkwNumer &lt;&gt; 0
	BEGIN
		IF NOT EXISTS (
				SELECT *
				FROM cdn.kntkarty
				WHERE knt_gidtyp = @AkwTyp
					AND knt_gidfirma = @AkwFirma
					AND knt_gidnumer = @AkwNumer
					AND knt_akwizytor = 1
				)
			AND NOT EXISTS (
				SELECT *
				FROM cdn.prckarty
				WHERE prc_gidtyp = @AkwTyp
					AND prc_gidfirma = @AkwFirma
					AND prc_gidnumer = @AkwNumer
				)
		BEGIN
			RAISERROR (
					'Nie znaleziono akwizytora [%d,%d,%d] - (17)'
					, 16
					, 1
					, @AkwTyp
					, @AkwNumer
					, @AkwFirma
					)

			RETURN 17
		END
	END

	SET @SQLString = @SQLString + ',Knt_AkwTyp=' + CAST(@AkwTyp AS VARCHAR) + ',Knt_AkwFirma=' + CAST(@AkwFirma AS VARCHAR) + ',Knt_AkwNumer=' + CAST(@AkwNumer AS VARCHAR)
END

-----------------------------------------------------------------------------------------------------
-- Knt_AkwProwizja
--------------------------------------------------------------------------------------------------
IF @AkwProwizja IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_AkwProwizja=' + CAST(@AkwProwizja AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_Umowa
--------------------------------------------------------------------------------------------------
IF @Umowa IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_Umowa=' + '''' + @Umowa + ''''

-----------------------------------------------------------------------------------------------------
-- Knt_DataW
--------------------------------------------------------------------------------------------------	
IF @DataW IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_DataW=' + CAST(@DataW AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_FaVATOsw
-----------------------------------------------------------------------------------------------------
IF @FaVATOsw IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_FaVATOsw=' + '''' + @FaVATOsw + ''''

-----------------------------------------------------------------------------------------------------
-- Knt_FaVATData
-----------------------------------------------------------------------------------------------------
IF @FaVATData IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_FaVATData=' + CAST(@FaVATData AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_CechaOpis
-----------------------------------------------------------------------------------------------------
IF @CechaOpis IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_CechaOpis=' + '''' + @CechaOpis + ''''

-----------------------------------------------------------------------------------------------------
-- Knt_Wsk
-----------------------------------------------------------------------------------------------------
IF @Wsk IS NOT NULL
BEGIN
	IF @Wsk IN (0, 4) --pole 'nie publikuj' możliwe tylko 0 lub 4
		SET @SQLString = @SQLString + ',Knt_Wsk=' + CAST(@Wsk AS VARCHAR)
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartość pola Knt_Wsk [%d] - (18)'
				, 16
				, 1
				, @Wsk
				)

		RETURN 18
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_PrcGID + obsługa
-----------------------------------------------------------------------------------------------------
IF @PrcTyp IS NOT NULL
	AND @PrcFirma IS NOT NULL
	AND @PrcNumer IS NOT NULL
BEGIN
	IF @PrcTyp &lt;&gt; 0
		AND @PrcFirma &lt;&gt; 0
		AND @PrcNumer &lt;&gt; 0
	BEGIN
		IF NOT EXISTS (
				SELECT *
				FROM cdn.prckarty
				WHERE prc_gidtyp = @PrcTyp
					AND prc_gidfirma = @PrcFirma
					AND prc_gidnumer = @PrcNumer
				)
		BEGIN
			RAISERROR (
					'Nie znaleziono pracownika [%d,%d,%d] - (19)'
					, 16
					, 1
					, @PrcTyp
					, @PrcNumer
					, @PrcFirma
					)

			RETURN 19
		END
	END

	SET @SQLString = @SQLString + ',Knt_PrcTyp=' + CAST(@PrcTyp AS VARCHAR) + ',Knt_PrcFirma=' + CAST(@PrcFirma AS VARCHAR) + ',Knt_PrcNumer=' + CAST(@PrcNumer AS VARCHAR)
END

-----------------------------------------------------------------------------------------------------
-- Knt_ESklep
-----------------------------------------------------------------------------------------------------
IF @ESklep IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_ESklep=' + CAST(@ESklep AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- KAp_CzyPotwierdzone
-----------------------------------------------------------------------------------------------------
IF @AutoPotwierdzenie IS NOT NULL
BEGIN
	IF @AutoPotwierdzenie NOT IN (0, 1)
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartość pola KAp_CzyPotwierdzone [%d] - (20)'
				, 16
				, 1
				, @AutoPotwierdzenie
				)

		RETURN 20
	END
END

-----------------------------------------------------------------------------------------------------
-- KAp_MagGID + obsługa
-----------------------------------------------------------------------------------------------------
IF @MagTyp IS NOT NULL
	AND @MagFirma IS NOT NULL
	AND @MagNumer IS NOT NULL
BEGIN
	IF @MagTyp &lt;&gt; 0
		AND @MagFirma &lt;&gt; 0
		AND @MagNumer &lt;&gt; 0
	BEGIN
		IF NOT EXISTS (
				SELECT *
				FROM CDN.KntMagazyny
				WHERE KnM_KntTyp = @KntGIDTyp
					AND KnM_KntNumer = @KntGIDNumer
					AND KnM_MagNumer = @MagNumer
				)
		BEGIN
			RAISERROR (
					'Nie znaleziono magazynu [%d] - (21)'
					, 16
					, 1
					, @MagNumer
					)

			RETURN 21
		END
	END
END

-----------------------------------------------------------------------------------------------------
-- KAp_OpeNumer
-----------------------------------------------------------------------------------------------------
IF isnull(@OpeNumerW,0) &gt; 0 --Bug #258473  
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.OpeKarty
			WHERE Ope_GIDNumer = @OpeNumerW
			)
	BEGIN
		--ROLLBACK TRAN
		RAISERROR (
				'Nie znaleziono operatora wystawiającego [%d] - (47)'
				, 16
				, 1
				, @OpeNumerW
				)

		RETURN 47
	END
END

-----------------------------------------------------------------------------------------------------   
-- KAp_OpeONumer
-----------------------------------------------------------------------------------------------------
IF @OpeNumerO IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.OpeKarty
			WHERE Ope_GIDNumer = @OpeNumerO
			)
	BEGIN
		--ROLLBACK TRAN
		RAISERROR (
				'Nie znaleziono operatora odpowiedzialnego za realizację [%d] - (48)'
				, 16
				, 1
				, @OpeNumerO
				)

		RETURN 48
	END
END

----------------------------------------------------------------------------------------------------- 
-- KAp_TwrGrupaNumer
-----------------------------------------------------------------------------------------------------
IF @TwrGrupaNumer IS NOT NULL
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM CDN.TwrGrupy
			WHERE TwG_GIDTyp = - 16
				AND TwG_GIDNumer = @TwrGrupaNumer
			)
	BEGIN
		--ROLLBACK TRAN
		RAISERROR (
				'Nie znaleziono grupy towarów udostępnionej kontrahentowi [%d] - (49)'
				, 16
				, 1
				, @TwrGrupaNumer
				)

		RETURN 49
	END
END

-----------------------------------------------------------------------------------------------------
-- KAp_MagMSGID + obsługa
-----------------------------------------------------------------------------------------------------
IF @MagMSTyp IS NOT NULL
	AND @MagMSFirma IS NOT NULL
	AND @MagMSNumer IS NOT NULL
BEGIN
	IF @MagMSTyp &lt;&gt; 0
		AND @MagMSFirma &lt;&gt; 0
		AND @MagMSNumer &lt;&gt; 0
	BEGIN
		IF NOT EXISTS (
				SELECT *
				FROM CDN.KntMagazyny
				WHERE KnM_KntTyp = @KntGIDTyp
					AND KnM_KntNumer = @KntGIDNumer
					AND KnM_MagNumer = @MagMSNumer
				)
		BEGIN
			RAISERROR (
					'Nie znaleziono magazynu [%d] - (50)'
					, 16
					, 1
					, @MagMSNumer
					)

			RETURN 50
		END
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_OutlookUrl
-----------------------------------------------------------------------------------------------------
IF @OutlookUrl IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_OutlookUrl=' + '''' + @OutlookUrl + ''''

-----------------------------------------------------------------------------------------------------
-- Knt_Zrodlo
-----------------------------------------------------------------------------------------------------
IF @Zrodlo IS NOT NULL
BEGIN
	IF @Zrodlo &lt;&gt; 0
	BEGIN
		IF NOT EXISTS (
				SELECT *
				FROM CDN.Slowniki
				INNER JOIN CDN.SlownikiStruktura
					ON SLW_SLSId = SLS_Id
				WHERE SLS_Predefiniowany = 18 /*e_sls_ZrodlaPochodzenia*/
					AND SLW_ID = @Zrodlo
				) --'Źródło pochodzenia'
		BEGIN
			RAISERROR (
					'Nie znaleziono wartości kategorii spośród kategorii Źródło pochodzenia [%d] - (22)'
					, 16
					, 1
					, @Zrodlo
					)

			RETURN 22
		END
	END

	SET @SQLString = @SQLString + ',Knt_Zrodlo=' + CAST(@Zrodlo AS VARCHAR)
END

-----------------------------------------------------------------------------------------------------
-- Knt_Branza
-----------------------------------------------------------------------------------------------------
IF @Branza IS NOT NULL
BEGIN
	IF @Branza &lt;&gt; 0
	BEGIN
		IF NOT EXISTS (
				SELECT *
				FROM CDN.Slowniki
				INNER JOIN CDN.SlownikiStruktura
					ON SLW_SLSId = SLS_Id
				WHERE SLS_Predefiniowany = 9 /*e_sls_BranzeKontrahentow*/
					AND SLW_ID = @Branza
				) --'Branża kontrahenta')
		BEGIN
			RAISERROR (
					'Nie znaleziono wartości kategorii spośród kategorii Branża kontrahenta [%d] - (23)'
					, 16
					, 1
					, @Branza
					)

			RETURN 23
		END
	END

	SET @SQLString = @SQLString + ',Knt_Branza=' + CAST(@Branza AS VARCHAR)
END

-----------------------------------------------------------------------------------------------------
-- Knt_Rodzaj
-----------------------------------------------------------------------------------------------------
IF @Rodzaj IS NOT NULL
BEGIN
	IF @Rodzaj &lt;&gt; 0
	BEGIN
		IF NOT EXISTS (
				SELECT *
				FROM CDN.Slowniki
				INNER JOIN CDN.SlownikiStruktura
					ON SLW_SLSId = SLS_Id
				WHERE SLS_Predefiniowany = 14 /*e_sls_RodzajeKontrahentow*/
					AND SLW_ID = @Rodzaj
				) --'Rodzaj kontrahenta')
		BEGIN
			RAISERROR (
					'Nie znaleziono wartości kategorii spośród kategorii Rodzaj kontrahenta [%d] - (24)'
					, 16
					, 1
					, @Rodzaj
					)

			RETURN 24
		END
	END

	SET @SQLString = @SQLString + ',Knt_Rodzaj=' + CAST(@Rodzaj AS VARCHAR)
END

-----------------------------------------------------------------------------------------------------
-- Knt_RolaPartnera
-----------------------------------------------------------------------------------------------------
IF @RolaPartnera IS NOT NULL
BEGIN
	IF @RolaPartnera &lt;&gt; 0
	BEGIN
		IF NOT EXISTS (
				SELECT *
				FROM CDN.Slowniki
				INNER JOIN CDN.SlownikiStruktura
					ON SLW_SLSId = SLS_Id
				WHERE SLS_Predefiniowany = 16 /*e_sls_RolePartnera*/
					AND SLW_ID = @RolaPartnera
				) --'Rola partnera')
		BEGIN
			RAISERROR (
					'Nie znaleziono wartości kategorii spośród kategorii Rola partnera [%d] - (25)'
					, 16
					, 1
					, @RolaPartnera
					)

			RETURN 25
		END
	END

	SET @SQLString = @SQLString + ',Knt_RolaPartnera=' + CAST(@RolaPartnera AS VARCHAR)
END

-----------------------------------------------------------------------------------------------------
-- Knt_Priorytet
-----------------------------------------------------------------------------------------------------
IF @Priorytet IS NOT NULL
BEGIN
	IF @Priorytet &lt;&gt; 0
	BEGIN
		IF NOT EXISTS (
				SELECT *
				FROM CDN.Slowniki
				INNER JOIN CDN.SlownikiStruktura
					ON SLW_SLSId = SLS_Id
				WHERE SLS_Predefiniowany = 12 /*e_sls_PriorytetyKontrahentow*/
					AND SLW_ID = @Priorytet
				) --'Priorytet kontrahenta')
		BEGIN
			RAISERROR (
					'Nie znaleziono wartości kategorii spośród kategorii Priorytet kontrahenta [%d] - (26)'
					, 16
					, 1
					, @Priorytet
					)

			RETURN 26
		END
	END

	SET @SQLString = @SQLString + ',Knt_Priorytet=' + CAST(@Priorytet AS VARCHAR)
END

-----------------------------------------------------------------------------------------------------
-- Knt_PriorytetRez
-----------------------------------------------------------------------------------------------------
IF @PriorytetRez IS NOT NULL
BEGIN
	BEGIN
		IF NOT EXISTS (
				SELECT *
				FROM CDN.Slowniki
				INNER JOIN CDN.SlownikiStruktura
					ON SLW_SLSId = SLS_Id
				WHERE SLS_Predefiniowany = 55 /*e_sls_PriorytetyRezerwacji*/
					AND SLW_WartoscL1 = @PriorytetRez
				) --'Priorytety rezerwacji')
		BEGIN
			RAISERROR (
					'Nie znaleziono wartości kategorii spośród kategorii Priorytety rezerwacji [%d] - (43)'
					, 16
					, 1
					, @PriorytetRez
					)

			RETURN 43
		END
	END

	IF (
			SELECT CASE WHEN EXISTS (
							SELECT ope_priorytetrez
								, *
							FROM cdn.opekarty
							WHERE ope_gidtyp = @OpeGIDTyp
								AND ope_gidnumer = @OpeGIDNumer
								AND ope_priorytetrez = 1
							) THEN 1 ELSE 0 END
			) = 1
		SET @SQLString = @SQLString + ',Knt_PriorytetRez=' + CAST(@PriorytetRez AS VARCHAR)
END

-----------------------------------------------------------------------------------------------------
-- Knt_Odleglosc
-----------------------------------------------------------------------------------------------------
IF @Odleglosc IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_Odleglosc=' + CAST(@Odleglosc AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_KarGID + obsługa
-----------------------------------------------------------------------------------------------------
IF @KarTyp IS NOT NULL
	AND @KarFirma IS NOT NULL
	AND @KarNumer IS NOT NULL
BEGIN
	IF @KarTyp &lt;&gt; 0
		AND @KarFirma &lt;&gt; 0
		AND @KarNumer &lt;&gt; 0
	BEGIN
		IF NOT EXISTS (
				SELECT *
				FROM cdn.rejestry
				WHERE kar_gidtyp = @KarTyp
					AND kar_gidfirma = @KarFirma
					AND kar_gidnumer = @KarNumer
				) OR (select COUNT(*) from CDN.KntRejestr where KRj_ObiNumer = @KntGIDNumer and KRj_ObiTyp = @KntGIDTyp and KRj_TypRejestru = 0) &gt; 1
		BEGIN
			RAISERROR (
					'Nie znaleziono rejestru [%d,%d,%d] lub kontrahent ma więcej niż jeden rejest rozliczeniowy - (27)'
					, 16
					, 1
					, @KarTyp
					, @KarNumer
					, @KarFirma
					)

			RETURN 27
		END
	END

	--SET @SQLString = @SQLString + ',Knt_KarTyp=' + CAST(@KarTyp AS VARCHAR) + ',Knt_KarFirma=' + CAST(@KarFirma AS VARCHAR) + ',Knt_KarNumer=' + CAST(@KarNumer AS VARCHAR)
END

-----------------------------------------------------------------------------------------------------
-- Knt_Archiwalny
-----------------------------------------------------------------------------------------------------
IF @Archiwalny IS NOT NULL
BEGIN
	IF @Archiwalny IN (0, 1)
		SET @SQLString = @SQLString + ',Knt_Archiwalny=' + CAST(@Archiwalny AS VARCHAR)
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartość pola Knt_Archiwalny [%d] - (41)'
				, 16
				, 1
				, @Archiwalny
				)

		RETURN 41
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_AdresNieAktualny
-----------------------------------------------------------------------------------------------------
IF @AdresNieAktualny IS NOT NULL
BEGIN
	IF @AdresNieAktualny IN (0, 1)
		SET @SQLString = @SQLString + ',Knt_AdresNieAktualny=' + CAST(@AdresNieAktualny AS VARCHAR)
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartość pola Knt_AdresNieAktualny [%d] - (42)'
				, 16
				, 1
				, @AdresNieAktualny
				)

		RETURN 42
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_BlokadaTransakcji + obsługa(operator blokujący transakcje)
-----------------------------------------------------------------------------------------------------
IF @BlokadaTransakcji IS NOT NULL
BEGIN
	IF @BlokadaTransakcji IN (0, 1)
		SET @SQLString = @SQLString + ',Knt_BlokadaTransakcji=' + CAST(@BlokadaTransakcji AS VARCHAR) + ',Knt_LastTransLockDate=' + CAST(datediff(s, '19900101', getdate()) AS VARCHAR) + ',Knt_ZtrTyp=' + CAST(@OpeGIDTyp AS VARCHAR) + ',Knt_ZtrFirma=' + CAST(@OpeGIDFirma AS VARCHAR) + ',Knt_ZtrNumer=' + CAST(@OpeGIDNumer AS VARCHAR)
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartość pola Knt_BlokadaTransakcji [%d] - (29)'
				, 16
				, 1
				, @BlokadaTransakcji
				)

		RETURN 29
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_Spedytor
-----------------------------------------------------------------------------------------------------
IF @Spedytor IS NOT NULL
BEGIN
	IF @Spedytor IN (0, 1)
		SET @SQLString = @SQLString + ',Knt_Spedytor=' + CAST(@Spedytor AS VARCHAR)
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartość pola Knt_Spedytor [%d] - (30)'
				, 16
				, 1
				, @Spedytor
				)

		RETURN 30
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_TerminPlZak
-----------------------------------------------------------------------------------------------------
IF @TerminPlZak IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_TerminPlZak=' + CAST(@TerminPlZak AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_FormaPlZak
-----------------------------------------------------------------------------------------------------	
IF @FormaPlZak IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_FormaPlZak=' + CAST(@FormaPlZak AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_SpTerminPlSpr
-----------------------------------------------------------------------------------------------------
IF @SpTerminPlSpr IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_SpTerminPlSpr=' + CAST(@SpTerminPlSpr AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_SpTerminPlZak
-----------------------------------------------------------------------------------------------------
IF @SpTerminPlZak IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_SpTerminPlZak=' + CAST(@SpTerminPlZak AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_TerminRozliczeniaKaucji
-----------------------------------------------------------------------------------------------------
IF @TerminRozliczeniaKaucji IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_TerminRozliczeniaKaucji=' + CAST(@TerminRozliczeniaKaucji AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_PlatnoscKaucji
-----------------------------------------------------------------------------------------------------
IF @PlatnoscKaucji IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_PlatnoscKaucji=' + CAST(@PlatnoscKaucji AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Kontrahent główny
-----------------------------------------------------------------------------------------------------	
IF @KnGTyp = 32
BEGIN
	IF EXISTS (
			SELECT *
			FROM cdn.kntkarty
			WHERE knt_gidnumer = @KnGNumer
			)
		SET @SQLString = @SQLString + ',Knt_KnGTyp=' + CAST(@KnGTyp AS VARCHAR) + ',Knt_KnGNumer=' + CAST(@KnGNumer AS VARCHAR)
END

-----------------------------------------------------------------------------------------------------
-- Knt_Platnik
-----------------------------------------------------------------------------------------------------
SET @PlatnikIstnieje = 0

IF @KnPTyp = 32
BEGIN
	IF EXISTS (
			SELECT *
			FROM cdn.kntkarty
			WHERE knt_gidnumer = @KnPNumer
			)
		SET @PlatnikIstnieje = 1
END
ELSE IF @KnPTyp = 48
BEGIN
	IF EXISTS (
			SELECT *
			FROM cdn.banki
			WHERE bnk_gidnumer = @KnPNumer
			)
		SET @PlatnikIstnieje = 1
END
ELSE IF @KnPTyp = 4304
BEGIN
	IF EXISTS (
			SELECT *
			FROM cdn.urzedy
			WHERE urz_gidnumer = @KnPNumer
			)
		SET @PlatnikIstnieje = 1
END
ELSE IF @KnPTyp = 944
BEGIN
	IF EXISTS (
			SELECT *
			FROM cdn.prckarty
			WHERE prc_gidnumer = @KnPNumer
			)
		SET @PlatnikIstnieje = 1
END

IF @PlatnikIstnieje = 1
	SET @SQLString = @SQLString + ',Knt_KnPTyp=' + CAST(@KnPTyp AS VARCHAR) + ',Knt_KnPNumer=' + CAST(@KnPNumer AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_KnPParam
-----------------------------------------------------------------------------------------------------
IF @KnPParam IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_KnPParam=' + CAST(@KnPParam AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_DataWygasniecia
-----------------------------------------------------------------------------------------------------
IF @DataWygasniecia IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_DataWygasniecia=' + CAST(@DataWygasniecia AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_MaxDniPoTerminie
-----------------------------------------------------------------------------------------------------
IF @MaxDniPoTerminie IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_MaxDniPoTerminie=' + CAST(@MaxDniPoTerminie AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_PIN
-----------------------------------------------------------------------------------------------------
IF @PIN IS NOT NULL
	SET @SQLString = @SQLString + ',Knt_PIN=' + '''' + @PIN + ''''

-----------------------------------------------------------------------------------------------------
-- Knt_Oddzialowy
-----------------------------------------------------------------------------------------------------	
IF @Oddzialowy IN (0, 1)
	SET @SQLString = @SQLString + ',Knt_Oddzialowy=' + CAST(@Oddzialowy AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- Knt_Powiazany
-----------------------------------------------------------------------------------------------------	
IF @Powiazany IN (0, 1)
	SET @SQLString = @SQLString + ',Knt_Powiazany=' + CAST(@Powiazany AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- MSTwrGrupaNumer
-----------------------------------------------------------------------------------------------------	
IF EXISTS (
		SELECT *
		FROM cdn.TwrGrupy
		WHERE TwG_GIDNumer = @MSTwrGrupaNumer
			AND TwG_GIDTyp = - 16
		)
	SET @SQLString = @SQLString + ',Knt_MSTwrGrupaNumer=' + CAST(@MSTwrGrupaNumer AS VARCHAR)

-----------------------------------------------------------------------------------------------------
-- RolnikRyczaltowy
-----------------------------------------------------------------------------------------------------	
IF @RolnikRyczaltowy IN (0, 1)
BEGIN
	SET @SQLString = @SQLString + ',Knt_RolnikRyczaltowy=' + CAST(@RolnikRyczaltowy AS VARCHAR)

	IF @modType = 0	AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_RolnikRyczaltowy=' + CAST(@RolnikRyczaltowy AS VARCHAR)

	SET @ModyfAdr = 1
END

--ERPXL-12111
IF @RolnikRyczaltowy = 0 AND @PlatnikVat = 0
		SET @SQLString = @SQLString + ',Knt_MetodaKasowa=0'

IF @modType = 0	AND @NowaKarta = 0 AND (@RolnikRyczaltowy = 0 AND @PlatnikVat = 0)
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_MetodaKasowa=0'

-----------------------------------------------------------------------------------------------------
-- DataWydania, OrganWydajacy, DokumentTozsamosci
-----------------------------------------------------------------------------------------------------	
IF (
		isnull(@DataWydania, 0) &lt;&gt; 0
		OR isnull(@OrganWydajacy, '') &lt;&gt; ''
		OR isnull(@DokumentTozsamosci, '') &lt;&gt; ''
		)
	AND NOT (
		isnull(@RolnikRyczaltowy, (
				SELECT Knt_RolnikRyczaltowy
				FROM cdn.KntKarty
				WHERE Knt_GidNumer = @KntGIDNumer
				)) = 1
		OR isnull(@Status, (
				SELECT Knt_Status
				FROM cdn.KntKarty
				WHERE Knt_GidNumer = @KntGIDNumer
				)) = 2 --odbiorca detaliczny
		)
BEGIN
	RAISERROR (
			'Nieprawidłowa wartość pola Knt_RolnikRyczaltowy przy zmianie Knt_DataWydania lub Knt_OrganWydajacy lub Knt_DokumentTozsamosci [%d] - (51)'
			, 16
			, 1
			, @RolnikRyczaltowy
			)

	RETURN 51
END

IF @DataWydania IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_DataWydania=' + CAST(@DataWydania AS VARCHAR)

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_DataWydania=' + CAST(@DataWydania AS VARCHAR)
	SET @ModyfAdr = 1
END

IF @DokumentTozsamosci IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_DokumentTozsamosci=' + '''' + @DokumentTozsamosci + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_DokumentTozsamosci=' + '''' + @DokumentTozsamosci + ''''
	SET @ModyfAdr = 1
END

IF @OrganWydajacy IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_OrganWydajacy=' + '''' + @OrganWydajacy + ''''

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_OrganWydajacy=' + '''' + @OrganWydajacy + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- SplitPayment
-----------------------------------------------------------------------------------------------------
IF @SplitPayment IS NOT NULL
BEGIN
	IF @SplitPayment = 0
		OR (
			@SplitPayment = 1
			AND isnull(@PlatnikVat, (
					SELECT Knt_PlatnikVat
					FROM cdn.KntKarty
					WHERE Knt_GidNumer = @KntGIDNumer
					)) = 1
			AND isnull(@Status, (
					SELECT Knt_Status
					FROM cdn.KntKarty
					WHERE Knt_GidNumer = @KntGIDNumer
					)) = 1
			AND (
				(
					isnull(@Dewizowe, (
							SELECT Knt_Dewizowe
							FROM cdn.KntKarty
							WHERE Knt_GidNumer = @KntGIDNumer
							)) = 1
					AND isnull(@Symbol, (
							SELECT Knt_Symbol
							FROM cdn.KntKarty
							WHERE Knt_GidNumer = @KntGIDNumer
							)) = 'PLN'
					)
				OR isnull(@Dewizowe, (
						SELECT Knt_Dewizowe
						FROM cdn.KntKarty
						WHERE Knt_GidNumer = @KntGIDNumer
						)) = 0
				AND @WalutaSystemowa = 'PLN'
				)
			)
		SET @SQLString = @SQLString + ',Knt_SplitPayment=' + CAST(@SplitPayment AS VARCHAR)
	ELSE
	BEGIN
		RAISERROR (
				'Nieprawidłowa wartość pola Knt_SplitPayment [%d] - (52)'
				, 16
				, 1
				, @SplitPayment
				)

		RETURN 52
	END
END

-----------------------------------------------------------------------------------------------------
-- Knt_Guid
-----------------------------------------------------------------------------------------------------	
IF @GUID &lt;&gt; '' and @GUID is not null
	SET @SQLString = @SQLString + ',Knt_Guid=''' + @GUID+''''

-----------------------------------------------------------------------------------------------------
-- Knt_Guiddane
-----------------------------------------------------------------------------------------------------	
IF @GUIDdane &lt;&gt; '' and @GUIDdane is not null
	SET @SQLString = @SQLString + ',Knt_Guiddane=''' + @GUIDdane+''''


-----------------------------------------------------------------------------------------------------
-- transakcja
-----------------------------------------------------------------------------------------------------
BEGIN TRANSACTION

-----------------------------------------------------------------------------------------------------
-- Opis kontrahenta - tabela kntopisy
-----------------------------------------------------------------------------------------------------
IF @Opis IS NOT NULL
BEGIN
	SELECT @Opis_old = Kno_Opis
	FROM cdn.kntopisy
	WHERE kno_knttyp = @KntGIDTyp
		AND kno_kntfirma = @KntGIDFirma
		AND kno_kntnumer = @KntGIDNumer

	IF @Opis_old &lt;&gt; ''
	BEGIN
		IF @Opis &lt;&gt; ''
			UPDATE cdn.kntopisy
			SET kno_opis = @Opis
			WHERE kno_knttyp = @KntGIDTyp
				AND kno_kntfirma = @KntGIDFirma
				AND kno_kntnumer = @KntGIDNumer
		ELSE IF @Opis = ''
			DELETE
			FROM cdn.kntopisy
			WHERE kno_knttyp = @KntGIDTyp
				AND kno_kntfirma = @KntGIDFirma
				AND kno_kntnumer = @KntGIDNumer
	END
	ELSE
	BEGIN
		IF @Opis &lt;&gt; ''
			INSERT INTO cdn.kntopisy (
				kno_knttyp
				, kno_kntfirma
				, kno_kntnumer
				, kno_kntlp
				, kno_typ
				, kno_opis
				)
			VALUES (
				@KntGIDTyp
				, @KntGIDFirma
				, @KntGIDNumer
				, 1
				, 0
				, @Opis
				)
	END
END


-----------------------------------------------------------------------------------------------------
-- Kna_GUIDTelefon
-----------------------------------------------------------------------------------------------------
IF @GUIDTelefon IS NOT NULL
BEGIN
	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_GUIDTelefon=' + '''' + @GUIDTelefon + ''''
	SET @ModyfAdr = 1
END


-----------------------------------------------------------------------------------------------------
-- Kna_GUIDEmail
-----------------------------------------------------------------------------------------------------
IF @GUIDEmail IS NOT NULL
BEGIN
	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',Kna_GUIDEmail=' + '''' + @GUIDEmail + ''''
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- CharsetANSI
-----------------------------------------------------------------------------------------------------
IF @CharsetANSI IS NOT NULL
BEGIN
	SET @SQLString = @SQLString + ',Knt_CharsetANSI=' + CAST(@CharsetANSI AS VARCHAR)

	IF @modType = 0
		AND @NowaKarta = 0 --tworzymy update na kntadresy
		SET @SQLStringAdr = @SQLStringAdr + ',KnA_CharsetANSI=' + CAST(@CharsetANSI AS VARCHAR)
	SET @ModyfAdr = 1
END

-----------------------------------------------------------------------------------------------------
-- Główny warunek procedury
-----------------------------------------------------------------------------------------------------
IF @ModyfAdr = 1
BEGIN
	IF @modType = 0
		AND @NowaKarta = 0 -- Tylko modyfikacja KntAdresy
	BEGIN
		SET @SQLStringAdr = REPLACE(@SQLStringAdr, 'set ,', 'set ') + ',KnA_LastModL=' + CAST(datediff(s, '19900101', getdate()) AS VARCHAR) + --data modyfikacji
			' Where KnA_GIDTyp=' + CAST(@KnaTyp AS VARCHAR) + ' and KnA_GIDFirma=' + CAST(@KnaFirma AS VARCHAR) + ' and KnA_GIDNumer=' + CAST(@KnaNumer AS VARCHAR)

		--update na kntadresy
		EXECUTE @err = sp_executesql @SQLStringAdr

		IF @err &lt;&gt; 0
		BEGIN
			ROLLBACK TRANSACTION

			RAISERROR (
					'Błąd modyfikacji KntAdresy! - (32)'
					, 16
					, 1
					)

			RETURN @err
		END
	END
	ELSE
	BEGIN -- Nowy rekord w KntAdresy
		--archiwizacja adresu
		IF @NowaKarta = 0
		BEGIN --- (if)Jeżeli nie nowa karta knt
			UPDATE CDN.KntAdresy
			SET KnA_DataArc = datediff(s, '19900101', getdate())
			WHERE KnA_GIDTyp = @knaTyp
				AND KnA_GIDfirma = @knaFirma
				AND KnA_GIDnumer = @knaNumer

			IF @@error &lt;&gt; 0
			BEGIN
				ROLLBACK TRANSACTION

				RAISERROR (
						'Błąd modyfikacji KntAdresy! - (33)'
						, 16
						, 1
						)

				RETURN 33
			END
		END --- (if)

		--select @KnaGuid = KnA_GUID,@KnaGuidDane = KnA_GUIDdane, @KnaGuidEmail = Kna_GuidEmail, @KnaGuidTelefon = Kna_GuidTelefon
		--FROM CDN.KntAdresy
		--WHERE KnA_GIDTyp = @knaTyp
		--		AND KnA_GIDfirma = @knaFirma
		--		AND KnA_GIDnumer = @knaNumer
		select @KnaGuid = NEWID(),@KnaGuidDane = NEWID(), @KnaGuidEmail = NEWID(), @KnaGuidTelefon = NEWID() 

		SELECT TOP 1 @knaTyp = KnA_GIDTyp
			, @knaFirma = KnA_GIDFirma
			, @knaNumer = KnA_GIDNumer + 1
		FROM CDN.KntAdresy
		WHERE KnA_GIDTyp = 864
		ORDER BY KnA_GIDNumer DESC

		IF @knaTyp IS NULL
			OR @knaFirma IS NULL
			OR @knaNumer IS NULL
		BEGIN
			ROLLBACK TRANSACTION

			RAISERROR (
					'Brak definicji adresu! - (34)'
					, 16
					, 1
					)

			RETURN 34
		END
	END
END

-----------------------------------------------------------------------------------------------------
-- Dodanie operatora modyfikującego + data modyfikacji
-----------------------------------------------------------------------------------------------------
SET @SQLString = @SQLString + ',Knt_OpeTypM=' + CAST(@OpeGIDTyp AS VARCHAR) + ',Knt_OpeFirmaM=' + CAST(@OpeGIDFirma AS VARCHAR) + ',Knt_OpeNumerM=' + CAST(@OpeGIDNumer AS VARCHAR) + ',Knt_LastModL=' + CAST(datediff(s, '19900101', getdate()) AS VARCHAR)
-----------------------------------------------------------------------------------------------------
-- Dodanie klauzuli where
-----------------------------------------------------------------------------------------------------
SET @SQLString = @SQLString + ' Where Knt_GIDTyp=' + CAST(@KntGIDTyp AS VARCHAR) + ' and Knt_GIDFirma=' + CAST(@KntGIDFirma AS VARCHAR) + ' and Knt_GIDNumer=' + CAST(@KntGIDNumer AS VARCHAR)
SET @SQLString = REPLACE(@SQLString, 'set ,', 'set ')

--update na kntkarty
EXECUTE @err = sp_executesql @SQLString

IF @err &lt;&gt; 0
BEGIN
	ROLLBACK TRANSACTION

	RAISERROR (
			'Błąd modyfikacji tabeli Cdn.KntKarty - (36)'
			, 16
			, 1
			)

	RETURN @err
END

--aktualizacja adresu kontrahenta (jeśli potrzebna)
IF @ModyfAdr = 1
	AND (
		@modType &lt;&gt; 0
		OR @NowaKarta &lt;&gt; 0
		)
BEGIN
	INSERT INTO cdn.kntadresy (
		KnA_GIDTyp
		, KnA_GIDFirma
		, KnA_GIDLp
		, KnA_KntTyp
		, KnA_KntFirma
		, KnA_KntNumer
		, KnA_KntLp
		, KnA_DataArc
		, KnA_Akronim
		, KnA_Wysylkowy
		, KnA_Nazwa1
		, KnA_Nazwa2
		, KnA_Nazwa3
		, KnA_KodP
		, KnA_Miasto
		, KnA_Ulica
		, KnA_Adres
		, KnA_NipE
		, KnA_Nip
		, KnA_NipPrefiks
		, KnA_Regon
		, KnA_Pesel
		, KnA_Kraj
		, KnA_Powiat
		, KnA_Gmina
		, KnA_Wojewodztwo
		, KnA_RegionCRM
		, KnA_GLN
		, KnA_Telefon1
		, KnA_Telefon2
		, KnA_Fax
		, KnA_Modem
		, KnA_Telex
		, KnA_EMail
		, KnA_BnkTyp
		, KnA_BnkFirma
		, KnA_BnkNumer
		, KnA_BnkLp
		, KnA_NrRachunku
		, KnA_LastModL
		, KnA_Odleglosc
		, KnA_NRB
		, KnA_NiePublikuj
		, KnA_Domyslny
		, KnA_DokumentTozsamosci
		, KnA_DataWydania
		, KnA_OrganWydajacy
		, KnA_RolnikRyczaltowy
		, KnA_KontoDostawcy
		, KnA_KontoOdbiorcy
		, KnA_StanPostep
		, KnA_PlatnikVat
		, KnA_GPSSz
		, KnA_GPSDl
		, KnA_GPSDataPobrania
		, KnA_GPSGodzinaPobrania
		, KnA_KnaPierwotny
		, KnA_KnaArchiwizowanego
		, Kna_GUID
		, KnA_GUIDdane
		, Kna_GuidEmail
		, Kna_GuidTelefon
		, KnA_CharsetANSI
		)
	SELECT 864
		, KnT_GIDFirma
		, Knt_GIDLp
		, Knt_GIDTyp
		, KnT_GIDFirma
		, KnT_GIDNumer
		, KnT_GIDLp
		, 0
		, Knt_Akronim
		, 0
		, Knt_Nazwa1
		, Knt_Nazwa2
		, Knt_Nazwa3
		, Knt_KodP
		, Knt_Miasto
		, Knt_Ulica
		, Knt_Adres
		, Knt_NipE
		, Knt_Nip
		, Knt_NipPrefiks
		, Knt_Regon
		, Knt_Pesel
		, Knt_Kraj
		, Knt_Powiat
		, Knt_Gmina
		, Knt_Wojewodztwo
		, Knt_RegionCRM
		, Knt_GLN
		, Knt_Telefon1
		, Knt_Telefon2
		, Knt_Fax
		, Knt_Modem
		, Knt_Telex
		, Knt_EMail
		, Knt_BnkTyp
		, Knt_BnkFirma
		, Knt_BnkNumer
		, Knt_BnkLp
		, Knt_NrRachunku
		, 0
		, Knt_Odleglosc
		, Knt_NRB
		, 0
		, 0
		, Knt_DokumentTozsamosci
		, Knt_DataWydania
		, Knt_OrganWydajacy
		, Knt_RolnikRyczaltowy
		, ''
		, ''
		, Knt_StanPostep --,KnA_StanPostep 
		, Knt_PlatnikVat --,KnA_PlatnikVat 
		, 0 --,KnA_GPSSz 
		, 0 --,KnA_GPSDl 
		, 0 --,KnA_GPSDataPobrania
		, 0 --,KnA_GPSGodzinaPobrania
		, 0 --,KnA_KnaPierwotny
		, COALESCE(@KnaNumer, 0) --,KnA_KnaArchiwizowanego
		, @KnaGuid
		, @KnaGuidDane
		, COALESCE(@GUIDEmail,@KnaGuidEmail)
		, COALESCE(@GUIDTelefon,@KnaGuidTelefon)
	    , COALESCE(@CharsetANSI, Knt_CharsetANSI)

	FROM cdn.KntKarty
	WHERE Knt_GIDNumer = @KntGIDNumer

	IF @@ERROR &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd dodawania rekordu do tabeli Cdn.KntAdresy - (35)'
				, 16
				, 1
				)

		RETURN @@ERROR
	END

	SELECT @KnaNumer = SCOPE_IDENTITY()

	IF @@ERROR &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd pobierania wartości IDENTITY z tabeli CDN.KntAdresy - (45)'
				, 16
				, 1
				)

		RETURN @@ERROR
	END

	--ERPXL-7023 ZmienPoleKntSQL - zmiana danych kontrahenta pole KnA_KnAPierwotny
	UPDATE cdn.KntAdresy
	SET KnA_KnaPierwotny = (select Knt_KnANumer from cdn.KntKarty where Knt_GIDNumer = @KntGIDNumer )
	WHERE KnA_GIDNumer = @knaNumer

	UPDATE cdn.kntkarty
	SET knt_knanumer = @KnaNumer
	WHERE Knt_GIDNumer = @KntGIDNumer

	IF @@ERROR &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd aktualizacji adresu na karcie kontrahenta - (46)'
				, 16
				, 1
				)

		RETURN @@ERROR
	END

END

IF @Akronim IS NOT NULL --aktualizacja akronimu w kntgrupy i kntgrupydom
BEGIN
	UPDATE cdn.kntgrupy
	SET KnG_Akronim = UPPER(@Akronim)
	WHERE KnG_GIDTyp = @KntGIDTyp
		AND KnG_GIDFirma = @KntGIDFirma
		AND KnG_GIDNumer = @KntGIDNumer

	IF @@ERROR &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd modyfikacji tabeli Cdn.KntGrupy - (37)'
				, 16
				, 1
				)

		RETURN 37
	END

	UPDATE cdn.kntgrupydom
	SET KGD_Kod = UPPER(@Akronim)
	WHERE KGD_GIDTyp = @KntGIDTyp
		AND KGD_GIDFirma = @KntGIDFirma
		AND KGD_GIDNumer = @KntGIDNumer

	IF @@ERROR &lt;&gt; 0
	BEGIN
		ROLLBACK TRANSACTION

		RAISERROR (
				'Błąd modyfikacji tabeli Cdn.KntGrupyDom - (38)'
				, 16
				, 1
				)

		RETURN 38
	END
END

-----------------------------------------------------------------------------------------------------
--Aplikacje
-----------------------------------------------------------------------------------------------------		
DECLARE @KAp_OpeNumer INT
DECLARE @KAp_OpeHaslo VARCHAR(100)
DECLARE @KAp_OpeONumer INT
DECLARE @KAp_MagTyp SMALLINT
DECLARE @KAp_MagFirma INT
DECLARE @KAp_MagNumer INT
DECLARE @KAp_MagLp SMALLINT
DECLARE @KAp_Seria VARCHAR(5)
DECLARE @KAp_TwrGrupaNumer INT
DECLARE @KAp_CzyPotwierdzone TINYINT
DECLARE @KAp_MagMSTyp SMALLINT
DECLARE @KAp_MagMSFirma INT
DECLARE @KAp_MagMSNumer INT
DECLARE @KAp_MagMSLp SMALLINT

IF EXISTS (
		SELECT *
		FROM CDN.KntAplikacje
		WHERE KAp_KntTyp = @KntGIDTyp
			AND KAp_KntNumer = @KntGIDNumer
		)
BEGIN
	SELECT @KAp_OpeNumer = KAp_OpeNumer
		, @KAp_OpeHaslo = KAp_OpeHaslo
		, @KAp_OpeONumer = KAp_OpeONumer
		, @KAp_MagTyp = KAp_MagTyp
		, @KAp_MagFirma = KAp_MagFirma
		, @KAp_MagNumer = KAp_MagNumer
		, @KAp_MagLp = KAp_MagLp
		, @KAp_Seria = KAp_Seria
		, @KAp_TwrGrupaNumer = KAp_TwrGrupaNumer
		, @KAp_CzyPotwierdzone = KAp_CzyPotwierdzone
		, @KAp_MagMSTyp = KAp_MagMSTyp
		, @KAp_MagMSFirma = KAp_MagMSFirma
		, @KAp_MagMSNumer = KAp_MagMSNumer
		, @KAp_MagMSLp = KAp_MagMSLp
	FROM CDN.KntAplikacje
	WHERE KAp_KntTyp = @KntGIDTyp
		AND KAp_KntNumer = @KntGIDNumer

	IF (
			@OpeNumerW IS NOT NULL
			AND @OpeNumerW = 0
			)
	BEGIN
		DELETE CDN.KntAplikacje
		WHERE KAp_KntTyp = @KntGIDTyp
			AND KAp_KntNumer = @KntGIDNumer
	END
	ELSE
	BEGIN
		UPDATE CDN.KntAplikacje
		SET KAp_OpeNumer = ISNULL(@OpeNumerW, @KAp_OpeNumer)
			, KAp_OpeHaslo = ISNULL(@OpeHaslo, @KAp_OpeHaslo)
			, KAp_OpeONumer = ISNULL(@OpeNumerO, @KAp_OpeONumer)
			, KAp_MagTyp = ISNULL(@MagTyp, @KAp_MagTyp)
			, KAp_MagFirma = ISNULL(@MagFirma, @KAp_MagFirma)
			, KAp_MagNumer = ISNULL(@MagNumer, @KAp_MagNumer)
			, KAp_Seria = ISNULL(@SeriaKaP, @KAp_Seria)
			, KAp_TwrGrupaNumer = ISNULL(@TwrGrupaNumer, @KAp_TwrGrupaNumer)
			, KAp_CzyPotwierdzone = ISNULL(@AutoPotwierdzenie, @KAp_CzyPotwierdzone)
			, KAp_MagMSTyp = ISNULL(@MagMSTyp, @KAp_MagMSTyp)
			, KAp_MagMSFirma = ISNULL(@MagMSFirma, @KAp_MagMSFirma)
			, KAp_MagMSNumer = ISNULL(@MagMSNumer, @KAp_MagMSNumer)
		WHERE KAp_KntTyp = @KntGIDTyp
			AND KAp_KntNumer = @KntGIDNumer
	END
END
ELSE
BEGIN
	SELECT @KAp_OpeNumer = KAp_OpeNumer
		, @KAp_OpeHaslo = KAp_OpeHaslo
		, @KAp_OpeONumer = KAp_OpeONumer
		, @KAp_MagTyp = KAp_MagTyp
		, @KAp_MagFirma = KAp_MagFirma
		, @KAp_MagNumer = KAp_MagNumer
		, @KAp_MagLp = KAp_MagLp
		, @KAp_Seria = KAp_Seria
		, @KAp_TwrGrupaNumer = KAp_TwrGrupaNumer
		, @KAp_CzyPotwierdzone = KAp_CzyPotwierdzone
		, @KAp_MagMSTyp = KAp_MagMSTyp
		, @KAp_MagMSFirma = KAp_MagMSFirma
		, @KAp_MagMSNumer = KAp_MagMSNumer
		, @KAp_MagMSLp = KAp_MagMSLp
	FROM CDN.KntAplikacje
	INNER JOIN CDN.KntGrupyDom
		ON KGD_GrOTyp = KAp_KntTyp
			AND KGD_GrONumer = KAp_KntNumer
	WHERE KGD_GIDTyp = @KntGIDTyp
		AND KGD_GIDNumer = @KntGIDNumer

	IF (
			@OpeNumerW IS NULL
			OR @OpeNumerW = 0
			)
		AND (
			@AutoPotwierdzenie IS NOT NULL
			OR @MagTyp IS NOT NULL
			OR @MagNumer IS NOT NULL
			OR @TwrGrupaNumer IS NOT NULL
			OR @SeriaKaP IS NOT NULL
			)
	BEGIN
		SET @OpeNumerW = @KAp_OpeNumer
		SET @OpeHaslo = @KAp_OpeHaslo
	END

	IF @OpeNumerW IS NOT NULL
		AND @OpeNumerW &gt; 0
	BEGIN
		INSERT INTO CDN.KntAplikacje (
			KAp_KntTyp
			, KAp_KntNumer
			, KAp_OpeNumer
			, KAp_OpeHaslo
			, KAp_OpeONumer
			, KAp_MagTyp
			, KAp_MagFirma
			, KAp_MagNumer
			, KAp_MagLp
			, KAp_Seria
			, KAp_TwrGrupaNumer
			, KAp_CzyPotwierdzone
			, KAp_MagMSTyp
			, KAp_MagMSFirma
			, KAp_MagMSNumer
			, KAp_MagMSLp
			)
		VALUES (
			@KntGIDTyp --KAp_KntTyp
			, @KntGIDNumer --KAp_KntNumer
			, @OpeNumerW --KAp_OpeNumer
			, IsNull(@OpeHaslo, '') --KAp_OpeHaslo
			, IsNull(@OpeNumerO, @KAp_OpeONumer) --KAp_OpeONumer
			, IsNUll(@MagTyp, @KAp_MagTyp) --KAp_MagTyp
			, IsNUll(@MagFirma, @KAp_MagFirma) --KAp_MagFirma
			, IsNUll(@MagNumer, @KAp_MagNumer) --KAp_MagNumer
			, 0 --KAp_MagLp
			, IsNUll(@SeriaKAp, @KAp_Seria) --KAp_Seria
			, IsNUll(@TwrGrupaNumer, @KAp_TwrGrupaNumer) --KAp_TwrGrupaNumer
			, IsNUll(@AutoPotwierdzenie, @KAp_CzyPotwierdzone) --KAp_CzyPotwierdzone
			, IsNull(@MagMSTyp, @KAp_MagMSTyp) --KAp_MagMSTyp
			, IsNull(@MagMSFirma, @KAp_MagMSFirma) --KAp_MagMSFirma
			, IsNull(@MagMSNumer, @KAp_MagMSNumer) --KAp_MagMSNumer
			, 0 --KAp_MagMSLp
			)
	END
END

-----------------------------------------------------------------------------------------------------
--KntRejestr
-----------------------------------------------------------------------------------------------------
IF @KarTyp IS NOT NULL
	AND @KarFirma IS NOT NULL
	AND @KarNumer IS NOT NULL
BEGIN
	IF EXISTS (
			SELECT *
			FROM CDN.KntRejestr
			WHERE KRj_ObiTyp = @KntGIDTyp
				AND KRj_ObiNumer = @KntGIDNumer
				AND KRj_TypRejestru = 0
			)
	BEGIN
		UPDATE CDN.KntRejestr
		SET KRj_KarNumer = @KarNumer
		WHERE KRj_ObiTyp = @KntGIDTyp
			AND KRj_ObiNumer = @KntGIDNumer
			AND KRj_TypRejestru = 0
	END
	ELSE
	BEGIN
		INSERT INTO CDN.KntRejestr (
			KRj_ObiTyp,
			KRj_ObiFirma,
			KRj_ObiNumer,
			KRj_ObiLp,
			KRj_TypRejestru,
			KRj_Waluta,
			KRj_PrzypiszDoPlatnosci,
			KRj_NrRachunku,
			KRj_KarNumer,
			KRj_Uwagi,
			KRj_CzasArchiwizacji
			)
		VALUES (
			@KntGIDTyp,
			@KntGIDFirma,
			@KntGIDNumer,
			0,
			0,
			isnull((
					SELECT TOP 1 Kar_Waluta
					FROM cdn.Rejestry
					WHERE kar_gidtyp = @KarTyp
						AND kar_gidnumer = @KarNumer
						AND isnull(Kar_waluta, '') &lt;&gt; ''
					), @WalutaSystemowa),
			0,
			'',
			@KarNumer,
			'',
			0
			)
	END
END

-----------------------------------------------------------------------------------------------------
--RachunkiBankowe
-----------------------------------------------------------------------------------------------------
IF @BnkTyp IS NOT NULL
	AND @BnkFirma IS NOT NULL
	AND @BnkNumer IS NOT NULL
	AND @NrRachunku IS NOT NULL
	AND @BnkTyp &lt;&gt; 0
BEGIN
	IF EXISTS (
			SELECT *
			FROM CDN.RachunkiBankowe
			WHERE RkB_ObiNumer = @KntGIDNumer
				AND RkB_ObiTyp = @KntGIDTyp
				AND RkB_BnkNumer = @BnkNumer
				AND RkB_BnkTyp = @BnkTyp
			)
	BEGIN
		UPDATE CDN.RachunkiBankowe
		SET RkB_NrRachunku = @NrRachunku,
			RkB_NrRachunkuE = @NrRachunku,
			RkB_IBAN = ISNULL(@NRB, RkB_IBAN)
		WHERE RkB_ObiNumer = @KntGIDNumer
			AND RkB_ObiTyp = @KntGIDTyp
			AND RkB_BnkNumer = @BnkNumer
			AND RkB_BnkTyp = @BnkTyp
	END
	ELSE
	BEGIN
		INSERT INTO CDN.RachunkiBankowe (
			RkB_ObiTyp,
			RkB_ObiFirma,
			RkB_ObiNumer,
			RkB_ObiLp,
			RkB_NrRachunku,
			RkB_NrRachunkuE,
			RkB_IBAN,
			RkB_BnkTyp,
			RkB_BnkFirma,
			RkB_BnkNumer,
			RkB_BnkLp,
			RkB_Waluta,
			RkB_OpeUtworzyl,
			RkB_CzasUtworzenia,
			RkB_KntAdres,
			RkB_TypRachunku,
			RkB_Uwagi,
			RkB_CzasArchiwizacji,
			RkB_Domyslny,
			RkB_CzasModyfikacji,
			RkB_OpeModyfikowal
			)
		VALUES (
			@KntGIDTyp,
			@KntGIDFirma,
			@KntGIDNumer,
			0,
			@NrRachunku,
			@NrRachunku,
			@NRB,
			@BnkTyp,
			@BnkFirma,
			@BnkNumer,
			0,
			'',
			@OpeGIDNumer,
			DATEDIFF(s, '19900101', GETDATE()),
			0,
			0,
			'',
			0,
			1,
			DATEDIFF(s, '19900101', GETDATE()),
			@OpeGIDNumer
			)
	END
END

COMMIT TRANSACTION

IF @ModyfAdr = 1
	AND (
		@modType &lt;&gt; 0
		OR @NowaKarta &lt;&gt; 0
		)
	SELECT KnANumer = @KnaNumer
ELSE
	SELECT 0

SET NOCOUNT OFF

-- END --
RETURN 0
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
<DIV CLASS="TextInfo">
      <P><A name="Przyznanie praw do procedury KntModyfikacja"></A><PRE>
          <FONT SIZE="2"><I>/* Przyznanie praw do procedury KntModyfikacja */</I><BR>
GRANT EXECUTE
	ON CDN.KntModyfikacja
	TO CDNRaport
</FONT>
        </PRE>
      </P>
      <HR>
    </DIV>
</BODY>
</HTML>