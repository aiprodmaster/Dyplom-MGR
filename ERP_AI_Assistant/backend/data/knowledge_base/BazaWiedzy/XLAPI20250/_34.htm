<html>

<head>
  <title> Prototyp i opis dzia³ania</title>
  <meta http-equiv=Content-Type content="text/html; charset=windows-1250">
  <meta name="GENERATOR" content="Macrobject Word-2-CHM Pro">
  <link rel="stylesheet" href="default.css" type="text/css" />
  <link rel="stylesheet" href="macrobject.css" type="text/css">
</head>

<body>


<div class=Section1>

<h6><a name=Bookmark33></a><span style='mso-bidi-font-family:"Times New Roman"'>Prototyp i opis dzia³ania</span><span style='mso-bidi-font-family:"Times New Roman"'><o:p></o:p></span></h6>

<p class=MsoCaption>XLDODAJPOZYCJE(<span class=SpellE>IDDokumentu</span> AS
LONG, <span class=SpellE>DokumentElemInfo</span> As <span class=SpellE>XLDokumentElemInfo</span>)
AS LONG<span style='font-size:12.0pt;mso-bidi-font-size:10.0pt'><o:p></o:p></span></p>

<p><span style='font-family:"Calibri",sans-serif;mso-bidi-font-family:"Times New Roman"'>&nbsp;<o:p></o:p></span></p>

<p><span style='font-family:"Calibri",sans-serif;mso-bidi-font-family:"Times New Roman"'>Funkcja
ta jest odpowiedzialna za sekwencyjne dodawanie do aktualnie otwartego (za
pomoc¹ <span class=SpellE>funkcj</span> <span class=SpellE>XLNowyDokument</span>)
dokumentu, elementów oraz zwi¹zanych z nim <span class=SpellE>subelementów</span>.
Odpowiada funkcjonalnie naciœniêciu przez operatora przycisku „Dodaj&quot; <span
style='mso-no-proof:yes'><img border=0 width=27 height=25
src="doc_pliki/image001.png" v:shapes="Obraz_x0020_1"></span>na
formatce edytowanego dokumentu. Elementy i <span class=SpellE>subelementy</span>
dziedzicz¹ ustawienia z nag³ówka dokumentu. Jeœli typem dokumentu jest
przyjêcie to automatycznie elementy bêd¹ zak³ada³y nowe dostawy. Jeœli
natomiast typ dokumentu jest ustawiony na sprzeda¿, to zostanie pobrane tyle <span
class=SpellE>subelementów</span> ile bêdzie wynika³o z iloœci. Na czas
dzia³ania funkcji zak³adana jest <a
href="javascript:BSSCPopup('Transakcja.htm');"><span style='mso-fareast-font-family:
"Arial Unicode MS";color:blue'>transakcja</span></a>, poniewa¿ jest to zapis
kilku zwi¹zanych ze sob¹ elementów bazy danych.<o:p></o:p></span></p>

<p><span style='font-family:"Calibri",sans-serif;mso-fareast-font-family:"Arial Unicode MS";
mso-bidi-font-family:"Times New Roman"'>Par</span><span style='font-family:
"Calibri",sans-serif;mso-bidi-font-family:"Times New Roman"'>ametr <span
class=SpellE>IDDokumentu</span> jest unikalnym wskaŸnikiem na nag³ówek
dokumentu (jest on zwracany przez funkcjê <span class=SpellE>XLNowyDokument</span>).<o:p></o:p></span></p>

<p><span style='font-family:"Calibri",sans-serif;mso-bidi-font-family:"Times New Roman"'>Przy
dodawaniu pozycji do dokumentu: Korekta rêczna, za pomoc¹ tej funkcji, nale¿y w
polu: <span class=SpellE>TypKorekty</span>, ustawiæ jedn¹ z wartoœci: 1 -
iloœciowa, 2 - wartoœciowa, 3 - VAT. <o:p></o:p></span></p>

<p><span style='font-family:"Calibri",sans-serif;mso-bidi-font-family:"Times New Roman"'>Od
wersji <b style='mso-bidi-font-weight:normal'>2016.0</b> mo¿liwe jest
przes³anie informacji o bud¿etach rabatowych. S³u¿¹ ku temu pola <span
class=SpellE>BudzetPrmID</span>, <span class=SpellE>BudzetID</span> i <span
class=SpellE>BudzetWartosc</span>. Wiele wartoœci dla tych pól nale¿y podawaæ
po przecinkach, np. w <span class=SpellE>fromie</span> ‘1,3,10.3’. Przes³anie w
polu <span class=SpellE>BudzetPrmID</span> wartoœci -1, w po³¹czeniu z
identyfikatorem elementu zamówienia, spowoduje zaczytanie zapisów z <span
class=SpellE>PrmHistoria</span> dotycz¹cych przes³anego identyfikatora elementu
zamówienia i przypisanie ich do elementu tworzonego dokumentu handlowego.<o:p></o:p></span></p>

<p><span style='font-family:"Calibri",sans-serif;mso-bidi-font-family:"Times New Roman"'>Od
wersji <b style='mso-bidi-font-weight:normal'>2019.1 </b>mo¿liwa jest
optymalizacja dodawania pozycji poprzez pole <b style='mso-bidi-font-weight:
normal'>Optymalizuj</b>. <o:p></o:p></span></p>

<p class=MsoNormal>&nbsp;Przyjmuje nastêpuj¹ce wartoœci:</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span class=SpellE>e_SPR_APIOptVATNie</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EQUATE(-1)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
!Nie optymalizuj w wewnêtrznym VAT-u</p>

<p class=MsoNormal><span class=SpellE>e_SPR_APIOptDomyslna</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EQUATE(0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!Domyœlny
w trybie wewnêtrznym optymalizuje VAT, w zewnêtrznym nie</p>

<p class=MsoNormal><span class=SpellE>e_SPR_APIOptVATTak</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
EQUATE(1)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; !Optymalizuj w trybie
zewnêtrznym VAT</p>

<p class=MsoNormal><span class=SpellE>e_SPR_APIOptDoKolejki</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
EQUATE(2)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; !Nie generuj pozycji
- zapisuj do kolejki</p>

<p class=MsoNormal><span class=SpellE>e_SPR_APIOptZKolejki</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
EQUATE(3)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; !Generuj pozycje z
kolejki</p>

<p class=MsoNormal><span class=SpellE>e_SPR_APIOptTylkoZKolejki</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
EQUATE(4)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; !Generuj pozycje z
kolejki nie dodaj¹c do niej obecnego wywo³ania</p>

<p class=MsoNormal>&nbsp;</p>

<p><span style='font-family:"Calibri",sans-serif;mso-bidi-font-family:"Times New Roman"'>Trzy
pierwsze to optymalizacja zapisu <span class=SpellE>TraVat</span>. Polega na
tym, ¿e przy ka¿dym <span class=SpellE>DodajPozycje</span> nie modyfikujemy
fizycznie tabelki VAT (nie ma ¿adnego ruchu na bazie na <span class=SpellE>TraVAT</span>)
jedynie wartoœci o stawkach zbieramy w specjalnej kolejce. Nie modyfikujemy
wtedy równie¿ wartoœci w <span class=SpellE>TraNag</span> i nie zapisujemy pól <span
class=SpellE>TrE_VATGID</span>. Robimy to dopiero W <span class=SpellE>ZamknijDokument</span>.
Dziêki temu zamiast przy ka¿dym <span class=SpellE>DodajPozycje</span> jeœli
jest ich np. 100 robiæ sto razy modyfikacjê <span class=SpellE>TraVAT</span>,
robimy to maksymalnie na koniec tyle razy ile by³o stawek VAT. Zwykle jest to
raz lub dwa razy.<o:p></o:p></span></p>

<p class=MsoNormal>Jeœli mamy tryb wewnêtrzny, mo¿emy ustawiæ to pole na <span
class=SpellE>e_SPR_APIOptDomyslna</span>, (wszystkie dotychczasowe wewnêtrzne
implementacje z tego skorzystaj¹, do tej pory nie by³o tego pola. Bêdzie wiêc z
automatu ustawione na 0) I wtedy w <span class=SpellE>ZamknijDokument</span>
zostanie dopiero zapisany <span class=SpellE>TraVat</span>. Niejako z automatu
bez ¿adnych modyfikacji wszystkie wewnêtrze implementacje w XL-u zadzia³aj¹ z
optymalizacj¹.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Jest specjalny tryb <span class=SpellE>e_SPR_APIOptVATNie</span>,
który wy³¹cza t¹ optymalizacjê w trybie wewnêtrznym. Czasami by³oby
niepo¿¹danym abyœmy po <span class=SpellE>DodajPozycje</span> nie znali
wartoœci nag³ówka.</p>

<p class=MsoNormal>Ustawiaj¹c: <span class=SpellE>e_SPR_APIOptVATTak</span>
powodujemy, ¿e równie¿ w trybie zewnêtrznym nie bêdzie nastêpowa³ zapis <span
class=SpellE>TraVat</span> po ka¿dym <span class=SpellE>DodajPozycje</span>.
(Miejmy œwiadomoœæ, ¿e wtedy po <span class=SpellE>DodajPozycje</span> mamy
niepe³ny, nieprawid³owy zapis o dokumencie w bazie) Musimy zatem na koniec
przed w³aœciwym <span class=SpellE>ZamknijDokument</span> zawo³aæ <span
class=SpellE>ZamknijDokument</span> w trybie <span class=SpellE><span
style='font-size:10.0pt;line-height:107%;color:black'>e_SPR_lZatwierdzCache</span></span><span
style='font-size:10.0pt;line-height:107%;color:black'> EQUATE(-6) </span>A
dopiero potem <span class=SpellE>ZamknijDokument</span> w trybie zapisu do
bufora, czy zatwierdzenia.</p>

<p class=MsoNormal>Mo¿emy wo³aæ <span class=SpellE>DodajPozycje</span> zarówno
w trybie zewnêtrznym jak i wewnêtrznym z ustawieniem tego pola na <span
class=SpellE>e_SPR_APIOptDoKolejki</span> spowoduje to, ¿e tak naprawdê <span
class=SpellE>DodajPozycje</span> nie wykona siê, a zostanie zbuforowane. Taki
tryb wymusza te¿ automatycznie optymalizacjê zapisu <span class=SpellE>TraVat</span>
o której mowa by³a wczeœniej. Mo¿emy tak zawo³aæ dowoln¹ iloœæ razy <span
class=SpellE>DodajPozycje</span>. (mamy np. do dodania 1000 elementów) Wo³amy
zatem z takim ustawieniem <span class=SpellE>DodajPozycje</span> dla 999
elementów, a dla ostatniego 1000-nego ustawiamy flagê optymalizacji na <span
class=SpellE>e_SPR_APIOptZKolejki</span>. Pamiêtajmy o tym, ¿e ten 1000-ny raz
wo³amy <span class=SpellE>DodajPozycje</span> w zwyczajny sposób przekazuj¹c
dane dla ostatniego elementu tak jak dla wszystkich poprzednich. Jedynie
zmieniaj¹c wartoœæ flagi optymalizacji. Dopiero przy zawo³aniu tego ostatniego
1000-nego <span class=SpellE>DodajPozycje</span> wszystkie 1000 elementów do
tej pory buforowanych doda siê do bazy fizycznie. Dziêki temu, tylko raz
sprawdzimy licencjê, prawo do edycji dokumentu, czy listê dostêpnych magazynów.
Istnieje jeszcze jeden specjalny tryb: <span class=SpellE>e_SPR_APIOptTylkoZKolejki</span>
Jeœli z jakichœ powodów nie wiedzielibyœmy który to bêdzie ostatni element i
nie bardzo moglibyœmy przy ostatnim zawo³aæ w trybie <span class=SpellE>e_SPR_APIOptZKolejki</span>.
Ten specjalny tryb zawo³ania <span class=SpellE>DodajPozycje</span> ignoruje
przes³ane doñ dane, a tylko zapisuje zbuforowane elementy. Przy zastosowaniu
tych trzech trybów optymalizacji nie musimy ju¿ wo³aæ dodatkowo <span
class=SpellE>ZamknijDokument</span> w trybie <span class=SpellE><span
style='font-size:10.0pt;line-height:107%;color:black'>e_SPR_lZatwierdzCache</span></span>
T¹ role spe³ni zawo³anie <span class=SpellE>DodajPozycje</span> z
optymalizacj¹: <span class=SpellE>e_SPR_APIOptZKolejki</span> lub <span
class=SpellE>e_SPR_APIOptTylkoZKolejki</span>. Mo¿emy te¿ dowolnie mieszaæ te
tryby optymalizacji. Mo¿emy np. W przypadku dodawania 1000 elementów zawo³aæ
300 razy z optymalizacj¹ <span class=SpellE>e_SPR_APIOptDoKolejki</span>, potem
301 jako <span class=SpellE>e_SPR_APIOptZKolejki</span> 10 razy bez ¿adnej
optymalizacji. I znowu kolejne 689 <span class=SpellE>e_SPR_APIOptDoKolejki</span>
i na koniec z <span class=SpellE>e_SPR_APIOptZKolejki</span> lub <span
class=SpellE>e_SPR_APIOptTylkoZKolejki</span>. Mo¿emy nawet nie zawo³aæ 301 raz
<span class=SpellE>e_SPR_APIOptZKolejki</span>, a zrobiæ to dopiero na koñcu. W
takim przypadku musimy jednak pamiêtaæ, ¿e elementy dodawane od 300 do 310 bêd¹
mia³y <span class=SpellE>Lp</span> od 1 do 10, a te zbuforowane dopiero od 11
do koñca.</p>

<p class=MsoNormal>Zagro¿enia wynikaj¹ce z tego to oczywiœcie w przypadku
przerwania procesu utrata tych wszystkich danych. Równie¿ nieumiejêtne
pos³ugiwanie siê API mo¿e powodowaæ mieszanie zawartoœci pamiêci. Dane s¹
usuwane z pamiêci przy odpowiednio zachowanej kolejnoœci <span class=SpellE>wywo³añ</span>.
Nie zawo³anie np. <span class=SpellE>ZamknijDokument</span> w trybie <span
class=SpellE>e_SPR_lZatwierdzCache</span> i próba dodania kolejnego dokumentu
mo¿e spowodowaæ, ¿e na tym dokumencie bêdziemy mieli zsumowane wartoœci z obu
dokumentów. Tak samo nieodpowiednia kolejnoœæ <span class=SpellE>wywo³añ</span>
<span class=SpellE>DodajPozycje</span> czy niereagowanie na zwracane b³êdy mo¿e
spowodowaæ utratê czêœci pozycji lub wymieszanie ich na dokumentach.</p>

<p><span style='font-family:"Calibri",sans-serif;mso-bidi-font-family:"Times New Roman"'>&nbsp;<o:p></o:p></span></p>

<div style='mso-element:para-border-div;border-top:solid black 1.0pt;
border-left:none;border-bottom:solid black 1.0pt;border-right:none;mso-border-top-alt:
solid black .75pt;mso-border-bottom-alt:solid black .75pt;padding:0cm 0cm 0cm 0cm;
margin-left:1.0cm;margin-right:6.5pt'>

<p class=body-text-2 style='margin-top:4.0pt;margin-right:0cm;margin-bottom:
0cm;margin-left:0cm;margin-bottom:.0001pt;border:none;mso-border-top-alt:solid black .75pt;
mso-border-bottom-alt:solid black .75pt;padding:0cm;mso-padding-alt:0cm 0cm 0cm 0cm'><span
style='font-size:12.0pt;font-family:"Calibri",sans-serif;mso-bidi-font-family:
"Times New Roman"'>W przypadku dodawania pozycji z wieloma <span class=SpellE>subelementami</span>
funkcjê <span class=SpellE>XLDodajPozycje</span> nale¿y traktowaæ jak dodanie
pierwszego <span class=SpellE>subelementu</span>. Z tego pierwszego <span
class=SpellE>subelementu</span> wyliczana jest cena sprzeda¿y, na podstawie
której zwiêkszana jest wartoœæ pozycji podczas dodawania kolejnych <span
class=SpellE>subelementów</span> przy pomocy funkcji <span class=SpellE>XLDodajSubPozycje</span>.
</span><span style='font-family:"Calibri",sans-serif;mso-bidi-font-family:"Times New Roman"'><o:p></o:p></span></p>

</div>


</div>







</body>

</html>
